commit cf36ee2631359bd7f265a5f17c751c13971378cf
Author: Andrew Beekhof <andrew@beekhof.net>
Date:   Mon Jul 21 11:23:40 2008 +0200

    Medium: PE: Bug LF:1941 - Mark extra clone instances as orphans and don't show inactive ones
    
    Mercurial revision: 96fac4b8c37d765c42a76c6e8dc1a0c364639056

diff --git a/lib/crm/pengine/clone.c b/lib/crm/pengine/clone.c
index 143b5d69d..971044149 100644
--- a/lib/crm/pengine/clone.c
+++ b/lib/crm/pengine/clone.c
@@ -64,7 +64,7 @@ create_child_clone(resource_t *rsc, int sub_id, pe_working_set_t *data_set)
 /* 	child_rsc->globally_unique = rsc->globally_unique; */
 
 	clone_data->total_clones += 1;
-	crm_err("Setting clone attributes for: %s", child_rsc->id);
+	crm_debug_2("Setting clone attributes for: %s", child_rsc->id);
 	rsc->children = g_list_append(rsc->children, child_rsc);
 	
 	add_hash_param(child_rsc->meta, XML_RSC_ATTR_INCARNATION_MAX, inc_max);
@@ -258,6 +258,11 @@ void clone_print(
 	
 	slist_iter(
 		child_rsc, resource_t, rsc->children, lpc,
+
+		if(is_set(child_rsc->flags, pe_rsc_orphan)
+		   && child_rsc->fns->active(child_rsc, TRUE) == FALSE) {
+		    continue;
+		}
 		
 		if(options & pe_print_html) {
 			status_print("<li>\n");
diff --git a/lib/crm/pengine/complex.c b/lib/crm/pengine/complex.c
index d5d81f92a..c0ff1e0f9 100644
--- a/lib/crm/pengine/complex.c
+++ b/lib/crm/pengine/complex.c
@@ -406,7 +406,7 @@ void common_free(resource_t *rsc)
 	if(rsc->meta != NULL) {
 		g_hash_table_destroy(rsc->meta);
 	}
-	if(is_set(rsc->flags, pe_rsc_orphan)) {
+	if(rsc->parent == NULL && is_set(rsc->flags, pe_rsc_orphan)) {
 		free_xml(rsc->xml);
 	}
 	if(rsc->running_on) {
diff --git a/lib/crm/pengine/unpack.c b/lib/crm/pengine/unpack.c
index 4455db59d..9beec4bd0 100644
--- a/lib/crm/pengine/unpack.c
+++ b/lib/crm/pengine/unpack.c
@@ -642,6 +642,7 @@ unpack_find_resource(
 			create_child_clone(clone_parent, -1, data_set);
 			crm_debug("Looking again for %s", alt_rsc_id);
 			rsc = pe_find_resource(data_set->resources, alt_rsc_id);
+			set_bit(rsc->flags, pe_rsc_orphan);
 			CRM_CHECK(rsc != NULL, crm_err("%s stil not found", alt_rsc_id); continue);
 #else
 			rsc = create_fake_resource(alt_rsc_id, rsc_entry, data_set);

