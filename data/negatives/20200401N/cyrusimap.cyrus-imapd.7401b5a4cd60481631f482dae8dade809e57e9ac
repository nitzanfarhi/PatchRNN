commit 7401b5a4cd60481631f482dae8dade809e57e9ac
Author: Larry Greenfield <leg@andrew.cmu.edu>
Date:   Tue Jun 6 00:52:26 2000 +0000

    strlen/sun_path

diff --git a/imap/acapmbox.c b/imap/acapmbox.c
index 72bcaf5d2..8ff082d7a 100644
--- a/imap/acapmbox.c
+++ b/imap/acapmbox.c
@@ -671,7 +671,7 @@ void acapmbox_kick_target(void)
     memset((char *)&srvaddr, 0, sizeof(srvaddr));
     srvaddr.sun_family = AF_UNIX;
     strcpy(srvaddr.sun_path, buf);
-    len = strlen(srvaddr.sun_path) + sizeof(srvaddr.sun_family);
+    len = sizeof(srvaddr.sun_family) + strlen(srvaddr.sun_path) + 1;
 
     r = connect(s, (struct sockaddr *)&srvaddr, len);
     if (r == -1) {
diff --git a/imap/acappush.c b/imap/acappush.c
index 3d153717d..ff95d95e3 100644
--- a/imap/acappush.c
+++ b/imap/acappush.c
@@ -327,7 +327,7 @@ int main(int argc, char **argv)
     strcpy(local.sun_path, config_dir);
     strcat(local.sun_path, FNAME_ACAPPUSH_SOCK);
     unlink(local.sun_path);
-    len = strlen(local.sun_path) + sizeof(local.sun_family);
+    len = sizeof(local.sun_family) + strlen(local.sun_path) + 1;
 
     oldumask = umask((mode_t) 0); /* for Linux */
 
diff --git a/imap/deliver.c b/imap/deliver.c
index 6618dcb6c..52ee0696b 100644
--- a/imap/deliver.c
+++ b/imap/deliver.c
@@ -297,7 +297,7 @@ static int init_net(const char *unixpath)
   strcpy(addr.sun_path, unixpath);
 
   if (connect(lmtpdsock, (struct sockaddr *) &addr, 
-	      sizeof(addr.sun_family) + strlen(addr.sun_path)) < 0) {
+	      sizeof(addr.sun_family) + strlen(addr.sun_path) + 1) < 0) {
       just_exit("connect failed");
   }
 
diff --git a/imap/lmtpengine.c b/imap/lmtpengine.c
index 595a832ab..6a6fef01f 100644
--- a/imap/lmtpengine.c
+++ b/imap/lmtpengine.c
@@ -1,5 +1,5 @@
 /* lmtpengine.c: LMTP protocol engine
- * $Id: lmtpengine.c,v 1.7 2000/06/05 19:11:02 leg Exp $
+ * $Id: lmtpengine.c,v 1.8 2000/06/06 00:54:54 leg Exp $
  *
  * Copyright (c) 2000 Carnegie Mellon University.  All rights reserved.
  *
@@ -1442,7 +1442,7 @@ int lmtp_connect(const char *phost,
 	addr.sun_family = AF_UNIX;
 	strcpy(addr.sun_path, host);
 	if (connect(sock, (struct sockaddr *) &addr, 
-		    sizeof(addr.sun_family) + strlen(addr.sun_path)) < 0) {
+		    sizeof(addr.sun_family) + strlen(addr.sun_path) + 1) < 0) {
 	    syslog(LOG_ERR, "connect(%s) failed: %m", addr.sun_path);
 	    goto donesock;
 	}
@@ -1593,7 +1593,6 @@ int lmtp_connect(const char *phost,
 static void pushmsg(struct protstream *in, struct protstream *out,
 		    int isdotstuffed)
 {
-    int r;
     char buf[8192], *p;
     int lastline_hadendline = 1;
 
diff --git a/imap/mailbox.c b/imap/mailbox.c
index 251d795b5..67bcb7d18 100644
--- a/imap/mailbox.c
+++ b/imap/mailbox.c
@@ -1,5 +1,5 @@
 /* mailbox.c -- Mailbox manipulation routines
- $Id: mailbox.c,v 1.98 2000/05/23 20:52:20 robeson Exp $
+ $Id: mailbox.c,v 1.99 2000/06/06 00:55:02 leg Exp $
  
  * Copyright (c) 1998-2000 Carnegie Mellon University.  All rights reserved.
  *
@@ -140,8 +140,8 @@ int mailbox_initialize(void)
     acappush_remote.sun_family = AF_UNIX;
     strcpy(acappush_remote.sun_path, config_dir);
     strcat(acappush_remote.sun_path, FNAME_ACAPPUSH_SOCK);
-    acappush_remote_len = strlen(acappush_remote.sun_path) + 
-	sizeof(acappush_remote.sun_family);
+    acappush_remote_len = sizeof(acappush_remote.sun_family) +
+	strlen(acappush_remote.sun_path) + 1;
 
     /* put us in non-blocking mode */
     fdflags = fcntl(s, F_GETFD, 0);
diff --git a/imap/target-acap.c b/imap/target-acap.c
index 6cf488458..434bcbff3 100644
--- a/imap/target-acap.c
+++ b/imap/target-acap.c
@@ -40,7 +40,7 @@
  * AN ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING
  * OUT OF OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.
  *
- * $Id: target-acap.c,v 1.17 2000/06/04 22:48:05 leg Exp $
+ * $Id: target-acap.c,v 1.18 2000/06/06 00:55:17 leg Exp $
  */
 
 #include <config.h>
@@ -186,10 +186,12 @@ void myacap_addto(acap_entry_t *entry,
     imapurl_fromURL(server, mailbox, d.url);
 
     syslog(LOG_DEBUG, "creating mailbox %s", name);
-    r = mboxlist_insertremote(mailbox, MBTYPE_REMOTE, server, d.acl, NULL);
-    if (r) {
-	syslog(LOG_ERR, "couldn't insert %s into mailbox list: %s\n",
-	       d.name, error_message(r));
+    if (!debugmode) {
+	r = mboxlist_insertremote(mailbox, MBTYPE_REMOTE, server, d.acl, NULL);
+	if (r) {
+	    syslog(LOG_ERR, "couldn't insert %s into mailbox list: %s\n",
+		   d.name, error_message(r));
+	}
     }
 
     free(mailbox);
@@ -207,7 +209,9 @@ void myacap_removefrom(acap_entry_t *entry,
     /* need to reencode UTF-8 name into a UTF-7 IMAP name */
 
     syslog(LOG_DEBUG, "deleting mailbox %s", name);
-    mboxlist_deletemailbox(name, 1, "", NULL, 0);
+    if (!debugmode) {
+	mboxlist_deletemailbox(name, 1, "", NULL, 0);
+    }
 }
 
 void myacap_change(acap_entry_t *entry,
@@ -276,8 +280,10 @@ void myacap_entry(acap_entry_t *entry, void *rock)
 	free(v);
 	r = 0;
     } else { /* we don't have it, add it */
-	r = mboxlist_insertremote(mailbox, MBTYPE_REMOTE, server, 
-				  acl->data, NULL);
+	if (!debugmode) {
+	    r = mboxlist_insertremote(mailbox, MBTYPE_REMOTE, server, 
+				      acl->data, NULL);
+	}
     }
 
     if (r) {
@@ -295,7 +301,9 @@ static void mboxdel(const void *v)
     int r = 0;
 
     syslog(LOG_DEBUG, "'%s' no longer exists", name);
-    r = mboxlist_deletemailbox(name, 1, "", NULL, 0);
+    if (!debugmode) {
+	r = mboxlist_deletemailbox(name, 1, "", NULL, 0);
+    }
     if (r) {
 	syslog(LOG_ERR, "error deleting '%s': %s", name, error_message(r));
     }
@@ -406,7 +414,7 @@ void listen_for_kicks()
     memset((char *)&srvaddr, 0, sizeof(srvaddr));
     srvaddr.sun_family = AF_UNIX;
     strcpy(srvaddr.sun_path, fnamebuf);
-    len = strlen(srvaddr.sun_path) + sizeof(srvaddr.sun_family);
+    len = strlen(srvaddr.sun_path) + sizeof(srvaddr.sun_family) + 1;
     oldumask = umask((mode_t) 0); /* for Linux */
     r = bind(s, (struct sockaddr *)&srvaddr, len);
     umask(oldumask); /* for Linux */

