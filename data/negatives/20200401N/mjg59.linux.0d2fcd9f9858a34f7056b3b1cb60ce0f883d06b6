commit 0d2fcd9f9858a34f7056b3b1cb60ce0f883d06b6
Author: Hannes Reinecke <hare@suse.de>
Date:   Thu Jun 14 15:16:45 2007 +0200

    [SCSI] fc_transport: Check portstates before invoking target scan
    
    When a target scan is initiated from sysfs, we should check the
    portstate prior to invoke scsi_scan_target().
    Otherwise scsi_scan_target() might oops as the rport might already
    been removed from the scsi host and the traversal from the rport to
    the scsi_host in scsi_scan_target() will fail.
    Also the portstate already told us that communication with the target
    has failed, so it's quite pointless to try.
    
    Signed-off-by: Hannes Reinecke <hare@suse.de>
    Cc: James Smart <James.Smart@Emulex.Com>
    Signed-off-by: James Bottomley <James.Bottomley@SteelEye.com>

diff --git a/drivers/scsi/scsi_transport_fc.c b/drivers/scsi/scsi_transport_fc.c
index 4953f0dca029..e8825709797e 100644
--- a/drivers/scsi/scsi_transport_fc.c
+++ b/drivers/scsi/scsi_transport_fc.c
@@ -1943,6 +1943,9 @@ static int fc_user_scan(struct Scsi_Host *shost, uint channel,
 		if (rport->scsi_target_id == -1)
 			continue;
 
+		if (rport->port_state != FC_PORTSTATE_ONLINE)
+			continue;
+
 		if ((channel == SCAN_WILD_CARD || channel == rport->channel) &&
 		    (id == SCAN_WILD_CARD || id == rport->scsi_target_id)) {
 			scsi_scan_target(&rport->dev, rport->channel,

