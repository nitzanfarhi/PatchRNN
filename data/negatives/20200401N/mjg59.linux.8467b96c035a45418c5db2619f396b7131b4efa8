commit 8467b96c035a45418c5db2619f396b7131b4efa8
Author: Yi Zou <yi.zou@intel.com>
Date:   Mon May 16 16:45:57 2011 -0700

    [SCSI] libfc: do not immediately retry the cmd when seq_send fails in fc_fcp_send_data
    
    Currently, when seq_send() fails in fc_fcp_send_data(),
    fc_fcp_retry_cmd() would complete this failed I/O directly and let
    scsi-ml retry. However, target side is not notified which may hang the
    target. Instead, we should just bail out from from fc_fcp_send_data
    and let scsi-ml times it out and aborts this I/O instead.
    
    Signed-off-by: Yi Zou <yi.zou@intel.com>
    Tested-by: Ross Brattain <ross.b.brattain@intel.com>
    Signed-off-by: Robert Love <robert.w.love@intel.com>
    Signed-off-by: James Bottomley <jbottomley@parallels.com>

diff --git a/drivers/scsi/libfc/fc_fcp.c b/drivers/scsi/libfc/fc_fcp.c
index 57704e814681..9cd2149519ac 100644
--- a/drivers/scsi/libfc/fc_fcp.c
+++ b/drivers/scsi/libfc/fc_fcp.c
@@ -681,8 +681,7 @@ static int fc_fcp_send_data(struct fc_fcp_pkt *fsp, struct fc_seq *seq,
 		error = lport->tt.seq_send(lport, seq, fp);
 		if (error) {
 			WARN_ON(1);		/* send error should be rare */
-			fc_fcp_retry_cmd(fsp);
-			return 0;
+			return error;
 		}
 		fp = NULL;
 	}

