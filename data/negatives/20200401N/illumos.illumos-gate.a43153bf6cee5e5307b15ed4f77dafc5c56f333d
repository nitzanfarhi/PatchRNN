commit a43153bf6cee5e5307b15ed4f77dafc5c56f333d
Author: smaybe <none@none>
Date:   Sat Dec 1 08:56:06 2007 -0800

    6636181 Bad trap booting MP domU with build 79 bits

diff --git a/usr/src/uts/i86xpv/io/psm/xpv_psm.c b/usr/src/uts/i86xpv/io/psm/xpv_psm.c
index 7244d43fb1..4137ff1f6a 100644
--- a/usr/src/uts/i86xpv/io/psm/xpv_psm.c
+++ b/usr/src/uts/i86xpv/io/psm/xpv_psm.c
@@ -775,9 +775,11 @@ xen_psm_rebind_irq(int irq)
 		CPUSET_ONLY(ncpu, newcpu & ~IRQ_USER_BOUND);
 	}
 	ec_set_irq_affinity(irq, ncpu);
-	irqptr = apic_irq_table[irq];
-	ASSERT(irqptr != NULL);
-	irqptr->airq_temp_cpu = (uchar_t)newcpu;
+	if (irq <= APIC_MAX_VECTOR) {
+		irqptr = apic_irq_table[irq];
+		ASSERT(irqptr != NULL);
+		irqptr->airq_temp_cpu = (uchar_t)newcpu;
+	}
 }
 
 /*
diff --git a/usr/src/uts/i86xpv/os/evtchn.c b/usr/src/uts/i86xpv/os/evtchn.c
index bc3b048096..680b319033 100644
--- a/usr/src/uts/i86xpv/os/evtchn.c
+++ b/usr/src/uts/i86xpv/os/evtchn.c
@@ -658,7 +658,8 @@ ec_set_irq_affinity(int irq, cpuset_t dest)
 	 * It will check for any pending interrupts, and so service any that
 	 * got delivered to the wrong processor by mistake.
 	 */
-	poke_cpu(tcpu);
+	if (ncpus > 1)
+		poke_cpu(tcpu);
 }
 
 int

