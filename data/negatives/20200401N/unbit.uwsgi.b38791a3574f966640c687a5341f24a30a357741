commit b38791a3574f966640c687a5341f24a30a357741
Author: roberto@oneiric64 <roberto@oneiric64>
Date:   Mon Jan 30 10:46:20 2012 +0100

    ported chmod-socket to new options api

diff --git a/uwsgi.c b/uwsgi.c
index e7aac612..944ac03f 100644
--- a/uwsgi.c
+++ b/uwsgi.c
@@ -70,7 +70,8 @@ static struct uwsgi_option uwsgi_base_options[] = {
 	{"profiler", required_argument, 0, "enable the specified profiler", uwsgi_opt_set_str, &uwsgi.profiler,0},
 	{"cgi-mode", no_argument, 'c', "force CGI-mode for plugins supporting it", uwsgi_opt_dyn_true, (void *) UWSGI_OPTION_CGI_MODE,0},
 	{"abstract-socket", no_argument, 'a', "force UNIX socket in abstract mode (Linux only)", uwsgi_opt_true, &uwsgi.abstract_socket,0},
-	//{"chmod-socket|chmod", optional_argument, 'C', "chmod-socket", uwsgi_opt_set_mode, &uwsgi.chmod_socket,0},
+	{"chmod-socket", optional_argument, 'C', "chmod-socket", uwsgi_opt_chmod_socket, NULL,0},
+	{"chmod", optional_argument, 'C', "chmod-socket", uwsgi_opt_chmod_socket, NULL,0},
 	{"chown-socket", required_argument, 0, "chown unix sockets", uwsgi_opt_set_str, &uwsgi.chown_socket, 0},
 	{"umask", required_argument, 0, "set umask", uwsgi_opt_set_umask, NULL, UWSGI_OPT_IMMEDIATE},
 #ifdef __linux__
@@ -3436,6 +3437,33 @@ void uwsgi_opt_log_date(char *opt, char *value, void *foobar) {
                 }
 }
 
+void uwsgi_opt_chmod_socket(char *opt, char *value, void *foobar) {
+
+	int i;
+
+	uwsgi.chmod_socket = 1;
+                if (value) {
+                        if (strlen(value) == 1 && *value == '1') {
+                                return;
+                        }
+                        if (strlen(value) != 3) {
+                                uwsgi_log("invalid chmod value: %s\n", value);
+                                exit(1);
+                        }
+                        for (i = 0; i < 3; i++) {
+                                if (value[i] < '0' || value[i] > '7') {
+                                        uwsgi_log("invalid chmod value: %s\n", value);
+                                        exit(1);
+                                }
+                        }
+
+                        uwsgi.chmod_socket_value = (uwsgi.chmod_socket_value << 3) + (value[0] - '0');
+                        uwsgi.chmod_socket_value = (uwsgi.chmod_socket_value << 3) + (value[1] - '0');
+                        uwsgi.chmod_socket_value = (uwsgi.chmod_socket_value << 3) + (value[2] - '0');
+                }
+
+}
+
 void uwsgi_opt_logfile_chmod(char *opt, char *value, void *foobar) {
 
 	int i;
diff --git a/uwsgi.h b/uwsgi.h
index cfb572a2..fb6b2c55 100644
--- a/uwsgi.h
+++ b/uwsgi.h
@@ -2529,6 +2529,7 @@ void uwsgi_opt_snmp_community(char *, char *, void *);
 void uwsgi_opt_logfile_chmod(char *, char *, void *);
 
 void uwsgi_opt_log_date(char *, char *, void *);
+void uwsgi_opt_chmod_socket(char *, char *, void *);
 
 #ifdef UWSGI_CAP
 void uwsgi_opt_set_cap(char *, char *, void *);

