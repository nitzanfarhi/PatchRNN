commit f940c08dbc340c3888400ba6b13f17c6451938de
Author: Bron Gondwana <brong@fastmail.fm>
Date:   Fri Apr 24 13:15:46 2015 +1000

    dav: clean up correctly after rename/delete

diff --git a/imap/imapd.c b/imap/imapd.c
index b784d63ee..58b346513 100644
--- a/imap/imapd.c
+++ b/imap/imapd.c
@@ -6814,14 +6814,6 @@ static int renmbox(char *name,
 	    user_copyquotaroot(name, text->newmailboxname);
 	    user_renameacl(text->namespace, text->newmailboxname,
 			   text->acl_olduser, text->acl_newuser);
-#ifdef WITH_DAV
-	    if (mbentry->mbtype & MBTYPES_DAV) {
-		struct mailbox *mailbox = NULL;
-		r = mailbox_open_irl(text->newmailboxname, &mailbox);
-		if (!r) r = mailbox_add_dav(mailbox);
-		mailbox_close(&mailbox);
-	    }
-#endif
 	}
 
 
diff --git a/imap/mailbox.c b/imap/mailbox.c
index b02e457b9..fa2a48bb3 100644
--- a/imap/mailbox.c
+++ b/imap/mailbox.c
@@ -146,6 +146,7 @@ static bit32 mailbox_index_record_to_buf(struct index_record *record, int versio
 #ifdef WITH_DAV
 static int mailbox_commit_dav(struct mailbox *mailbox);
 static int mailbox_abort_dav(struct mailbox *mailbox);
+static int mailbox_delete_dav(struct mailbox *mailbox);
 #endif
 
 static struct mailboxlist *create_listitem(const char *name)
@@ -4818,6 +4819,9 @@ EXPORTED int mailbox_add_dav(struct mailbox *mailbox)
     if (!(mailbox->mbtype & (MBTYPES_DAV)))
 	return 0;
 
+    if (mboxname_isdeletedmailbox(mailbox->name, NULL))
+	return 0;
+
     for (recno = 1; recno <= mailbox->i.num_records; recno++) {
 	r = mailbox_read_index_record(mailbox, recno, &record);
 	if (r) return r;
@@ -4828,6 +4832,7 @@ EXPORTED int mailbox_add_dav(struct mailbox *mailbox)
 
     return 0;
 }
+
 #endif /* WITH_DAV */
 
 EXPORTED int mailbox_add_conversations(struct mailbox *mailbox)
@@ -4895,6 +4900,12 @@ static int mailbox_delete_internal(struct mailbox **mailboxptr)
     mailbox_index_dirty(mailbox);
     mailbox->i.options |= OPT_MAILBOX_DELETED;
 
+#ifdef WITH_DAV
+    /* remove any DAV records */
+    r = mailbox_delete_dav(mailbox);
+    if (r) return r;
+#endif
+
     /* clean up annotations */
     r = annotate_delete_mailbox(mailbox);
     if (r) return r;
diff --git a/imap/mboxlist.c b/imap/mboxlist.c
index 2f704763b..6c7522fb8 100644
--- a/imap/mboxlist.c
+++ b/imap/mboxlist.c
@@ -1580,6 +1580,11 @@ EXPORTED int mboxlist_renamemailbox(const char *oldname, const char *newname,
 	    }
 
 	    mailbox_rename_cleanup(&oldmailbox, isusermbox);
+
+#ifdef WITH_DAV
+	    mailbox_add_dav(newmailbox);
+#endif
+
 	    mailbox_close(&newmailbox);
 	}
 	else if (partitionmove) {

