commit 09b8a7d2af83ae96dc052f9708e50140d06a9b6c
Author: Sage Weil <sage@newdream.net>
Date:   Wed Nov 11 15:21:27 2009 -0800

    ceph: exclude snapdir from readdir results
    
    It was hidden from sync readdir, but not the cached dcache version.
    
    Signed-off-by: Sage Weil <sage@newdream.net>

diff --git a/fs/ceph/dir.c b/fs/ceph/dir.c
index 4f7467961b09..32ef54367224 100644
--- a/fs/ceph/dir.c
+++ b/fs/ceph/dir.c
@@ -131,6 +131,7 @@ more:
 			goto out_unlock;
 		}
 		if (!d_unhashed(dentry) && dentry->d_inode &&
+		    ceph_snap(dentry->d_inode) != CEPH_SNAPDIR &&
 		    filp->f_pos <= di->offset)
 			break;
 		dout(" skipping %p %.*s at %llu (%llu)%s%s\n", dentry,

