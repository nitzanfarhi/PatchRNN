commit 1eaca39a84170b369fe61fb1da3c1e8606859e99
Author: Bian Yu <bianyu@kedacom.com>
Date:   Wed Dec 12 22:26:58 2012 -0500

    [libata] ahci: Fix lack of command retry after a success error handler.
    
    It should be a mistake introduced by commit 8d899e70c1b3afff.
    
    qc->flags can't be set AC_ERR_*
    
    Signed-off-by: Bian Yu <bianyu@kedacom.com>
    Signed-off-by: Jeff Garzik <jgarzik@redhat.com>

diff --git a/drivers/ata/libata-eh.c b/drivers/ata/libata-eh.c
index bf039b0e97b7..bcf4437214f5 100644
--- a/drivers/ata/libata-eh.c
+++ b/drivers/ata/libata-eh.c
@@ -2094,7 +2094,7 @@ static unsigned int ata_eh_speed_down(struct ata_device *dev,
  */
 static inline int ata_eh_worth_retry(struct ata_queued_cmd *qc)
 {
-	if (qc->flags & AC_ERR_MEDIA)
+	if (qc->err_mask & AC_ERR_MEDIA)
 		return 0;	/* don't retry media errors */
 	if (qc->flags & ATA_QCFLAG_IO)
 		return 1;	/* otherwise retry anything from fs stack */

