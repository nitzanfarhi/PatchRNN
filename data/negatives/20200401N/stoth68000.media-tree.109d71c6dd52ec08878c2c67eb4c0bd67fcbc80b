commit 109d71c6dd52ec08878c2c67eb4c0bd67fcbc80b
Author: Frank Rowand <frank.rowand@am.sony.com>
Date:   Thu Nov 19 13:42:06 2009 -0800

    lockstat: Fix min, max times in /proc/lock_stats
    
    Fix min, max times in /proc/lock_stats
    
    (1) When collecting lock hold and wait times, if the current minimum
        time is zero, it will be replaced by the next time.
    
    (2) When aggregating minimum and maximum lock hold and wait times
        accross cpus, the values are added, instead of selecting the
        minimum and maximum.
    
    Signed-off-by: Frank Rowand <frank.rowand@am.sony.com>
    Signed-off-by: Peter Zijlstra <a.p.zijlstra@chello.nl>
    LKML-Reference: <4B05BBAE.2050005@am.sony.com>
    Signed-off-by: Ingo Molnar <mingo@elte.hu>

diff --git a/kernel/lockdep.c b/kernel/lockdep.c
index f5dcd36d3151..7a3ae56b3a7f 100644
--- a/kernel/lockdep.c
+++ b/kernel/lockdep.c
@@ -168,7 +168,7 @@ static void lock_time_inc(struct lock_time *lt, u64 time)
 	if (time > lt->max)
 		lt->max = time;
 
-	if (time < lt->min || !lt->min)
+	if (time < lt->min || !lt->nr)
 		lt->min = time;
 
 	lt->total += time;
@@ -177,8 +177,15 @@ static void lock_time_inc(struct lock_time *lt, u64 time)
 
 static inline void lock_time_add(struct lock_time *src, struct lock_time *dst)
 {
-	dst->min += src->min;
-	dst->max += src->max;
+	if (!src->nr)
+		return;
+
+	if (src->max > dst->max)
+		dst->max = src->max;
+
+	if (src->min < dst->min || !dst->nr)
+		dst->min = src->min;
+
 	dst->total += src->total;
 	dst->nr += src->nr;
 }

