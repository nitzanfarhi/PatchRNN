commit 0b5b7ae0a853c91015bb3b1729166ca65f693322
Author: Andy Adamson <andros@netapp.com>
Date:   Wed Apr 1 09:23:15 2009 -0400

    nfs41: Setup the backchannel
    
    The NFS v4.1 callback service has already been setup, and
    rpc_xprt->serv points to the svc_serv structure describing it.
    Invoke the xprt_setup_backchannel() initialization to pre-
    allocate the necessary backchannel structures.
    
    Signed-off-by: Ricardo Labiaga <ricardo.labiaga@netapp.com>
    Signed-off-by: Benny Halevy <bhalevy@panasas.com>
    [nfs41: change nfs4_put_session(nfs4_session**) to nfs4_destroy_session(nfs_session*)]
    Signed-off-by: Alexandros Batsakis <Alexandros.Batsakis@netapp.com>
    Signed-off-by: Benny Halevy <bhalevy@panasas.com>
    [moved xprt_setup_backchannel from nfs4_init_session to nfs4_init_backchannel]
    Signed-off-by: Andy Adamson <andros@netapp.com>
    Signed-off-by: Benny Halevy <bhalevy@panasas.com>

diff --git a/fs/nfs/client.c b/fs/nfs/client.c
index ac6575c4da31..4f75ec593be8 100644
--- a/fs/nfs/client.c
+++ b/fs/nfs/client.c
@@ -37,6 +37,7 @@
 #include <linux/in6.h>
 #include <net/ipv6.h>
 #include <linux/nfs_xdr.h>
+#include <linux/sunrpc/bc_xprt.h>
 
 #include <asm/system.h>
 
@@ -1096,6 +1097,14 @@ static int nfs4_init_callback(struct nfs_client *clp)
 	int error;
 
 	if (clp->rpc_ops->version == 4) {
+		if (nfs4_has_session(clp)) {
+			error = xprt_setup_backchannel(
+						clp->cl_rpcclient->cl_xprt,
+						NFS41_BC_MIN_CALLBACKS);
+			if (error < 0)
+				return error;
+		}
+
 		error = nfs_callback_up(clp->cl_minorversion,
 					clp->cl_rpcclient->cl_xprt);
 		if (error < 0) {

