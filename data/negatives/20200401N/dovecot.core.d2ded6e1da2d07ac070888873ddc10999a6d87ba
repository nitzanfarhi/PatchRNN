commit d2ded6e1da2d07ac070888873ddc10999a6d87ba
Author: Timo Sirainen <tss@iki.fi>
Date:   Wed Nov 28 16:08:39 2007 +0200

    Die if (Solaris) LDAP library returns wrong file descriptor.
    
    --HG--
    branch : HEAD

diff --git a/src/auth/db-ldap.c b/src/auth/db-ldap.c
index f0df5999a..828d62b81 100644
--- a/src/auth/db-ldap.c
+++ b/src/auth/db-ldap.c
@@ -527,6 +527,11 @@ static void db_ldap_get_fd(struct ldap_connection *conn)
 		i_fatal("LDAP: Can't get connection fd: %s",
 			ldap_err2string(ret));
 	}
+	if (conn->fd <= CLIENT_LISTEN_FD) {
+		/* Solaris LDAP library seems to be broken */
+		i_fatal("LDAP: Buggy LDAP library returned wrong fd: %d",
+			conn->fd);
+	}
 	i_assert(conn->fd != -1);
 	net_set_nonblock(conn->fd, TRUE);
 }

