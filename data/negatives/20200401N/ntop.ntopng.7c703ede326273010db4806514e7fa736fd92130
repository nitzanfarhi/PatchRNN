commit 7c703ede326273010db4806514e7fa736fd92130
Author: emanuele-f <black.silver@hotmail.it>
Date:   Tue Apr 11 00:29:58 2017 +0200

    Handle space terminator in netbios name

diff --git a/src/NetworkInterface.cpp b/src/NetworkInterface.cpp
index 701fc668..85419d78 100644
--- a/src/NetworkInterface.cpp
+++ b/src/NetworkInterface.cpp
@@ -1342,19 +1342,26 @@ bool NetworkInterface::processPacket(const struct bpf_timeval *when,
 	     && (ndpi_netbios_name_interpret((char*)&payload[12], name, sizeof(name)) > 0)
 	     && (!strstr(name, "__MSBROWSE__"))
 	     ) {
+
+	    if(name[0] == '*') {
+	      int limit = min(payload_len-57, (int)sizeof(name)-1);
+	      int i = 0;
+
+	      while((i<limit) && (payload[57+i] != 0x20) && (payload[57+i] != 0x00)) {
+	        name[i] = payload[57+i];
+	        i++;
+	      }
+	      name[i] = 0;
+	    }
 #if 0
 	    char buf[32];
 
-	    ntop->getTrace()->traceEvent(TRACE_NORMAL, "Setting hostname from NetBios [raw=0x%x opcode=0x%x response=0x%x]: ip=%s -> '%s' [%s]",
+	    ntop->getTrace()->traceEvent(TRACE_NORMAL, "Setting hostname from NetBios [raw=0x%x opcode=0x%x response=0x%x]: ip=%s -> '%s'",
 	        payload[2], (payload[2] & 0x78) >> 3, (payload[2] & 0x80) >> 7,
-					 (*srcHost)->get_ip()->print(buf, sizeof(buf)), name,
-					 &payload[57]);
+					 flow->get_srv_host()->get_ip()->print(buf, sizeof(buf)), name);
 #endif
 
-	    if(name[0] == '*')
-	      flow->get_srv_host()->set_host_label((char*)&payload[57], false);
-	    else
-	      flow->get_srv_host()->set_host_label(name, false);
+	    flow->get_srv_host()->set_host_label(name, false);
     }
 	}
       }

