commit 2d9e8f451e16a3fb22040b49acb236c5edd1d1e6
Author: jwadams <none@none>
Date:   Tue Aug 30 16:50:58 2005 -0700

    6317793 umem environment processing mis-detects dlopen(3C) recursion

diff --git a/usr/src/lib/libumem/common/envvar.c b/usr/src/lib/libumem/common/envvar.c
index e1888ba199..82afede143 100644
--- a/usr/src/lib/libumem/common/envvar.c
+++ b/usr/src/lib/libumem/common/envvar.c
@@ -20,7 +20,7 @@
  * CDDL HEADER END
  */
 /*
- * Copyright 2004 Sun Microsystems, Inc.  All rights reserved.
+ * Copyright 2005 Sun Microsystems, Inc.  All rights reserved.
  * Use is subject to license terms.
  */
 
@@ -545,6 +545,7 @@ umem_setup_envvars(int invalid)
 	static volatile enum {
 		STATE_START,
 		STATE_GETENV,
+		STATE_DLOPEN,
 		STATE_DLSYM,
 		STATE_FUNC,
 		STATE_DONE
@@ -569,6 +570,10 @@ umem_setup_envvars(int invalid)
 			where = "during getenv(3C) calls -- "
 			    "getenv(3C) results ignored.";
 			break;
+		case STATE_DLOPEN:
+			where = "during dlopen(3C) call -- "
+			    "_umem_*() results ignored.";
+			break;
 		case STATE_DLSYM:
 			where = "during dlsym(3C) call -- "
 			    "_umem_*() results ignored.";
@@ -609,6 +614,8 @@ umem_setup_envvars(int invalid)
 	}
 
 #ifndef UMEM_STANDALONE
+	state = STATE_DLOPEN;
+
 	/* get a handle to the "a.out" object */
 	if ((h = dlopen(0, RTLD_FIRST | RTLD_LAZY)) != NULL) {
 		for (cur_env = umem_envvars; cur_env->env_name != NULL;

