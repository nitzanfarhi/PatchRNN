commit 6fbb618f5da0424adcba5f666035e4772a8df526
Author: Paul Mackerras <paulus@samba.org>
Date:   Mon Dec 5 14:19:10 2005 +1100

    powerpc/pseries: Optimize IOMMU setup
    
    The previous commit will use the page-at-a-time hypervisor call for
    setting up IOMMU entries when we are using 64k pages and setting up
    one 64k page, even though that means 16 calls to the hypervisor, since
    the hypervisor still works on 4k pages.  This optimizes this case by
    using the multi-page IOMMU setup hypervisor call instead.
    
    Signed-off-by: Paul Mackerras <paulus@samba.org>

diff --git a/arch/powerpc/platforms/pseries/iommu.c b/arch/powerpc/platforms/pseries/iommu.c
index fa1edbdcf88c..2043659ea7b1 100644
--- a/arch/powerpc/platforms/pseries/iommu.c
+++ b/arch/powerpc/platforms/pseries/iommu.c
@@ -146,7 +146,7 @@ static void tce_buildmulti_pSeriesLP(struct iommu_table *tbl, long tcenum,
 	union tce_entry tce, *tcep;
 	long l, limit;
 
-	if (npages == 1)
+	if (TCE_PAGE_FACTOR == 0 && npages == 1)
 		return tce_build_pSeriesLP(tbl, tcenum, npages, uaddr,
 					   direction);
 

