commit ddfc4e171292d63d7e3f8c95ff9c3ef9932870ce
Author: Bryan Schumaker <bjschuma@netapp.com>
Date:   Tue Oct 2 16:01:38 2012 -0400

    NFS: Set key construction data for the legacy upcall
    
    This prevents a null pointer dereference when
    nfs_idmap_complete_pipe_upcall_locked() calls complete_request_key().
    
    Fixes a regression caused by commit 0cac12023 (NFSv4: Ensure that
    idmap_pipe_downcall sanity-checks the downcall data).
    
    Signed-off-by: Bryan Schumaker <bjschuma@netapp.com>
    Signed-off-by: Trond Myklebust <Trond.Myklebust@netapp.com>

diff --git a/fs/nfs/idmap.c b/fs/nfs/idmap.c
index 675b389cba5b..9cc4a3fbf4b0 100644
--- a/fs/nfs/idmap.c
+++ b/fs/nfs/idmap.c
@@ -707,6 +707,7 @@ static int nfs_idmap_legacy_upcall(struct key_construction *cons,
 	msg = &data->pipe_msg;
 	im = &data->idmap_msg;
 	data->idmap = idmap;
+	data->key_cons = cons;
 
 	ret = nfs_idmap_prepare_message(key->description, idmap, im, msg);
 	if (ret < 0)

