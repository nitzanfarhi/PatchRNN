commit 8c66e386054cefd8f0ae80fd1eab74efc9d07be7
Author: David Raynor <draynor@sourcefire.com>
Date:   Fri Mar 22 12:05:59 2013 -0400

    vba: grab length after middle test

diff --git a/libclamav/vba_extract.c b/libclamav/vba_extract.c
index 347d025b0..ba89281d7 100644
--- a/libclamav/vba_extract.c
+++ b/libclamav/vba_extract.c
@@ -182,16 +182,17 @@ vba_read_project_strings(int fd, int big_endian)
     unsigned char *buf = NULL;
     uint16_t buflen = 0;
     uint16_t length = 0;
-    int ret = 0;
-
-    /* if no initial name length, exit */
-    if(!read_uint16(fd, &length, big_endian))
-        return 0;
+    int ret = 0, getnewlength = 1;
 
     for(;;) {
         off_t offset;
         char *name;
 
+        /* if no initial name length, exit */
+        if(getnewlength && !read_uint16(fd, &length, big_endian))
+            return 0;
+        getnewlength = 0;
+
         /* if too short, break */
         if (length < 6) {
             if (lseek(fd, -2, SEEK_CUR) == -1) {
@@ -265,6 +266,7 @@ vba_read_project_strings(int fd, int big_endian)
         }
         cli_dbgmsg("offset: %lu\n", (unsigned long)offset);
         vba56_test_middle(fd);
+        getnewlength = 1;
     }
 
     free(buf);

