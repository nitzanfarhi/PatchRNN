commit 88e79e1b476996bab2582009f4ab5ff7c9fad9f4
Author: David Storch <david.storch@10gen.com>
Date:   Mon Sep 29 16:58:16 2014 -0400

    SERVER-15403 query planner should not error if $min and $max are equal

diff --git a/src/mongo/db/query/query_planner.cpp b/src/mongo/db/query/query_planner.cpp
index e6b06e3246..8f5880ab46 100644
--- a/src/mongo/db/query/query_planner.cpp
+++ b/src/mongo/db/query/query_planner.cpp
@@ -642,7 +642,7 @@ namespace mongo {
 
                         // Now we have the final min and max. This index is only relevant for
                         // the min/max query if min < max.
-                        if (0 > finishedMinObj.woCompare(finishedMaxObj, kp, false)) {
+                        if (0 >= finishedMinObj.woCompare(finishedMaxObj, kp, false)) {
                             // Found a relevant index.
                             idxNo = i;
                             break;
diff --git a/src/mongo/db/query/query_planner_test.cpp b/src/mongo/db/query/query_planner_test.cpp
index 1c6a3d934f..281514306e 100644
--- a/src/mongo/db/query/query_planner_test.cpp
+++ b/src/mongo/db/query/query_planner_test.cpp
@@ -1129,6 +1129,15 @@ namespace {
                                 "node: {ixscan: {filter: null, pattern: {a: 1}}}}}");
     }
 
+    TEST_F(QueryPlannerTest, MinMaxSameValue) {
+        addIndex(BSON("a" << 1));
+        runQueryHintMinMax(BSONObj(), BSONObj(), fromjson("{a: 1}"), fromjson("{a: 1}"));
+
+        assertNumSolutions(1U);
+        assertSolutionExists("{fetch: {filter: null, "
+                                "node: {ixscan: {filter: null, pattern: {a: 1}}}}}");
+    }
+
     TEST_F(QueryPlannerTest, MaxWithoutIndex) {
         runInvalidQueryHintMinMax(BSONObj(), BSONObj(), BSONObj(), fromjson("{a: 1}"));
     }

