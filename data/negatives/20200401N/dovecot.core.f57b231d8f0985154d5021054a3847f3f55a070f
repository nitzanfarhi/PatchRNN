commit f57b231d8f0985154d5021054a3847f3f55a070f
Author: Timo Sirainen <tss@iki.fi>
Date:   Thu May 15 08:51:12 2008 +0300

    If file isn't found from uidlist, refresh the file and look again in case it
    was added after the previous mailbox sync (but after the previous view sync
    that found new messages).
    
    --HG--
    branch : HEAD

diff --git a/src/lib-storage/index/maildir/maildir-mail.c b/src/lib-storage/index/maildir/maildir-mail.c
index 457567a02..55a7277b3 100644
--- a/src/lib-storage/index/maildir/maildir-mail.c
+++ b/src/lib-storage/index/maildir/maildir-mail.c
@@ -152,6 +152,14 @@ maildir_mail_get_fname(struct maildir_mailbox *mbox, struct mail *mail,
 	if (*fname_r != NULL)
 		return TRUE;
 
+	/* refresh uidlist and check again in case it was added after the last
+	   mailbox sync */
+	if (maildir_uidlist_refresh(mbox->uidlist) < 0)
+		return FALSE;
+	*fname_r = maildir_uidlist_lookup(mbox->uidlist, mail->uid, &flags);
+	if (*fname_r != NULL)
+		return TRUE;
+
 	/* file exists in index file, but not in dovecot-uidlist anymore. */
 	mail_set_expunged(mail);
 

