commit aa851e365b3f62ad86cf599860217b60e02dc893
Author: Marcelo Tosatti <mtosatti@redhat.com>
Date:   Thu Oct 21 13:35:01 2010 -0200

    kvm: add save/restore of MSR_VM_HSAVE_PA
    
    commit 2bba4446746add456ceeb0e8359a43032a2ea333
    Author: Alexander Graf <agraf@suse.de>
    Date:   Thu Dec 18 15:38:32 2008 +0100
    
        Enable nested SVM support in userspace
    
    Signed-off-by: Marcelo Tosatti <mtosatti@redhat.com>

diff --git a/target-i386/kvm.c b/target-i386/kvm.c
index 587ee195da..e6c9a1d8f1 100644
--- a/target-i386/kvm.c
+++ b/target-i386/kvm.c
@@ -790,6 +790,7 @@ static int kvm_put_msrs(CPUState *env, int level)
     kvm_msr_entry_set(&msrs[n++], MSR_IA32_SYSENTER_EIP, env->sysenter_eip);
     if (kvm_has_msr_star(env))
 	kvm_msr_entry_set(&msrs[n++], MSR_STAR, env->star);
+    kvm_msr_entry_set(&msrs[n++], MSR_VM_HSAVE_PA, env->vm_hsave);
 #ifdef TARGET_X86_64
     /* FIXME if lm capable */
     kvm_msr_entry_set(&msrs[n++], MSR_CSTAR, env->cstar);
@@ -1015,6 +1016,7 @@ static int kvm_get_msrs(CPUState *env)
     msrs[n++].index = MSR_IA32_SYSENTER_EIP;
     if (kvm_has_msr_star(env))
 	msrs[n++].index = MSR_STAR;
+    msrs[n++].index = MSR_VM_HSAVE_PA;
     msrs[n++].index = MSR_IA32_TSC;
 #ifdef TARGET_X86_64
     /* FIXME lm_capable_kernel */
@@ -1071,6 +1073,9 @@ static int kvm_get_msrs(CPUState *env)
         case MSR_IA32_TSC:
             env->tsc = msrs[i].data;
             break;
+        case MSR_VM_HSAVE_PA:
+            env->vm_hsave = msrs[i].data;
+            break;
         case MSR_KVM_SYSTEM_TIME:
             env->system_time_msr = msrs[i].data;
             break;

