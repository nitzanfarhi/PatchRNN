commit 571370c1555d2aa697733479a50957aff024bbcb
Author: Lennart Poettering <lennart@poettering.net>
Date:   Fri Jan 8 02:46:59 2016 +0100

    resolved: when we get a packet failure from a server, don't downgrade UDP to TCP or vice versa
    
    Under the assumption that packet failures (i.e. FORMERR, SERVFAIL, NOTIMP) are caused by packet contents, not used
    transport, we shouldn't switch between UDP and TCP when we get them, but only downgrade the higher levels down to UDP.

diff --git a/src/resolve/resolved-dns-server.c b/src/resolve/resolved-dns-server.c
index 0de6c8cec..1600e7c29 100644
--- a/src/resolve/resolved-dns-server.c
+++ b/src/resolve/resolved-dns-server.c
@@ -277,6 +277,14 @@ void dns_server_packet_failed(DnsServer *s, DnsServerFeatureLevel level) {
         if (s->possible_feature_level != level)
                 return;
 
+        /* Invoked whenever we get a FORMERR, SERVFAIL or NOTIMP rcode from a server. This is an immediate trigger for
+         * us to go one feature level down. Except when we are already at TCP or UDP level, in which case there's no
+         * point in changing, under the assumption that packet failures are caused by packet contents, not by used
+         * transport. */
+
+        if (s->possible_feature_level <= DNS_SERVER_FEATURE_LEVEL_UDP)
+                return;
+
         s->n_failed_attempts  = (unsigned) -1;
 }
 

