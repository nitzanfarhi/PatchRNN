commit 5ee01f49c963d5e0b530344f86535ecb7f672064
Author: Jeremy Fitzhardinge <jeremy.fitzhardinge@citrix.com>
Date:   Thu Mar 18 14:31:30 2010 -0400

    x86/PCI: make sure _PAGE_IOMAP it set on pci mappings
    
    When mapping pci space via /sys or /proc, make sure we're really
    doing a hardware mapping by setting _PAGE_IOMAP.
    
    [ Impact: bugfix; make PCI mappings map the right pages ]
    
    Signed-off-by: Jeremy Fitzhardinge <jeremy.fitzhardinge@citrix.com>
    Reviewed-by: Konrad Rzeszutek Wilk <konrad.wilk@oracle.com>
    Reviewed-by: "H. Peter Anvin" <hpa@zytor.com>
    Reviewed-by: Matthew Wilcox <willy@linux.intel.com>
    Acked-by: Jesse Barnes <jbarnes@virtuousgeek.org>
    Cc: x86@kernel.org

diff --git a/arch/x86/pci/i386.c b/arch/x86/pci/i386.c
index 55253095be84..8379c2c3d076 100644
--- a/arch/x86/pci/i386.c
+++ b/arch/x86/pci/i386.c
@@ -311,6 +311,8 @@ int pci_mmap_page_range(struct pci_dev *dev, struct vm_area_struct *vma,
 		 */
 		prot |= _PAGE_CACHE_UC_MINUS;
 
+	prot |= _PAGE_IOMAP;	/* creating a mapping for IO */
+
 	vma->vm_page_prot = __pgprot(prot);
 
 	if (io_remap_pfn_range(vma, vma->vm_start, vma->vm_pgoff,

