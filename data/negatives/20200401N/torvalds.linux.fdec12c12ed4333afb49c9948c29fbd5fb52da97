commit fdec12c12ed4333afb49c9948c29fbd5fb52da97
Author: Christoffer Dall <christoffer.dall@linaro.org>
Date:   Thu Dec 10 22:46:50 2015 +0100

    KVM: arm/arm64: vgic: Fix kvm_vgic_map_is_active's dist check
    
    External inputs to the vgic from time to time need to poke into the
    state of a virtual interrupt, the prime example is the architected timer
    code.
    
    Since the IRQ's active state can be represented in two places; the LR or
    the distributor, we first loop over the LRs but if not active in the LRs
    we just return if *any* IRQ is active on the VCPU in question.
    
    This is of course bogus, as we should check if the specific IRQ in
    quesiton is active on the distributor instead.
    
    Reported-by: Eric Auger <eric.auger@linaro.org>
    Acked-by: Marc Zyngier <marc.zyngier@arm.com>
    Signed-off-by: Christoffer Dall <christoffer.dall@linaro.org>
    Signed-off-by: Marc Zyngier <marc.zyngier@arm.com>

diff --git a/virt/kvm/arm/vgic.c b/virt/kvm/arm/vgic.c
index 65461f821a75..7a2f449bd85d 100644
--- a/virt/kvm/arm/vgic.c
+++ b/virt/kvm/arm/vgic.c
@@ -1114,7 +1114,7 @@ bool kvm_vgic_map_is_active(struct kvm_vcpu *vcpu, struct irq_phys_map *map)
 			return true;
 	}
 
-	return dist_active_irq(vcpu);
+	return vgic_irq_is_active(vcpu, map->virt_irq);
 }
 
 /*

