commit 87ed89d21ede38f86be9419ca7c6dd4761764bbb
Author: Tanya Brokhman <tlinder@codeaurora.org>
Date:   Tue Apr 1 11:01:12 2014 +0300

    UBI: fix error path in __wl_get_peb
    
    In case of an error (if there are not free PEB's for example),
    __wl_get_peb will return a negative value. In order to prevent access
    violation we need to test the returned value prior to using it later on.
    
    Signed-off-by: Tatyana Brokhman <tlinder@codeaurora.org>
    Reviewed-by: Dolev Raviv <draviv@codeaurora.org>
    Acked-by: Richard Weinberger <richard@nod.at>
    Signed-off-by: Artem Bityutskiy <artem.bityutskiy@linux.intel.com>

diff --git a/drivers/mtd/ubi/wl.c b/drivers/mtd/ubi/wl.c
index 02317c1c0238..457ead32105c 100644
--- a/drivers/mtd/ubi/wl.c
+++ b/drivers/mtd/ubi/wl.c
@@ -684,6 +684,9 @@ int ubi_wl_get_peb(struct ubi_device *ubi)
 	peb = __wl_get_peb(ubi);
 	spin_unlock(&ubi->wl_lock);
 
+	if (peb < 0)
+		return peb;
+
 	err = ubi_self_check_all_ff(ubi, peb, ubi->vid_hdr_aloffset,
 				    ubi->peb_size - ubi->vid_hdr_aloffset);
 	if (err) {

