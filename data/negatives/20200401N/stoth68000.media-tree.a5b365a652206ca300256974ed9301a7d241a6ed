commit a5b365a652206ca300256974ed9301a7d241a6ed
Author: Christoph Hellwig <hch@lst.de>
Date:   Tue May 25 14:17:54 2010 +0200

    virtio-blk: fix minimum number of S/G elements
    
    We need at least one S/G element to operate properly, as does the block
    layer which increments it to one anyway.  We hit this due to a qemu
    bug which advertises a sg_elements of 0 under some circumstances.
    
    Signed-off-by: Christoph Hellwig <hch@lst.de>
    Signed-off-by: Rusty Russell <rusty@rustcorp.com.au> (tweaked logic)

diff --git a/drivers/block/virtio_blk.c b/drivers/block/virtio_blk.c
index 83fa09a836ca..258bc2ae2885 100644
--- a/drivers/block/virtio_blk.c
+++ b/drivers/block/virtio_blk.c
@@ -298,7 +298,9 @@ static int __devinit virtblk_probe(struct virtio_device *vdev)
 	err = virtio_config_val(vdev, VIRTIO_BLK_F_SEG_MAX,
 				offsetof(struct virtio_blk_config, seg_max),
 				&sg_elems);
-	if (err)
+
+	/* We need at least one SG element, whatever they say. */
+	if (err || !sg_elems)
 		sg_elems = 1;
 
 	/* We need an extra sg elements at head and tail. */

