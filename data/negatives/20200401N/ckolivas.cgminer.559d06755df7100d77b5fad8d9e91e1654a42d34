commit 559d06755df7100d77b5fad8d9e91e1654a42d34
Author: Mikeqin <Fengling.Qin@gmail.com>
Date:   Sun May 10 17:02:49 2015 +0800

    Change delay to macro

diff --git a/driver-avalon4-mini.c b/driver-avalon4-mini.c
index bee5e1a4..2bf53d49 100644
--- a/driver-avalon4-mini.c
+++ b/driver-avalon4-mini.c
@@ -35,7 +35,7 @@ uint32_t opt_avalonm_freq[3] = {AVAM_DEFAULT_FREQUENCY,
 			   AVAM_DEFAULT_FREQUENCY,
 			   AVAM_DEFAULT_FREQUENCY};
 uint16_t opt_avalonm_ntime_offset = 0;
-static uint32_t g_delay_ms = 100 * AVAM_ASIC_TIMEOUT_100M / AVAM_DEFAULT_FREQUENCY / 4;
+static uint32_t g_delay_ms = CAL_DELAY(AVAM_DEFAULT_FREQUENCY);
 int opt_avalonm_voltage = AVAM_DEFAULT_VOLTAGE;
 static uint32_t g_freq_array[][2] = {
 	{100, 0x1e678447},
@@ -319,7 +319,7 @@ static void avalonm_set_freq(struct cgpu_info *avalonm)
 			max_freq = opt_avalonm_freq[i];
 	}
 
-	g_delay_ms = 100 * AVAM_ASIC_TIMEOUT_100M / max_freq / 4;
+	g_delay_ms = CAL_DELAY(max_freq);
 
 	memset(send_pkg.data, 0, AVAM_P_DATA_LEN);
 	tmp = avalonm_get_cpm(info->set_frequency[0]);
diff --git a/driver-avalon4-mini.h b/driver-avalon4-mini.h
index 98c896e1..0258a50b 100644
--- a/driver-avalon4-mini.h
+++ b/driver-avalon4-mini.h
@@ -25,6 +25,8 @@
 #define AVAM_DEFAULT_VOLTAGE_MAX	9000
 #define AVAM_DEFAULT_VOLTAGE	6875
 
+#define CAL_DELAY(freq)	(100 * AVAM_ASIC_TIMEOUT_100M / (freq) / 4)
+
 /* 2 ^ 32 * 1000 / (10 ^ 8 * 3968 / 65.0) ~= 703 ms */
 #define AVAM_ASIC_TIMEOUT_100M	703
 /* Avalon4 protocol package type from MM protocol.h

