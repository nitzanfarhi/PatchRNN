commit 3185bf8c23149f32d7e7363b84539ea50b26ecb1
Author: Xiaotian Feng <dfeng@redhat.com>
Date:   Fri Aug 13 16:23:06 2010 +0800

    KVM: destroy workqueue on kvm_create_pit() failures
    
    kernel needs to destroy workqueue if kvm_create_pit() fails, otherwise
    after pit is freed, the workqueue is leaked.
    
    Signed-off-by: Xiaotian Feng <dfeng@redhat.com>
    Cc: Avi Kivity <avi@redhat.com>
    Cc: Marcelo Tosatti <mtosatti@redhat.com>
    Cc: Thomas Gleixner <tglx@linutronix.de>
    Cc: Ingo Molnar <mingo@redhat.com>
    Cc: "H. Peter Anvin" <hpa@zytor.com>
    Cc: Gleb Natapov <gleb@redhat.com>
    Cc: "Michael S. Tsirkin" <mst@redhat.com>
    Cc: Gregory Haskins <ghaskins@novell.com>
    Signed-off-by: Avi Kivity <avi@redhat.com>

diff --git a/arch/x86/kvm/i8254.c b/arch/x86/kvm/i8254.c
index 0fd6378981f4..f539c3c2a687 100644
--- a/arch/x86/kvm/i8254.c
+++ b/arch/x86/kvm/i8254.c
@@ -742,7 +742,7 @@ fail:
 	kvm_unregister_irq_mask_notifier(kvm, 0, &pit->mask_notifier);
 	kvm_unregister_irq_ack_notifier(kvm, &pit_state->irq_ack_notifier);
 	kvm_free_irq_source_id(kvm, pit->irq_source_id);
-
+	destroy_workqueue(pit->wq);
 	kfree(pit);
 	return NULL;
 }

