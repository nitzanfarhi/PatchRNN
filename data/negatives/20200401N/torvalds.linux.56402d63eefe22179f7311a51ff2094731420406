commit 56402d63eefe22179f7311a51ff2094731420406
Author: Thomas Gleixner <tglx@linutronix.de>
Date:   Fri May 6 20:48:16 2016 +0200

    x86/topology: Handle CPUID bogosity gracefully
    
    Joseph reported that a XEN guest dies with a division by 0 in the package
    topology setup code. This happens if cpu_info.x86_max_cores is zero.
    
    Handle that case and emit a warning. This does not fix the underlying XEN bug,
    but makes the code more robust.
    
    Reported-and-tested-by: Joseph Salisbury <joseph.salisbury@canonical.com>
    Cc: Peter Zijlstra <peterz@infradead.org>
    Cc: Boris Ostrovsky <boris.ostrovsky@oracle.com>
    Cc: David Vrabel <david.vrabel@citrix.com>
    Link: http://lkml.kernel.org/r/alpine.DEB.2.11.1605062046270.3540@nanos
    Signed-off-by: Thomas Gleixner <tglx@linutronix.de>

diff --git a/arch/x86/kernel/smpboot.c b/arch/x86/kernel/smpboot.c
index a2065d3b3b39..0e4329ed91ef 100644
--- a/arch/x86/kernel/smpboot.c
+++ b/arch/x86/kernel/smpboot.c
@@ -332,6 +332,11 @@ static void __init smp_init_package_map(void)
 	 * primary cores.
 	 */
 	ncpus = boot_cpu_data.x86_max_cores;
+	if (!ncpus) {
+		pr_warn("x86_max_cores == zero !?!?");
+		ncpus = 1;
+	}
+
 	__max_logical_packages = DIV_ROUND_UP(total_cpus, ncpus);
 
 	/*

