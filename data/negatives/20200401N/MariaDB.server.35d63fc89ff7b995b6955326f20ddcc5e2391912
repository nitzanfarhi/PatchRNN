commit 35d63fc89ff7b995b6955326f20ddcc5e2391912
Author: Zardosht Kasheff <zardosht@tokutek.com>
Date:   Wed Apr 17 00:02:06 2013 -0400

    [t:3875], fix a bug where we forgot to reset size of range query buffer
    
    git-svn-id: file:///svn/mysql/tokudb-engine/tokudb-engine@33988 c7de825b-a66e-492c-adef-691d508d4ae1

diff --git a/storage/tokudb/ha_tokudb.cc b/storage/tokudb/ha_tokudb.cc
index cdbb9ba3af4..c792a7f76d6 100644
--- a/storage/tokudb/ha_tokudb.cc
+++ b/storage/tokudb/ha_tokudb.cc
@@ -4933,8 +4933,10 @@ int ha_tokudb::fill_range_query_buf(
             );
         if (range_query_buff == NULL) {
             error = ENOMEM;
+            invalidate_bulk_fetch();
             goto cleanup;
         }
+        size_range_query_buff = bytes_used_in_range_query_buff+size_needed;
     }
     //
     // now we know we have the size, let's fill the buffer, starting with the key

