commit 5842f5768599094758931b74190cdf93641a8e35
Author: Konrad Rzeszutek Wilk <konrad.wilk@oracle.com>
Date:   Wed May 23 12:56:59 2012 -0400

    xen/hvc: Check HVM_PARAM_CONSOLE_[EVTCHN|PFN] for correctness.
    
    We need to make sure that those parameters are setup to be correct.
    As such the value of 0 is deemed invalid and we find that we
    bail out. The hypervisor sets by default all of them to be zero
    and when the hypercall is done does a simple:
    
     a.value = d->arch.hvm_domain.params[a.index];
    
    Which means that if the Xen toolstack forgot to setup the proper
    HVM_PARAM_CONSOLE_EVTCHN (or the PFN one), we would get the
    default value of 0 and use that.
    
    CC: stable@kernel.org
    Fixes-Oracle-Bug: 14091238
    Signed-off-by: Konrad Rzeszutek Wilk <konrad.wilk@oracle.com>

diff --git a/drivers/tty/hvc/hvc_xen.c b/drivers/tty/hvc/hvc_xen.c
index 3277f0eec4a7..944eaeb8e0cf 100644
--- a/drivers/tty/hvc/hvc_xen.c
+++ b/drivers/tty/hvc/hvc_xen.c
@@ -214,14 +214,19 @@ static int xen_hvm_console_init(void)
 	/* already configured */
 	if (info->intf != NULL)
 		return 0;
-
+	/*
+	 * If the toolstack (or the hypervisor) hasn't set these values, the
+	 * default value is 0. Even though mfn = 0 and evtchn = 0 are
+	 * theoretically correct values, in practice they never are and they
+	 * mean that a legacy toolstack hasn't initialized the pv console correctly.
+	 */
 	r = hvm_get_parameter(HVM_PARAM_CONSOLE_EVTCHN, &v);
-	if (r < 0)
+	if (r < 0 || v == 0)
 		goto err;
 	info->evtchn = v;
 	v = 0;
 	r = hvm_get_parameter(HVM_PARAM_CONSOLE_PFN, &v);
-	if (r < 0)
+	if (r < 0 || v == 0)
 		goto err;
 	mfn = v;
 	info->intf = ioremap(mfn << PAGE_SHIFT, PAGE_SIZE);

