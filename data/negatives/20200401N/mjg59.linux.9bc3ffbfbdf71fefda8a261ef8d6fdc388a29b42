commit 9bc3ffbfbdf71fefda8a261ef8d6fdc388a29b42
Author: Andrew Patterson <andrew.patterson@hp.com>
Date:   Thu Sep 4 14:27:30 2008 -0600

    Check for device resize when rescanning partitions
    
    Check for device resize in the rescan_partitions() routine. If the device
    has been resized, the bdev size is set to match. The rescan_partitions()
    routine is called when opening the device and when calling the
    BLKRRPART ioctl.
    
    Signed-off-by: Andrew Patterson <andrew.patterson@hp.com>
    Signed-off-by: Jens Axboe <jens.axboe@oracle.com>

diff --git a/fs/partitions/check.c b/fs/partitions/check.c
index 0e411603fdf5..7408227c49c9 100644
--- a/fs/partitions/check.c
+++ b/fs/partitions/check.c
@@ -504,7 +504,6 @@ int rescan_partitions(struct gendisk *disk, struct block_device *bdev)
 	res = invalidate_partition(disk, 0);
 	if (res)
 		return res;
-	bdev->bd_invalidated = 0;
 
 	disk_part_iter_init(&piter, disk, DISK_PITER_INCL_EMPTY);
 	while ((part = disk_part_iter_next(&piter)))
@@ -513,6 +512,8 @@ int rescan_partitions(struct gendisk *disk, struct block_device *bdev)
 
 	if (disk->fops->revalidate_disk)
 		disk->fops->revalidate_disk(disk);
+	check_disk_size_change(disk, bdev);
+	bdev->bd_invalidated = 0;
 	if (!get_capacity(disk) || !(state = check_partition(disk, bdev)))
 		return 0;
 	if (IS_ERR(state))	/* I/O error reading the partition table */

