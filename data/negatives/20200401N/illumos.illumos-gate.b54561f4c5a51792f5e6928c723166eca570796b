commit b54561f4c5a51792f5e6928c723166eca570796b
Author: nakanon <none@none>
Date:   Mon Jul 30 15:25:23 2007 -0700

    6465359 Exclusion dependencies could make svcadm milestone spin

diff --git a/usr/src/cmd/svc/startd/graph.c b/usr/src/cmd/svc/startd/graph.c
index 9c2aa69ae2..d70d4bf2f7 100644
--- a/usr/src/cmd/svc/startd/graph.c
+++ b/usr/src/cmd/svc/startd/graph.c
@@ -4002,6 +4002,16 @@ disable_nonsubgraph_leaves(graph_vertex_t *v, void *arg)
 {
 	assert(PTHREAD_MUTEX_HELD(&dgraph_lock));
 
+	/*
+	 * We must skip exclusion dependencies because they are allowed to
+	 * complete dependency cycles.  This is correct because A's exclusion
+	 * dependency on B doesn't bear on the order in which they should be
+	 * stopped.  Indeed, the exclusion dependency should guarantee that
+	 * they are never online at the same time.
+	 */
+	if (v->gv_type == GVT_GROUP && v->gv_depgroup == DEPGRP_EXCLUDE_ALL)
+		return;
+
 	/* If v isn't an instance, recurse on its dependencies. */
 	if (v->gv_type != GVT_INST)
 		goto recurse;

