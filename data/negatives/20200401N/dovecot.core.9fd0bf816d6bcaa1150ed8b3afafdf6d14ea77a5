commit 9fd0bf816d6bcaa1150ed8b3afafdf6d14ea77a5
Author: Timo Sirainen <tss@iki.fi>
Date:   Wed Mar 5 02:53:05 2008 +0200

    uncork stream only after syncing to avoid extra writes.
    
    --HG--
    branch : HEAD

diff --git a/src/imap/client.c b/src/imap/client.c
index 4fd63ddd7..a8efc2457 100644
--- a/src/imap/client.c
+++ b/src/imap/client.c
@@ -763,16 +763,16 @@ int client_output(struct client *client)
 			break;
 		}
 	}
-	o_stream_uncork(client->output);
 
 	if (client->output->closed) {
 		client_destroy(client, NULL);
 		return 1;
 	} else {
 		(void)cmd_sync_delayed(client);
+		o_stream_uncork(client->output);
 		client_continue_pending_input(&client);
+		return ret;
 	}
-	return ret;
 }
 
 void clients_init(void)

