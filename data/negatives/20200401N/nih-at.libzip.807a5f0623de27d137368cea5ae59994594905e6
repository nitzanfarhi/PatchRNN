commit 807a5f0623de27d137368cea5ae59994594905e6
Author: Dieter Baron <dillo@nih.at>
Date:   Sat Jul 14 16:37:11 2012 +0200

    Fix some errors found by LLVM.

diff --git a/lib/zip_close.c b/lib/zip_close.c
index 098a9c2..a87820f 100644
--- a/lib/zip_close.c
+++ b/lib/zip_close.c
@@ -152,7 +152,9 @@ zip_close(struct zip *za)
 	/* create new local directory entry */
 	if (entry->changes == NULL) {
 	    if ((entry->changes=_zip_dirent_clone(entry->orig)) == NULL) {
-		/* XXX: error */
+                _zip_error_set(&za->error, ZIP_ER_MEMORY, 0);
+                error = 1;
+                break;
 	    }
 	}
 	de = entry->changes;
diff --git a/lib/zip_dirent.c b/lib/zip_dirent.c
index 2457c96..cf904db 100644
--- a/lib/zip_dirent.c
+++ b/lib/zip_dirent.c
@@ -495,8 +495,6 @@ static struct zip_string *
 _zip_dirent_process_ef_utf_8(struct zip_dirent *de, zip_uint16_t id, struct zip_string *str)
 {
     zip_uint16_t ef_len;
-    zip_uint8_t string;
-    zip_uint32_t string_len;
     zip_uint32_t ef_crc;
 
     const zip_uint8_t *ef = _zip_ef_get_by_id(de->extra_fields, &ef_len, id, 0, ZIP_EF_BOTH, NULL);
diff --git a/lib/zip_extra_field.c b/lib/zip_extra_field.c
index 9799880..523410c 100644
--- a/lib/zip_extra_field.c
+++ b/lib/zip_extra_field.c
@@ -191,12 +191,10 @@ struct zip_extra_field *
 _zip_ef_parse(const zip_uint8_t *data, zip_uint16_t len, zip_flags_t flags, struct zip_error *error)
 {
     struct zip_extra_field *ef, *ef2, *ef_head;
-    int i;
     const zip_uint8_t *p;
     zip_uint16_t fid, flen;
 
     ef_head = NULL;
-    i = 0;
     for (p=data; p<data+len; p+=flen+4) {
 	if (p+4 > data+len) {
 	    _zip_error_set(error, ZIP_ER_INCONS, 0);
diff --git a/lib/zip_extra_field_api.c b/lib/zip_extra_field_api.c
index bbb0f75..ff91766 100644
--- a/lib/zip_extra_field_api.c
+++ b/lib/zip_extra_field_api.c
@@ -216,6 +216,7 @@ zip_file_extra_field_set(struct zip *za, zip_uint64_t idx, zip_uint16_t ef_id, z
 
     ef = de->extra_fields;
     ef_prev = NULL;
+    i = 0;
     found = 0;
 
     for (; ef; ef=ef->next) {
diff --git a/lib/zip_source_error.c b/lib/zip_source_error.c
index 433b450..c4885f7 100644
--- a/lib/zip_source_error.c
+++ b/lib/zip_source_error.c
@@ -43,6 +43,10 @@ zip_source_error(struct zip_source *src, int *ze, int *se)
     int e[2];
 
     if (src->src == NULL) {
+        if (src->cb.f(src->ud, e, sizeof(e), ZIP_SOURCE_ERROR) < 0) {
+            e[0] = ZIP_ER_INTERNAL;
+            e[1] = 0;
+        }
     }
     else {
 	switch (src->error_source) {

