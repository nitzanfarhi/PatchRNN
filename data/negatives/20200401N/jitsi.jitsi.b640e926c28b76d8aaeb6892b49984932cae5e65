commit b640e926c28b76d8aaeb6892b49984932cae5e65
Author: Ingo Bauersachs <ingo@jitsi.org>
Date:   Sun Dec 3 20:28:40 2017 +0100

    Add %ProgramData%\Jitsi\native to java.libary.path

diff --git a/src/native/windows/run/run.c b/src/native/windows/run/run.c
index e26bfe942..e20086f9b 100644
--- a/src/native/windows/run/run.c
+++ b/src/native/windows/run/run.c
@@ -439,30 +439,29 @@ Run_getJavaExeCommandLine(LPCTSTR javaExe, LPTSTR *commandLine)
 static LPTSTR
 Run_getJavaLibraryPath()
 {
-    LPCTSTR relativeJavaLibraryPath = _T("native");
-    TCHAR javaLibraryPath[MAX_PATH + 1];
-    DWORD javaLibraryPathCapacity
-        = sizeof(javaLibraryPath) / sizeof(TCHAR);
-    DWORD javaLibraryPathLength
-        = GetFullPathName(
-                relativeJavaLibraryPath,
-                javaLibraryPathCapacity, javaLibraryPath,
-                NULL);
-    LPCTSTR dup;
-
-    if (javaLibraryPathLength
-            && (javaLibraryPathLength < javaLibraryPathCapacity))
+    TCHAR installedNativePath[MAX_PATH];
+    size_t installedNativePathLength = GetFullPathName(_T("native"), MAX_PATH, installedNativePath, NULL);
+    if (!installedNativePathLength || installedNativePathLength >= MAX_PATH)
     {
-        LPTSTR str = javaLibraryPath;
+        return _tcsdup(_T(""));
+    }
 
-        str += javaLibraryPathLength;
-        *str = 0;
+    TCHAR javaSharedLibraryPath[MAX_PATH];
+    HRESULT hr = SHGetFolderPath(NULL, CSIDL_COMMON_APPDATA, 0, SHGFP_TYPE_CURRENT, javaSharedLibraryPath);
+    if (FAILED(hr))
+    {
+        return _tcsdup(_T(""));
+    }
 
-        dup = javaLibraryPath;
+    TCHAR javaLibraryPath[MAX_PATH];
+    memset(javaLibraryPath, 0, sizeof(javaLibraryPath));
+    size_t javaLibraryPathLength = _sntprintf(javaLibraryPath, MAX_PATH, _T("%s;%s\\%s\\native"), installedNativePath, javaSharedLibraryPath, _T(PRODUCTNAME));
+    if (javaLibraryPathLength < 0 || javaLibraryPathLength >= MAX_PATH)
+    {
+        return _tcsdup(_T(""));
     }
-    else
-        dup = relativeJavaLibraryPath;
-    return _tcsdup(dup);
+
+    return _tcsdup(javaLibraryPath);
 }
 
 static LONG

