commit 5898a366bebb8c7980e2e1a8fe1d1e0cafd5abc7
Author: aland <aland>
Date:   Fri Jun 15 09:49:38 2007 +0000

            listen sections find clients by:
    
            - clients = foo
                    look for clients foo {} section that contains clients.
            - identity bar {}
                    Look for clients in the identity section
            - else mainconfig.config

diff --git a/src/main/listen.c b/src/main/listen.c
index e6685383e..a8385d87a 100644
--- a/src/main/listen.c
+++ b/src/main/listen.c
@@ -289,14 +289,29 @@ static int common_socket_parse(const char *filename, int lineno,
 	rcode = cf_item_parse(cs, "clients", PW_TYPE_STRING_PTR,
 			      &section_name, NULL);
 	if (rcode < 0) return -1; /* bad string */
-	if (rcode > 0) return 0; /* non-existent is OK. */
+	if (rcode == 0) {
+		/*
+		 *	Explicit list given: use it.
+		 */
+		client_cs = cf_section_find(section_name);
+		free(section_name);
+		if (!client_cs) {
+			radlog(L_CONS|L_ERR, "%s[%d]: Failed to find client section %s",
+			       filename, cf_section_lineno(cs), section_name);
+			return -1;
+		}
 
-	client_cs = cf_section_find(section_name);
-	free(section_name);
-	if (!client_cs) {
-		radlog(L_CONS|L_ERR, "%s[%d]: Failed to find client section %s",
-		       filename, cf_section_lineno(cs), section_name);
-		return -1;
+	} else if (this->identity) { /* no "clients = ", try using identity */
+		/*
+		 *	Else base it off of the identity.
+		 */
+		client_cs = cf_section_sub_find_name2(mainconfig.config,
+						      "identity",
+						      this->identity);
+		if (!client_cs) client_cs = mainconfig.config;
+
+	} else {
+		client_cs = mainconfig.config;
 	}
 
 	sock->clients = clients_parse_section(filename, client_cs);

