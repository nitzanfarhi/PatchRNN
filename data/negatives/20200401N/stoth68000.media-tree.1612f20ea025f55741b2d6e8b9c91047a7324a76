commit 1612f20ea025f55741b2d6e8b9c91047a7324a76
Author: Hans Verkuil <hverkuil@xs4all.nl>
Date:   Thu Jul 24 09:19:37 2014 -0300

    [media] vb2: fix vb2_poll for output streams
    
    vb2_poll should always return POLLOUT | POLLWRNORM as long as there
    are fewer buffers queued than there are buffers available. Poll for
    an output stream should only wait if all buffers are queued and nobody
    is dequeuing them.
    
    Signed-off-by: Hans Verkuil <hansverk@cisco.com>
    Acked-by: Marek Szyprowski <m.szyprowski@samsung.com>
    Signed-off-by: Mauro Carvalho Chehab <m.chehab@samsung.com>

diff --git a/drivers/media/v4l2-core/videobuf2-core.c b/drivers/media/v4l2-core/videobuf2-core.c
index f33508f854a4..c359006074a8 100644
--- a/drivers/media/v4l2-core/videobuf2-core.c
+++ b/drivers/media/v4l2-core/videobuf2-core.c
@@ -2596,6 +2596,13 @@ unsigned int vb2_poll(struct vb2_queue *q, struct file *file, poll_table *wait)
 	if ((list_empty(&q->queued_list) && !vb2_is_streaming(q)) || q->error)
 		return res | POLLERR;
 
+	/*
+	 * For output streams you can write as long as there are fewer buffers
+	 * queued than there are buffers available.
+	 */
+	if (V4L2_TYPE_IS_OUTPUT(q->type) && q->queued_count < q->num_buffers)
+		return res | POLLOUT | POLLWRNORM;
+
 	if (list_empty(&q->done_list))
 		poll_wait(file, &q->done_wq, wait);
 

