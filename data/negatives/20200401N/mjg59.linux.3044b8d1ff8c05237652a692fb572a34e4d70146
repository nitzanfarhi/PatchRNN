commit 3044b8d1ff8c05237652a692fb572a34e4d70146
Author: Breno Leitao <leitao@linux.vnet.ibm.com>
Date:   Wed May 6 10:44:26 2009 +0000

    ixgbe: Return PCI_ERS_RESULT_DISCONNECT when bus is disabled
    
    According to the "PCI Error Recovery" document, if after a recovery,
    the bus is disabled, the error_detected function should return
    PCI_ERS_RESULT_DISCONNECT. Actually ixgbe error_detected function is
    always returning PCI_ERS_RESULT_NEED_RESET, even if the bus is in failure.
    This patch just check if the bus is disabled and then returns
    PCI_ERS_RESULT_DISCONNET.
    
    Signed-off-by: Breno Leitao <leitao@linux.vnet.ibm.com>
    Signed-off-by: Jeff Kirsher <jeffrey.t.kirsher@intel.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

diff --git a/drivers/net/ixgbe/ixgbe_main.c b/drivers/net/ixgbe/ixgbe_main.c
index 2c70fa0add3e..dd56adb2191a 100644
--- a/drivers/net/ixgbe/ixgbe_main.c
+++ b/drivers/net/ixgbe/ixgbe_main.c
@@ -5145,6 +5145,9 @@ static pci_ers_result_t ixgbe_io_error_detected(struct pci_dev *pdev,
 
 	netif_device_detach(netdev);
 
+	if (state == pci_channel_io_perm_failure)
+		return PCI_ERS_RESULT_DISCONNECT;
+
 	if (netif_running(netdev))
 		ixgbe_down(adapter);
 	pci_disable_device(pdev);

