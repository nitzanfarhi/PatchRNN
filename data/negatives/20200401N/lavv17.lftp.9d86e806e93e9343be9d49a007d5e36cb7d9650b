commit 9d86e806e93e9343be9d49a007d5e36cb7d9650b
Author: lav <>
Date:   Fri Feb 14 08:19:50 2003 +0000

            * FileCopy.cc, FileCopyFtp.cc: don't start "put" peer if target file
              is already complete; don't get size multiple times (occasionally).

diff --git a/src/FileCopy.cc b/src/FileCopy.cc
index 04d913d3..9d5fb4a4 100644
--- a/src/FileCopy.cc
+++ b/src/FileCopy.cc
@@ -120,6 +120,12 @@ int FileCopy::Do()
    case(PUT_WAIT):
       if(put->Error())
 	 goto put_error;
+      if(put->GetSeekPos()!=FILE_END && get->GetSize()>=0
+      && put->GetSeekPos()>=get->GetSize())
+      {
+	 debug((9,_("copy: destination file is already complete\n")));
+	 goto pre_GET_DONE_WAIT;
+      }
       if(!put->IOReady())
 	 return m;
       /* now we know if put's seek failed. Seek get accordingly. */
@@ -697,7 +703,7 @@ int FileCopyPeerFA::Do()
 
    if(Done() || Error())
       return m;
-   if(want_size && (mode==PUT || !start_transfer))
+   if(want_size && size==NO_SIZE_YET && (mode==PUT || !start_transfer))
    {
       if(session->IsClosed())
       {
diff --git a/src/FileCopyFtp.cc b/src/FileCopyFtp.cc
index e93cd9e9..858e414a 100644
--- a/src/FileCopyFtp.cc
+++ b/src/FileCopyFtp.cc
@@ -40,7 +40,11 @@ int FileCopyFtp::Do()
    int src_res,dst_res;
    int m=super::Do();
 
-   if(disable_fxp || Error())
+   if(disable_fxp || Error() || !put || !get)
+      return m;
+
+   if(put->GetSeekPos()!=FILE_END && get->GetSize()>=0
+   && put->GetSeekPos()>=get->GetSize())
       return m;
 
    if(state==PUT_WAIT && put->GetSeekPos()!=FILE_END && ftp_dst->IsClosed())

