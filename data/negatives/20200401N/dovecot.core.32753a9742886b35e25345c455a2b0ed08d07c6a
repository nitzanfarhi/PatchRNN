commit 32753a9742886b35e25345c455a2b0ed08d07c6a
Author: Timo Sirainen <tss@iki.fi>
Date:   Mon Feb 19 16:27:17 2007 +0200

    Get pop3_uidl_format even if it's inside protocol pop3 {}
    
    --HG--
    branch : HEAD

diff --git a/src/deliver/deliver.c b/src/deliver/deliver.c
index 1081aaa0e..315b07abc 100644
--- a/src/deliver/deliver.c
+++ b/src/deliver/deliver.c
@@ -189,7 +189,7 @@ static void config_file_init(const char *path)
 	struct istream *input;
 	const char *key, *value;
 	char *line, *p, quote;
-	int fd, sections = 0, lda_section = FALSE;
+	int fd, sections = 0, lda_section = FALSE, pop3_section = FALSE;
 	size_t len;
 
 	fd = open(path, O_RDONLY);
@@ -237,21 +237,27 @@ static void config_file_init(const char *path)
 				if (strcmp(line, "protocol lda {") == 0 ||
 				    strcmp(line, "plugin {") == 0)
 					lda_section = TRUE;
+				if (strcmp(line, "protocol pop3 {") == 0)
+					pop3_section = TRUE;
 				sections++;
 			}
 			if (*line == '}') {
 				sections--;
 				lda_section = FALSE;
+				pop3_section = FALSE;
 			}
 			continue;
 		}
 
-		if (sections > 0 && !lda_section)
-			continue;
-
 		while (p > line && p[-1] == ' ') p--;
 		key = t_strdup_until(line, p);
 
+		if (sections > 0 && !lda_section) {
+			if (!pop3_section ||
+			    strcmp(key, "pop3_uidl_format") != 0)
+				continue;
+		}
+
 		do {
 			value++;
 		} while (*value == ' ');

