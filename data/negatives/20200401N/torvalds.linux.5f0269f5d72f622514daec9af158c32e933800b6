commit 5f0269f5d72f622514daec9af158c32e933800b6
Author: Mikhail Ershov <arcezed@gmail.com>
Date:   Mon Aug 3 14:58:25 2009 +0300

    KVM: Align cr8 threshold when userspace changes cr8
    
    Commit f0a3602c20 ("KVM: Move interrupt injection logic to x86.c") does not
    update the cr8 intercept if the lapic is disabled, so when userspace updates
    cr8, the cr8 threshold control is not updated and we are left with illegal
    control fields.
    
    Fix by explicitly resetting the cr8 threshold.
    
    Signed-off-by: Avi Kivity <avi@redhat.com>

diff --git a/arch/x86/kvm/x86.c b/arch/x86/kvm/x86.c
index f4cb1baaa04b..69de7248083f 100644
--- a/arch/x86/kvm/x86.c
+++ b/arch/x86/kvm/x86.c
@@ -4445,6 +4445,8 @@ int kvm_arch_vcpu_ioctl_set_sregs(struct kvm_vcpu *vcpu,
 	kvm_set_segment(vcpu, &sregs->tr, VCPU_SREG_TR);
 	kvm_set_segment(vcpu, &sregs->ldt, VCPU_SREG_LDTR);
 
+	update_cr8_intercept(vcpu);
+
 	/* Older userspace won't unhalt the vcpu on reset. */
 	if (kvm_vcpu_is_bsp(vcpu) && kvm_rip_read(vcpu) == 0xfff0 &&
 	    sregs->cs.selector == 0xf000 && sregs->cs.base == 0xffff0000 &&

