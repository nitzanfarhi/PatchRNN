commit ca88f5c24a147a04e4f94390ccfced863dfed96c
Author: Hongli Lai (Phusion) <hongli@phusion.nl>
Date:   Tue May 6 21:04:48 2008 +0200

    Fix compilation on OS X.

diff --git a/ext/apache2/MessageChannel.h b/ext/apache2/MessageChannel.h
index d53b8b5eb..9c60f7e83 100644
--- a/ext/apache2/MessageChannel.h
+++ b/ext/apache2/MessageChannel.h
@@ -436,6 +436,8 @@ public:
 		struct iovec vec;
 		char dummy[1];
 		#ifdef __APPLE__
+			// File descriptor passing macros (CMSG_*) seem to be broken
+			// on 64-bit MacOS X. This structure works around the problem.
 			struct {
 				struct cmsghdr header;
 				int fd;
diff --git a/ext/passenger/native_support.c b/ext/passenger/native_support.c
index 8d975c859..f5fb7d70f 100644
--- a/ext/passenger/native_support.c
+++ b/ext/passenger/native_support.c
@@ -43,7 +43,14 @@ send_fd(VALUE self, VALUE socket_fd, VALUE fd_to_send) {
 	struct msghdr msg;
 	struct iovec vec;
 	char dummy[1];
-	char control_data[CMSG_SPACE(sizeof(int))];
+	#ifdef __APPLE__
+		struct {
+			struct cmsghdr header;
+			int fd;
+		} control_data;
+	#else
+		char control_data[CMSG_SPACE(sizeof(int))];
+	#endif
 	struct cmsghdr *control_header;
 	int control_payload;
 	
@@ -97,6 +104,8 @@ recv_fd(VALUE self, VALUE socket_fd) {
 	struct iovec vec;
 	char dummy[1];
 	#ifdef __APPLE__
+		// File descriptor passing macros (CMSG_*) seem to be broken
+		// on 64-bit MacOS X. This structure works around the problem.
 		struct {
 			struct cmsghdr header;
 			int fd;

