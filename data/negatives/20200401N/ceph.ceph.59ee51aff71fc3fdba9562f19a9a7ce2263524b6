commit 59ee51aff71fc3fdba9562f19a9a7ce2263524b6
Author: Sage Weil <sage@inktank.com>
Date:   Fri Sep 20 20:43:00 2013 -0700

    osd/ReplicatedPG: handle COPY_FROM self
    
    Return EINVAL if we try to COPY_FROM ourselves.
    
    Signed-off-by: Sage Weil <sage@inktank.com>

diff --git a/src/osd/ReplicatedPG.cc b/src/osd/ReplicatedPG.cc
index a92403ae37..a48372fe56 100644
--- a/src/osd/ReplicatedPG.cc
+++ b/src/osd/ReplicatedPG.cc
@@ -3532,6 +3532,11 @@ int ReplicatedPG::do_osd_ops(OpContext *ctx, vector<OSDOp>& ops)
 	  hobject_t src(src_name, src_oloc.key, src_snapid,
 			raw_pg.ps(), raw_pg.pool(),
 			src_oloc.nspace);
+	  if (src == soid) {
+	    dout(20) << " copy from self is invalid" << dendl;
+	    result = -EINVAL;
+	    break;
+	  }
 	  result = start_copy(ctx, src, src_oloc, src_version, &ctx->copy_op);
 	  if (result < 0)
 	    goto fail;

