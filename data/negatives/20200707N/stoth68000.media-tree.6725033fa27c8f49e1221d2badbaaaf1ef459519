commit 6725033fa27c8f49e1221d2badbaaaf1ef459519
Author: Joonwoo Park <joonwpark81@gmail.com>
Date:   Fri Jan 18 03:45:18 2008 -0800

    [IPV4] fib_trie: fix duplicated route issue
    
    http://bugzilla.kernel.org/show_bug.cgi?id=9493
    
    The fib allows making identical routes with 'ip route replace'.
    This patch makes the fib return -EEXIST if replacement would cause duplication.
    
    Signed-off-by: Joonwoo Park <joonwpark81@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

diff --git a/net/ipv4/fib_trie.c b/net/ipv4/fib_trie.c
index 8d8c2915e064..1010b469d7d3 100644
--- a/net/ipv4/fib_trie.c
+++ b/net/ipv4/fib_trie.c
@@ -1214,6 +1214,9 @@ static int fn_trie_insert(struct fib_table *tb, struct fib_config *cfg)
 			struct fib_info *fi_drop;
 			u8 state;
 
+			if (fi->fib_treeref > 1)
+				goto out;
+
 			err = -ENOBUFS;
 			new_fa = kmem_cache_alloc(fn_alias_kmem, GFP_KERNEL);
 			if (new_fa == NULL)

