commit 2a6a4da51833411bcacfbb8da6e1c9f2e62a83ba
Author: jacekm <jacekm@openbsd.org>
Date:   Tue May 19 12:33:53 2009 +0000

    Accept STARTTLS only after EHLO; ok gilles@

diff --git a/usr.sbin/smtpd/smtp_session.c b/usr.sbin/smtpd/smtp_session.c
index 47fc8960164..c144576310d 100644
--- a/usr.sbin/smtpd/smtp_session.c
+++ b/usr.sbin/smtpd/smtp_session.c
@@ -1,4 +1,4 @@
-/*	$OpenBSD: smtp_session.c,v 1.90 2009/05/19 11:42:52 jacekm Exp $	*/
+/*	$OpenBSD: smtp_session.c,v 1.91 2009/05/19 12:33:53 jacekm Exp $	*/
 
 /*
  * Copyright (c) 2008 Gilles Chehade <gilles@openbsd.org>
@@ -119,6 +119,11 @@ session_rfc3207_stls_handler(struct session *s, char *args)
 		return 1;
 	}
 
+	if (s->s_state != S_HELO) {
+		session_respond(s, "503 TLS not allowed at this stage");
+		return 1;
+	}
+
 	if (args != NULL) {
 		session_respond(s, "501 No parameters allowed");
 		return 1;

