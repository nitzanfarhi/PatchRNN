commit 33b4de513ee81c2a87e1b954a9544a5eec1f8f94
Author: Justin T. Gibbs <justing@spectralogic.com>
Date:   Sat Nov 22 19:14:24 2014 -0800

    Illumos 5311 - traverse_dnode may report success when it should not
    
    5311 traverse_dnode may report success when it should not
    Reviewed by: Matthew Ahrens <mahrens@delphix.com>
    Reviewed by: Andriy Gapon <avg@FreeBSD.org>
    Reviewed by: Will Andrews <willa@spectralogic.com>
    Approved by: Dan McDonald <danmcd@omniti.com>
    
    References:
      https://github.com/illumos/illumos-gate/commit/2a89c2c
      https://www.illumos.org/issues/5311
    
    Ported by: DHE <git@dehacked.net>
    Signed-off-by: Brian Behlendorf <behlendorf1@llnl.gov>
    Closes #2970

diff --git a/module/zfs/dmu_traverse.c b/module/zfs/dmu_traverse.c
index b090bc2fc..b5c1ec758 100644
--- a/module/zfs/dmu_traverse.c
+++ b/module/zfs/dmu_traverse.c
@@ -438,7 +438,7 @@ traverse_dnode(traverse_data_t *td, const dnode_phys_t *dnp,
 			break;
 	}
 
-	if (dnp->dn_flags & DNODE_FLAG_SPILL_BLKPTR) {
+	if (err == 0 && dnp->dn_flags & DNODE_FLAG_SPILL_BLKPTR) {
 		SET_BOOKMARK(&czb, objset, object, 0, DMU_SPILL_BLKID);
 		err = traverse_visitbp(td, dnp, &dnp->dn_spill, &czb);
 	}

