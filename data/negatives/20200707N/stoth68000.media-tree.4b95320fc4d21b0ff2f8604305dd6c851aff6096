commit 4b95320fc4d21b0ff2f8604305dd6c851aff6096
Author: Wang Zhenyu <zhenyu.z.wang@intel.com>
Date:   Wed Jan 17 11:07:54 2007 +0800

    [AGPGART] intel_agp: restore graphics device's pci space early in resume
    
    Currently in resuming path graphics device's pci space restore is
    behind host bridge, so resume function wrongly accesses graphics
    device's space. This makes resuming failure which crashed X.
    here's a patch to restore device's pci space early, which makes
    resuming ok with X.
    
    Signed-off-by: Wang Zhenyu <zhenyu.z.wang@intel.com>
    Signed-off-by: Dave Jones <davej@redhat.com>

diff --git a/drivers/char/agp/intel-agp.c b/drivers/char/agp/intel-agp.c
index ab0a9c0ad7c0..a3011de51f7c 100644
--- a/drivers/char/agp/intel-agp.c
+++ b/drivers/char/agp/intel-agp.c
@@ -1955,6 +1955,15 @@ static int agp_intel_resume(struct pci_dev *pdev)
 
 	pci_restore_state(pdev);
 
+	/* We should restore our graphics device's config space,
+	 * as host bridge (00:00) resumes before graphics device (02:00),
+	 * then our access to its pci space can work right.
+	 */
+	if (intel_i810_private.i810_dev)
+		pci_restore_state(intel_i810_private.i810_dev);
+	if (intel_i830_private.i830_dev)
+		pci_restore_state(intel_i830_private.i830_dev);
+
 	if (bridge->driver == &intel_generic_driver)
 		intel_configure();
 	else if (bridge->driver == &intel_850_driver)

