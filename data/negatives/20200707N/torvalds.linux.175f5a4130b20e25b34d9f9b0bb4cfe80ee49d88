commit 175f5a4130b20e25b34d9f9b0bb4cfe80ee49d88
Author: Michal Suchanek <hramrach@gmail.com>
Date:   Thu Jun 9 15:08:42 2016 +0000

    staging: fbtft: do not allocate huge txbuf
    
    txbuflen can be set to arbitrary value by user and it is also set
    automagically to the maximum transfer size of the SPI master controller.
    
    Do not allocate the buffer when larger than vmem. When my SPI master
    controller reports maximum transfer size 16M the probe of fbtft fails.
    
    Signed-off-by: Michal Suchanek <hramrach@gmail.com>
    Acked-by: Noralf Tr√∏nnes <noralf@tronnes.org>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

diff --git a/drivers/staging/fbtft/fbtft-core.c b/drivers/staging/fbtft/fbtft-core.c
index 0c1a77cafe14..ce4fd374c3d0 100644
--- a/drivers/staging/fbtft/fbtft-core.c
+++ b/drivers/staging/fbtft/fbtft-core.c
@@ -820,6 +820,8 @@ struct fb_info *fbtft_framebuffer_alloc(struct fbtft_display *display,
 	/* Transmit buffer */
 	if (txbuflen == -1)
 		txbuflen = vmem_size + 2; /* add in case startbyte is used */
+	if (txbuflen >= vmem_size + 2)
+		txbuflen = 0;
 
 #ifdef __LITTLE_ENDIAN
 	if ((!txbuflen) && (bpp > 8))

