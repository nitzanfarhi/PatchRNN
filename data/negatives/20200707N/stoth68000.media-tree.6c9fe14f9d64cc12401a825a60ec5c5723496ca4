commit 6c9fe14f9d64cc12401a825a60ec5c5723496ca4
Author: Qu Wenruo <quwenruo@cn.fujitsu.com>
Date:   Tue Jan 20 17:05:33 2015 +0800

    btrfs: Fix the bug that fs_info->pending_changes is never cleared.
    
    Fs_info->pending_changes is never cleared since the original code uses
    cmpxchg(&fs_info->pending_changes, 0, 0), which will only clear it if
    pending_changes is already 0.
    
    This will cause a lot of problem when mount it with inode_cache mount
    option.
    If the btrfs is mounted as inode_cache, pending_changes will always be
    1, even when the fs is frozen.
    
    Signed-off-by: Qu Wenruo <quwenruo@cn.fujitsu.com>
    Reviewed-by: David Sterba <dsterba@suse.cz>
    Signed-off-by: David Sterba <dsterba@suse.cz>
    Signed-off-by: Chris Mason <clm@fb.com>

diff --git a/fs/btrfs/transaction.c b/fs/btrfs/transaction.c
index a605d4e2f2bc..e88b59d13439 100644
--- a/fs/btrfs/transaction.c
+++ b/fs/btrfs/transaction.c
@@ -2118,7 +2118,7 @@ void btrfs_apply_pending_changes(struct btrfs_fs_info *fs_info)
 	unsigned long prev;
 	unsigned long bit;
 
-	prev = cmpxchg(&fs_info->pending_changes, 0, 0);
+	prev = xchg(&fs_info->pending_changes, 0);
 	if (!prev)
 		return;
 

