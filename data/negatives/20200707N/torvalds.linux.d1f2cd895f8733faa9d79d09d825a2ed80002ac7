commit d1f2cd895f8733faa9d79d09d825a2ed80002ac7
Author: Eli Cohen <eli@dev.mellanox.co.il>
Date:   Mon Jul 14 23:48:45 2008 -0700

    IB/mlx4: Configure QPs' max message size based on real device capability
    
    ConnectX returns the max message size it supports through the
    QUERY_DEV_CAP firmware command.  When modifying a QP to RTR, the max
    message size for the QP must be specified.  This value must not exceed
    the value declared through QUERY_DEV_CAP.  The current code ignores
    the max allowed size and unconditionally sets the value to 2^31.  This
    patch sets all QPs to the max value allowed as returned from firmware.
    
    Signed-off-by: Eli Cohen <eli@mellanox.co.il>
    Signed-off-by: Roland Dreier <rolandd@cisco.com>

diff --git a/drivers/infiniband/hw/mlx4/qp.c b/drivers/infiniband/hw/mlx4/qp.c
index 4b0ac5d68c46..76054a72f71b 100644
--- a/drivers/infiniband/hw/mlx4/qp.c
+++ b/drivers/infiniband/hw/mlx4/qp.c
@@ -908,7 +908,8 @@ static int __mlx4_ib_modify_qp(struct ib_qp *ibqp,
 			       attr->path_mtu);
 			goto out;
 		}
-		context->mtu_msgmax = (attr->path_mtu << 5) | 31;
+		context->mtu_msgmax = (attr->path_mtu << 5) |
+			ilog2(dev->dev->caps.max_msg_sz);
 	}
 
 	if (qp->rq.wqe_cnt)

