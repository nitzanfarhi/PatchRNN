commit bf7919371025412978268efca4b09dd847acb395
Author: Vivek Goyal <vgoyal@redhat.com>
Date:   Thu Dec 3 12:59:37 2009 -0500

    blkio: Set must_dispatch only if we decided to not dispatch the request
    
    o must_dispatch flag should be set only if we decided not to run the queue
      and dispatch the request.
    
    Signed-off-by: Vivek Goyal <vgoyal@redhat.com>
    Signed-off-by: Jens Axboe <jens.axboe@oracle.com>

diff --git a/block/cfq-iosched.c b/block/cfq-iosched.c
index f5b59e18ebd3..15b53616516a 100644
--- a/block/cfq-iosched.c
+++ b/block/cfq-iosched.c
@@ -2490,9 +2490,9 @@ cfq_rq_enqueued(struct cfq_data *cfqd, struct cfq_queue *cfqq,
 			if (blk_rq_bytes(rq) > PAGE_CACHE_SIZE ||
 			    cfqd->busy_queues > 1) {
 				del_timer(&cfqd->idle_slice_timer);
-			__blk_run_queue(cfqd->queue);
-			}
-			cfq_mark_cfqq_must_dispatch(cfqq);
+				__blk_run_queue(cfqd->queue);
+			} else
+				cfq_mark_cfqq_must_dispatch(cfqq);
 		}
 	} else if (cfq_should_preempt(cfqd, cfqq, rq)) {
 		/*

