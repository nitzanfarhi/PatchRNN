commit 333e40aee3f2d0457e2cbadc742619a6f449b2e7
Author: Ian Abbott <abbotti@mev.co.uk>
Date:   Thu Jul 23 16:47:00 2015 +0100

    staging: comedi: usbduxsigma: round down AI scan_begin_arg at step 4.
    
    The return value of the `cmdtest` handler for a subdevice checks the
    prospective new command in various steps and returns the step number at
    which any problem was detected, or 0 if no problem was detected.  It is
    allowed to modify the command in various ways at each step.  Corrections
    for out-of-range values are generally made at step 3, and minor
    adjustments such as rounding are generally made at step 4.
    
    The `cmdtest` handler for the AI subdevice (`usbduxsigma_ai_cmdtest()`)
    currently modifies `cmd->scan_begin_arg` to bring it into range and
    round it down at step 3.  Move the rounding down part to step 4 to
    follow the usual Comedi convention.
    
    Signed-off-by: Ian Abbott <abbotti@mev.co.uk>
    Reviewed-by: Bernd Porr <mail@berndporr.me.uk>
    Reviewed-by: H Hartley Sweeten <hsweeten@visionengravers.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

diff --git a/drivers/staging/comedi/drivers/usbduxsigma.c b/drivers/staging/comedi/drivers/usbduxsigma.c
index fdc880a4adaf..535cf01bca07 100644
--- a/drivers/staging/comedi/drivers/usbduxsigma.c
+++ b/drivers/staging/comedi/drivers/usbduxsigma.c
@@ -519,17 +519,12 @@ static int usbduxsigma_ai_cmdtest(struct comedi_device *dev,
 		 */
 		err |= comedi_check_trigger_arg_min(&cmd->scan_begin_arg,
 						    (125000 * interval));
-
-		tmp = (cmd->scan_begin_arg / 125000) * 125000;
 	} else {
 		/* full speed */
 		/* 1kHz scans every USB frame */
 		err |= comedi_check_trigger_arg_min(&cmd->scan_begin_arg,
 						    1000000);
-
-		tmp = (cmd->scan_begin_arg / 1000000) * 1000000;
 	}
-	err |= comedi_check_trigger_arg_is(&cmd->scan_begin_arg, tmp);
 
 	err |= comedi_check_trigger_arg_is(&cmd->scan_end_arg,
 					   cmd->chanlist_len);
@@ -542,6 +537,14 @@ static int usbduxsigma_ai_cmdtest(struct comedi_device *dev,
 	if (err)
 		return 3;
 
+	/* Step 4: fix up any arguments */
+
+	tmp = rounddown(cmd->scan_begin_arg, high_speed ? 125000 : 1000000);
+	err |= comedi_check_trigger_arg_is(&cmd->scan_begin_arg, tmp);
+
+	if (err)
+		return 4;
+
 	return 0;
 }
 

