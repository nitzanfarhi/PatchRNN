commit b0f2027cde31c645524256763672e09eeb204a9a
Author: Stefan Hajnoczi <stefanha@redhat.com>
Date:   Mon Jul 29 15:02:00 2013 +0200

    dataplane: refuse to start if device is already in use
    
    Dataplane must check whether a block device is in use before launching
    the dataplane thread.  This is necessary since the thread does not
    synchronize with the main loop and I/O requests could cause corruption.
    
    One example is when a drive is added and a block job is started before
    hotplugging the virtio-blk-pci adapter.  In this case we must not use
    dataplane mode.
    
    Cc: qemu-stable@nongnu.org
    Reviewed-by: Kevin Wolf <kwolf@redhat.com>
    Signed-off-by: Stefan Hajnoczi <stefanha@redhat.com>

diff --git a/hw/block/dataplane/virtio-blk.c b/hw/block/dataplane/virtio-blk.c
index 63c3ffabc1..411becc06e 100644
--- a/hw/block/dataplane/virtio-blk.c
+++ b/hw/block/dataplane/virtio-blk.c
@@ -415,6 +415,14 @@ bool virtio_blk_data_plane_create(VirtIODevice *vdev, VirtIOBlkConf *blk,
         return false;
     }
 
+    /* If dataplane is (re-)enabled while the guest is running there could be
+     * block jobs that can conflict.
+     */
+    if (bdrv_in_use(blk->conf.bs)) {
+        error_report("cannot start dataplane thread while device is in use");
+        return false;
+    }
+
     fd = raw_get_aio_fd(blk->conf.bs);
     if (fd < 0) {
         error_report("drive is incompatible with x-data-plane, "

