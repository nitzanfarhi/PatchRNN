commit 9d1ad66e3eae0faf3f19a618da74b4c377474845
Author: Shlomo Pongratz <shlomop@mellanox.com>
Date:   Tue Feb 19 15:40:22 2013 +0000

    IPoIB: Fix ipoib_neigh hashing to use the correct daddr octets
    
    The hash function introduced in commit b63b70d877 ("IPoIB: Use a
    private hash table for path lookup in xmit path") was designd to use
    the 3 octets of the IPoIB HW address that holds the remote QPN.
    However, this currently isn't the case on little-endian machines,
    because the the code there uses the flags part (octet[0]) and not the
    last octet of the QPN (octet[3]).  Fix this.
    
    The fix caused a checkpatch warning on line over 80 characters, to
    solve that changed the name of the temp variable that holds the daddr.
    
    Signed-off-by: Shlomo Pongratz <shlomop@mellanox.com>
    Signed-off-by: Or Gerlitz <ogerlitz@mellanox.com>
    Signed-off-by: Roland Dreier <roland@purestorage.com>

diff --git a/drivers/infiniband/ulp/ipoib/ipoib.h b/drivers/infiniband/ulp/ipoib/ipoib.h
index 07ca6fd5546b..a7ac0977cb5e 100644
--- a/drivers/infiniband/ulp/ipoib/ipoib.h
+++ b/drivers/infiniband/ulp/ipoib/ipoib.h
@@ -117,6 +117,8 @@ enum {
 #define	IPOIB_OP_CM     (0)
 #endif
 
+#define IPOIB_QPN_MASK ((__force u32) cpu_to_be32(0xFFFFFF))
+
 /* structs */
 
 struct ipoib_header {
diff --git a/drivers/infiniband/ulp/ipoib/ipoib_main.c b/drivers/infiniband/ulp/ipoib/ipoib_main.c
index 6fdc9e78da0d..a68628e4197a 100644
--- a/drivers/infiniband/ulp/ipoib/ipoib_main.c
+++ b/drivers/infiniband/ulp/ipoib/ipoib_main.c
@@ -844,10 +844,10 @@ static u32 ipoib_addr_hash(struct ipoib_neigh_hash *htbl, u8 *daddr)
 	 * different subnets.
 	 */
 	 /* qpn octets[1:4) & port GUID octets[12:20) */
-	u32 *daddr_32 = (u32 *) daddr;
+	u32 *d32 = (u32 *) daddr;
 	u32 hv;
 
-	hv = jhash_3words(daddr_32[3], daddr_32[4], 0xFFFFFF & daddr_32[0], 0);
+	hv = jhash_3words(d32[3], d32[4], IPOIB_QPN_MASK & d32[0], 0);
 	return hv & htbl->mask;
 }
 

