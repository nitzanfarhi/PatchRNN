commit 84646ab1c2c40003dd4ae506324947bafefcab1e
Author: Sage Weil <sage@redhat.com>
Date:   Wed Oct 14 08:41:39 2015 -0400

    os/newstore: do not set/change frag_size if there are overlays
    
    Signed-off-by: Sage Weil <sage@redhat.com>

diff --git a/src/os/newstore/NewStore.cc b/src/os/newstore/NewStore.cc
index 19daad887c..77a870b11e 100644
--- a/src/os/newstore/NewStore.cc
+++ b/src/os/newstore/NewStore.cc
@@ -3491,7 +3491,8 @@ int NewStore::_do_write(TransContext *txc,
   _dump_onode(o);
   o->exists = true;
 
-  if (!o->onode.frag_size && o->onode.data_map.empty()) {
+  if (!o->onode.frag_size && o->onode.data_map.empty() &&
+      o->onode.overlay_map.empty()) {
     o->onode.frag_size = g_conf->newstore_min_frag_size;
     dout(20) << __func__ << " set frag_size " << o->onode.frag_size << dendl;
   }
@@ -4332,7 +4333,7 @@ int NewStore::_setallochint(TransContext *txc,
   o->onode.expected_write_size = expected_write_size;
   txc->write_onode(o);
 
-  if (o->onode.data_map.empty()) {
+  if (o->onode.data_map.empty() && o->onode.overlay_map.empty()) {
     // FIXME: we could do something clever with onode.frag_size here.
   }
 

