commit 9d40ea756e1063093eed36bf384f52859e3abab5
Author: Eddie Kohler <ekohler@gmail.com>
Date:   Tue Mar 18 09:03:09 2014 -0400

    Don't select too many colors.
    
    In the unlikely (probably impossible) event that an image has >=2^32-1
    pixels for more colors than we expect.

diff --git a/src/xform.c b/src/xform.c
index 8a34d83..1f24f1a 100644
--- a/src/xform.c
+++ b/src/xform.c
@@ -590,7 +590,8 @@ static int scale_image_add_colors(scale_context* sctx, Gif_Image* gfo) {
     kchist_compress(&kch);
 
     kcdiversity_init(&div, &kch, 0);
-    for (i = 0; i != kch.n && kch.h[i].count == (kchist_count_t) -1; ++i)
+    for (i = 0; i != kch.n && i != gfcm->ncol
+             && kch.h[i].count == (kchist_count_t) -1; ++i)
         kcdiversity_choose(&div, i, 0);
 
     nadded = 0;

