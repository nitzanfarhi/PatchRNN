commit 855a6a93a12b60b2799eb5999baabd7a85a37c99
Author: Kevin Wolf <kwolf@redhat.com>
Date:   Fri Mar 4 14:16:51 2016 +0100

    block: Handle flush error in bdrv_pwrite_sync()
    
    We don't want to silently ignore a flush error.
    
    Also, there is little point in avoiding the flush for writethrough modes
    and once WCE is moved to the BB layer, we definitely need the flush here
    because bdrv_pwrite() won't involve one any more.
    
    Signed-off-by: Kevin Wolf <kwolf@redhat.com>
    Reviewed-by: Max Reitz <mreitz@redhat.com>

diff --git a/block/io.c b/block/io.c
index c8f5401076..b58843594e 100644
--- a/block/io.c
+++ b/block/io.c
@@ -747,9 +747,9 @@ int bdrv_pwrite_sync(BlockDriverState *bs, int64_t offset,
         return ret;
     }
 
-    /* No flush needed for cache modes that already do it */
-    if (bs->enable_write_cache) {
-        bdrv_flush(bs);
+    ret = bdrv_flush(bs);
+    if (ret < 0) {
+        return ret;
     }
 
     return 0;

