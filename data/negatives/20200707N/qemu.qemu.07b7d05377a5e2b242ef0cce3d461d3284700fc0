commit 07b7d05377a5e2b242ef0cce3d461d3284700fc0
Author: Markus Armbruster <armbru@redhat.com>
Date:   Thu Jun 18 15:14:07 2009 +0200

    Fix do_pci_register_device() to reject devfn already in use
    
    Signed-off-by: Markus Armbruster <armbru@redhat.com>
    Signed-off-by: Anthony Liguori <aliguori@us.ibm.com>

diff --git a/hw/pci.c b/hw/pci.c
index 140cdbaa29..da76ecd342 100644
--- a/hw/pci.c
+++ b/hw/pci.c
@@ -267,6 +267,8 @@ static PCIDevice *do_pci_register_device(PCIDevice *pci_dev, PCIBus *bus,
         }
         return NULL;
     found: ;
+    } else if (bus->devices[devfn]) {
+        return NULL;
     }
     pci_dev->bus = bus;
     pci_dev->devfn = devfn;

