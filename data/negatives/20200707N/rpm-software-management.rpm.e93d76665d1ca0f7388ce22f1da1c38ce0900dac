commit e93d76665d1ca0f7388ce22f1da1c38ce0900dac
Author: Panu Matilainen <pmatilai@redhat.com>
Date:   Thu Feb 14 15:02:18 2008 +0200

    Improve header i18n locale matching
    - Get best lang from rpm HEADERI18NTABLE, instead of getting first fuzzy match
      (eg: zh_TW matches zh_CN whereas zh_TW entry is available)
    
    Patch from Pascal Rigaux

diff --git a/rpmdb/header.c b/rpmdb/header.c
index aa3b679c7..ecc24e010 100644
--- a/rpmdb/header.c
+++ b/rpmdb/header.c
@@ -1214,7 +1214,7 @@ static int copyEntry(const indexEntry entry,
  * @param td		header i18n table data, NUL terminated
  * @param l		start of locale	to match
  * @param le		end of locale to match
- * @return		1 on match, 0 on no match
+ * @return		1 on good match, 2 on weak match, 0 on no match
  */
 static int headerMatchLocale(const char *td, const char *l, const char *le)
 {
@@ -1276,7 +1276,7 @@ static int headerMatchLocale(const char *td, const char *l, const char *le)
     for (fe = l; fe < le && *fe != '_'; fe++)
 	{};
     if (fe < le && !strncmp(td, l, (fe - l)))
-	return 1;
+	return 2;
 
     return 0;
 }
@@ -1305,7 +1305,7 @@ headerFindI18NString(Header h, indexEntry entry)
 
     for (l = lang; *l != '\0'; l = le) {
 	const char *td;
-	char *ed;
+	char *ed, *ed_weak = NULL;
 	int langNum;
 
 	while (*l && *l == ':')			/* skip leading colons */
@@ -1320,10 +1320,12 @@ headerFindI18NString(Header h, indexEntry entry)
 	     langNum < entry->info.count;
 	     langNum++, td += strlen(td) + 1, ed += strlen(ed) + 1) {
 
-		if (headerMatchLocale(td, l, le))
-		    return ed;
+	           int match = headerMatchLocale(td, l, le);
+		   if (match == 1) return ed;
+		   else if (match == 2) ed_weak = ed;
 
 	}
+	if (ed_weak) return ed_weak;
     }
 
     return entry->data;

