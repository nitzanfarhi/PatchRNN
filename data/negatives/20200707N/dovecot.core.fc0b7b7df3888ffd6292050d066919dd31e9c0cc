commit fc0b7b7df3888ffd6292050d066919dd31e9c0cc
Author: Timo Sirainen <tss@iki.fi>
Date:   Thu Oct 22 20:28:46 2009 -0400

    anvil: Added CONNECT-DUMP command to dump connect-limit state.
    
    --HG--
    branch : HEAD

diff --git a/src/anvil/anvil-connection.c b/src/anvil/anvil-connection.c
index bdeb8ab09..07dc61b0d 100644
--- a/src/anvil/anvil-connection.c
+++ b/src/anvil/anvil-connection.c
@@ -66,6 +66,9 @@ anvil_connection_request(struct anvil_connection *conn,
 		pid = strtol(args[0], NULL, 10);
 		connect_limit_disconnect(connect_limit, pid, args[1]);
 		return 0;
+	} else if (strcmp(cmd, "CONNECT-DUMP") == 0) {
+		connect_limit_dump(connect_limit, conn->output);
+		return 0;
 	} else if (strcmp(cmd, "KILL") == 0) {
 		if (args[0] == NULL) {
 			*error_r = "KILL: Not enough parameters";
diff --git a/src/anvil/connect-limit.c b/src/anvil/connect-limit.c
index 9d5f7bb67..97132b5ed 100644
--- a/src/anvil/connect-limit.c
+++ b/src/anvil/connect-limit.c
@@ -2,6 +2,9 @@
 
 #include "common.h"
 #include "hash.h"
+#include "str.h"
+#include "strescape.h"
+#include "ostream.h"
 #include "connect-limit.h"
 
 struct ident_pid {
@@ -164,3 +167,23 @@ void connect_limit_disconnect_pid(struct connect_limit *limit, pid_t pid)
 	}
 	hash_table_iterate_deinit(&iter);
 }
+
+void connect_limit_dump(struct connect_limit *limit, struct ostream *output)
+{
+	struct hash_iterate_context *iter;
+	void *key, *value;
+	string_t *str = t_str_new(256);
+
+	iter = hash_table_iterate_init(limit->ident_pid_hash);
+	while (hash_table_iterate(iter, &key, &value)) {
+		struct ident_pid *i = key;
+
+		str_truncate(str, 0);
+		str_tabescape_write(str, i->ident);
+		str_printfa(str, "\t%ld\t%u\n", (long)i->pid, i->refcount);
+		if (o_stream_send(output, str_data(str), str_len(str)) < 0)
+			break;
+	}
+	hash_table_iterate_deinit(&iter);
+	(void)o_stream_send(output, "\n", 1);
+}
diff --git a/src/anvil/connect-limit.h b/src/anvil/connect-limit.h
index 2c44e8e81..2d3c61101 100644
--- a/src/anvil/connect-limit.h
+++ b/src/anvil/connect-limit.h
@@ -11,5 +11,6 @@ void connect_limit_connect(struct connect_limit *limit, pid_t pid,
 void connect_limit_disconnect(struct connect_limit *limit, pid_t pid,
 			      const char *ident);
 void connect_limit_disconnect_pid(struct connect_limit *limit, pid_t pid);
+void connect_limit_dump(struct connect_limit *limit, struct ostream *output);
 
 #endif

