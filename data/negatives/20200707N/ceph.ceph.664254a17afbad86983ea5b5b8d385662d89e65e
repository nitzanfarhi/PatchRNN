commit 664254a17afbad86983ea5b5b8d385662d89e65e
Author: Dong Wu <archer.wudong@gmail.com>
Date:   Thu Oct 27 11:02:36 2016 +0800

    mon: update mon(peon)'s down_pending_out when osd up
    
    Fixes: http://tracker.ceph.com/issues/17719
    Signed-off-by: Dong Wu <archer.wudong@gmail.com>

diff --git a/src/mon/OSDMonitor.cc b/src/mon/OSDMonitor.cc
index ef0d87a9be..ec68a66fac 100644
--- a/src/mon/OSDMonitor.cc
+++ b/src/mon/OSDMonitor.cc
@@ -287,12 +287,19 @@ void OSDMonitor::update_from_paxos(bool *need_bootstrap)
   }
 
   for (int o = 0; o < osdmap.get_max_osd(); o++) {
+    if (osdmap.is_out(o))
+      continue;
+    auto found = down_pending_out.find(o);
     if (osdmap.is_down(o)) {
       // populate down -> out map
-      if (osdmap.is_in(o) &&
-	  down_pending_out.count(o) == 0) {
-	dout(10) << " adding osd." << o << " to down_pending_out map" << dendl;
-	down_pending_out[o] = ceph_clock_now(g_ceph_context);
+      if (found == down_pending_out.end()) {
+        dout(10) << " adding osd." << o << " to down_pending_out map" << dendl;
+        down_pending_out[o] = ceph_clock_now(g_ceph_context);
+      }
+    } else {
+      if (found != down_pending_out.end()) {
+        dout(10) << " removing osd." << o << " from down_pending_out map" << dendl;
+        down_pending_out.erase(found);
       }
     }
   }

