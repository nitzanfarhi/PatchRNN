commit bbc780f8bab52fef1784151d3c4982cb1143edd2
Author: David Herrmann <dh.herrmann@gmail.com>
Date:   Thu Nov 21 20:15:48 2013 +0100

    driver core: fix device_create() error path
    
    We call put_device() in the error path, which is fine for dev==NULL.
    However, in case kobject_set_name_vargs() fails, we have dev!=NULL but
    device_initialized() wasn't called, yet.
    
    Fix this by splitting device_register() into explicit calls to
    device_add() and an early call to device_initialize().
    
    Signed-off-by: David Herrmann <dh.herrmann@gmail.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

diff --git a/drivers/base/core.c b/drivers/base/core.c
index 67b180d855b2..aab43fbb8336 100644
--- a/drivers/base/core.c
+++ b/drivers/base/core.c
@@ -1603,6 +1603,7 @@ device_create_groups_vargs(struct class *class, struct device *parent,
 		goto error;
 	}
 
+	device_initialize(dev);
 	dev->devt = devt;
 	dev->class = class;
 	dev->parent = parent;
@@ -1614,7 +1615,7 @@ device_create_groups_vargs(struct class *class, struct device *parent,
 	if (retval)
 		goto error;
 
-	retval = device_register(dev);
+	retval = device_add(dev);
 	if (retval)
 		goto error;
 

