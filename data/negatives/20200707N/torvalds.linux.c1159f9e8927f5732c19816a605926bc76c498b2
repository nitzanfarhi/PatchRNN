commit c1159f9e8927f5732c19816a605926bc76c498b2
Author: Jean Delvare <khali@linux-fr.org>
Date:   Sun Aug 10 22:56:16 2008 +0200

    i2c: Check for address business before creating clients
    
    We check for address business in i2c_probe_address(),
    i2c_detect_address() and i2c_new_probed_device(), but this isn't
    sufficient. Drivers can call i2c_attach_client() and
    i2c_new_device() on any address, so we must check the address there
    as well.
    
    This fixes bug #11239:
    http://bugzilla.kernel.org/show_bug.cgi?id=11239
    
    Signed-off-by: Jean Delvare <khali@linux-fr.org>

diff --git a/drivers/i2c/i2c-core.c b/drivers/i2c/i2c-core.c
index c16dcad94412..550853f79ae8 100644
--- a/drivers/i2c/i2c-core.c
+++ b/drivers/i2c/i2c-core.c
@@ -813,7 +813,12 @@ static int i2c_check_addr(struct i2c_adapter *adapter, int addr)
 int i2c_attach_client(struct i2c_client *client)
 {
 	struct i2c_adapter *adapter = client->adapter;
-	int res = 0;
+	int res;
+
+	/* Check for address business */
+	res = i2c_check_addr(adapter, client->addr);
+	if (res)
+		return res;
 
 	client->dev.parent = &client->adapter->dev;
 	client->dev.bus = &i2c_bus_type;

