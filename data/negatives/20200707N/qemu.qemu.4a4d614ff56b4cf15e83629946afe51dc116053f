commit 4a4d614ff56b4cf15e83629946afe51dc116053f
Author: Daniel Stekloff <dan@wendan.org>
Date:   Fri Apr 24 11:55:42 2015 -0700

    Enable NVMe start controller for Windows guest.
    
    Windows seems to send two separate calls to NVMe controller configuration. The
    first sends configuration info and the second the enable bit. I couldn't
    enable the Windows 8.1 in-box NVMe driver with base Qemu. I made the
    following change to store the configuration data and then handle enable and
    NVMe driver works on Windows 8.1.
    
    I am not a Windows expert and I'm not entirely sure this is the correct
    approach. I'm offering it for anyone who wishes to use NVMe on Windows 8.1
    using Qemu.
    
    I have tested this change with Linux and Windows guests with NVMe devices.
    
    Signed-off-by: Daniel Stekloff <dan@wendan.org>
    Acked-by: Keith Busch <keith.busch@intel.com>
    Signed-off-by: Kevin Wolf <kwolf@redhat.com>

diff --git a/hw/block/nvme.c b/hw/block/nvme.c
index 1e071662d2..ad988d7c24 100644
--- a/hw/block/nvme.c
+++ b/hw/block/nvme.c
@@ -615,6 +615,13 @@ static void nvme_write_bar(NvmeCtrl *n, hwaddr offset, uint64_t data,
         n->bar.intmc = n->bar.intms;
         break;
     case 0x14:
+        /* Windows first sends data, then sends enable bit */
+        if (!NVME_CC_EN(data) && !NVME_CC_EN(n->bar.cc) &&
+            !NVME_CC_SHN(data) && !NVME_CC_SHN(n->bar.cc))
+        {
+            n->bar.cc = data;
+        }
+
         if (NVME_CC_EN(data) && !NVME_CC_EN(n->bar.cc)) {
             n->bar.cc = data;
             if (nvme_start_ctrl(n)) {

