commit 175ca83c0b6ab3c2af2d9e1ffff4d274910bbc10
Author: Richard Genoud <richard.genoud@gmail.com>
Date:   Thu Mar 28 12:55:48 2013 +0100

    pinctrl: pinctrl_select_state: set the old_state back on error
    
    In unapply_new_state, the old state is re-applied, but p->state is not
    set back as it should.
    
    Signed-off-by: Richard Genoud <richard.genoud@gmail.com>
    Reviewed-by: Stephen Warren <swarren@nvidia.com>
    Signed-off-by: Linus Walleij <linus.walleij@linaro.org>

diff --git a/drivers/pinctrl/core.c b/drivers/pinctrl/core.c
index f04f7d3d9a94..96cee791aa82 100644
--- a/drivers/pinctrl/core.c
+++ b/drivers/pinctrl/core.c
@@ -991,6 +991,8 @@ static int pinctrl_select_state_locked(struct pinctrl *p,
 				pinmux_enable_setting(setting);
 		}
 	}
+
+	p->state = old_state;
 	return ret;
 }
 

