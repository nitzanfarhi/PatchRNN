commit ca1d299a6483411a5d79365490570266577e67f9
Author: castaglia <castaglia>
Date:   Mon Dec 13 19:50:37 2010 +0000

    Make the unique session ID generated by mod_unique_id available to all
    modules by stashing the ID in the session.notes table.

diff --git a/contrib/mod_unique_id.c b/contrib/mod_unique_id.c
index 58ff0b655..275f9a515 100644
--- a/contrib/mod_unique_id.c
+++ b/contrib/mod_unique_id.c
@@ -2,7 +2,7 @@
  * ProFTPD: mod_unique_id -- a module for generating a unique ID for each
  *                           FTP session.
  *
- * Copyright (c) 2006-2007 TJ Saunders
+ * Copyright (c) 2006-2010 TJ Saunders
  *
  * This program is free software; you can redistribute it and/or modify
  * it under the terms of the GNU General Public License as published by
@@ -26,7 +26,7 @@
  * This is mod_unique_id, contrib software for proftpd 1.2.x/1.3.x and above.
  * For more information contact TJ Saunders <tj@castaglia.org>.
  *
- * $Id: mod_unique_id.c,v 1.1 2007-10-11 17:02:15 castaglia Exp $
+ * $Id: mod_unique_id.c,v 1.2 2010-12-13 19:50:37 castaglia Exp $
  */
 
 #include "conf.h"
@@ -35,7 +35,7 @@
  * module for Apache.
  */
 
-#define MOD_UNIQUE_ID_VERSION		"mod_unique_id/0.1"
+#define MOD_UNIQUE_ID_VERSION		"mod_unique_id/0.2"
 
 /* Make sure the version of proftpd is as necessary. */
 #if PROFTPD_VERSION_NUMBER < 0x0001030102
@@ -148,7 +148,7 @@ static int uniqid_sess_init(void) {
   unsigned short counter;
   struct timeval tv;
   struct timezone tz;
-  char *id = NULL;
+  char *key = "UNIQUE_ID", *id = NULL;
   unsigned char *x, *y;
   register unsigned int i, j;
 
@@ -254,7 +254,7 @@ static int uniqid_sess_init(void) {
     j = id_encoded_sz;
   id[j] = '\0';
 
-  if (pr_env_set(session.pool, "UNIQUE_ID", id) < 0) {
+  if (pr_env_set(session.pool, key, id) < 0) {
     pr_log_debug(DEBUG0, MOD_UNIQUE_ID_VERSION
       ": error setting UNIQUE_ID environment variable: %s", strerror(errno));
 
@@ -263,6 +263,11 @@ static int uniqid_sess_init(void) {
       ": unique session ID is '%s'", id);
   }
 
+  if (pr_table_add_dup(session.notes, pstrdup(session.pool, key), id, 0) < 0) {
+    pr_log_debug(DEBUG0, MOD_UNIQUE_ID_VERSION
+      ": error adding %s session note: %s", key, strerror(errno));
+  }
+
   return 0;
 }
 

