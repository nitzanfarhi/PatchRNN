commit e6dd588fb7e480ff02c32dd676cdabe3bbf03328
Author: Sage Weil <sage@newdream.net>
Date:   Fri Oct 3 12:08:32 2008 -0700

    mds: don't issue leases on dentries in stray dir
    
    Also, assert in remove_dentry() that the dentry has no more leases.

diff --git a/src/mds/CDir.cc b/src/mds/CDir.cc
index 5a48a33f22..a6b5163d9b 100644
--- a/src/mds/CDir.cc
+++ b/src/mds/CDir.cc
@@ -316,6 +316,9 @@ void CDir::remove_dentry(CDentry *dn)
 {
   dout(12) << "remove_dentry " << *dn << dendl;
 
+  // there should be no client leases at this point!
+  assert(dn->client_lease_map.empty());
+
   if (dn->inode) {
     // detach inode and dentry
     unlink_inode_work(dn);
diff --git a/src/mds/Locker.cc b/src/mds/Locker.cc
index ccb033b0ae..351e0c9567 100644
--- a/src/mds/Locker.cc
+++ b/src/mds/Locker.cc
@@ -1286,7 +1286,8 @@ int Locker::issue_client_lease(CDentry *dn, int client,
   //    if the client is holding EXCL|RDCACHE caps.
   int mask = 0;
   CInode *diri = dn->get_dir()->get_inode();
-  if ((diri->is_base() ||   // base inode's don't get version updated, so ICONTENT is useless.
+  if (!diri->is_stray() &&  // do not issue dn leases in stray dir!
+      (diri->is_base() ||   // base inode's don't get version updated, so ICONTENT is useless.
        (!diri->dirlock.can_lease() &&
 	(diri->get_client_cap_pending(client) & (CEPH_CAP_EXCL|CEPH_CAP_RDCACHE)) == 0)) &&
       dn->lock.can_lease())

