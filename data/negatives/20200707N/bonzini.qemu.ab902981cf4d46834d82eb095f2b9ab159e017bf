commit ab902981cf4d46834d82eb095f2b9ab159e017bf
Author: Hans de Goede <hdegoede@redhat.com>
Date:   Fri Sep 7 21:48:22 2012 +0200

    qxl: Ignore set_client_capabilities pre/post migrate
    
    The recent introduction of set_client_capabilities has broken
    (seamless) migration by trying to call qxl_send_events pre (seamless
    incoming) and post (*) migration, triggering the following assert:
    qxl_send_events: Assertion `qemu_spice_display_is_running(&d->ssd)' failed.
    
    The solution is easy, pre migration the guest will have already received
    the client caps on the migration source side, and post migration there no
    longer is a guest, so we can simply ignore the set_client_capabilities call
    in both those scenarios.
    
    *) Post migration, so not fatal for to the migration itself, but still a crash
    
    Signed-off-by: Hans de Goede <hdegoede@redhat.com>
    Signed-off-by: Gerd Hoffmann <kraxel@redhat.com>

diff --git a/hw/qxl.c b/hw/qxl.c
index 0176b1a11a..e539134c65 100644
--- a/hw/qxl.c
+++ b/hw/qxl.c
@@ -953,6 +953,11 @@ static void interface_set_client_capabilities(QXLInstance *sin,
 {
     PCIQXLDevice *qxl = container_of(sin, PCIQXLDevice, ssd.qxl);
 
+    if (runstate_check(RUN_STATE_INMIGRATE) ||
+        runstate_check(RUN_STATE_POSTMIGRATE)) {
+        return;
+    }
+
     qxl->shadow_rom.client_present = client_present;
     memcpy(qxl->shadow_rom.client_capabilities, caps, sizeof(caps));
     qxl->rom->client_present = client_present;

