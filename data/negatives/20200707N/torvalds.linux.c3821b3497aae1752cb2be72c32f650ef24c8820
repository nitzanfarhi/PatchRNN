commit c3821b3497aae1752cb2be72c32f650ef24c8820
Author: Kinglong Mee <kinglongmee@gmail.com>
Date:   Sun Feb 5 22:02:01 2017 +0800

    nfsd/idmap: return nfserr_inval for 0-length names
    
    Tigran Mkrtchyan's new pynfs testcases for zero length principals fail:
    
    SATT16   st_setattr.testEmptyPrincipal                            : FAILURE
               Setting empty owner should return NFS4ERR_INVAL,
               instead got NFS4ERR_BADOWNER
    SATT17   st_setattr.testEmptyGroupPrincipal                       : FAILURE
               Setting empty owner_group should return NFS4ERR_INVAL,
               instead got NFS4ERR_BADOWNER
    
    This patch checks the principal and returns nfserr_inval directly.  It
    could check after decoding in nfs4xdr.c, but it's simpler to do it in
    nfsd_map_xxxx.
    
    Signed-off-by: Kinglong Mee <kinglongmee@gmail.com>
    Signed-off-by: J. Bruce Fields <bfields@redhat.com>

diff --git a/fs/nfsd/nfs4idmap.c b/fs/nfsd/nfs4idmap.c
index 5b20577dcdd2..6b9b6cca469f 100644
--- a/fs/nfsd/nfs4idmap.c
+++ b/fs/nfsd/nfs4idmap.c
@@ -628,6 +628,10 @@ nfsd_map_name_to_uid(struct svc_rqst *rqstp, const char *name, size_t namelen,
 {
 	__be32 status;
 	u32 id = -1;
+
+	if (name == NULL || namelen == 0)
+		return nfserr_inval;
+
 	status = do_name_to_id(rqstp, IDMAP_TYPE_USER, name, namelen, &id);
 	*uid = make_kuid(&init_user_ns, id);
 	if (!uid_valid(*uid))
@@ -641,6 +645,10 @@ nfsd_map_name_to_gid(struct svc_rqst *rqstp, const char *name, size_t namelen,
 {
 	__be32 status;
 	u32 id = -1;
+
+	if (name == NULL || namelen == 0)
+		return nfserr_inval;
+
 	status = do_name_to_id(rqstp, IDMAP_TYPE_GROUP, name, namelen, &id);
 	*gid = make_kgid(&init_user_ns, id);
 	if (!gid_valid(*gid))

