commit c1992c8c7a87b261065d30594c16681800f5371c
Author: roberto@natty32 <roberto@natty32>
Date:   Tue Mar 22 12:12:03 2011 +0100

    added --check-cache

diff --git a/protocol.c b/protocol.c
index d7a7816e..d76dbe22 100644
--- a/protocol.c
+++ b/protocol.c
@@ -719,6 +719,18 @@ int uwsgi_parse_vars(struct wsgi_request *wsgi_req) {
 		}
 	}
 
+	if (uwsgi.check_cache && wsgi_req->uri_len && wsgi_req->method_len == 3 &&
+		wsgi_req->method[0] == 'G' && wsgi_req->method[1] == 'E' && wsgi_req->method[2] == 'T') {
+
+		uint64_t cache_value_size;
+		char *cache_value = uwsgi_cache_get(wsgi_req->uri, wsgi_req->uri_len, &cache_value_size);
+		if (cache_value && cache_value_size > 0) {
+			wsgi_req->response_size = write(wsgi_req->poll.fd, cache_value, cache_value_size);
+			wsgi_req->status = -1;
+			return -1;
+		}
+	}
+
 	if (uwsgi.manage_script_name) {
 		if (uwsgi.apps_cnt > 0 && wsgi_req->path_info_len > 1) {
 			// starts with 1 as the 0 app is the default (/) one
diff --git a/uwsgi.c b/uwsgi.c
index c3129bf2..2b8c7d12 100644
--- a/uwsgi.c
+++ b/uwsgi.c
@@ -152,6 +152,7 @@ static struct option long_base_options[] = {
 	{"routing", no_argument, &uwsgi.routing, 1},
 #endif
 	{"check-static", required_argument, 0, LONG_ARGS_CHECK_STATIC},
+	{"check-cache", no_argument, &uwsgi.check_cache, 1},
 	{"close-on-exec", no_argument, &uwsgi.close_on_exec, 1},
 	{"mode", required_argument, 0, LONG_ARGS_MODE},
 	{"env", required_argument, 0, LONG_ARGS_ENV},
diff --git a/uwsgi.h b/uwsgi.h
index c84d49e6..ae7fda24 100644
--- a/uwsgi.h
+++ b/uwsgi.h
@@ -1006,6 +1006,8 @@ struct uwsgi_server {
 	int cluster_nodes;
 	int cluster_fd;
 	struct sockaddr_in mc_cluster_addr;
+	
+	int		check_cache;
 
 	uint32_t 	cache_max_items;
 	uint64_t 	*cache_hashtable;

