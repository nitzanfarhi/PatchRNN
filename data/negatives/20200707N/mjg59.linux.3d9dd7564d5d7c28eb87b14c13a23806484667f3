commit 3d9dd7564d5d7c28eb87b14c13a23806484667f3
Author: Zach Brown <zach.brown@oracle.com>
Date:   Fri Apr 14 16:04:18 2006 -0700

    [PATCH] ip_output: account for fraggap when checking to add trailer_len
    
    During other work I noticed that ip_append_data() seemed to be forgetting to
    include the frag gap in its calculation of a fragment that consumes the rest of
    the payload.  Herbert confirmed that this was a bug that snuck in during a
    previous rework.
    
    Signed-off-by: Zach Brown <zach.brown@oracle.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

diff --git a/net/ipv4/ip_output.c b/net/ipv4/ip_output.c
index 8dcba3887f04..cff9c3a72daf 100644
--- a/net/ipv4/ip_output.c
+++ b/net/ipv4/ip_output.c
@@ -904,7 +904,7 @@ alloc_new_skb:
 			 * because we have no idea what fragment will be
 			 * the last.
 			 */
-			if (datalen == length)
+			if (datalen == length + fraggap)
 				alloclen += rt->u.dst.trailer_len;
 
 			if (transhdrlen) {

