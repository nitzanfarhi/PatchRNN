commit bdf95923086fb359ccb44c815724c3ace1611c90
Author: Sunil Goutham <sgoutham@cavium.com>
Date:   Tue Apr 25 15:27:52 2017 +0530

    iommu/arm-smmu: Return IOVA in iova_to_phys when SMMU is bypassed
    
    For software initiated address translation, when domain type is
    IOMMU_DOMAIN_IDENTITY i.e SMMU is bypassed, mimic HW behavior
    i.e return the same IOVA as translated address.
    
    This patch is an extension to Will Deacon's patchset
    "Implement SMMU passthrough using the default domain".
    
    Signed-off-by: Sunil Goutham <sgoutham@cavium.com>
    Acked-by: Will Deacon <will.deacon@arm.com>
    Signed-off-by: Joerg Roedel <jroedel@suse.de>

diff --git a/drivers/iommu/arm-smmu-v3.c b/drivers/iommu/arm-smmu-v3.c
index 803352d78d43..6ef9c3ed4344 100644
--- a/drivers/iommu/arm-smmu-v3.c
+++ b/drivers/iommu/arm-smmu-v3.c
@@ -1714,6 +1714,9 @@ arm_smmu_iova_to_phys(struct iommu_domain *domain, dma_addr_t iova)
 	struct arm_smmu_domain *smmu_domain = to_smmu_domain(domain);
 	struct io_pgtable_ops *ops = smmu_domain->pgtbl_ops;
 
+	if (domain->type == IOMMU_DOMAIN_IDENTITY)
+		return iova;
+
 	if (!ops)
 		return 0;
 
diff --git a/drivers/iommu/arm-smmu.c b/drivers/iommu/arm-smmu.c
index 77242afa1efc..a36e80abf084 100644
--- a/drivers/iommu/arm-smmu.c
+++ b/drivers/iommu/arm-smmu.c
@@ -1459,6 +1459,9 @@ static phys_addr_t arm_smmu_iova_to_phys(struct iommu_domain *domain,
 	struct arm_smmu_domain *smmu_domain = to_smmu_domain(domain);
 	struct io_pgtable_ops *ops= smmu_domain->pgtbl_ops;
 
+	if (domain->type == IOMMU_DOMAIN_IDENTITY)
+		return iova;
+
 	if (!ops)
 		return 0;
 

