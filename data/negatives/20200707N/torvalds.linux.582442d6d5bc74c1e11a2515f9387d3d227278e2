commit 582442d6d5bc74c1e11a2515f9387d3d227278e2
Author: Oussama Ghorbel <ou.ghorbel@gmail.com>
Date:   Thu Oct 3 14:49:26 2013 +0100

    ipv6: Allow the MTU of ipip6 tunnel to be set below 1280
    
    The (inner) MTU of a ipip6 (IPv4-in-IPv6) tunnel cannot be set below 1280, which is the minimum MTU in IPv6.
    However, there should be no IPv6 on the tunnel interface at all, so the IPv6 rules should not apply.
    More info at https://bugzilla.kernel.org/show_bug.cgi?id=15530
    
    This patch allows to check the minimum MTU for ipv6 tunnel according to these rules:
    -In case the tunnel is configured with ipip6 mode the minimum MTU is 68.
    -In case the tunnel is configured with ip6ip6 or any mode the minimum MTU is 1280.
    
    Signed-off-by: Oussama Ghorbel <ou.ghorbel@gmail.com>
    Acked-by: Hannes Frederic Sowa <hannes@stressinduktion.org>
    Signed-off-by: David S. Miller <davem@davemloft.net>

diff --git a/net/ipv6/ip6_tunnel.c b/net/ipv6/ip6_tunnel.c
index a791552e0422..583b77e2f69b 100644
--- a/net/ipv6/ip6_tunnel.c
+++ b/net/ipv6/ip6_tunnel.c
@@ -1430,9 +1430,17 @@ ip6_tnl_ioctl(struct net_device *dev, struct ifreq *ifr, int cmd)
 static int
 ip6_tnl_change_mtu(struct net_device *dev, int new_mtu)
 {
-	if (new_mtu < IPV6_MIN_MTU) {
-		return -EINVAL;
+	struct ip6_tnl *tnl = netdev_priv(dev);
+
+	if (tnl->parms.proto == IPPROTO_IPIP) {
+		if (new_mtu < 68)
+			return -EINVAL;
+	} else {
+		if (new_mtu < IPV6_MIN_MTU)
+			return -EINVAL;
 	}
+	if (new_mtu > 0xFFF8 - dev->hard_header_len)
+		return -EINVAL;
 	dev->mtu = new_mtu;
 	return 0;
 }

