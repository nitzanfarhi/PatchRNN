commit 1297667083d5442aafe3e337b9413bf02b114edb
Author: Matt Fleming <matt@codeblueprint.co.uk>
Date:   Mon Sep 19 13:09:09 2016 +0100

    x86/efi: Only map RAM into EFI page tables if in mixed-mode
    
    Waiman reported that booting with CONFIG_EFI_MIXED enabled on his
    multi-terabyte HP machine results in boot crashes, because the EFI
    region mapping functions loop forever while trying to map those
    regions describing RAM.
    
    While this patch doesn't fix the underlying hang, there's really no
    reason to map EFI_CONVENTIONAL_MEMORY regions into the EFI page tables
    when mixed-mode is not in use at runtime.
    
    Reported-by: Waiman Long <waiman.long@hpe.com>
    Cc: Ard Biesheuvel <ard.biesheuvel@linaro.org>
    Cc: Borislav Petkov <bp@alien8.de>
    Cc: Linus Torvalds <torvalds@linux-foundation.org>
    CC: Theodore Ts'o <tytso@mit.edu>
    Cc: Arnd Bergmann <arnd@arndb.de>
    Cc: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
    Cc: Scott J Norton <scott.norton@hpe.com>
    Cc: Douglas Hatch <doug.hatch@hpe.com>
    Cc: <stable@vger.kernel.org> # v4.6+
    Signed-off-by: Matt Fleming <matt@codeblueprint.co.uk>

diff --git a/arch/x86/platform/efi/efi_64.c b/arch/x86/platform/efi/efi_64.c
index 677e29e29473..8dd3784eb075 100644
--- a/arch/x86/platform/efi/efi_64.c
+++ b/arch/x86/platform/efi/efi_64.c
@@ -245,7 +245,7 @@ int __init efi_setup_page_tables(unsigned long pa_memmap, unsigned num_pages)
 	 * text and allocate a new stack because we can't rely on the
 	 * stack pointer being < 4GB.
 	 */
-	if (!IS_ENABLED(CONFIG_EFI_MIXED))
+	if (!IS_ENABLED(CONFIG_EFI_MIXED) || efi_is_native())
 		return 0;
 
 	/*

