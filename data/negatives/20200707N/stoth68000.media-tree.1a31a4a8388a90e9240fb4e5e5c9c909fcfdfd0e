commit 1a31a4a8388a90e9240fb4e5e5c9c909fcfdfd0e
Author: Pablo Neira Ayuso <pablo@netfilter.org>
Date:   Sat Dec 24 19:28:47 2011 +0100

    netfilter: ctnetlink: fix scheduling while atomic if helper is autoloaded
    
    This patch fixes one scheduling while atomic error:
    
    [  385.565186] ctnetlink v0.93: registering with nfnetlink.
    [  385.565349] BUG: scheduling while atomic: lt-expect_creat/16163/0x00000200
    
    It can be triggered with utils/expect_create included in
    libnetfilter_conntrack if the FTP helper is not loaded.
    
    Signed-off-by: Pablo Neira Ayuso <pablo@netfilter.org>

diff --git a/net/netfilter/nf_conntrack_netlink.c b/net/netfilter/nf_conntrack_netlink.c
index 3d7ea7af76fc..b6977776d715 100644
--- a/net/netfilter/nf_conntrack_netlink.c
+++ b/net/netfilter/nf_conntrack_netlink.c
@@ -1358,12 +1358,15 @@ ctnetlink_create_conntrack(struct net *net, u16 zone,
 						    nf_ct_protonum(ct));
 		if (helper == NULL) {
 			rcu_read_unlock();
+			spin_unlock_bh(&nf_conntrack_lock);
 #ifdef CONFIG_MODULES
 			if (request_module("nfct-helper-%s", helpname) < 0) {
+				spin_lock_bh(&nf_conntrack_lock);
 				err = -EOPNOTSUPP;
 				goto err1;
 			}
 
+			spin_lock_bh(&nf_conntrack_lock);
 			rcu_read_lock();
 			helper = __nf_conntrack_helper_find(helpname,
 							    nf_ct_l3num(ct),

