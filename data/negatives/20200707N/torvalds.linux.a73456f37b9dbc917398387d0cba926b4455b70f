commit a73456f37b9dbc917398387d0cba926b4455b70f
Author: Li Zefan <lizefan@huawei.com>
Date:   Wed Jun 5 17:15:59 2013 +0800

    cpuset: re-structure update_cpumask() a bit
    
    Check if cpus_allowed is to be changed before calling validate_change().
    
    This won't change any behavior, but later it will allow us to do this:
    
     # mkdir /cpuset/child
     # echo $$ > /cpuset/child/tasks        /* empty cpuset */
     # echo > /cpuset/child/cpuset.cpus     /* do nothing, won't fail */
    
    Without this patch, the last operation will fail.
    
    Signed-off-by: Li Zefan <lizefan@huawei.com>
    Signed-off-by: Tejun Heo <tj@kernel.org>

diff --git a/kernel/cpuset.c b/kernel/cpuset.c
index 51f8e1d5a2a9..535dce685eec 100644
--- a/kernel/cpuset.c
+++ b/kernel/cpuset.c
@@ -856,14 +856,15 @@ static int update_cpumask(struct cpuset *cs, struct cpuset *trialcs,
 		if (!cpumask_subset(trialcs->cpus_allowed, cpu_active_mask))
 			return -EINVAL;
 	}
-	retval = validate_change(cs, trialcs);
-	if (retval < 0)
-		return retval;
 
 	/* Nothing to do if the cpus didn't change */
 	if (cpumask_equal(cs->cpus_allowed, trialcs->cpus_allowed))
 		return 0;
 
+	retval = validate_change(cs, trialcs);
+	if (retval < 0)
+		return retval;
+
 	retval = heap_init(&heap, PAGE_SIZE, GFP_KERNEL, NULL);
 	if (retval)
 		return retval;

