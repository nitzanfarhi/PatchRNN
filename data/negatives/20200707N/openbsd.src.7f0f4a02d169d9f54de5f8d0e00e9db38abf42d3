commit 7f0f4a02d169d9f54de5f8d0e00e9db38abf42d3
Author: stsp <stsp@openbsd.org>
Date:   Sat Apr 28 14:46:10 2018 +0000

    Fix WEP key selection in ieee80211_get_txkey().
    
    The WEP key index is stored in ic_def_txkey. The iGTK ("integrity group key")
    index is specific to WPA. The previous code happened to always select WEP key
    index 0 since the iGTK index is not yet used by any driver.
    
    ok phessler@

diff --git a/sys/net80211/ieee80211_crypto.c b/sys/net80211/ieee80211_crypto.c
index e618e1d4b1d..046412f9e5c 100644
--- a/sys/net80211/ieee80211_crypto.c
+++ b/sys/net80211/ieee80211_crypto.c
@@ -1,4 +1,4 @@
-/*	$OpenBSD: ieee80211_crypto.c,v 1.72 2018/04/28 14:45:28 stsp Exp $	*/
+/*	$OpenBSD: ieee80211_crypto.c,v 1.73 2018/04/28 14:46:10 stsp Exp $	*/
 
 /*-
  * Copyright (c) 2008 Damien Bergamini <damien.bergamini@free.fr>
@@ -196,7 +196,8 @@ ieee80211_get_txkey(struct ieee80211com *ic, const struct ieee80211_frame *wh,
 	    ni->ni_rsncipher != IEEE80211_CIPHER_USEGROUP)
 		return &ni->ni_pairwise_key;
 
-	if (!IEEE80211_IS_MULTICAST(wh->i_addr1) ||
+	if ((ic->ic_flags & IEEE80211_F_WEPON) ||
+	    !IEEE80211_IS_MULTICAST(wh->i_addr1) ||
 	    (wh->i_fc[0] & IEEE80211_FC0_TYPE_MASK) !=
 	    IEEE80211_FC0_TYPE_MGT)
 		kid = ic->ic_def_txkey;

