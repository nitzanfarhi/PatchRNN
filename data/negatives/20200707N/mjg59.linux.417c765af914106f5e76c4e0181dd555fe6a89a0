commit 417c765af914106f5e76c4e0181dd555fe6a89a0
Author: Alan Stern <stern@rowland.harvard.edu>
Date:   Thu Mar 21 12:48:42 2013 -0400

    USB: EHCI: fix up incorrect merge resolution
    
    This patch (as1671) fixes up an incorrect resolution of a merge
    conflict between Greg KH's usb-linus branch and his usb-next branch.
    
    Signed-off-by: Alan Stern <stern@rowland.harvard.edu>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

diff --git a/drivers/usb/host/ehci-timer.c b/drivers/usb/host/ehci-timer.c
index dca8fc42b8d7..e7363332887e 100644
--- a/drivers/usb/host/ehci-timer.c
+++ b/drivers/usb/host/ehci-timer.c
@@ -297,6 +297,15 @@ static void ehci_iaa_watchdog(struct ehci_hcd *ehci)
 {
 	u32 cmd, status;
 
+	/*
+	 * Lost IAA irqs wedge things badly; seen first with a vt8235.
+	 * So we need this watchdog, but must protect it against both
+	 * (a) SMP races against real IAA firing and retriggering, and
+	 * (b) clean HC shutdown, when IAA watchdog was pending.
+	 */
+	if (ehci->rh_state != EHCI_RH_RUNNING)
+		return;
+
 	/* If we get here, IAA is *REALLY* late.  It's barely
 	 * conceivable that the system is so busy that CMD_IAAD
 	 * is still legitimately set, so let's be sure it's

