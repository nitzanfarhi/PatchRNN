commit 05cc23f6051fc9c408e636a9261343b72bbe78ea
Author: Armin Burgmeier <armin@arbur.net>
Date:   Sun Jul 14 20:52:59 2013 +0200

    Fix a warning in case the connection goes down at sending </stream:stream>
    
    This is a similar fix to the previous one: The connection can go down
    in </stream:stream>, and then gnutls_bye would try to send more data on a
    closed connection.

diff --git a/libinfinity/common/inf-xmpp-connection.c b/libinfinity/common/inf-xmpp-connection.c
index 500ba6b..aa1dd90 100644
--- a/libinfinity/common/inf-xmpp-connection.c
+++ b/libinfinity/common/inf-xmpp-connection.c
@@ -798,14 +798,20 @@ inf_xmpp_connection_terminate(InfXmppConnection* xmpp)
         xmlFreeNode(abort);
       }
 
-      inf_xmpp_connection_send_chars(
-        xmpp,
-        xmpp_connection_deinit_request,
-        sizeof(xmpp_connection_deinit_request) - 1
-      );
+      /* inf_xmpp_connection_send_xml() above might have caused
+       * status update: */
+      if(priv->status != INF_XMPP_CONNECTION_CLOSED)
+      {
+        inf_xmpp_connection_send_chars(
+          xmpp,
+          xmpp_connection_deinit_request,
+          sizeof(xmpp_connection_deinit_request) - 1
+        );
+      }
     }
 
-    if(priv->session != NULL)
+    /* One of the send() calls above might have caused status update */
+    if(priv->status != INF_XMPP_CONNECTION_CLOSED && priv->session != NULL)
       gnutls_bye(priv->session, GNUTLS_SHUT_WR);
   }
 

