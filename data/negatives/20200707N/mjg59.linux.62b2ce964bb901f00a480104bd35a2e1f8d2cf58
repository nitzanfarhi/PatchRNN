commit 62b2ce964bb901f00a480104bd35a2e1f8d2cf58
Author: Sage Weil <sage@inktank.com>
Date:   Wed Aug 15 13:30:12 2012 -0700

    vfs: fix propagation of atomic_open create error on negative dentry
    
    If ->atomic_open() returns -ENOENT, we take care to return the create
    error (e.g., EACCES), if any.  Do the same when ->atomic_open() returns 1
    and provides a negative dentry.
    
    This fixes a regression where an unprivileged open O_CREAT fails with
    ENOENT instead of EACCES, introduced with the new atomic_open code.  It
    is tested by the open/08.t test in the pjd posix test suite, and was
    observed on top of fuse (backed by ceph-fuse).
    
    Signed-off-by: Sage Weil <sage@inktank.com>
    Signed-off-by: Miklos Szeredi <mszeredi@suse.cz>

diff --git a/fs/namei.c b/fs/namei.c
index 26c28ec4f4af..db76b866a097 100644
--- a/fs/namei.c
+++ b/fs/namei.c
@@ -2489,6 +2489,10 @@ static int atomic_open(struct nameidata *nd, struct dentry *dentry,
 			dput(dentry);
 			dentry = file->f_path.dentry;
 		}
+		if (create_error && dentry->d_inode == NULL) {
+			error = create_error;
+			goto out;
+		}
 		goto looked_up;
 	}
 

