commit b743d52a6070442b8fa35c1fd728834159bb134e
Author: Jilles Tjoelker <jilles@stack.nl>
Date:   Mon Dec 7 18:52:07 2009 +0100

    Disallow ASCII 1-31 in vhosts and botserv bot nick/user/host.

diff --git a/modules/botserv/main.c b/modules/botserv/main.c
index df196451e..090b596c0 100644
--- a/modules/botserv/main.c
+++ b/modules/botserv/main.c
@@ -591,9 +591,11 @@ static bool valid_misc_field(const char *field, size_t maxlen)
 
 	/* Never ever allow @!?* as they have special meaning in all ircds */
 	/* Empty, space anywhere and colon at the start break the protocol */
+	/* Also disallow ASCII 1-31 */
 	if (strchr(field, '@') || strchr(field, '!') || strchr(field, '?') ||
 			strchr(field, '*') || strchr(field, ' ') ||
-			*field == ':' || *field == '\0')
+			*field == ':' || *field == '\0' ||
+			has_ctrl_chars(field))
 		return false;
 
 	return true;
diff --git a/src/services.c b/src/services.c
index ebcec0a6b..38184d540 100644
--- a/src/services.c
+++ b/src/services.c
@@ -951,9 +951,11 @@ bool check_vhost_validity(sourceinfo_t *si, const char *host)
 
 	/* Never ever allow @!?* as they have special meaning in all ircds */
 	/* Empty, space anywhere and colon at the start break the protocol */
+	/* Also disallow ASCII 1-31 */
 	if (strchr(host, '@') || strchr(host, '!') || strchr(host, '?') ||
 			strchr(host, '*') || strchr(host, ' ') ||
-			*host == ':' || *host == '\0')
+			*host == ':' || *host == '\0' ||
+			has_ctrl_chars(host))
 	{
 		command_fail(si, fault_badparams, _("The vhost provided contains invalid characters."));
 		return false;

