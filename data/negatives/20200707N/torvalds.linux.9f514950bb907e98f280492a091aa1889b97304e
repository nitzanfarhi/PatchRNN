commit 9f514950bb907e98f280492a091aa1889b97304e
Author: Herbert Xu <herbert@gondor.apana.org.au>
Date:   Sat Mar 25 01:24:25 2006 -0800

    [NET]: Take RTNL when unregistering notifier
    
    The netdev notifier call chain is currently unregistered without taking
    any locks outside the notifier system.  Because the notifier system itself
    does not synchronise unregistration with respect to the calling of the
    chain, we as its user need to do our own locking.
    
    We are supposed to take the RTNL for all calls to netdev notifiers, so
    taking the RTNL should be sufficient to protect it.
    
    The registration path in dev.c already takes the RTNL so it's OK.
    
    Signed-off-by: Herbert Xu <herbert@gondor.apana.org.au>
    Signed-off-by: David S. Miller <davem@davemloft.net>

diff --git a/net/core/dev.c b/net/core/dev.c
index 08dec6eb922b..e0489ca731c5 100644
--- a/net/core/dev.c
+++ b/net/core/dev.c
@@ -977,7 +977,12 @@ int register_netdevice_notifier(struct notifier_block *nb)
 
 int unregister_netdevice_notifier(struct notifier_block *nb)
 {
-	return notifier_chain_unregister(&netdev_chain, nb);
+	int err;
+
+	rtnl_lock();
+	err = notifier_chain_unregister(&netdev_chain, nb);
+	rtnl_unlock();
+	return err;
 }
 
 /**

