commit d9d2925713d92bbe33b2edff3d7de1ce5646ab54
Author: Luis R. Rodriguez <lrodriguez@atheros.com>
Date:   Wed Oct 22 13:13:53 2008 -0700

    mac80211: make use of regulatory tx power settings on change of tx power
    
    We do not know what max power to allow until a device is targeting
    a channel, therefore only allow changing tx power if a channel is defined.
    Also make use of the channel's max power setting as defined by
    regulatory rules before allowing the user to use the requested power
    setting. If the user asked us to figure it out we use the max allowed
    by regulatory.
    
    Signed-off-by: Luis R. Rodriguez <lrodriguez@atheros.com>
    Signed-off-by: John W. Linville <linville@tuxdriver.com>

diff --git a/net/mac80211/wext.c b/net/mac80211/wext.c
index 31d2e74a1bc0..231cab57351f 100644
--- a/net/mac80211/wext.c
+++ b/net/mac80211/wext.c
@@ -656,6 +656,7 @@ static int ieee80211_ioctl_siwtxpower(struct net_device *dev,
 				      union iwreq_data *data, char *extra)
 {
 	struct ieee80211_local *local = wdev_priv(dev->ieee80211_ptr);
+	struct ieee80211_channel* chan = local->hw.conf.channel;
 	u32 reconf_flags = 0;
 	int new_power_level;
 
@@ -663,20 +664,13 @@ static int ieee80211_ioctl_siwtxpower(struct net_device *dev,
 		return -EINVAL;
 	if (data->txpower.flags & IW_TXPOW_RANGE)
 		return -EINVAL;
+	if (!chan)
+		return -EINVAL;
 
-	if (data->txpower.fixed) {
-		new_power_level = data->txpower.value;
-	} else {
-		/*
-		 * Automatic power level. Use maximum power for the current
-		 * channel. Should be part of rate control.
-		 */
-		struct ieee80211_channel* chan = local->hw.conf.channel;
-		if (!chan)
-			return -EINVAL;
-
+	if (data->txpower.fixed)
+		new_power_level = min(data->txpower.value, chan->max_power);
+	else /* Automatic power level setting */
 		new_power_level = chan->max_power;
-	}
 
 	if (local->hw.conf.power_level != new_power_level) {
 		local->hw.conf.power_level = new_power_level;

