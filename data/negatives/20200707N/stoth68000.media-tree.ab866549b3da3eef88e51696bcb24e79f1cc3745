commit ab866549b3da3eef88e51696bcb24e79f1cc3745
Author: Yan, Zheng <zheng.z.yan@intel.com>
Date:   Tue Apr 1 20:20:17 2014 +0800

    ceph: drop extra open file reference in ceph_atomic_open()
    
    ceph_atomic_open() calls ceph_open() after receiving the MDS reply.
    ceph_open() grabs an extra open file reference. (The open request
    already holds an open file reference)
    
    Signed-off-by: Yan, Zheng <zheng.z.yan@intel.com>

diff --git a/fs/ceph/file.c b/fs/ceph/file.c
index 2862a75fb949..66075a4ad979 100644
--- a/fs/ceph/file.c
+++ b/fs/ceph/file.c
@@ -291,8 +291,9 @@ int ceph_atomic_open(struct inode *dir, struct dentry *dentry,
 		}
 		err = finish_open(file, dentry, ceph_open, opened);
 	}
-
 out_err:
+	if (!req->r_err && req->r_target_inode)
+		ceph_put_fmode(ceph_inode(req->r_target_inode), req->r_fmode);
 	ceph_mdsc_put_request(req);
 	dout("atomic_open result=%d\n", err);
 	return err;

