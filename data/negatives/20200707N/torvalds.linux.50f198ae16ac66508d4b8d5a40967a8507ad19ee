commit 50f198ae16ac66508d4b8d5a40967a8507ad19ee
Author: Tyler Hicks <tyhicks@linux.vnet.ibm.com>
Date:   Wed Mar 9 11:49:13 2011 -0600

    eCryptfs: Unlock page in write_begin error path
    
    Unlock the page in error path of ecryptfs_write_begin(). This may
    happen, for example, if decryption fails while bring the page
    up-to-date.
    
    Cc: <stable@kernel.org>
    Signed-off-by: Tyler Hicks <tyhicks@linux.vnet.ibm.com>

diff --git a/fs/ecryptfs/mmap.c b/fs/ecryptfs/mmap.c
index 5e150131eb9d..6a44148c5fb9 100644
--- a/fs/ecryptfs/mmap.c
+++ b/fs/ecryptfs/mmap.c
@@ -381,6 +381,11 @@ static int ecryptfs_write_begin(struct file *file,
 	    && (pos != 0))
 		zero_user(page, 0, PAGE_CACHE_SIZE);
 out:
+	if (unlikely(rc)) {
+		unlock_page(page);
+		page_cache_release(page);
+		*pagep = NULL;
+	}
 	return rc;
 }
 

