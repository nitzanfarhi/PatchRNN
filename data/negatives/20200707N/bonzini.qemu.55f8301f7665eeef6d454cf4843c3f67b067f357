commit 55f8301f7665eeef6d454cf4843c3f67b067f357
Author: Anthony Liguori <aliguori@us.ibm.com>
Date:   Wed Jun 1 12:14:51 2011 -0500

    json-streamer: allow recovery after bad input
    
    Once we detect a malformed message, make sure to reset our state.
    
    Signed-off-by: Michael Roth <mdroth@linux.vnet.ibm.com>
    Signed-off-by: Anthony Liguori <aliguori@us.ibm.com>

diff --git a/json-streamer.c b/json-streamer.c
index f7e7a68d40..549e9b7f1e 100644
--- a/json-streamer.c
+++ b/json-streamer.c
@@ -51,8 +51,12 @@ static void json_message_process_token(JSONLexer *lexer, QString *token, JSONTok
 
     qlist_append(parser->tokens, dict);
 
-    if (parser->brace_count == 0 &&
-        parser->bracket_count == 0) {
+    if (parser->brace_count < 0 ||
+        parser->bracket_count < 0 ||
+        (parser->brace_count == 0 &&
+         parser->bracket_count == 0)) {
+        parser->brace_count = 0;
+        parser->bracket_count = 0;
         parser->emit(parser, parser->tokens);
         QDECREF(parser->tokens);
         parser->tokens = qlist_new();

