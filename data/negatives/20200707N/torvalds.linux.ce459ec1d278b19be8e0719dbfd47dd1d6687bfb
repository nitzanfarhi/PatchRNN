commit ce459ec1d278b19be8e0719dbfd47dd1d6687bfb
Author: Alan Stern <stern@rowland.harvard.edu>
Date:   Tue Feb 24 16:19:47 2009 -0500

    USB: g_file_storage: automatically disable stalls under Atmel
    
    This patch (as1220) automatically disables stalls when g_file_storage
    finds itself running with an Atmel device controller, because the
    Atmel hardware/driver isn't capable of halting bulk endpoints
    correctly.
    
    Reported-by: Stanislaw Gruszka <stf_xl@wp.pl>
    Signed-off-by: Alan Stern <stern@rowland.harvard.edu>
    Acked-by: David Brownell <dbrownell@users.sourceforge.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@suse.de>

diff --git a/drivers/usb/gadget/file_storage.c b/drivers/usb/gadget/file_storage.c
index b10fa31cc915..1ab9dac7e12d 100644
--- a/drivers/usb/gadget/file_storage.c
+++ b/drivers/usb/gadget/file_storage.c
@@ -3879,7 +3879,11 @@ static int __init check_parameters(struct fsg_dev *fsg)
 	mod_data.protocol_type = USB_SC_SCSI;
 	mod_data.protocol_name = "Transparent SCSI";
 
-	if (gadget_is_sh(fsg->gadget))
+	/* Some peripheral controllers are known not to be able to
+	 * halt bulk endpoints correctly.  If one of them is present,
+	 * disable stalls.
+	 */
+	if (gadget_is_sh(fsg->gadget) || gadget_is_at91(fsg->gadget))
 		mod_data.can_stall = 0;
 
 	if (mod_data.release == 0xffff) {	// Parameter wasn't set

