commit da629cf111a2b9a182d1b43f03f2cb0d3f258af4
Author: Helmut Schaa <helmut.schaa@googlemail.com>
Date:   Tue Jan 5 17:42:13 2016 +0100

    mac80211: Don't buffer non-bufferable MMPDUs
    
    Non-bufferable MMPDUs are sent out to STAs even while in PS mode
    (for example probe responses). Applying filtered frame handling for
    these doesn't seem to make much sense and will only create more
    air utilization when the STA wakes up. Hence, apply filtered frame
    handling only for bufferable MMPDUs.
    
    Discovered while testing an old VOIP phone that started probing
    for APs while in PS mode. The mac80211/ath9k AP where the STA is
    associated would reply with a probe response but the phone sometimes
    moved to a new channel already and couldn't ack the probe response
    anymore. In that case mac80211 applied filtered frame handling
    for the un-acked probe response.
    
    Signed-off-by: Helmut Schaa <helmut.schaa@googlemail.com>
    Signed-off-by: Johannes Berg <johannes.berg@intel.com>

diff --git a/net/mac80211/status.c b/net/mac80211/status.c
index 5bad05e9af90..6101deb805a8 100644
--- a/net/mac80211/status.c
+++ b/net/mac80211/status.c
@@ -51,6 +51,11 @@ static void ieee80211_handle_filtered_frame(struct ieee80211_local *local,
 	struct ieee80211_hdr *hdr = (void *)skb->data;
 	int ac;
 
+	if (info->flags & IEEE80211_TX_CTL_NO_PS_BUFFER) {
+		ieee80211_free_txskb(&local->hw, skb);
+		return;
+	}
+
 	/*
 	 * This skb 'survived' a round-trip through the driver, and
 	 * hopefully the driver didn't mangle it too badly. However,

