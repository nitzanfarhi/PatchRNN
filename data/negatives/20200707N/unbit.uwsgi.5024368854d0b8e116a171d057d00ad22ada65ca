commit 5024368854d0b8e116a171d057d00ad22ada65ca
Author: roberto@maverick64 <roberto@maverick64>
Date:   Thu Jun 30 12:56:13 2011 +0200

    gather statistics about subscribed fastrouter nodes

diff --git a/plugins/fastrouter/fastrouter.c b/plugins/fastrouter/fastrouter.c
index 8f82cb25..9590eddc 100644
--- a/plugins/fastrouter/fastrouter.c
+++ b/plugins/fastrouter/fastrouter.c
@@ -512,6 +512,9 @@ void fastrouter_loop() {
 							iov[1].iov_base = fr_session->buffer;
 							iov[1].iov_len = fr_session->uh.pktsize;
 
+							// increment node requests counter
+							fr_session->un->requests++;
+
 							// fd passing: PERFORMANCE EXTREME BOOST !!!
 							if (fr_session->pass_fd && !uwsgi.no_fd_passing) {
 								msg.msg_name    = NULL;
@@ -567,6 +570,9 @@ void fastrouter_loop() {
 								close_session(fr_table, fr_session);
                                                         	break;
 							}
+
+							// update transfer statistics
+							fr_session->un->transferred += len;
 						}
 						// body from client
 						else if (interesting_fd == fr_session->fd) {
diff --git a/spooler.c b/spooler.c
index c5cd7eda..86d6d4e9 100644
--- a/spooler.c
+++ b/spooler.c
@@ -241,7 +241,9 @@ void spooler_manage_task(char *dir, char *task) {
 			char *prio_path = realpath(".", NULL);
 			spooler_scandir(prio_path);
 			free(prio_path);
-			chdir(dir);
+			if (chdir(dir)) {
+				uwsgi_error("chdir()");
+			}
 			return;
 		}
 #endif
diff --git a/uwsgi.h b/uwsgi.h
index 962ac198..953d9116 100644
--- a/uwsgi.h
+++ b/uwsgi.h
@@ -1844,6 +1844,12 @@ struct uwsgi_subscriber_name {
 
 	uint8_t modifier1;
 	uint8_t modifier2;
+
+	// total requests managed by this node
+	uint64_t	requests;
+	// bytes transferred by this node
+	uint64_t	transferred;
+
 };
 
 struct uwsgi_subscriber {

