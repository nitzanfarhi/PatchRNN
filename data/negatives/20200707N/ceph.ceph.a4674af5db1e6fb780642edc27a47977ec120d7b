commit a4674af5db1e6fb780642edc27a47977ec120d7b
Author: Sage Weil <sage@newdream.net>
Date:   Sun Nov 7 07:49:59 2010 -0800

    mds: eval: put scatter in MIX if replicated, otherwise LOCK
    
    Signed-off-by: Sage Weil <sage@newdream.net>

diff --git a/src/mds/Locker.cc b/src/mds/Locker.cc
index f227922a98..27a26f19b1 100644
--- a/src/mds/Locker.cc
+++ b/src/mds/Locker.cc
@@ -3317,11 +3317,18 @@ void Locker::scatter_eval(ScatterLock *lock, bool *need_issue)
   if (lock->get_parent()->is_frozen()) return;
   
   if (lock->get_type() == CEPH_LOCK_INEST) {
-    // in general, we want to keep INEST scattered at all times.
+    // in general, we want to keep INEST writable at all times.
     if (!lock->is_rdlocked() &&
-	lock->get_state() != LOCK_MIX)
-      scatter_mix(lock, need_issue);
-      return;
+	!lock->is_xlocked()) {
+      if (lock->get_parent()->is_replicated()) {
+	if (lock->get_state() != LOCK_MIX)
+	  scatter_mix(lock, need_issue);
+      } else {
+	if (lock->get_state() != LOCK_LOCK)
+	  simple_lock(lock, need_issue);
+      }
+    }
+    return;
   }
 
   CInode *in = (CInode*)lock->get_parent();

