commit f70b2a0dc7fbceb56cfd702e782a1018b89a3f8d
Author: miod <miod@openbsd.org>
Date:   Wed Mar 21 05:28:51 2007 +0000

    Real atomic_{set,clear}bits_int implementation, ok deraadt

diff --git a/sys/arch/m88k/include/atomic.h b/sys/arch/m88k/include/atomic.h
index 16ebc203af6..d551ba1885c 100644
--- a/sys/arch/m88k/include/atomic.h
+++ b/sys/arch/m88k/include/atomic.h
@@ -1,4 +1,4 @@
-/*	$OpenBSD: atomic.h,v 1.2 2007/02/19 17:18:43 deraadt Exp $	*/
+/*	$OpenBSD: atomic.h,v 1.3 2007/03/21 05:28:51 miod Exp $	*/
 
 /* Public Domain */
 
@@ -10,13 +10,25 @@
 static __inline void
 atomic_setbits_int(__volatile unsigned int *uip, unsigned int v)
 {
-	*uip |= v;
+	unsigned int old, new;
+
+	do {
+		old = *uip;
+		new = old | v;
+		__asm__ __volatile__ ("xmem %0, %1, r0" : "+r"(new) : "r"(uip));
+	} while (old != new);
 }
 
 static __inline void
 atomic_clearbits_int(__volatile unsigned int *uip, unsigned int v)
 {
-	*uip &= ~v;
+	unsigned int old, new;
+
+	do {
+		old = *uip;
+		new = old & ~v;
+		__asm__ __volatile__ ("xmem %0, %1, r0" : "+r"(new) : "r"(uip));
+	} while (old != new);
 }
 
 #endif /* defined(_KERNEL) */

