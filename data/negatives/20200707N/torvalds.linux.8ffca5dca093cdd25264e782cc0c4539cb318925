commit 8ffca5dca093cdd25264e782cc0c4539cb318925
Author: Leo (Sunpeng) Li <sunpeng.li@amd.com>
Date:   Fri Nov 10 15:02:19 2017 -0500

    drm/amd/display: Do DC mode-change check when adding CRTCs
    
    Within atomic check, dm_update_crtcs_state is called twice. First to
    remove from the dc_state, and subsequently to add to it.
    
    In both calls, a secondary mode-change check is done using dc-level
    states. We shouldn't be doing this while removing, since a new
    dc_stream_state has not been created to do the necessary comparison.
    Because of this, the mode_changed flag within the DRM state can be
    mistakenly set to false. Doing so only when adding prevents this.
    
    We are also guaranteed that a call to add will come after remove, or
    else the atomic check fails (and a commit will not happen).
    
    Signed-off-by: Leo (Sunpeng) Li <sunpeng.li@amd.com>
    Reviewed-by: Tony Cheng <Tony.Cheng@amd.com>
    Acked-by: Harry Wentland <harry.wentland@amd.com>
    Signed-off-by: Alex Deucher <alexander.deucher@amd.com>

diff --git a/drivers/gpu/drm/amd/display/amdgpu_dm/amdgpu_dm.c b/drivers/gpu/drm/amd/display/amdgpu_dm/amdgpu_dm.c
index 5293604a894b..8b0fb25d84a6 100644
--- a/drivers/gpu/drm/amd/display/amdgpu_dm/amdgpu_dm.c
+++ b/drivers/gpu/drm/amd/display/amdgpu_dm/amdgpu_dm.c
@@ -4460,7 +4460,7 @@ static int dm_update_crtcs_state(struct dc *dc,
 			}
 		}
 
-		if (dc_is_stream_unchanged(new_stream, dm_old_crtc_state->stream) &&
+		if (enable && dc_is_stream_unchanged(new_stream, dm_old_crtc_state->stream) &&
 				dc_is_stream_scaling_unchanged(new_stream, dm_old_crtc_state->stream)) {
 
 			new_crtc_state->mode_changed = false;

