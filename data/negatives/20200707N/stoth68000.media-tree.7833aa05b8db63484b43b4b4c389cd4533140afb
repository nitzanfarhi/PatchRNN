commit 7833aa05b8db63484b43b4b4c389cd4533140afb
Author: Steffen Klassert <steffen.klassert@secunet.com>
Date:   Mon Apr 25 19:41:21 2011 +0000

    xfrm: Check for the new replay implementation if an esn state is inserted
    
    IPsec extended sequence numbers can be used only with the new
    anti-replay window implementation. So check if the new implementation
    is used if an esn state is inserted and return an error if it is not.
    
    Signed-off-by: Steffen Klassert <steffen.klassert@secunet.com>
    Acked-by: Herbert Xu <herbert@gondor.apana.org.au>
    Signed-off-by: David S. Miller <davem@davemloft.net>

diff --git a/net/xfrm/xfrm_user.c b/net/xfrm/xfrm_user.c
index 5d1d60d3ca83..c658cb3bc7c3 100644
--- a/net/xfrm/xfrm_user.c
+++ b/net/xfrm/xfrm_user.c
@@ -124,6 +124,9 @@ static inline int verify_replay(struct xfrm_usersa_info *p,
 {
 	struct nlattr *rt = attrs[XFRMA_REPLAY_ESN_VAL];
 
+	if ((p->flags & XFRM_STATE_ESN) && !rt)
+		return -EINVAL;
+
 	if (!rt)
 		return 0;
 

