commit 28e8886b0df67a27ec0fc8b07e096f7a3050b4db
Author: Jilles Tjoelker <jilles@stack.nl>
Date:   Sat Dec 31 15:28:52 2011 +0100

    Enforce that bind and connect address have the same address family.
    
    Both must be IPv4 or both must be IPv6.
    
    This means getaddrinfo() for the bind address (vhost) will fail if it
    is numeric and of the wrong address family. If it is a name with both
    IPv4 and IPv6 addresses, getaddrinfo() will pick the correct one.

diff --git a/libathemecore/connection.c b/libathemecore/connection.c
index fcf658824..e9082f023 100644
--- a/libathemecore/connection.c
+++ b/libathemecore/connection.c
@@ -402,9 +402,13 @@ connection_t *connection_open_tcp(char *host, char *vhost, unsigned int port,
 
 	if (vhost != NULL)
 	{
-		struct addrinfo *bind_addr = NULL;
+		struct addrinfo hints, *bind_addr = NULL;
 
-		if ((error = getaddrinfo(vhost, NULL, NULL, &bind_addr)))
+		memset(&hints, 0, sizeof hints);
+		hints.ai_family = addr->ai_family;
+		hints.ai_socktype = SOCK_STREAM;
+		hints.ai_flags = AI_PASSIVE;
+		if ((error = getaddrinfo(vhost, NULL, &hints, &bind_addr)))
 		{
 			slog(LG_ERROR, "connection_open_tcp(): cant resolve vhost %s: %s", vhost, gai_strerror(error));
 			close(s);

