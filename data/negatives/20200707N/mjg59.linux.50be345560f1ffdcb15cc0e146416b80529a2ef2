commit 50be345560f1ffdcb15cc0e146416b80529a2ef2
Author: Milan Broz <mbroz@redhat.com>
Date:   Mon Sep 4 15:37:57 2006 +0200

    [PATCH] fix creating zero sized bio mempools in low memory system
    
    In the very low memory systems is in the init_bio call
    scale parameter set to zero and it leads to creating
    zero sized mempool.
    
    This patch prevents pool_entries parameter become zero,
    so the created pool have at least 1 entry.
    
    Mempool with 0 entries lead to incorrect behaviour
    of mempool_free. (Alloc requests are not waken up
    and system stalls in mempool_alloc->ioschedule).
    
    Signed-off-by: Milan Broz <mbroz@redhat.com>
    Signed-off-by: Jens Axboe <axboe@kernel.dk>

diff --git a/fs/bio.c b/fs/bio.c
index 6a0b9ad8f8c9..52de79c29942 100644
--- a/fs/bio.c
+++ b/fs/bio.c
@@ -1142,7 +1142,7 @@ static int biovec_create_pools(struct bio_set *bs, int pool_entries, int scale)
 		struct biovec_slab *bp = bvec_slabs + i;
 		mempool_t **bvp = bs->bvec_pools + i;
 
-		if (i >= scale)
+		if (pool_entries > 1 && i >= scale)
 			pool_entries >>= 1;
 
 		*bvp = mempool_create_slab_pool(pool_entries, bp->slab);

