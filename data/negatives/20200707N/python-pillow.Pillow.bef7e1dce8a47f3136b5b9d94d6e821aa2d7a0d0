commit bef7e1dce8a47f3136b5b9d94d6e821aa2d7a0d0
Author: homm <homm86@gmail.com>
Date:   Wed Oct 8 17:40:33 2014 +0400

    cache hasAlpha for ImagingUnsharpMask

diff --git a/libImaging/UnsharpMask.c b/libImaging/UnsharpMask.c
index 0e0eb66e..76d630a8 100644
--- a/libImaging/UnsharpMask.c
+++ b/libImaging/UnsharpMask.c
@@ -293,6 +293,7 @@ ImagingUnsharpMask(Imaging im, Imaging imOut, float radius, int percent,
     int channel = 0;
     int channels = 0;
     int padding = 0;
+    int hasAlpha = 0;
 
     int x = 0;
     int y = 0;
@@ -337,6 +338,10 @@ ImagingUnsharpMask(Imaging im, Imaging imOut, float radius, int percent,
 
     ImagingSectionEnter(&cookie);
 
+    if (strcmp(im->mode, "RGBX") == 0 || strcmp(im->mode, "RGBA") == 0) {
+        hasAlpha = 1;
+    }
+
     for (y = 0; y < im->ysize; y++) {
         if (channels == 1) {
             lineIn8 = im->image8[y];
@@ -385,8 +390,7 @@ ImagingUnsharpMask(Imaging im, Imaging imOut, float radius, int percent,
                             (channel * 8);
                     }
                 }
-                if (strcmp(im->mode, "RGBX") == 0
-                    || strcmp(im->mode, "RGBA") == 0) {
+                if (hasAlpha) {
                     /* preserve the alpha channel
                        this may not work for little-endian systems, fix it! */
                     newPixel =

