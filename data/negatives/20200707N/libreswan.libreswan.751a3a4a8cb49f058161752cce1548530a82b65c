commit 751a3a4a8cb49f058161752cce1548530a82b65c
Author: Paul Wouters <paul@xelerance.com>
Date:   Mon Jul 19 09:46:06 2010 -0400

    Fix for HAVE_STATSD log output when two connections share a phase1

diff --git a/programs/pluto/log.c b/programs/pluto/log.c
index 734e4562d..79870f676 100644
--- a/programs/pluto/log.c
+++ b/programs/pluto/log.c
@@ -911,9 +911,16 @@ connection_state(struct state *st, void *data)
 {
 	struct log_conn_info *lc = data;
 
-	if (!st || st == lc->ignore || st->st_connection != lc->conn)
+	if (!st || st == lc->ignore || !st->st_connection || !lc->conn)
 		return;
 
+	if (st->st_connection != lc->conn) {
+		if (lc->conn->host_pair != st->st_connection->host_pair ||
+			!same_peer_ids(lc->conn, st->st_connection, NULL))
+		    return;
+		/* phase1 is shared with another connnection */
+	}
+
 	/* ignore undefined states (ie., just deleted) */
 	if (st->st_state == STATE_UNDEFINED)
 		return;
@@ -935,6 +942,9 @@ connection_state(struct state *st, void *data)
 		}
 	}
 
+	/* only phase one shares across connections, so we can quit now */
+	if (st->st_connection != lc->conn)
+		return;
 
 	if (IS_PHASE15(st->st_state)) {
 		if (lc->tunnel < tun_phase15)

