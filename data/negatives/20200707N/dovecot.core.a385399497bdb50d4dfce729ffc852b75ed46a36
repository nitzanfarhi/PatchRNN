commit a385399497bdb50d4dfce729ffc852b75ed46a36
Author: Timo Sirainen <tss@iki.fi>
Date:   Wed Apr 23 16:45:10 2014 +0300

    virtual: Fixed assert-crash in IDLE caused by earlier changes.
    This change negates all the improvements of the earlier changes when IDLE is
    used. This could be fixed by using mailbox-list-notify.h API.

diff --git a/src/plugins/virtual/virtual-storage.c b/src/plugins/virtual/virtual-storage.c
index ea7bfe19d..41e14c005 100644
--- a/src/plugins/virtual/virtual-storage.c
+++ b/src/plugins/virtual/virtual-storage.c
@@ -417,17 +417,25 @@ virtual_notify_callback(struct mailbox *bbox ATTR_UNUSED, struct mailbox *box)
 static void virtual_notify_changes(struct mailbox *box)
 {
 	struct virtual_mailbox *mbox = (struct virtual_mailbox *)box;
-	struct virtual_backend_box *const *bboxes;
-	unsigned int i, count;
+	struct virtual_backend_box *const *bboxp;
 
-	bboxes = array_get(&mbox->backend_boxes, &count);
-	for (i = 0; i < count; i++) {
-		struct mailbox *bbox = bboxes[i]->box;
+	if (box->notify_callback == NULL) {
+		array_foreach(&mbox->backend_boxes, bboxp)
+			mailbox_notify_changes_stop((*bboxp)->box);
+		return;
+	}
+
+	/* FIXME: if mailbox_list_index=yes, use mailbox-list-notify.h API
+	   to wait for changes and avoid opening all mailboxes here. */
 
-		if (box->notify_callback == NULL)
-			mailbox_notify_changes_stop(bbox);
-		else
-			mailbox_notify_changes(bbox, virtual_notify_callback, box);
+	array_foreach(&mbox->backend_boxes, bboxp) {
+		if (mailbox_open((*bboxp)->box) < 0) {
+			/* we can't report error in here, so do it later */
+			(*bboxp)->open_failed = TRUE;
+			continue;
+		}
+		mailbox_notify_changes((*bboxp)->box,
+				       virtual_notify_callback, box);
 	}
 }
 
diff --git a/src/plugins/virtual/virtual-storage.h b/src/plugins/virtual/virtual-storage.h
index 0bb738df6..64045340e 100644
--- a/src/plugins/virtual/virtual-storage.h
+++ b/src/plugins/virtual/virtual-storage.h
@@ -92,6 +92,7 @@ struct virtual_backend_box {
 	struct imap_match_glob *glob;
 	struct mail_namespace *ns;
 
+	unsigned int open_failed:1;
 	unsigned int sync_seen:1;
 	unsigned int wildcard:1;
 	unsigned int clear_recent:1;
diff --git a/src/plugins/virtual/virtual-sync.c b/src/plugins/virtual/virtual-sync.c
index 118181963..a12cc0f39 100644
--- a/src/plugins/virtual/virtual-sync.c
+++ b/src/plugins/virtual/virtual-sync.c
@@ -1041,10 +1041,13 @@ static int virtual_sync_backend_box(struct virtual_sync_context *ctx,
 		   mailbox. */
 		i_assert(array_count(&bbox->sync_pending_removes) == 0);
 
-		if (bbox_index_opened) {
-			/* index already opened, refresh it */
+		if (bbox_index_opened || bbox->open_failed) {
+			/* a) index already opened, refresh it
+			   b) delayed error handling for mailbox_open()
+			   that failed in virtual_notify_changes() */
 			if (mailbox_sync(bbox->box, sync_flags) < 0)
 				return -1;
+			bbox->open_failed = FALSE;
 		}
 
 		if (mailbox_get_status(bbox->box, STATUS_UIDVALIDITY |

