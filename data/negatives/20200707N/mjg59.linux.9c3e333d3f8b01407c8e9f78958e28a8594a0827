commit 9c3e333d3f8b01407c8e9f78958e28a8594a0827
Author: Shaohua Li <shli@fb.com>
Date:   Thu Aug 13 14:32:02 2015 -0700

    raid5: disable batch with log enabled
    
    With log enabled, r5l_write_stripe will add the stripe to log. With
    batch, several stripes are linked together. The stripes must be in the
    same state. While with log, the log/reclaim unit is stripe, we can't
    guarantee the several stripes are in the same state. Disabling batch for
    log now.
    
    Signed-off-by: Shaohua Li <shli@fb.com>
    Signed-off-by: NeilBrown <neilb@suse.com>

diff --git a/drivers/md/raid5.c b/drivers/md/raid5.c
index 508a29bd4733..a9604d4392ee 100644
--- a/drivers/md/raid5.c
+++ b/drivers/md/raid5.c
@@ -755,6 +755,10 @@ static void unlock_two_stripes(struct stripe_head *sh1, struct stripe_head *sh2)
 /* Only freshly new full stripe normal write stripe can be added to a batch list */
 static bool stripe_can_batch(struct stripe_head *sh)
 {
+	struct r5conf *conf = sh->raid_conf;
+
+	if (conf->log)
+		return false;
 	return test_bit(STRIPE_BATCH_READY, &sh->state) &&
 		!test_bit(STRIPE_BITMAP_PENDING, &sh->state) &&
 		is_full_stripe_write(sh);

