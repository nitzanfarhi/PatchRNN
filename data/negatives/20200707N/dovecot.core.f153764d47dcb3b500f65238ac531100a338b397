commit f153764d47dcb3b500f65238ac531100a338b397
Author: Aki Tuomi <aki.tuomi@dovecot.fi>
Date:   Mon Dec 12 15:14:52 2016 +0200

    imap: Fix assert when waiting for input on SEARCH/SORT
    
    Set cmd->state to CLIENT_COMMAND_STATE_WAIT_EXTERNAL
    because we are not expecting input or output.
    
    Fixes Panic: file imap-client.c: line 854 (client_check_command_hangs): assertion failed: (client->io != NULL || (client->output_cmd_lock != NULL && client->output_cmd_lock != client->input_lock))

diff --git a/src/imap/imap-search.c b/src/imap/imap-search.c
index b3f3d160f..dc3c77100 100644
--- a/src/imap/imap-search.c
+++ b/src/imap/imap-search.c
@@ -603,6 +603,9 @@ bool imap_search_start(struct imap_search_context *ctx,
 	/* we may have moved onto syncing by now */
 	if (cmd->func == cmd_search_more)
 		ctx->to = timeout_add(0, cmd_search_more_callback, cmd);
+
+	cmd->state = CLIENT_COMMAND_STATE_WAIT_EXTERNAL;
+
 	return FALSE;
 }
 

