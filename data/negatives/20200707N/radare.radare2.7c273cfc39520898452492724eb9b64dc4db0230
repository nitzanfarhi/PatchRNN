commit 7c273cfc39520898452492724eb9b64dc4db0230
Author: pancake <pancake@nopcode.org>
Date:   Wed Jan 8 17:19:52 2014 +0100

    Fix TE section name issue again

diff --git a/libr/bin/format/te/te.c b/libr/bin/format/te/te.c
index f5ef00232..336a2feea 100644
--- a/libr/bin/format/te/te.c
+++ b/libr/bin/format/te/te.c
@@ -280,7 +280,8 @@ struct r_bin_te_section_t* r_bin_te_get_sections(struct r_bin_te_obj_t* bin) {
 	}
 	for (i = 0; i < sections_count; i++) {
 		memcpy (sections[i].name, shdr[i].Name, TE_IMAGE_SIZEOF_NAME);
-		sections[i].name[TE_IMAGE_SIZEOF_NAME - 1] = '\0';
+		// not a null terminated string if len==buflen
+		//sections[i].name[TE_IMAGE_SIZEOF_NAME] = '\0';
 		sections[i].rva = shdr[i].VirtualAddress - r_bin_te_get_stripped_delta(bin);
 		sections[i].size = shdr[i].SizeOfRawData;
 		sections[i].vsize = shdr[i].VirtualSize;
diff --git a/libr/bin/p/bin_te.c b/libr/bin/p/bin_te.c
index 10aff9327..8ee0e408e 100644
--- a/libr/bin/p/bin_te.c
+++ b/libr/bin/p/bin_te.c
@@ -68,7 +68,12 @@ static RList* sections(RBinArch *arch) {
 	for (i = 0; !sections[i].last; i++) {
 		if (!(ptr = R_NEW0 (RBinSection)))
 			break;
-		strncpy (ptr->name, (char*)sections[i].name, R_BIN_SIZEOF_STRINGS);
+		if (sections[i].name[sizeof (sections[i].name)-1]) {
+			memcpy (ptr->name, sections[i].name,
+				sizeof (sections[i].name));
+			ptr->name[sizeof (sections[i].name)] = 0;
+		} else strncpy (ptr->name, (char*)sections[i].name,
+			R_BIN_SIZEOF_STRINGS);
 		ptr->size = sections[i].size;
 		ptr->vsize = sections[i].vsize;
 		ptr->offset = sections[i].offset;

