commit 17d9716d7b5381c4b6566bb1a06267d2bfcd1821
Author: Stefan Hajnoczi <stefanha@redhat.com>
Date:   Mon Jun 15 16:02:14 2015 +0100

    block: keep bitmap if incremental backup job is cancelled
    
    Reclaim the dirty bitmap if an incremental backup block job is
    cancelled.  The ret variable may be 0 when the job is cancelled so it's
    not enough to check ret < 0.
    
    Reviewed-by: John Snow <jsnow@redhat.com>
    Signed-off-by: Stefan Hajnoczi <stefanha@redhat.com>
    Message-id: 1434380534-7680-1-git-send-email-stefanha@redhat.com
    Signed-off-by: Jeff Cody <jcody@redhat.com>

diff --git a/block/backup.c b/block/backup.c
index d3c7d9f85d..965654d521 100644
--- a/block/backup.c
+++ b/block/backup.c
@@ -431,7 +431,7 @@ static void coroutine_fn backup_run(void *opaque)
 
     if (job->sync_bitmap) {
         BdrvDirtyBitmap *bm;
-        if (ret < 0) {
+        if (ret < 0 || block_job_is_cancelled(&job->common)) {
             /* Merge the successor back into the parent, delete nothing. */
             bm = bdrv_reclaim_dirty_bitmap(bs, job->sync_bitmap, NULL);
             assert(bm);

