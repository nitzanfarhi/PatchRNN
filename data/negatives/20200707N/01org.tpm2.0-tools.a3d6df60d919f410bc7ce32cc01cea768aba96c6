commit a3d6df60d919f410bc7ce32cc01cea768aba96c6
Author: Javier Martinez Canillas <javierm@redhat.com>
Date:   Thu Sep 21 16:08:29 2017 +0200

    tpm2_getmanufec: only attempt to persist the EK if a handle was provided
    
    The tool has a -H option to provide a persistent handle to store a EK, but
    currently is trying to do it even if no handle was provided.
    
    Make it fail early if that's the case since there's no point in attempting
    an operation that will fail.
    
    Signed-off-by: Javier Martinez Canillas <javierm@redhat.com>

diff --git a/tools/tpm2_getmanufec.c b/tools/tpm2_getmanufec.c
index 3ea4d1c..9aab6d8 100644
--- a/tools/tpm2_getmanufec.c
+++ b/tools/tpm2_getmanufec.c
@@ -235,6 +235,12 @@ int createEKHandle(TSS2_SYS_CONTEXT *sapi_context)
     LOG_INFO("EK create succ.. Handle: 0x%8.8x", handle2048ek);
 
     if (!ctx.non_persistent_read) {
+
+        if (!ctx.persistent_handle) {
+            LOG_ERR("Persistent handle for EK was not provided");
+            return 1;
+        }
+
          /*
           * To make EK persistent, use own auth
           */

