commit d66d7c6e3af510fd3856c05644e50bd44ca6c9db
Author: Andi Gutmans <andi@php.net>
Date:   Wed Feb 16 13:34:07 2000 +0000

    - In IIS ISAPI when the user presses the STOP button while the script is
      running make sure it stops gracefully. Before it stuck the server.

diff --git a/sapi/isapi/php4isapi.c b/sapi/isapi/php4isapi.c
index 24e8a96b2a..72a7bec1c0 100644
--- a/sapi/isapi/php4isapi.c
+++ b/sapi/isapi/php4isapi.c
@@ -136,9 +136,12 @@ static int sapi_isapi_ub_write(const char *str, uint str_length)
 	DWORD num_bytes = str_length;
 	LPEXTENSION_CONTROL_BLOCK ecb;
 	SLS_FETCH();
+	ELS_FETCH();
 	
 	ecb = (LPEXTENSION_CONTROL_BLOCK) SG(server_context);
-	ecb->WriteClient(ecb->ConnID, (char *) str, &num_bytes, HSE_IO_SYNC );
+	if (ecb->WriteClient(ecb->ConnID, (char *) str, &num_bytes, HSE_IO_SYNC ) == FALSE) {
+		longjmp(EG(bailout), 1);
+	}
 	return num_bytes;
 }
 

