commit 01be815500184443dc94b88a6ce4d9800c69768a
Author: William Pitcock <nenolod@atheme.org>
Date:   Mon Jun 15 21:56:01 2009 -0500

    chanserv: don't join channels with bots assigned to them.

diff --git a/modules/chanserv/main.c b/modules/chanserv/main.c
index e894c3be4..898482ec3 100644
--- a/modules/chanserv/main.c
+++ b/modules/chanserv/main.c
@@ -38,6 +38,8 @@ static void join_registered(bool all)
 	{
 		if (!(mc->flags & MC_GUARD))
 			continue;
+		if (metadata_find(mc, "private:botserv:bot-assigned") != NULL)
+			continue;
 
 		if (all)
 		{
@@ -252,6 +254,8 @@ static void cs_join(hook_channel_joinpart_t *hdata)
 	mc = mychan_find(chan->name);
 	if (mc == NULL)
 		return;
+	if (metadata_find(mc, "private:botserv:bot-assigned") != NULL)
+		return;
 
 	flags = chanacs_user_flags(mc, u);
 	noop = mc->flags & MC_NOOP || (u->myuser != NULL &&
@@ -483,6 +487,9 @@ static void cs_part(hook_channel_joinpart_t *hdata)
 	mc = mychan_find(cu->chan->name);
 	if (mc == NULL)
 		return;
+	if (metadata_find(mc, "private:botserv:bot-assigned") != NULL)
+		return;
+
 	if (CURRTIME - mc->used >= 3600)
 		if (chanacs_user_flags(mc, cu->user) & CA_USEDUPDATE)
 			mc->used = CURRTIME;
@@ -512,6 +519,8 @@ static void cs_register(hook_channel_req_t *hdata)
 	{
 		if (mc->flags & MC_GUARD)
 			join(mc->name, chansvs.nick);
+		if (metadata_find(mc, "private:botserv:bot-assigned") != NULL)
+			return;
 
 		check_modes(mc, true);
 	}
@@ -609,6 +618,8 @@ static void cs_newchan(channel_t *c)
 
 	if (!(mc = mychan_find(c->name)))
 		return;
+	if (metadata_find(mc, "private:botserv:bot-assigned") != NULL)
+		return;
 
 	/* schedule a mode lock check when we know the current modes
 	 * -- jilles */

