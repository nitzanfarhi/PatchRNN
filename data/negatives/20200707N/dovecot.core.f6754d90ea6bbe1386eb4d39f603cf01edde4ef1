commit f6754d90ea6bbe1386eb4d39f603cf01edde4ef1
Author: Timo Sirainen <tss@iki.fi>
Date:   Sun Feb 3 21:52:19 2013 +0200

    lib-fs: fs_write_stream_finish(file, NULL) is now alias to fs_write_stream_finish_async(file)
    This makes wrapper implementations easier.

diff --git a/src/lib-fs/fs-api.c b/src/lib-fs/fs-api.c
index 9c8d2fd3c..ba38e261d 100644
--- a/src/lib-fs/fs-api.c
+++ b/src/lib-fs/fs-api.c
@@ -314,7 +314,7 @@ struct ostream *fs_write_stream(struct fs_file *file)
 
 int fs_write_stream_finish(struct fs_file *file, struct ostream **output)
 {
-	i_assert(*output == file->output);
+	i_assert(*output == file->output || *output == NULL);
 
 	*output = NULL;
 	return file->fs->v.write_stream_finish(file, TRUE);

