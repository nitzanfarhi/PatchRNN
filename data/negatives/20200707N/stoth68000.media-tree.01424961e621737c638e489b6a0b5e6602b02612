commit 01424961e621737c638e489b6a0b5e6602b02612
Author: Al Viro <viro@www.linux.org.uk>
Date:   Sun Apr 24 12:28:34 2005 -0700

    [PATCH] mempolicy.c GFP fix
    
    zonelist_policy() forgot to mask non-zone bits from gfp when comparing
    zone number with policy_zone.
    
    ACKed-by: Andi Kleen <ak@suse.de>
    Signed-off-by: Al Viro <viro@parcelfarce.linux.theplanet.co.uk>
    Signed-off-by: Linus Torvalds <torvalds@osdl.org>

diff --git a/mm/mempolicy.c b/mm/mempolicy.c
index a3b44a671cec..08c41da429cf 100644
--- a/mm/mempolicy.c
+++ b/mm/mempolicy.c
@@ -661,7 +661,7 @@ static struct zonelist *zonelist_policy(unsigned int __nocast gfp, struct mempol
 	case MPOL_BIND:
 		/* Lower zones don't get a policy applied */
 		/* Careful: current->mems_allowed might have moved */
-		if (gfp >= policy_zone)
+		if ((gfp & GFP_ZONEMASK) >= policy_zone)
 			if (cpuset_zonelist_valid_mems_allowed(policy->v.zonelist))
 				return policy->v.zonelist;
 		/*FALL THROUGH*/

