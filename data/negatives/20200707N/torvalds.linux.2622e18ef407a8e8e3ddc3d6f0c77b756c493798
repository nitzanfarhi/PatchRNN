commit 2622e18ef407a8e8e3ddc3d6f0c77b756c493798
Author: Sean Hefty <sean.hefty@intel.com>
Date:   Mon May 30 22:30:46 2011 -0700

    IB/cm: Do not automatically disconnect XRC TGT QPs
    
    Because an XRC TGT QP can end up being shared among multiple
    processes, don't have the ib_cm automatically send a DREQ when the
    userspace process that owns the ib_cm_id exits.  Disconnect can be
    initiated by the user directly; otherwise, the owner of the XRC INI QP
    controls the connection.
    
    Note that as a result of the process exiting, the ib_cm will stop
    tracking the XRC connection on the target side.  For the purposes of
    disconnecting, this isn't a big deal.  The ib_cm will respond to the
    DREQ appropriately.  For other messages, mainly LAP, the CM will
    reject the request, since there's no one available to route the
    request to.
    
    Signed-off-by: Sean Hefty <sean.hefty@intel.com>
    Signed-off-by: Roland Dreier <roland@purestorage.com>

diff --git a/drivers/infiniband/core/cm.c b/drivers/infiniband/core/cm.c
index 42a7a9bae44e..4104ea2427c2 100644
--- a/drivers/infiniband/core/cm.c
+++ b/drivers/infiniband/core/cm.c
@@ -889,6 +889,8 @@ static void cm_destroy_id(struct ib_cm_id *cm_id, int err)
 		break;
 	case IB_CM_ESTABLISHED:
 		spin_unlock_irq(&cm_id_priv->lock);
+		if (cm_id_priv->qp_type == IB_QPT_XRC_TGT)
+			break;
 		ib_send_cm_dreq(cm_id, NULL, 0);
 		goto retest;
 	case IB_CM_DREQ_SENT:

