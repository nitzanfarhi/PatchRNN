commit a960baad4fe2628aea74eb626ed1dff2fa96a768
Author: craig <craig@b1e49159-3266-923f-9c3e-04f16369770a>
Date:   Sun Feb 19 00:42:44 2012 +0000

    Better redirect handling

diff --git a/models/streamfetcher.cpp b/models/streamfetcher.cpp
index 76bc4210..8a9d800e 100644
--- a/models/streamfetcher.cpp
+++ b/models/streamfetcher.cpp
@@ -237,18 +237,27 @@ void StreamFetcher::jobFinished(QNetworkReply *reply)
     // We only handle 1 job at a time!
     if (reply==job) {
         if (!reply->error()) {
-            QString u=parse(data, handlers);
-
-            if (u.isEmpty() || u==current) {
-                done.append(current);
-            } else if (u.startsWith(QLatin1String("http://")) && ++redirects<constMaxRedirects) {
-                // Redirect...
-                current=u;
+            QVariant redirect = reply->header(QNetworkRequest::LocationHeader);
+            if (redirect.isValid() && ++redirects<constMaxRedirects) {
+                reply->deleteLater();
+                current=redirect.toString();
                 data.clear();
-                job=manager->get(u);
+                job=manager->get(current);
                 connect(job, SIGNAL(readyRead()), this, SLOT(dataReady()));
             } else {
-                done.append(u);
+                QString u=parse(data, handlers);
+
+                if (u.isEmpty() || u==current) {
+                    done.append(current);
+                } else if (u.startsWith(QLatin1String("http://")) && ++redirects<constMaxRedirects) {
+                    // Redirect...
+                    current=u;
+                    data.clear();
+                    job=manager->get(u);
+                    connect(job, SIGNAL(readyRead()), this, SLOT(dataReady()));
+                } else {
+                    done.append(u);
+                }
             }
         } else {
             done.append(current);

