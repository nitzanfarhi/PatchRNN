commit 8c7274aa6f5ee352e0c748d83452d5f33badfd1e
Author: Andrew Beekhof <andrew@beekhof.net>
Date:   Thu Jan 10 17:50:26 2008 +0100

    High: PE: Bug 1777 - Allow colocation with a resource in the Stopped state
    
    Mercurial revision: 00d401efb27d74a329950fb0f3414469244618bd

diff --git a/pengine/native.c b/pengine/native.c
index 5cf64c77d..cc02895e7 100644
--- a/pengine/native.c
+++ b/pengine/native.c
@@ -582,19 +582,38 @@ filter_colocation_constraint(
 		return FALSE;
 	}
 
-	if(constraint->role_lh != RSC_ROLE_UNKNOWN
+	if(constraint->score > 0
+	   && constraint->role_lh != RSC_ROLE_UNKNOWN
 	   && constraint->role_lh != rsc_lh->next_role) {
-		crm_debug_4("RH: Skipping constraint: \"%s\" state filter",
+		crm_debug_4("LH: Skipping constraint: \"%s\" state filter",
 			    role2text(constraint->role_rh));
 		return FALSE;
 	}
 	
-	if(constraint->role_rh != RSC_ROLE_UNKNOWN
+	if(constraint->score > 0
+	   && constraint->role_rh != RSC_ROLE_UNKNOWN
 	   && constraint->role_rh != rsc_rh->next_role) {
 		crm_debug_4("RH: Skipping constraint: \"%s\" state filter",
 			    role2text(constraint->role_rh));
 		return FALSE;
 	}
+
+	if(constraint->score < 0
+	   && constraint->role_lh != RSC_ROLE_UNKNOWN
+	   && constraint->role_lh == rsc_lh->next_role) {
+		crm_debug_4("LH: Skipping -ve constraint: \"%s\" state filter",
+			    role2text(constraint->role_rh));
+		return FALSE;
+	}
+	
+	if(constraint->score < 0
+	   && constraint->role_rh != RSC_ROLE_UNKNOWN
+	   && constraint->role_rh == rsc_rh->next_role) {
+		crm_debug_4("RH: Skipping -ve constraint: \"%s\" state filter",
+			    role2text(constraint->role_rh));
+		return FALSE;
+	}
+
 	return TRUE;
 }
 

