commit bed8c0e6fe010dd040f1db6f9554511149902555
Author: bertrand <bertrand@fb.com>
Date:   Thu Jan 24 16:06:39 2013 -0800

    Don't allow nulls in regexes passed to preg_replace
    
    Summary: If we allow null characters in a regex, then a user could construct a string that ends with "/e\0" and surreptitiously execute an arbitrary piece of code.  With this patch we fatal if a null is found anywhere before the end of the regex (determined by length()).

diff --git a/hphp/runtime/base/preg.cpp b/hphp/runtime/base/preg.cpp
index 101eea2be8..876fad28fa 100644
--- a/hphp/runtime/base/preg.cpp
+++ b/hphp/runtime/base/preg.cpp
@@ -235,6 +235,12 @@ static const pcre_cache_entry* pcre_get_compiled_regex_cache(CStrRef regex) {
     }
   }
 
+  /* We've reached a null byte, now check if we're actually at the end of the
+     string.  If not this is a bad expression, and a potential security hole. */
+  if (regex.length() != (pp - regex.data())) {
+    raise_error("Error: Null byte found in pattern");
+  }
+
   /* Compile pattern and display a warning if compilation failed. */
   const char  *error;
   int erroffset;

