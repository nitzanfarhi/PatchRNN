commit 1a1769f32349a188db48cf81fe306b6f841fc246
Author: Steffen Klassert <klassert@mathematik.tu-chemnitz.de>
Date:   Tue Oct 16 14:24:09 2007 -0700

    WOL bugfix for 3c59x.c
    
    Some NICs (3c905B) can not generate PME in power state PCI_D0, while others
    like 3c905C can.  Call pci_enable_wake() with PCI_D3hot should give proper
    WOL for 3c905B.
    
    Signed-off-by: Steffen Klassert <klassert@mathematik.tu-chemnitz.de>
    Tested-by: Harry Coin <hcoin@n4comm.com>
    Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
    Signed-off-by: Jeff Garzik <jeff@garzik.org>

diff --git a/drivers/net/3c59x.c b/drivers/net/3c59x.c
index 8d3893da06f5..862f47223fdc 100644
--- a/drivers/net/3c59x.c
+++ b/drivers/net/3c59x.c
@@ -3118,7 +3118,13 @@ static void acpi_set_WOL(struct net_device *dev)
 		iowrite16(SetRxFilter|RxStation|RxMulticast|RxBroadcast, ioaddr + EL3_CMD);
 		iowrite16(RxEnable, ioaddr + EL3_CMD);
 
-		pci_enable_wake(VORTEX_PCI(vp), 0, 1);
+		if (pci_enable_wake(VORTEX_PCI(vp), PCI_D3hot, 1)) {
+			printk(KERN_INFO "%s: WOL not supported.\n",
+					pci_name(VORTEX_PCI(vp)));
+
+			vp->enable_wol = 0;
+			return;
+		}
 
 		/* Change the power state to D3; RxEnable doesn't take effect. */
 		pci_set_power_state(VORTEX_PCI(vp), PCI_D3hot);

