commit 216c44dfc17252ec0681dcb0bbeeb45a9d14eca7
Author: Mark Thompson <sw@jkqxz.net>
Date:   Sun Dec 17 19:48:35 2017 +0000

    vaapi_encode: Destroy output buffer pool before VA context
    
    The buffers are created associated with the context, so they should be
    destroyed before the context is.  This is enforced by the iHD driver.

diff --git a/libavcodec/vaapi_encode.c b/libavcodec/vaapi_encode.c
index c6113b1de..398b8e11f 100644
--- a/libavcodec/vaapi_encode.c
+++ b/libavcodec/vaapi_encode.c
@@ -1556,6 +1556,8 @@ av_cold int ff_vaapi_encode_close(AVCodecContext *avctx)
         vaapi_encode_free(avctx, pic);
     }
 
+    av_buffer_pool_uninit(&ctx->output_buffer_pool);
+
     if (ctx->va_context != VA_INVALID_ID) {
         vaDestroyContext(ctx->hwctx->display, ctx->va_context);
         ctx->va_context = VA_INVALID_ID;
@@ -1566,8 +1568,6 @@ av_cold int ff_vaapi_encode_close(AVCodecContext *avctx)
         ctx->va_config = VA_INVALID_ID;
     }
 
-    av_buffer_pool_uninit(&ctx->output_buffer_pool);
-
     av_freep(&ctx->codec_sequence_params);
     av_freep(&ctx->codec_picture_params);
 

