commit 84c2bbc7b4a9b2dce8396179e345e06ce22199d7
Author: Remi Gacogne <remi.gacogne@powerdns.com>
Date:   Sun Jul 2 00:12:05 2017 +0200

    rec: Use ECS when updating the validation state if needed
    
    If `use-incoming-ecs` is set and an actual ECS value was received.

diff --git a/pdns/syncres.cc b/pdns/syncres.cc
index 8fa0f9576..416dfd025 100644
--- a/pdns/syncres.cc
+++ b/pdns/syncres.cc
@@ -834,7 +834,7 @@ bool SyncRes::doCNAMECacheCheck(const DNSName &qname, const QType &qtype, vector
             state = SyncRes::validateRecordsWithSigs(depth, qname, QType(QType::CNAME), qname, cset, signatures);
             if (state != Indeterminate) {
               LOG(prefix<<qname<<": got Indeterminate state from the CNAME cache, new validation result is "<<vStates[state]<<endl);
-              t_RC->updateValidationStatus(d_now.tv_sec, qname, QType(QType::CNAME), d_requestor, d_requireAuthData, state);
+              t_RC->updateValidationStatus(d_now.tv_sec, qname, QType(QType::CNAME), d_incomingECSFound ? d_incomingECSNetwork : d_requestor, d_requireAuthData, state);
             }
           }
         }
@@ -992,7 +992,7 @@ bool SyncRes::doCacheCheck(const DNSName &qname, const QType &qtype, vector<DNSR
 
         if (cachedState != Indeterminate) {
           LOG(prefix<<qname<<": got Indeterminate state from the cache, validation result is "<<vStates[cachedState]<<endl);
-          t_RC->updateValidationStatus(d_now.tv_sec, sqname, sqt, d_requestor, d_requireAuthData, cachedState);
+          t_RC->updateValidationStatus(d_now.tv_sec, sqname, sqt, d_incomingECSFound ? d_incomingECSNetwork : d_requestor, d_requireAuthData, cachedState);
         }
       }
     }

