commit a896d03bb5f70ed76b3e9e1acba864115cfb5e01
Author: Peter Maydell <peter.maydell@linaro.org>
Date:   Mon Mar 12 06:24:45 2012 +0000

    gdbstub: Synchronize CPU state unconditionally in gdb_set_cpu_pc
    
    Synchronize the CPU state via cpu_sychronize_state() unconditionally
    in gdb_set_cpu_pc() rather than only in some of the target ifdef
    ladder cases.
    
    We can divide the CPUs into three categories:
     * non-KVM targets: no change of behaviour since we will use the
       kvm-stub.c no-op function.
     * i386 and s390: no change of behaviour since they were already
       calling this function
     * PPC (in KVM mode): this fixes an error: failing to synchronise
       was accidental and probably a bug.
    
    This also paves the way for other targets (specifically ARM) which
    can add KVM support in future without having to add another target
    specific change to this bit of code.
    
    Signed-off-by: Peter Maydell <peter.maydell@linaro.org>
    Signed-off-by: Blue Swirl <blauwirbel@gmail.com>

diff --git a/gdbstub.c b/gdbstub.c
index 6a7e2c4934..6a77a6696b 100644
--- a/gdbstub.c
+++ b/gdbstub.c
@@ -1903,8 +1903,8 @@ static void gdb_breakpoint_remove_all(void)
 
 static void gdb_set_cpu_pc(GDBState *s, target_ulong pc)
 {
-#if defined(TARGET_I386)
     cpu_synchronize_state(s->c_cpu);
+#if defined(TARGET_I386)
     s->c_cpu->eip = pc;
 #elif defined (TARGET_PPC)
     s->c_cpu->nip = pc;
@@ -1929,7 +1929,6 @@ static void gdb_set_cpu_pc(GDBState *s, target_ulong pc)
 #elif defined (TARGET_ALPHA)
     s->c_cpu->pc = pc;
 #elif defined (TARGET_S390X)
-    cpu_synchronize_state(s->c_cpu);
     s->c_cpu->psw.addr = pc;
 #elif defined (TARGET_LM32)
     s->c_cpu->pc = pc;

