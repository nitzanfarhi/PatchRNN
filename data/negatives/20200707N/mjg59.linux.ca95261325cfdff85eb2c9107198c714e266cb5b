commit ca95261325cfdff85eb2c9107198c714e266cb5b
Author: monk.liu <monk.liu@amd.com>
Date:   Mon May 25 14:44:05 2015 +0800

    drm/amdgpu: fix bug of vm_bo_map (v2)
    
    call reservation_object_reserve_shared before amdgpu_bo_fence
    
    Signed-off-by: monk.liu <monk.liu@amd.com>
    Reviewed-by: Christian KÃ¶nig <christian.koenig@amd.com>
    Reviewed-by: Jammy Zhou <jammy.zhou@amd.com>

diff --git a/drivers/gpu/drm/amd/amdgpu/amdgpu_vm.c b/drivers/gpu/drm/amd/amdgpu/amdgpu_vm.c
index b25e533fd6e8..cc6dca2581a6 100644
--- a/drivers/gpu/drm/amd/amdgpu/amdgpu_vm.c
+++ b/drivers/gpu/drm/amd/amdgpu/amdgpu_vm.c
@@ -315,6 +315,10 @@ static int amdgpu_vm_clear_bo(struct amdgpu_device *adev,
 	if (r)
 		return r;
 
+	r = reservation_object_reserve_shared(bo->tbo.resv);
+	if (r)
+		return r;
+
 	r = ttm_bo_validate(&bo->tbo, &bo->placement, true, false);
 	if (r)
 		goto error_unreserve;

