commit 06ed1361336f090f7687e519efcc386148764311
Author: Arun Kuruvila <arun.kuruvila@oracle.com>
Date:   Wed Feb 25 10:07:15 2015 +0530

    BUG#20031475: ASSERTION `HASH_NOT_OK == 0' FAILED IN
                  SQL_ACL.CC:1944
    
    Description:- Improper deletion of users from mysql.user
    table followed by granting privileges to a new user with
    same name as before leads to server crash.
    
    Analysis:- Deletion of users by deleting rows from the
    mysql.user table and granting privileges to a new user with
    same name as before leads to server crash. This is due to
    the lack of reloading acl privileges. A manual FLUSH
    PRIVILEGES command after the improper deletion will fix this
    problem. The assertion failure which occurs during the
    "acl_update()" is also due to the incorrect length of the
    plugin passed to the "acl_update_user()". Fixing this
    problem solves the server crash.
    
    Fix:- Correct plugin length is passed to "acl_update_user()".
    
    NOTE:- This patch is only for mysql-5.6. In mysql-5.7, the
    bug does not exist anymore.

diff --git a/sql/sql_acl.cc b/sql/sql_acl.cc
index d95b4edd429..c30fd48b2b3 100644
--- a/sql/sql_acl.cc
+++ b/sql/sql_acl.cc
@@ -2994,7 +2994,8 @@ static int replace_user_table(THD *thd, TABLE *table, LEX_USER *combo,
 	}
       }
     }
-    old_plugin.length= 0;
+    else
+      old_plugin.length= 0;
     combo->plugin= old_plugin;
 
     /*

