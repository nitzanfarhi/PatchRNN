commit 5734a6acf5f9bb8a0816c537d232530deda247c8
Author: Mathias Stearn <mathias@10gen.com>
Date:   Mon Oct 27 16:03:54 2014 -0400

    SERVER-13635 Fix KVStorageEngine::dropDatabase

diff --git a/src/mongo/db/storage/kv/kv_storage_engine.cpp b/src/mongo/db/storage/kv/kv_storage_engine.cpp
index fe73131362..da19282696 100644
--- a/src/mongo/db/storage/kv/kv_storage_engine.cpp
+++ b/src/mongo/db/storage/kv/kv_storage_engine.cpp
@@ -177,6 +177,13 @@ namespace mongo {
             entry = it->second;
         }
 
+        // This is called outside of a WUOW since MMAPv1 has unfortunate behavior around dropping
+        // databases. We need to create one here since we want db dropping to all-or-nothing
+        // wherever possible. Eventually we want to move this up so that it can include the logOp
+        // inside of the WUOW, but that would require making DB dropping happen inside the Dur
+        // system for MMAPv1.
+        WriteUnitOfWork wuow(txn);
+
         std::list<std::string> toDrop;
         entry->getCollectionNamespaces( &toDrop );
 
@@ -193,6 +200,8 @@ namespace mongo {
             txn->recoveryUnit()->registerChange(new RemoveDBChange(this, db, entry));
             _dbs.erase( db.toString() );
         }
+
+        wuow.commit();
         return Status::OK();
     }
 

