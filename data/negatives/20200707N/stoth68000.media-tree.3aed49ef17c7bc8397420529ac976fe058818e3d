commit 3aed49ef17c7bc8397420529ac976fe058818e3d
Author: Stanislaw Gruszka <sgruszka@redhat.com>
Date:   Wed Oct 6 11:22:12 2010 +0200

    mac80211: compete scan to cfg80211 if deferred scan fail to start
    
    We nulify local->scan_req on failure in __ieee80211_start_scan, so
    __ieee80211_scan_completed will not call cfg80211_scan_done. Fix that.
    
    Signed-off-by: Stanislaw Gruszka <sgruszka@redhat.com>
    Acked-by: Johannes Berg <johannes@sipsolutions.net>
    Signed-off-by: John W. Linville <linville@tuxdriver.com>

diff --git a/net/mac80211/scan.c b/net/mac80211/scan.c
index 9aab921f7ca8..80e017df5f31 100644
--- a/net/mac80211/scan.c
+++ b/net/mac80211/scan.c
@@ -665,6 +665,8 @@ void ieee80211_scan_work(struct work_struct *work)
 
 		rc = __ieee80211_start_scan(sdata, req);
 		if (rc) {
+			/* need to complete scan in cfg80211 */
+			local->scan_req = req;
 			aborted = true;
 			goto out_complete;
 		} else

