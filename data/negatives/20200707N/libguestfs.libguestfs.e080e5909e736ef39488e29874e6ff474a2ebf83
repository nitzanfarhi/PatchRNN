commit e080e5909e736ef39488e29874e6ff474a2ebf83
Author: Richard W.M. Jones <rjones@redhat.com>
Date:   Thu Apr 28 15:57:10 2016 +0100

    launch: libvirt: Add libvirt version to the data struct.
    
    This commit just allows us to make XML features conditional on the
    libvirt version, but has no other functional change.

diff --git a/src/launch-libvirt.c b/src/launch-libvirt.c
index b12160378..b4fd04949 100644
--- a/src/launch-libvirt.c
+++ b/src/launch-libvirt.c
@@ -118,6 +118,7 @@ struct backend_libvirt_data {
   char *network_bridge;
   char name[DOMAIN_NAME_LEN];   /* random name */
   bool is_kvm;                  /* false = qemu, true = kvm (from capabilities)*/
+  unsigned long libvirt_version; /* libvirt version */
   unsigned long qemu_version;   /* qemu version (from libvirt) */
   struct secret *secrets;       /* list of secrets */
   size_t nr_secrets;
@@ -235,7 +236,6 @@ launch_libvirt (guestfs_h *g, void *datav, const char *libvirt_uri)
 {
   struct backend_libvirt_data *data = datav;
   int daemon_accept_sock = -1, console_sock = -1;
-  unsigned long version;
   virConnectPtr conn = NULL;
   virDomainPtr dom = NULL;
   CLEANUP_FREE char *capabilities_xml = NULL;
@@ -262,11 +262,13 @@ launch_libvirt (guestfs_h *g, void *datav, const char *libvirt_uri)
     return -1;
   }
 
-  virGetVersion (&version, NULL, NULL);
+  virGetVersion (&data->libvirt_version, NULL, NULL);
   debug (g, "libvirt version = %lu (%lu.%lu.%lu)",
-         version,
-         version / 1000000UL, version / 1000UL % 1000UL, version % 1000UL);
-  if (version < MIN_LIBVIRT_VERSION) {
+         data->libvirt_version,
+         data->libvirt_version / 1000000UL,
+         data->libvirt_version / 1000UL % 1000UL,
+         data->libvirt_version % 1000UL);
+  if (data->libvirt_version < MIN_LIBVIRT_VERSION) {
     error (g, _("you must have libvirt >= %d.%d.%d "
                 "to use the 'libvirt' backend"),
            MIN_LIBVIRT_MAJOR, MIN_LIBVIRT_MINOR, MIN_LIBVIRT_MICRO);

