commit f0398d0364bc5819471138f646cea6926a0c40bc
Author: Florian Forster <octo@collectd.org>
Date:   Fri Dec 4 17:18:24 2015 +0100

    df plugin: Fix the duplicate detection.
    
    Not that multiple devices could be mounted at the same mount point ... I think.
    
    Fixes: #1402

diff --git a/src/df.c b/src/df.c
index 3f9eabda..74292d7e 100644
--- a/src/df.c
+++ b/src/df.c
@@ -204,7 +204,7 @@ static int df_read (void)
 	{
 		unsigned long long blocksize;
 		char disk_name[256];
-        cu_mount_t *mnt_dup_ptr;
+		cu_mount_t *dup_ptr;
 		uint64_t blk_free;
 		uint64_t blk_reserved;
 		uint64_t blk_used;
@@ -220,20 +220,27 @@ static int df_read (void)
 		if (ignorelist_match (il_fstype, mnt_ptr->type))
 			continue;
 
-		/* ignore duplicates */
-		for (mnt_dup_ptr = mnt_ptr; mnt_dup_ptr != NULL; mnt_dup_ptr = mnt_dup_ptr->next)
+		/* search for duplicates *in front of* the current mnt_ptr. */
+		for (dup_ptr = mnt_list; dup_ptr != NULL; dup_ptr = dup_ptr->next)
 		{
-			if (by_device) {
-				if (strcmp (mnt_ptr->spec_device, mnt_dup_ptr->spec_device) == 0)
-					continue;
-			}
-			else
+			/* No duplicate found: mnt_ptr is the first of its kind. */
+			if (dup_ptr == mnt_ptr)
 			{
-				if (strcmp (mnt_ptr->dir, mnt_dup_ptr->dir) == 0)
-					continue;
+				dup_ptr = NULL;
+				break;
 			}
+
+			/* Duplicate found: leave non-NULL dup_ptr. */
+			if (by_device && (strcmp (mnt_ptr->spec_device, dup_ptr->spec_device) == 0))
+				break;
+			else if (!by_device && (strcmp (mnt_ptr->dir, dup_ptr->dir) == 0))
+				break;
 		}
 
+		/* ignore duplicates */
+		if (dup_ptr != NULL)
+			continue;
+
 		if (STATANYFS (mnt_ptr->dir, &statbuf) < 0)
 		{
 			char errbuf[1024];

