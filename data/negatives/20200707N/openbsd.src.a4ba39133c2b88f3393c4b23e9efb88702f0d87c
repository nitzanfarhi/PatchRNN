commit a4ba39133c2b88f3393c4b23e9efb88702f0d87c
Author: reyk <reyk@openbsd.org>
Date:   Mon Feb 13 18:49:01 2017 +0000

    Fix powerdown with vmmci(4) VMs using a shutdown and no reset.
    
    vmm VMs don't support powerdown - no ACPI or power management - so we
    use a trick to issue a reboot and just don't reset after the triple
    fault.  This worked before but was broken with the previous fix to
    pvbus_shutdown() - move the trick to vmd instead.
    
    OK mlarkin@

diff --git a/usr.sbin/vmd/virtio.c b/usr.sbin/vmd/virtio.c
index d22066db949..b642e64653a 100644
--- a/usr.sbin/vmd/virtio.c
+++ b/usr.sbin/vmd/virtio.c
@@ -1,4 +1,4 @@
-/*	$OpenBSD: virtio.c,v 1.31 2017/01/21 11:36:54 reyk Exp $	*/
+/*	$OpenBSD: virtio.c,v 1.32 2017/02/13 18:49:01 reyk Exp $	*/
 
 /*
  * Copyright (c) 2015 Mike Larkin <mlarkin@openbsd.org>
@@ -1201,6 +1201,13 @@ vmmci_ctl(unsigned int cmd)
 		/* Update command */
 		vmmci.cmd = cmd;
 
+		/*
+		 * vmm VMs do not support powerdown, send a reboot request
+		 * instead and turn it off after the triple fault.
+		 */
+		if (cmd == VMMCI_SHUTDOWN)
+			cmd = VMMCI_REBOOT;
+
 		/* Trigger interrupt */
 		vmmci.cfg.isr_status = VIRTIO_CONFIG_ISR_CONFIG_CHANGE;
 		vcpu_assert_pic_irq(vmmci.vm_id, 0, vmmci.irq);

