commit 9be2f7c38e0bd64e8a0f74ea68df1e73e2ddfcc3
Author: Linus Torvalds <torvalds@g5.osdl.org>
Date:   Sat May 13 08:01:23 2006 -0700

    Revert "[PATCH] i386: export: memory more than 4G through /proc/iomem"
    
    This reverts commit 10dbe196a8da6b3196881269c6639c0ec11c36cb.
    
    The resource struct is still 32-bit, so trying to save a 64-bit memory
    size there obviously won't work.
    
    When we merge the 64-bit resource series, we can re-enable this.
    
    Thanks to Sachin Sant and Maneesh Soni for debugging
    
    Cc: Maneesh Soni <maneesh@in.ibm.com>
    Cc: Sachin Sant <sachinp@in.ibm.com>
    Cc: Russell King <rmk+lkml@arm.linux.org.uk>
    Cc: Sharyathi Nagesh <sharyath@in.ibm.com>
    Cc: Arjan van de Ven <arjan@infradead.org>
    Cc: Vivek Goyal <vgoyal@in.ibm.com>
    Signed-off-by: Linus Torvalds <torvalds@osdl.org>

diff --git a/arch/i386/kernel/setup.c b/arch/i386/kernel/setup.c
index d77e89ac0d54..846e1639ef7c 100644
--- a/arch/i386/kernel/setup.c
+++ b/arch/i386/kernel/setup.c
@@ -1320,6 +1320,8 @@ legacy_init_iomem_resources(struct resource *code_resource, struct resource *dat
 	probe_roms();
 	for (i = 0; i < e820.nr_map; i++) {
 		struct resource *res;
+		if (e820.map[i].addr + e820.map[i].size > 0x100000000ULL)
+			continue;
 		res = kzalloc(sizeof(struct resource), GFP_ATOMIC);
 		switch (e820.map[i].type) {
 		case E820_RAM:	res->name = "System RAM"; break;

