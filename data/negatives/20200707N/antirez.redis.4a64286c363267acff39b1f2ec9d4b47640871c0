commit 4a64286c363267acff39b1f2ec9d4b47640871c0
Author: antirez <antirez@gmail.com>
Date:   Tue Feb 11 10:06:10 2014 +0100

    Cluster: configEpoch assignment in SETNODE improved.
    
    Avoid to trash a configEpoch for every slot migrated if this node has
    already the max configEpoch across the cluster.
    
    Still work to do in this area but this avoids both ending with a very
    high configEpoch without any reason and to flood the system with fsyncs.

diff --git a/src/cluster.c b/src/cluster.c
index aeedc177..b6562341 100644
--- a/src/cluster.c
+++ b/src/cluster.c
@@ -3174,9 +3174,13 @@ void clusterCommand(redisClient *c) {
                  * FIXME: the new version should be agreed otherwise a race
                  * is possible if while a manual resharding is in progress
                  * the master is failed over by a slave. */
-                server.cluster->currentEpoch++;
-                myself->configEpoch = server.cluster->currentEpoch;
-                clusterDoBeforeSleep(CLUSTER_TODO_FSYNC_CONFIG);
+                uint64_t maxEpoch = clusterGetMaxEpoch();
+
+                if (myself->configEpoch != maxEpoch) {
+                    server.cluster->currentEpoch++;
+                    myself->configEpoch = server.cluster->currentEpoch;
+                    clusterDoBeforeSleep(CLUSTER_TODO_FSYNC_CONFIG);
+                }
                 server.cluster->importing_slots_from[slot] = NULL;
             }
             clusterDelSlot(slot);

