commit a9083081b56800691e79d541638fd2fc6366db0f
Author: Michael Halcrow <mhalcrow@us.ibm.com>
Date:   Thu Nov 16 01:19:16 2006 -0800

    [PATCH] eCryptfs: dput() lower d_parent on rename
    
    On rename, for both the old and new lower dentry objects, eCryptfs is
    missing a dput on the lower parent directory dentry.  This patch will
    prevent the BUG() at fs/dcache.c:613 from being hit after renaming a file
    inside eCryptfs and then doing a umount on the lower filesystem.
    
    Signed-off-by: Michael Halcrow <mhalcrow@us.ibm.com>
    Signed-off-by: Andrew Morton <akpm@osdl.org>
    Signed-off-by: Linus Torvalds <torvalds@osdl.org>

diff --git a/fs/ecryptfs/inode.c b/fs/ecryptfs/inode.c
index ff4865d24f0f..ebec8cfc189b 100644
--- a/fs/ecryptfs/inode.c
+++ b/fs/ecryptfs/inode.c
@@ -630,6 +630,8 @@ ecryptfs_rename(struct inode *old_dir, struct dentry *old_dentry,
 		ecryptfs_copy_attr_all(old_dir, lower_old_dir_dentry->d_inode);
 out_lock:
 	unlock_rename(lower_old_dir_dentry, lower_new_dir_dentry);
+	dput(lower_new_dentry->d_parent);
+	dput(lower_old_dentry->d_parent);
 	dput(lower_new_dentry);
 	dput(lower_old_dentry);
 	return rc;

