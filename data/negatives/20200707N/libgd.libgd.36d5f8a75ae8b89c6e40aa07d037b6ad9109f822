commit 36d5f8a75ae8b89c6e40aa07d037b6ad9109f822
Author: Ondřej Surý <ondrej@sury.org>
Date:   Mon Apr 22 23:32:50 2013 +0200

    Don't output jpeg error_message directly, but format it first and push it to gd_error_ex(GD_ERROR, ...)

diff --git a/src/gd_jpeg.c b/src/gd_jpeg.c
index 11a1ad3..adb6f96 100644
--- a/src/gd_jpeg.c
+++ b/src/gd_jpeg.c
@@ -101,9 +101,10 @@ static void jpeg_emit_message(j_common_ptr jpeg_info, int level)
 static void fatal_jpeg_error(j_common_ptr cinfo)
 {
 	jmpbuf_wrapper *jmpbufw;
+	char buffer[JMSG_LENGTH_MAX];
 
-	gd_error("gd-jpeg: JPEG library reports unrecoverable error: ");
-	(*cinfo->err->output_message)(cinfo);
+	(*cinfo->err->format_message)(cinfo, buffer);
+	gd_error(GD_ERROR, "gd-jpeg: JPEG library reports unrecoverable error: %s", buffer);
 
 	jmpbufw = (jmpbuf_wrapper *)cinfo->client_data;
 	jpeg_destroy(cinfo);
@@ -186,6 +187,7 @@ BGD_DECLARE(void) gdImageJpegCtx(gdImagePtr im, gdIOCtx *outfile, int quality)
 		return;
 	}
 
+	cinfo.err->emit_message = jpeg_emit_message;
 	cinfo.err->error_exit = fatal_jpeg_error;
 
 	jpeg_create_compress(&cinfo);

