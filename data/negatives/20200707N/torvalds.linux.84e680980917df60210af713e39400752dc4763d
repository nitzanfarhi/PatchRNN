commit 84e680980917df60210af713e39400752dc4763d
Author: Philipp Zabel <p.zabel@pengutronix.de>
Date:   Thu Sep 19 04:53:21 2013 -0300

    [media] v4l2-mem2mem: clear m2m queue ready counter in v4l2_m2m_streamoff
    
    v4l2_m2m_streamoff drops the list of ready buffers but failed to reset the
    num_rdy counter to zero. This would lead to v4l2_m2m_num_src/dst_bufs_ready
    reporting wrong values after streamoff.
    
    Signed-off-by: Philipp Zabel <p.zabel@pengutronix.de>
    Signed-off-by: Kamil Debski <k.debski@samsung.com>
    Signed-off-by: Mauro Carvalho Chehab <m.chehab@samsung.com>

diff --git a/drivers/media/v4l2-core/v4l2-mem2mem.c b/drivers/media/v4l2-core/v4l2-mem2mem.c
index 8f116c2642db..796de3349303 100644
--- a/drivers/media/v4l2-core/v4l2-mem2mem.c
+++ b/drivers/media/v4l2-core/v4l2-mem2mem.c
@@ -488,6 +488,7 @@ int v4l2_m2m_streamoff(struct file *file, struct v4l2_m2m_ctx *m2m_ctx,
 	/* Drop queue, since streamoff returns device to the same state as after
 	 * calling reqbufs. */
 	INIT_LIST_HEAD(&q_ctx->rdy_queue);
+	q_ctx->num_rdy = 0;
 	spin_unlock_irqrestore(&q_ctx->rdy_spinlock, flags);
 
 	if (m2m_dev->curr_ctx == m2m_ctx) {

