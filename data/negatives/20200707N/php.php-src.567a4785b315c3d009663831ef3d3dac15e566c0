commit 567a4785b315c3d009663831ef3d3dac15e566c0
Author: Dmitry Stogov <dmitry@php.net>
Date:   Mon Sep 11 07:22:40 2006 +0000

    Don't try to do safe connection close in case of FastCGI protocol error

diff --git a/sapi/cgi/fastcgi.c b/sapi/cgi/fastcgi.c
index ae57779b7c..4a2a73623d 100644
--- a/sapi/cgi/fastcgi.c
+++ b/sapi/cgi/fastcgi.c
@@ -611,10 +611,12 @@ static inline void fcgi_close(fcgi_request *req, int force, int destroy)
 			RevertToSelf();
 		}
 #else
-		char buf[8];
+		if (!force) {
+			char buf[8];
 
-		shutdown(req->fd, 1);
-		while (recv(req->fd, buf, sizeof(buf), 0) > 0) {}
+			shutdown(req->fd, 1);
+			while (recv(req->fd, buf, sizeof(buf), 0) > 0) {}
+		}
 		close(req->fd);
 #endif
 		req->fd = -1;

