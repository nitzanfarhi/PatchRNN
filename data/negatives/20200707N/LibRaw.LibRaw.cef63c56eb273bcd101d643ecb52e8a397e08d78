commit cef63c56eb273bcd101d643ecb52e8a397e08d78
Author: Alex Tutubalin <lexa@lexa.ru>
Date:   Tue Jul 10 18:58:16 2018 +0300

    additional checks in parse_phase_one()

diff --git a/dcraw/dcraw.c b/dcraw/dcraw.c
index 04beec8..fe6d742 100644
--- a/dcraw/dcraw.c
+++ b/dcraw/dcraw.c
@@ -16199,8 +16199,11 @@ void CLASS parse_phase_one(int base)
   order = get4() & 0xffff;
   if (get4() >> 8 != 0x526177)
     return; /* "Raw" */
-  fseek(ifp, get4() + base, SEEK_SET);
+  unsigned offset = get4();
+  if(offset == 0xbad0bad) return;
+  fseek(ifp, offset + base, SEEK_SET);
   entries = get4();
+  if(entries > 8192) return; // too much??
   get4();
   while (entries--)
   {
diff --git a/internal/dcraw_common.cpp b/internal/dcraw_common.cpp
index 96b91ea..306f461 100644
--- a/internal/dcraw_common.cpp
+++ b/internal/dcraw_common.cpp
@@ -14861,8 +14861,11 @@ void CLASS parse_phase_one(int base)
   order = get4() & 0xffff;
   if (get4() >> 8 != 0x526177)
     return; /* "Raw" */
-  fseek(ifp, get4() + base, SEEK_SET);
+  unsigned offset = get4();
+  if(offset == 0xbad0bad) return;
+  fseek(ifp, offset + base, SEEK_SET);
   entries = get4();
+  if(entries > 8192) return; // too much??
   get4();
   while (entries--)
   {

