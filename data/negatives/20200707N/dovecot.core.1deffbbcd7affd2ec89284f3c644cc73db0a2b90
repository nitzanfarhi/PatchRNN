commit 1deffbbcd7affd2ec89284f3c644cc73db0a2b90
Author: Timo Sirainen <tss@iki.fi>
Date:   Tue Feb 19 13:43:42 2013 +0200

    lib-index: Give a better error message if index is readonly and log is tried to be locked.

diff --git a/src/lib-index/mail-transaction-log-file.c b/src/lib-index/mail-transaction-log-file.c
index 97e22f5cf..df16f4308 100644
--- a/src/lib-index/mail-transaction-log-file.c
+++ b/src/lib-index/mail-transaction-log-file.c
@@ -362,6 +362,13 @@ int mail_transaction_log_file_lock(struct mail_transaction_log_file *file)
 	if (file->log->index->lock_method == FILE_LOCK_METHOD_DOTLOCK)
 		return mail_transaction_log_file_dotlock(file);
 
+	if (file->log->index->readonly) {
+		mail_index_set_error(file->log->index,
+			"Index is read-only, can't write-lock %s",
+			file->filepath);
+		return -1;
+	}
+
 	i_assert(file->file_lock == NULL);
 	lock_timeout_secs = I_MIN(MAIL_TRANSACTION_LOG_LOCK_TIMEOUT,
 				  file->log->index->max_lock_timeout_secs);

