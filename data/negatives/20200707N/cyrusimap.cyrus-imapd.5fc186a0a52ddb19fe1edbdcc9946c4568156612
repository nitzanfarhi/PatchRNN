commit 5fc186a0a52ddb19fe1edbdcc9946c4568156612
Author: Bron Gondwana <brong@fastmail.fm>
Date:   Mon Apr 29 16:31:45 2013 +1000

    mailbox: cleanup correctly when DELETED records retained

diff --git a/imap/mailbox.c b/imap/mailbox.c
index 2828940c0..c0b3c1bbb 100644
--- a/imap/mailbox.c
+++ b/imap/mailbox.c
@@ -3447,6 +3447,8 @@ static int chkchildren(char *name,
     int r;
 
     r = mboxlist_lookup(name, &mbentry, 0);
+    /* deleted mailboxes don't count as children */
+    if (r == IMAP_MAILBOX_NONEXISTENT) return 0;
     if (r) return r;
 
     if (!strcmp(part, mbentry->partition))

