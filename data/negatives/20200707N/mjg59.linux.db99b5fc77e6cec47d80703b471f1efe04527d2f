commit db99b5fc77e6cec47d80703b471f1efe04527d2f
Author: Johan Hedberg <johan.hedberg@intel.com>
Date:   Wed Feb 22 20:14:22 2012 +0200

    Bluetooth: Fix read_name updating when HCI_SETUP is not set
    
    The local name should only be updated as a consequence of a
    hci_read_local_name if we are in the HCI_SETUP state. In all other
    scenarios it should only be updated through hci_write_local_name.
    
    Signed-off-by: Johan Hedberg <johan.hedberg@intel.com>
    Acked-by: Marcel Holtmann <marcel@holtmann.org>

diff --git a/net/bluetooth/hci_event.c b/net/bluetooth/hci_event.c
index c79ffb955554..9917fe3d1d18 100644
--- a/net/bluetooth/hci_event.c
+++ b/net/bluetooth/hci_event.c
@@ -227,7 +227,8 @@ static void hci_cc_read_local_name(struct hci_dev *hdev, struct sk_buff *skb)
 	if (rp->status)
 		return;
 
-	memcpy(hdev->dev_name, rp->name, HCI_MAX_NAME_LENGTH);
+	if (test_bit(HCI_SETUP, &hdev->dev_flags))
+		memcpy(hdev->dev_name, rp->name, HCI_MAX_NAME_LENGTH);
 }
 
 static void hci_cc_write_auth_enable(struct hci_dev *hdev, struct sk_buff *skb)

