commit 91f10a99436b2a906a63bb256c6c03fcd1d7af44
Author: tomas@poseidon.(none) <>
Date:   Mon Aug 23 18:47:12 2004 +0000

    added support for stopping ndb_mgmd from client

diff --git a/ndb/src/mgmsrv/Services.cpp b/ndb/src/mgmsrv/Services.cpp
index 121176f5a19..d51e54f688d 100644
--- a/ndb/src/mgmsrv/Services.cpp
+++ b/ndb/src/mgmsrv/Services.cpp
@@ -31,6 +31,8 @@
 
 #include "Services.hpp"
 
+extern bool g_StopServer;
+
 static const unsigned int MAX_READ_TIMEOUT = 1000 ;
 static const unsigned int MAX_WRITE_TIMEOUT = 100 ;
 
@@ -1012,12 +1014,29 @@ MgmApiSession::stop(Parser<MgmApiSession>::Context &,
     nodes.push_back(atoi(p));
   }
 
+  int stop_self= 0;
+
+  for(size_t i=0; i < nodes.size(); i++) {
+    if (nodes[i] == m_mgmsrv.getOwnNodeId()) {
+      stop_self= 1;
+      if (i != nodes.size()-1) {
+	m_output->println("stop reply");
+	m_output->println("result: server must be stopped last");
+	m_output->println("");
+	return;
+      }
+    }
+  }
+
   int stopped = 0, result = 0;
   
   for(size_t i=0; i < nodes.size(); i++)
-    if((result = m_mgmsrv.stopNode(nodes[i], abort != 0)) == 0)
+    if (nodes[i] != m_mgmsrv.getOwnNodeId()) {
+      if((result = m_mgmsrv.stopNode(nodes[i], abort != 0)) == 0)
+	stopped++;
+    } else
       stopped++;
-  
+
   m_output->println("stop reply");
   if(result != 0)
     m_output->println("result: %s", m_mgmsrv.getErrorText(result));
@@ -1025,6 +1044,9 @@ MgmApiSession::stop(Parser<MgmApiSession>::Context &,
     m_output->println("result: Ok");
   m_output->println("stopped: %d", stopped);
   m_output->println("");
+
+  if (stop_self)
+    g_StopServer= true;
 }
 
 
diff --git a/ndb/src/mgmsrv/main.cpp b/ndb/src/mgmsrv/main.cpp
index 719226b51df..465d858cfab 100644
--- a/ndb/src/mgmsrv/main.cpp
+++ b/ndb/src/mgmsrv/main.cpp
@@ -265,9 +265,10 @@ NDB_MAIN(mgmsrv){
 	NdbSleep_MilliSleep(500);
     }
   
+  g_EventLogger.info("Shutting down server...");
   glob.socketServer->stopServer();
   glob.socketServer->stopSessions();
-  
+  g_EventLogger.info("Shutdown complete");
   return 0;
  error_end:
   return 1;

