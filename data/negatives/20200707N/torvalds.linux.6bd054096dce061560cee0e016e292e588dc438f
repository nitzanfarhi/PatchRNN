commit 6bd054096dce061560cee0e016e292e588dc438f
Author: Will Deacon <will.deacon@arm.com>
Date:   Fri Dec 2 18:16:01 2011 +0100

    ARM: 7185/1: perf: don't assign platform_device on unsupported CPUs
    
    In the unlikely case that a platform registers a PMU platform_device
    when running on a CPU that is unsupported by perf, we will encounter a
    NULL dereference when trying to assign the platform_device to the
    cpu_pmu structure.
    
    This patch checks that the CPU is supported by perf before assigning
    the platform_device.
    
    Reported-by: Pawel Moll <pawel.moll@arm.com>
    Signed-off-by: Will Deacon <will.deacon@arm.com>
    Signed-off-by: Russell King <rmk+kernel@arm.linux.org.uk>

diff --git a/arch/arm/kernel/perf_event.c b/arch/arm/kernel/perf_event.c
index 8e9c98edc068..88b0941ce51e 100644
--- a/arch/arm/kernel/perf_event.c
+++ b/arch/arm/kernel/perf_event.c
@@ -640,6 +640,9 @@ static struct platform_device_id armpmu_plat_device_ids[] = {
 
 static int __devinit armpmu_device_probe(struct platform_device *pdev)
 {
+	if (!cpu_pmu)
+		return -ENODEV;
+
 	cpu_pmu->plat_device = pdev;
 	return 0;
 }

