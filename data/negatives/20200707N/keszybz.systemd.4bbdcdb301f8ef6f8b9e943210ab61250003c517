commit 4bbdcdb301f8ef6f8b9e943210ab61250003c517
Author: Lennart Poettering <lennart@poettering.net>
Date:   Wed Jan 4 02:16:38 2012 +0100

    journal: apply seek check before resizing window, and refresh stat data if necessary

diff --git a/src/journal/journal-file.c b/src/journal/journal-file.c
index 15a752d50..977cfa101 100644
--- a/src/journal/journal-file.c
+++ b/src/journal/journal-file.c
@@ -296,6 +296,15 @@ static int journal_file_move_to(JournalFile *f, int wt, uint64_t offset, uint64_
         assert(wt >= 0);
         assert(wt < _WINDOW_MAX);
 
+        if (offset + size > (uint64_t) f->last_stat.st_size) {
+                /* Hmm, out of range? Let's refresh the fstat() data
+                 * first, before we trust that check. */
+
+                if (fstat(f->fd, &f->last_stat) < 0 ||
+                    offset + size > (uint64_t) f->last_stat.st_size)
+                        return -EADDRNOTAVAIL;
+        }
+
         w = f->windows + wt;
 
         if (_likely_(w->ptr &&
@@ -331,9 +340,6 @@ static int journal_file_move_to(JournalFile *f, int wt, uint64_t offset, uint64_
         } else
                 delta = 0;
 
-        if (offset > (uint64_t) f->last_stat.st_size)
-                return -EADDRNOTAVAIL;
-
         if (offset + size > (uint64_t) f->last_stat.st_size)
                 size = PAGE_ALIGN((uint64_t) f->last_stat.st_size - offset);
 

