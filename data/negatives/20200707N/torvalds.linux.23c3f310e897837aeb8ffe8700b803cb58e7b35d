commit 23c3f310e897837aeb8ffe8700b803cb58e7b35d
Author: Charles Keepax <ckeepax@opensource.wolfsonmicro.com>
Date:   Thu Sep 17 14:50:20 2015 +0100

    regulator: core: Correct return value check in regulator_resolve_supply
    
    The ret pointer passed to regulator_dev_lookup is only filled with a
    valid error code if regulator_dev_lookup returned NULL. Currently
    regulator_resolve_supply checks this ret value before it checks if a
    regulator was returned, this can result in valid regulator lookups being
    ignored.
    
    Fixes: 6261b06de565 ("regulator: Defer lookup of supply to regulator_get")
    Signed-off-by: Charles Keepax <ckeepax@opensource.wolfsonmicro.com>
    Signed-off-by: Mark Brown <broonie@kernel.org>
    Cc: stable@vger.kernel.org

diff --git a/drivers/regulator/core.c b/drivers/regulator/core.c
index 7150ff6ef46b..d0fbaea9bf54 100644
--- a/drivers/regulator/core.c
+++ b/drivers/regulator/core.c
@@ -1394,15 +1394,15 @@ static int regulator_resolve_supply(struct regulator_dev *rdev)
 		return 0;
 
 	r = regulator_dev_lookup(dev, rdev->supply_name, &ret);
-	if (ret == -ENODEV) {
-		/*
-		 * No supply was specified for this regulator and
-		 * there will never be one.
-		 */
-		return 0;
-	}
-
 	if (!r) {
+		if (ret == -ENODEV) {
+			/*
+			 * No supply was specified for this regulator and
+			 * there will never be one.
+			 */
+			return 0;
+		}
+
 		if (have_full_constraints()) {
 			r = dummy_regulator_rdev;
 		} else {

