commit ad4aca69bbd40663ca93a3eb1d8042c023b9b407
Author: Stefan Berger <stefanb@linux.vnet.ibm.com>
Date:   Fri Nov 10 22:07:35 2017 -0500

    tpm_tis: Return TPM_VERSION_UNSPEC in case of BE failure
    
    In case the backend has a failure, such as the tpm_emulator's CMD_INIT
    failing, the TIS goes into failure mode and does not respond to reads
    or writes to MMIO registers. In this case we need to prevent the ACPI
    table from being added and the straight-forward way is to indicate that
    there's no known TPM version being used.
    
    Signed-off-by: Stefan Berger <stefanb@linux.vnet.ibm.com>
    Reviewed-by: Marc-Andr√© Lureau <marcandre.lureau@redhat.com>

diff --git a/hw/tpm/tpm_tis.c b/hw/tpm/tpm_tis.c
index 7402528b25..fec2fc617a 100644
--- a/hw/tpm/tpm_tis.c
+++ b/hw/tpm/tpm_tis.c
@@ -1008,6 +1008,10 @@ TPMVersion tpm_tis_get_tpm_version(Object *obj)
 {
     TPMState *s = TPM(obj);
 
+    if (tpm_backend_had_startup_error(s->be_driver)) {
+        return TPM_VERSION_UNSPEC;
+    }
+
     return tpm_backend_get_tpm_version(s->be_driver);
 }
 

