commit fa3b6dcd5298db2e7b63c17795c9e5570d3df8d9
Author: Yu Zhao <yu.zhao@intel.com>
Date:   Fri May 8 10:33:38 2009 +0800

    VT-d: fix invalid domain id for KVM context flush
    
    The domain->id is a sequence number associated with the KVM guest
    and should not be used for the context flush. This patch replaces
    the domain->id with a proper id value for both bare metal and KVM.
    
    Signed-off-by: Yu Zhao <yu.zhao@intel.com>
    Acked-by: Weidong Han <weidong.han@intel.com>
    Signed-off-by: David Woodhouse <David.Woodhouse@intel.com>

diff --git a/drivers/pci/intel-iommu.c b/drivers/pci/intel-iommu.c
index d3edd6aa82ce..d6f4ee50924c 100644
--- a/drivers/pci/intel-iommu.c
+++ b/drivers/pci/intel-iommu.c
@@ -1429,7 +1429,7 @@ static int domain_context_mapping_one(struct dmar_domain *domain, int segment,
 	domain_flush_cache(domain, context, sizeof(*context));
 
 	/* it's a non-present to present mapping */
-	if (iommu->flush.flush_context(iommu, domain->id,
+	if (iommu->flush.flush_context(iommu, id,
 		(((u16)bus) << 8) | devfn, DMA_CCMD_MASK_NOBIT,
 		DMA_CCMD_DEVICE_INVL, 1))
 		iommu_flush_write_buffer(iommu);

