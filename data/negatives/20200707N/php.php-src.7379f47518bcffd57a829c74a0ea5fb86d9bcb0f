commit 7379f47518bcffd57a829c74a0ea5fb86d9bcb0f
Author: Wez Furlong <wez@php.net>
Date:   Wed Mar 19 00:17:15 2003 +0000

    Sanity check for when a stream is requested to be persistent but the wrapper
    does not respect the flag.

diff --git a/main/streams/streams.c b/main/streams/streams.c
index e2ff0bd709..b3dff8abb0 100755
--- a/main/streams/streams.c
+++ b/main/streams/streams.c
@@ -1461,6 +1461,15 @@ PHPAPI php_stream *_php_stream_open_wrapper_ex(char *path, char *mode, int optio
 		stream = wrapper->wops->stream_opener(wrapper,
 				path_to_open, mode, options ^ REPORT_ERRORS,
 				opened_path, context STREAMS_REL_CC TSRMLS_CC);
+	
+		/* if the caller asked for a persistent stream but the wrapper did not
+		 * return one, force an error here */
+		if (stream && (options & STREAM_OPEN_PERSISTENT) && !stream->is_persistent) {
+			php_stream_wrapper_log_error(wrapper, options ^ REPORT_ERRORS TSRMLS_CC,
+					"wrapper does not support persistent streams");
+			php_stream_close(stream);
+			stream = NULL;
+		}
 		
 		if (stream) {
 			stream->wrapper = wrapper;

