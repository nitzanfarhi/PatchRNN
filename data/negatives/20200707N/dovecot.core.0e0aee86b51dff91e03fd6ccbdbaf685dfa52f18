commit 0e0aee86b51dff91e03fd6ccbdbaf685dfa52f18
Author: Timo Sirainen <tss@iki.fi>
Date:   Mon Jan 9 10:05:24 2006 +0200

    try_alloc: Handle mail_get_physical_size() failures.
    
    --HG--
    branch : HEAD

diff --git a/src/plugins/quota/quota-dict.c b/src/plugins/quota/quota-dict.c
index 5560ff53d..1207af06c 100644
--- a/src/plugins/quota/quota-dict.c
+++ b/src/plugins/quota/quota-dict.c
@@ -231,6 +231,9 @@ dict_quota_try_alloc(struct quota_transaction_context *ctx,
 	uoff_t size;
 
 	size = mail_get_physical_size(mail);
+	if (size == (uoff_t)-1)
+		return -1;
+
 	*too_large_r = size > ctx->storage_limit;
 
 	if (ctx->storage_current + ctx->bytes_diff + size > ctx->storage_limit)
diff --git a/src/plugins/quota/quota-dirsize.c b/src/plugins/quota/quota-dirsize.c
index 9b95d3ab4..2d1c91712 100644
--- a/src/plugins/quota/quota-dirsize.c
+++ b/src/plugins/quota/quota-dirsize.c
@@ -269,6 +269,9 @@ dirsize_quota_try_alloc(struct quota_transaction_context *ctx,
 		return -1;
 
 	size = mail_get_physical_size(mail);
+	if (size == (uoff_t)-1)
+		return -1;
+
 	*too_large_r = size > ctx->storage_limit;
 
 	if (ctx->storage_current + ctx->bytes_diff + size > ctx->storage_limit)

