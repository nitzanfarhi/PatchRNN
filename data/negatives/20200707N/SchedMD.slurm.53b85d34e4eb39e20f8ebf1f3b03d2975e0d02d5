commit 53b85d34e4eb39e20f8ebf1f3b03d2975e0d02d5
Author: Morris Jette <jette@schedmd.com>
Date:   Tue Aug 11 07:36:43 2015 -0700

    job configuring state fix
    
    This propagates the logic from commit aa81c5503b63b581913af6ddf52aae2270588fec
    into another place where the job CONFIGURING flag is set.

diff --git a/src/slurmctld/job_mgr.c b/src/slurmctld/job_mgr.c
index 6b07f0c559..aa96883b43 100644
--- a/src/slurmctld/job_mgr.c
+++ b/src/slurmctld/job_mgr.c
@@ -11128,6 +11128,7 @@ extern int
 job_alloc_info(uint32_t uid, uint32_t job_id, struct job_record **job_pptr)
 {
 	struct job_record *job_ptr;
+	uint8_t prolog = 0;
 
 	job_ptr = find_job_record(job_id);
 	if (job_ptr == NULL)
@@ -11140,9 +11141,11 @@ job_alloc_info(uint32_t uid, uint32_t job_id, struct job_record **job_pptr)
 		return ESLURM_JOB_PENDING;
 	if (IS_JOB_FINISHED(job_ptr))
 		return ESLURM_ALREADY_DONE;
+	if (job_ptr->details)
+		prolog = job_ptr->details->prolog_running;
 
 	if (job_ptr->alias_list && !strcmp(job_ptr->alias_list, "TBD") &&
-	    job_ptr->node_bitmap &&
+	    (prolog == 0) && job_ptr->node_bitmap &&
 	    (bit_overlap(power_node_bitmap, job_ptr->node_bitmap) == 0)) {
 		job_ptr->job_state &= (~JOB_CONFIGURING);
 		set_job_alias_list(job_ptr);
diff --git a/src/slurmctld/job_scheduler.c b/src/slurmctld/job_scheduler.c
index b38264792e..56cdd703eb 100644
--- a/src/slurmctld/job_scheduler.c
+++ b/src/slurmctld/job_scheduler.c
@@ -3268,7 +3268,7 @@ static void *_run_prolog(void *arg)
 	}
 	if (job_ptr) {
                 job_ptr->job_state &= ~JOB_CONFIGURING;
-		if (job_ptr->details)
+		if (job_ptr->details && job_ptr->details->prolog_running)
 			job_ptr->details->prolog_running--;
 		if (job_ptr->batch_flag &&
 		    (IS_JOB_RUNNING(job_ptr) || IS_JOB_SUSPENDED(job_ptr)))

