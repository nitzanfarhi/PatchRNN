commit 3d7f4f87267cf260795f28de1f669c3f45e05a28
Author: Nicolas George <nicolas.george@normalesup.org>
Date:   Wed Feb 13 13:28:57 2013 +0100

    lavf/avio: check that the protocol supports the open mode.
    
    Fix trac ticket #2139.

diff --git a/libavformat/avio.c b/libavformat/avio.c
index 6d8a8bb92a..b00cc9d349 100644
--- a/libavformat/avio.c
+++ b/libavformat/avio.c
@@ -119,6 +119,16 @@ static int url_alloc_for_protocol (URLContext **puc, struct URLProtocol *up,
     if (up->flags & URL_PROTOCOL_FLAG_NETWORK && !ff_network_init())
         return AVERROR(EIO);
 #endif
+    if ((flags & AVIO_FLAG_READ) && !up->url_read) {
+        av_log(NULL, AV_LOG_ERROR,
+               "Impossible to open the '%s' protocol for reading\n", up->name);
+        return AVERROR(EIO);
+    }
+    if ((flags & AVIO_FLAG_WRITE) && !up->url_write) {
+        av_log(NULL, AV_LOG_ERROR,
+               "Impossible to open the '%s' protocol for writing\n", up->name);
+        return AVERROR(EIO);
+    }
     uc = av_mallocz(sizeof(URLContext) + strlen(filename) + 1);
     if (!uc) {
         err = AVERROR(ENOMEM);

