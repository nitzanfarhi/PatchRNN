commit 0c064c3f03cbd7272866fd1e1a186fd7bded91d3
Author: marko <>
Date:   Wed Feb 17 13:52:05 2010 +0000

    branches/zip: Merge revisions 6613:6669 from branches/5.1:
      ------------------------------------------------------------------------
      r6669 | jyang | 2010-02-11 12:24:19 +0200 (Thu, 11 Feb 2010) | 7 lines
    
      branches/5.1: Fix bug #50691, AIX implementation of readdir_r
      causes InnoDB errors. readdir_r() returns an non-NULL value
      in the case of reaching the end of a directory. It should
      not be treated as an error return.
    
      rb://238 approved by Marko
      ------------------------------------------------------------------------

diff --git a/os/os0file.c b/os/os0file.c
index 2bb652980b0..f19e587053b 100644
--- a/os/os0file.c
+++ b/os/os0file.c
@@ -789,7 +789,15 @@ next_file:
 #ifdef HAVE_READDIR_R
 	ret = readdir_r(dir, (struct dirent*)dirent_buf, &ent);
 
-	if (ret != 0) {
+	if (ret != 0
+#ifdef UNIV_AIX
+	    /* On AIX, only if we got non-NULL 'ent' (result) value and
+	    a non-zero 'ret' (return) value, it indicates a failed
+	    readdir_r() call. An NULL 'ent' with an non-zero 'ret'
+	    would indicate the "end of the directory" is reached. */
+	    && ent != NULL
+#endif
+	   ) {
 		fprintf(stderr,
 			"InnoDB: cannot read directory %s, error %lu\n",
 			dirname, (ulong)ret);

