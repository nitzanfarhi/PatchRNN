commit 2578dfb7f767076baf04eaf5fbf35a75afb9a1a7
Author: Laurent Pinchart <laurent.pinchart@ideasonboard.com>
Date:   Thu Apr 7 13:30:14 2011 -0300

    [media] omap3isp: queue: Don't corrupt buf->npages when get_user_pages() fails
    
    get_user_pages() can return a negative error code when it fails. Set
    buf->npages to 0 in that case, to prevent isp_video_buffer_cleanup()
    from releasing invalid pages.
    
    Signed-off-by: Laurent Pinchart <laurent.pinchart@ideasonboard.com>
    Signed-off-by: Mauro Carvalho Chehab <mchehab@redhat.com>

diff --git a/drivers/media/video/omap3isp/ispqueue.c b/drivers/media/video/omap3isp/ispqueue.c
index c91e56a5791e..9c317148205f 100644
--- a/drivers/media/video/omap3isp/ispqueue.c
+++ b/drivers/media/video/omap3isp/ispqueue.c
@@ -339,7 +339,7 @@ static int isp_video_buffer_prepare_user(struct isp_video_buffer *buf)
 	up_read(&current->mm->mmap_sem);
 
 	if (ret != buf->npages) {
-		buf->npages = ret;
+		buf->npages = ret < 0 ? 0 : ret;
 		isp_video_buffer_cleanup(buf);
 		return -EFAULT;
 	}

