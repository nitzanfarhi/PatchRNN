commit 773b9b85b3918dc2e4dbf178c5f2f13ceb428b31
Author: dequis <dx@dxzone.com.ar>
Date:   Sat Aug 29 04:36:42 2015 -0300

    r_lib_close: close all the plugins when freeing, not just the first
    
    This fixes a leak when there's more than one plugin.

diff --git a/libr/util/lib.c b/libr/util/lib.c
index 49f545e40..80a8728c7 100644
--- a/libr/util/lib.c
+++ b/libr/util/lib.c
@@ -163,9 +163,8 @@ R_API RLibHandler *r_lib_get_handler(RLib *lib, int type) {
 
 R_API R_API int r_lib_close(RLib *lib, const char *file) {
 	RLibPlugin *p;
-	RListIter *iter;
-	/* No _safe loop necessary because we return immediately after the delete. */
-	r_list_foreach (lib->plugins, iter, p) {
+	RListIter *iter, *iter_tmp;
+	r_list_foreach_safe (lib->plugins, iter, iter_tmp, p) {
 		if ((file==NULL || (!strcmp (file, p->file)))) {
 			int ret = 0;
 			if (p->handler && p->handler->constructor) {
@@ -174,9 +173,14 @@ R_API R_API int r_lib_close(RLib *lib, const char *file) {
 			}
 			free (p->file);
 			r_list_delete (lib->plugins, iter);
-			return ret;
+			if (file != NULL) {
+				return ret;
+			}
 		}
 	}
+	if (file == NULL) {
+		return 0;
+	}
 	// delete similar plugin name
 	r_list_foreach (lib->plugins, iter, p) {
 		if (strstr (p->file, file)) {

