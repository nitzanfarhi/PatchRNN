commit 7246e160763306d254772353adb8e0836c3eac5b
Author: Hervé Poussineau <hpoussin@reactos.org>
Date:   Mon Jul 9 12:02:23 2012 +0200

    esp: delay Transfer Information command if dma is not enabled
    
    The same mechanism is already in place for some select commands.
    
    Signed-off-by: Hervé Poussineau <hpoussin@reactos.org>
    Signed-off-by: Blue Swirl <blauwirbel@gmail.com>

diff --git a/hw/esp.c b/hw/esp.c
index aff8de6839..ac91f00351 100644
--- a/hw/esp.c
+++ b/hw/esp.c
@@ -435,6 +435,11 @@ static void handle_ti(ESPState *s)
 {
     uint32_t dmalen, minlen;
 
+    if (s->dma && !s->dma_enabled) {
+        s->dma_cb = handle_ti;
+        return;
+    }
+
     dmalen = s->rregs[ESP_TCLO] | (s->rregs[ESP_TCMID] << 8);
     if (dmalen==0) {
       dmalen=0x10000;

