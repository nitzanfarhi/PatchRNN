commit 40b41be3fa6c5bc3b064ffec97096524ac33af4d
Author: Anton Khirnov <anton@khirnov.net>
Date:   Sun Mar 18 17:35:49 2012 +0100

    lavf: use AVStream.discard to disable queueing attached pictures.

diff --git a/libavformat/utils.c b/libavformat/utils.c
index 7fd425f1cc..d17b5752f1 100644
--- a/libavformat/utils.c
+++ b/libavformat/utils.c
@@ -519,7 +519,8 @@ static void queue_attached_pictures(AVFormatContext *s)
 {
     int i;
     for (i = 0; i < s->nb_streams; i++)
-        if (s->streams[i]->disposition & AV_DISPOSITION_ATTACHED_PIC) {
+        if (s->streams[i]->disposition & AV_DISPOSITION_ATTACHED_PIC &&
+            s->streams[i]->discard < AVDISCARD_ALL) {
             AVPacket copy = s->streams[i]->attached_pic;
             copy.destruct = NULL;
             add_to_pktbuf(&s->raw_packet_buffer, &copy, &s->raw_packet_buffer_end);

