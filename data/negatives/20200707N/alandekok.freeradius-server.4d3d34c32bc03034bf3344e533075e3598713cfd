commit 4d3d34c32bc03034bf3344e533075e3598713cfd
Author: Alan T. DeKok <aland@freeradius.org>
Date:   Fri Jul 17 14:45:15 2009 +0200

    Move zombie checks to later so other rules apply, too

diff --git a/src/main/realms.c b/src/main/realms.c
index 4d1be7761..6c6d45eda 100644
--- a/src/main/realms.c
+++ b/src/main/realms.c
@@ -1870,18 +1870,9 @@ home_server *home_server_ldb(const char *realmname,
 		if (!home) continue;
 
 		/*
-		 *	Remember zombies, but skip them.  If there are
-		 *	no live servers, then we will use a zombie one.
+		 *	Skip dead home servers.
 		 */
-		if (home->state == HOME_STATE_ZOMBIE) {
-			zombie = home;
-			continue;
-		}
-
-		/*
-		 *	Skip zombie && dead home servers.
-		 */
-		if (home->state != HOME_STATE_ALIVE) {
+		if (home->state == HOME_STATE_IS_DEAD) {
 			continue;
 		}
 
@@ -1905,6 +1896,16 @@ home_server *home_server_ldb(const char *realmname,
 		}
 #endif
 
+		/*
+		 *	It's zombie, so we remember the first zombie
+		 *	we find, but we don't mark it as a "live"
+		 *	server.
+		 */
+		if (home->state == HOME_STATE_ZOMBIE) {
+			if (!zombie) zombie = home;
+			continue;
+		}
+
 		/*
 		 *	We've found the first "live" one.  Use that.
 		 */

