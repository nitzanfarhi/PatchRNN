commit c5835df9716bdb1af8e25e9a452f717e54e02ed0
Author: Mandeep Singh Baines <msb@google.com>
Date:   Thu Apr 24 20:55:56 2008 -0700

    ethtool: EEPROM dump no longer works for tg3 and natsemi
    
    In the ethtool user-space application, tg3 and natsemi over-ride the
    default implementation of dump_eeprom(). In both tg3_dump_eeprom() and
    natsemi_dump_eeprom(), there is a magic number check which is not
    present in the default implementation.
    
    Commit b131dd5d ("[ETHTOOL]: Add support for large eeproms") snipped
    the code which copied the ethtool_eeprom structure back to
    user-space. tg3 and natsemi are over-writing the magic number field
    and then checking it in user-space. With the ethtool_eeprom copy
    removed, the check is failing.
    
    The fix is simple. Add the ethtool_eeprom copy back.
    
    Signed-off-by: Mandeep Singh Baines <msb@google.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

diff --git a/net/core/ethtool.c b/net/core/ethtool.c
index a29b43d0b450..0133b5ebd545 100644
--- a/net/core/ethtool.c
+++ b/net/core/ethtool.c
@@ -323,6 +323,11 @@ static int ethtool_get_eeprom(struct net_device *dev, void __user *useraddr)
 		bytes_remaining -= eeprom.len;
 	}
 
+	eeprom.len = userbuf - (useraddr + sizeof(eeprom));
+	eeprom.offset -= eeprom.len;
+	if (copy_to_user(useraddr, &eeprom, sizeof(eeprom)))
+		ret = -EFAULT;
+
 	kfree(data);
 	return ret;
 }

