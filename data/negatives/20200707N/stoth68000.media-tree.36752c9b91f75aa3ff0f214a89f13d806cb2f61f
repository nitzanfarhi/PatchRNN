commit 36752c9b91f75aa3ff0f214a89f13d806cb2f61f
Author: Gleb Natapov <gleb@redhat.com>
Date:   Mon May 11 13:35:53 2009 +0300

    KVM: Do not migrate pending software interrupts.
    
    INTn will be re-executed after migration. If we wanted to migrate
    pending software interrupt we would need to migrate interrupt type
    and instruction length too, but we do not have all required info on
    SVM, so SVM->VMX migration would need to re-execute INTn anyway. To
    make it simple never migrate pending soft interrupt.
    
    Signed-off-by: Gleb Natapov <gleb@redhat.com>
    Signed-off-by: Avi Kivity <avi@redhat.com>

diff --git a/arch/x86/kvm/x86.c b/arch/x86/kvm/x86.c
index 199426cc1d0e..beb806b03a2e 100644
--- a/arch/x86/kvm/x86.c
+++ b/arch/x86/kvm/x86.c
@@ -3579,7 +3579,7 @@ int kvm_arch_vcpu_ioctl_get_sregs(struct kvm_vcpu *vcpu,
 
 	memset(sregs->interrupt_bitmap, 0, sizeof sregs->interrupt_bitmap);
 
-	if (vcpu->arch.interrupt.pending)
+	if (vcpu->arch.interrupt.pending && !vcpu->arch.interrupt.soft)
 		set_bit(vcpu->arch.interrupt.nr,
 			(unsigned long *)sregs->interrupt_bitmap);
 

