commit d24d7dbf3cc49b00a152e55e24f0eeb173c7a971
Author: Jovi Zhang <bookjovi@gmail.com>
Date:   Wed Jul 18 18:16:44 2012 +0800

    tracing: Verify target file before registering a uprobe event
    
    Without this patch, we can register a uprobe event for a directory.
    Enabling such a uprobe event would anyway fail.
    
    Example:
    $ echo 'p /bin:0x4245c0' > /sys/kernel/debug/tracing/uprobe_events
    
    However dirctories cannot be valid targets for uprobe.
    Hence verify if the target is a regular file during the probe
    registration.
    
    Link: http://lkml.kernel.org/r/20130103004212.690763002@goodmis.org
    
    Cc: Namhyung Kim <namhyung@kernel.org>
    Signed-off-by: Jovi Zhang <bookjovi@gmail.com>
    Acked-by: Srikar Dronamraju <srikar@linux.vnet.ibm.com>
    [ cleaned up whitespace and removed redundant IS_DIR() check ]
    Signed-off-by: Steven Rostedt <rostedt@goodmis.org>

diff --git a/kernel/trace/trace_uprobe.c b/kernel/trace/trace_uprobe.c
index c86e6d4f67fb..87b6db4ccbc5 100644
--- a/kernel/trace/trace_uprobe.c
+++ b/kernel/trace/trace_uprobe.c
@@ -258,6 +258,10 @@ static int create_trace_uprobe(int argc, char **argv)
 		goto fail_address_parse;
 
 	inode = igrab(path.dentry->d_inode);
+	if (!S_ISREG(inode->i_mode)) {
+		ret = -EINVAL;
+		goto fail_address_parse;
+	}
 
 	argc -= 2;
 	argv += 2;
@@ -356,7 +360,7 @@ static int create_trace_uprobe(int argc, char **argv)
 	if (inode)
 		iput(inode);
 
-	pr_info("Failed to parse address.\n");
+	pr_info("Failed to parse address or file.\n");
 
 	return ret;
 }

