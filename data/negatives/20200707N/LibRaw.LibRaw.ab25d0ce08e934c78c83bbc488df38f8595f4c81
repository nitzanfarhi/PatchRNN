commit ab25d0ce08e934c78c83bbc488df38f8595f4c81
Author: Alex Tutubalin <lexa@lexa.ru>
Date:   Sun Jan 15 14:59:19 2017 +0300

    Sony BL fallback; xtrans copy warning eliminated

diff --git a/dcraw/dcraw.c b/dcraw/dcraw.c
index e0f2b32..0a005d0 100644
--- a/dcraw/dcraw.c
+++ b/dcraw/dcraw.c
@@ -17438,8 +17438,14 @@ void CLASS identify()
     top_margin = filters = 0;
     strcpy(model, "C603");
   }
+#ifndef LIBRAW_LIBRARY_BUILD
   if (!strcmp(make, "Sony") && raw_width > 3888 && !black && !cblack[0])
     black = 128 << (tiff_bps - 12);
+#else
+  /* Always 512 for arw2_load_raw */
+  if (!strcmp(make, "Sony") && raw_width > 3888 && !black && !cblack[0])
+    black = 128 << (load_raw == &LibRaw::sony_arw2_load_raw) ? 4 : (tiff_bps - 12);
+#endif
 
   if (is_foveon)
   {
diff --git a/internal/dcraw_common.cpp b/internal/dcraw_common.cpp
index d915d5b..9125d9c 100644
--- a/internal/dcraw_common.cpp
+++ b/internal/dcraw_common.cpp
@@ -15953,8 +15953,14 @@ void CLASS identify()
     top_margin = filters = 0;
     strcpy(model, "C603");
   }
+#ifndef LIBRAW_LIBRARY_BUILD
   if (!strcmp(make, "Sony") && raw_width > 3888 && !black && !cblack[0])
     black = 128 << (tiff_bps - 12);
+#else
+  /* Always 512 for arw2_load_raw */
+  if (!strcmp(make, "Sony") && raw_width > 3888 && !black && !cblack[0])
+    black = 128 << (load_raw == &LibRaw::sony_arw2_load_raw) ? 4 : (tiff_bps - 12);
+#endif
 
   if (is_foveon)
   {
diff --git a/src/libraw_cxx.cpp b/src/libraw_cxx.cpp
index 1ea1e57..1148960 100644
--- a/src/libraw_cxx.cpp
+++ b/src/libraw_cxx.cpp
@@ -1870,8 +1870,9 @@ int LibRaw::open_datastream(LibRaw_abstract_datastream *stream)
           imgdata.sizes.top_margin = newtm;
           imgdata.sizes.width -= (newlm - imgdata.sizes.left_margin);
           imgdata.sizes.left_margin = newlm;
-          for (int c = 0; c < 36; c++)
-            imgdata.idata.xtrans[0][c] = imgdata.idata.xtrans_abs[0][c];
+          for (int c1 = 0; c1 < 6; c1++)
+            for (int c2 = 0; c2 < 6; c2++)
+              imgdata.idata.xtrans[c1][c2] = imgdata.idata.xtrans_abs[c1][c2];
         }
       }
     }

