commit 04c0635058256e2f4618139c237e56b5a4bdbb8f
Author: Wim Colgate <wim@xensource.com>
Date:   Tue Jun 17 10:47:08 2008 +0200

    xen/blkfront: Make sure that the device is fully ready before allowing release.
    
    [ linux-2.6.18-xen changeset c1c57fea77e9 ]
    
    Signed-off-by: Wim Colgate <wim@xensource.com>
    Signed-off-by: Jeremy Fitzhardinge <jeremy.fitzhardinge@citrix.com>
    Signed-off-by: Jens Axboe <jens.axboe@oracle.com>

diff --git a/drivers/block/xen-blkfront.c b/drivers/block/xen-blkfront.c
index da3fee6bf530..a39b4b2b0c50 100644
--- a/drivers/block/xen-blkfront.c
+++ b/drivers/block/xen-blkfront.c
@@ -997,7 +997,7 @@ static int blkif_release(struct inode *inode, struct file *filep)
 		struct xenbus_device *dev = info->xbdev;
 		enum xenbus_state state = xenbus_read_driver_state(dev->otherend);
 
-		if (state == XenbusStateClosing)
+		if (state == XenbusStateClosing && info->is_ready)
 			blkfront_closing(dev);
 	}
 	return 0;

