commit cca351db187fe92ec839b601a32e77eb63207a8d
Author: Timo Sirainen <tss@iki.fi>
Date:   Mon May 31 19:09:41 2010 +0100

    lib-index: Try to handle index directory deletion more nicely.
    
    --HG--
    branch : HEAD

diff --git a/src/lib-index/mail-transaction-log.c b/src/lib-index/mail-transaction-log.c
index f3a4f3d0d..a878a4f5d 100644
--- a/src/lib-index/mail-transaction-log.c
+++ b/src/lib-index/mail-transaction-log.c
@@ -306,6 +306,13 @@ mail_transaction_log_refresh(struct mail_transaction_log *log, bool nfs_flush)
 							  "stat()");
 			return -1;
 		}
+		/* see if the whole directory got deleted */
+		if (nfs_safe_stat(log->index->dir, &st) < 0 &&
+		    errno == ENOENT) {
+			log->index->index_deleted = TRUE;
+			return -1;
+		}
+
 		/* the file should always exist at this point. if it doesn't,
 		   someone deleted it manually while the index was open. try to
 		   handle this nicely by creating a new log file. */

