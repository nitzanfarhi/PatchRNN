commit 5b0b45ba0b6250d5feb17d6cfccf61eb89f26178
Author: Timo Sirainen <timo.sirainen@dovecot.fi>
Date:   Thu Oct 19 14:39:01 2017 +0300

    lib-storage: Fix assert-crash when searching header and MIMEPART
    
    For now this is just a bit kludgy workaround. The proper fix requires
    larger changes, which aren't worth the effort right now.
    
    For example:
    doveadm fetch -u testuser uid MAILBOX inbox FROM foo MIMEPART FILENAME CONTAINS bar BODY baz
    
    Crashes with:
    Panic: file index-mail-headers.c: line 294 (index_mail_parse_header): assertion failed: (part != NULL)

diff --git a/src/lib-storage/index/index-search.c b/src/lib-storage/index/index-search.c
index 2abcdae8a..36791fb05 100644
--- a/src/lib-storage/index/index-search.c
+++ b/src/lib-storage/index/index-search.c
@@ -769,7 +769,17 @@ static int search_arg_match_text(struct mail_search_arg *args,
 			search_cur_mail_failed(ctx);
 			failed = TRUE;
 		} else {
+			/* FIXME: The header parsing here is an optimization to
+			   avoid parsing the header twice: First when checking
+			   whether the search matches, and secondly when
+			   generating wanted fields. However, if we already
+			   know that we want to generate a BODYSTRUCTURE reply,
+			   index_mail_parse_header() must have a non-NULL part
+			   parameter. That's not easily possible at this point
+			   without larger code changes, so for now we'll just
+			   disable this optimization for that case. */
 			hdr_ctx.parse_headers =
+				!hdr_ctx.imail->data.save_bodystructure_header &&
 				index_mail_want_parse_headers(hdr_ctx.imail);
 			if (hdr_ctx.parse_headers) {
 				index_mail_parse_header_init(hdr_ctx.imail,

