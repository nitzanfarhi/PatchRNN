commit 09fadd948f9011c308be671dac979e0566feafdf
Author: Jerry Jelinek <jerry.jelinek@joyent.com>
Date:   Tue Mar 26 14:54:30 2013 +0000

    4659 grub corrupts stack while installing stage1.5
    Reviewed by: Dan McDonald <danmcd@omniti.com>
    Approved by: Garrett D'Amore <garrett@damore.org>

diff --git a/usr/src/grub/grub-0.97/stage2/builtins.c b/usr/src/grub/grub-0.97/stage2/builtins.c
index 6213dc8d1c..17eb542a1e 100644
--- a/usr/src/grub/grub-0.97/stage2/builtins.c
+++ b/usr/src/grub/grub-0.97/stage2/builtins.c
@@ -4495,15 +4495,15 @@ setup_func (char *arg, int flags)
 	{
 	  char tmp[16];
 	  grub_sprintf (tmp, ",%d", (partition >> 16) & 0xFF);
-	  grub_strncat (device, tmp, 256);
+	  grub_strncat (device, tmp, sizeof (device));
 	}
       if ((partition & 0x00FF00) != 0x00FF00)
 	{
 	  char tmp[16];
 	  grub_sprintf (tmp, ",%c", 'a' + ((partition >> 8) & 0xFF));
-	  grub_strncat (device, tmp, 256);
+	  grub_strncat (device, tmp, sizeof (device));
 	}
-      grub_strncat (device, ")", 256);
+      grub_strncat (device, ")", sizeof (device));
     }
   
   int embed_stage1_5 (char *stage1_5, int drive, int partition)
diff --git a/usr/src/grub/grub-0.97/stage2/char_io.c b/usr/src/grub/grub-0.97/stage2/char_io.c
index f29164712e..7146377cd0 100644
--- a/usr/src/grub/grub-0.97/stage2/char_io.c
+++ b/usr/src/grub/grub-0.97/stage2/char_io.c
@@ -1062,10 +1062,10 @@ grub_strncat (char *s1, const char *s2, int n)
 
   while (i < n && (s1[i++] = *(s2++)) != 0);
 
-  s1[n - 1] = 0;
-
-  if (i >= n)
+  if (i >= n) {
+    s1[n - 1] = 0;
     return 0;
+  }
 
   s1[i] = 0;
 

