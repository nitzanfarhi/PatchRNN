commit 5b75a6af11357813a7eeb4a29d0261adbbfab556
Author: Will Deacon <will.deacon@arm.com>
Date:   Fri Aug 22 14:25:21 2014 +0100

    arm64: perf: don't rely on layout of pt_regs when grabbing sp or pc
    
    The current perf_regs code relies on sp and pc sitting just off the end
    of the pt_regs->regs array. This is ugly and fragile, so this patch
    checks for these register explicitly and returns the appropriate field.
    
    Acked-by: Jean Pihet <jean.pihet@linaro.org>
    Signed-off-by: Will Deacon <will.deacon@arm.com>

diff --git a/arch/arm64/kernel/perf_regs.c b/arch/arm64/kernel/perf_regs.c
index 422ebd63b619..6762ad705587 100644
--- a/arch/arm64/kernel/perf_regs.c
+++ b/arch/arm64/kernel/perf_regs.c
@@ -24,6 +24,12 @@ u64 perf_reg_value(struct pt_regs *regs, int idx)
 			return regs->compat_lr;
 	}
 
+	if ((u32)idx == PERF_REG_ARM64_SP)
+		return regs->sp;
+
+	if ((u32)idx == PERF_REG_ARM64_PC)
+		return regs->pc;
+
 	return regs->regs[idx];
 }
 

