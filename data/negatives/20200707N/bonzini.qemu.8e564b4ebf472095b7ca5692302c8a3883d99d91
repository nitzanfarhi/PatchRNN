commit 8e564b4ebf472095b7ca5692302c8a3883d99d91
Author: Jan Kiszka <jan.kiszka@siemens.com>
Date:   Fri Feb 17 18:31:15 2012 +0100

    Process pending work while waiting for initial kick-off in TCG mode
    
    When the TCG thread is started but not yet the machine, we wait in
    qemu_tcg_cpu_thread_fn on tcg_halt_cond. To allow run_on_cpu already at
    this time, we need to process pending request in that loop.
    
    CC: Paolo Bonzini <pbonzini@redhat.com>
    Signed-off-by: Jan Kiszka <jan.kiszka@siemens.com>
    Signed-off-by: Avi Kivity <avi@redhat.com>

diff --git a/cpus.c b/cpus.c
index 4e6589457e..4a10775cb6 100644
--- a/cpus.c
+++ b/cpus.c
@@ -761,6 +761,11 @@ static void *qemu_tcg_cpu_thread_fn(void *arg)
     /* wait for initial kick-off after machine start */
     while (first_cpu->stopped) {
         qemu_cond_wait(tcg_halt_cond, &qemu_global_mutex);
+
+        /* process any pending work */
+        for (env = first_cpu; env != NULL; env = env->next_cpu) {
+            qemu_wait_io_event_common(env);
+        }
     }
 
     while (1) {

