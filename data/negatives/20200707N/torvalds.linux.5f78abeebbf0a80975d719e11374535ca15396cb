commit 5f78abeebbf0a80975d719e11374535ca15396cb
Author: Steven Rostedt <srostedt@redhat.com>
Date:   Wed Jun 17 14:11:10 2009 -0400

    ring-buffer: check for less than two in size allocation
    
    The ring buffer must have at least two pages allocated for the
    reader page swap to work.
    
    The page count check will miss the case of a zero size passed in.
    Even though a zero size ring buffer would probably fail an allocation,
    making the min size check for less than two instead of equal to one makes
    the code a bit more robust.
    
    Signed-off-by: Steven Rostedt <rostedt@goodmis.org>

diff --git a/kernel/trace/ring_buffer.c b/kernel/trace/ring_buffer.c
index 162da2305cbc..2e99dba6dc48 100644
--- a/kernel/trace/ring_buffer.c
+++ b/kernel/trace/ring_buffer.c
@@ -657,8 +657,8 @@ struct ring_buffer *__ring_buffer_alloc(unsigned long size, unsigned flags,
 	buffer->reader_lock_key = key;
 
 	/* need at least two pages */
-	if (buffer->pages == 1)
-		buffer->pages++;
+	if (buffer->pages < 2)
+		buffer->pages = 2;
 
 	/*
 	 * In case of non-hotplug cpu, if the ring-buffer is allocated

