commit 3ebd6fab526ea5a22c023597dae25579fa1dfd5d
Author: Angus Salkeld <asalkeld@redhat.com>
Date:   Fri May 14 02:03:49 2010 +0000

    cov 10379 &10380: check result of open before calling ftruncate.
    
    
    git-svn-id: http://svn.fedorahosted.org/svn/corosync/trunk@2823 fd59a12c-fef9-0310-b244-a6a79926bd2f

diff --git a/exec/coroipcs.c b/exec/coroipcs.c
index 9394f21c..9d81b7e5 100644
--- a/exec/coroipcs.c
+++ b/exec/coroipcs.c
@@ -263,8 +263,9 @@ memory_map (
 
 	unlink (path);
 
-	res = ftruncate (fd, bytes);
-
+	if (fd >= 0) {
+		res = ftruncate (fd, bytes);
+	}
 	addr_orig = mmap (NULL, bytes, PROT_NONE,
 		MAP_ANONYMOUS | MAP_PRIVATE, -1, 0);
 
@@ -305,8 +306,9 @@ circular_memory_map (
 
 	unlink (path);
 
-	res = ftruncate (fd, bytes);
-
+	if (fd >= 0) {
+		res = ftruncate (fd, bytes);
+	}
 	addr_orig = mmap (NULL, bytes << 1, PROT_NONE,
 		MAP_ANONYMOUS | MAP_PRIVATE, -1, 0);
 

