commit c4a9aa1f8c40ba37834d711259662c5fa92758ea
Author: Alex RÃ¸nne Petersen <alexrp@xamarin.com>
Date:   Fri Oct 25 18:20:44 2013 +0200

    Add LLDB support to mono_gdb_render_native_backtraces () on POSIX.

diff --git a/mono/mini/mini-posix.c b/mono/mini/mini-posix.c
index d3e5c907294..8b77cd47ff4 100644
--- a/mono/mini/mini-posix.c
+++ b/mono/mini/mini-posix.c
@@ -672,24 +672,54 @@ void
 mono_gdb_render_native_backtraces (pid_t crashed_pid)
 {
 	const char *argv [9];
+	char template [] = "/tmp/mono-lldb-commands.XXXXXX";
 	char buf1 [128];
+	FILE *commands;
+	gboolean using_lldb = FALSE;
 
 	argv [0] = g_find_program_in_path ("gdb");
 	if (argv [0] == NULL) {
-		return;
+		argv [0] = g_find_program_in_path ("lldb");
+		using_lldb = TRUE;
 	}
 
-	argv [1] = "-ex";
-	sprintf (buf1, "attach %ld", (long) crashed_pid);
-	argv [2] = buf1;
-	argv [3] = "--ex";
-	argv [4] = "info threads";
-	argv [5] = "--ex";
-	argv [6] = "thread apply all bt";
-	argv [7] = "--batch";
-	argv [8] = 0;
+	if (argv [0] == NULL)
+		return;
+
+	if (using_lldb) {
+		if (mkstemp (template) == -1)
+			return;
+
+		commands = fopen (template, "w");
+
+		fprintf (commands, "process attach --pid %ld\n", (long) crashed_pid);
+		fprintf (commands, "script lldb.debugger.HandleCommand (\"thread list\")\n");
+		fprintf (commands, "script lldb.debugger.HandleCommand (\"thread backtrace all\")\n");
+		fprintf (commands, "detach\n");
+		fprintf (commands, "quit\n");
+
+		fflush (commands);
+		fclose (commands);
+
+		argv [1] = "--source";
+		argv [2] = template;
+		argv [3] = 0;
+	} else {
+		argv [1] = "-ex";
+		sprintf (buf1, "attach %ld", (long) crashed_pid);
+		argv [2] = buf1;
+		argv [3] = "--ex";
+		argv [4] = "info threads";
+		argv [5] = "--ex";
+		argv [6] = "thread apply all bt";
+		argv [7] = "--batch";
+		argv [8] = 0;
+	}
 
 	execv (argv [0], (char**)argv);
+
+	if (using_lldb)
+		unlink (template);
 }
 #endif
 #endif /* __native_client__ */

