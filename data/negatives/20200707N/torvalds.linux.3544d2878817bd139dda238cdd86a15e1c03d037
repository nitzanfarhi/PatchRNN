commit 3544d2878817bd139dda238cdd86a15e1c03d037
Author: Muhammad Hamza Farooq <mfarooq@visteon.com>
Date:   Thu Jun 30 17:15:15 2016 +0200

    dmaengine: rcar-dmac: use result of updated get_residue in tx_status
    
    The hardware might have complete the transfer but the interrupt handler
    might not have had a chance to run. If rcar_dmac_chan_get_residue()
    which reads HW registers finds that there is no residue return
    DMA_COMPLETE.
    
    Signed-off-by: Muhammad Hamza Farooq <mfarooq@visteon.com>
    Signed-off-by: Geert Uytterhoeven <geert+renesas@glider.be>
    [Niklas: add explanation in commit message]
    Signed-off-by: Niklas SÃ¶derlund <niklas.soderlund+renesas@ragnatech.se>
    Acked-by: Laurent Pinchart <laurent.pinchart@ideasonboard.com>
    Signed-off-by: Vinod Koul <vinod.koul@intel.com>

diff --git a/drivers/dma/sh/rcar-dmac.c b/drivers/dma/sh/rcar-dmac.c
index 433e98260414..74c9563222bc 100644
--- a/drivers/dma/sh/rcar-dmac.c
+++ b/drivers/dma/sh/rcar-dmac.c
@@ -1202,6 +1202,10 @@ static enum dma_status rcar_dmac_tx_status(struct dma_chan *chan,
 	residue = rcar_dmac_chan_get_residue(rchan, cookie);
 	spin_unlock_irqrestore(&rchan->lock, flags);
 
+	/* if there's no residue, the cookie is complete */
+	if (!residue)
+		return DMA_COMPLETE;
+
 	dma_set_residue(txstate, residue);
 
 	return status;

