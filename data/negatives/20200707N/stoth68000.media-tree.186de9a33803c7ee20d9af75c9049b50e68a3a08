commit 186de9a33803c7ee20d9af75c9049b50e68a3a08
Author: Gustavo F. Padovan <gustavo@las.ic.unicamp.br>
Date:   Tue Dec 15 15:56:34 2009 -0200

    Bluetooth: Fix unset of RemoteBusy flag for L2CAP
    
    RemoteBusy flag need to be unset before l2cap_ertm_send(), otherwise
    l2cap_ertm_send() will return without sending packets because it checks
    that flag before start sending.
    
    Signed-off-by: Gustavo F. Padovan <gustavo@las.ic.unicamp.br>
    Signed-off-by: Marcel Holtmann <marcel@holtmann.org>

diff --git a/net/bluetooth/l2cap.c b/net/bluetooth/l2cap.c
index 5129b88c8e5b..7db9a1f8f882 100644
--- a/net/bluetooth/l2cap.c
+++ b/net/bluetooth/l2cap.c
@@ -3435,8 +3435,8 @@ static inline int l2cap_data_channel_sframe(struct sock *sk, u16 rx_control, str
 			    (pi->unacked_frames > 0))
 				__mod_retrans_timer();
 
-			l2cap_ertm_send(sk);
 			pi->conn_state &= ~L2CAP_CONN_REMOTE_BUSY;
+			l2cap_ertm_send(sk);
 		}
 		break;
 

