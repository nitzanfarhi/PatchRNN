commit e7291a6d1a807d1391ebf2c4c259681fec149adb
Author: Lai Siyao <lai.siyao@intel.com>
Date:   Thu Oct 27 18:11:43 2016 -0400

    staging: lustre: dne: setdirstripe should fail if not supported
    
    If MDS doesn't support striped directory, creating striped directory
    from a userland utility such as 'lfs setdirstripe' should fail.
    
    Signed-off-by: Lai Siyao <lai.siyao@intel.com>
    Intel-bug-id: https://jira.hpdd.intel.com/browse/LU-6661
    Reviewed-on: http://review.whamcloud.com/15123
    Reviewed-by: James Simmons <uja.ornl@yahoo.com>
    Reviewed-by: Andreas Dilger <andreas.dilger@intel.com>
    Reviewed-by: Oleg Drokin <oleg.drokin@intel.com>
    Signed-off-by: James Simmons <jsimmons@infradead.org>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

diff --git a/drivers/staging/lustre/lustre/llite/dir.c b/drivers/staging/lustre/lustre/llite/dir.c
index 929c32c6bb10..6e744a5e9f0d 100644
--- a/drivers/staging/lustre/lustre/llite/dir.c
+++ b/drivers/staging/lustre/lustre/llite/dir.c
@@ -419,6 +419,10 @@ static int ll_dir_setdirstripe(struct inode *parent, struct lmv_user_md *lump,
 	       PFID(ll_inode2fid(parent)), parent, dirname,
 	       (int)lump->lum_stripe_offset, lump->lum_stripe_count);
 
+	if (lump->lum_stripe_count > 1 &&
+	    !(exp_connect_flags(sbi->ll_md_exp) & OBD_CONNECT_DIR_STRIPE))
+		return -EINVAL;
+
 	if (lump->lum_magic != cpu_to_le32(LMV_USER_MAGIC))
 		lustre_swab_lmv_user_md(lump);
 

