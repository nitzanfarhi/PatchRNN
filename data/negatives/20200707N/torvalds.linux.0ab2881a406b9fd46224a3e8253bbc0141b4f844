commit 0ab2881a406b9fd46224a3e8253bbc0141b4f844
Author: Mathias Nyman <mathias.nyman@linux.intel.com>
Date:   Tue Mar 28 15:55:29 2017 +0300

    xhci: Set URB actual length for stopped control transfers
    
    A control transfer that stopped at the status stage incorrectly
    warned about a "unexpected TRB Type 4", and did not set the
    transferred actual_length for the URB.
    
    The URB actual_length for control transfers should contain the
    bytes transferred in the data stage.
    
    Bytes of a partially sent setup stage and missing bytes from
    status stage should be left out.
    
    Cc: <stable@vger.kernel.org>
    Signed-off-by: Mathias Nyman <mathias.nyman@linux.intel.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

diff --git a/drivers/usb/host/xhci-ring.c b/drivers/usb/host/xhci-ring.c
index d9936c771fa0..a3309aa02993 100644
--- a/drivers/usb/host/xhci-ring.c
+++ b/drivers/usb/host/xhci-ring.c
@@ -1989,6 +1989,9 @@ static int process_ctrl_td(struct xhci_hcd *xhci, struct xhci_td *td,
 		case TRB_NORMAL:
 			td->urb->actual_length = requested - remaining;
 			goto finish_td;
+		case TRB_STATUS:
+			td->urb->actual_length = requested;
+			goto finish_td;
 		default:
 			xhci_warn(xhci, "WARN: unexpected TRB Type %d\n",
 				  trb_type);

