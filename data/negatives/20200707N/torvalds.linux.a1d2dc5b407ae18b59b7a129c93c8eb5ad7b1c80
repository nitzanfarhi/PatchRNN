commit a1d2dc5b407ae18b59b7a129c93c8eb5ad7b1c80
Author: Mark A. Greer <mgreer@animalcreek.com>
Date:   Tue Mar 25 08:54:37 2014 -0700

    NFC: trf7970a: Turn RF on after hardware is configured
    
    The NFC digital layer calls the 'switch_rf' hook to turn the RF on before
    it configures the RF technology and framing. There is potential to confuse
    a tag doing it this way so don't enable the RF until the RF technology and
    initial framing have been configured.
    
    Signed-off-by: Mark A. Greer <mgreer@animalcreek.com>
    Signed-off-by: Samuel Ortiz <sameo@linux.intel.com>

diff --git a/drivers/nfc/trf7970a.c b/drivers/nfc/trf7970a.c
index 203d86fb1d54..0a46348f9af6 100644
--- a/drivers/nfc/trf7970a.c
+++ b/drivers/nfc/trf7970a.c
@@ -779,11 +779,6 @@ static int trf7970a_init(struct trf7970a *trf)
 
 	trf->special_fcn_reg1 = 0;
 
-	ret = trf7970a_write(trf, TRF7970A_CHIP_STATUS_CTRL,
-			trf->chip_status_ctrl | TRF7970A_CHIP_STATUS_RF_ON);
-	if (ret)
-		goto err_out;
-
 	trf->iso_ctrl = 0xff;
 	return 0;
 
@@ -796,6 +791,10 @@ static void trf7970a_switch_rf_off(struct trf7970a *trf)
 {
 	dev_dbg(trf->dev, "Switching rf off\n");
 
+	trf->chip_status_ctrl &= ~TRF7970A_CHIP_STATUS_RF_ON;
+
+	trf7970a_write(trf, TRF7970A_CHIP_STATUS_CTRL, trf->chip_status_ctrl);
+
 	gpio_set_value(trf->en_gpio, 0);
 	gpio_set_value(trf->en2_gpio, 0);
 
@@ -948,6 +947,18 @@ static int trf7970a_config_framing(struct trf7970a *trf, int framing)
 			return ret;
 	}
 
+	if (!(trf->chip_status_ctrl & TRF7970A_CHIP_STATUS_RF_ON)) {
+		ret = trf7970a_write(trf, TRF7970A_CHIP_STATUS_CTRL,
+				trf->chip_status_ctrl |
+					TRF7970A_CHIP_STATUS_RF_ON);
+		if (ret)
+			return ret;
+
+		trf->chip_status_ctrl |= TRF7970A_CHIP_STATUS_RF_ON;
+
+		usleep_range(5000, 6000);
+	}
+
 	return 0;
 }
 

