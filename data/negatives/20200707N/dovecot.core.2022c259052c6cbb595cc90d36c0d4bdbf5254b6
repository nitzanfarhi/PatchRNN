commit 2022c259052c6cbb595cc90d36c0d4bdbf5254b6
Author: Timo Sirainen <tss@iki.fi>
Date:   Wed Aug 1 20:24:00 2012 +0300

    fts: Fixed crash in fts_lookup_multi() for backends that can't handle it (fts-squat)

diff --git a/src/plugins/fts/fts-api.c b/src/plugins/fts/fts-api.c
index 24031a698..079b2f938 100644
--- a/src/plugins/fts/fts-api.c
+++ b/src/plugins/fts/fts-api.c
@@ -318,9 +318,24 @@ int fts_backend_lookup_multi(struct fts_backend *backend,
 			     struct mail_search_arg *args, bool and_args,
 			     struct fts_multi_result *result)
 {
+	unsigned int i;
+
 	i_assert(boxes[0] != NULL);
 
-	return backend->v.lookup_multi(backend, boxes, args, and_args, result);
+	if (backend->v.lookup_multi != NULL) {
+		return backend->v.lookup_multi(backend, boxes, args,
+					       and_args, result);
+	}
+
+	for (i = 0; boxes[i] != NULL; i++) ;
+	result->box_results = p_new(result->pool, struct fts_result, i+1);
+
+	for (i = 0; boxes[i] != NULL; i++) {
+		if (backend->v.lookup(backend, boxes[i], args,
+				      and_args, &result->box_results[i]) < 0)
+			return -1;
+	}
+	return 0;
 }
 
 void fts_backend_lookup_done(struct fts_backend *backend)

