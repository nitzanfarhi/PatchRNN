commit aaa1a022756fd01a6f38d7ce3818c6f1db822885
Author: Yehuda Sadeh <yehuda@hq.newdream.net>
Date:   Wed Jul 13 14:08:38 2011 -0700

    rgw: clean up temp object if failed to PUT
    
    Conflicts:
    
            src/rgw/rgw_op.cc

diff --git a/src/rgw/rgw_op.cc b/src/rgw/rgw_op.cc
index d45e28a51b..9b98c6efa9 100644
--- a/src/rgw/rgw_op.cc
+++ b/src/rgw/rgw_op.cc
@@ -520,6 +520,7 @@ void RGWPutObj::execute()
   list<struct put_obj_aio_info> pending;
   size_t max_chunks = RGW_MAX_PENDING_CHUNKS;
   bool created_obj = false;
+  rgw_obj obj;
 
   ret = -EINVAL;
   if (!s->object) {
@@ -559,7 +560,6 @@ void RGWPutObj::execute()
     MD5 hash;
     string oid;
     multipart = s->args.exists("uploadId");
-    rgw_obj obj;
     if (!multipart) {
       oid = s->object_str;
       obj.set_ns(tmp_ns);
@@ -596,7 +596,7 @@ void RGWPutObj::execute()
 				     data,
 				     ((ofs == 0) ? -1 : ofs), len, &handle);
         if (ret < 0)
-          goto done;
+          goto done_err;
 
         created_obj = true;
 
@@ -608,7 +608,7 @@ void RGWPutObj::execute()
         while (pending_has_completed(pending)) {
           ret = wait_pending_front(pending);
           if (ret < 0)
-            goto done;
+            goto done_err;
 
         }
 
@@ -619,7 +619,7 @@ void RGWPutObj::execute()
         if (pending.size() > max_chunks) {
           ret = wait_pending_front(pending);
           if (ret < 0)
-            goto done;
+            goto done_err;
         }
         ofs += len;
       }
@@ -634,7 +634,7 @@ void RGWPutObj::execute()
 
     if (supplied_md5_b64 && strcmp(calc_md5, supplied_md5)) {
        ret = -ERR_BAD_DIGEST;
-       goto done;
+       goto done_err;
     }
     bufferlist aclbl;
     policy.encode(aclbl);
@@ -658,7 +658,7 @@ void RGWPutObj::execute()
       rgw_obj dst_obj(s->bucket_str, s->object_str);
       ret = rgwstore->clone_obj(dst_obj, 0, obj, 0, s->obj_size, attrs);
       if (ret < 0)
-        goto done;
+        goto done_err;
       if (created_obj) {
         ret = rgwstore->delete_obj(s->user.user_id, obj);
         if (ret < 0)
@@ -667,7 +667,7 @@ void RGWPutObj::execute()
     } else {
       ret = rgwstore->put_obj_meta(s->user.user_id, obj, NULL, attrs, false);
       if (ret < 0)
-        goto done;
+        goto done_err;
 
       bl.clear();
       map<string, bufferlist> meta_attrs;
@@ -689,6 +689,13 @@ void RGWPutObj::execute()
 done:
   drain_pending(pending);
   send_response();
+  return;
+
+done_err:
+  if (created_obj)
+    rgwstore->delete_obj(s->user.user_id, obj);
+  drain_pending(pending);
+  send_response();
 }
 
 int RGWDeleteObj::verify_permission()

