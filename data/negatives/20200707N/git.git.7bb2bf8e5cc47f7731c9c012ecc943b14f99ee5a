commit 7bb2bf8e5cc47f7731c9c012ecc943b14f99ee5a
Author: Michael Haggerty <mhagger@alum.mit.edu>
Date:   Thu Sep 15 23:10:31 2011 +0200

    resolve_ref(): explicitly fail if a symlink is not readable
    
    Previously the failure came later, after a few steps in which the
    length was treated like the actual length of a string.  Even though
    the old code gave the same answers, it was somewhat misleading.
    
    Signed-off-by: Michael Haggerty <mhagger@alum.mit.edu>
    Signed-off-by: Junio C Hamano <gitster@pobox.com>

diff --git a/refs.c b/refs.c
index d2aac24a3..c51fd45f9 100644
--- a/refs.c
+++ b/refs.c
@@ -518,6 +518,8 @@ const char *resolve_ref(const char *ref, unsigned char *sha1, int reading, int *
 		/* Follow "normalized" - ie "refs/.." symlinks by hand */
 		if (S_ISLNK(st.st_mode)) {
 			len = readlink(path, buffer, sizeof(buffer)-1);
+			if (len < 0)
+				return NULL;
 			if (len >= 5 && !memcmp("refs/", buffer, 5)) {
 				buffer[len] = 0;
 				strcpy(ref_buffer, buffer);

