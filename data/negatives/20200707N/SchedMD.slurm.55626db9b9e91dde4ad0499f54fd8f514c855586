commit 55626db9b9e91dde4ad0499f54fd8f514c855586
Author: Morris Jette <jette@schedmd.com>
Date:   Tue Oct 7 14:15:30 2014 -0700

    Fix for poe with --hint=nomultithread
    
    This is a minor change to commit 4b8cdd4c1c835b3127bd5f7041f18f4cf52242cf
    from yesterday and is needed to work with launch/poe (which was
    broken by the commit).

diff --git a/src/srun/libsrun/opt.c b/src/srun/libsrun/opt.c
index 76f58b0c20..8c93b76ea0 100644
--- a/src/srun/libsrun/opt.c
+++ b/src/srun/libsrun/opt.c
@@ -1648,10 +1648,11 @@ static void _set_options(const int argc, char **argv)
 		}
 	}
 
-	/* This means it was read from the environment.  We will
-	 * override it with what the user specified in the hostlist.
-	 */
-	if (!ntasks_set_opt && (opt.distribution == SLURM_DIST_ARBITRARY))
+	/* This means --ntasks was read from the environment.  We will override
+	 * it with what the user specified in the hostlist. POE launched
+	 * jobs excluded (they have the SLURM_STARTED_STEP env var set). */
+	if (!ntasks_set_opt && (opt.distribution == SLURM_DIST_ARBITRARY) &&
+	    !getenv("SLURM_STARTED_STEP"))
 		opt.ntasks_set = false;
 
 	spank_option_table_destroy (optz);

