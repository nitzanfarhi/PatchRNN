commit 8628c589f69aea164ec1865f52eb0f5bc5154ed8
Author: Sergei Petrunia <psergey@askmonty.org>
Date:   Mon Apr 9 15:27:35 2018 +0300

    Fix ha_rocksdb::calc_eq_cond_len() to handle HA_READ_PREFIX_LAST_OR_PREV correctly

diff --git a/storage/rocksdb/ha_rocksdb.cc b/storage/rocksdb/ha_rocksdb.cc
index 5f19faca6cb..9d3d07e72f0 100644
--- a/storage/rocksdb/ha_rocksdb.cc
+++ b/storage/rocksdb/ha_rocksdb.cc
@@ -7464,6 +7464,13 @@ int ha_rocksdb::calc_eq_cond_len(const Rdb_key_def &kd,
     */
     return slice.size() - bytes_changed_by_succ;
   }
+  if (find_flag == HA_READ_PREFIX_LAST_OR_PREV) {
+    /*
+      We are interested in records with or without the specified prefix, so
+      the only limit is that records are from this index
+    */
+    return Rdb_key_def::INDEX_NUMBER_SIZE;
+  }
 
   if (end_key) {
     *end_key_packed_size =

