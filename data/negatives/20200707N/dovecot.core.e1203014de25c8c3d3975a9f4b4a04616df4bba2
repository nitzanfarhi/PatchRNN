commit e1203014de25c8c3d3975a9f4b4a04616df4bba2
Author: Timo Sirainen <tss@iki.fi>
Date:   Sun Nov 16 14:43:14 2008 +0200

    IMAP ACLs: Let MYRIGHTS show the rights even if we don't have "r" permission.
    
    --HG--
    branch : HEAD

diff --git a/src/plugins/imap-acl/imap-acl-plugin.c b/src/plugins/imap-acl/imap-acl-plugin.c
index ddb32724f..101b16abf 100644
--- a/src/plugins/imap-acl/imap-acl-plugin.c
+++ b/src/plugins/imap-acl/imap-acl-plugin.c
@@ -74,10 +74,10 @@ acl_mailbox_open_as_admin(struct client_command_context *cmd, const char *name)
 	/* not an administrator. */
 	if (acl_mailbox_right_lookup(box, ACL_STORAGE_RIGHT_LOOKUP) <= 0) {
 		client_send_tagline(cmd, t_strdup_printf(
-			"["IMAP_RESP_CODE_NONEXISTENT"] "
+			"NO ["IMAP_RESP_CODE_NONEXISTENT"] "
 			MAIL_ERRSTR_MAILBOX_NOT_FOUND, name));
 	} else {
-		client_send_tagline(cmd, ERROR_NOT_ADMIN);
+		client_send_tagline(cmd, "NO "ERROR_NOT_ADMIN);
 	}
 	mailbox_close(&box);
 	return NULL;
@@ -231,7 +231,8 @@ static bool cmd_myrights(struct client_command_context *cmd)
 	if (storage == NULL)
 		return TRUE;
 
-	box = mailbox_open(storage, real_mailbox, NULL, ACL_MAILBOX_OPEN_FLAGS);
+	box = mailbox_open(storage, real_mailbox, NULL, ACL_MAILBOX_OPEN_FLAGS |
+			   MAIL_STORAGE_FLAG_IGNORE_ACLS);
 	if (box == NULL) {
 		client_send_storage_error(cmd, storage);
 		return TRUE;
@@ -243,6 +244,13 @@ static bool cmd_myrights(struct client_command_context *cmd)
 		mailbox_close(&box);
 		return TRUE;
 	}
+	if (*rights == NULL) {
+		client_send_tagline(cmd, t_strdup_printf(
+			"NO ["IMAP_RESP_CODE_NONEXISTENT"] "
+			MAIL_ERRSTR_MAILBOX_NOT_FOUND, real_mailbox));
+		mailbox_close(&box);
+		return TRUE;
+	}
 
 	str = t_str_new(128);
 	str_append(str, "* MYRIGHTS ");

