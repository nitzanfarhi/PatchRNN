commit f4028119714e452f9b49377ec55e0ed1e5d1dfa4
Author: Amit Shah <amit.shah@redhat.com>
Date:   Thu Sep 2 18:11:46 2010 +0530

    virtio: console: Make write() return -ENODEV on hot-unplug
    
    When a port is hot-unplugged while an app was blocked on a write() call,
    the call was unblocked but would not get an error returned.
    
    Return -ENODEV to ensure the app knows the port has gone away.
    
    Signed-off-by: Amit Shah <amit.shah@redhat.com>
    Signed-off-by: Rusty Russell <rusty@rustcorp.com.au>

diff --git a/drivers/char/virtio_console.c b/drivers/char/virtio_console.c
index e17ecf5d42b5..70f1c38fa14c 100644
--- a/drivers/char/virtio_console.c
+++ b/drivers/char/virtio_console.c
@@ -626,6 +626,9 @@ static ssize_t port_fops_write(struct file *filp, const char __user *ubuf,
 		if (ret < 0)
 			return ret;
 	}
+	/* Port got hot-unplugged. */
+	if (!port->guest_connected)
+		return -ENODEV;
 
 	count = min((size_t)(32 * 1024), count);
 

