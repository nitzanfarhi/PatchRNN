commit 3566ac4c305fab55e0489dc0a725b095c3ca22b7
Author: Timo Sirainen <tss@iki.fi>
Date:   Tue May 25 15:23:32 2010 +0100

    maildir: Expunging last messages may have assert-crashed if their filenames had changed.
    
    --HG--
    branch : HEAD

diff --git a/src/lib-storage/index/maildir/maildir-sync-index.c b/src/lib-storage/index/maildir/maildir-sync-index.c
index 5424a4ef9..1e5f440f5 100644
--- a/src/lib-storage/index/maildir/maildir-sync-index.c
+++ b/src/lib-storage/index/maildir/maildir-sync-index.c
@@ -601,7 +601,6 @@ int maildir_sync_index(struct maildir_index_sync_context *ctx,
 		maildir_sync_mail_keywords(ctx, seq);
 	}
 	maildir_uidlist_iter_deinit(&iter);
-	mbox->syncing_commit = FALSE;
 
 	if (!partial) {
 		/* expunge the rest */
@@ -664,6 +663,7 @@ int maildir_sync_index(struct maildir_index_sync_context *ctx,
 	}
 	array_free(&ctx->keywords);
 	array_free(&ctx->idx_keywords);
+	mbox->syncing_commit = FALSE;
 	return ret < 0 ? -1 : (full_rescan ? 0 : 1);
 }
 

