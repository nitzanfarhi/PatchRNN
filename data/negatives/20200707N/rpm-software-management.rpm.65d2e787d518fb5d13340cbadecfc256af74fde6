commit 65d2e787d518fb5d13340cbadecfc256af74fde6
Author: Panu Matilainen <pmatilai@redhat.com>
Date:   Tue Feb 12 05:11:16 2013 +0200

    Failure to calculate digest in rpmDoDigest() is, well, a failure
    
    - This is mostly a cant-happen situation but technically it can
      fail, lets not segfault if it does (RhBug:909618)

diff --git a/rpmio/rpmfileutil.c b/rpmio/rpmfileutil.c
index 6cdfe2552..b116146fa 100644
--- a/rpmio/rpmfileutil.c
+++ b/rpmio/rpmfileutil.c
@@ -174,7 +174,7 @@ int rpmDoDigest(int algo, const char * fn,int asAscii,
 	while ((rc = Fread(buf, sizeof(buf[0]), sizeof(buf), fd)) > 0)
 	    fsize += rc;
 	fdFiniDigest(fd, algo, (void **)&dig, &diglen, asAscii);
-	if (Ferror(fd))
+	if (dig == NULL || Ferror(fd))
 	    rc = 1;
 
 	(void) Fclose(fd);

