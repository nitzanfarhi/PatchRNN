commit cfbe7e4f5e4a0e1fc2ff23b167bfb3fa992f623d
Author: Shen Feng <shen@cn.fujitsu.com>
Date:   Sun Jul 13 21:03:31 2008 -0400

    ext4: error proc entry creation when the fs/ext4 is not correctly created
    
    When the directory fs/ext4 is not correctly created under proc, the entry
    under this directory should not be created.
    
    Signed-off-by: Shen Feng <shen@cn.fujitsu.com>
    Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
    Signed-off-by: Theodore Ts'o <tytso@mit.edu>

diff --git a/fs/ext4/mballoc.c b/fs/ext4/mballoc.c
index 21ee6d42ee7b..771a1d608528 100644
--- a/fs/ext4/mballoc.c
+++ b/fs/ext4/mballoc.c
@@ -2661,6 +2661,10 @@ static int ext4_mb_init_per_dev_proc(struct super_block *sb)
 	struct proc_dir_entry *proc;
 	char devname[64];
 
+	if (proc_root_ext4 == NULL) {
+		sbi->s_mb_proc = NULL;
+		return -EINVAL;
+	}
 	bdevname(sb->s_bdev, devname);
 	sbi->s_mb_proc = proc_mkdir(devname, proc_root_ext4);
 

