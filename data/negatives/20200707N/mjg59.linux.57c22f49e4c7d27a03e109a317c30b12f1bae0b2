commit 57c22f49e4c7d27a03e109a317c30b12f1bae0b2
Author: Andi Kleen <ak@suse.de>
Date:   Sun Jul 22 11:12:39 2007 +0200

    i386: Handle P6s without performance counters in nmi watchdog
    
    I got an oops while booting a 32bit kernel on KVM because it doesn't
    implement performance counters used by the NMI watchdog. Handle this
    case.
    
    Cc: Avi Kivity <avi@qumranet.com>
    Signed-off-by: Andi Kleen <ak@suse.de>
    Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>

diff --git a/arch/i386/kernel/cpu/perfctr-watchdog.c b/arch/i386/kernel/cpu/perfctr-watchdog.c
index 30b5e48aa76b..572900398def 100644
--- a/arch/i386/kernel/cpu/perfctr-watchdog.c
+++ b/arch/i386/kernel/cpu/perfctr-watchdog.c
@@ -346,7 +346,9 @@ static int setup_p6_watchdog(unsigned nmi_hz)
 	perfctr_msr = MSR_P6_PERFCTR0;
 	evntsel_msr = MSR_P6_EVNTSEL0;
 
-	wrmsrl(perfctr_msr, 0UL);
+	/* KVM doesn't implement this MSR */
+	if (wrmsr_safe(perfctr_msr, 0, 0) < 0)
+		return 0;
 
 	evntsel = P6_EVNTSEL_INT
 		| P6_EVNTSEL_OS

