commit e1101773f96815751e0579b8208156ff838c11d4
Author: Assefa Yewondwossen <assefa@dmsolutions.ca>
Date:   Thu Mar 25 13:46:25 2010 +0000

    Fix GetFeatureInfo queries on WFS layers (#3403)
    
    git-svn-id: http://svn.osgeo.org/mapserver/trunk@10007 7532c77e-422f-0410-93f4-f0b67bdd69e2

diff --git a/mapserver.h b/mapserver.h
index 576fa71b..278643e9 100644
--- a/mapserver.h
+++ b/mapserver.h
@@ -1989,6 +1989,7 @@ int msOGRLayerNextShape(layerObj *layer, shapeObj *shape);
 int msOGRLayerGetItems(layerObj *layer);
 void msOGRLayerFreeItemInfo(layerObj *layer);
 int msOGRLayerGetShape(layerObj *layer, shapeObj *shape, int tile, long record);
+int msOGRLayerResultGetShape(layerObj *layer, shapeObj *shape, int tile, long record);
 int msOGRLayerGetExtent(layerObj *layer, rectObj *extent);
 
 #ifdef USE_OGR
diff --git a/mapwfslayer.c b/mapwfslayer.c
index 0cb072d5..e44e7081 100644
--- a/mapwfslayer.c
+++ b/mapwfslayer.c
@@ -936,6 +936,45 @@ int msWFSLayerGetShape(layerObj *layer, shapeObj *shape, int tile,
 
 
 
+/**********************************************************************
+ *                          msWFSLayerGetShape()
+ *
+ **********************************************************************/
+int msWFSLayerResultGetShape(layerObj *layer, shapeObj *shape, int tile, 
+                             long record)
+{
+#ifdef USE_WFS_LYR
+    msWFSLayerInfo* psInfo = NULL;
+
+    if(layer != NULL && layer->wfslayerinfo != NULL)
+    	psInfo = (msWFSLayerInfo*)layer->wfslayerinfo;
+    else
+    {
+	msSetError(MS_WFSERR, "Layer is not opened.", "msWFSLayerResultGetShape()");
+	return MS_FAILURE;
+    }
+
+    if(psInfo->bLayerHasValidGML)
+      return msOGRLayerResultGetShape(layer, shape, tile, record);
+    else
+    {
+          /* Layer is successful, but there is no data to process */
+        msFreeShape(shape);
+        shape->type = MS_SHAPE_NULL;
+        return MS_FAILURE;
+    }
+#else
+/* ------------------------------------------------------------------
+ * WFS CONNECTION Support not included...
+ * ------------------------------------------------------------------ */
+  msSetError(MS_WFSCONNERR, "WFS CLIENT CONNECTION support is not available.", 
+             "msWFSLayerResultGetShape()");
+  return(MS_FAILURE);
+#endif /* USE_WFS_LYR */
+
+}
+
+
 
 /**********************************************************************
  *                          msWFSLayerGetNextShape()
@@ -1321,7 +1360,7 @@ msWFSLayerInitializeVirtualTable(layerObj *layer)
     layer->vtable->LayerIsOpen = msWFSLayerIsOpen;
     layer->vtable->LayerWhichShapes = msWFSLayerWhichShapes;
     layer->vtable->LayerNextShape = msWFSLayerNextShape;
-    layer->vtable->LayerResultsGetShape = msWFSLayerGetShape; 
+    layer->vtable->LayerResultsGetShape = msWFSLayerResultGetShape; 
     layer->vtable->LayerGetShape = msWFSLayerGetShape;
     layer->vtable->LayerClose = msWFSLayerClose;
     layer->vtable->LayerGetItems = msWFSLayerGetItems;

