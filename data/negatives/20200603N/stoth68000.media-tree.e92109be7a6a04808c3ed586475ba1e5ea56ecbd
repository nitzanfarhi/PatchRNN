commit e92109be7a6a04808c3ed586475ba1e5ea56ecbd
Author: Stanislaw Gruszka <sgruszka@redhat.com>
Date:   Thu Mar 15 11:42:49 2012 +0100

    iwlegacy: fix BSSID setting
    
    Current commit 0775f9f90cdaf40fbf69b3192b3dddb2b3436f45
    "mac80211: remove spurious BSSID change flag" exposed bug on iwlegacy,
    that we do not set BSSID address correctly and then device was not able
    to receive frames after successful associate.
    
    On the way fix scan canceling comment. Apparently ->post_associate()
    do cancel scan itself, but scan cancel on BSS_CHANGED_BSSID is needed.
    I'm not sure why, but when I removed it, I had frequent auth failures:
    
     wlan4: send auth to 54:e6:fc:98:63:fe (try 1/3)
     wlan4: send auth to 54:e6:fc:98:63:fe (try 2/3)
     wlan4: send auth to 54:e6:fc:98:63:fe (try 3/3)
     wlan4: authentication with 54:e6:fc:98:63:fe timed out
    
    Signed-off-by: Stanislaw Gruszka <sgruszka@redhat.com>
    Signed-off-by: John W. Linville <linville@tuxdriver.com>

diff --git a/drivers/net/wireless/iwlegacy/common.c b/drivers/net/wireless/iwlegacy/common.c
index 6a692a534ffc..eaf249452e51 100644
--- a/drivers/net/wireless/iwlegacy/common.c
+++ b/drivers/net/wireless/iwlegacy/common.c
@@ -5288,9 +5288,9 @@ il_mac_bss_info_changed(struct ieee80211_hw *hw, struct ieee80211_vif *vif,
 		D_MAC80211("BSSID %pM\n", bss_conf->bssid);
 
 		/*
-		 * If there is currently a HW scan going on in the
-		 * background then we need to cancel it else the RXON
-		 * below/in post_associate will fail.
+		 * If there is currently a HW scan going on in the background,
+		 * then we need to cancel it, otherwise sometimes we are not
+		 * able to authenticate (FIXME: why ?)
 		 */
 		if (il_scan_cancel_timeout(il, 100)) {
 			D_MAC80211("leave - scan abort failed\n");
@@ -5299,14 +5299,10 @@ il_mac_bss_info_changed(struct ieee80211_hw *hw, struct ieee80211_vif *vif,
 		}
 
 		/* mac80211 only sets assoc when in STATION mode */
-		if (vif->type == NL80211_IFTYPE_ADHOC || bss_conf->assoc) {
-			memcpy(il->staging.bssid_addr, bss_conf->bssid,
-			       ETH_ALEN);
+		memcpy(il->staging.bssid_addr, bss_conf->bssid, ETH_ALEN);
 
-			/* currently needed in a few places */
-			memcpy(il->bssid, bss_conf->bssid, ETH_ALEN);
-		} else
-			il->staging.filter_flags &= ~RXON_FILTER_ASSOC_MSK;
+		/* FIXME: currently needed in a few places */
+		memcpy(il->bssid, bss_conf->bssid, ETH_ALEN);
 	}
 
 	/*

