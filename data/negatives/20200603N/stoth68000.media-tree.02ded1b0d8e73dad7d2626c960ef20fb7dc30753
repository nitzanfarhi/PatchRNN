commit 02ded1b0d8e73dad7d2626c960ef20fb7dc30753
Author: Robert Baldyga <r.baldyga@samsung.com>
Date:   Tue Jul 28 07:19:59 2015 +0200

    usb: gadget: add 'quirk_stall_not_supp' to usb_gadget
    
    Due to some UDC controllers may not support stalling, usb gadget layer
    needs to provide a generic way to inform gadget functions about non-standard
    hardware limitations.
    
    This patch adds 'quirk_stall_not_supp' field to struct usb_gadget and helper
    function gadget_is_stall_supported(). It also sets 'quirk_stall_not_supp'
    to 1 in at91_udc driver, which has such limitation.
    
    Signed-off-by: Robert Baldyga <r.baldyga@samsung.com>
    Signed-off-by: Felipe Balbi <balbi@ti.com>

diff --git a/drivers/usb/gadget/udc/at91_udc.c b/drivers/usb/gadget/udc/at91_udc.c
index fc4226462f8f..32f50a7944dd 100644
--- a/drivers/usb/gadget/udc/at91_udc.c
+++ b/drivers/usb/gadget/udc/at91_udc.c
@@ -825,6 +825,7 @@ static void udc_reinit(struct at91_udc *udc)
 
 	INIT_LIST_HEAD(&udc->gadget.ep_list);
 	INIT_LIST_HEAD(&udc->gadget.ep0->ep_list);
+	udc->gadget.quirk_stall_not_supp = 1;
 
 	for (i = 0; i < NUM_ENDPOINTS; i++) {
 		struct at91_ep *ep = &udc->ep[i];
diff --git a/include/linux/usb/gadget.h b/include/linux/usb/gadget.h
index 31be84b7e645..f195a76548f6 100644
--- a/include/linux/usb/gadget.h
+++ b/include/linux/usb/gadget.h
@@ -573,6 +573,7 @@ struct usb_gadget {
 	unsigned			a_alt_hnp_support:1;
 	unsigned			quirk_ep_out_aligned_size:1;
 	unsigned			quirk_altset_not_supp:1;
+	unsigned			quirk_stall_not_supp:1;
 	unsigned			is_selfpowered:1;
 	unsigned			deactivated:1;
 	unsigned			connected:1;
@@ -620,6 +621,15 @@ static inline int gadget_is_altset_supported(struct usb_gadget *g)
 	return !g->quirk_altset_not_supp;
 }
 
+/**
+ * gadget_is_stall_supported - return true iff the hardware supports stalling
+ * @g: controller to check for quirk
+ */
+static inline int gadget_is_stall_supported(struct usb_gadget *g)
+{
+	return !g->quirk_stall_not_supp;
+}
+
 /**
  * gadget_is_dualspeed - return true iff the hardware handles high speed
  * @g: controller that might support both high and full speeds

