commit afdacc6ed76dd288fdbc0f99857d9ffba23c5132
Author: w11979 <wang.wenfeng@h3c.com>
Date:   Fri Sep 1 10:02:34 2017 -0400

    osd: fix build_initial_pg_history
    
    We need to update our info about the previous interval in order to
    detect interval changes properly.
    
    Fixes: http://tracker.ceph.com/issues/21203
    
    Signed-off-by: w11979 <wang.wenfeng@h3c.com>
    Signed-off-by: Sage Weil <sage@redhat.com>

diff --git a/src/osd/OSD.cc b/src/osd/OSD.cc
index ddf67319a1..35c8758469 100644
--- a/src/osd/OSD.cc
+++ b/src/osd/OSD.cc
@@ -4436,6 +4436,10 @@ void OSD::build_initial_pg_history(
       h->last_epoch_split = e;
     }
     lastmap = osdmap;
+    up_primary = new_up_primary;
+    acting_primary = new_acting_primary;
+    up = new_up;
+    acting = new_acting;
   }
   dout(20) << __func__ << " " << debug.str() << dendl;
   dout(10) << __func__ << " " << *h << " " << *pi

