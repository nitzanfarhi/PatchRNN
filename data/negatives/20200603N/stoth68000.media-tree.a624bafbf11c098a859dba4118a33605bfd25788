commit a624bafbf11c098a859dba4118a33605bfd25788
Author: Martin Peres <martin.peres@labri.fr>
Date:   Thu Dec 20 01:32:09 2012 +0100

    drm/nouveau/fan: handle the cases where we are outside of the linear zone
    
    This fixes a bug where, when temperature is outside of the linear range, fan
    pwm would be outside of the allowed range ([0, 100]) and could get negative in
    some cases.
    
    It seems like a regression that happened when we re-worked the fan management
    logic before merging.
    
    Tested-by: Ozan Çağlayan <ozancag@gmail.com>
    Signed-off-by: Martin Peres <martin.peres@labri.fr>
    Signed-off-by: Ben Skeggs <bskeggs@redhat.com>

diff --git a/drivers/gpu/drm/nouveau/core/subdev/therm/base.c b/drivers/gpu/drm/nouveau/core/subdev/therm/base.c
index b35b4a249c5f..25b7f6a907c8 100644
--- a/drivers/gpu/drm/nouveau/core/subdev/therm/base.c
+++ b/drivers/gpu/drm/nouveau/core/subdev/therm/base.c
@@ -71,6 +71,13 @@ nouveau_therm_update_linear(struct nouveau_therm *therm)
 	u8  temp = therm->temp_get(therm);
 	u16 duty;
 
+	/* handle the non-linear part first */
+	if (temp < linear_min_temp)
+		return priv->fan->bios.min_duty;
+	else if (temp > linear_max_temp)
+		return priv->fan->bios.max_duty;
+
+	/* we are in the linear zone */
 	duty  = (temp - linear_min_temp);
 	duty *= (priv->fan->bios.max_duty - priv->fan->bios.min_duty);
 	duty /= (linear_max_temp - linear_min_temp);

