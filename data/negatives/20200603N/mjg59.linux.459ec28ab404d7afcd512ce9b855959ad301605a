commit 459ec28ab404d7afcd512ce9b855959ad301605a
Author: Ingo Molnar <mingo@elte.hu>
Date:   Sun Sep 13 17:33:44 2009 +0200

    perf_counter: Allow mmap if paranoid checks are turned off
    
    Before:
    
      $ perf sched record -f sleep 1
      Error: failed to mmap with 1 (Operation not permitted)
    
    After:
    
      $ perf sched record -f sleep 1
      [ perf record: Captured and wrote 0.095 MB perf.data (~4161 samples) ]
    
    Note, this is only allowed if perfcounter_paranoid is set to
    the most permissive (non-default) value of -1.
    
    Cc: Peter Zijlstra <a.p.zijlstra@chello.nl>
    Cc: Mike Galbraith <efault@gmx.de>
    Cc: Paul Mackerras <paulus@samba.org>
    Cc: Arnaldo Carvalho de Melo <acme@redhat.com>
    Cc: Frederic Weisbecker <fweisbec@gmail.com>
    LKML-Reference: <new-submission>
    Signed-off-by: Ingo Molnar <mingo@elte.hu>

diff --git a/kernel/perf_counter.c b/kernel/perf_counter.c
index e0d91fdf0c3c..667ab25ad3d5 100644
--- a/kernel/perf_counter.c
+++ b/kernel/perf_counter.c
@@ -2315,7 +2315,8 @@ static int perf_mmap(struct file *file, struct vm_area_struct *vma)
 	lock_limit >>= PAGE_SHIFT;
 	locked = vma->vm_mm->locked_vm + extra;
 
-	if ((locked > lock_limit) && !capable(CAP_IPC_LOCK)) {
+	if ((locked > lock_limit) && perf_paranoid_tracepoint_raw() &&
+		!capable(CAP_IPC_LOCK)) {
 		ret = -EPERM;
 		goto unlock;
 	}

