commit 1d5f003f5a964711853514b04ddc872eec0fdc7b
Author: Gleb Natapov <gleb@redhat.com>
Date:   Sun Oct 23 19:10:33 2011 +0200

    perf: Do not set task_ctx pointer in cpuctx if there are no events in the context
    
    Do not set task_ctx pointer during sched_in if there are no
    events associated with the context.  Otherwise if during task
    execution total number of events in the system will become zero
    perf_event_context_sched_out() will not be called and cpuctx->task_ctx
    will be left with a stale value.
    
    Signed-off-by: Gleb Natapov <gleb@redhat.com>
    Signed-off-by: Peter Zijlstra <a.p.zijlstra@chello.nl>
    Link: http://lkml.kernel.org/r/20111023171033.GI17571@redhat.com
    Signed-off-by: Ingo Molnar <mingo@elte.hu>

diff --git a/kernel/events/core.c b/kernel/events/core.c
index 0e8457da6f95..b0c1186fd97b 100644
--- a/kernel/events/core.c
+++ b/kernel/events/core.c
@@ -2173,7 +2173,8 @@ static void perf_event_context_sched_in(struct perf_event_context *ctx,
 
 	perf_event_sched_in(cpuctx, ctx, task);
 
-	cpuctx->task_ctx = ctx;
+	if (ctx->nr_events)
+		cpuctx->task_ctx = ctx;
 
 	perf_pmu_enable(ctx->pmu);
 	perf_ctx_unlock(cpuctx, ctx);

