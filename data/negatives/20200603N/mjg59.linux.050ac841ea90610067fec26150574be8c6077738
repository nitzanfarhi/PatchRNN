commit 050ac841ea90610067fec26150574be8c6077738
Author: Miklos Szeredi <mszeredi@suse.cz>
Date:   Mon May 21 17:30:12 2012 +0200

    vfs: do_last(): only return EISDIR for O_CREAT
    
    This allows this code to be shared between O_CREAT and plain opens.
    
    Signed-off-by: Miklos Szeredi <mszeredi@suse.cz>
    Signed-off-by: Al Viro <viro@zeniv.linux.org.uk>

diff --git a/fs/namei.c b/fs/namei.c
index 4767c0588b6e..90210b46b461 100644
--- a/fs/namei.c
+++ b/fs/namei.c
@@ -2384,7 +2384,7 @@ static struct file *do_last(struct nameidata *nd, struct path *path,
 	if (error)
 		return ERR_PTR(error);
 	error = -EISDIR;
-	if (S_ISDIR(nd->inode->i_mode))
+	if ((open_flag & O_CREAT) && S_ISDIR(nd->inode->i_mode))
 		goto exit;
 	error = -ENOTDIR;
 	if ((nd->flags & LOOKUP_DIRECTORY) && !nd->inode->i_op->lookup)

