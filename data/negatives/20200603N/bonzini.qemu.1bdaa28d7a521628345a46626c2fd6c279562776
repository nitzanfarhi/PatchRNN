commit 1bdaa28d7a521628345a46626c2fd6c279562776
Author: Alexander Graf <agraf@suse.de>
Date:   Tue Dec 14 16:23:38 2010 +0100

    ide: honor ncq for atapi
    
    ATAPI also can do ncq, so let's expose the capability.
    
    This patch makes CD-ROM support work on Windows 7 for me.
    
    Signed-off-by: Alexander Graf <agraf@suse.de>
    Signed-off-by: Kevin Wolf <kwolf@redhat.com>

diff --git a/hw/ide/core.c b/hw/ide/core.c
index 9e1d4e6717..9496e990b9 100644
--- a/hw/ide/core.c
+++ b/hw/ide/core.c
@@ -217,6 +217,12 @@ static void ide_atapi_identify(IDEState *s)
     put_le16(p + 71, 30); /* in ns */
     put_le16(p + 72, 30); /* in ns */
 
+    if (s->ncq_queues) {
+        put_le16(p + 75, s->ncq_queues - 1);
+        /* NCQ supported */
+        put_le16(p + 76, (1 << 8));
+    }
+
     put_le16(p + 80, 0x1e); /* support up to ATA/ATAPI-4 */
 #ifdef USE_DMA_CDROM
     put_le16(p + 88, 0x3f | (1 << 13)); /* udma5 set and supported */

