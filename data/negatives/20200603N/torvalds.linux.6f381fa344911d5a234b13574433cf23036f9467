commit 6f381fa344911d5a234b13574433cf23036f9467
Author: Lin Ming <ming.m.lin@intel.com>
Date:   Thu Apr 12 13:50:38 2012 +0800

    [SCSI] scsi_lib: use correct DMA device in __scsi_alloc_queue
    
    Currently, __scsi_alloc_queue uses SCSI host's parent device
    as DMA device to set segment boundary. But the parent device may not
    refer to the DMA device. For example, for ATA disk, SCSI host's parent
    device now refers to ATA port.
    
    Since commit d139b9b([SCSI] scsi_lib_dma: fix bug with dma maps on
    nested scsi objects), a new field Scsi_Host->dma_dev was introduced
    to refer to the real DMA device.
    
    Use ->dma_dev in __scsi_alloc_queue to correctly set segment
    boundary.
    
    Bug report: http://marc.info/?l=linux-ide&m=133177818318187&w=2
    
    Reported-and-tested-by: JÃ¶rg Sommer <joerg@alea.gnuu.de>
    Signed-off-by: Lin Ming <ming.m.lin@intel.com>
    Signed-off-by: James Bottomley <JBottomley@Parallels.com>

diff --git a/drivers/scsi/scsi_lib.c b/drivers/scsi/scsi_lib.c
index ead6405f3e51..5dfd7495d1a1 100644
--- a/drivers/scsi/scsi_lib.c
+++ b/drivers/scsi/scsi_lib.c
@@ -1638,7 +1638,7 @@ struct request_queue *__scsi_alloc_queue(struct Scsi_Host *shost,
 					 request_fn_proc *request_fn)
 {
 	struct request_queue *q;
-	struct device *dev = shost->shost_gendev.parent;
+	struct device *dev = shost->dma_dev;
 
 	q = blk_init_queue(request_fn, NULL);
 	if (!q)

