commit 07fc96197aec46f7ad4f08a4b2a1ea426112e24d
Author: Philipp Reisner <philipp.reisner@linbit.com>
Date:   Tue Aug 28 11:07:56 2012 +0200

    drbd: Do not check aspects that are not subject to change in _conn_requests_state()
    
    When _conn_requests_state() is used to change other parts of the state
    than the connection, do not check for a valid connection transition.
    
    Signed-off-by: Philipp Reisner <philipp.reisner@linbit.com>
    Signed-off-by: Lars Ellenberg <lars.ellenberg@linbit.com>

diff --git a/drivers/block/drbd/drbd_state.c b/drivers/block/drbd/drbd_state.c
index f3e6090d462b..9ae40c96c1be 100644
--- a/drivers/block/drbd/drbd_state.c
+++ b/drivers/block/drbd/drbd_state.c
@@ -1742,9 +1742,11 @@ _conn_request_state(struct drbd_tconn *tconn, union drbd_state mask, union drbd_
 	union drbd_state ns_max, ns_min, os;
 	bool have_mutex = false;
 
-	rv = is_valid_conn_transition(oc, val.conn);
-	if (rv < SS_SUCCESS)
-		goto abort;
+	if (mask.conn) {
+		rv = is_valid_conn_transition(oc, val.conn);
+		if (rv < SS_SUCCESS)
+			goto abort;
+	}
 
 	rv = conn_is_valid_transition(tconn, mask, val, flags);
 	if (rv < SS_SUCCESS)

