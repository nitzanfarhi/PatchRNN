commit ac0c66d60102982ec2e9cb1a1277187fb1d3ed0c
Author: Paul Wouters <pwouters@redhat.com>
Date:   Wed Oct 8 00:39:29 2014 -0400

    pluto: handle AES_CTR_SALT_BYTES

diff --git a/programs/pluto/ikev1_quick.c b/programs/pluto/ikev1_quick.c
index bf11a268e..1c893c183 100644
--- a/programs/pluto/ikev1_quick.c
+++ b/programs/pluto/ikev1_quick.c
@@ -212,6 +212,19 @@ static void compute_proto_keymat(struct state *st,
 				/* XXX: obtained from peer - was it verified for validity yet? */
 			}
 			break;
+		case ESP_AES_CTR:
+			if (st->st_esp.attrs.transattrs.enckeylen) {
+				needed_len =
+					st->st_esp.attrs.transattrs.enckeylen /
+					BITS_PER_BYTE;
+				/* XXX: obtained from peer - was it verified for validity yet? */
+			} else {
+				/* if no keylength set, pick strongest allowed */
+				needed_len = AES_CTR_KEY_MAX_LEN / BITS_PER_BYTE;
+			}
+			/* AES_CTR requires an extra AES_CTR_SALT_BYTES (4) bytes of salt */
+			needed_len += AES_CTR_SALT_BYTES;
+			break;
 		case ESP_AES_GCM_8:
 		case ESP_AES_GCM_12:
 		case ESP_AES_GCM_16:
diff --git a/programs/pluto/ikev2_crypto.c b/programs/pluto/ikev2_crypto.c
index be4350872..3fbec74fd 100644
--- a/programs/pluto/ikev2_crypto.c
+++ b/programs/pluto/ikev2_crypto.c
@@ -100,6 +100,10 @@ void ikev2_derive_child_keys(struct state *st, enum phase1_role role)
 		ipi->keymat_len = ei->authkeylen;
 		break;
 
+	case IKEv2_ENCR_AES_CTR:
+		ipi->keymat_len = ei->enckeylen + ei->authkeylen + AES_CTR_SALT_BYTES;;
+		break;
+
 	case IKEv2_ENCR_AES_GCM_8:
 	case IKEv2_ENCR_AES_GCM_12:
 	case IKEv2_ENCR_AES_GCM_16:
diff --git a/programs/pluto/kernel.c b/programs/pluto/kernel.c
index 019c43808..7bd2d6b42 100644
--- a/programs/pluto/kernel.c
+++ b/programs/pluto/kernel.c
@@ -1729,6 +1729,12 @@ static bool setup_half_ipsec_sa(struct state *st, bool inbound)
 			if (enc_key_len == 7)
 				enc_key_len = 8;
 			break;
+
+		case IKEv2_ENCR_AES_CTR:
+			/* keymat contains 4 bytes of salt */
+			enc_key_len += AES_CTR_SALT_BYTES;
+			break;
+
 		case IKEv2_ENCR_AES_GCM_8:
 		case IKEv2_ENCR_AES_GCM_12:
 		case IKEv2_ENCR_AES_GCM_16:

