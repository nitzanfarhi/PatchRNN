commit 8d67115ff1d54ba967c835c5aa050111fa54602f
Author: Timo Sirainen <tss@iki.fi>
Date:   Fri Sep 20 08:40:43 2002 +0300

    Index compression broke it + few other fixes
    
    --HG--
    branch : HEAD

diff --git a/src/lib-index/mail-index-compress.c b/src/lib-index/mail-index-compress.c
index 59851ae9f..fcefe2f2c 100644
--- a/src/lib-index/mail-index-compress.c
+++ b/src/lib-index/mail-index-compress.c
@@ -83,6 +83,8 @@ int mail_index_compress(MailIndex *index)
 	/* truncate the file to get rid of the extra records */
 	index->mmap_used_length = (size_t) ((char *) hole_rec -
 					    (char *) index->mmap_base);
+	index->header->used_file_size = index->mmap_used_length;
+
 	if (!mail_index_truncate(index))
 		return FALSE;
 
diff --git a/src/lib-index/mail-index-fsck.c b/src/lib-index/mail-index-fsck.c
index 3a2c2bb62..e54c08fd1 100644
--- a/src/lib-index/mail-index-fsck.c
+++ b/src/lib-index/mail-index-fsck.c
@@ -27,14 +27,16 @@ static void print_differences(MailIndexHeader *old_hdr,
 	CHECK(deleted_messages_count);
 	CHECK(last_nonrecent_uid);
 
-	if (old_hdr->first_unseen_uid_lowwater >
+	if (new_hdr->first_unseen_uid_lowwater != 0 &&
+	    old_hdr->first_unseen_uid_lowwater >
 	    new_hdr->first_unseen_uid_lowwater) {
 		i_warning("fsck: first_unseen_uid_lowwater %u > %u",
 			  old_hdr->first_unseen_uid_lowwater,
                           new_hdr->first_unseen_uid_lowwater);
 	}
 
-	if (old_hdr->first_deleted_uid_lowwater >
+	if (new_hdr->first_deleted_uid_lowwater != 0 &&
+	    old_hdr->first_deleted_uid_lowwater >
 	    new_hdr->first_deleted_uid_lowwater) {
 		i_warning("fsck: first_deleted_uid_lowwater %u > %u",
 			  old_hdr->first_deleted_uid_lowwater,
diff --git a/src/lib-index/mail-index.c b/src/lib-index/mail-index.c
index 902cd79f5..1940503ea 100644
--- a/src/lib-index/mail-index.c
+++ b/src/lib-index/mail-index.c
@@ -1024,6 +1024,8 @@ int mail_index_append_begin(MailIndex *index, MailIndexRecord **rec)
 
 int mail_index_append_end(MailIndex *index, MailIndexRecord *rec)
 {
+	i_assert(rec->uid == 0);
+
 	index->header->messages_count++;
 
 	rec->uid = index->header->next_uid++;

