commit 09024aa61e1bc994404683e2e5b363484a15dd12
Author: Geoff Levand <geoff@infradead.org>
Date:   Tue Dec 17 00:19:29 2013 +0000

    arm64: Fix the soft_restart routine
    
    Change the soft_restart() routine to call cpu_reset() at its identity mapped
    physical address.
    
    The cpu_reset() routine must be called at its identity mapped physical address
    so that when the MMU is turned off the instruction pointer will be at the correct
    location in physical memory.
    
    Signed-off-by: Geoff Levand <geoff@infradead.org> for Huawei, Linaro
    Signed-off-by: Catalin Marinas <catalin.marinas@arm.com>

diff --git a/arch/arm64/kernel/process.c b/arch/arm64/kernel/process.c
index 1c0a9be2ffa8..fa6b5bba15f6 100644
--- a/arch/arm64/kernel/process.c
+++ b/arch/arm64/kernel/process.c
@@ -72,8 +72,17 @@ static void setup_restart(void)
 
 void soft_restart(unsigned long addr)
 {
+	typedef void (*phys_reset_t)(unsigned long);
+	phys_reset_t phys_reset;
+
 	setup_restart();
-	cpu_reset(addr);
+
+	/* Switch to the identity mapping */
+	phys_reset = (phys_reset_t)virt_to_phys(cpu_reset);
+	phys_reset(addr);
+
+	/* Should never get here */
+	BUG();
 }
 
 /*

