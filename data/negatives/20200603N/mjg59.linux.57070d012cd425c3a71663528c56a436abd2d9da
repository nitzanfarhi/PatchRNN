commit 57070d012cd425c3a71663528c56a436abd2d9da
Author: Peter Staubach <staubach@redhat.com>
Date:   Sat Mar 25 03:08:04 2006 -0800

    [PATCH] compat_sys_nfsservctl(): handle errors correctly
    
    Correct some error handling on the compat version of the nfsservctl()
    system.  It was detecting errors while copying in the arguments from user
    space, but then attempting to use the arguments anyway.  This didn't seem
    so good.
    
    Signed-off-by: Peter Staubach <staubach@redhat.com>
    Cc: Trond Myklebust <trond.myklebust@fys.uio.no>
    Cc: Neil Brown <neilb@cse.unsw.edu.au>
    Signed-off-by: Andrew Morton <akpm@osdl.org>
    Signed-off-by: Linus Torvalds <torvalds@osdl.org>

diff --git a/fs/compat.c b/fs/compat.c
index 2a88477330fc..263990ae4096 100644
--- a/fs/compat.c
+++ b/fs/compat.c
@@ -2170,9 +2170,12 @@ asmlinkage long compat_sys_nfsservctl(int cmd, struct compat_nfsctl_arg __user *
 
 	default:
 		err = -EINVAL;
-		goto done;
+		break;
 	}
 
+	if (err)
+		goto done;
+
 	oldfs = get_fs();
 	set_fs(KERNEL_DS);
 	/* The __user pointer casts are valid because of the set_fs() */

