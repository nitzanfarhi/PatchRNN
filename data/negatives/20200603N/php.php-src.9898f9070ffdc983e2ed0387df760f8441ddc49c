commit 9898f9070ffdc983e2ed0387df760f8441ddc49c
Author: Gustavo Andr√© dos Santos Lopes <cataphract@php.net>
Date:   Tue Jul 5 16:09:06 2011 +0000

    - Fixed bug #52935 (call exit in user_error_handler cause stream relate core).

diff --git a/main/streams/streams.c b/main/streams/streams.c
index 673795971a..15c1454547 100755
--- a/main/streams/streams.c
+++ b/main/streams/streams.c
@@ -163,6 +163,7 @@ void php_stream_display_wrapper_errors(php_stream_wrapper *wrapper, const char *
 	char *tmp = estrdup(path);
 	char *msg;
 	int free_msg = 0;
+	php_stream_wrapper orig_wrapper;
 
 	if (wrapper) {
 		if (wrapper->err_count > 0) {
@@ -207,7 +208,16 @@ void php_stream_display_wrapper_errors(php_stream_wrapper *wrapper, const char *
 	}
 
 	php_strip_url_passwd(tmp);
+	if (wrapper) {
+		/* see bug #52935 */
+		orig_wrapper = *wrapper;
+		wrapper->err_stack = NULL;
+		wrapper->err_count = 0;
+	}
 	php_error_docref1(NULL TSRMLS_CC, tmp, E_WARNING, "%s: %s", caption, msg);
+	if (wrapper) {
+		*wrapper = orig_wrapper;
+	}
 	efree(tmp);
 	if (free_msg) {
 		efree(msg);

