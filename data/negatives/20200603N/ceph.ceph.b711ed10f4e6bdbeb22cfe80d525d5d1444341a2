commit b711ed10f4e6bdbeb22cfe80d525d5d1444341a2
Author: Sage Weil <sage@newdream.net>
Date:   Thu Dec 4 10:06:09 2008 -0800

    osd: fix missing.add_event
    
    We only should set have to prior_version if we aren't missing the
    prior_version too!

diff --git a/src/osd/PG.h b/src/osd/PG.h
index e5bb933b17..0075278937 100644
--- a/src/osd/PG.h
+++ b/src/osd/PG.h
@@ -430,9 +430,12 @@ public:
     }
     
     void add_event(Log::Entry& e) {
-      if (e.is_update())
-	add(e.oid, e.version, e.prior_version);
-      else
+      if (e.is_update()) {
+	if (is_missing(e.oid, e.prior_version))
+	  add(e.oid, e.version);
+	else
+	  add(e.oid, e.version, e.prior_version);
+      } else
 	rm(e.oid, e.version);
     }
 

