commit c703c0bac32c5655f1881dca73aecc695056995c
Author: Alberto Lerner <alerner@10gen.com>
Date:   Thu Aug 19 12:54:28 2010 -0400

    Tighten process string caching

diff --git a/client/distlock.cpp b/client/distlock.cpp
index 90d203120d..2f5bb00fc5 100644
--- a/client/distlock.cpp
+++ b/client/distlock.cpp
@@ -16,6 +16,9 @@
  */
 
 #include "pch.h"
+
+#include "boost/thread/once.hpp"
+
 #include "dbclient.h"
 #include "distlock.h"
 
@@ -24,15 +27,28 @@ namespace mongo {
     string lockPingNS = "config.lockpings";
 
     ThreadLocalValue<string> distLockIds("");
-    
+
+    /* ==================
+     * Module initialization
+     */
+
+    boost::once_flag _init = BOOST_ONCE_INIT;
+    static string* _cachedProcessString = NULL;
+
+    static void initModule() {
+        // cache process string
+        stringstream ss;
+        ss << getHostName() << ":" << time(0) << ":" << rand();
+        _cachedProcessString = new string( ss.str() );
+    }
+
+    /* =================== */
+
     string getDistLockProcess(){
-        static string s;
-        if ( s.empty() ){
-            stringstream ss;
-            ss << getHostNameCached() << ":" << time(0) << ":" << rand();
-            s = ss.str();
-        }
-        return s;
+        if ( _cachedProcessString == NULL )
+            boost::call_once( initModule, _init );
+        assert( _cachedProcessString );
+        return *_cachedProcessString;
     }
 
     string getDistLockId(){

