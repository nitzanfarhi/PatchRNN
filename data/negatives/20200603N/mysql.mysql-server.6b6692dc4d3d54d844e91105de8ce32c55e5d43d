commit 6b6692dc4d3d54d844e91105de8ce32c55e5d43d
Author: dlenev@mysql.com <>
Date:   Fri Oct 22 19:27:43 2004 +0400

    Part of fix for bug #6081 "Call to deprecated mysql_create_db() function
    crashes server"
    
    (in 4.0 we fix only connection stalling in case of error, crash itself is
    fixed in 4.1, the test case for this code is also there).

diff --git a/sql/sql_parse.cc b/sql/sql_parse.cc
index 9e0853a370b..7c21a5af2a6 100644
--- a/sql/sql_parse.cc
+++ b/sql/sql_parse.cc
@@ -1142,7 +1142,9 @@ bool dispatch_command(enum enum_server_command command, THD *thd,
       if (check_access(thd,CREATE_ACL,db,0,1))
 	break;
       mysql_log.write(thd,command,packet);
-      mysql_create_db(thd,(lower_case_table_names == 2 ? alias : db),0,0);
+      if (mysql_create_db(thd, (lower_case_table_names == 2 ? alias : db),
+                          0, 0) < 0)
+        send_error(&thd->net, thd->killed ? ER_SERVER_SHUTDOWN : 0);
       break;
     }
   case COM_DROP_DB:				// QQ: To be removed
@@ -1163,7 +1165,9 @@ bool dispatch_command(enum enum_server_command command, THD *thd,
 	break;
       }
       mysql_log.write(thd,command,db);
-      mysql_rm_db(thd, (lower_case_table_names == 2 ? alias : db), 0, 0);
+      if (mysql_rm_db(thd, (lower_case_table_names == 2 ? alias : db),
+                      0, 0) < 0)
+        send_error(&thd->net, thd->killed ? ER_SERVER_SHUTDOWN : 0);
       break;
     }
   case COM_BINLOG_DUMP:

