commit f6711b49b7db61a5e1c4575fde2d982c9220ec16
Author: Jan Kundr√°t <jkt@gentoo.org>
Date:   Tue Aug 31 01:45:43 2010 +0200

    Make sure we always work with uppercased capabilities

diff --git a/src/Imap/Model/ImapTask.cpp b/src/Imap/Model/ImapTask.cpp
index 48b93470..d143c9f5 100644
--- a/src/Imap/Model/ImapTask.cpp
+++ b/src/Imap/Model/ImapTask.cpp
@@ -143,8 +143,6 @@ void ImapTask::handleResponseCode( Imap::Parser* ptr, const Imap::Responses::Sta
                 const RespData<QStringList>* const caps = dynamic_cast<const RespData<QStringList>* const>(
                         resp->respCodeData.data() );
                 if ( caps ) {
-                    model->_parsers[ ptr ].capabilities = caps->data;
-                    model->_parsers[ ptr ].capabilitiesFresh = true;
                     model->updateCapabilities( ptr, caps->data );
                 }
             }
diff --git a/src/Imap/Model/Model.cpp b/src/Imap/Model/Model.cpp
index 99a491fb..d6a5917c 100644
--- a/src/Imap/Model/Model.cpp
+++ b/src/Imap/Model/Model.cpp
@@ -653,8 +653,6 @@ void Model::_finalizeFetch( Parser* parser, const QMap<CommandHandle, Task>::con
 
 void Model::handleCapability( Imap::Parser* ptr, const Imap::Responses::Capability* const resp )
 {
-    _parsers[ ptr ].capabilities = resp->capabilities;
-    _parsers[ ptr ].capabilitiesFresh = true;
     updateCapabilities( ptr, resp->capabilities );
 }
 
@@ -1205,7 +1203,12 @@ void Model::enterIdle( Parser* parser )
 
 void Model::updateCapabilities( Parser* parser, const QStringList capabilities )
 {
-    parser->enableLiteralPlus( capabilities.contains( QLatin1String( "LITERAL+" ) ) );
+    QStringList uppercaseCaps;
+    Q_FOREACH( const QString& str, capabilities )
+            uppercaseCaps << str.toUpper();
+    _parsers[ parser ].capabilities = uppercaseCaps;
+    _parsers[ parser ].capabilitiesFresh = true;
+    parser->enableLiteralPlus( uppercaseCaps.contains( QLatin1String( "LITERAL+" ) ) );
 }
 
 void Model::markMessageDeleted( TreeItemMessage* msg, bool marked )
diff --git a/src/Imap/Model/UnauthenticatedHandler.cpp b/src/Imap/Model/UnauthenticatedHandler.cpp
index 07856c96..73fd5f48 100644
--- a/src/Imap/Model/UnauthenticatedHandler.cpp
+++ b/src/Imap/Model/UnauthenticatedHandler.cpp
@@ -42,8 +42,6 @@ void UnauthenticatedHandler::handleResponseCode( Imap::Parser* ptr, const Imap::
                 const RespData<QStringList>* const caps = dynamic_cast<const RespData<QStringList>* const>(
                         resp->respCodeData.data() );
                 if ( caps ) {
-                    m->_parsers[ ptr ].capabilities = caps->data;
-                    m->_parsers[ ptr ].capabilitiesFresh = true;
                     m->updateCapabilities( ptr, caps->data );
                 }
             }

