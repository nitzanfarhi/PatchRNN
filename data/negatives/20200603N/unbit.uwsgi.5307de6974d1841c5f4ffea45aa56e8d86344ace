commit 5307de6974d1841c5f4ffea45aa56e8d86344ace
Author: Unbit <info@unbit.it>
Date:   Tue Feb 19 19:09:27 2013 +0100

    added uwsgi_buffer json escaper

diff --git a/core/buffer.c b/core/buffer.c
index d258ac02..b9d4a087 100644
--- a/core/buffer.c
+++ b/core/buffer.c
@@ -121,6 +121,23 @@ int uwsgi_buffer_append(struct uwsgi_buffer *ub, char *buf, size_t len) {
 	return 0;
 }
 
+int uwsgi_buffer_append_json(struct uwsgi_buffer *ub, char *buf, size_t len) {
+	// need to escape \ and "
+	size_t i;
+	for(i=0;i<len;i++) {
+		if (buf[i] == '"') {
+			if (uwsgi_buffer_append(ub, "\\\"", 2)) return -1;
+		}
+		else if (buf[i] == '\\') {
+			if (uwsgi_buffer_append(ub, "\\\\", 2)) return -1;
+		}
+		else {
+			if (uwsgi_buffer_append(ub, buf+i, 1)) return -1;
+		}
+	}
+	return 0;
+}
+
 int uwsgi_buffer_u16le(struct uwsgi_buffer *ub, uint16_t num) {
 	uint8_t buf[2];
 	buf[0] = (uint8_t) (num & 0xff);
diff --git a/uwsgi.h b/uwsgi.h
index 5625c559..0842a8c8 100644
--- a/uwsgi.h
+++ b/uwsgi.h
@@ -3558,6 +3558,7 @@ int uwsgi_buffer_append_base64(struct uwsgi_buffer *, char *, size_t);
 int uwsgi_buffer_insert(struct uwsgi_buffer *, size_t, char *, size_t);
 int uwsgi_buffer_insert_chunked(struct uwsgi_buffer *, size_t, size_t);
 int uwsgi_buffer_append_chunked(struct uwsgi_buffer *, size_t);
+int uwsgi_buffer_append_json(struct uwsgi_buffer *, char *, size_t);
 
 ssize_t uwsgi_buffer_write_simple(struct wsgi_request *, struct uwsgi_buffer *);
 

