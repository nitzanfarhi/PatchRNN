commit 960fe80e7f8db715f2a09d675a206000f94f8053
Author: Frank Denis (Jedi/Sector One) <github@pureftpd.org>
Date:   Tue Oct 20 23:36:45 2009 +0200

    Check mmap() return against MAP_FAILED, not NULL

diff --git a/src/ftpd.c b/src/ftpd.c
index 2c6be95..8d1af65 100644
--- a/src/ftpd.c
+++ b/src/ftpd.c
@@ -4643,7 +4643,7 @@ static void fortune(void)
         !(S_ISREG(st.st_mode) || S_ISLNK(st.st_mode)) || st.st_size < 2 ||
         (buf = mmap(NULL, (size_t) st.st_size,
                 PROT_READ, MAP_FILE | MAP_SHARED, fd,
-                (off_t) 0)) == (char *) MAP_FAILED) {
+                (off_t) 0)) == (void *) MAP_FAILED) {
         (void) close(fd);
         logfile(LOG_ERR, MSG_OPEN_FAILURE, fortunes_file);
         return;
diff --git a/src/ftpwho-update.c b/src/ftpwho-update.c
index dd534f6..03eb4e6 100644
--- a/src/ftpwho-update.c
+++ b/src/ftpwho-update.c
@@ -179,10 +179,11 @@ int ftpwho_initwho(void)
     lock.l_start = (off_t) 0;
     lock.l_len = (off_t) 0;
     lock.l_pid = getpid();
-    if ((shm_data_cur = (FTPWhoEntry *) mmap(NULL, sizeof (FTPWhoEntry),
-                                             PROT_WRITE | PROT_READ,
-                                             MAP_SHARED | MAP_FILE, 
-                                             mmap_fd, (off_t) 0)) == NULL) {
+    if ((shm_data_cur =
+         (FTPWhoEntry *) mmap(NULL, sizeof (FTPWhoEntry),
+                              PROT_WRITE | PROT_READ,
+                              MAP_SHARED | MAP_FILE, 
+                              mmap_fd, (off_t) 0)) == (void *) MAP_FAILED) {
         goto err2;
     }
     return 0;
diff --git a/src/pure-ftpwho.c b/src/pure-ftpwho.c
index d7bde20..7b346df 100644
--- a/src/pure-ftpwho.c
+++ b/src/pure-ftpwho.c
@@ -844,10 +844,11 @@ int main(int argc, char *argv[])
         }
         ftpwho_lock();
         locked++;
-        if ((scanned_entry = (FTPWhoEntry *) mmap(NULL, sizeof (FTPWhoEntry),
-                                                  PROT_READ, 
-                                                  MAP_SHARED | MAP_FILE, 
-                                                  mmap_fd, (off_t) 0)) == NULL) {
+        if ((scanned_entry =
+             (FTPWhoEntry *) mmap(NULL, sizeof (FTPWhoEntry),
+                                  PROT_READ, 
+                                  MAP_SHARED | MAP_FILE, 
+                                  mmap_fd, (off_t) 0)) == (void *) MAP_FAILED) {
             goto nextone;
         }
         if (checkproc(scanned_entry->pid) == 0) {

