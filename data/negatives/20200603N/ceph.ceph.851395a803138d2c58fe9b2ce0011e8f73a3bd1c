commit 851395a803138d2c58fe9b2ce0011e8f73a3bd1c
Author: Jason Dillaman <dillaman@redhat.com>
Date:   Tue Feb 9 12:10:10 2016 -0500

    librbd: do not fire flush completions before associated write
    
    Prevents a race condition in journal replay when committing events
    to the journal.
    
    Signed-off-by: Jason Dillaman <dillaman@redhat.com>

diff --git a/src/librbd/AioCompletion.cc b/src/librbd/AioCompletion.cc
index ab71c3c268..765c4cfe5f 100644
--- a/src/librbd/AioCompletion.cc
+++ b/src/librbd/AioCompletion.cc
@@ -91,12 +91,7 @@ namespace librbd {
       ictx->journal->commit_io_event(journal_tid, rval);
     }
 
-    // note: possible for image to be closed after op marked finished
     done = true;
-    if (async_op.started()) {
-      async_op.finish_op();
-    }
-
     if (complete_cb) {
       lock.Unlock();
       complete_cb(rbd_comp, complete_arg);
@@ -110,6 +105,11 @@ namespace librbd {
       ictx->event_socket.notify();
     }
     cond.Signal();
+
+    // note: possible for image to be closed after op marked finished
+    if (async_op.started()) {
+      async_op.finish_op();
+    }
     tracepoint(librbd, aio_complete_exit);
   }
 

