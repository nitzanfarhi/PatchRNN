commit 1f5b62024038d5bc697d539048750eaad85f6daa
Author: Sage Weil <sage@newdream.net>
Date:   Tue Apr 26 15:44:56 2011 -0700

    mon: fix standby-replay assignment (again)
    
    Only assign a random node to standby-replay if they are marked as
    STANDBY_ANY.
    
    Signed-off-by: Sage Weil <sage@newdream.net>

diff --git a/src/mon/MDSMonitor.cc b/src/mon/MDSMonitor.cc
index 51d5a0bfd1..f6e3aefce8 100644
--- a/src/mon/MDSMonitor.cc
+++ b/src/mon/MDSMonitor.cc
@@ -1067,11 +1067,12 @@ void MDSMonitor::tick()
 	   i != pending_mdsmap.mds_info.end();
 	   ++i) {
 	if (i->second.rank >= 0 && pending_mdsmap.is_followable(i->second.rank)) {
-	  if (info.standby_for_name.length() &&
-	      info.standby_for_name != i->second.name)
+	  if ((info.standby_for_name.length() && info.standby_for_name != i->second.name) ||
+	      info.standby_for_rank >= 0)
 	    continue;   // we're supposed to follow someone else
 
-	  if (try_standby_replay(info, i->second)) {
+	  if (info.standby_for_rank == MDSMap::MDS_STANDBY_ANY &&
+	      try_standby_replay(info, i->second)) {
 	    do_propose = true;
 	    break;
 	  }

