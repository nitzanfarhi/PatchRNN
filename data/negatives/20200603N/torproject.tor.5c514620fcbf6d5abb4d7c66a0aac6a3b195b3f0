commit 5c514620fcbf6d5abb4d7c66a0aac6a3b195b3f0
Author: Nick Mathewson <nickm@torproject.org>
Date:   Thu Apr 17 17:25:32 2003 +0000

    Adjust straggling users of payload field
    
    
    svn:r250

diff --git a/src/or/connection.c b/src/or/connection.c
index 7dd00cff5..c82a22594 100644
--- a/src/or/connection.c
+++ b/src/or/connection.c
@@ -670,7 +670,7 @@ repeat_connection_package_raw_inbuf:
    *       compressing.
    *    2) 
    */
-  len = connection_compress_from_buf(cell.payload,
+  len = connection_compress_from_buf(cell.payload+TOPIC_HEADER_SIZE,
                                      CELL_PAYLOAD_SIZE - TOPIC_HEADER_SIZE,
                                      conn, Z_SYNC_FLUSH);
   if (len < 0)
@@ -684,7 +684,8 @@ repeat_connection_package_raw_inbuf:
     cell.length = amount_to_process;
   }
 
-  if(connection_fetch_from_buf(cell.payload, cell.length, conn) < 0)
+  if(connection_fetch_from_buf(cell.payload+TOPIC_HEADER_SIZE, 
+                               cell.length, conn) < 0)
     return -1;
 #endif
 
diff --git a/src/or/connection_edge.c b/src/or/connection_edge.c
index bc3828439..ab43798de 100644
--- a/src/or/connection_edge.c
+++ b/src/or/connection_edge.c
@@ -153,7 +153,7 @@ int connection_edge_process_data_cell(cell_t *cell, circuit_t *circ, int edge_ty
       }
 
 #ifdef USE_ZLIB
-      if(connection_decompress_to_buf(cell->payload,
+      if(connection_decompress_to_buf(cell->payload + TOPIC_HEADER_SIZE,
                                       cell->length - TOPIC_HEADER_SIZE, 
                                       conn, Z_SYNC_FLUSH) < 0) {
         log(LOG_INFO,"connection_edge_process_data_cell(): write to buf failed. Marking for close.");
@@ -161,7 +161,7 @@ int connection_edge_process_data_cell(cell_t *cell, circuit_t *circ, int edge_ty
         return 0;
       }
 #else
-      if(connection_write_to_buf(cell->payload,
+      if(connection_write_to_buf(cell->payload + TOPIC_HEADER_SIZE,
                                  cell->length - TOPIC_HEADER_SIZE, conn) < 0) {
         conn->marked_for_close = 1;
         return 0;
diff --git a/src/or/onion.c b/src/or/onion.c
index 7b288f975..2f6131e73 100644
--- a/src/or/onion.c
+++ b/src/or/onion.c
@@ -310,7 +310,6 @@ static int onion_process(circuit_t *circ) {
 int chooselen(double cw)
 {
   int len = 2;
-  int retval = 0;
   uint8_t coin;
   
   if ((cw < 0) || (cw >= 1)) /* invalid parameter */

