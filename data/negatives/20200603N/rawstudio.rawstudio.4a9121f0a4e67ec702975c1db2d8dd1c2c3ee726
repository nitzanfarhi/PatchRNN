commit 4a9121f0a4e67ec702975c1db2d8dd1c2c3ee726
Author: post <klauspost@gmail.com>
Date:   Tue Aug 17 16:59:15 2010 +0000

    Check size of TIFF images before reading them.

diff --git a/librawstudio/rs-dcp-file.c b/librawstudio/rs-dcp-file.c
index eaf2c900..2e86ed4a 100644
--- a/librawstudio/rs-dcp-file.c
+++ b/librawstudio/rs-dcp-file.c
@@ -74,7 +74,8 @@ read_file_header(RSTiff *tiff)
 	gboolean ret = TRUE;
 
 	/* Parse TIFF */
-	RS_TIFF_CLASS(rs_dcp_file_parent_class)->read_file_header(tiff);
+	if (!RS_TIFF_CLASS(rs_dcp_file_parent_class)->read_file_header(tiff))
+		return FALSE;
 
 	/* Read DCP Magic */
 	if (rs_tiff_get_ushort(tiff, 2) != 0x4352)
diff --git a/librawstudio/rs-tiff.c b/librawstudio/rs-tiff.c
index 9db2549d..b4fed1b2 100644
--- a/librawstudio/rs-tiff.c
+++ b/librawstudio/rs-tiff.c
@@ -114,6 +114,9 @@ read_file_header(RSTiff *tiff)
 	gboolean ret = TRUE;
 	guint next_ifd;
 
+	if (tiff->map_length < 16)
+		return FALSE;
+
 	/* Read endianness */
 	if ((tiff->map[0] == 'I') && (tiff->map[1] == 'I'))
 		tiff->byte_order = G_LITTLE_ENDIAN;
@@ -193,7 +196,8 @@ rs_tiff_get_ifd_entry(RSTiff *tiff, guint ifd_num, gushort tag)
 	g_assert(RS_IS_TIFF(tiff));
 
 	if (tiff->ifds == 0)
-		read_from_file(tiff);
+		if (!read_from_file(tiff))
+			return NULL;
 		
 	if (ifd_num <= tiff->num_ifd)
 		ifd = g_list_nth_data(tiff->ifds, ifd_num);

