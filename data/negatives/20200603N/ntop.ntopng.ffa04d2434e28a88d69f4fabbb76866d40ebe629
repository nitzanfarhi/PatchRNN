commit ffa04d2434e28a88d69f4fabbb76866d40ebe629
Author: Simone Mainardi <simonemainardi@gmail.com>
Date:   Thu Jun 30 18:25:27 2016 +0200

    Allows web server binding to system ports for nonpriv. users

diff --git a/include/Utils.h b/include/Utils.h
index d9e47e78..f774b3f9 100755
--- a/include/Utils.h
+++ b/include/Utils.h
@@ -50,7 +50,7 @@ class Utils {
   static bool file_exists(const char *path);
   static bool mkdir_tree(char *path);
   static const char* trend2str(ValueTrend t);
-  static void dropPrivileges();
+  static int dropPrivileges();
   static std::string base64_encode(unsigned char const* bytes_to_encode, unsigned int in_len);
   static std::string base64_decode(std::string const& encoded_string);
   static bool dumpHostToDB(IpAddress *host, LocationPolicy policy);
diff --git a/src/Utils.cpp b/src/Utils.cpp
index 7481d2b7..887e82b8 100755
--- a/src/Utils.cpp
+++ b/src/Utils.cpp
@@ -314,14 +314,14 @@ const char* Utils::trend2str(ValueTrend t) {
 
 /* **************************************************** */
 
-void Utils::dropPrivileges() {
+int Utils::dropPrivileges() {
 #ifndef WIN32
   struct passwd *pw = NULL;
   const char *username;
 
   if(getgid() && getuid()) {
     ntop->getTrace()->traceEvent(TRACE_NORMAL, "Privileges are not dropped as we're not superuser");
-    return;
+    return -1;
   }
 
   username = ntop->getPrefs()->get_user();
@@ -337,14 +337,16 @@ void Utils::dropPrivileges() {
     if((setgid(pw->pw_gid) != 0) || (setuid(pw->pw_uid) != 0)) {
       ntop->getTrace()->traceEvent(TRACE_WARNING, "Unable to drop privileges [%s]",
 				   strerror(errno));
-    } else
-      ntop->getTrace()->traceEvent(TRACE_NORMAL, "User changed to %s", username);
+      return -1;
+    }
+    ntop->getTrace()->traceEvent(TRACE_NORMAL, "User changed to %s", username);
   } else {
     ntop->getTrace()->traceEvent(TRACE_WARNING, "Unable to locate user %s", username);
+    return -1;
   }
-
   umask(0);
 #endif
+  return 0;
 }
 
 
diff --git a/src/main.cpp b/src/main.cpp
index d939d4c1..a86cc62a 100644
--- a/src/main.cpp
+++ b/src/main.cpp
@@ -263,7 +263,14 @@ int main(int argc, char *argv[])
   }
 #endif
 
-  if(prefs->do_change_user())
+  /*
+    It's safe to drop privileges now if http and https ports
+    are non-privileged. Otherwise it is necessary to delay
+    the privilege drop after the web server bind()
+   */
+  if(prefs->do_change_user()
+     && (prefs->get_http_port()  >= 1024)
+     && (prefs->get_https_port() >= 1024))
     Utils::dropPrivileges();
 
   ntop->loadGeolocation(prefs->get_docs_dir());
diff --git a/third-party/mongoose/mongoose.c b/third-party/mongoose/mongoose.c
index a784b37e..7626ec80 100644
--- a/third-party/mongoose/mongoose.c
+++ b/third-party/mongoose/mongoose.c
@@ -4489,6 +4489,11 @@ static int set_ports_option(struct mg_context *ctx) {
 			       &sa->sa,
 			       (sa->sa.sa_family == AF_INET) ? sizeof(sa->sin) : sizeof(sa->sin6))
 		) != 0 ||
+	       /*
+#if defined _UTILS_H_ && defined _NTOP_CLASS_H_
+	       (ntop->getPrefs()->do_change_user() && Utils::dropPrivileges())      ||
+#endif
+	       */
 	       (rc_listen = listen(so.sock, SOMAXCONN)) != 0) {
       cry(fc(ctx), "%s: cannot bind to %.*s: %s", __func__,
 	  (int) vec.len, vec.ptr, strerror(ERRNO));
@@ -4508,7 +4513,18 @@ static int set_ports_option(struct mg_context *ctx) {
   if (!success) {
     close_all_listening_sockets(ctx);
   }
-
+#if defined _UTILS_H_ && defined _NTOP_CLASS_H_
+  /*
+    Privileges drop may have been delayed until now, that is,
+    after the bind(). This happens when the web server needs to be
+    bound on privileged-ports < 1024. If this is the case, now
+    it's time to drop the privileges.
+   */
+  if(ntop->getPrefs()->do_change_user()
+     && ( (ntop->getPrefs()->get_http_port()   < 1024)
+       || (ntop->getPrefs()->get_https_port()  < 1024)))
+    Utils::dropPrivileges();
+#endif
   return success;
 }
 

