commit 8a7d552cb3684570491a5ecaa8b78818404ed2fb
Author: Amit Shah <amit.shah@redhat.com>
Date:   Fri Sep 9 14:30:39 2011 +0530

    balloon: Disassociate handlers from balloon device on unplug
    
    When a balloon device gets unplugged, allow the balloon handlers to be
    freed.
    
    Reported-by: Shaolong Hu <shu@redhat.com>
    Signed-off-by: Amit Shah <amit.shah@redhat.com>
    Signed-off-by: Amit Shah <amit.shah@redhat.com>
    Signed-off-by: Anthony Liguori <aliguori@us.ibm.com>

diff --git a/balloon.c b/balloon.c
index f56fdc1c4b..a2133dba75 100644
--- a/balloon.c
+++ b/balloon.c
@@ -52,6 +52,16 @@ int qemu_add_balloon_handler(QEMUBalloonEvent *event_func,
     return 0;
 }
 
+void qemu_remove_balloon_handler(void *opaque)
+{
+    if (balloon_opaque != opaque) {
+        return;
+    }
+    balloon_event_fn = NULL;
+    balloon_stat_fn = NULL;
+    balloon_opaque = NULL;
+}
+
 static int qemu_balloon(ram_addr_t target)
 {
     if (!balloon_event_fn) {
diff --git a/balloon.h b/balloon.h
index 3df14e645a..f59e2881f6 100644
--- a/balloon.h
+++ b/balloon.h
@@ -22,6 +22,7 @@ typedef void (QEMUBalloonStatus)(void *opaque, MonitorCompletion cb,
 
 int qemu_add_balloon_handler(QEMUBalloonEvent *event_func,
 			     QEMUBalloonStatus *stat_func, void *opaque);
+void qemu_remove_balloon_handler(void *opaque);
 
 void monitor_print_balloon(Monitor *mon, const QObject *data);
 int do_info_balloon(Monitor *mon, MonitorCompletion cb, void *opaque);

