commit c9463ece0c3c8511ac8a4bc593b6a25760da9bd9
Author: ellie timoney <ellie@fastmail.com>
Date:   Mon Oct 26 13:12:15 2015 +1100

    backup api: better error handling in backup_get_paths

diff --git a/backup/api.c b/backup/api.c
index ee68bde5f..5cf6ab95d 100644
--- a/backup/api.c
+++ b/backup/api.c
@@ -398,6 +398,10 @@ EXPORTED int backup_get_paths(const mbname_t *mbname,
                            userid, strlen(userid),
                            backup_path, path_len,
                            &tid);
+        if (r) cyrusdb_abort(backups_db, tid);
+        else r = cyrusdb_commit(backups_db, tid);
+
+        tid = NULL;
 
         /* if we didn't store it in the database successfully, trash the file,
          * it won't be used */
@@ -420,10 +424,10 @@ EXPORTED int backup_get_paths(const mbname_t *mbname,
     buf_appendcstr(index_fname, ".index");
 
 done:
-    if (tid)
-        cyrusdb_commit(backups_db, tid);
-    if (backups_db)
+    if (backups_db) {
+        if (tid) cyrusdb_abort(backups_db, tid);
         cyrusdb_close(backups_db);
+    }
     free(backups_db_fname);
     return r;
 }

