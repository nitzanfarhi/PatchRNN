commit 75662bad8333dd298169ee5694d44d7b45324b68
Author: Greg Banks <gnb@fastmail.fm>
Date:   Wed May 23 16:02:10 2012 +1000

    [IRIS-1553] don't begin an annotate txn in repack
    
    because we're already in one from several call levels up, and they don't
    nest.  Also improve error handling in expire() and add a debug print to
    the annotate code, inside #if DEBUG

diff --git a/imap/annotate.c b/imap/annotate.c
index 756e21e37..f48df9efd 100644
--- a/imap/annotate.c
+++ b/imap/annotate.c
@@ -3167,6 +3167,10 @@ int annotate_msg_copy(struct mailbox *oldmailbox, uint32_t olduid,
 
 int annotate_msg_expunge(struct mailbox *mailbox, uint32_t uid)
 {
+#if DEBUG
+    syslog(LOG_ERR, "annotate_msg_expunge: expunging mailbox=%s uid=%u",
+	    mailbox->name, uid);
+#endif
     return _annotate_rewrite(mailbox, uid, /*userid*/NULL,
 			     /*newmbox*/NULL,
 			     /*newuid*/0, /*newuserid*/NULL,
diff --git a/imap/cyr_expire.c b/imap/cyr_expire.c
index 83aa90a04..4795f7e27 100644
--- a/imap/cyr_expire.c
+++ b/imap/cyr_expire.c
@@ -228,7 +228,9 @@ static int expire(char *name, int matchlen __attribute__((unused)),
     r = mailbox_open_iwl(name, &mailbox);
     if (r) {
 	/* mailbox corrupt/nonexistent -- skip it */
-	syslog(LOG_WARNING, "unable to open mailbox %s", name);
+	syslog(LOG_WARNING, "unable to open mailbox %s: %s",
+	       name, error_message(r));
+	annotatemore_abort();
 	return 0;
     }
 
diff --git a/imap/mailbox.c b/imap/mailbox.c
index 38b02b796..d104b6b33 100644
--- a/imap/mailbox.c
+++ b/imap/mailbox.c
@@ -2626,9 +2626,6 @@ static int mailbox_index_repack(struct mailbox *mailbox)
 
     syslog(LOG_INFO, "Repacking mailbox %s", mailbox->name);
 
-    r = annotatemore_begin();
-    if (r) return r;
-
     r = mailbox_repack_setup(mailbox, &repack);
     if (r) goto fail;
 
@@ -2665,9 +2662,6 @@ static int mailbox_index_repack(struct mailbox *mailbox)
     r = mailbox_repack_commit(&repack);
     if (r) goto fail;
 
-    r = annotatemore_commit();
-    if (r) goto fail;
-
     return 0;
 
 fail:

