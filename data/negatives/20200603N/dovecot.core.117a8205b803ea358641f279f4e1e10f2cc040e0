commit 117a8205b803ea358641f279f4e1e10f2cc040e0
Author: Timo Sirainen <tss@iki.fi>
Date:   Thu Apr 10 23:36:09 2003 +0300

    a bit memory allocation tweaks
    
    --HG--
    branch : HEAD

diff --git a/src/lib-index/maildir/maildir-sync.c b/src/lib-index/maildir/maildir-sync.c
index 12bdd1ade..07d7b9531 100644
--- a/src/lib-index/maildir/maildir-sync.c
+++ b/src/lib-index/maildir/maildir-sync.c
@@ -300,6 +300,7 @@ static int maildir_index_sync_dir(struct mail_index *index, const char *dir,
 	const char *fname;
 	void *orig_key, *orig_value;
 	unsigned int new_count;
+	size_t size;
 	int failed, check_content_changes;
 
 	i_assert(dir != NULL);
@@ -312,7 +313,9 @@ static int maildir_index_sync_dir(struct mail_index *index, const char *dir,
 	}
 
 	/* read current messages in index into hash */
-	pool = pool_alloconly_create("maildir sync", 16384);
+	size = nearest_power(index->header->messages_count *
+			     sizeof(struct maildir_hash_rec) + 1024);
+	pool = pool_alloconly_create("maildir sync", I_MAX(size, 16384));
 	files = hash_create(default_pool, pool, index->header->messages_count*2,
 			    maildir_hash, maildir_cmp);
 

