commit e8cd4247e96bb2158ef0ae0ff20e72746b9dd32d
Author: Laurent Vivier <lvivier@redhat.com>
Date:   Tue Jul 18 12:16:32 2017 +0200

    spapr/htab: fix savevm
    
    Commit 3a38429 ("spapr: Add a "no HPT" encoding to HTAB migration stream")
    allows to migrate an empty HPT, but doesn't mark correctly the
    end of the migration stream.
    
    The end condition (value returned by htab_save_iterate())
    should be 1, whereas in 3a38429 it returns 0.
    
    The problem can be reproduced with QEMU monitor command "savevm":
    the command never stops and the disk image grows without limit.
    
    Fixes: 3a38429748aa4f74abaecf16c4c087e8a325e12a
    Signed-off-by: Laurent Vivier <lvivier@redhat.com>
    Reviewed-by: Thomas Huth <thuth@redhat.com>
    Signed-off-by: David Gibson <david@gibson.dropbear.id.au>

diff --git a/hw/ppc/spapr.c b/hw/ppc/spapr.c
index 970093e6b5..1cb09e7c64 100644
--- a/hw/ppc/spapr.c
+++ b/hw/ppc/spapr.c
@@ -1827,7 +1827,7 @@ static int htab_save_iterate(QEMUFile *f, void *opaque)
     /* Iteration header */
     if (!spapr->htab_shift) {
         qemu_put_be32(f, -1);
-        return 0;
+        return 1;
     } else {
         qemu_put_be32(f, 0);
     }

