commit ea7344c9be64216dbce8282fd99f47d427612b91
Author: Sage Weil <sage@newdream.net>
Date:   Tue Mar 24 11:14:48 2009 -0700

    mds: put pending (not added) caps in reply caps
    
    Otherwise the client thinks it had fewer caps than it has.

diff --git a/src/mds/CInode.cc b/src/mds/CInode.cc
index 8ef6d432ed..de6b098bc7 100644
--- a/src/mds/CInode.cc
+++ b/src/mds/CInode.cc
@@ -1465,6 +1465,7 @@ bool CInode::encode_inodestat(bufferlist& bl, Session *session,
       int allowed = get_caps_allowed_for_client(client);
       int issue = (cap->wanted() | likes) & allowed;
       cap->issue_norevoke(issue);
+      issue = cap->pending();
       cap->set_last_issue_stamp(g_clock.recent_now());
       cap->touch();   // move to back of session cap LRU
       e.cap.caps = issue;

