commit c8367c4cd9de512d296fc557f121be62a43987f3
Author: Ira Weiny <weiny2@llnl.gov>
Date:   Thu May 19 18:19:28 2011 -0700

    IB/mad: Return EPROTONOSUPPORT when an RDMA device lacks the QP required
    
    We had a script which was looping through the devices returned from
    ibstat and attempted to register a SMI agent on an ethernet device.
    This caused a kernel panic for IBoE devices that don't have QP0.
    
    Fix this by checking if the QP exists before using it.
    
    Signed-off-by: Ira Weiny <weiny2@llnl.gov>
    Acked-by: Sean Hefty <sean.hefty@intel.com>
    Signed-off-by: Roland Dreier <roland@purestorage.com>

diff --git a/drivers/infiniband/core/mad.c b/drivers/infiniband/core/mad.c
index 822cfdcd9f78..b4d8672a3e4e 100644
--- a/drivers/infiniband/core/mad.c
+++ b/drivers/infiniband/core/mad.c
@@ -276,6 +276,13 @@ struct ib_mad_agent *ib_register_mad_agent(struct ib_device *device,
 		goto error1;
 	}
 
+	/* Verify the QP requested is supported.  For example, Ethernet devices
+	 * will not have QP0 */
+	if (!port_priv->qp_info[qpn].qp) {
+		ret = ERR_PTR(-EPROTONOSUPPORT);
+		goto error1;
+	}
+
 	/* Allocate structures */
 	mad_agent_priv = kzalloc(sizeof *mad_agent_priv, GFP_KERNEL);
 	if (!mad_agent_priv) {

