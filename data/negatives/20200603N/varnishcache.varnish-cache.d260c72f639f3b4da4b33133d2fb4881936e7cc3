commit d260c72f639f3b4da4b33133d2fb4881936e7cc3
Author: Poul-Henning Kamp <phk@phk.freebsd.dk>
Date:   Mon Mar 16 09:48:48 2009 +0000

    Attempt even harder to get diag on cli issues
    
    
    
    git-svn-id: http://www.varnish-cache.org/svn/trunk/varnish-cache@3933 d4fa192b-c00b-0410-8231-f00ffab90ce4

diff --git a/bin/varnishtest/vtc_varnish.c b/bin/varnishtest/vtc_varnish.c
index 8fdf999f0..743ed71df 100644
--- a/bin/varnishtest/vtc_varnish.c
+++ b/bin/varnishtest/vtc_varnish.c
@@ -97,7 +97,7 @@ varnish_ask_cli(const struct varnish *v, const char *cmd, char **repl)
 	assert(i == strlen(cmd));
 	i = write(v->cli_fd, "\n", 1);
 	assert(i == 1);
-	i = cli_readres(v->cli_fd, &retval, &r, 10.0);
+	i = cli_readres(v->cli_fd, &retval, &r, 20.0);
 	if (i != 0) {
 		vtc_log(v->vl, 0, "CLI failed (%s) = %d %u %s",
 		    cmd, i, retval, r);
@@ -295,8 +295,12 @@ varnish_start(struct varnish *v)
 		return;
 	vtc_log(v->vl, 2, "Start");
 	u = varnish_ask_cli(v, "start", NULL);
+	if (vtc_error)
+		return;
 	assert(u == CLIS_OK);
 	u = varnish_ask_cli(v, "debug.xid 1000", NULL);
+	if (vtc_error)
+		return;
 	assert(u == CLIS_OK);
 }
 
diff --git a/lib/libvarnish/cli_common.c b/lib/libvarnish/cli_common.c
index 6cc2e4619..a9cdd0722 100644
--- a/lib/libvarnish/cli_common.c
+++ b/lib/libvarnish/cli_common.c
@@ -164,7 +164,9 @@ cli_readres(int fd, unsigned *status, char **ptr, double tmo)
 		*status = CLIS_COMMS;
 		if (ptr != NULL)
 			*ptr = strdup("CLI communication error (hdr)");
-		return (1);
+		if (i != 0)
+			return (i);
+		return (400);
 	}
 	assert(i == CLI_LINE0_LEN);
 	assert(res[3] == ' ');

