commit fbca66aa851d9479839276fe0445c1270679ef6f
Author: Greg Banks <gnb@fastmail.fm>
Date:   Tue Feb 21 18:10:00 2012 +1100

    Add timeval_{get,set}_double
    
    and timeval_add_double() as useful utility routines for manipulating
    struct timevals.

diff --git a/lib/util.c b/lib/util.c
index e2cfae11d..99a1eed5c 100644
--- a/lib/util.c
+++ b/lib/util.c
@@ -50,6 +50,7 @@
 #include <grp.h>
 #include <limits.h>
 #include <pwd.h>
+#include <math.h>
 #include <string.h>
 #include <stdlib.h>
 #include <syslog.h>
@@ -540,6 +541,25 @@ static int cmdtime_enabled = 0;
 static struct timeval cmdtime_start, cmdtime_end, nettime_start, nettime_end;
 static double totaltime, cmdtime, nettime;
 
+double timeval_get_double(const struct timeval *tv)
+{
+    return (double)tv->tv_sec + (double)tv->tv_usec/1000000.0;
+}
+
+void timeval_set_double(struct timeval *tv, double d)
+{
+    double sec;
+    double subsec = modf(d, &sec);
+
+    tv->tv_sec = sec;
+    tv->tv_usec = 1000000.0*subsec;
+}
+
+void timeval_add_double(struct timeval *tv, double delta)
+{
+    timeval_set_double(tv, timeval_get_double(tv) + delta);
+}
+
 double timesub(const struct timeval *start, const struct timeval *end)
 {
     return (double)(end->tv_sec - start->tv_sec) +
diff --git a/lib/util.h b/lib/util.h
index 999f1ea70..7ea359c46 100644
--- a/lib/util.h
+++ b/lib/util.h
@@ -187,6 +187,9 @@ extern void cmdtime_starttimer(void);
 extern void cmdtime_endtimer(double * cmdtime, double * nettime);
 extern void cmdtime_netstart(void);
 extern void cmdtime_netend(void);
+extern double timeval_get_double(const struct timeval *tv);
+extern void timeval_set_double(struct timeval *tv, double d);
+extern void timeval_add_double(struct timeval *tv, double delta);
 extern double timesub(const struct timeval *start, const struct timeval *end);
 
 extern clock_t sclock(void);

