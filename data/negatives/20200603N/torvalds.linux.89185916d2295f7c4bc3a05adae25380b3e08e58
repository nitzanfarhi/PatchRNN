commit 89185916d2295f7c4bc3a05adae25380b3e08e58
Author: Felipe Balbi <balbi@ti.com>
Date:   Tue Sep 15 09:49:14 2015 -0500

    usb: dwc3: gadget: clear DWC3_PENDING_REQUEST when request is queued
    
    Instead of clearing DWC3_PENDING_REQUEST when
    we start transfer, let's do it when the request
    is actually queued, that way we know for sure
    that we're clearing in the right time.
    
    Signed-off-by: Felipe Balbi <balbi@ti.com>

diff --git a/drivers/usb/dwc3/gadget.c b/drivers/usb/dwc3/gadget.c
index 2d0dc2d5c3c6..13ed16a96e37 100644
--- a/drivers/usb/dwc3/gadget.c
+++ b/drivers/usb/dwc3/gadget.c
@@ -948,7 +948,6 @@ static int __dwc3_gadget_kick_transfer(struct dwc3_ep *dep, u16 cmd_param,
 		dwc3_trace(trace_dwc3_gadget, "%s: endpoint busy", dep->name);
 		return -EBUSY;
 	}
-	dep->flags &= ~DWC3_EP_PENDING_REQUEST;
 
 	/*
 	 * If we are getting here after a short-out-packet we don't enqueue any
@@ -1117,6 +1116,10 @@ static int __dwc3_gadget_ep_queue(struct dwc3_ep *dep, struct dwc3_request *req)
 		if (ret && ret != -EBUSY)
 			dev_dbg(dwc->dev, "%s: failed to kick transfers\n",
 					dep->name);
+
+		if (!ret)
+			dep->flags &= ~DWC3_EP_PENDING_REQUEST;
+
 		return ret;
 	}
 

