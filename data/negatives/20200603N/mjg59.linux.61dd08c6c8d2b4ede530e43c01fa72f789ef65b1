commit 61dd08c6c8d2b4ede530e43c01fa72f789ef65b1
Author: Alan <alan@lxorguk.ukuu.org.uk>
Date:   Thu Jan 25 15:09:05 2007 +0000

    libata-sff: Don't call bmdma_stop on non DMA capable controllers
    
    Fixes bogus accesses to ports 0-15 with a non DMA capable controller.
    This I think should go in for 2.6.20
    
    Signed-off-by: Alan Cox <alan@redhat.com>
    Signed-off-by: Jeff Garzik <jeff@garzik.org>

diff --git a/drivers/ata/libata-sff.c b/drivers/ata/libata-sff.c
index 114fa81deb83..942aeba2940a 100644
--- a/drivers/ata/libata-sff.c
+++ b/drivers/ata/libata-sff.c
@@ -827,7 +827,8 @@ void ata_bmdma_error_handler(struct ata_port *ap)
  */
 void ata_bmdma_post_internal_cmd(struct ata_queued_cmd *qc)
 {
-	ata_bmdma_stop(qc);
+	if (qc->ap->ioaddr.bmdma_addr)
+		ata_bmdma_stop(qc);
 }
 
 #ifdef CONFIG_PCI

