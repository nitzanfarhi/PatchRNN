commit 2735739fddd8c390825114c2bc2bd12ab9cdd86c
Author: myang <myang@facebook.com>
Date:   Mon Nov 15 16:38:47 2010 -0800

    Fix crash in ~AccessLog
    
    Summary:
    This crash can happen when server is shutdown, but not always. When we
    use the /usr/sbin/cronolog to write logs, the ~AccessLog() will call pclose
    to close the FILE * (which was opened by popen). After the child process
    exits, a SIGCHLD will be sent to the parent process. Sometimes PHP code
    will set up a handler for SIGCHLD. This will install pcntl_signal_handler
    as the signal handler for SIGCHLD. When pcntl_signal_handler is invoked
    while doing ~AccessLog(), we are already in destruction stage and crash
    occurred.
    
    I added signal(SIGCHLD, SIG_DFL) to make sure SIGCHLD will not cause
    the crash.
    Task ID: #
    
    Blame Rev:
    
    Reviewers:
    qixin, hzhao
    CC:
    hphp-diffs@lists.facebook.com
    Test Plan:
    make debug www, start/stop the server many times and confirm no more crash
    ~AccessLog() involved crashes.
    
    Revert Plan:
    
    Tags:
    
    - begin *PUBLIC* platform impact section -
    Bugzilla: #
    - end platform impact -
    
    DiffCamp Revision: 182772

diff --git a/src/runtime/base/server/access_log.cpp b/src/runtime/base/server/access_log.cpp
index 03bf5f6ef0..2467d7bce1 100644
--- a/src/runtime/base/server/access_log.cpp
+++ b/src/runtime/base/server/access_log.cpp
@@ -29,6 +29,7 @@ using namespace std;
 ///////////////////////////////////////////////////////////////////////////////
 
 AccessLog::~AccessLog() {
+  signal(SIGCHLD, SIG_DFL);
   for (uint i = 0; i < m_output.size(); ++i) {
     if (m_output[i].log) {
       if (m_files[i].file[0] == '|') {

