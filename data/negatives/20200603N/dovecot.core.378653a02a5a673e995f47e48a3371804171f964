commit 378653a02a5a673e995f47e48a3371804171f964
Author: Timo Sirainen <timo.sirainen@dovecot.fi>
Date:   Sun Apr 23 17:19:36 2017 +0300

    imapc: Fix crash in mailbox_exists() when LAYOUT isn't imapc.
    
    Especially breaks LAYOUT=none.

diff --git a/src/lib-storage/index/imapc/imapc-storage.c b/src/lib-storage/index/imapc/imapc-storage.c
index 1d49020ee..ce0bb033e 100644
--- a/src/lib-storage/index/imapc/imapc-storage.c
+++ b/src/lib-storage/index/imapc/imapc-storage.c
@@ -495,6 +495,14 @@ static int
 imapc_mailbox_exists(struct mailbox *box, bool auto_boxes ATTR_UNUSED,
 		     enum mailbox_existence *existence_r)
 {
+	if (strcmp(box->list->name, MAILBOX_LIST_NAME_IMAPC) != 0) {
+		if (box->inbox_any)
+			*existence_r = MAILBOX_EXISTENCE_SELECT;
+		else
+			*existence_r = MAILBOX_EXISTENCE_NONE;
+		return 0;
+	}
+
 	enum mailbox_info_flags flags;
 
 	struct imapc_mailbox_list *list = (struct imapc_mailbox_list *)box->list;

