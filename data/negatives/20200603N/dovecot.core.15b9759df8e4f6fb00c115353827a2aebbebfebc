commit 15b9759df8e4f6fb00c115353827a2aebbebfebc
Author: Timo Sirainen <tss@iki.fi>
Date:   Tue Jul 11 19:00:08 2006 +0300

    Added hook_mailbox_opened to make it easier to hook all mailbox opens.
    
    --HG--
    branch : HEAD

diff --git a/src/lib-storage/mail-storage-private.h b/src/lib-storage/mail-storage-private.h
index e58ee3a6e..fd1f4f675 100644
--- a/src/lib-storage/mail-storage-private.h
+++ b/src/lib-storage/mail-storage-private.h
@@ -8,6 +8,9 @@
 #define MAIL_STORAGE_ERR_MAILBOX_NOT_FOUND "Mailbox doesn't exist: %s"
 #define MAIL_STORAGE_ERR_NO_PERMISSION "Permission denied"
 
+/* Called after mailbox has been opened */
+extern void (*hook_mailbox_opened)(struct mailbox *box);
+
 struct mail_storage_vfuncs {
 	void (*class_init)(void);
 	void (*class_deinit)(void);
diff --git a/src/lib-storage/mail-storage.c b/src/lib-storage/mail-storage.c
index 35de5504e..257cd40fd 100644
--- a/src/lib-storage/mail-storage.c
+++ b/src/lib-storage/mail-storage.c
@@ -27,6 +27,8 @@
 unsigned int mail_storage_module_id = 0;
 unsigned int mail_storage_mail_index_module_id = 0;
 
+void (*hook_mailbox_opened)(struct mailbox *box) = NULL;
+
 static ARRAY_DEFINE(storages, struct mail_storage *);
 
 void mail_storage_init(void)
@@ -366,7 +368,12 @@ struct mailbox *mailbox_open(struct mail_storage *storage, const char *name,
 			     struct istream *input,
 			     enum mailbox_open_flags flags)
 {
-	return storage->v.mailbox_open(storage, name, input, flags);
+	struct mailbox *box;
+
+	box = storage->v.mailbox_open(storage, name, input, flags);
+	if (hook_mailbox_opened != NULL && box != NULL)
+		hook_mailbox_opened(box);
+	return box;
 }
 
 int mailbox_close(struct mailbox **_box)

