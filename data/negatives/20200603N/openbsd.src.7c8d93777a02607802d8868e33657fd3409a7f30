commit 7c8d93777a02607802d8868e33657fd3409a7f30
Author: sthen <sthen@openbsd.org>
Date:   Sat Jul 7 12:08:07 2018 +0000

    slaacd is not interested in v4-related route messages so set the address
    family on the two socket() calls to open the routing socket, so that only
    v6-related and af-unspecific messages are seen.
    
    One of the sockets is only used for sending not receiving messages;
    shutdown the receive side to avoid receiving messages as suggested by
    claudio@.
    
    slaacd is run by default (watching for interface changes to add the
    "autoconf" flag), so has to process route messages even where IPv6
    autoconf isn't used - these changes reduce CPU use on machines processing
    large numbers of route updates (in particular full-table BGP routers).
    
    ok florian@ claudio@ benno@

diff --git a/sbin/slaacd/slaacd.c b/sbin/slaacd/slaacd.c
index 68934d122f7..fbf119cf464 100644
--- a/sbin/slaacd/slaacd.c
+++ b/sbin/slaacd/slaacd.c
@@ -1,4 +1,4 @@
-/*	$OpenBSD: slaacd.c,v 1.23 2018/06/18 16:13:45 florian Exp $	*/
+/*	$OpenBSD: slaacd.c,v 1.24 2018/07/07 12:08:07 sthen Exp $	*/
 
 /*
  * Copyright (c) 2017 Florian Obser <florian@openbsd.org>
@@ -244,8 +244,9 @@ main(int argc, char *argv[])
 	log_procinit(log_procnames[slaacd_process]);
 
 	if ((routesock = socket(PF_ROUTE, SOCK_RAW | SOCK_CLOEXEC |
-	    SOCK_NONBLOCK, 0)) < 0)
+	    SOCK_NONBLOCK, AF_INET6)) < 0)
 		fatal("route socket");
+	shutdown(SHUT_RD, routesock);
 
 	event_init();
 
@@ -304,8 +305,8 @@ main(int argc, char *argv[])
 	    sizeof(filt)) == -1)
 		fatal("ICMP6_FILTER");
 
-	if ((frontend_routesock = socket(PF_ROUTE, SOCK_RAW | SOCK_CLOEXEC, 0))
-	    < 0)
+	if ((frontend_routesock = socket(PF_ROUTE, SOCK_RAW | SOCK_CLOEXEC,
+	    AF_INET6)) < 0)
 		fatal("route socket");
 
 	rtfilter = ROUTE_FILTER(RTM_IFINFO) | ROUTE_FILTER(RTM_NEWADDR) |

