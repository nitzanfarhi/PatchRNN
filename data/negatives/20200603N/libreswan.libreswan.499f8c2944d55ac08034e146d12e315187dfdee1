commit 499f8c2944d55ac08034e146d12e315187dfdee1
Author: Antony Antony <antony@phenome.org>
Date:   Sun May 14 14:13:02 2017 +0200

    pluto: replace crypto libevent struct with pluto_event

diff --git a/programs/pluto/ikev2_parent.c b/programs/pluto/ikev2_parent.c
index ecd6281e8..145840912 100644
--- a/programs/pluto/ikev2_parent.c
+++ b/programs/pluto/ikev2_parent.c
@@ -89,7 +89,7 @@ struct ikev2_pam_helper {
 	struct ikev2_pam_helper *next;  /* set outside thread */
 	int master_fd;                  /* master's fd (-1 if none) */
 	int helper_fd;                  /* helper's fd */
-	struct pluto_event *evm;        /* callback event on master_fd. */
+	struct pluto_event *ev;         /* callback event on master_fd. */
 };
 
 static struct ikev2_pam_helper *pluto_v2_pam_helpers = NULL;
@@ -3163,7 +3163,7 @@ static void free_pam_thread_entry(struct ikev2_pam_helper **pp)
 	pfreeany(p->pam.c_name);
 	pfreeany(p->pam.ra);
 	pthread_cancel(p->tid);
-	delete_pluto_event(&p->evm);
+	delete_pluto_event(&p->ev);
 	if (p->master_fd != NULL_FD)
 		close(p->master_fd);
 	if (p->helper_fd != NULL_FD)
@@ -3306,7 +3306,7 @@ static stf_status ikev2_start_pam_authorize(struct msg_digest *md)
 	pthread_attr_destroy(&pattr);
 
 	DBG(DBG_CONTROL, DBG_log("setup IKEv2 PAM authorize helper callback for master fd %d", p->master_fd));
-	p->evm = pluto_event_add(p->master_fd, EV_READ, ikev2_pam_continue_cb,
+	p->ev = pluto_event_add(p->master_fd, EV_READ, ikev2_pam_continue_cb,
 					p, NULL, "PAM_THREAD_FD");
 
 	return STF_SUSPEND;
diff --git a/programs/pluto/pluto_crypt.c b/programs/pluto/pluto_crypt.c
index ff575f684..453a61285 100644
--- a/programs/pluto/pluto_crypt.c
+++ b/programs/pluto/pluto_crypt.c
@@ -163,7 +163,7 @@ struct pluto_crypto_worker {
 	bool pcw_dead;          /* worker is dead */
 	/*TAILQ_HEAD*/ struct req_queue pcw_active;	/* queue of tasks for this worker */
 	int pcw_work;           /* how many items in pcw_active */
-	struct event *evm;      /* pointer to master_fd event. AA_2015 free it */
+	struct pluto_event *ev; /* pointer to master_fd event. AA_2015 free it */
 };
 
 static /*TAILQ_HEAD*/ struct req_queue backlog;
@@ -936,9 +936,8 @@ static void init_crypto_helper(struct pluto_crypto_worker *w, int n)
 	w->pcw_master_fd = -1;
 	w->pcw_helpernum = n;
 
-	if (w->evm != NULL) {
-		event_del(w->evm);
-		w->evm = NULL;
+	if (w->ev != NULL) {
+		delete_pluto_event(&w->ev);
 	}
 
 	if (socketpair(PF_UNIX, SOCK_STREAM, 0, fds) != 0) {
@@ -997,8 +996,9 @@ static void init_crypto_helper(struct pluto_crypto_worker *w, int n)
 
 		DBG(DBG_CONTROL, DBG_log("setup helper callback for master fd %d",
 				w->pcw_master_fd));
-		w->evm = pluto_event_new(w->pcw_master_fd, EV_READ | EV_PERSIST,
-				handle_helper_answer_cb, w, NULL);
+		w->ev = pluto_event_add(w->pcw_master_fd, EV_READ | EV_PERSIST,
+				handle_helper_answer_cb, w, NULL,
+				"CRYPTO_HELPER_FD");
 	}
 }
 

