commit 873a447162cd671b600c80a4a7871be33a00c31e
Author: Love Hörnquist Åstrand <lha@kth.se>
Date:   Tue May 8 07:13:45 2007 +0000

    Write log entry after store is successful, rename out goto statments.
    
    
    git-svn-id: svn://svn.h5l.se/heimdal/trunk/heimdal@20612 ec53bebd-3082-4978-b11e-865c3cabbd6b

diff --git a/lib/kadm5/delete_s.c b/lib/kadm5/delete_s.c
index 4933470eb..65d97e2cb 100644
--- a/lib/kadm5/delete_s.c
+++ b/lib/kadm5/delete_s.c
@@ -51,22 +51,25 @@ kadm5_s_delete_principal(void *server_handle, krb5_principal princ)
     ret = context->db->hdb_fetch(context->context, context->db, princ,
 				 HDB_F_DECRYPT|HDB_F_GET_ANY, &ent);
     if(ret == HDB_ERR_NOENTRY)
-	goto out2;
+	goto out;
     if(ent.entry.flags.immutable) {
 	ret = KADM5_PROTECT_PRINCIPAL;
-	goto out;
+	goto out2;
     }
     
     ret = hdb_seal_keys(context->context, context->db, &ent.entry);
     if (ret)
-	goto out;
+	goto out2;
 
-    kadm5_log_delete (context, princ);
-    
     ret = context->db->hdb_remove(context->context, context->db, princ);
-out:
-    hdb_free_entry(context->context, &ent);
+    if (ret)
+	goto out2;
+
+    kadm5_log_delete (context, princ);
+
 out2:
+    hdb_free_entry(context->context, &ent);
+out:
     context->db->hdb_close(context->context, context->db);
     return _kadm5_error_code(ret);
 }

