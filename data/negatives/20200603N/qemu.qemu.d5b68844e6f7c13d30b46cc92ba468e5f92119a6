commit d5b68844e6f7c13d30b46cc92ba468e5f92119a6
Author: Kevin Wolf <kwolf@redhat.com>
Date:   Tue Jul 11 13:04:28 2017 +0200

    block/qapi: Use blk_all_next() for query-block
    
    This patch replaces the blk_next() loop in query-block by a
    blk_all_next() one so that we also get access to BlockBackends that
    aren't owned by the monitor. For now, the next thing we do is check
    whether each BB has a name, so there is no semantic difference.
    
    Signed-off-by: Kevin Wolf <kwolf@redhat.com>
    Reviewed-by: Eric Blake <eblake@redhat.com>
    Reviewed-by: John Snow <jsnow@redhat.com>

diff --git a/block/qapi.c b/block/qapi.c
index c8a45ec54c..164dd2b9a9 100644
--- a/block/qapi.c
+++ b/block/qapi.c
@@ -472,8 +472,14 @@ BlockInfoList *qmp_query_block(Error **errp)
     BlockBackend *blk;
     Error *local_err = NULL;
 
-    for (blk = blk_next(NULL); blk; blk = blk_next(blk)) {
-        BlockInfoList *info = g_malloc0(sizeof(*info));
+    for (blk = blk_all_next(NULL); blk; blk = blk_all_next(blk)) {
+        BlockInfoList *info;
+
+        if (!*blk_name(blk)) {
+            continue;
+        }
+
+        info = g_malloc0(sizeof(*info));
         bdrv_query_info(blk, &info->value, &local_err);
         if (local_err) {
             error_propagate(errp, local_err);

