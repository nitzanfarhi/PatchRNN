commit 391567f479f56c2ae7c2beb9eb5305f5c02f5d82
Author: Lennart Poettering <lennart@poettering.net>
Date:   Fri Jul 3 12:30:53 2015 +0200

    Revert "nspawn: determine_uid_shift before forking"

diff --git a/src/nspawn/nspawn.c b/src/nspawn/nspawn.c
index 7fa098bea..df341a6e7 100644
--- a/src/nspawn/nspawn.c
+++ b/src/nspawn/nspawn.c
@@ -4313,6 +4313,10 @@ static int outer_child(
         if (r < 0)
                 return r;
 
+        r = determine_uid_shift(directory);
+        if (r < 0)
+                return r;
+
         /* Turn directory into bind mount */
         if (mount(directory, directory, NULL, MS_BIND|MS_REC, NULL) < 0)
                 return log_error_errno(errno, "Failed to make bind mount: %m");
@@ -4491,10 +4495,6 @@ int main(int argc, char *argv[]) {
         if (r < 0)
                 goto finish;
 
-        r = determine_uid_shift(arg_directory);
-        if (r < 0)
-                return r;
-
         if (geteuid() != 0) {
                 log_error("Need to be root.");
                 r = -EPERM;

