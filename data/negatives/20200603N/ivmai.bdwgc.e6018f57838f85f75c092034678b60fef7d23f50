commit e6018f57838f85f75c092034678b60fef7d23f50
Author: Ivan Maidanski <ivmai@mail.ru>
Date:   Sun Aug 25 09:59:42 2013 +0400

    Use __builtin_extract_return_addr in GC_RETURN_ADDR_PARENT (gcc/x86)
    
    * include/gc_config_macros.h (GC_RETURN_ADDR_PARENT): Use
    __builtin_extract_return_addr (since the address passed to dladdr);
    do not define the macro for GCC pre-v4.

diff --git a/include/gc_config_macros.h b/include/gc_config_macros.h
index e6525933..7e967571 100644
--- a/include/gc_config_macros.h
+++ b/include/gc_config_macros.h
@@ -323,9 +323,10 @@
     /* gcc knows how to retrieve return address, but we don't know      */
     /* how to generate call stacks.                                     */
 #   define GC_RETURN_ADDR (GC_word)__builtin_return_address(0)
-#   if defined(__i386__) || defined(__amd64__) \
-       || defined(__x86_64__) /* and probably others... */
-#     define GC_RETURN_ADDR_PARENT (GC_word)__builtin_return_address(1)
+#   if (__GNUC__ >= 4) && (defined(__i386__) || defined(__amd64__) \
+        || defined(__x86_64__) /* and probably others... */)
+#     define GC_RETURN_ADDR_PARENT \
+        (GC_word)__builtin_extract_return_addr(__builtin_return_address(1))
 #   endif
 # else
     /* Just pass 0 for gcc compatibility.       */

