commit 39aa3e99ea06c590dfa50b8683d93d42cf6bd57c
Author: tomas@whalegate.ndb.mysql.com <>
Date:   Thu May 24 16:40:05 2007 +0200

    Bug #28653      Fast GCP + high load + high RedoBuffer causes ndbrequire
    - parameterize on RedoBuffer

diff --git a/storage/ndb/src/kernel/blocks/dblqh/Dblqh.hpp b/storage/ndb/src/kernel/blocks/dblqh/Dblqh.hpp
index 3fc8891c082..0f88933f617 100644
--- a/storage/ndb/src/kernel/blocks/dblqh/Dblqh.hpp
+++ b/storage/ndb/src/kernel/blocks/dblqh/Dblqh.hpp
@@ -2678,7 +2678,8 @@ private:
   UintR cfirstfreeLogFile;
   UintR clogFileFileSize;
 
-#define ZLFO_FILE_SIZE 256            /* MAX 256 OUTSTANDING FILE OPERATIONS */
+#define ZLFO_MIN_FILE_SIZE 256
+// RedoBuffer/32K minimum ZLFO_MIN_FILE_SIZE
   LogFileOperationRecord *logFileOperationRecord;
   LogFileOperationRecordPtr lfoPtr;
   UintR cfirstfreeLfo;
@@ -2695,7 +2696,7 @@ private:
   UintR cfirstfreePageRef;
   UintR cpageRefFileSize;
 
-#define ZSCANREC_FILE_SIZE 100
+// Configurable
   ArrayPool<ScanRecord> c_scanRecordPool;
   ScanRecordPtr scanptr;
   UintR cscanNoFreeRec;
diff --git a/storage/ndb/src/kernel/blocks/dblqh/DblqhInit.cpp b/storage/ndb/src/kernel/blocks/dblqh/DblqhInit.cpp
index 8ddb96f9111..8aaf86de73a 100644
--- a/storage/ndb/src/kernel/blocks/dblqh/DblqhInit.cpp
+++ b/storage/ndb/src/kernel/blocks/dblqh/DblqhInit.cpp
@@ -30,11 +30,11 @@ void Dblqh::initData()
   cgcprecFileSize = ZGCPREC_FILE_SIZE;
   chostFileSize = MAX_NDB_NODES;
   clcpFileSize = ZNO_CONCURRENT_LCP;
-  clfoFileSize = ZLFO_FILE_SIZE;
+  clfoFileSize = 0;
   clogFileFileSize = 0;
   clogPartFileSize = ZLOG_PART_FILE_SIZE;
   cpageRefFileSize = ZPAGE_REF_FILE_SIZE;
-  cscanrecFileSize = ZSCANREC_FILE_SIZE;
+  cscanrecFileSize = 0;
   ctabrecFileSize = 0;
   ctcConnectrecFileSize = 0;
   ctcNodeFailrecFileSize = MAX_NDB_NODES;
diff --git a/storage/ndb/src/kernel/blocks/dblqh/DblqhMain.cpp b/storage/ndb/src/kernel/blocks/dblqh/DblqhMain.cpp
index 6c99e8d0e13..35a53aae1c0 100644
--- a/storage/ndb/src/kernel/blocks/dblqh/DblqhMain.cpp
+++ b/storage/ndb/src/kernel/blocks/dblqh/DblqhMain.cpp
@@ -992,6 +992,11 @@ void Dblqh::execREAD_CONFIG_REQ(Signal* signal)
   ndb_mgm_get_int_parameter(p, CFG_DB_REDO_BUFFER,  
 			    &log_page_size);
 
+  /* maximum number of log file operations */
+  clfoFileSize = (log_page_size+32768-1)/32768;
+  if (clfoFileSize < ZLFO_MIN_FILE_SIZE)
+    clfoFileSize = ZLFO_MIN_FILE_SIZE;
+
   /**
    * Always set page size in half MBytes
    */

