commit ba60dbe2411397051d72805b8686cbaa57cd2729
Author: Bron Gondwana <brong@opera.com>
Date:   Mon Nov 29 11:59:05 2010 +1100

    Bug 3355 - abort immediately if record missing on the replica

diff --git a/imap/sync_server.c b/imap/sync_server.c
index 70805573e..a92931919 100644
--- a/imap/sync_server.c
+++ b/imap/sync_server.c
@@ -1172,7 +1172,6 @@ static int do_mailbox(struct dlist *kin,
     uint32_t newcrc;
     struct dlist *kr;
     struct dlist *ki;
-    int found;
     uint32_t recno;
     int r;
 
@@ -1267,44 +1266,65 @@ static int do_mailbox(struct dlist *kin,
 	    syslog(LOG_ERR, "Failed to parse uploaded record"); 
 	    goto done;
 	}
-	found = 0;
-	while (!found && recno <= old_num_records) {
+
+	while (rrecord.uid < mrecord.uid) {
+	    /* hit the end?  Magic marker */
+	    if (recno > mailbox->i.num_records) {
+		rrecord.uid = UINT32_MAX;
+		break;
+	    }
+
+	    /* read another record */
 	    r = mailbox_read_index_record(mailbox, recno, &rrecord);
 	    if (r) {
 		syslog(LOG_ERR, "Failed to read record %s %d",
 		       mboxname, recno);
 		goto done;
 	    }
+	    recno++;
 
-	    /* copy the interesting fields out */
-	    if (rrecord.uid == mrecord.uid) {
-		/* GUID mismatch on a non-expunged record is an error straight away */
-		if (!(mrecord.system_flags & FLAG_EXPUNGED) &&
-		    !message_guid_compare(&mrecord.guid, &rrecord.guid)) {
-		    r = IMAP_MAILBOX_CRC;
-		    goto done;
-		}
-		rrecord.modseq = mrecord.modseq;
-		rrecord.last_updated = mrecord.last_updated;
-		rrecord.internaldate = mrecord.internaldate;
-		rrecord.system_flags = (mrecord.system_flags & ~FLAG_UNLINKED) |
-				       (rrecord.system_flags & FLAG_UNLINKED);
-		for (i = 0; i < MAX_USER_FLAGS/32; i++)
-		    rrecord.user_flags[i] = mrecord.user_flags[i];
-		rrecord.silent = 1;
-		r = mailbox_rewrite_index_record(mailbox, &rrecord);
-		if (r) {
-		    syslog(LOG_ERR, "Failed to rewrite record %s %d",
-			   mboxname, recno);
-		    goto done;
-		}
-		found = 1;
+	    /* usual case, no stale records here, great */
+	    if (rrecord.uid >= mrecord.uid) break;
+
+	    /* otherwise, if it's expunged, that's OK */
+	    if (rrecord.system_flags & FLAG_EXPUNGED)
+		continue;
+
+	    /* Otherwise we want to abort and fix up */
+	    r = IMAP_MAILBOX_CRC;
+	    goto done;
+	}
+
+	/* found a match, check for updates */
+	if (rrecord.uid == mrecord.uid) {
+	    /* GUID mismatch on a non-expunged record is an error straight away */
+	    if (!(mrecord.system_flags & FLAG_EXPUNGED) &&
+		!message_guid_compare(&mrecord.guid, &rrecord.guid)) {
+		r = IMAP_MAILBOX_CRC;
+		goto done;
 	    }
-	    recno++;
+	    /* higher modseq on the replica is an error */
+	    if (rrecord.modseq > mrecord.modseq) {
+		r = IMAP_MAILBOX_CRC;
+		goto done;
+	    }
+	    rrecord.modseq = mrecord.modseq;
+	    rrecord.last_updated = mrecord.last_updated;
+	    rrecord.internaldate = mrecord.internaldate;
+	    rrecord.system_flags = (mrecord.system_flags & ~FLAG_UNLINKED) |
+				   (rrecord.system_flags & FLAG_UNLINKED);
+	    for (i = 0; i < MAX_USER_FLAGS/32; i++)
+		rrecord.user_flags[i] = mrecord.user_flags[i];
+	    rrecord.silent = 1;
+	    r = mailbox_rewrite_index_record(mailbox, &rrecord);
+	    if (r) {
+		syslog(LOG_ERR, "Failed to rewrite record %s %d",
+		       mboxname, recno);
+		goto done;
+	    }
+	    /* all done, move on to next records */
+	    continue;
 	}
-	if (found) continue;
-	if (rrecord.uid >= mrecord.uid)
-	    continue; /* guess it got UNLINKED along the way... */
 
 	/* not found and less than LAST_UID, bogus */
 	if (mrecord.uid <= mailbox->i.last_uid) {
@@ -1316,6 +1336,7 @@ static int do_mailbox(struct dlist *kin,
 	    goto done;
 	}
 
+	/* after LAST_UID, it's an append, that's OK */
 	mrecord.silent = 1;
 	r = sync_append_copyfile(mailbox, &mrecord);
 	if (r) {

