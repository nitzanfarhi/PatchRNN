commit ea6bb99ed5860c8906f2ae281da391227f1f027c
Author: Edward Cree <ecree@solarflare.com>
Date:   Mon Jun 15 18:27:54 2015 +0100

    sfc: mark state UNINIT after unregister
    
    Without this change, modprobe -r sfc hits the BUG_ON() in
    efx_pci_remove_main().
    
    Fixes: e7fef9b45ae1 ("sfc: add sysfs entry to control MCDI tracing")
    Reported-by: Jarod Wilson <jarod@redhat.com>
    Reviewed-by: Jarod Wilson <jarod@redhat.com>
    Signed-off-by: Edward Cree <ecree@solarflare.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

diff --git a/drivers/net/ethernet/sfc/efx.c b/drivers/net/ethernet/sfc/efx.c
index 0c42ed9c9e4c..67bdaf39dce5 100644
--- a/drivers/net/ethernet/sfc/efx.c
+++ b/drivers/net/ethernet/sfc/efx.c
@@ -2920,6 +2920,7 @@ static void efx_pci_remove(struct pci_dev *pci_dev)
 	efx_dissociate(efx);
 	dev_close(efx->net_dev);
 	efx_disable_interrupts(efx);
+	efx->state = STATE_UNINIT;
 	rtnl_unlock();
 
 	if (efx->type->sriov_fini)

