commit 84e5b8750d1b7027b61c659780aa8951d0593d9e
Author: Thomas Roessler <roessler@does-not-exist.org>
Date:   Tue May 18 12:01:27 1999 +0000

    The current code wasn't asking for the capabilities of the server in
    the case where the user is using PREAUTH.

diff --git a/imap.c b/imap.c
index 9d609535d..a90d7f340 100644
--- a/imap.c
+++ b/imap.c
@@ -1337,7 +1337,16 @@ static int imap_open_connection (IMAP_DATA *idata, CONNECTION *conn)
       return (-1);
     }
   }
-  else if (mutt_strncmp ("* PREAUTH", buf, 9) != 0)
+  else if (mutt_strncmp ("* PREAUTH", buf, 9) == 0)
+  {
+    if (imap_check_capabilities(idata) != 0)
+    {
+      close (conn->fd);
+      idata->state = IMAP_DISCONNECTED;
+      return (-1);
+    }
+  } 
+  else
   {
     imap_error ("imap_open_connection()", buf);
     close (conn->fd);

