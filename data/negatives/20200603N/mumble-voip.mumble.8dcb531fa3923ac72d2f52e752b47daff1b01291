commit 8dcb531fa3923ac72d2f52e752b47daff1b01291
Author: Mikkel Krautz <mikkel@krautz.dk>
Date:   Fri Nov 6 20:10:58 2009 +0100

    Catch and handle kCGEventTapDisabledByTimeout Snow Leopard behavior in GlobalShortcutMac.

diff --git a/src/mumble/GlobalShortcut_macx.cpp b/src/mumble/GlobalShortcut_macx.cpp
index 09dd2522..661e8ada 100644
--- a/src/mumble/GlobalShortcut_macx.cpp
+++ b/src/mumble/GlobalShortcut_macx.cpp
@@ -77,8 +77,8 @@ GlobalShortcutEngine *GlobalShortcutEngine::platformInit() {
 	return new GlobalShortcutMac();
 }
 
-CGEventRef EventTapCallback(CGEventTapProxy proxy, CGEventType type,
-                            CGEventRef event, void *udata) {
+CGEventRef GlobalShortcutMac::callback(CGEventTapProxy proxy, CGEventType type,
+                                       CGEventRef event, void *udata) {
 	GlobalShortcutMac *gs = reinterpret_cast<GlobalShortcutMac *>(udata);
 	unsigned int keycode;
 	bool suppress = false;
@@ -115,11 +115,24 @@ CGEventRef EventTapCallback(CGEventTapProxy proxy, CGEventType type,
 			break;
 
 		case kCGEventTapDisabledByTimeout:
-			qWarning("GlobalShortcutMac: EventTap disabled by timeout.");
+			qWarning("GlobalShortcutMac: EventTap disabled by timeout. Re-enabling.");
+			/*
+			 * On Snow Leopard, we get this event type quite often. It disables our event
+			 * tap completely. Possible Apple bug.
+			 *
+			 * For now, simply call CGEventTapEnable() to enable our event tap again.
+			 *
+			 * See: http://lists.apple.com/archives/quartz-dev/2009/Sep/msg00007.html
+			 */
+			CGEventTapEnable(gs->port, true);
 			break;
 		case kCGEventTapDisabledByUserInput:
 			qWarning("GlobalShortcutMac: EventTap disabled by user input.");
 			break;
+
+		default:
+			qWarning("GlobalShortcutMac: Unknown event intercepted.");
+			break;
 	}
 
 	return suppress ? NULL : event;
@@ -145,7 +158,7 @@ GlobalShortcutMac::GlobalShortcutMac() : modmask(0) {
 
 	port = CGEventTapCreate(kCGSessionEventTap,
 	                        kCGHeadInsertEventTap,
-	                        0, evmask, EventTapCallback,
+	                        0, evmask, GlobalShortcutMac::callback,
 	                        this);
 
 	if (! port) {
diff --git a/src/mumble/GlobalShortcut_macx.h b/src/mumble/GlobalShortcut_macx.h
index 3947e51b..d71f79db 100644
--- a/src/mumble/GlobalShortcut_macx.h
+++ b/src/mumble/GlobalShortcut_macx.h
@@ -66,6 +66,8 @@ class GlobalShortcutMac : public GlobalShortcutEngine {
 		UCKeyboardLayout *kbdLayout;
 
 		void run();
+
+		static CGEventRef callback(CGEventTapProxy proxy, CGEventType type, CGEventRef event, void *udata);
 		QString translateMouseButton(const unsigned int keycode) const;
 		QString translateModifierKey(const unsigned int keycode) const;
 		QString translateKeyName(const unsigned int keycode) const;

