commit da5dd6f1141e8b134199e1a2a23af4e05173464a
Author: Timo Sirainen <tss@iki.fi>
Date:   Thu Nov 8 05:56:50 2007 +0200

    Crashfix if cache file got unusable in the middle of a transaction.
    
    --HG--
    branch : HEAD

diff --git a/src/lib-index/mail-cache-transaction.c b/src/lib-index/mail-cache-transaction.c
index fe1993a7f..1c9944a90 100644
--- a/src/lib-index/mail-cache-transaction.c
+++ b/src/lib-index/mail-cache-transaction.c
@@ -828,7 +828,8 @@ void mail_cache_add(struct mail_cache_transaction_ctx *ctx, uint32_t seq,
 		mail_cache_transaction_open_if_needed(ctx);
 		if (!MAIL_CACHE_IS_UNUSABLE(ctx->cache))
 			ctx->cache_file_seq = ctx->cache->hdr->file_seq;
-	} else if (ctx->cache_file_seq != ctx->cache->hdr->file_seq) {
+	} else if (!MAIL_CACHE_IS_UNUSABLE(ctx->cache) &&
+		   ctx->cache_file_seq != ctx->cache->hdr->file_seq) {
 		/* cache was compressed within this transaction */
 		mail_cache_transaction_reset(ctx);
 	}

