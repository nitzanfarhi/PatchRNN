commit 7204bad11e2b0f4eccf6417b3cf1913a1a4c5d9e
Author: andrewparoski <andrew.paroski@fb.com>
Date:   Tue Mar 1 18:17:54 2011 -0800

    Fix end() to clear the IterationDirty flag
    
    Summary:
    HPHP has an IterationDirty flag inside ZendArray to detect when foreach
    loops are mixed with current(), each(), key(), value(), prev() and next()
    so that it can raise a notice.
    
    Currently we are clearing the IterationDirty flag when reset() is called,
    but we are failing to clear it when end() is called. This revision fixes
    end() to correctly clear the IterationDirty flag.
    
    Test Plan:
    make fast_tests
    Write a PHP program to exercise this and verify the fix works
    
    Differential Revision: 218459
    Reviewed By: qixin
    Reviewers: qixin, mwilliams
    CC: qixin
    Revert Plan:
    OK

diff --git a/src/runtime/ext/ext_array.h b/src/runtime/ext/ext_array.h
index cfc8bdaf8f..7bf902b93d 100644
--- a/src/runtime/ext/ext_array.h
+++ b/src/runtime/ext/ext_array.h
@@ -310,6 +310,7 @@ inline Variant f_reset(Variant array) {
   return array.array_iter_reset();
 }
 inline Variant f_end(Variant array) {
+  array.array_iter_dirty_reset();
   return array.array_iter_end();
 }
 inline Variant f_key(Variant array) {

