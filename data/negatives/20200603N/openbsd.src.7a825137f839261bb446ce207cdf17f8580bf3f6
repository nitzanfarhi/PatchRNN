commit 7a825137f839261bb446ce207cdf17f8580bf3f6
Author: guenther <guenther@openbsd.org>
Date:   Mon Jul 9 23:06:07 2012 +0000

    The linux emulation exit hook needs to be able to sleep, so call it
    before changing p_stat to SDEAD
    
    ok pirofti@

diff --git a/sys/kern/kern_exit.c b/sys/kern/kern_exit.c
index 57c88ff8aca..22700dffbec 100644
--- a/sys/kern/kern_exit.c
+++ b/sys/kern/kern_exit.c
@@ -1,4 +1,4 @@
-/*	$OpenBSD: kern_exit.c,v 1.115 2012/04/14 14:26:39 kettenis Exp $	*/
+/*	$OpenBSD: kern_exit.c,v 1.116 2012/07/09 23:06:07 guenther Exp $	*/
 /*	$NetBSD: kern_exit.c,v 1.39 1996/04/22 01:38:25 christos Exp $	*/
 
 /*
@@ -244,6 +244,13 @@ exit1(struct proc *p, int rv, int flags)
 	if (ISSET(p->p_flag, P_SYSTRACE))
 		systrace_exit(p);
 #endif
+
+	/*
+	 * If emulation has process exit hook, call it now.
+	 */
+	if (p->p_emul->e_proc_exit)
+		(*p->p_emul->e_proc_exit)(p);
+
         /*
          * Remove proc from pidhash chain so looking it up won't
          * work.  Move it from allproc to zombproc, but do not yet
@@ -339,12 +346,6 @@ exit1(struct proc *p, int rv, int flags)
 	 * Other substructures are freed from reaper and wait().
 	 */
 
-	/*
-	 * If emulation has process exit hook, call it now.
-	 */
-	if (p->p_emul->e_proc_exit)
-		(*p->p_emul->e_proc_exit)(p);
-
 	/*
 	 * Finally, call machine-dependent code to switch to a new
 	 * context (possibly the idle context).  Once we are no longer

