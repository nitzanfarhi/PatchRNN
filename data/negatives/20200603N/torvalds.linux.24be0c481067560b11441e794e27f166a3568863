commit 24be0c481067560b11441e794e27f166a3568863
Author: Sage Weil <sage@newdream.net>
Date:   Tue Jan 18 08:48:06 2011 -0800

    ceph: fix erroneous cap flush to non-auth mds
    
    The int flushing is global and not clear on each iteration of the loop,
    which can cause a second flush of caps to any MDSs with ids greater than
    the auth.
    
    Signed-off-by: Sage Weil <sage@newdream.net>

diff --git a/fs/ceph/caps.c b/fs/ceph/caps.c
index 60d27bc9eb83..f654c7e933ac 100644
--- a/fs/ceph/caps.c
+++ b/fs/ceph/caps.c
@@ -1658,6 +1658,8 @@ void ceph_check_caps(struct ceph_inode_info *ci, int flags,
 
 		if (cap == ci->i_auth_cap && ci->i_dirty_caps)
 			flushing = __mark_caps_flushing(inode, session);
+		else
+			flushing = 0;
 
 		mds = cap->mds;  /* remember mds, so we don't repeat */
 		sent++;

