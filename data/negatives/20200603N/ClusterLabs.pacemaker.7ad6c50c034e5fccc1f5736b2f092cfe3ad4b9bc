commit 7ad6c50c034e5fccc1f5736b2f092cfe3ad4b9bc
Author: Andrew Beekhof <andrew@beekhof.net>
Date:   Tue Mar 16 12:06:47 2004 +0000

    * Perform an ACK for accepted clients
    * Clients that fail the to be accepted are NACK'd by means of destroying
      their channel
    * Add the ability to CC the DC on a message
    
    CVS patchset: 2574
    CVS date: 2004/03/16 12:06:47
    
    Mercurial revision: 4294ca009c01a53f6295b94dbc1867ad9d7d11da

diff --git a/crm/common/msgutils.c b/crm/common/msgutils.c
index 48e9940f1..167d82b69 100644
--- a/crm/common/msgutils.c
+++ b/crm/common/msgutils.c
@@ -1,4 +1,4 @@
-/* $Id: msgutils.c,v 1.16 2004/03/16 10:46:30 andrew Exp $ */
+/* $Id: msgutils.c,v 1.17 2004/03/16 12:06:47 andrew Exp $ */
 /* 
  * Copyright (C) 2004 Andrew Beekhof <andrew@beekhof.net>
  * 
@@ -373,8 +373,7 @@ send_hello_message(IPC_Channel *ipc_client,
 	xmlNodePtr hello_node = NULL;
 	FNIN();
 	
-	if (uid == NULL || strlen(uid) == 0
-	    || client_name == NULL || strlen(client_name) == 0
+	if (client_name == NULL || strlen(client_name) == 0
 	    || major_version == NULL || strlen(major_version) == 0
 	    || minor_version == NULL || strlen(minor_version) == 0) {
 		cl_log(LOG_ERR,
@@ -383,10 +382,12 @@ send_hello_message(IPC_Channel *ipc_client,
 	}
 
 	hello_node = create_xml_node(NULL, "hello");
-	set_xml_property_copy(hello_node, "client_uuid",   uid);
-	set_xml_property_copy(hello_node, "client_name",   client_name);
 	set_xml_property_copy(hello_node, "major_version", major_version);
 	set_xml_property_copy(hello_node, "minor_version", minor_version);
+	set_xml_property_copy(hello_node, "client_name",   client_name);
+	if(uid != NULL) {
+		set_xml_property_copy(hello_node, "client_uuid",   uid);
+	}
 
 	send_xmlipc_message(ipc_client, hello_node);
 
diff --git a/crm/common/xmltags.h b/crm/common/xmltags.h
index 49e87c3d2..f50ab2ec2 100644
--- a/crm/common/xmltags.h
+++ b/crm/common/xmltags.h
@@ -1,4 +1,4 @@
-/* $Id: xmltags.h,v 1.8 2004/02/26 12:58:57 andrew Exp $ */
+/* $Id: xmltags.h,v 1.9 2004/03/16 12:06:47 andrew Exp $ */
 /* 
  * Copyright (C) 2004 Andrew Beekhof <andrew@beekhof.net>
  * 
@@ -46,6 +46,7 @@
 #define XML_ATTR_MSGTYPE		"message_type"
 #define XML_ATTR_SYSFROM		"sys_from"
 #define XML_ATTR_SYSTO			"sys_to"
+#define XML_ATTR_SYSCC			"sys_cc"
 #define XML_ATTR_HOSTFROM		"host_from"
 #define XML_ATTR_HOSTTO			"host_to"
 #define XML_ATTR_REFERENCE		"crm_msg_reference"
diff --git a/crm/crmd/messages.c b/crm/crmd/messages.c
index 333833dc4..a0b226cbc 100644
--- a/crm/crmd/messages.c
+++ b/crm/crmd/messages.c
@@ -381,6 +381,7 @@ relay_message(xmlNodePtr xml_relay_message, gboolean originated_locally)
 {
 	const char *host_to = xmlGetProp(xml_relay_message, XML_ATTR_HOSTTO);
 	const char *sys_to  = xmlGetProp(xml_relay_message, XML_ATTR_SYSTO);
+	const char *sys_cc  = xmlGetProp(xml_relay_message, XML_ATTR_SYSCC);
 	gboolean processing_complete = FALSE;
 	int is_for_dc  = 0;
 	int is_for_dcib  = 0;
@@ -426,6 +427,7 @@ relay_message(xmlNodePtr xml_relay_message, gboolean originated_locally)
 		is_local=1;
 	}
 
+/*
 	CRM_DEBUG2("is_local    %d", is_local);
 	CRM_DEBUG2("is_for_dcib %d", is_for_dcib);
 	CRM_DEBUG2("is_for_dc   %d", is_for_dc);
@@ -433,7 +435,7 @@ relay_message(xmlNodePtr xml_relay_message, gboolean originated_locally)
 	CRM_DEBUG2("AM_I_DC     %d", AM_I_DC);
 	CRM_DEBUG2("sys_to      %s", sys_to);
 	CRM_DEBUG2("host_to     %s", host_to);
-	
+*/
 
 	if(is_for_dc || is_for_dcib) {
 		if(AM_I_DC) {
@@ -457,17 +459,10 @@ relay_message(xmlNodePtr xml_relay_message, gboolean originated_locally)
 		ROUTER_RESULT("Message result: Local relay");
 		CRM_DEBUG2("Message result: Local relay to %s", sys_to);
 		send_msg_via_ipc(xml_relay_message, sys_to);
-		processing_complete = TRUE;
+		if(sys_cc == NULL || strcmp(sys_cc, CRM_SYSTEM_DC) != 0)
+			processing_complete = TRUE;
+		// else the DC should also get this message
 	} else {
-/* 		const char *sys_from  = */
-/* 			xmlGetProp(xml_relay_message, XML_ATTR_SYSFROM); */
-/* 		if(AM_I_DC && strcmp(CRM_SYSTEM_CIB, sys_from) == 0) { */
-/* 			// we are a special CIB */
-/* 			xmlSetProp(xml_relay_message, */
-/* 				   XML_ATTR_SYSFROM, */
-/* 				   CRM_SYSTEM_DCIB); */
-/* 		} */
-
 		ROUTER_RESULT("Message result: External relay");
 		CRM_DEBUG2("Message result: External relay to %s", host_to);
 
@@ -629,10 +624,16 @@ crmd_authorize_message(xmlNodePtr root_xml_node,
 		g_hash_table_insert (ipc_clients,
 				     table_key,
 				     curr_client->client_channel);
-	} else
-		CRM_DEBUG("Rejected client logon request");
-
 
+		send_hello_message(curr_client->client_channel,
+				   NULL, CRM_SYSTEM_CRMD,
+				   "0", "1");
+	} else {
+		CRM_DEBUG("Rejected client logon request");
+		curr_client->client_channel->ops->destroy(
+			curr_client->client_channel);
+	}
+	
 	if(uid != NULL) ha_free(uid);
 	if(client_name != NULL) ha_free(client_name);
 	

