commit df97729f1bcb5055ba414f08b48364d46c6baef0
Author: Imre Deak <imre.deak@intel.com>
Date:   Tue May 21 20:03:17 2013 +0300

    drm/i915: add msecs_to_jiffies_timeout to guarantee minimum duration
    
    We need this to avoid premature timeouts whenever scheduling a timeout
    based on the current jiffies value. For an explanation see [1].
    The following patches will take the helper into use.
    
    Once the more generic solution proposed in the thread at [1] is accepted
    this patch can be reverted while keeping the follow-up patches.
    
    [1] http://marc.info/?l=linux-kernel&m=136854294730957&w=2
    
    Signed-off-by: Imre Deak <imre.deak@intel.com>
    Signed-off-by: Daniel Vetter <daniel.vetter@ffwll.ch>

diff --git a/drivers/gpu/drm/i915/i915_drv.h b/drivers/gpu/drm/i915/i915_drv.h
index d5dcf7fe1ee9..b9d00dcf9a2d 100644
--- a/drivers/gpu/drm/i915/i915_drv.h
+++ b/drivers/gpu/drm/i915/i915_drv.h
@@ -1943,4 +1943,19 @@ static inline void __user *to_user_ptr(u64 address)
 	return (void __user *)(uintptr_t)address;
 }
 
+static inline unsigned long msecs_to_jiffies_timeout(const unsigned int m)
+{
+	unsigned long j = msecs_to_jiffies(m);
+
+	return min_t(unsigned long, MAX_JIFFY_OFFSET, j + 1);
+}
+
+static inline unsigned long
+timespec_to_jiffies_timeout(const struct timespec *value)
+{
+	unsigned long j = timespec_to_jiffies(value);
+
+	return min_t(unsigned long, MAX_JIFFY_OFFSET, j + 1);
+}
+
 #endif

