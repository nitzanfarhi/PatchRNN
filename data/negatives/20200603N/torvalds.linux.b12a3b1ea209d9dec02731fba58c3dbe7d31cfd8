commit b12a3b1ea209d9dec02731fba58c3dbe7d31cfd8
Author: Chris Mason <chris.mason@fusionio.com>
Date:   Tue Aug 7 15:34:49 2012 -0400

    Btrfs: don't run __tree_mod_log_free_eb on leaves
    
    When we split a leaf, we may end up inserting a new root on top of that
    leaf.  The reflog code was incorrectly assuming the old root was always
    a node.  This makes sure we skip over leaves.
    
    Signed-off-by: Chris Mason <chris.mason@fusionio.com>

diff --git a/fs/btrfs/ctree.c b/fs/btrfs/ctree.c
index 08e0b11ba0a1..6d183f60d63a 100644
--- a/fs/btrfs/ctree.c
+++ b/fs/btrfs/ctree.c
@@ -625,6 +625,9 @@ __tree_mod_log_free_eb(struct btrfs_fs_info *fs_info, struct extent_buffer *eb)
 	u32 nritems;
 	int ret;
 
+	if (btrfs_header_level(eb) == 0)
+		return;
+
 	nritems = btrfs_header_nritems(eb);
 	for (i = nritems - 1; i >= 0; i--) {
 		ret = tree_mod_log_insert_key_locked(fs_info, eb, i,

