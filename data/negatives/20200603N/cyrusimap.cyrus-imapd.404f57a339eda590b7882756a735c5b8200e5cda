commit 404f57a339eda590b7882756a735c5b8200e5cda
Author: Bron Gondwana <brong@opera.com>
Date:   Thu Dec 1 12:48:27 2011 +0100

    cache: if fd has gone away, make sure mmap is clean too
    
    This is not a bug, just a bit tidier.  I don't know a codepath that could get here.

diff --git a/imap/mailbox.c b/imap/mailbox.c
index 9d7579d06..87462a2e8 100644
--- a/imap/mailbox.c
+++ b/imap/mailbox.c
@@ -477,6 +477,10 @@ int mailbox_ensure_cache(struct mailbox *mailbox, unsigned offset)
 	mailbox->cache_fd = open(fname, openflags, 0);
 	if (mailbox->cache_fd == -1)
 	    goto fail;
+
+	if (mailbox->cache_buf.s)
+	    map_free((const char **)&mailbox->cache_buf.s, &mailbox->cache_len);
+	mailbox->cache_buf.len = 0;
     }
 
     if (offset >= mailbox->cache_buf.len) {

