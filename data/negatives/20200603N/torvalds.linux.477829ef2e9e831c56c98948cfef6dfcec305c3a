commit 477829ef2e9e831c56c98948cfef6dfcec305c3a
Author: Mandy Kirkconnell <alkirkco@sgi.com>
Date:   Fri Jun 9 17:13:04 2006 +1000

    [XFS] Fix nused counter.  It's currently getting set to -1 rather than
    getting decremented by 1.  Since nused never reaches 0, the "if
    (!free->hdr.nused)" check in xfs_dir2_leafn_remove() fails every time and
    xfs_dir2_shrink_inode() doesn't get called when it should.  This causes
    extra blocks to be left on an empty directory and the directory in unable
    to be converted back to inline extent mode.
    
    SGI-PV: 951958
    SGI-Modid: xfs-linux-melb:xfs-kern:211382a
    
    Signed-off-by: Mandy Kirkconnell <alkirkco@sgi.com>
    Signed-off-by: Nathan Scott <nathans@sgi.com>

diff --git a/fs/xfs/xfs_dir2_node.c b/fs/xfs/xfs_dir2_node.c
index a8d483c0a84c..b1f85cc7795a 100644
--- a/fs/xfs/xfs_dir2_node.c
+++ b/fs/xfs/xfs_dir2_node.c
@@ -972,7 +972,7 @@ xfs_dir2_leafn_remove(
 			/*
 			 * One less used entry in the free table.
 			 */
-			free->hdr.nused = cpu_to_be32(-1);
+			be32_add(&free->hdr.nused, -1);
 			xfs_dir2_free_log_header(tp, fbp);
 			/*
 			 * If this was the last entry in the table, we can

