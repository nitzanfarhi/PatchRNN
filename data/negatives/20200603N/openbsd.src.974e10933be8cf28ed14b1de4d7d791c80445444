commit 974e10933be8cf28ed14b1de4d7d791c80445444
Author: mickey <mickey@openbsd.org>
Date:   Wed Jan 29 20:32:23 2003 +0000

    make it work on both yamaha and ensoniq mpus; from hunter@dg.net.ua

diff --git a/sys/dev/isa/mpu_isa.c b/sys/dev/isa/mpu_isa.c
index 2982e0be40d..d273c8016ec 100644
--- a/sys/dev/isa/mpu_isa.c
+++ b/sys/dev/isa/mpu_isa.c
@@ -1,4 +1,4 @@
-/*	$OpenBSD: mpu_isa.c,v 1.1 2002/11/28 23:24:53 mickey Exp $	*/
+/*	$OpenBSD: mpu_isa.c,v 1.2 2003/01/29 20:32:23 mickey Exp $	*/
 
 /*
  * Copyright (c) 2002 Sergey Smitienko. All rights reserved.
@@ -94,18 +94,23 @@ mpu_test (iot, iobase)
 		goto done;
 
 	for (i = 0; i < MPU_MAXWAIT; i++) {
-		if (!(MPU_GETSTATUS(iot, ioh) & MPU_OUTPUT_BUSY))
-			goto done;
-		delay (10);
-	}
-	bus_space_write_1(iot, ioh, MPU_COMMAND, MPU_RESET);
-
-	for (i = 0; i < 2 * MPU_MAXWAIT; i++)
-		if (!(MPU_GETSTATUS(iot, ioh) & MPU_INPUT_EMPTY) &&
-		    bus_space_read_1(iot, ioh, MPU_DATA) == MPU_ACK) {
+		if (!MPU_GETSTATUS(iot, ioh) & MPU_OUTPUT_BUSY)) {
 			rc = 1;
 			break;
 		}
+		delay (10);
+	}
+	
+	if (rc == 1) {	
+		bus_space_write_1(iot, ioh, MPU_COMMAND, MPU_RESET);
+		rc = 0;
+		for (i = 0; i < 2 * MPU_MAXWAIT; i++)
+			if (!(MPU_GETSTATUS(iot, ioh) & MPU_INPUT_EMPTY) &&
+			    bus_space_read_1(iot, ioh, MPU_DATA) == MPU_ACK) {
+				rc = 1;
+				break;
+			}
+	}
 done:
 	bus_space_unmap(iot, ioh, MPU401_NPORT);
 

