commit 804faa200aed8a43660aead77382afb7777c22d0
Author: Greg Banks <gnb@fastmail.fm>
Date:   Fri Sep 16 14:11:29 2011 +1000

    SETMETADATA with a nonexistant mailbox name fails
    
    with "NO Mailbox does not exist" instead of silently doing nothing and
    returning "OK".

diff --git a/imap/annotate.c b/imap/annotate.c
index b709a6c38..6f4049a9a 100644
--- a/imap/annotate.c
+++ b/imap/annotate.c
@@ -1191,6 +1191,7 @@ struct apply_rock {
     void *data;
     char lastname[MAX_MAILBOX_PATH+1];
     int sawuser;
+    unsigned int nseen;
 };
 
 static int apply_cb(char *name, int matchlen,
@@ -1236,6 +1237,7 @@ static int apply_cb(char *name, int matchlen,
 	goto out;
 
     r = arock->proc(state, arock->data);
+    arock->nseen++;
 
 out:
     annotate_state_unset_scope(state);
@@ -1268,6 +1270,9 @@ int annotate_apply_mailboxes(annotate_state_t *state,
 					   state->auth_state,
 					   apply_cb, &arock);
 
+    if (!r && !arock.nseen)
+	r = IMAP_MAILBOX_NONEXISTENT;
+
     return r;
 }
 

