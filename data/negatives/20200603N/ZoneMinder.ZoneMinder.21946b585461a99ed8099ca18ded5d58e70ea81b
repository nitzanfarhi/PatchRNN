commit 21946b585461a99ed8099ca18ded5d58e70ea81b
Author: Edward Barnard <eabarnard@gmail.com>
Date:   Sat Nov 30 21:59:04 2013 +0000

    H264 SPS and PPS frames are now handled correctly

diff --git a/src/zm_remote_camera_rtsp.cpp b/src/zm_remote_camera_rtsp.cpp
index cffb91cce..9a90ac64d 100644
--- a/src/zm_remote_camera_rtsp.cpp
+++ b/src/zm_remote_camera_rtsp.cpp
@@ -261,6 +261,27 @@ int RemoteCameraRtsp::Capture( Image &image )
             if ( !buffer.size() )
                 return( -1 );
 
+            // SPS and PPS frames should be saved and appended to IDR frames
+            int nalType = (buffer.head()[3] & 0x1f);
+            if(mCodecContext->codec_id == CODEC_ID_H264)
+            {
+                if(nalType == 7)
+                {
+                    lastSps = buffer;
+                    continue;
+                }
+                else if(nalType == 8)
+                {
+                    lastPps = buffer;
+                    continue;
+                }
+                else if(nalType == 5)
+                {
+                    buffer += lastSps;
+                    buffer += lastPps;
+                }
+            }
+
             av_init_packet( &packet );
             
 	    while ( !frameComplete && buffer.size() > 0 )
diff --git a/src/zm_remote_camera_rtsp.h b/src/zm_remote_camera_rtsp.h
index 3295c9363..359fea9f4 100644
--- a/src/zm_remote_camera_rtsp.h
+++ b/src/zm_remote_camera_rtsp.h
@@ -41,6 +41,8 @@ protected:
 	int rtcp_sd;
 
 	Buffer buffer;
+    Buffer lastSps;
+    Buffer lastPps;
 
     RtspThread::RtspMethod method;
 

