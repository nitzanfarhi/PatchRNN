commit 2aaf2bf4a21ddafbaf6efb9e2d6777489b3e31d0
Author: krw <krw@openbsd.org>
Date:   Wed Oct 11 00:09:32 2017 +0000

    Repair printing of classless-static-routes to leases
    file. Broken due to incorrect translation from a netmask
    to the count of leading 1's. Use brute force counting
    until something better is found.
    
    Issue discovered and diffs tested by Anthony Coulter via
    bugs@. Thanks!

diff --git a/sbin/dhclient/options.c b/sbin/dhclient/options.c
index 40d24a3224f..0782ed22f1a 100644
--- a/sbin/dhclient/options.c
+++ b/sbin/dhclient/options.c
@@ -1,4 +1,4 @@
-/*	$OpenBSD: options.c,v 1.108 2017/09/20 16:09:42 krw Exp $	*/
+/*	$OpenBSD: options.c,v 1.109 2017/10/11 00:09:32 krw Exp $	*/
 
 /* DHCP options parsing and reassembly. */
 
@@ -588,7 +588,8 @@ pretty_print_classless_routes(unsigned char *src, size_t srclen,
 {
 	char		 bitsbuf[5];	/* to hold "/nn " */
 	struct in_addr	 dest, netmask, gateway;
-	unsigned int	 i, len;
+	unsigned int	 bits, i, len;
+	uint32_t	 m;
 	int		 rslt;
 
 	i = 0;
@@ -599,8 +600,14 @@ pretty_print_classless_routes(unsigned char *src, size_t srclen,
 			goto bad;
 		i += len;
 
-		rslt = snprintf(bitsbuf, sizeof(bitsbuf), "/%d ",
-		    33 - ffs(netmask.s_addr));
+		m = ntohl(netmask.s_addr);
+		bits = 32;
+		while ((bits > 0) && ((m & 1) == 0)) {
+			m >>= 1;
+			bits--;
+		}
+
+		rslt = snprintf(bitsbuf, sizeof(bitsbuf), "/%d ", bits);
 		if (rslt == -1 || (unsigned int)rslt >= sizeof(bitsbuf))
 			goto bad;
 

