commit 26caee5bc643b318fa2e9bd4f66dace1755ec413
Author: Josef Whiter <jwhiter@redhat.com>
Date:   Mon Jul 23 10:02:40 2007 +0100

    [GFS2] Fix calculation of demote state
    
    If a glock is in the exclusive state and a request for demote to
    deferred has been received, then further requests for demote to
    shared are being ignored. This patch fixes that by ensuring that
    we demote to unlocked in that case.
    
    Signed-off-by: Josef Whiter <jwhiter@redhat.com>
    Signed-off-by: Steven Whitehouse <swhiteho@redhat.com>

diff --git a/fs/gfs2/glock.c b/fs/gfs2/glock.c
index 6a3eeba102f9..6b6ae4537340 100644
--- a/fs/gfs2/glock.c
+++ b/fs/gfs2/glock.c
@@ -697,8 +697,9 @@ static void handle_callback(struct gfs2_glock *gl, unsigned int state, int remot
 			}
 			return;
 		}
-	} else if (gl->gl_demote_state != LM_ST_UNLOCKED) {
-		gl->gl_demote_state = state;
+	} else if (gl->gl_demote_state != LM_ST_UNLOCKED &&
+			gl->gl_demote_state != state) {
+		gl->gl_demote_state = LM_ST_UNLOCKED;
 	}
 	spin_unlock(&gl->gl_spin);
 }

