commit 20e6e55aaaa6745fbc815845e2e5e20dc35d62e5
Author: Felix Fietkau <nbd@openwrt.org>
Date:   Tue Sep 17 12:05:15 2013 +0200

    ath9k: don't use BAW tracking on PS responses for non-AMPDU packets
    
    When .release_buffered_frames was implemented, only A-MPDU packets were
    buffered internally. Now that this has changed, the BUF_AMPDU flag needs
    to be checked before calling ath_tx_addto_baw
    
    Signed-off-by: Felix Fietkau <nbd@openwrt.org>
    Signed-off-by: John W. Linville <linville@tuxdriver.com>

diff --git a/drivers/net/wireless/ath/ath9k/xmit.c b/drivers/net/wireless/ath/ath9k/xmit.c
index 58499603f705..9b3736ea2aaf 100644
--- a/drivers/net/wireless/ath/ath9k/xmit.c
+++ b/drivers/net/wireless/ath/ath9k/xmit.c
@@ -1556,8 +1556,10 @@ void ath9k_release_buffered_frames(struct ieee80211_hw *hw,
 			__skb_unlink(bf->bf_mpdu, tid_q);
 			list_add_tail(&bf->list, &bf_q);
 			ath_set_rates(tid->an->vif, tid->an->sta, bf);
-			ath_tx_addto_baw(sc, tid, bf);
-			bf->bf_state.bf_type &= ~BUF_AGGR;
+			if (bf_isampdu(bf)) {
+				ath_tx_addto_baw(sc, tid, bf);
+				bf->bf_state.bf_type &= ~BUF_AGGR;
+			}
 			if (bf_tail)
 				bf_tail->bf_next = bf;
 

