commit 138f296e140f79cb955caba70690076fb14e6f6d
Author: Tomi Valkeinen <tomi.valkeinen@ti.com>
Date:   Wed Apr 24 08:35:20 2013 +0300

    fbdev: fix check for fb_mmap's mmio availability
    
    Commit fc9bbca8f650e5f738af8806317c0a041a48ae4a (vm: convert fb_mmap to
    vm_iomap_memory() helper) made fbmem.c use vm_iomap_memory, but also
    accidentally removed the check for mmio's availability.
    
    Add the check back.
    
    Signed-off-by: Tomi Valkeinen <tomi.valkeinen@ti.com>

diff --git a/drivers/video/fbmem.c b/drivers/video/fbmem.c
index 86291dcd964a..dcb669eb4532 100644
--- a/drivers/video/fbmem.c
+++ b/drivers/video/fbmem.c
@@ -1398,6 +1398,11 @@ fb_mmap(struct file *file, struct vm_area_struct * vma)
 	len = info->fix.smem_len;
 	mmio_pgoff = PAGE_ALIGN((start & ~PAGE_MASK) + len) >> PAGE_SHIFT;
 	if (vma->vm_pgoff >= mmio_pgoff) {
+		if (info->var.accel_flags) {
+			mutex_unlock(&info->mm_lock);
+			return -EINVAL;
+		}
+
 		vma->vm_pgoff -= mmio_pgoff;
 		start = info->fix.mmio_start;
 		len = info->fix.mmio_len;

