commit c61715e2c505c15a5cfc9eab18b4311a6504055a
Author: Michael Niedermayer <michael@niedermayer.cc>
Date:   Sun Jul 2 00:09:42 2017 +0200

    avcodec/htmlsubtitles: Be a bit more picky on syntax
    
    This reduces the number of strstr() calls per byte
    This diasalows empty tags like '< >' as well as '<' in tags like '<ab<cd<<ef>'
    
    Fixes timeout
    Fixes: 1817/clusterfuzz-testcase-minimized-5104230530547712
    
    Found-by: continuous fuzzing process https://github.com/google/oss-fuzz/tree/master/projects/ffmpeg
    Signed-off-by: Michael Niedermayer <michael@niedermayer.cc>

diff --git a/libavcodec/htmlsubtitles.c b/libavcodec/htmlsubtitles.c
index 9575464063..e6bac713c1 100644
--- a/libavcodec/htmlsubtitles.c
+++ b/libavcodec/htmlsubtitles.c
@@ -110,13 +110,13 @@ int ff_htmlmarkup_to_ass(void *log_ctx, AVBPrint *dst, const char *in)
         case '<':
             tag_close = in[1] == '/';
             len = 0;
-            if (sscanf(in+tag_close+1, "%127[^>]>%n", buffer, &len) >= 1 && len > 0) {
+            if (sscanf(in+tag_close+1, "%127[^<>]>%n", buffer, &len) >= 1 && len > 0) {
                 const char *tagname = buffer;
                 while (*tagname == ' ')
                     tagname++;
                 if ((param = strchr(tagname, ' ')))
                     *param++ = 0;
-                if ((!tag_close && sptr < FF_ARRAY_ELEMS(stack)) ||
+                if ((!tag_close && sptr < FF_ARRAY_ELEMS(stack) && *tagname) ||
                     ( tag_close && sptr > 0 && !av_strcasecmp(stack[sptr-1].tag, tagname))) {
                     int i, j, unknown = 0;
                     in += len + tag_close;

