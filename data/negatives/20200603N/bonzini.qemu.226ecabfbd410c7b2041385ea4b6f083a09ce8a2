commit 226ecabfbd410c7b2041385ea4b6f083a09ce8a2
Author: Paolo Bonzini <pbonzini@redhat.com>
Date:   Fri Mar 22 17:57:48 2013 +0100

    qemu-bridge-helper: force usage of a very high MAC address for the bridge
    
    Linux uses the lowest enslaved MAC address as the MAC address of
    the bridge.  Set MAC address to a high value so that it does not
    affect the MAC address of the bridge.
    
    Changing the MAC address of the bridge could cause a few seconds
    of network downtime.
    
    Cc: qemu-stable@nongnu.org
    Signed-off-by: Paolo Bonzini <pbonzini@redhat.com>
    Message-id: 1363971468-21154-1-git-send-email-pbonzini@redhat.com
    Signed-off-by: Anthony Liguori <aliguori@us.ibm.com>

diff --git a/qemu-bridge-helper.c b/qemu-bridge-helper.c
index 287bfd5e38..6a0974eb48 100644
--- a/qemu-bridge-helper.c
+++ b/qemu-bridge-helper.c
@@ -367,6 +367,24 @@ int main(int argc, char **argv)
         goto cleanup;
     }
 
+    /* Linux uses the lowest enslaved MAC address as the MAC address of
+     * the bridge.  Set MAC address to a high value so that it doesn't
+     * affect the MAC address of the bridge.
+     */
+    if (ioctl(ctlfd, SIOCGIFHWADDR, &ifr) < 0) {
+        fprintf(stderr, "failed to get MAC address of device `%s': %s\n",
+                iface, strerror(errno));
+        ret = EXIT_FAILURE;
+        goto cleanup;
+    }
+    ifr.ifr_hwaddr.sa_data[0] = 0xFE;
+    if (ioctl(ctlfd, SIOCSIFHWADDR, &ifr) < 0) {
+        fprintf(stderr, "failed to set MAC address of device `%s': %s\n",
+                iface, strerror(errno));
+        ret = EXIT_FAILURE;
+        goto cleanup;
+    }
+
     /* add the interface to the bridge */
     prep_ifreq(&ifr, bridge);
     ifindex = if_nametoindex(iface);

