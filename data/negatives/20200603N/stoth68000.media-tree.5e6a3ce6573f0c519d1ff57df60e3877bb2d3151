commit 5e6a3ce6573f0c519d1ff57df60e3877bb2d3151
Author: Pavel Emelyanov <xemul@parallels.com>
Date:   Thu Apr 19 03:41:32 2012 +0000

    tcp: Report mss_clamp with TCP_MAXSEG option in repair mode
    
    The mss_clamp is the only connection-time negotiated option which
    cannot be obtained from the user space. Make the TCP_MAXSEG sockopt
    report one in the repair mode.
    
    Signed-off-by: Pavel Emelyanov <xemul@openvz.org>
    Signed-off-by: David S. Miller <davem@davemloft.net>

diff --git a/net/ipv4/tcp.c b/net/ipv4/tcp.c
index 47e2f4972f79..b4e690ddb08c 100644
--- a/net/ipv4/tcp.c
+++ b/net/ipv4/tcp.c
@@ -2659,6 +2659,8 @@ static int do_tcp_getsockopt(struct sock *sk, int level,
 		val = tp->mss_cache;
 		if (!val && ((1 << sk->sk_state) & (TCPF_CLOSE | TCPF_LISTEN)))
 			val = tp->rx_opt.user_mss;
+		if (tp->repair)
+			val = tp->rx_opt.mss_clamp;
 		break;
 	case TCP_NODELAY:
 		val = !!(tp->nonagle&TCP_NAGLE_OFF);

