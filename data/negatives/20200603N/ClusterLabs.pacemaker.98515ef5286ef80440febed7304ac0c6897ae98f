commit 98515ef5286ef80440febed7304ac0c6897ae98f
Author: Andrew Beekhof <andrew@beekhof.net>
Date:   Thu Feb 16 21:54:36 2012 +1100

    High: Core: Correctly determine when an XML file should be decompressed

diff --git a/lib/common/xml.c b/lib/common/xml.c
index 5ecf9922a..7045c41d2 100644
--- a/lib/common/xml.c
+++ b/lib/common/xml.c
@@ -678,10 +678,11 @@ filename2xml(const char *filename)
 {
     xmlNode *xml = NULL;
     xmlDocPtr output = NULL;
+    const char *match = NULL;
     xmlParserCtxtPtr ctxt = NULL;
     xmlErrorPtr last_error = NULL;
     static int xml_options = XML_PARSE_NOBLANKS|XML_PARSE_RECOVER;
-    
+
     /* create a parser context */
     ctxt = xmlNewParserCtxt();
     CRM_CHECK(ctxt != NULL, return NULL);
@@ -692,11 +693,15 @@ filename2xml(const char *filename)
     xmlSetGenericErrorFunc(ctxt, crm_xml_err);
     /* initGenericErrorDefaultFunc(crm_xml_err); */
 
+    if(filename) {
+        match = strstr(filename, ".bz2");
+    }
+
     if(filename == NULL) {
 	/* STDIN_FILENO == fileno(stdin) */
 	output = xmlCtxtReadFd(ctxt, STDIN_FILENO, "unknown.xml", NULL, xml_options);
 
-    } else if(strstr(filename, ".bz2") == NULL) {
+    } else if(match == NULL || match[4] != 0) {
 	output = xmlCtxtReadFile(ctxt, filename, NULL, xml_options);
 
     } else {

