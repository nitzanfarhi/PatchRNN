commit 81102044f417bd99ca570d9234b1df5195e9a8c9
Author: Joao Eduardo Luis <joao.luis@inktank.com>
Date:   Fri Aug 29 20:21:25 2014 +0100

    osd: OSDMap: ordered blacklist on non-classic encode function
    
    Fixes: #9211
    Backport: firefly
    
    Signed-off-by: Joao Eduardo Luis <joao.luis@inktank.com>
    Reviewed-by: Sage Weil <sage@redhat.com>

diff --git a/src/osd/OSDMap.cc b/src/osd/OSDMap.cc
index 3dd0c1b5dc..ca0f6e63e0 100644
--- a/src/osd/OSDMap.cc
+++ b/src/osd/OSDMap.cc
@@ -1760,15 +1760,7 @@ void OSDMap::encode_classic(bufferlist& bl, uint64_t features) const
   ::encode(ev, bl);
   ::encode(osd_addrs->hb_back_addr, bl);
   ::encode(osd_info, bl);
-  {
-    // put this in a sorted, ordered map<> so that we encode in a
-    // deterministic order.
-    map<entity_addr_t,utime_t> blacklist_map;
-    for (ceph::unordered_map<entity_addr_t,utime_t>::const_iterator p =
-	   blacklist.begin(); p != blacklist.end(); ++p)
-      blacklist_map.insert(make_pair(p->first, p->second));
-    ::encode(blacklist_map, bl);
-  }
+  ::encode(blacklist, bl);
   ::encode(osd_addrs->cluster_addr, bl);
   ::encode(cluster_snapshot_epoch, bl);
   ::encode(cluster_snapshot, bl);
@@ -1826,7 +1818,15 @@ void OSDMap::encode(bufferlist& bl, uint64_t features) const
     ENCODE_START(1, 1, bl); // extended, osd-only data
     ::encode(osd_addrs->hb_back_addr, bl);
     ::encode(osd_info, bl);
-    ::encode(blacklist, bl);
+    {
+      // put this in a sorted, ordered map<> so that we encode in a
+      // deterministic order.
+      map<entity_addr_t,utime_t> blacklist_map;
+      for (ceph::unordered_map<entity_addr_t,utime_t>::const_iterator p =
+	     blacklist.begin(); p != blacklist.end(); ++p)
+	blacklist_map.insert(make_pair(p->first, p->second));
+      ::encode(blacklist_map, bl);
+    }
     ::encode(osd_addrs->cluster_addr, bl);
     ::encode(cluster_snapshot_epoch, bl);
     ::encode(cluster_snapshot, bl);

