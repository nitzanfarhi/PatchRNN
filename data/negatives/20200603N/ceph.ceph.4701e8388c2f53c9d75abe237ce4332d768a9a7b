commit 4701e8388c2f53c9d75abe237ce4332d768a9a7b
Author: Sage Weil <sage@newdream.net>
Date:   Thu Jul 8 14:55:53 2010 -0700

    msgr: return error and dethrottle if message decode fails
    
    This was broken by the addition of the throttling stuff.
    
    Signed-off-by: Sage Weil <sage@newdream.net>

diff --git a/src/msg/SimpleMessenger.cc b/src/msg/SimpleMessenger.cc
index 2db35278cd..87b9bf0089 100644
--- a/src/msg/SimpleMessenger.cc
+++ b/src/msg/SimpleMessenger.cc
@@ -1790,6 +1790,11 @@ int SimpleMessenger::Pipe::read_message(Message **pm)
   dout(20) << "reader got " << front.length() << " + " << middle.length() << " + " << data.length()
 	   << " byte message" << dendl;
   message = decode_message(header, footer, front, middle, data);
+  if (!message) {
+    ret = -EINVAL;
+    goto out_dethrottle;
+  }
+
   message->set_throttler(policy.throttler);
 
   // store reservation size in message, so we don't get confused

