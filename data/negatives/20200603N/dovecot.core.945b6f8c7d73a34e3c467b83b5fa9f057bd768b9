commit 945b6f8c7d73a34e3c467b83b5fa9f057bd768b9
Author: Timo Sirainen <tss@iki.fi>
Date:   Wed Aug 29 18:32:01 2012 +0300

    imap: Added asserts to make sure a tagline isn't sent twice to the same command.

diff --git a/src/imap/imap-client.c b/src/imap/imap-client.c
index 73cdeeb16..8d3d3b165 100644
--- a/src/imap/imap-client.c
+++ b/src/imap/imap-client.c
@@ -340,6 +340,9 @@ void client_send_tagline(struct client_command_context *cmd, const char *data)
 	if (client->output->closed || cmd->cancel)
 		return;
 
+	i_assert(!cmd->tagline_sent);
+	cmd->tagline_sent = TRUE;
+
 	if (tag == NULL || *tag == '\0')
 		tag = "*";
 
diff --git a/src/imap/imap-client.h b/src/imap/imap-client.h
index 9d2f72a9f..b8d97209d 100644
--- a/src/imap/imap-client.h
+++ b/src/imap/imap-client.h
@@ -79,6 +79,7 @@ struct client_command_context {
 	unsigned int search_save_result:1; /* search result is being updated */
 	unsigned int search_save_result_used:1; /* command uses search save */
 	unsigned int temp_executed:1; /* temporary execution state tracking */
+	unsigned int tagline_sent:1;
 };
 
 struct imap_client_vfuncs {

