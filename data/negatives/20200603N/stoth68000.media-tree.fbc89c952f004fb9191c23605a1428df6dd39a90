commit fbc89c952f004fb9191c23605a1428df6dd39a90
Author: Martin Schwidefsky <schwidefsky@de.ibm.com>
Date:   Wed Jan 7 11:00:02 2015 +0100

    s390/mm: avoid using pmd_to_page for !USE_SPLIT_PMD_PTLOCKS
    
    pmd_to_page() is only available if USE_SPLIT_PMD_PTLOCKS is defined.
    The use of pmd_to_page in the gmap code can cause compile errors if
    NR_CPUS is smaller than SPLIT_PTLOCK_CPUS. Do not use pmd_to_page
    outside of USE_SPLIT_PMD_PTLOCKS sections.
    
    Reported-by: Mike Frysinger <vapier@gentoo.org>
    Signed-off-by: Martin Schwidefsky <schwidefsky@de.ibm.com>

diff --git a/arch/s390/mm/pgtable.c b/arch/s390/mm/pgtable.c
index 71c7eff2c89f..601deb85d2a0 100644
--- a/arch/s390/mm/pgtable.c
+++ b/arch/s390/mm/pgtable.c
@@ -322,11 +322,12 @@ static int gmap_alloc_table(struct gmap *gmap, unsigned long *table,
 static unsigned long __gmap_segment_gaddr(unsigned long *entry)
 {
 	struct page *page;
-	unsigned long offset;
+	unsigned long offset, mask;
 
 	offset = (unsigned long) entry / sizeof(unsigned long);
 	offset = (offset & (PTRS_PER_PMD - 1)) * PMD_SIZE;
-	page = pmd_to_page((pmd_t *) entry);
+	mask = ~(PTRS_PER_PMD * sizeof(pmd_t) - 1);
+	page = virt_to_page((void *)((unsigned long) entry & mask));
 	return page->index + offset;
 }
 

