commit 4a9216453c8537a7f43a3b1708509b9dd271dc9f
Author: Jesse Barnes <jbarnes@virtuousgeek.org>
Date:   Tue Nov 10 08:21:25 2009 +0000

    drm: when queuing an event with NEXTONMISS, return queued sequence to userspace
    
    If we queue a vblank event but miss it, we should return the actual
    sequence number we queued to userspace, so its event handling function
    will know which event to look for.
    
    Acked-by: Kristian HÃ¸gsberg <krh@bitplanet.net>
    Signed-off-by: Jesse Barnes <jbarnes@virtuousgeek.org>
    Signed-off-by: Dave Airlie <airlied@redhat.com>

diff --git a/drivers/gpu/drm/drm_irq.c b/drivers/gpu/drm/drm_irq.c
index 72754aca7abf..6b3ce6d38848 100644
--- a/drivers/gpu/drm/drm_irq.c
+++ b/drivers/gpu/drm/drm_irq.c
@@ -585,6 +585,7 @@ static int drm_queue_vblank_event(struct drm_device *dev, int pipe,
 	if ((vblwait->request.type & _DRM_VBLANK_NEXTONMISS) &&
 	    (seq - vblwait->request.sequence) <= (1 << 23)) {
 		vblwait->request.sequence = seq + 1;
+		vblwait->reply.sequence = vblwait->request.sequence;
 	}
 
 	DRM_DEBUG("event on vblank count %d, current %d, crtc %d\n",

