commit 380ccfd76b2aa45d31082e9fa5482e5e84584bf0
Author: Colin Patrick McCabe <cmccabe@alumni.cmu.edu>
Date:   Thu Feb 10 03:27:40 2011 -0800

    common: safe_io: handle EOF on read
    
    Signed-off-by: Colin McCabe <colin.mccabe@dreamhost.com>

diff --git a/src/common/safe_io.c b/src/common/safe_io.c
index 455265e703..f9158a77fa 100644
--- a/src/common/safe_io.c
+++ b/src/common/safe_io.c
@@ -10,7 +10,11 @@ ssize_t safe_read(int fd, void *buf, size_t count)
 
 	while (count > 0) {
 		r = read(fd, buf, count);
-		if (r < 0) {
+		if (r <= 0) {
+			if (r == 0) {
+				// EOF
+				return -EDOM;
+			}
 			if (errno == EINTR)
 				continue;
 			return -errno;
@@ -44,11 +48,16 @@ ssize_t safe_pread(int fd, void *buf, size_t count, off_t offset)
 
 	while (count > 0) {
 		r = pread(fd, buf, count, offset);
-		if (r < 0) {
+		if (r <= 0) {
+			if (r == 0) {
+				// EOF
+				return -EDOM;
+			}
 			if (errno == EINTR)
 				continue;
 			return -errno;
 		}
+
 		count -= r;
 		buf = (char *)buf + r;
 		offset += r;

