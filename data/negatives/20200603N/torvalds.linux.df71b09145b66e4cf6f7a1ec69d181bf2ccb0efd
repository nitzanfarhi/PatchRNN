commit df71b09145b66e4cf6f7a1ec69d181bf2ccb0efd
Author: Richard Weinberger <richard@nod.at>
Date:   Wed Jun 7 23:33:35 2017 +0200

    ubifs: Fail commit if TNC is obviously inconsistent
    
    A reference to LEB 0 or with length 0 in the TNC
    is never correct and could be caused by a memory corruption.
    Don't write such a bad index node to the MTD.
    Instead fail the commit which will turn UBIFS into read-only mode.
    
    This is less painful than having the bad reference on the MTD
    from where UBFIS has no chance to recover.
    
    Signed-off-by: Richard Weinberger <richard@nod.at>

diff --git a/fs/ubifs/tnc_commit.c b/fs/ubifs/tnc_commit.c
index 51157da3f76e..aa31f60220ef 100644
--- a/fs/ubifs/tnc_commit.c
+++ b/fs/ubifs/tnc_commit.c
@@ -57,6 +57,8 @@ static int make_idx_node(struct ubifs_info *c, struct ubifs_idx_node *idx,
 			ubifs_dump_znode(c, znode);
 			if (zbr->znode)
 				ubifs_dump_znode(c, zbr->znode);
+
+			return -EINVAL;
 		}
 	}
 	ubifs_prepare_node(c, idx, len, 0);
@@ -859,6 +861,8 @@ static int write_index(struct ubifs_info *c)
 				ubifs_dump_znode(c, znode);
 				if (zbr->znode)
 					ubifs_dump_znode(c, zbr->znode);
+
+				return -EINVAL;
 			}
 		}
 		len = ubifs_idx_node_sz(c, znode->child_cnt);

