commit c0d09828c870f90c6bc72070ada281568f89c63b
Author: Amit Shah <amit.shah@redhat.com>
Date:   Mon Oct 27 09:04:18 2008 +0000

    KVM: SVM: Set the 'busy' flag of the TR selector
    
    The busy flag of the TR selector is not set by the hardware. This breaks
    migration from amd hosts to intel hosts.
    
    Signed-off-by: Amit Shah <amit.shah@redhat.com>
    Signed-off-by: Avi Kivity <avi@redhat.com>

diff --git a/arch/x86/kvm/svm.c b/arch/x86/kvm/svm.c
index 665008d97856..743aebd7bfcc 100644
--- a/arch/x86/kvm/svm.c
+++ b/arch/x86/kvm/svm.c
@@ -781,6 +781,13 @@ static void svm_get_segment(struct kvm_vcpu *vcpu,
 	if (seg == VCPU_SREG_CS)
 		var->g = s->limit > 0xfffff;
 
+	/*
+	 * Work around a bug where the busy flag in the tr selector
+	 * isn't exposed
+	 */
+	if (seg == VCPU_SREG_TR)
+		var->type |= 0x2;
+
 	var->unusable = !var->present;
 }
 

