commit a87cb2d1c1242b849e9ce84bd19b8501d14154dd
Author: Marti Maria <info@littlecms.com>
Date:   Sun Dec 4 21:09:18 2016 +0100

    fix IT8 parsing glitch
    
    Fixed a bug when trying to parse junk as IT8 file. Added the
    corresponding test case

diff --git a/include/lcms2.h b/include/lcms2.h
index b6da91d..82bcaed 100644
--- a/include/lcms2.h
+++ b/include/lcms2.h
@@ -1810,7 +1810,7 @@ CMSAPI cmsInt32Number   CMSEXPORT cmsIT8SetTable(cmsHANDLE hIT8, cmsUInt32Number
 
 // Persistence
 CMSAPI cmsHANDLE        CMSEXPORT cmsIT8LoadFromFile(cmsContext ContextID, const char* cFileName);
-CMSAPI cmsHANDLE        CMSEXPORT cmsIT8LoadFromMem(cmsContext ContextID, void *Ptr, cmsUInt32Number len);
+CMSAPI cmsHANDLE        CMSEXPORT cmsIT8LoadFromMem(cmsContext ContextID, const void *Ptr, cmsUInt32Number len);
 // CMSAPI cmsHANDLE        CMSEXPORT cmsIT8LoadFromIOhandler(cmsContext ContextID, cmsIOHANDLER* io);
 
 CMSAPI cmsBool          CMSEXPORT cmsIT8SaveToFile(cmsHANDLE hIT8, const char* cFileName);
diff --git a/src/cmscgats.c b/src/cmscgats.c
index 6011fb2..16a50cd 100644
--- a/src/cmscgats.c
+++ b/src/cmscgats.c
@@ -2024,14 +2024,17 @@ cmsBool HeaderSection(cmsIT8* it8)
 static
 void ReadType(cmsIT8* it8, char* SheetTypePtr)
 {
+    cmsInt32Number cnt = 0;
+
     // First line is a very special case.
 
     while (isseparator(it8->ch))
             NextCh(it8);
 
-    while (it8->ch != '\r' && it8 ->ch != '\n' && it8->ch != '\t' && it8 -> ch != -1) {
+    while (it8->ch != '\r' && it8 ->ch != '\n' && it8->ch != '\t' && it8 -> ch != 0) {
 
-        *SheetTypePtr++= (char) it8 ->ch;
+        if (cnt++ < MAXSTR) 
+            *SheetTypePtr++= (char) it8 ->ch;
         NextCh(it8);
     }
 
diff --git a/testbed/testcms2.c b/testbed/testcms2.c
index f59180d..f4e6bf1 100644
--- a/testbed/testcms2.c
+++ b/testbed/testcms2.c
@@ -6861,6 +6861,20 @@ cmsInt32Number CheckCGATS(void)
 
 }
 
+static const cmsUInt8Number junk[] = { 0x0, 0xd, 0xd, 0xa, 0x20, 0xd, 0x20, 0x20, 0x20, 0x3a, 0x31, 0x3d, 0x3d, 0x3d, 0x3d };
+
+static
+cmsInt32Number CheckCGATS2(void)
+{
+    cmsHANDLE handle;
+
+    handle = cmsIT8LoadFromMem(0, (const void*)junk, sizeof(junk));
+    if (handle)
+        cmsIT8Free(handle);
+
+    return 1;
+}
+
 
 // Create CSA/CRD
 
@@ -8611,6 +8625,7 @@ int main(int argc, char* argv[])
     Check("TAC detection", CheckTAC);
 
     Check("CGATS parser", CheckCGATS);
+    Check("CGATS parser on junk", CheckCGATS2);
     Check("PostScript generator", CheckPostScript);
     Check("Segment maxima GBD", CheckGBD);
     Check("MD5 digest", CheckMD5);

