commit 3755b21992f921e68ea4dc5b74d32328e6088641
Author: Rainer Gerhards <rgerhards@adiscon.com>
Date:   Wed Oct 1 11:41:09 2014 +0200

    do not try to parse messages with invalid facility (RFC3164 mode)

diff --git a/tools/pmrfc3164.c b/tools/pmrfc3164.c
index 9bae2b3df..f436f1440 100644
--- a/tools/pmrfc3164.c
+++ b/tools/pmrfc3164.c
@@ -84,6 +84,9 @@ CODESTARTparse
 	lenMsg = pMsg->iLenRawMsg - pMsg->offAfterPRI; /* note: offAfterPRI is already the number of PRI chars (do not add one!) */
 	p2parse = pMsg->pszRawMsg + pMsg->offAfterPRI; /* point to start of text, after PRI */
 	setProtocolVersion(pMsg, MSG_LEGACY_PROTOCOL);
+	if(pMsg->iFacility == (LOG_INVLD>>3))
+		FINALIZE; /* don't parse out from invalid messages! */
+
 
 	/* Check to see if msg contains a timestamp. We start by assuming
 	 * that the message timestamp is the time of reception (which we 
@@ -199,7 +202,7 @@ CODESTARTparse
 		}
 	}
 
-	/* The rest is the actual MSG */
+finalize_it:
 	MsgSetMSGoffs(pMsg, p2parse - pMsg->pszRawMsg);
 ENDparse
 

