commit 2eee40c7f7c3734b28456169b2945e07d5ac0e2d
Author: Rémi Denis-Courmont <remi.denis-courmont@nokia.com>
Date:   Tue Jul 21 01:57:58 2009 +0000

    Phonet: dropped datagrams accounting
    
    The per-socket drop count is visible via /proc/net/phonet.
    
    Signed-off-by: Rémi Denis-Courmont <remi.denis-courmont@nokia.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

diff --git a/net/phonet/datagram.c b/net/phonet/datagram.c
index e087862ed7e4..ef5c75c372e4 100644
--- a/net/phonet/datagram.c
+++ b/net/phonet/datagram.c
@@ -159,8 +159,11 @@ static int pn_recvmsg(struct kiocb *iocb, struct sock *sk,
 static int pn_backlog_rcv(struct sock *sk, struct sk_buff *skb)
 {
 	int err = sock_queue_rcv_skb(sk, skb);
-	if (err < 0)
+	if (err < 0) {
 		kfree_skb(skb);
+		if (err == -ENOMEM)
+			atomic_inc(&sk->sk_drops);
+	}
 	return err ? NET_RX_DROP : NET_RX_SUCCESS;
 }
 

