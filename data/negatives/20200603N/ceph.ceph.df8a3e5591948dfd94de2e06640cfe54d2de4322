commit df8a3e5591948dfd94de2e06640cfe54d2de4322
Author: Sage Weil <sage@inktank.com>
Date:   Mon Jun 17 16:38:26 2013 -0700

    client: handle reset during initial mds session open
    
    If we get a reset during our attempt to open an MDS session, close out the
    Connection* and retry to open the session, moving the waiters over.
    
    Fixes: #5379
    Signed-off-by: Sage Weil <sage@inktank.com>
    Reviewed-by: Greg Farnum <greg@inktank.com>

diff --git a/src/client/Client.cc b/src/client/Client.cc
index a17254b60b..cfebcdb03d 100644
--- a/src/client/Client.cc
+++ b/src/client/Client.cc
@@ -7889,9 +7889,22 @@ void Client::ms_handle_remote_reset(Connection *con)
 	}
       }
       if (mds >= 0) {
-	if (s->state == MetaSession::STATE_CLOSING) {
+	switch (s->state) {
+	case MetaSession::STATE_CLOSING:
 	  ldout(cct, 1) << "reset from mds we were closing; we'll call that closed" << dendl;
 	  _closed_mds_session(s);
+	  break;
+
+	case MetaSession::STATE_OPENING:
+	  {
+	    ldout(cct, 1) << "reset from mds we were opening; retrying" << dendl;
+	    list<Cond*> waiters;
+	    waiters.swap(s->waiting_for_open);
+	    _closed_mds_session(s);
+	    MetaSession *news = _get_or_open_mds_session(mds);
+	    news->waiting_for_open.swap(waiters);
+	  }
+	  break;
 	}
       }
     }

