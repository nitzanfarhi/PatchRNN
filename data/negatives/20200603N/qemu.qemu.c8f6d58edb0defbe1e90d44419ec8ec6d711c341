commit c8f6d58edb0defbe1e90d44419ec8ec6d711c341
Author: Kevin Wolf <kwolf@redhat.com>
Date:   Fri Feb 17 14:52:00 2017 +0100

    block: Assertions for resize permission
    
    This adds an assertion that ensures that the necessary resize permission
    has been granted before bdrv_truncate() is called.
    
    Signed-off-by: Kevin Wolf <kwolf@redhat.com>
    Reviewed-by: Max Reitz <mreitz@redhat.com>
    Acked-by: Fam Zheng <famz@redhat.com>

diff --git a/block.c b/block.c
index 79d9ad0ad6..74ac7dcf74 100644
--- a/block.c
+++ b/block.c
@@ -3122,6 +3122,9 @@ int bdrv_truncate(BdrvChild *child, int64_t offset)
     BlockDriverState *bs = child->bs;
     BlockDriver *drv = bs->drv;
     int ret;
+
+    assert(child->perm & BLK_PERM_RESIZE);
+
     if (!drv)
         return -ENOMEDIUM;
     if (!drv->bdrv_truncate)
diff --git a/block/io.c b/block/io.c
index 4c797454a4..8f38d46de0 100644
--- a/block/io.c
+++ b/block/io.c
@@ -1339,6 +1339,7 @@ static int coroutine_fn bdrv_aligned_pwritev(BdrvChild *child,
     assert(req->overlap_offset <= offset);
     assert(offset + bytes <= req->overlap_offset + req->overlap_bytes);
     assert(child->perm & BLK_PERM_WRITE);
+    assert(end_sector <= bs->total_sectors || child->perm & BLK_PERM_RESIZE);
 
     ret = notifier_with_return_list_notify(&bs->before_write_notifiers, req);
 

