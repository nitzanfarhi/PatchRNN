commit 53b139567cd2c828cf2cf387029396ef55351289
Author: Victor Seva <linuxmaniac@torreviejawireless.org>
Date:   Fri Sep 23 11:11:56 2016 +0200

    presence: fix crash when no dialog.id on dialog-info xml
    
    Fix #794

diff --git a/modules/presence/presentity.c b/modules/presence/presentity.c
index e601153df..00fdbfdcb 100644
--- a/modules/presence/presentity.c
+++ b/modules/presence/presentity.c
@@ -691,13 +691,13 @@ int update_presentity(struct sip_msg* msg, presentity_t* presentity, str* body,
 			}
 
 			check_if_dialog(*body, &is_dialog, &dialog_id);
+			if (is_dialog == 1) {
+				if (delete_presentity_if_dialog_id_exists(presentity, dialog_id) < 0) {
+					goto error;
+				}
 
-			if (delete_presentity_if_dialog_id_exists(presentity, dialog_id) < 0) {
-				goto error;
+				free(dialog_id);
 			}
-
-			free(dialog_id);
-
 			LM_DBG("inserting %d cols into table\n",n_query_cols);
 
 			if (pa_dbf.insert(pa_db, query_cols, query_vals, n_query_cols) < 0)

