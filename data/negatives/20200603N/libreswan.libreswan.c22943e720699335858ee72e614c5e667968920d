commit c22943e720699335858ee72e614c5e667968920d
Author: Tuomo Soini <tis@foobar.fi>
Date:   Mon May 17 13:11:58 2010 +0300

    Revert "Don't set virtualwhy for non-virtual conns - it might match!"
    This wasn't correct way to make vhost:%no work.
    
    This reverts commit 46384b91d30a5b550fa125e8c15aaafee61e930a.

diff --git a/programs/pluto/connections.c b/programs/pluto/connections.c
index 0965408ec..d28f50d0f 100644
--- a/programs/pluto/connections.c
+++ b/programs/pluto/connections.c
@@ -2705,14 +2705,15 @@ fc_try(const struct connection *c
 				       , d3, d1));
 			continue;
 		    }
-		    if (is_virtual_sr(sr)) {
-			virtualwhy=is_virtual_net_allowed(d, peer_net, &sr->that.host_addr);
-		    	if ( (virtualwhy != NULL) ||
-			     (is_virtual_net_used(d, peer_net, peer_id?peer_id:&sr->that.id)) ) {
-			    DBG(DBG_CONTROLMORE
-				, DBG_log("   virtual net not allowed"));
-			    continue;
-			}
+
+		    virtualwhy=is_virtual_net_allowed(d, peer_net, &sr->that.host_addr);
+		    
+		    if ((is_virtual_sr(sr)) &&
+			( (virtualwhy != NULL) ||
+			  (is_virtual_net_used(d, peer_net, peer_id?peer_id:&sr->that.id)) )) {
+			DBG(DBG_CONTROLMORE
+			     , DBG_log("   virtual net not allowed"));
+			continue;
 		    }
 		}
 	    }

