commit ac928f8dc8e8ee6c402f623723cad22a14394277
Author: Emmanuel Grumbach <emmanuel.grumbach@intel.com>
Date:   Sun Oct 14 16:36:36 2012 +0200

    iwlwifi: first deactivate a queue, then wipe out its data
    
    Doing the opposite is wrong, the SCD wouldn't like someone
    to clear its data while the queue is still active.
    
    Signed-off-by: Emmanuel Grumbach <emmanuel.grumbach@intel.com>
    Signed-off-by: Johannes Berg <johannes.berg@intel.com>

diff --git a/drivers/net/wireless/iwlwifi/pcie/tx.c b/drivers/net/wireless/iwlwifi/pcie/tx.c
index f3c23afbbe63..39ead8cc7e73 100644
--- a/drivers/net/wireless/iwlwifi/pcie/tx.c
+++ b/drivers/net/wireless/iwlwifi/pcie/tx.c
@@ -491,6 +491,8 @@ void iwl_trans_pcie_txq_disable(struct iwl_trans *trans, int txq_id)
 		return;
 	}
 
+	iwl_txq_set_inactive(trans, txq_id);
+
 	rd_ptr = iwl_read_prph(trans, SCD_QUEUE_RDPTR(txq_id)) & (n_bd - 1);
 	wr_ptr = iwl_read_prph(trans, SCD_QUEUE_WRPTR(txq_id));
 
@@ -500,7 +502,6 @@ void iwl_trans_pcie_txq_disable(struct iwl_trans *trans, int txq_id)
 	_iwl_write_targ_mem_dwords(trans, stts_addr,
 				   zero_val, ARRAY_SIZE(zero_val));
 
-	iwl_txq_set_inactive(trans, txq_id);
 	IWL_DEBUG_TX_QUEUES(trans, "Deactivate queue %d\n", txq_id);
 }
 

