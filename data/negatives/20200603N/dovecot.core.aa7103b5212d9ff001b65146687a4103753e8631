commit aa7103b5212d9ff001b65146687a4103753e8631
Author: Timo Sirainen <tss@iki.fi>
Date:   Mon Nov 15 16:06:58 2010 +0000

    istream-base64-encoder: Don't add unwanted trailing [CR]LF

diff --git a/src/lib/istream-base64-encoder.c b/src/lib/istream-base64-encoder.c
index 2f5b1709e..21ec70534 100644
--- a/src/lib/istream-base64-encoder.c
+++ b/src/lib/istream-base64-encoder.c
@@ -46,6 +46,10 @@ i_stream_base64_try_encode_line(struct base64_encoder_istream *bstream)
 	size_t size, buffer_avail;
 	buffer_t buf;
 
+	data = i_stream_get_data(stream->parent, &size);
+	if (size == 0)
+		return FALSE;
+
 	if (bstream->cur_line_len == bstream->chars_per_line) {
 		/* @UNSAFE: end of line, add newline */
 		if (!i_stream_get_buffer_space(stream,
@@ -57,9 +61,6 @@ i_stream_base64_try_encode_line(struct base64_encoder_istream *bstream)
 		stream->w_buffer[stream->pos++] = '\n';
 		bstream->cur_line_len = 0;
 	}
-	data = i_stream_get_data(stream->parent, &size);
-	if (size == 0)
-		return FALSE;
 
 	i_stream_get_buffer_space(stream, (size+2)/3*4, NULL);
 	buffer_avail = stream->buffer_size - stream->pos;

