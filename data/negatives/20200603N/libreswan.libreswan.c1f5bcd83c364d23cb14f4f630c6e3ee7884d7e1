commit c1f5bcd83c364d23cb14f4f630c6e3ee7884d7e1
Author: David McCullough <david_mccullough@mcafee.com>
Date:   Thu Dec 2 12:04:37 2010 +1000

    Order algs correctly for OCF processing
    
    When mixing AUTH/CIPHER algs,  the crypto descriptors need to be in the
    correct order for OCF processing,  otherwise,  depending on the driver,
    in correct results or EINVAL will be returned.
    
            rcv:  auth + cipher
            xmit: cipher + auth

diff --git a/linux/net/ipsec/ipsec_ocf.c b/linux/net/ipsec/ipsec_ocf.c
index bae61a122..a22bf6882 100644
--- a/linux/net/ipsec/ipsec_ocf.c
+++ b/linux/net/ipsec/ipsec_ocf.c
@@ -603,8 +603,18 @@ ipsec_ocf_rcv(struct ipsec_rcv_state *irs)
 	/* we currently don't support any chaining across protocols */
 	switch(ipsp->ips_said.proto) {
 	case IPPROTO_ESP:
-		crde = crp->crp_desc;
-		crda = crde->crd_next;
+		/*
+		 * we are decrypting,  from the setup in ipsec_ocf_sa_init above,  we
+		 * need to flip the order of hash/cipher for recieve so that it is
+		 * hash first then decrypt.  Transmit is ok.
+		 */
+		if (crp->crp_desc && crp->crp_desc->crd_next) {
+			crda = crp->crp_desc;
+			crde = crda->crd_next;
+		} else {
+			crde = crp->crp_desc;
+			crda = crde->crd_next;
+		}
 		break;
 	case IPPROTO_COMP:
 		crdc = crp->crp_desc;

