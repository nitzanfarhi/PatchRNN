commit ebf15b567240f8eb5a5c05961991cb8418bd8a0e
Author: Panu Matilainen <pmatilai@redhat.com>
Date:   Tue Feb 19 13:48:55 2013 +0200

    Move log mask into the log context, update callers

diff --git a/rpmio/rpmlog.c b/rpmio/rpmlog.c
index f0a4221ec..51b6493a3 100644
--- a/rpmio/rpmlog.c
+++ b/rpmio/rpmlog.c
@@ -10,6 +10,7 @@
 
 typedef struct rpmlogCtx_s * rpmlogCtx;
 struct rpmlogCtx_s {
+    unsigned mask;
     int nrecs;
     rpmlogRec recs;
     rpmlogCallback cbfunc;
@@ -26,7 +27,8 @@ struct rpmlogRec_s {
 /* Force log context acquisition through a function */
 static rpmlogCtx rpmlogCtxAcquire(int write)
 {
-    static struct rpmlogCtx_s _globalCtx = { 0, NULL, NULL, NULL, NULL };
+    static struct rpmlogCtx_s _globalCtx = { RPMLOG_UPTO(RPMLOG_NOTICE),
+					     0, NULL, NULL, NULL, NULL };
     return &_globalCtx;
 }
 
@@ -116,17 +118,19 @@ void rpmlogOpen (const char *ident, int option,
 {
 }
 
-static unsigned rpmlogMask = RPMLOG_UPTO( RPMLOG_NOTICE );
-
 #ifdef NOTYET
 static unsigned rpmlogFacility = RPMLOG_USER;
 #endif
 
 int rpmlogSetMask (int mask)
 {
-    int omask = rpmlogMask;
+    rpmlogCtx ctx = rpmlogCtxAcquire(1);
+
+    int omask = ctx->mask;
     if (mask)
-        rpmlogMask = mask;
+        ctx->mask = mask;
+
+    rpmlogCtxRelease(ctx);
     return omask;
 }
 
@@ -242,7 +246,7 @@ void rpmlog (int code, const char *fmt, ...)
 
     rpmlogCtx ctx = rpmlogCtxAcquire(saverec);
 
-    if ((mask & rpmlogMask) == 0)
+    if ((mask & ctx->mask) == 0)
 	goto exit;
 
     va_start(ap, fmt);

