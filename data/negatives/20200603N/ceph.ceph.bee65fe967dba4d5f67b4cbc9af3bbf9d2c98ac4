commit bee65fe967dba4d5f67b4cbc9af3bbf9d2c98ac4
Author: Sage Weil <sage@newdream.net>
Date:   Thu Aug 7 17:14:25 2008 -0700

    mds: adjust MClientSnaps encoding

diff --git a/src/include/ceph_fs.h b/src/include/ceph_fs.h
index 4b6f7f469c..fab56442fe 100644
--- a/src/include/ceph_fs.h
+++ b/src/include/ceph_fs.h
@@ -815,6 +815,7 @@ struct ceph_mds_caps {
 	struct ceph_timespec mtime, atime, ctime;
 	__le64 time_warp_seq;
 	__le64 snap_follows;
+	__le32 snap_trace_len;
 } __attribute__ ((packed));
 
 
diff --git a/src/messages/MClientCaps.h b/src/messages/MClientCaps.h
index 773d04e012..082dcd743a 100644
--- a/src/messages/MClientCaps.h
+++ b/src/messages/MClientCaps.h
@@ -98,11 +98,12 @@ class MClientCaps : public Message {
   void decode_payload() {
     bufferlist::iterator p = payload.begin();
     ::decode(h, p);
-    ::decode(snapbl, p);
+    ::decode_nohead(h.snap_trace_len, snapbl, p);
   }
   void encode_payload() {
+    h.snap_trace_len = snapbl.length();
     ::encode(h, payload);
-    ::encode(snapbl, payload);
+    ::encode_nohead(snapbl, payload);
   }
 };
 

