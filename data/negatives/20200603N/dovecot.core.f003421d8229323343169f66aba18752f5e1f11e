commit f003421d8229323343169f66aba18752f5e1f11e
Author: Timo Sirainen <tss@iki.fi>
Date:   Tue Feb 19 11:22:57 2013 +0200

    auth: userdb passwd-file iteration now skips passdb-only entries if there are other userdbs.

diff --git a/src/auth/userdb-passwd-file.c b/src/auth/userdb-passwd-file.c
index d5588e468..fcf4954c7 100644
--- a/src/auth/userdb-passwd-file.c
+++ b/src/auth/userdb-passwd-file.c
@@ -20,6 +20,7 @@ struct passwd_file_userdb_iterate_context {
 	struct userdb_iterate_context ctx;
 	struct istream *input;
 	char *path;
+	bool skip_passdb_entries;
 };
 
 struct passwd_file_userdb_module {
@@ -98,6 +99,7 @@ passwd_file_iterate_init(struct auth_request *auth_request,
 	ctx->ctx.auth_request = auth_request;
 	ctx->ctx.callback = callback;
 	ctx->ctx.context = context;
+	ctx->skip_passdb_entries = module->pwf->userdb_warn_missing;
 	if (module->pwf->default_file == NULL) {
 		i_error("passwd-file: User iteration isn't currently supported "
 			"with %%variable paths");
@@ -121,7 +123,7 @@ static void passwd_file_iterate_next(struct userdb_iterate_context *_ctx)
 {
 	struct passwd_file_userdb_iterate_context *ctx =
 		(struct passwd_file_userdb_iterate_context *)_ctx;
-	const char *line;
+	const char *line, *p;
 
 	if (ctx->input == NULL)
 		line = NULL;
@@ -129,6 +131,12 @@ static void passwd_file_iterate_next(struct userdb_iterate_context *_ctx)
 		while ((line = i_stream_read_next_line(ctx->input)) != NULL) {
 			if (*line == '\0' || *line == ':' || *line == '#')
 				continue; /* no username or comment */
+			if (ctx->skip_passdb_entries &&
+			    ((p = strchr(line, ':')) == NULL ||
+			     strchr(p+1, ':') == NULL)) {
+				/* only passdb info */
+				continue;
+			}
 			break;
 		}
 		if (line == NULL && ctx->input->stream_errno != 0) {

