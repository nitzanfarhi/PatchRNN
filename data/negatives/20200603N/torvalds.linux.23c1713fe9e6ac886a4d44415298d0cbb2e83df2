commit 23c1713fe9e6ac886a4d44415298d0cbb2e83df2
Author: Joerg Roedel <joerg.roedel@amd.com>
Date:   Wed Sep 17 17:18:17 2008 +0200

    AMD IOMMU: use cmd_buf_size when freeing the command buffer
    
    The command buffer release function uses the CMD_BUF_SIZE macro for
    get_order. Replace this with iommu->cmd_buf_size which is more reliable
    about the actual size of the buffer.
    
    Signed-off-by: Joerg Roedel <joerg.roedel@amd.com>
    Signed-off-by: Ingo Molnar <mingo@elte.hu>

diff --git a/arch/x86/kernel/amd_iommu_init.c b/arch/x86/kernel/amd_iommu_init.c
index 80250e63bd07..db0c83af44de 100644
--- a/arch/x86/kernel/amd_iommu_init.c
+++ b/arch/x86/kernel/amd_iommu_init.c
@@ -433,7 +433,8 @@ static u8 * __init alloc_command_buffer(struct amd_iommu *iommu)
 
 static void __init free_command_buffer(struct amd_iommu *iommu)
 {
-	free_pages((unsigned long)iommu->cmd_buf, get_order(CMD_BUFFER_SIZE));
+	free_pages((unsigned long)iommu->cmd_buf,
+		   get_order(iommu->cmd_buf_size));
 }
 
 /* allocates the memory where the IOMMU will log its events to */

