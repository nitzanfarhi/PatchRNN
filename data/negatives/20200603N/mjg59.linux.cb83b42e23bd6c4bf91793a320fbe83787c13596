commit cb83b42e23bd6c4bf91793a320fbe83787c13596
Author: Tejun Heo <tj@kernel.org>
Date:   Tue Feb 24 11:57:20 2009 +0900

    percpu: fix pcpu_chunk_struct_size
    
    Impact: fix short allocation leading to memory corruption
    
    While dropping rvalue wrapping macros around global parameters,
    pcpu_chunk_struct_size was set incorrectly resulting in shorter page
    pointer array.  Fix it.
    
    Signed-off-by: Tejun Heo <tj@kernel.org>

diff --git a/mm/percpu.c b/mm/percpu.c
index 997724c2ea24..ed92caa2aa3b 100644
--- a/mm/percpu.c
+++ b/mm/percpu.c
@@ -850,7 +850,7 @@ size_t __init pcpu_setup_static(pcpu_populate_pte_fn_t populate_pte_fn,
 	pcpu_chunk_size = num_possible_cpus() * pcpu_unit_size;
 	pcpu_nr_slots = pcpu_size_to_slot(pcpu_unit_size) + 1;
 	pcpu_chunk_struct_size = sizeof(struct pcpu_chunk)
-		+ (1 << pcpu_unit_pages_shift) * sizeof(struct page *);
+		+ num_possible_cpus() * pcpu_unit_pages * sizeof(struct page *);
 
 	/* allocate chunk slots */
 	pcpu_slot = alloc_bootmem(pcpu_nr_slots * sizeof(pcpu_slot[0]));

