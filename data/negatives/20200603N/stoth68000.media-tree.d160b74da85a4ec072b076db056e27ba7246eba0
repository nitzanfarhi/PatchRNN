commit d160b74da85a4ec072b076db056e27ba7246eba0
Author: Dean Jenkins <Dean_Jenkins@mentor.com>
Date:   Thu Apr 20 18:06:41 2017 +0100

    Bluetooth: hci_ldisc: Add missing clear HCI_UART_PROTO_READY
    
    Ensure that HCI_UART_PROTO_READY is cleared before close(hu) is
    called which closes the Data Link protocol layer.
    
    Therefore, add the missing bit clear of HCI_UART_PROTO_READY to
    hci_uart_init_work() so that the flag is cleared when
    hci_register_dev fails.
    
    Without the fix, the functions of the Data Link protocol layer could
    potentially be accessed after that layer has been closed. This
    could lead to a crash as memory would have been freed in that layer.
    
    Signed-off-by: Dean Jenkins <Dean_Jenkins@mentor.com>
    Signed-off-by: Marcel Holtmann <marcel@holtmann.org>

diff --git a/drivers/bluetooth/hci_ldisc.c b/drivers/bluetooth/hci_ldisc.c
index b1096d1ab30e..c53513cb7654 100644
--- a/drivers/bluetooth/hci_ldisc.c
+++ b/drivers/bluetooth/hci_ldisc.c
@@ -188,6 +188,7 @@ static void hci_uart_init_work(struct work_struct *work)
 		hdev = hu->hdev;
 		hu->hdev = NULL;
 		hci_free_dev(hdev);
+		clear_bit(HCI_UART_PROTO_READY, &hu->flags);
 		hu->proto->close(hu);
 		return;
 	}

