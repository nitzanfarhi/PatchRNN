commit 5d74aa7f641a8bf778b87941ae6a955121f64f7d
Author: Anup Patel <anup.patel@broadcom.com>
Date:   Tue Oct 3 10:52:57 2017 +0530

    dmaengine: bcm-sba-raid: serialize dma_cookie_complete() using reqs_lock
    
    As-per documentation in driver/dma/dmaengine.h, the
    dma_cookie_complete() API should be called with lock
    held.
    
    This patch ensures that Broadcom SBA RAID driver calls
    the dma_cookie_complete() API with reqs_lock held.
    
    Signed-off-by: Anup Patel <anup.patel@broadcom.com>
    Reviewed-by: Ray Jui <ray.jui@broadcom.com>
    Reviewed-by: Scott Branden <scott.branden@broadcom.com>
    Signed-off-by: Vinod Koul <vinod.koul@intel.com>

diff --git a/drivers/dma/bcm-sba-raid.c b/drivers/dma/bcm-sba-raid.c
index 6c2c44724637..15c558508345 100644
--- a/drivers/dma/bcm-sba-raid.c
+++ b/drivers/dma/bcm-sba-raid.c
@@ -442,7 +442,9 @@ static void sba_process_received_request(struct sba_device *sba,
 
 		WARN_ON(tx->cookie < 0);
 		if (tx->cookie > 0) {
+			spin_lock_irqsave(&sba->reqs_lock, flags);
 			dma_cookie_complete(tx);
+			spin_unlock_irqrestore(&sba->reqs_lock, flags);
 			dmaengine_desc_get_callback_invoke(tx, NULL);
 			dma_descriptor_unmap(tx);
 			tx->callback = NULL;

