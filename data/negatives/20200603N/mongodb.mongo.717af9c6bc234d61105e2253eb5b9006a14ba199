commit 717af9c6bc234d61105e2253eb5b9006a14ba199
Author: Mathias Stearn <mathias@10gen.com>
Date:   Mon Jan 10 18:50:17 2011 -0500

    TempDisableDurability in repair

diff --git a/db/pdfile.cpp b/db/pdfile.cpp
index 6759dcac01..30def1916a 100644
--- a/db/pdfile.cpp
+++ b/db/pdfile.cpp
@@ -1895,6 +1895,8 @@ namespace mongo {
 
         BackgroundOperation::assertNoBgOpInProgForDb(dbName);
 
+        dur::TempDisableDurability holder; // SyncAndTruncate before computing freeSpace
+
         boost::intmax_t totalSize = dbSize( dbName );
         boost::intmax_t freeSize = freeSpace( repairpath );
         if ( freeSize > -1 && freeSize < totalSize ) {
@@ -1930,6 +1932,8 @@ namespace mongo {
             return false;
         }
 
+        MongoFile::flushAll(true);
+
         Client::Context ctx( dbName );
         Database::closeDatabase( dbName, dbpath );
 

