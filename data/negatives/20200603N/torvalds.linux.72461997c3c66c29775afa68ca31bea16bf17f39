commit 72461997c3c66c29775afa68ca31bea16bf17f39
Author: Paul Mundt <lethal@linux-sh.org>
Date:   Fri Sep 12 22:56:35 2008 +0900

    sh: Check SR.DSP bit for DSP regset validity.
    
    Signed-off-by: Paul Mundt <lethal@linux-sh.org>

diff --git a/arch/sh/kernel/ptrace_32.c b/arch/sh/kernel/ptrace_32.c
index 92fe2034f74a..0f44f2b51a60 100644
--- a/arch/sh/kernel/ptrace_32.c
+++ b/arch/sh/kernel/ptrace_32.c
@@ -179,6 +179,14 @@ static int dspregs_set(struct task_struct *target,
 
 	return ret;
 }
+
+static int dspregs_active(struct task_struct *target,
+			  const struct user_regset *regset)
+{
+	struct pt_regs *regs = task_pt_regs(target);
+
+	return regs->sr & SR_DSP ? regset->n : 0;
+}
 #endif
 
 /*
@@ -213,6 +221,7 @@ static const struct user_regset sh_regsets[] = {
 		.align		= sizeof(long),
 		.get		= dspregs_get,
 		.set		= dspregs_set,
+		.active		= dspregs_active,
 	},
 #endif
 };

