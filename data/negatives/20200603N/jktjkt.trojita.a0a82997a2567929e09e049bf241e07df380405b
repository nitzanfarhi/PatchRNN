commit a0a82997a2567929e09e049bf241e07df380405b
Author: Jan Kundr√°t <jkt@flaska.net>
Date:   Sat Jun 2 14:46:30 2012 +0200

    TaskPresentationModel: implementation of parent() was obviously wrong
    
    This one apparently isn't correct either, but it's certainly a step in the right
    direction. Oh well.

diff --git a/src/Imap/Model/TaskPresentationModel.cpp b/src/Imap/Model/TaskPresentationModel.cpp
index efffd553..ffc1f1c7 100644
--- a/src/Imap/Model/TaskPresentationModel.cpp
+++ b/src/Imap/Model/TaskPresentationModel.cpp
@@ -87,9 +87,16 @@ QModelIndex TaskPresentationModel::parent(const QModelIndex &child) const
         // A parent of the parser state is always the root item
         return QModelIndex();
     }
-
-    // The child is definitely an ImapTask
-    return indexForTask(static_cast<ImapTask *>(child.internalPointer()));
+    // The child is definitely an ImapTask; let's find what the parent is
+    ImapTask *task = static_cast<ImapTask *>(child.internalPointer());
+    if (task->parentTask) {
+        return indexForTask(task->parentTask);
+    } else {
+        Q_ASSERT(task->parser);
+        int index = m_model->m_parsers.keys().indexOf(task->parser);
+        Q_ASSERT(index != -1);
+        return createIndex(index, 0, task->parser);
+    }
 }
 
 /** @short Return a QModelIndex for the specified ImapTask* */

