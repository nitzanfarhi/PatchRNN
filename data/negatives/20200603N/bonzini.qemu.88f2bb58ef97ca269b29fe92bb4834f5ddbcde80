commit 88f2bb58ef97ca269b29fe92bb4834f5ddbcde80
Author: Amit Shah <amit.shah@redhat.com>
Date:   Sat Apr 9 15:54:39 2011 +0530

    atapi: Report correct errors on guest eject request
    
    Table 629 of the MMC-5 spec mentions two different error conditions when
    a CDROM eject is requested: a) while a disc is inserted and b) while a
    disc is not inserted.
    
    Ensure we return the appropriate error for the present condition of the
    drive and disc status.
    
    Signed-off-by: Amit Shah <amit.shah@redhat.com>
    Signed-off-by: Kevin Wolf <kwolf@redhat.com>

diff --git a/hw/ide/core.c b/hw/ide/core.c
index a290142c57..b5de22e86a 100644
--- a/hw/ide/core.c
+++ b/hw/ide/core.c
@@ -1304,7 +1304,7 @@ static void ide_atapi_cmd(IDEState *s)
         break;
     case GPCMD_START_STOP_UNIT:
         {
-            int start, eject, err = 0;
+            int start, eject, sense, err = 0;
             start = packet[4] & 1;
             eject = (packet[4] >> 1) & 1;
 
@@ -1317,7 +1317,11 @@ static void ide_atapi_cmd(IDEState *s)
                 ide_atapi_cmd_ok(s);
                 break;
             case -EBUSY:
-                ide_atapi_cmd_error(s, SENSE_NOT_READY,
+                sense = SENSE_NOT_READY;
+                if (bdrv_is_inserted(s->bs)) {
+                    sense = SENSE_ILLEGAL_REQUEST;
+                }
+                ide_atapi_cmd_error(s, sense,
                                     ASC_MEDIA_REMOVAL_PREVENTED);
                 break;
             default:

