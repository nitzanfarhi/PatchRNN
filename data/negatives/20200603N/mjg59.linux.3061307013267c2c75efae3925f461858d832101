commit 3061307013267c2c75efae3925f461858d832101
Author: Johannes Berg <johannes@sipsolutions.net>
Date:   Thu Sep 11 05:27:40 2008 +0200

    mac80211: pass AP vif pointer for VLANs
    
    We cannot pass a VLAN vif pointer to the driver since those are
    entirely virtual and we never tell the driver.
    
    Signed-off-by: Johannes Berg <johannes@sipsolutions.net>
    Signed-off-by: John W. Linville <linville@tuxdriver.com>

diff --git a/net/mac80211/tx.c b/net/mac80211/tx.c
index 7468495d6f9c..698c8233e6b3 100644
--- a/net/mac80211/tx.c
+++ b/net/mac80211/tx.c
@@ -1351,6 +1351,10 @@ int ieee80211_master_start_xmit(struct sk_buff *skb,
 		return 0;
 	}
 
+	if (osdata->vif.type == NL80211_IFTYPE_AP_VLAN)
+		osdata = container_of(osdata->bss,
+				      struct ieee80211_sub_if_data,
+				      u.ap);
 	info->control.vif = &osdata->vif;
 	ret = ieee80211_tx(odev, skb);
 	dev_put(odev);

