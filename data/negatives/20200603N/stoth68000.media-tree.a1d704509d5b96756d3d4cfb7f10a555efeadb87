commit a1d704509d5b96756d3d4cfb7f10a555efeadb87
Author: Johan Hedberg <johan.hedberg@intel.com>
Date:   Wed Jan 9 15:29:40 2013 +0200

    Bluetooth: Fix sending incorrect new_settings for mgmt_set_powered
    
    The socket from which a mgmt_set_powered command was received should
    only receive the command response but no new_settings event.
    
    The mgmt_powered() function which is used to handle the situation with
    the HCI_AUTO_OFF flag tries to check for a pending command to know which
    socket to skip the event for, but since the pending command hasn't been
    added this will not happen.
    
    This patch fixes the issue by adding the pending command for the
    HCI_AUTO_OFF case and thereby ensures that mgmt_powered() will skip the
    right socket when sending the new_settings event, but still send the
    proper response to the socket where the command came from.
    
    Signed-off-by: Johan Hedberg <johan.hedberg@intel.com>
    Acked-by: Marcel Holtmann <marcel@holtmann.org>
    Signed-off-by: Gustavo Padovan <gustavo.padovan@collabora.co.uk>

diff --git a/net/bluetooth/mgmt.c b/net/bluetooth/mgmt.c
index b1b0a36e1e80..37add53ce613 100644
--- a/net/bluetooth/mgmt.c
+++ b/net/bluetooth/mgmt.c
@@ -787,8 +787,9 @@ static int set_powered(struct sock *sk, struct hci_dev *hdev, void *data,
 		cancel_delayed_work(&hdev->power_off);
 
 		if (cp->val) {
-			err = send_settings_rsp(sk, MGMT_OP_SET_POWERED, hdev);
-			mgmt_powered(hdev, 1);
+			mgmt_pending_add(sk, MGMT_OP_SET_POWERED, hdev,
+					 data, len);
+			err = mgmt_powered(hdev, 1);
 			goto failed;
 		}
 	}

