commit ab1350b2b3c1dd2e465a6abdda608d8c44facfb8
Author: Mi Jinlong <mijinlong@cn.fujitsu.com>
Date:   Thu Jul 14 15:06:26 2011 +0800

    nfsd41: Deny new lock before RECLAIM_COMPLETE done
    
    Before nfs41 client's RECLAIM_COMPLETE done, nfs server should deny any
    new locks or opens.
    
    rfc5661:
    
       " Whenever a client establishes a new client ID and before it does
       the first non-reclaim operation that obtains a lock, it MUST send a
       RECLAIM_COMPLETE with rca_one_fs set to FALSE, even if there are no
       locks to reclaim.  If non-reclaim locking operations are done before
       the RECLAIM_COMPLETE, an NFS4ERR_GRACE error will be returned. "
    
    Signed-off-by: Mi Jinlong <mijinlong@cn.fujitsu.com>
    Signed-off-by: J. Bruce Fields <bfields@redhat.com>

diff --git a/fs/nfsd/nfs4proc.c b/fs/nfsd/nfs4proc.c
index 96b69299dcbe..121fd84e7f90 100644
--- a/fs/nfsd/nfs4proc.c
+++ b/fs/nfsd/nfs4proc.c
@@ -291,6 +291,15 @@ nfsd4_open(struct svc_rqst *rqstp, struct nfsd4_compound_state *cstate,
 	if (open->op_create && open->op_claim_type != NFS4_OPEN_CLAIM_NULL)
 		return nfserr_inval;
 
+	/*
+	 * RFC5661 18.51.3
+	 * Before RECLAIM_COMPLETE done, server should deny new lock
+	 */
+	if (nfsd4_has_session(cstate) &&
+	    !cstate->session->se_client->cl_firststate &&
+	    open->op_claim_type != NFS4_OPEN_CLAIM_PREVIOUS)
+		return nfserr_grace;
+
 	if (nfsd4_has_session(cstate))
 		copy_clientid(&open->op_clientid, cstate->session);
 

