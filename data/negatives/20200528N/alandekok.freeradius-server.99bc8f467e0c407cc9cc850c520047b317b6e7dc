commit 99bc8f467e0c407cc9cc850c520047b317b6e7dc
Author: Alan T. DeKok <aland@freeradius.org>
Date:   Tue May 4 11:30:50 2010 +0200

    Treat bad records as EOF.
    
    This helps when the disk is full, and rlm_detail writes a partial record.

diff --git a/src/main/detail.c b/src/main/detail.c
index 91f9503d1..54ce56161 100644
--- a/src/main/detail.c
+++ b/src/main/detail.c
@@ -580,7 +580,16 @@ int detail_recv(rad_listen_t *listener,
  alloc_packet:
 	data->tries++;
 	
-	rad_assert(data->state == STATE_QUEUED);
+	/*
+	 *	The writer doesn't check that the record was
+	 *	completely written.  If the disk is full, this can
+	 *	result in a truncated record.  When that happens,
+	 *	treat it as EOF.
+	 */
+	if (data->state != STATE_QUEUED) {
+		radlog(L_ERR, "Truncated record: treating it as EOF for detail file %s", data->filename_work);
+		goto cleanup;	  
+	}
 
 	/*
 	 *	We're done reading the file, but we didn't read

