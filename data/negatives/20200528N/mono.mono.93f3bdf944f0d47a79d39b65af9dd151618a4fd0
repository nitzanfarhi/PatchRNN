commit 93f3bdf944f0d47a79d39b65af9dd151618a4fd0
Author: Rodrigo Kumpera <kumpera@gmail.com>
Date:   Mon Feb 24 17:54:43 2014 -0500

    [sgen] We must do bridge processing with all sgen locks taken.

diff --git a/mono/metadata/sgen-stw.c b/mono/metadata/sgen-stw.c
index 12111cbc32d..b6fe446cc36 100755
--- a/mono/metadata/sgen-stw.c
+++ b/mono/metadata/sgen-stw.c
@@ -200,13 +200,13 @@ sgen_stop_world (int generation)
 {
 	int count, dead;
 
-	/*XXX this is the right stop, thought might not be the nicest place to put it*/
-	sgen_process_togglerefs ();
-
 	mono_profiler_gc_event (MONO_GC_EVENT_PRE_STOP_WORLD, generation);
 	MONO_GC_WORLD_STOP_BEGIN ();
 	acquire_gc_locks ();
 
+	/* We start to scan after locks are taking, this ensures we won't be interrupted. */
+	sgen_process_togglerefs ();
+
 	update_current_thread_stack (&count);
 
 	sgen_global_stop_count++;

