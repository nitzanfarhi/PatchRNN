commit de7ea885c5394c1fba7443cbf33bd2745d32e6c2
Author: Paolo Bonzini <pbonzini@redhat.com>
Date:   Thu Jun 18 18:47:26 2015 +0200

    kvm: Switch to unlocked MMIO
    
    Do not take the BQL before dispatching MMIO requests of KVM VCPUs.
    Instead, address_space_rw will do it if necessary. This enables completely
    BQL-free MMIO handling in KVM mode for upcoming devices with fine-grained
    locking.
    
    Signed-off-by: Paolo Bonzini <pbonzini@redhat.com>
    Message-Id: <1434646046-27150-10-git-send-email-pbonzini@redhat.com>

diff --git a/kvm-all.c b/kvm-all.c
index ad5ac5e3df..df57da0bf2 100644
--- a/kvm-all.c
+++ b/kvm-all.c
@@ -1814,13 +1814,12 @@ int kvm_cpu_exec(CPUState *cpu)
             break;
         case KVM_EXIT_MMIO:
             DPRINTF("handle_mmio\n");
-            qemu_mutex_lock_iothread();
+            /* Called outside BQL */
             address_space_rw(&address_space_memory,
                              run->mmio.phys_addr, attrs,
                              run->mmio.data,
                              run->mmio.len,
                              run->mmio.is_write);
-            qemu_mutex_unlock_iothread();
             ret = 0;
             break;
         case KVM_EXIT_IRQ_WINDOW_OPEN:

