commit 16367b702073ed1975366d81e1b9a0ae33d927e1
Author: Bram Matthys <syzop@vulnscan.org>
Date:   Sun Jun 21 10:21:46 2015 +0200

    cleanup deop and can kick call code (and fix bugs)

diff --git a/src/modules/m_kick.c b/src/modules/m_kick.c
index f4a77873..cdbf5ef2 100644
--- a/src/modules/m_kick.c
+++ b/src/modules/m_kick.c
@@ -94,7 +94,7 @@ CMD_FUNC(m_kick)
 	Membership *lp;
 	Hook *h;
 	int i = 0;
-	int ret, strict_ret;
+	int ret;
 
 	if (parc < 3 || *parv[1] == '\0')
 	{
@@ -152,18 +152,19 @@ CMD_FUNC(m_kick)
 				who_flags = get_access(who, chptr);
 
 				badkick = NULL;
-				ret = 0;
-				strict_ret = EX_ALLOW;
+				ret = EX_ALLOW;
 				for (h = Hooks[HOOKTYPE_CAN_KICK]; h; h = h->next) {
-					ret = (*(h->func.intfunc))(sptr, who, chptr, comment, sptr_flags, who_flags, &badkick);
+					int n = (*(h->func.intfunc))(sptr, who, chptr, comment, sptr_flags, who_flags, &badkick);
 
-					if (ret == EX_DENY)
-						strict_ret = ret;
-					else if (ret == EX_ALWAYS_DENY)
+					if (n == EX_DENY)
+						ret = n;
+					else if (n == EX_ALWAYS_DENY)
+					{
+						ret = n;
 						break;
+					}
 				}
-				ret = strict_ret; /* most strict one wins */
-				
+
 				if (ret == EX_ALWAYS_DENY)
 				{
 					if (MyClient(sptr) && badkick)
diff --git a/src/modules/m_mode.c b/src/modules/m_mode.c
index 1d24e44d..a1e18aed 100644
--- a/src/modules/m_mode.c
+++ b/src/modules/m_mode.c
@@ -916,19 +916,20 @@ int  do_mode_char(aChannel *chptr, long modetype, char modechar, char *param,
 		
 		  if (what == MODE_DEL)
 		  {
-		  	int ret = 0;
-		  	int strict_ret = EX_ALLOW;
+		  	int ret = EX_ALLOW;
 		  	char *badmode = NULL;
 		  	
 		  	for (h = Hooks[HOOKTYPE_MODE_DEOP]; h; h = h->next)
 		  	{
-		  		ret = (*(h->func.intfunc))(cptr, member->cptr, chptr, what, modechar, my_access, &badmode);
-		  		if (ret == EX_DENY)
-		  			strict_ret = ret;
-				else if (ret == EX_ALWAYS_DENY)
+		  		int n = (*(h->func.intfunc))(cptr, member->cptr, chptr, what, modechar, my_access, &badmode);
+		  		if (n == EX_DENY)
+		  			ret = n;
+				else if (n == EX_ALWAYS_DENY)
+				{
+					ret = n;
 					break;
+				}
 		  	}
-		  	ret = strict_ret; /* most strict one wins */
 		  	
 		  	if (ret == EX_ALWAYS_DENY)
 		  	{

