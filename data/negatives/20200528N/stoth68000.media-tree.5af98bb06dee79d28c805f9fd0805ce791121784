commit 5af98bb06dee79d28c805f9fd0805ce791121784
Author: Sarah Sharp <sarah.a.sharp@linux.intel.com>
Date:   Fri Mar 16 12:58:20 2012 -0700

    xhci: Warn when hosts don't halt.
    
    Eric Fu reports a problem with his VIA host controller fetching a zeroed
    event ring pointer on resume from suspend.  The host should have been
    halted, but we can't be sure because that code ignores the return value
    from xhci_halt().  Print a warning when the host controller refuses to
    halt within XHCI_MAX_HALT_USEC (currently 16 seconds).
    
    (Update: it turns out that the VIA host controller is reporting a halted
    state when it fetches the zeroed event ring pointer.  However, we still
    need this warning for other host controllers.)
    
    Signed-off-by: Sarah Sharp <sarah.a.sharp@linux.intel.com>

diff --git a/drivers/usb/host/xhci.c b/drivers/usb/host/xhci.c
index e1963d4a430f..f68bc15d21e8 100644
--- a/drivers/usb/host/xhci.c
+++ b/drivers/usb/host/xhci.c
@@ -106,6 +106,9 @@ int xhci_halt(struct xhci_hcd *xhci)
 			STS_HALT, STS_HALT, XHCI_MAX_HALT_USEC);
 	if (!ret)
 		xhci->xhc_state |= XHCI_STATE_HALTED;
+	else
+		xhci_warn(xhci, "Host not halted after %u microseconds.\n",
+				XHCI_MAX_HALT_USEC);
 	return ret;
 }
 

