commit ba80b5e7fcb3865aee28728381fcebcc81c685e0
Author: Andrew Beekhof <andrew@beekhof.net>
Date:   Wed Jul 25 09:48:32 2012 +1000

    High: ipc: Read up to 10 messages per mainloop invocation

diff --git a/lib/common/ipc.c b/lib/common/ipc.c
index c73361adc..79f6c6dd6 100644
--- a/lib/common/ipc.c
+++ b/lib/common/ipc.c
@@ -428,7 +428,7 @@ crm_ipc_read(crm_ipc_t *client)
     crm_trace("Message recieved on %s IPC connection", client->name);
 
     client->buffer[0] = 0;
-    client->msg_size = qb_ipcc_event_recv(client->ipc, client->buffer, client->buf_size-1, -1);
+    client->msg_size = qb_ipcc_event_recv(client->ipc, client->buffer, client->buf_size-1, 100);
     if(client->msg_size >= 0) {
         struct qb_ipc_response_header *header = (struct qb_ipc_response_header *)client->buffer;
         client->buffer[client->msg_size] = 0;
diff --git a/lib/common/mainloop.c b/lib/common/mainloop.c
index fd0b8154f..99ff67a28 100644
--- a/lib/common/mainloop.c
+++ b/lib/common/mainloop.c
@@ -510,19 +510,24 @@ mainloop_gio_callback(GIOChannel *gio, GIOCondition condition, gpointer data)
 
     if(condition & G_IO_IN) {
         if(client->ipc) {
-            long rc = crm_ipc_read(client->ipc);
-            crm_trace("New message from %s[%p] = %d", client->name, client, rc);
-
-            if(rc <= 0) {
-                crm_perror(LOG_TRACE, "Message acquisition failed: %ld", rc);
-        
-            } else if(client->dispatch_fn_ipc) {
-                const char *buffer = crm_ipc_buffer(client->ipc);
-                if(client->dispatch_fn_ipc(buffer, rc, client->userdata) < 0) {
-                    crm_trace("Connection to %s no longer required", client->name);
-                    keep = FALSE;
+            long rc = 0;
+            int max = 10;
+            do {
+                rc = crm_ipc_read(client->ipc);
+                crm_trace("New message from %s[%p] = %d", client->name, client, rc);
+
+                if(rc <= 0) {
+                    crm_perror(LOG_TRACE, "Message acquisition failed: %ld", rc);
+
+                } else if(client->dispatch_fn_ipc) {
+                    const char *buffer = crm_ipc_buffer(client->ipc);
+                    if(client->dispatch_fn_ipc(buffer, rc, client->userdata) < 0) {
+                        crm_trace("Connection to %s no longer required", client->name);
+                        keep = FALSE;
+                    }
                 }
-            }
+
+            } while(keep && rc > 0 && --max > 0);
 
         } else {
             crm_trace("New message from %s[%p]", client->name, client);

