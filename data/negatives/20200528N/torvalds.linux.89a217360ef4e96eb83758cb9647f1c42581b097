commit 89a217360ef4e96eb83758cb9647f1c42581b097
Author: Trond Myklebust <Trond.Myklebust@netapp.com>
Date:   Fri May 25 15:00:06 2012 -0400

    NFSv4.1: Handle NFS4ERR_SEQ_MISORDERED when confirming the lease
    
    Apparently the patch "NFS: Always use the same SETCLIENTID boot verifier"
    is tickling a Linux nfs server bug, and causing a regression: the server
    can get into a situation where it keeps replying NFS4ERR_SEQ_MISORDERED
    to our CREATE_SESSION request even when we are sending the correct
    sequence ID.
    
    Fix this by purging the lease and then retrying.
    
    Reported-by: Bryan Schumaker <bjschuma@netapp.com>
    Signed-off-by: Trond Myklebust <Trond.Myklebust@netapp.com>

diff --git a/fs/nfs/nfs4state.c b/fs/nfs/nfs4state.c
index 604c6009d1ac..419f8c44429e 100644
--- a/fs/nfs/nfs4state.c
+++ b/fs/nfs/nfs4state.c
@@ -1580,6 +1580,11 @@ static int nfs4_check_lease(struct nfs_client *clp)
 static int nfs4_handle_reclaim_lease_error(struct nfs_client *clp, int status)
 {
 	switch (status) {
+	case -NFS4ERR_SEQ_MISORDERED:
+		if (test_and_set_bit(NFS4CLNT_PURGE_STATE, &clp->cl_state))
+			return -ESERVERFAULT;
+		/* Lease confirmation error: retry after purging the lease */
+		ssleep(1);
 	case -NFS4ERR_CLID_INUSE:
 	case -NFS4ERR_STALE_CLIENTID:
 		clear_bit(NFS4CLNT_LEASE_CONFIRM, &clp->cl_state);

