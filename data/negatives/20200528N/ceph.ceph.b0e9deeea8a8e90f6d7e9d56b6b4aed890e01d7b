commit b0e9deeea8a8e90f6d7e9d56b6b4aed890e01d7b
Author: Greg Farnum <gfarnum@redhat.com>
Date:   Thu May 25 21:52:49 2017 -0700

    osd: Reset() the snaptrimmer on shutdown
    
    We were failing to exit various wait states which held PGRefs. Error!
    
    Fixes: http://tracker.ceph.com/issues/19931
    
    Signed-off-by: Greg Farnum <gfarnum@redhat.com>

diff --git a/src/osd/PrimaryLogPG.cc b/src/osd/PrimaryLogPG.cc
index c3539c1dbc..c8fc5cb5b1 100644
--- a/src/osd/PrimaryLogPG.cc
+++ b/src/osd/PrimaryLogPG.cc
@@ -10446,6 +10446,8 @@ void PrimaryLogPG::on_shutdown()
   cancel_log_updates();
   // we must remove PGRefs, so do this this prior to release_backoffs() callers
   clear_backoffs(); 
+  // clean up snap trim references
+  snap_trimmer_machine.process_event(Reset());
 
   pgbackend->on_change();
 

