commit 6c4060a4fe863e560904f4e01f54745fe64e563c
Author: Timo Sirainen <timo.sirainen@dovecot.fi>
Date:   Thu May 3 18:30:51 2018 +0300

    fts: Make sure indexing virtual mailbox doesn't recurse and index mail multiple times

diff --git a/src/plugins/fts/fts-storage.c b/src/plugins/fts/fts-storage.c
index deda16785..cdf1fc50a 100644
--- a/src/plugins/fts/fts-storage.c
+++ b/src/plugins/fts/fts-storage.c
@@ -58,6 +58,7 @@ struct fts_transaction_context {
 	uint32_t highest_virtual_uid;
 	unsigned int precache_extra_count;
 
+	bool indexing:1;
 	bool precached:1;
 	bool mails_saved:1;
 	bool failed:1;
@@ -529,8 +530,12 @@ static void fts_mail_precache(struct mail *_mail)
 	if (fmail->virtual_mail) {
 		if (ft->highest_virtual_uid < _mail->uid)
 			ft->highest_virtual_uid = _mail->uid;
-	} else T_BEGIN {
+	} else if (!ft->indexing) T_BEGIN {
+		/* avoid recursing here from fts_mail_precache_range() */
+		ft->indexing = TRUE;
 		fts_mail_index(_mail);
+		i_assert(ft->indexing);
+		ft->indexing = FALSE;
 	} T_END;
 }
 

