commit a532321bc4525493c0c4f6b648bed7b62ca3dc9c
Author: Mark Probst <mark.probst@gmail.com>
Date:   Thu Dec 11 14:57:58 2014 -0800

    [sgen] Fix evacuation.
    
    We can't dereference an object's VTable before we know that it's not
    tagged.  In this case, forwarded.  The access would be unaligned and
    might even fault.

diff --git a/mono/metadata/sgen-marksweep-drain-gray-stack.h b/mono/metadata/sgen-marksweep-drain-gray-stack.h
index da962a81b8f..b4e383cf8c5 100644
--- a/mono/metadata/sgen-marksweep-drain-gray-stack.h
+++ b/mono/metadata/sgen-marksweep-drain-gray-stack.h
@@ -130,8 +130,8 @@ COPY_OR_MARK_FUNCTION_NAME (void **ptr, void *obj, SgenGrayQueue *queue)
 		return FALSE;
 	} else {
 		mword vtable_word = *(mword*)obj;
-		mword desc = sgen_vtable_get_descriptor ((MonoVTable*)vtable_word);
-		int type = desc & DESC_TYPE_MASK;
+		mword desc;
+		int type;
 
 		HEAVY_STAT (++stat_optimized_copy_major);
 
@@ -147,6 +147,11 @@ COPY_OR_MARK_FUNCTION_NAME (void **ptr, void *obj, SgenGrayQueue *queue)
 		}
 #endif
 
+		SGEN_ASSERT (9, !SGEN_VTABLE_IS_PINNED (vtable_word), "Pinned object in non-pinned block?");
+
+		desc = sgen_vtable_get_descriptor ((MonoVTable*)vtable_word);
+		type = desc & DESC_TYPE_MASK;
+
 		if (type <= DESC_TYPE_MAX_SMALL_OBJ || SGEN_ALIGN_UP (sgen_safe_object_get_size ((MonoObject*)obj)) <= SGEN_MAX_SMALL_OBJ_SIZE) {
 #ifdef HEAVY_STATISTICS
 			if (type <= DESC_TYPE_MAX_SMALL_OBJ)
diff --git a/mono/metadata/sgen-marksweep.c b/mono/metadata/sgen-marksweep.c
index 474b97c503e..1aaf2e43db1 100644
--- a/mono/metadata/sgen-marksweep.c
+++ b/mono/metadata/sgen-marksweep.c
@@ -138,8 +138,7 @@ static int fast_block_obj_size_indexes [MS_NUM_FAST_BLOCK_OBJ_SIZE_INDEXES];
 #define MS_BLOCK_TYPE_MAX	4
 
 static gboolean *evacuate_block_obj_sizes;
-/* Evacuation is broken right now, so disable by default. */
-static float evacuation_threshold = 0; //0.666f;
+static float evacuation_threshold = 0.666f;
 static float concurrent_evacuation_threshold = 0.666f;
 static gboolean want_evacuation = FALSE;
 

