commit d5774b93f04252b81bd2c2cc84ec663c6aa798d1
Author: Jiri Pirko <jiri@mellanox.com>
Date:   Mon Mar 6 16:39:53 2017 +0100

    flow_dissector: Fix GRE header error path
    
    Now, when an unexpected element in the GRE header appears, we break so
    the l4 ports are processed. But since the ports are processed
    unconditionally, there will be certainly random values dissected. Fix
    this by just bailing out in such situations.
    
    Signed-off-by: Jiri Pirko <jiri@mellanox.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

diff --git a/net/core/flow_dissector.c b/net/core/flow_dissector.c
index 8d012987e3c3..cefaf2368a3f 100644
--- a/net/core/flow_dissector.c
+++ b/net/core/flow_dissector.c
@@ -479,18 +479,18 @@ bool __skb_flow_dissect(const struct sk_buff *skb,
 
 		/* Only look inside GRE without routing */
 		if (hdr->flags & GRE_ROUTING)
-			break;
+			goto out_good;
 
 		/* Only look inside GRE for version 0 and 1 */
 		gre_ver = ntohs(hdr->flags & GRE_VERSION);
 		if (gre_ver > 1)
-			break;
+			goto out_good;
 
 		proto = hdr->protocol;
 		if (gre_ver) {
 			/* Version1 must be PPTP, and check the flags */
 			if (!(proto == GRE_PROTO_PPP && (hdr->flags & GRE_KEY)))
-				break;
+				goto out_good;
 		}
 
 		offset += sizeof(struct gre_base_hdr);

