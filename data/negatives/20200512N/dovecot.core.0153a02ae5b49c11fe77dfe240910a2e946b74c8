commit 0153a02ae5b49c11fe77dfe240910a2e946b74c8
Author: Timo Sirainen <tss@iki.fi>
Date:   Thu May 20 09:25:47 2010 +0200

    imap parser: Fail immediately if we see unexpected ')' while reading atom.
    
    --HG--
    branch : HEAD

diff --git a/src/lib-imap/imap-parser.c b/src/lib-imap/imap-parser.c
index 1f76d38cd..f7146cca2 100644
--- a/src/lib-imap/imap-parser.c
+++ b/src/lib-imap/imap-parser.c
@@ -264,11 +264,13 @@ static int imap_parser_read_atom(struct imap_parser *parser,
 			imap_parser_save_arg(parser, data, i);
 			break;
 		} else if (data[i] == ')') {
-			if (parser->list_arg != NULL ||
-			    (parser->flags &
-			     IMAP_PARSE_FLAG_ATOM_ALLCHARS) == 0) {
+			if (parser->list_arg != NULL) {
 				imap_parser_save_arg(parser, data, i);
 				break;
+			} else if ((parser->flags &
+				    IMAP_PARSE_FLAG_ATOM_ALLCHARS) == 0) {
+				parser->error = "Unexpected ')'";
+				return FALSE;
 			}
 			/* assume it's part of the atom */
 		} else if (!is_valid_atom_char(parser, data[i]))

