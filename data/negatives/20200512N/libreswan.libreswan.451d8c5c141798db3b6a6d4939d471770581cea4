commit 451d8c5c141798db3b6a6d4939d471770581cea4
Author: Paul Wouters <pwouters@redhat.com>
Date:   Sun Feb 15 20:18:00 2015 +0800

    IKEv2: send_v2_notification() used hardcoded ISAKMP_v2_SA_INIT exchange
    
    If an ID is mismatched, and we find out during IKE_AUTH, we sent
    an error back using the wrong exchange type. The value is now part
    of a switch, which still needs to be extended, but should handle
    the error in IKE_AUTH now.

diff --git a/programs/pluto/ikev2_parent.c b/programs/pluto/ikev2_parent.c
index 6762fbafa..01c982123 100644
--- a/programs/pluto/ikev2_parent.c
+++ b/programs/pluto/ikev2_parent.c
@@ -2993,7 +2993,18 @@ void send_v2_notification(struct state *p1st,
 		if (rcookie != NULL) /* some responses are with zero rSPI */
 			memcpy(hdr.isa_rcookie, rcookie, COOKIE_SIZE);
 		memcpy(hdr.isa_icookie, icookie, COOKIE_SIZE);
-		hdr.isa_xchg = ISAKMP_v2_SA_INIT;
+
+		/* incomplete */
+		switch (p1st->st_state) {
+		case STATE_PARENT_R1:
+			hdr.isa_xchg = ISAKMP_v2_AUTH;
+			break;
+		default:
+			/* default to old behaviour of hardcoding ISAKMP_v2_SA_INIT */
+			hdr.isa_xchg = ISAKMP_v2_SA_INIT;
+			break;
+		}
+
 		hdr.isa_np = ISAKMP_NEXT_v2N;
 		/* XXX unconditionally clearing original initiator flag is wrong */
 		hdr.isa_flags &= ~ISAKMP_FLAGS_v2_IKE_I;

