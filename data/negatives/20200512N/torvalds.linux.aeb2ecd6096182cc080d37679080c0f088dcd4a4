commit aeb2ecd6096182cc080d37679080c0f088dcd4a4
Author: Tejun Heo <htejun@gmail.com>
Date:   Mon Jun 12 14:11:43 2006 +0900

    [PATCH] libata: fast exit from EH while unloading
    
    Make EH exit fast if the port is being unloaded.
    
    Signed-off-by: Tejun Heo <htejun@gmail.com>
    Signed-off-by: Jeff Garzik <jeff@garzik.org>

diff --git a/drivers/scsi/libata-eh.c b/drivers/scsi/libata-eh.c
index 782dfba573a9..531a4e11c078 100644
--- a/drivers/scsi/libata-eh.c
+++ b/drivers/scsi/libata-eh.c
@@ -1680,6 +1680,10 @@ static int ata_eh_recover(struct ata_port *ap, ata_prereset_fn_t prereset,
 	down_xfermask = 0;
 	rc = 0;
 
+	/* if UNLOADING, finish immediately */
+	if (ap->flags & ATA_FLAG_UNLOADING)
+		goto out;
+
 	/* skip EH if possible. */
 	if (ata_eh_skip_recovery(ap))
 		ehc->i.action = 0;

