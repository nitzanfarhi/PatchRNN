commit f00e6aa66b34910d24fa464cabb82f8e83f87bc8
Author: darrenm <none@none>
Date:   Mon Feb 13 02:31:44 2006 -0800

    6382160 login(1)/su(1m) not passing PAM_CHANGE_EXPIRED_AUTHTOK to pam_chauthtok

diff --git a/usr/src/cmd/login/login.c b/usr/src/cmd/login/login.c
index 35d559c4bd..bdf7e6dc7c 100644
--- a/usr/src/cmd/login/login.c
+++ b/usr/src/cmd/login/login.c
@@ -20,7 +20,7 @@
  * CDDL HEADER END
  */
 /*
- * Copyright 2005 Sun Microsystems, Inc.  All rights reserved.
+ * Copyright 2006 Sun Microsystems, Inc.  All rights reserved.
  * Use is subject to license terms.
  */
 
@@ -1658,10 +1658,12 @@ validate_account(void)
 
 				(void) printf("Choose a new password.\n");
 
-				error = pam_chauthtok(pamh, 0);
+				error = pam_chauthtok(pamh,
+				    PAM_CHANGE_EXPIRED_AUTHTOK);
 				if (error == PAM_TRY_AGAIN) {
 					(void) sleep(1);
-					error = pam_chauthtok(pamh, 0);
+					error = pam_chauthtok(pamh,
+					    PAM_CHANGE_EXPIRED_AUTHTOK);
 				}
 				tries++;
 			}
diff --git a/usr/src/cmd/su/su.c b/usr/src/cmd/su/su.c
index dee728ac31..d6a97ff16d 100644
--- a/usr/src/cmd/su/su.c
+++ b/usr/src/cmd/su/su.c
@@ -20,7 +20,7 @@
  * CDDL HEADER END
  */
 /*
- * Copyright 2005 Sun Microsystems, Inc.  All rights reserved.
+ * Copyright 2006 Sun Microsystems, Inc.  All rights reserved.
  * Use is subject to license terms.
  */
 
@@ -1130,8 +1130,8 @@ validate(char *usernam, int *pw_change)
 			tries = 0;
 			message(ERR, gettext("Password for user "
 			    "'%s' has expired"), pwd.pw_name);
-			while ((error = pam_chauthtok(pamh, 0)) !=
-			    PAM_SUCCESS) {
+			while ((error = pam_chauthtok(pamh,
+			    PAM_CHANGE_EXPIRED_AUTHTOK)) != PAM_SUCCESS) {
 				if ((error == PAM_AUTHTOK_ERR ||
 				    error == PAM_TRY_AGAIN) &&
 				    (tries++ < DEF_ATTEMPTS)) {

