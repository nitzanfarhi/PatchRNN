commit 95c43f507c05aa5a6a8c87da6c2ec2013d70c7e4
Author: Ken Murchison <murch@fastmail.com>
Date:   Sun Sep 9 10:23:09 2018 -0400

    http_jmap.c: fromAccountId and toAccountId need to default to accountId in Foo/copy

diff --git a/imap/http_jmap.c b/imap/http_jmap.c
index 5b75cd49e..4c793c0af 100644
--- a/imap/http_jmap.c
+++ b/imap/http_jmap.c
@@ -2002,9 +2002,6 @@ static int jmap_blob_copy(jmap_req_t *req)
         if (!strcmp(key, "fromAccountId")) {
             if (json_is_string(arg)) {
                 from_accountid = json_string_value(arg);
-                if (from_accountid == NULL) {
-                    from_accountid = req->userid;
-                }
             }
             else if (JNOTNULL(arg)) {
                 json_array_append_new(invalid, json_string("fromAccountId"));
@@ -2014,9 +2011,6 @@ static int jmap_blob_copy(jmap_req_t *req)
         else if (!strcmp(key, "toAccountId")) {
             if (json_is_string(arg)) {
                 to_accountid = json_string_value(arg);
-                if (to_accountid == NULL) {
-                    to_accountid = req->userid;
-                }
             }
             else if (JNOTNULL(arg)) {
                 json_array_append_new(invalid, json_string("toAccountId"));
@@ -2054,6 +2048,13 @@ static int jmap_blob_copy(jmap_req_t *req)
     }
     json_decref(invalid);
 
+    if (from_accountid == NULL) {
+        from_accountid = req->userid;
+    }
+    if (to_accountid == NULL) {
+        to_accountid = req->userid;
+    }
+
     /* No return from here on */
     struct mailbox *to_mbox = NULL;
     json_t *not_copied = json_object();
@@ -3072,9 +3073,6 @@ EXPORTED void jmap_copy_parse(json_t *jargs,
             else if (JNOTNULL(arg)) {
                 jmap_parser_invalid(parser, "fromAccountId");
             }
-            else {
-                copy->from_account_id = req->accountid;
-            }
         }
 
         /* toAccountId */
@@ -3085,9 +3083,6 @@ EXPORTED void jmap_copy_parse(json_t *jargs,
             else if (JNOTNULL(arg)) {
                 jmap_parser_invalid(parser, "toAccountId");
             }
-            else {
-                copy->to_account_id = req->accountid;
-            }
         }
 
         /* create */
@@ -3137,6 +3132,13 @@ EXPORTED void jmap_copy_parse(json_t *jargs,
         *err = json_pack("{s:s s:O}", "type", "invalidArguments",
                 "arguments", parser->invalid);
     }
+
+    if (!copy->from_account_id) {
+        copy->from_account_id = req->accountid;
+    }
+    if (!copy->to_account_id) {
+        copy->to_account_id = req->accountid;
+    }
 }
 
 

