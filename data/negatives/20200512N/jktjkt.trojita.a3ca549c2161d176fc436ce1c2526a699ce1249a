commit a3ca549c2161d176fc436ce1c2526a699ce1249a
Author: Jan Kundr√°t <jkt@gentoo.org>
Date:   Wed Jul 21 11:23:26 2010 +0200

    Check uidvalidity when copying messages around

diff --git a/src/Imap/Model/MailboxModel.cpp b/src/Imap/Model/MailboxModel.cpp
index 702319d1..07adbe35 100644
--- a/src/Imap/Model/MailboxModel.cpp
+++ b/src/Imap/Model/MailboxModel.cpp
@@ -318,6 +318,13 @@ bool MailboxModel::dropMimeData( const QMimeData* data, Qt::DropAction action,
         return false;
     }
 
+    uint uidValidity;
+    stream >> uidValidity;
+    if ( uidValidity != origMbox->syncState.uidValidity() ) {
+        qDebug() << "UID validity for original mailbox got changed, can't copy messages";
+        return false;
+    }
+
     Imap::Sequence seq;
     while ( ! stream.atEnd() ) {
         uint uid;
diff --git a/src/Imap/Model/MsgListModel.cpp b/src/Imap/Model/MsgListModel.cpp
index b01b185c..cccc15e4 100644
--- a/src/Imap/Model/MsgListModel.cpp
+++ b/src/Imap/Model/MsgListModel.cpp
@@ -321,7 +321,7 @@ QMimeData* MsgListModel::mimeData( const QModelIndexList& indexes ) const
     TreeItemMailbox* mailbox = dynamic_cast<TreeItemMailbox*>( Model::realTreeItem(
             indexes.front() )->parent()->parent() );
     Q_ASSERT( mailbox );
-    stream << mailbox->mailbox();
+    stream << mailbox->mailbox() << mailbox->syncState.uidValidity();
 
     for ( QModelIndexList::const_iterator it = indexes.begin(); it != indexes.end(); ++it ) {
         TreeItemMessage* message = dynamic_cast<TreeItemMessage*>( Model::realTreeItem( *it ) );

