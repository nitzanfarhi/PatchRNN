commit 35841b6c6d2fcc7aca61d02ce7b60c30eb9e7e95
Author: Guillaume Melquiond <guillaume.melquiond@gmail.com>
Date:   Sat Mar 26 09:06:17 2005 +0000

    Now that we are using streams,
    
    ...we can't afford to go back at the start of it in case of wrong
    detection. So let's detect the format by just peeking the first
    character.

diff --git a/src/serialization/binary_or_text.cpp b/src/serialization/binary_or_text.cpp
index 541b30fd97..52f2ff8b04 100644
--- a/src/serialization/binary_or_text.cpp
+++ b/src/serialization/binary_or_text.cpp
@@ -21,14 +21,14 @@
 
 bool detect_format_and_read(config &cfg, std::istream &in)
 {
-	try {
+	unsigned char c = in.peek();
+	if (c < 5) {
 		read_compressed(cfg, in);
 		return true;
-	} catch (config::error &) {
+	} else {
+		read(cfg, in);
+		return false;
 	}
-
-	read(cfg, in);
-	return false;
 }
 
 void write_possibly_compressed(std::string const &filename, config &cfg, bool compress)

