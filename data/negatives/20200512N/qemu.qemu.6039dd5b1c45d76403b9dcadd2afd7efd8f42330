commit 6039dd5b1c45d76403b9dcadd2afd7efd8f42330
Author: Dr. David Alan Gilbert <dgilbert@redhat.com>
Date:   Mon Feb 5 09:13:37 2018 +0000

    migration: Recover block devices if failure in device state
    
    In e91d895 I added the new pause-before-switchover mechanism
    to allow migration completion to be delayed; this changes the
    last state prior to completion to MIGRATE_STATUS_DEVICE rather
    than MIGRATE_STATUS_ACTIVE.
    
    Fix the failure path in migration_completion to recover the block
    devices if it fails in MIGRATE_STATUS_DEVICE, not just the
    MIGRATE_STATUS_ACTIVE that it previously had.
    
    This corresponds to rh bz:
      https://bugzilla.redhat.com/show_bug.cgi?id=1538494
    whose symptom is an occasional source crash on a failed migration.
    
    Fixes: e91d8951d59d483f085f
    Signed-off-by: Dr. David Alan Gilbert <dgilbert@redhat.com>
    Reviewed-by: Peter Xu <peterx@redhat.com>
    Signed-off-by: Dr. David Alan Gilbert <dgilbert@redhat.com>

diff --git a/migration/migration.c b/migration/migration.c
index 44cbfb0ddd..0fdb2e410d 100644
--- a/migration/migration.c
+++ b/migration/migration.c
@@ -2122,7 +2122,8 @@ fail_invalidate:
     /* If not doing postcopy, vm_start() will be called: let's regain
      * control on images.
      */
-    if (s->state == MIGRATION_STATUS_ACTIVE) {
+    if (s->state == MIGRATION_STATUS_ACTIVE ||
+        s->state == MIGRATION_STATUS_DEVICE) {
         Error *local_err = NULL;
 
         qemu_mutex_lock_iothread();

