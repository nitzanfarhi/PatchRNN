commit 5e69206e0b13bbe3dbc50c5dc6c58da007402237
Author: Timo Sirainen <tss@iki.fi>
Date:   Tue Nov 7 23:33:51 2006 +0200

    When verifying the header, check that next_uid is larger than last message's
    UID.
    
    --HG--
    branch : HEAD

diff --git a/src/lib-index/mail-index.c b/src/lib-index/mail-index.c
index 43a66adc9..b3a0d68c8 100644
--- a/src/lib-index/mail-index.c
+++ b/src/lib-index/mail-index.c
@@ -560,6 +560,15 @@ static int mail_index_check_header(struct mail_index *index,
 	    hdr->first_deleted_uid_lowwater > hdr->next_uid)
 		return 0;
 
+	if (map->records_count > 0) {
+		/* last message's UID must be smaller than next_uid */
+		const struct mail_index_record *rec;
+
+		rec = MAIL_INDEX_MAP_IDX(map, map->records_count-1);
+		if (rec->uid >= hdr->next_uid)
+			return 0;
+	}
+
 	return mail_index_parse_extensions(index, map);
 }
 

