commit 69766a113f213503940de1dd962bd1ef3fe9a62e
Author: Alan T. DeKok <aland@freeradius.org>
Date:   Thu Sep 29 18:03:23 2011 +0200

    Load "server {...}" sections properly

diff --git a/src/main/modules.c b/src/main/modules.c
index 2ef969ce5..f01531bd7 100644
--- a/src/main/modules.c
+++ b/src/main/modules.c
@@ -1280,13 +1280,15 @@ int virtual_servers_load(CONF_SECTION *config)
 	 *	In either case, load the "default" virtual server first.
 	 *	this matches better iwth users expectations.
 	 */
-	cs = cf_section_find_name2(config, "server", NULL);
-	if (!cs) {
-		if (load_byserver(config) < 0) {
+	cs = cf_section_find_name2(cf_subsection_find_next(config, NULL,
+							   "server"),
+				   "server", NULL);
+	if (cs) {
+		if (load_byserver(cs) < 0) {
 			return -1;
 		}
 	} else {
-		if (load_byserver(cs) < 0) {
+		if (load_byserver(config) < 0) {
 			return -1;
 		}
 	}

