commit bb685a402f5ca873f1896640abacbb392e040157
Author: Zeev Suraski <zeev@php.net>
Date:   Fri Mar 1 12:00:05 2002 +0000

    Fix php_splice() to work with large values

diff --git a/ext/standard/array.c b/ext/standard/array.c
index d80ac32507..106ea8d23f 100644
--- a/ext/standard/array.c
+++ b/ext/standard/array.c
@@ -1529,7 +1529,17 @@ HashTable* php_splice(HashTable *in_hash, int offset, int length,
 		   and copy it into the output hash */
 		for (i=0; i<list_count; i++) {
 			entry = *list[i];
-			entry->refcount++;
+			if (entry->refcount>=1000) {
+				zval *tmp = (zval *) emalloc(sizeof(zval));
+
+				*tmp = *entry;
+				zval_copy_ctor(tmp);
+				tmp->refcount = 1;
+				tmp->is_ref = 0;
+				entry = tmp;
+			} else {
+				entry->refcount++;
+			}
 			zend_hash_next_index_insert(out_hash, &entry, sizeof(zval *), NULL);
 		}
 	}

