commit ef31a55cf4557a848d7024962758508fb4d59773
Author: vk154806 <none@none>
Date:   Thu Jun 15 06:05:32 2006 -0700

    6389488 new fsck_ufs(1M) complains about CG XXXX: IMPOSSIBLE NUMBER OF CYLINDERS IN GROUP

diff --git a/usr/src/cmd/fs.d/ufs/fsck/pass5.c b/usr/src/cmd/fs.d/ufs/fsck/pass5.c
index c4c95e0511..15768dbdd6 100644
--- a/usr/src/cmd/fs.d/ufs/fsck/pass5.c
+++ b/usr/src/cmd/fs.d/ufs/fsck/pass5.c
@@ -1,5 +1,5 @@
 /*
- * Copyright 2005 Sun Microsystems, Inc.  All rights reserved.
+ * Copyright 2006 Sun Microsystems, Inc.  All rights reserved.
  * Use is subject to license terms.
  */
 
@@ -171,7 +171,7 @@ pass5(void)
 			dmax = fs->fs_size;
 		newcg->cg_ndblk = dmax - dbase;
 		if (c == fs->fs_ncg - 1)
-			newcg->cg_ncyl = fs->fs_ncyl % fs->fs_cpg;
+			newcg->cg_ncyl = fs->fs_ncyl - (fs->fs_cpg * c);
 		else
 			newcg->cg_ncyl = fs->fs_cpg;
 		newcg->cg_niblk = sblock.fs_ipg;
diff --git a/usr/src/cmd/fs.d/ufs/fsck/utilities.c b/usr/src/cmd/fs.d/ufs/fsck/utilities.c
index 6e49530bf9..26d816b47a 100644
--- a/usr/src/cmd/fs.d/ufs/fsck/utilities.c
+++ b/usr/src/cmd/fs.d/ufs/fsck/utilities.c
@@ -2094,9 +2094,9 @@ fix_cg(struct cg *cgp, int cgno)
 	}
 
 	if ((cgp->cg_ncyl < 1) || (cgp->cg_ncyl > sblock.fs_cpg)) {
-		if (cgno == sblock.fs_ncg) {
+		if (cgno == (sblock.fs_ncg - 1)) {
 			cgp->cg_ncyl = sblock.fs_ncyl -
-				(sblock.fs_ncg * (cgno - 1));
+				(sblock.fs_cpg * cgno);
 		} else {
 			cgp->cg_ncyl = sblock.fs_cpg;
 		}

