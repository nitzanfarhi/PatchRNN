commit 6632210f50530ea53dd21f786f2854609d928689
Author: Dave Young <dyoung@redhat.com>
Date:   Mon Aug 18 09:30:07 2014 +0800

    arm64/efi: Do not enter virtual mode if booting with efi=noruntime or noefi
    
    In case efi runtime disabled via noefi kernel cmdline
    arm64_enter_virtual_mode should error out.
    
    At the same time move early_memunmap(memmap.map, mapsize) to the
    beginning of the function or it will leak early mem.
    
    Signed-off-by: Dave Young <dyoung@redhat.com>
    Reviewed-by: Will Deacon <will.deacon@arm.com>
    Signed-off-by: Matt Fleming <matt.fleming@intel.com>

diff --git a/arch/arm64/kernel/efi.c b/arch/arm64/kernel/efi.c
index 6ed0362dd579..8f5db4a3c9d9 100644
--- a/arch/arm64/kernel/efi.c
+++ b/arch/arm64/kernel/efi.c
@@ -392,11 +392,16 @@ static int __init arm64_enter_virtual_mode(void)
 		return -1;
 	}
 
-	pr_info("Remapping and enabling EFI services.\n");
-
-	/* replace early memmap mapping with permanent mapping */
 	mapsize = memmap.map_end - memmap.map;
 	early_memunmap(memmap.map, mapsize);
+
+	if (efi_runtime_disabled()) {
+		pr_info("EFI runtime services will be disabled.\n");
+		return -1;
+	}
+
+	pr_info("Remapping and enabling EFI services.\n");
+	/* replace early memmap mapping with permanent mapping */
 	memmap.map = (__force void *)ioremap_cache((phys_addr_t)memmap.phys_map,
 						   mapsize);
 	memmap.map_end = memmap.map + mapsize;

