commit 88674088d10ca2538b2efd2559f6620ade8ec373
Author: Matthew Garrett <mjg@redhat.com>
Date:   Mon Apr 16 16:26:04 2012 -0400

    x86: Use vga_default_device() when determining whether an fb is primary
    
    IORESOURCE_ROM_SHADOW is not necessarily an indication that the hardware
    is the primary device. Add support for using the vgaarb functions and
    fall back if nothing's set them.
    
    Signed-off-by: Matthew Garrett <mjg@redhat.com>
    Cc: mingo@redhat.com
    Acked-by: hpa@zytor.com
    Signed-off-by: Dave Airlie <airlied@redhat.com>

diff --git a/arch/x86/video/fbdev.c b/arch/x86/video/fbdev.c
index c5ffb6ac8707..d5644bbe8cba 100644
--- a/arch/x86/video/fbdev.c
+++ b/arch/x86/video/fbdev.c
@@ -9,24 +9,34 @@
 #include <linux/fb.h>
 #include <linux/pci.h>
 #include <linux/module.h>
+#include <linux/vgaarb.h>
 
 int fb_is_primary_device(struct fb_info *info)
 {
 	struct device *device = info->device;
 	struct pci_dev *pci_dev = NULL;
+	struct pci_dev *default_device = vga_default_device();
 	struct resource *res = NULL;
-	int retval = 0;
 
 	if (device)
 		pci_dev = to_pci_dev(device);
 
-	if (pci_dev)
-		res = &pci_dev->resource[PCI_ROM_RESOURCE];
+	if (!pci_dev)
+		return 0;
+
+	if (default_device) {
+		if (pci_dev == default_device)
+			return 1;
+		else
+			return 0;
+	}
+
+	res = &pci_dev->resource[PCI_ROM_RESOURCE];
 
 	if (res && res->flags & IORESOURCE_ROM_SHADOW)
-		retval = 1;
+		return 1;
 
-	return retval;
+	return 0;
 }
 EXPORT_SYMBOL(fb_is_primary_device);
 MODULE_LICENSE("GPL");

