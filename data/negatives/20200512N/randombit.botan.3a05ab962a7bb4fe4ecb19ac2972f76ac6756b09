commit 3a05ab962a7bb4fe4ecb19ac2972f76ac6756b09
Author: lloyd <lloyd@randombit.net>
Date:   Fri Sep 7 19:17:08 2012 +0000

    Take version from pending state for creating cipher spec

diff --git a/src/tls/tls_channel.cpp b/src/tls/tls_channel.cpp
index e54af7f0b..255d7813a 100644
--- a/src/tls/tls_channel.cpp
+++ b/src/tls/tls_channel.cpp
@@ -86,7 +86,7 @@ void Channel::change_cipher_spec_reader(Connection_Side side)
    side = (side == CLIENT) ? SERVER : CLIENT;
 
    m_read_cipherstate.reset(
-      new Connection_Cipher_State(current_protocol_version(),
+      new Connection_Cipher_State(m_pending_state->version(),
                                   side,
                                   m_pending_state->ciphersuite(),
                                   m_pending_state->session_keys())
@@ -109,13 +109,13 @@ void Channel::change_cipher_spec_writer(Connection_Side side)
 
    For DTLS, increment the epoch
    */
-   if(current_protocol_version().is_datagram_protocol())
+   if(m_pending_state->version().is_datagram_protocol())
       m_write_seq_no = ((m_write_seq_no >> 48) + 1) << 48;
    else
       m_write_seq_no = 0;
 
    m_write_cipherstate.reset(
-      new Connection_Cipher_State(current_protocol_version(),
+      new Connection_Cipher_State(m_pending_state->version(),
                                   side,
                                   m_pending_state->ciphersuite(),
                                   m_pending_state->session_keys())

