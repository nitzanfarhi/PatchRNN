commit f7027c6387d0c3acf569845165ec7947e2083c82
Author: Rusty Russell <rusty@rustcorp.com.au>
Date:   Fri Jun 12 22:27:00 2009 -0600

    lguest: get more serious about wmb() in example Launcher code
    
    Since the Launcher process runs the Guest, it doesn't have to be very
    serious about its barriers: the Guest isn't running while we are (Guest
    is UP).
    
    Before we change to use threads to service devices, we need to fix this.
    
    Signed-off-by: Rusty Russell <rusty@rustcorp.com.au>

diff --git a/Documentation/lguest/lguest.c b/Documentation/lguest/lguest.c
index 1a2b906a3ae6..1e31d1ec12a3 100644
--- a/Documentation/lguest/lguest.c
+++ b/Documentation/lguest/lguest.c
@@ -182,9 +182,10 @@ struct virtqueue
 /* Remember the arguments to the program so we can "reboot" */
 static char **main_args;
 
-/* Since guest is UP and we don't run at the same time, we don't need barriers.
- * But I include them in the code in case others copy it. */
-#define wmb()
+/* We have to be careful with barriers: our devices are all run in separate
+ * threads and so we need to make sure that changes visible to the Guest happen
+ * in precise order. */
+#define wmb() __asm__ __volatile__("" : : : "memory")
 
 /* Convert an iovec element to the given type.
  *

