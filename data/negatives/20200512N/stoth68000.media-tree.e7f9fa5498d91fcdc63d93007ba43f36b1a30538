commit e7f9fa5498d91fcdc63d93007ba43f36b1a30538
Author: Joerg Roedel <jroedel@suse.de>
Date:   Tue Aug 5 12:55:45 2014 +0200

    iommu/vt-d: Defer domain removal if device is assigned to a driver
    
    When the BUS_NOTIFY_DEL_DEVICE event is received the device
    might still be attached to a driver. In this case the domain
    can't be released as the mappings might still be in use.
    
    Defer the domain removal in this case until we receivce the
    BUS_NOTIFY_UNBOUND_DRIVER event.
    
    Cc: Jiang Liu <jiang.liu@linux.intel.com>
    Cc: David Woodhouse <dwmw2@infradead.org>
    Cc: stable@vger.kernel.org   # v3.15, v3.16
    Signed-off-by: Joerg Roedel <jroedel@suse.de>

diff --git a/drivers/iommu/intel-iommu.c b/drivers/iommu/intel-iommu.c
index d1f5caad04f9..5619f264862d 100644
--- a/drivers/iommu/intel-iommu.c
+++ b/drivers/iommu/intel-iommu.c
@@ -3869,6 +3869,14 @@ static int device_notifier(struct notifier_block *nb,
 	    action != BUS_NOTIFY_DEL_DEVICE)
 		return 0;
 
+	/*
+	 * If the device is still attached to a device driver we can't
+	 * tear down the domain yet as DMA mappings may still be in use.
+	 * Wait for the BUS_NOTIFY_UNBOUND_DRIVER event to do that.
+	 */
+	if (action == BUS_NOTIFY_DEL_DEVICE && dev->driver != NULL)
+		return 0;
+
 	domain = find_domain(dev);
 	if (!domain)
 		return 0;

