commit 6dd996c7c81575a1e4969987ab175a6df7beab3d
Author: Anton Khirnov <anton@khirnov.net>
Date:   Thu Apr 14 20:53:59 2016 +0200

    h264: move building the reference list out of h264_slice_header_parse()
    
    This does not do any bitstream parsing and will allow moving out other
    code in later commits.

diff --git a/libavcodec/h264_slice.c b/libavcodec/h264_slice.c
index 2e9587997d..0c38121827 100644
--- a/libavcodec/h264_slice.c
+++ b/libavcodec/h264_slice.c
@@ -1347,9 +1347,6 @@ static int h264_slice_header_parse(H264Context *h, H264SliceContext *sl)
            sl->ref_count[1] = sl->ref_count[0] = 0;
            return ret;
        }
-       ret = ff_h264_build_ref_list(h, sl);
-       if (ret < 0)
-           return ret;
     }
 
     sl->pwt.use_weight = 0;
@@ -1449,6 +1446,10 @@ int ff_h264_decode_slice_header(H264Context *h, H264SliceContext *sl)
     if (ret < 0)
         return ret;
 
+    ret = ff_h264_build_ref_list(h, sl);
+    if (ret < 0)
+        return ret;
+
     if (h->ps.pps->weighted_bipred_idc == 2 &&
         sl->slice_type_nos == AV_PICTURE_TYPE_B) {
         implicit_weight_table(h, sl, -1);

