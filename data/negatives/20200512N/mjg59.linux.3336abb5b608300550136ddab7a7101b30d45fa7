commit 3336abb5b608300550136ddab7a7101b30d45fa7
Author: Felipe Balbi <balbi@ti.com>
Date:   Wed Jun 6 09:19:35 2012 +0300

    usb: dwc3: gadget: ignore endpoint IRQs when endpoint is disabled
    
    By the time we're disabling the endpoint, HW
    could already have posted more events to our
    event buffer. In that case, we will receive
    endpoint events for a disabled endpoint.
    
    In order to protect ourselves from that situation,
    we simply ignore endpoint interrupts whenever
    the endpoint is disabled.
    
    Tested-by: Pratyush Anand <pratyush.anand@st.com>
    Signed-off-by: Felipe Balbi <balbi@ti.com>

diff --git a/drivers/usb/dwc3/gadget.c b/drivers/usb/dwc3/gadget.c
index 52d0f67e33d5..8e00756ee522 100644
--- a/drivers/usb/dwc3/gadget.c
+++ b/drivers/usb/dwc3/gadget.c
@@ -1768,6 +1768,9 @@ static void dwc3_endpoint_interrupt(struct dwc3 *dwc,
 
 	dep = dwc->eps[epnum];
 
+	if (!(dep->flags & DWC3_EP_ENABLED))
+		return;
+
 	dev_vdbg(dwc->dev, "%s: %s\n", dep->name,
 			dwc3_ep_event_string(event->endpoint_event));
 

