commit 78749809222be5083e21bfe697b44ab797e5c0a8
Author: Hollis Blanchard <hollisb@us.ibm.com>
Date:   Fri Nov 7 13:32:12 2008 -0600

    KVM: ensure that memslot userspace addresses are page-aligned
    
    Bad page translation and silent guest failure ensue if the userspace address is
    not page-aligned.  I hit this problem using large (host) pages with qemu,
    because qemu currently has a hardcoded 4096-byte alignment for guest memory
    allocations.
    
    Signed-off-by: Hollis Blanchard <hollisb@us.ibm.com>
    Signed-off-by: Avi Kivity <avi@redhat.com>

diff --git a/virt/kvm/kvm_main.c b/virt/kvm/kvm_main.c
index a65baa9039d5..0a0a9595ba3b 100644
--- a/virt/kvm/kvm_main.c
+++ b/virt/kvm/kvm_main.c
@@ -715,6 +715,8 @@ int __kvm_set_memory_region(struct kvm *kvm,
 		goto out;
 	if (mem->guest_phys_addr & (PAGE_SIZE - 1))
 		goto out;
+	if (mem->userspace_addr & (PAGE_SIZE - 1))
+		goto out;
 	if (mem->slot >= KVM_MEMORY_SLOTS + KVM_PRIVATE_MEM_SLOTS)
 		goto out;
 	if (mem->guest_phys_addr + mem->memory_size < mem->guest_phys_addr)

