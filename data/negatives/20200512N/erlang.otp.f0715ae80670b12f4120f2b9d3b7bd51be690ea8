commit f0715ae80670b12f4120f2b9d3b7bd51be690ea8
Author: Sverker Eriksson <sverker@erlang.org>
Date:   Thu Jul 6 15:07:34 2017 +0200

    erts: Generate crash_dump slogan string as UTF8
    
    the same as atoms.

diff --git a/erts/emulator/beam/bif.c b/erts/emulator/beam/bif.c
index 8380efaf13..8bf7e3926e 100644
--- a/erts/emulator/beam/bif.c
+++ b/erts/emulator/beam/bif.c
@@ -3971,9 +3971,6 @@ BIF_RETTYPE display_nl_0(BIF_ALIST_0)
 /**********************************************************************/
 
 
-#define HALT_MSG_SIZE	200
-static char halt_msg[HALT_MSG_SIZE+1];
-
 /* stop the system with exit code and flags */
 BIF_RETTYPE halt_2(BIF_ALIST_2)
 {
@@ -4024,15 +4021,16 @@ BIF_RETTYPE halt_2(BIF_ALIST_2)
 	erts_exit(ERTS_ABORT_EXIT, "");
     }
     else if (is_string(BIF_ARG_1) || BIF_ARG_1 == NIL) {
-	Sint i;
+#       define HALT_MSG_SIZE 200
+        static byte halt_msg[4*HALT_MSG_SIZE+1];
+        Sint written;
 
-        if ((i = intlist_to_buf(BIF_ARG_1, halt_msg, HALT_MSG_SIZE)) == -1) {
+        if (erts_unicode_list_to_buf(BIF_ARG_1, halt_msg, HALT_MSG_SIZE,
+                                     &written) == -1 ) {
             goto error;
         }
-        if (i == -2) /* truncated string */
-            i = HALT_MSG_SIZE;
-        ASSERT(i >= 0 && i <= HALT_MSG_SIZE);
-	halt_msg[i] = '\0';
+        ASSERT(written >= 0 && written < sizeof(halt_msg));
+	halt_msg[written] = '\0';
 	VERBOSE(DEBUG_SYSTEM,
 		("System halted by BIF halt(%T, %T)\n", BIF_ARG_1, BIF_ARG_2));
 	erts_smp_proc_unlock(BIF_P, ERTS_PROC_LOCK_MAIN);

