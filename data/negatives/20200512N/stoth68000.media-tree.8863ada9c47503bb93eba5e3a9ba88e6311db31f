commit 8863ada9c47503bb93eba5e3a9ba88e6311db31f
Author: Jason Wessel <jason.wessel@windriver.com>
Date:   Wed Dec 1 13:01:01 2010 -0600

    kgdboc,input: Fix regression with keyboard release key and early debugging
    
    The commit 111c182340cd22e238ab1cc6564df336c6ebd7cb (kgdboc: reset
    input devices (keyboards) when exiting debugger) introduced a
    regression in early debugging such that you get a kernel oops on
    continue (with the go command) if you boot a kernel with:
    
        earlyprintk=vga ekgdboc=kbd kgdbwait
    
    The restore kgdboc_restore_input() routine schedules work for the
    purpose of sending key release events for any keys that were in the
    depressed state prior to entering the kernel debugger.  A simple fix
    to the crash is to not invoke the schedule_work() if the kernel
    system_state is anything other than SYSTEM_RUNNING.
    
    Signed-off-by: Jason Wessel <jason.wessel@windriver.com>
    Acked-by: Dmitry Torokhov <dmitry.torokhov@gmail.com>
    Reviewed-by: Sergei Shtylyov <sshtylyov@mvista.com>

diff --git a/drivers/serial/kgdboc.c b/drivers/serial/kgdboc.c
index 3374618300af..25a8bc565f40 100644
--- a/drivers/serial/kgdboc.c
+++ b/drivers/serial/kgdboc.c
@@ -90,7 +90,8 @@ static DECLARE_WORK(kgdboc_restore_input_work, kgdboc_restore_input_helper);
 
 static void kgdboc_restore_input(void)
 {
-	schedule_work(&kgdboc_restore_input_work);
+	if (likely(system_state == SYSTEM_RUNNING))
+		schedule_work(&kgdboc_restore_input_work);
 }
 
 static int kgdboc_register_kbd(char **cptr)

