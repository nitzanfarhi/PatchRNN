commit a01523cdcd2439b553086127be3d30ac9c3cb651
Author: Michal Simek <monstr@monstr.eu>
Date:   Thu Oct 15 11:32:25 2009 +0200

    microblaze: Ptrace notifying from signal code
    
    After the signal frame is set up on the userspace stack, ptrace() should
    be given an opportunity to single-step into the signal handler
    
    FRV, Blackfin, mn10300 and UM. Worth to look at that patches.
    
    Signed-off-by: Michal Simek <monstr@monstr.eu>

diff --git a/arch/microblaze/kernel/signal.c b/arch/microblaze/kernel/signal.c
index 1c80e4fc40ce..0c96ac34c316 100644
--- a/arch/microblaze/kernel/signal.c
+++ b/arch/microblaze/kernel/signal.c
@@ -233,6 +233,10 @@ static void setup_rt_frame(int sig, struct k_sigaction *ka, siginfo_t *info,
 
 	set_fs(USER_DS);
 
+	/* the tracer may want to single-step inside the handler */
+	if (test_thread_flag(TIF_SINGLESTEP))
+		ptrace_notify(SIGTRAP);
+
 #ifdef DEBUG_SIG
 	printk(KERN_INFO "SIG deliver (%s:%d): sp=%p pc=%08lx\n",
 		current->comm, current->pid, frame, regs->pc);

