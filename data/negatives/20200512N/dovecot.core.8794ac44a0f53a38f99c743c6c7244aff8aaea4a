commit 8794ac44a0f53a38f99c743c6c7244aff8aaea4a
Author: Stephan Bosch <stephan.bosch@dovecot.fi>
Date:   Tue Dec 26 00:38:58 2017 +0100

    lib-smtp: server: Fix assertion failure occurring for a second failed BDAT/BURL command.
    
    Assertion was:
    
    Panic: file smtp-server-cmd-data.c: line 420 (smtp_server_connection_data_chunk_init): assertion failed: (data_cmd->chunk_first)

diff --git a/src/lib-smtp/smtp-server-cmd-data.c b/src/lib-smtp/smtp-server-cmd-data.c
index d728e445b..ab3b9d26a 100644
--- a/src/lib-smtp/smtp-server-cmd-data.c
+++ b/src/lib-smtp/smtp-server-cmd-data.c
@@ -416,7 +416,7 @@ void smtp_server_connection_data_chunk_init(struct smtp_server_cmd_ctx *cmd)
 	command->hook_replied = cmd_data_chunk_replied;
 	command->hook_destroy = cmd_data_destroy;
 
-	if (conn->state.data_chain == NULL) {
+	if (!conn->state.data_failed && conn->state.data_chain == NULL) {
 		i_assert(data_cmd->chunk_first);
 		i_assert(conn->state.data_chain_input == NULL);
 		conn->state.data_chain_input =

