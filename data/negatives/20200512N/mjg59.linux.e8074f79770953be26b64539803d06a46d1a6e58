commit e8074f79770953be26b64539803d06a46d1a6e58
Author: Stephen M. Cameron <scameron@beardog.cce.hp.com>
Date:   Thu Sep 17 13:47:24 2009 -0500

    cciss: Handle failure of blk_init_queue gracefully in cciss_add_disk.
    
    Handle failure of blk_init_queue gracefully in cciss_add_disk.
    
    Signed-off-by: Stephen M. Cameron <scameron@beardog.cce.hp.com>
    Signed-off-by: Jens Axboe <jens.axboe@oracle.com>

diff --git a/drivers/block/cciss.c b/drivers/block/cciss.c
index 2810dd9805a9..b1211d530dae 100644
--- a/drivers/block/cciss.c
+++ b/drivers/block/cciss.c
@@ -1690,6 +1690,8 @@ static int cciss_add_disk(ctlr_info_t *h, struct gendisk *disk,
 				int drv_index)
 {
 	disk->queue = blk_init_queue(do_cciss_request, &h->lock);
+	if (!disk->queue)
+		goto init_queue_failure;
 	sprintf(disk->disk_name, "cciss/c%dd%d", h->ctlr, drv_index);
 	disk->major = h->major;
 	disk->first_minor = drv_index << NWD_SHIFT;
@@ -1730,6 +1732,7 @@ static int cciss_add_disk(ctlr_info_t *h, struct gendisk *disk,
 cleanup_queue:
 	blk_cleanup_queue(disk->queue);
 	disk->queue = NULL;
+init_queue_failure:
 	return -1;
 }
 

