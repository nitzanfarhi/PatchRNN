commit fa0a9143bb21f1d0b15681560b2f5534bb6c2e00
Author: Török Edvin <edwin@clamav.net>
Date:   Thu May 13 19:51:27 2010 +0300

    Fix types for store/copy instructions.

diff --git a/libclamav/bytecode.c b/libclamav/bytecode.c
index 59d895e55..25a2eae37 100644
--- a/libclamav/bytecode.c
+++ b/libclamav/bytecode.c
@@ -1279,8 +1279,11 @@ static int parseBB(struct cli_bc *bc, unsigned func, unsigned bb, unsigned char
 			break;
 		}
 	}
-	if (inst.opcode == OP_BC_STORE)
-	    inst.type = get_optype(bcfunc, inst.u.binop[0]);
+	if (inst.opcode == OP_BC_STORE) {
+	    int16_t t = get_optype(bcfunc, inst.u.binop[0]);
+	    if (t)
+		inst.type = t;
+	}
 	if (inst.opcode == OP_BC_COPY)
 	    inst.type = get_optype(bcfunc, inst.u.binop[1]);
 	if (!ok) {
diff --git a/libclamav/c++/bytecode2llvm.cpp b/libclamav/c++/bytecode2llvm.cpp
index c5d3048ad..22b541333 100644
--- a/libclamav/c++/bytecode2llvm.cpp
+++ b/libclamav/c++/bytecode2llvm.cpp
@@ -1179,6 +1179,8 @@ public:
 			    Value *Dest = Values[inst->u.binop[1]];
 			    const PointerType *PTy = cast<PointerType>(Dest->getType());
 			    Op0 = convertOperand(func, PTy->getElementType(), inst->u.binop[0]);
+			    PTy = PointerType::getUnqual(Op0->getType());
+			    Dest = Builder.CreateBitCast(Dest, PTy);
 			    Builder.CreateStore(Op0, Dest);
 			    break;
 			}

