commit b119dee44d8f6ba2658dc02223862eef8b353bef
Author: Morris Jette <jette@schedmd.com>
Date:   Fri Apr 4 16:23:29 2014 -0700

    Move state save after scheduling new batch job
    
    This is related to defering batch job scheduling if there
    are a bunch of requests pending

diff --git a/src/slurmctld/proc_req.c b/src/slurmctld/proc_req.c
index 7aa829a46b..c598437aea 100644
--- a/src/slurmctld/proc_req.c
+++ b/src/slurmctld/proc_req.c
@@ -2948,8 +2948,6 @@ static void _slurm_rpc_submit_batch_job(slurm_msg_t * msg)
 			sched_cnt += schedule_cnt;
 			slurm_mutex_unlock(&sched_cnt_mutex);
 		}
-		schedule_job_save();	/* has own locks */
-		schedule_node_save();	/* has own locks */
 	}
 
 fini:	/* We need to use schedule() to initiate a batch job in order to run
@@ -2966,6 +2964,8 @@ fini:	/* We need to use schedule() to initiate a batch job in order to run
 	slurm_mutex_unlock(&sched_cnt_mutex);
 	if (sched_now_cnt)
 		(void) schedule(sched_now_cnt); /* has own locks */
+	schedule_job_save();	/* has own locks */
+	schedule_node_save();	/* has own locks */
 }
 
 /* _slurm_rpc_update_job - process RPC to update the configuration of a

