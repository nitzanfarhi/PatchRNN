commit aecb0565e3e331d4dd23b4d35180519532015f22
Author: Saravanan Dhanabal <ext-saravanan.dhanabal@nokia.com>
Date:   Fri Apr 9 11:07:28 2010 +0300

    wl1271: Fix mac80211 RTS threshold requests during WL1271_STATE_OFF
    
    mac80211 sends RTS threshold configuration request even if the wl1271 interface
    state is WL1271_STATE_OFF. This leads to failures during pm tests.
    
    This patch leaves the configuration function, if the interface is
    going down.
    
    Signed-off-by: Saravanan Dhanabal <ext-saravanan.dhanabal@nokia.com>
    Reviewed-by: Juuso Oikarinen <juuso.oikarinen@nokia.com>
    Signed-off-by: Luciano Coelho <luciano.coelho@nokia.com>
    Signed-off-by: John W. Linville <linville@tuxdriver.com>

diff --git a/drivers/net/wireless/wl12xx/wl1271_main.c b/drivers/net/wireless/wl12xx/wl1271_main.c
index 2eb7b99ff276..4adc5162e7e5 100644
--- a/drivers/net/wireless/wl12xx/wl1271_main.c
+++ b/drivers/net/wireless/wl12xx/wl1271_main.c
@@ -1582,10 +1582,13 @@ static int wl1271_op_hw_scan(struct ieee80211_hw *hw,
 static int wl1271_op_set_rts_threshold(struct ieee80211_hw *hw, u32 value)
 {
 	struct wl1271 *wl = hw->priv;
-	int ret;
+	int ret = 0;
 
 	mutex_lock(&wl->mutex);
 
+	if (unlikely(wl->state == WL1271_STATE_OFF))
+		goto out;
+
 	ret = wl1271_ps_elp_wakeup(wl, false);
 	if (ret < 0)
 		goto out;

