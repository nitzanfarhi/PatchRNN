commit d5842ab730d368ae2e8925dc00aec0ca132b72ab
Author: Roland Stigge <stigge@antcom.de>
Date:   Wed Jun 27 17:51:15 2012 +0200

    mtd: lpc32xx_slc: Make probe() return -EPROBE_DEFER if necessary
    
    Via of_get_named_gpio(), wp_gpio can become -EPROBE_DEFER which now makes
    probe() return -EPROBE_DEFER as well to wait until the gpio controller is
    probed before trying to probe lpc32xx_slc again.
    
    Signed-off-by: Roland Stigge <stigge@antcom.de>
    Acked-by: Alexandre Pereira da Silva <aletes.xgr@gmail.com>
    Signed-off-by: Artem Bityutskiy <artem.bityutskiy@linux.intel.com>
    Signed-off-by: David Woodhouse <David.Woodhouse@intel.com>

diff --git a/drivers/mtd/nand/lpc32xx_slc.c b/drivers/mtd/nand/lpc32xx_slc.c
index 116665015269..1719387dd008 100644
--- a/drivers/mtd/nand/lpc32xx_slc.c
+++ b/drivers/mtd/nand/lpc32xx_slc.c
@@ -821,6 +821,8 @@ static int __devinit lpc32xx_nand_probe(struct platform_device *pdev)
 		dev_err(&pdev->dev, "Missing platform data\n");
 		return -ENOENT;
 	}
+	if (host->ncfg->wp_gpio == -EPROBE_DEFER)
+		return -EPROBE_DEFER;
 	if (gpio_is_valid(host->ncfg->wp_gpio) &&
 			gpio_request(host->ncfg->wp_gpio, "NAND WP")) {
 		dev_err(&pdev->dev, "GPIO not available\n");

