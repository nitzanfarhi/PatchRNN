commit 5cb770bf4b777dae832151f4bc4d35e7a99f9880
Author: Roland Dreier <roland@purestorage.com>
Date:   Mon Oct 14 15:49:23 2013 -0700

    target: Return an error for WRITE SAME with ANCHOR==1
    
    Per SBC-3, since we report ANC_SUP==0 in VPD page B2h, we need to return
    an error (ILLEGAL REQUEST/INVALID FIELD IN CDB) for all WRITE SAME
    requests with ANCHOR==1.
    
    Signed-off-by: Roland Dreier <roland@purestorage.com>
    Signed-off-by: Nicholas Bellinger <nab@linux-iscsi.org>

diff --git a/drivers/target/target_core_sbc.c b/drivers/target/target_core_sbc.c
index 4714c6f8da4b..d9b92b2c524d 100644
--- a/drivers/target/target_core_sbc.c
+++ b/drivers/target/target_core_sbc.c
@@ -263,6 +263,11 @@ sbc_setup_write_same(struct se_cmd *cmd, unsigned char *flags, struct sbc_ops *o
 			sectors, cmd->se_dev->dev_attrib.max_write_same_len);
 		return TCM_INVALID_CDB_FIELD;
 	}
+	/* We always have ANC_SUP == 0 so setting ANCHOR is always an error */
+	if (flags[0] & 0x10) {
+		pr_warn("WRITE SAME with ANCHOR not supported\n");
+		return TCM_INVALID_CDB_FIELD;
+	}
 	/*
 	 * Special case for WRITE_SAME w/ UNMAP=1 that ends up getting
 	 * translated into block discard requests within backend code.

