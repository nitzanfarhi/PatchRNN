commit 0106246594a05f02a6be6ee4695c7584c758fa7f
Author: Arnd Bergmann <arnd@arndb.de>
Date:   Wed Jan 4 20:31:25 2006 +0100

    [PATCH] spufs fix spu_acquire_runnable error path
    
    When spu_activate fails in spu_acquire_runnable, the
    state must still be SPU_STATE_SAVED, we were
    incorrectly setting it to SPU_STATE_RUNNABLE.
    
    Signed-off-by: Arnd Bergmann <arndb@de.ibm.com>
    Signed-off-by: Paul Mackerras <paulus@samba.org>

diff --git a/arch/powerpc/platforms/cell/spufs/context.c b/arch/powerpc/platforms/cell/spufs/context.c
index c5cd55ac848d..336f238102fd 100644
--- a/arch/powerpc/platforms/cell/spufs/context.c
+++ b/arch/powerpc/platforms/cell/spufs/context.c
@@ -132,10 +132,10 @@ int spu_acquire_runnable(struct spu_context *ctx)
 
 	if (ctx->state == SPU_STATE_SAVED) {
 		ret = spu_activate(ctx, 0);
+		if (ret)
+			goto out;
 		ctx->state = SPU_STATE_RUNNABLE;
 	}
-	if (ret)
-		goto out;
 
 	downgrade_write(&ctx->state_sema);
 	/* On success, we return holding the lock */

