commit 739f4f284b4a137c9291a00a23d197b1cd42099d
Author: Timo Sirainen <tss@iki.fi>
Date:   Fri Jun 13 01:11:24 2014 +0300

    fts: Improved doveadm fts dump for corrupted expunge log
    Although we may still be trying to allocate up to 2 GB of memory, but at
    least no more than that now.
    Found by Coverity

diff --git a/src/plugins/fts/doveadm-dump-fts-expunge-log.c b/src/plugins/fts/doveadm-dump-fts-expunge-log.c
index 8d4a2ae92..1b7876923 100644
--- a/src/plugins/fts/doveadm-dump-fts-expunge-log.c
+++ b/src/plugins/fts/doveadm-dump-fts-expunge-log.c
@@ -36,6 +36,11 @@ static int dump_record(int fd, buffer_t *buf)
 	if (ret != sizeof(rec))
 		i_fatal("rec read() %d != %d", (int)ret, (int)sizeof(rec));
 
+	if (rec.record_size < sizeof(rec) + sizeof(uint32_t) ||
+	    rec.record_size > INT_MAX) {
+		i_fatal("Invalid record_size=%u at offset %"PRIuUOFF_T,
+			rec.record_size, offset);
+	}
 	data_size = rec.record_size - sizeof(rec);
 	buffer_set_used_size(buf, 0);
 	data = buffer_append_space_unsafe(buf, data_size);

