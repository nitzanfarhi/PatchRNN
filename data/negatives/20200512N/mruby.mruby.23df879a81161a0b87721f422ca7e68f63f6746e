commit 23df879a81161a0b87721f422ca7e68f63f6746e
Author: h2so5 <mail@h2so5.net>
Date:   Sat Aug 24 06:49:58 2013 +0900

    Fix a problem of 'z' option and shared string

diff --git a/src/class.c b/src/class.c
index b5c561d0..df034737 100644
--- a/src/class.c
+++ b/src/class.c
@@ -489,14 +489,19 @@ mrb_get_args(mrb_state *mrb, const char *format, ...)
         mrb_value ss;
         struct RString *s;
         char **ps;
+        mrb_int len;
 
         ps = va_arg(ap, char**);
         if (i < argc) {
           ss = to_str(mrb, *sp++);
           s = mrb_str_ptr(ss);
-          if ((mrb_int)strlen(s->ptr) < s->len) {
+          len = (mrb_int)strlen(s->ptr);
+          if (len < s->len) {
             mrb_raise(mrb, E_ARGUMENT_ERROR, "String contains NUL");
           }
+          else if (len > s->len) {
+            mrb_str_modify(mrb, s);
+          }
           *ps = s->ptr;
           i++;
         }
diff --git a/src/string.c b/src/string.c
index 2004c9fe..88dcfc63 100644
--- a/src/string.c
+++ b/src/string.c
@@ -62,6 +62,7 @@ mrb_str_modify(mrb_state *mrb, struct RString *s)
     if (shared->refcnt == 1 && s->ptr == shared->ptr) {
       s->ptr = shared->ptr;
       s->aux.capa = shared->len;
+      s->ptr[s->len] = '\0';
       mrb_free(mrb, shared);
     }
     else {

