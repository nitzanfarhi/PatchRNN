commit 888c6216ca9239be260fd832f900b9fcd784f806
Author: Lennart Poettering <lennart@poettering.net>
Date:   Tue Aug 17 18:00:48 2010 +0200

    nss: don't disable nscd anymore, since it doesn't make sense to socket-activate nscd anyway

diff --git a/src/main.c b/src/main.c
index 51253c66c..43b469fb0 100644
--- a/src/main.c
+++ b/src/main.c
@@ -975,20 +975,14 @@ int main(int argc, char *argv[]) {
         log_full(arg_running_as == MANAGER_SYSTEM ? LOG_INFO : LOG_DEBUG,
                  PACKAGE_STRING " running in %s mode. (" SYSTEMD_FEATURES ")", manager_running_as_to_string(arg_running_as));
 
-        if (arg_running_as == MANAGER_SYSTEM) {
+        if (arg_running_as == MANAGER_SYSTEM && !serialization) {
+                if (arg_show_status)
+                        status_welcome();
 
-                /* Disable nscd, to avoid deadlocks when systemd uses
-                 * NSS and the nscd socket is maintained by us. */
-                nss_disable_nscd();
-
-                if (!serialization) {
-                        if (arg_show_status)
-                                status_welcome();
-                        modprobe_setup(arg_nomodules);
-                        kmod_setup();
-                        hostname_setup();
-                        loopback_setup();
-                }
+                modprobe_setup(arg_nomodules);
+                kmod_setup();
+                hostname_setup();
+                loopback_setup();
         }
 
         if ((r = manager_new(arg_running_as, &m)) < 0) {
diff --git a/src/util.c b/src/util.c
index 3bcce2f01..0b0063ee0 100644
--- a/src/util.c
+++ b/src/util.c
@@ -2981,23 +2981,6 @@ char *ellipsize(const char *s, unsigned length, unsigned percent) {
         return r;
 }
 
-void nss_disable_nscd(void) {
-
-        void (*func)(void);
-
-        /* This is an internal glibc function call. We are not
-         * supposed to call this, because we are not nscd. However
-         * sometimes we feel really dangerous and do it
-         * nonetheless. Muahahah! But at least we protect this with a
-         * dlsym() just in case glibc takes this away from us. */
-
-        if ((func = dlsym(RTLD_DEFAULT, "__nss_disable_nscd"))) {
-                log_debug("Disabling nscd.");
-                func();
-        } else
-                log_debug("Cannot disable nscd.");
-}
-
 int touch(const char *path) {
         int fd;
 
diff --git a/src/util.h b/src/util.h
index 18dfa97b8..97e1b1ba4 100644
--- a/src/util.h
+++ b/src/util.h
@@ -336,8 +336,6 @@ int running_in_chroot(void);
 
 char *ellipsize(const char *s, unsigned length, unsigned percent);
 
-void nss_disable_nscd(void);
-
 int touch(const char *path);
 
 const char *ioprio_class_to_string(int i);

