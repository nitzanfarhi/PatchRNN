commit ec62b1ab0f4ccbc48aa8b9852cc25b38a1f12d1e
Author: Baoquan He <bhe@redhat.com>
Date:   Thu Aug 24 21:13:57 2017 +0800

    iommu/amd: Check if domain is NULL in get_domain() and return -EBUSY
    
    In get_domain(), 'domain' could be NULL before it's passed to dma_ops_domain()
    to dereference. And the current code calling get_domain() can't deal with the
    returned 'domain' well if its value is NULL.
    
    So before dma_ops_domain() calling, check if 'domain' is NULL, If yes just return
    ERR_PTR(-EBUSY) directly.
    
    Reported-by: Dan Carpenter <dan.carpenter@oracle.com>
    Fixes: df3f7a6e8e85 ('iommu/amd: Use is_attach_deferred call-back')
    Signed-off-by: Baoquan He <bhe@redhat.com>
    Signed-off-by: Joerg Roedel <jroedel@suse.de>

diff --git a/drivers/iommu/amd_iommu.c b/drivers/iommu/amd_iommu.c
index 9e8ea1907796..b531307a9360 100644
--- a/drivers/iommu/amd_iommu.c
+++ b/drivers/iommu/amd_iommu.c
@@ -2472,6 +2472,9 @@ static struct protection_domain *get_domain(struct device *dev)
 		domain = to_pdomain(io_domain);
 		attach_device(dev, domain);
 	}
+	if (domain == NULL)
+		return ERR_PTR(-EBUSY);
+
 	if (!dma_ops_domain(domain))
 		return ERR_PTR(-EBUSY);
 

