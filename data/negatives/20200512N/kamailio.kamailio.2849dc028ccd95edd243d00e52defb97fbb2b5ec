commit 2849dc028ccd95edd243d00e52defb97fbb2b5ec
Author: Jan Janak <jan@iptel.org>
Date:   Thu Feb 16 14:22:53 2006 +0000

    - fixed typo in modparam fixup
    - added acc_db_log (can be used to generate acc entry from script
      without having transaction context)
    - added acc_db_missed (can be used to generate acc entry from scrit
      without having transaction context, useful when lookup_contacts
      yields no contacts (temporarily unavailable)

diff --git a/modules_s/acc_db/acc_db.c b/modules_s/acc_db/acc_db.c
index 8e169e32f..1b1952607 100644
--- a/modules_s/acc_db/acc_db.c
+++ b/modules_s/acc_db/acc_db.c
@@ -174,9 +174,11 @@ static db_val_t vals[sizeof(ALL_LOG_FMT) - 1];
 static int db_n;
 
 static int acc_db_request(struct sip_msg *rq, char *comment, char *foo);
+static int acc_db_missed(struct sip_msg *rq, char *comment, char *foo);
 
 static cmd_export_t cmds[] = {
-	{"acc_db_request", acc_db_request, 1, 0, REQUEST_ROUTE | FAILURE_ROUTE},
+	{"acc_db_log",    acc_db_request, 1, 0, REQUEST_ROUTE | FAILURE_ROUTE},
+	{"acc_db_missed", acc_db_missed, 1, 0, REQUEST_ROUTE | FAILURE_ROUTE},
 	{0, 0, 0, 0, 0}
 };
 
@@ -248,7 +250,7 @@ static int fix_log_flag( modparam_t type, void* val)
 /* fixes log_missed_flag param (resolves possible named flags) */
 static int fix_log_missed_flag( modparam_t type, void* val)
 {
-	return fix_flag(type, val, "acc_db", "log_missed_flag", &log_flag);
+	return fix_flag(type, val, "acc_db", "log_missed_flag", &log_missed_flag);
 }
 
 
@@ -795,6 +797,17 @@ static int acc_db_request(struct sip_msg *rq, char* comment, char* s2)
 }
 
 
+/* these wrappers parse all what may be needed; they don't care about
+ * the result -- accounting functions just display "unavailable" if there
+ * is nothing meaningful
+ */
+static int acc_db_missed(struct sip_msg *rq, char* comment, char* s2)
+{
+	preparse_req(rq);
+	return log_request(rq, rq->to, mc_table.s, 0, time(0));
+}
+
+
 static void ack_handler(struct cell* t, int type, struct tmcb_params* ps)
 {
 	if (is_acc_on(t->uas.request)) {

