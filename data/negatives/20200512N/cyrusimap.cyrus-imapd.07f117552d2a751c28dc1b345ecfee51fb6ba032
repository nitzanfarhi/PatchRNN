commit 07f117552d2a751c28dc1b345ecfee51fb6ba032
Author: Bron Gondwana <brong@opera.com>
Date:   Tue Apr 5 00:16:29 2011 +0200

    mailbox: rewrite cache

diff --git a/imap/mailbox.c b/imap/mailbox.c
index 598c02aed..c0de712bb 100644
--- a/imap/mailbox.c
+++ b/imap/mailbox.c
@@ -2081,6 +2081,12 @@ int mailbox_rewrite_index_record(struct mailbox *mailbox,
 	    mailbox->i.options |= OPT_MAILBOX_NEEDS_REPACK;
 	mailbox->i.options |= OPT_MAILBOX_NEEDS_UNLINK;
     }
+    else {
+	/* write the cache record before buffering the message, it
+	 * will set the cache_offset field. */
+	r = mailbox_append_cache(mailbox, record);
+	if (r) return r;
+    }
 
     /* make sure highestmodseq gets updated unless we're
      * being silent about it (i.e. marking an already EXPUNGED

