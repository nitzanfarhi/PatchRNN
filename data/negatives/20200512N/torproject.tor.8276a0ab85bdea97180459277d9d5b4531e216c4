commit 8276a0ab85bdea97180459277d9d5b4531e216c4
Author: George Kadianakis <desnacked@riseup.net>
Date:   Wed Oct 25 19:18:25 2017 +0300

    Update entry guard state whenever we download a consensus.
    
    Update guard state even if we don't have enough dirinfo since that
    actually affects the future download of dirinfos.
    
    Fixes #23862 on 0.3.0.1-alpha

diff --git a/src/or/main.c b/src/or/main.c
index 7b1f4975f..0d91803d4 100644
--- a/src/or/main.c
+++ b/src/or/main.c
@@ -968,6 +968,15 @@ directory_info_has_arrived(time_t now, int from_cache, int suppress_logs)
 {
   const or_options_t *options = get_options();
 
+  /* if we have enough dir info, then update our guard status with
+   * whatever we just learned. */
+  int invalidate_circs = guards_update_all();
+
+  if (invalidate_circs) {
+    circuit_mark_all_unused_circs();
+    circuit_mark_all_dirty_circs_as_unusable();
+  }
+
   if (!router_have_minimum_dir_info()) {
     int quiet = suppress_logs || from_cache ||
                 directory_too_idle_to_fetch_descriptors(options, now);
@@ -981,15 +990,6 @@ directory_info_has_arrived(time_t now, int from_cache, int suppress_logs)
       update_all_descriptor_downloads(now);
     }
 
-    /* if we have enough dir info, then update our guard status with
-     * whatever we just learned. */
-    int invalidate_circs = guards_update_all();
-
-    if (invalidate_circs) {
-      circuit_mark_all_unused_circs();
-      circuit_mark_all_dirty_circs_as_unusable();
-    }
-
     /* Don't even bother trying to get extrainfo until the rest of our
      * directory info is up-to-date */
     if (options->DownloadExtraInfo)

