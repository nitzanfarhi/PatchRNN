commit 5628240e7eac9dda0b6c7c92443428b12828fdb1
Author: Sage Weil <sage@newdream.net>
Date:   Wed Oct 7 11:54:20 2009 -0700

    crush: zero weight items get 0 length straws

diff --git a/src/crush/builder.c b/src/crush/builder.c
index 7ac398db44..a10f7a455e 100644
--- a/src/crush/builder.c
+++ b/src/crush/builder.c
@@ -333,6 +333,13 @@ crush_make_straw_bucket(int type,
 
 	i=0;
 	while (i < size) {
+		/* zero weight items get 0 length straws! */
+		if (weights[reverse[i]] == 0) {
+			bucket->straws[reverse[i]] = 0;
+			i++;
+			continue;
+		}
+
 		/* set this item's straw */
 		bucket->straws[reverse[i]] = straw * 0x10000;
 		/*printf("item %d at %d weight %d straw %d (%lf)\n",

