commit 78bd4d484f81a611ef6ff02f909e576cb9aac7f2
Author: Oleg Nesterov <oleg@tv-sign.ru>
Date:   Mon Aug 21 08:33:23 2006 +0200

    [PATCH] sys_ioprio_set: minor do_each_thread+break fix
    
    From include/linux/sched.h:
    
             * Careful: do_each_thread/while_each_thread is a double loop so
             *          'break' will not work as expected - use goto instead.
             */
    
    Signed-off-by: Oleg Nesterov <oleg@tv-sign.ru>
    Signed-off-by: Jens Axboe <axboe@suse.de>

diff --git a/fs/ioprio.c b/fs/ioprio.c
index 93aa5715f224..3db31038e9ab 100644
--- a/fs/ioprio.c
+++ b/fs/ioprio.c
@@ -111,9 +111,9 @@ asmlinkage long sys_ioprio_set(int which, int who, int ioprio)
 					continue;
 				ret = set_task_ioprio(p, ioprio);
 				if (ret)
-					break;
+					goto free_uid;
 			} while_each_thread(g, p);
-
+free_uid:
 			if (who)
 				free_uid(user);
 			break;

