commit cd7a473263fd6e272dc83d46e8710d4b5d192f2c
Author: Simone Mainardi <mainardi@ntop.org>
Date:   Thu Jan 12 22:01:13 2017 +0100

    Handles category shapers

diff --git a/src/Host.cpp b/src/Host.cpp
index 7364e622..71c18f04 100644
--- a/src/Host.cpp
+++ b/src/Host.cpp
@@ -1181,13 +1181,16 @@ u_int8_t Host::get_shaper_id(ndpi_protocol ndpiProtocol, bool isIngress) {
       HASH_FIND_INT(policy->mapping_proto_shaper_id, &protocol, sd);
     }
 
+    ret = isIngress ? policy->default_shapers.ingress : policy->default_shapers.egress;
+
     if(sd) {
-      /* A protocol shaper is defined */
-      ret = isIngress ? sd->ingress : sd->egress;
-    } else {
-      /* The default shaper is returned */
-      ret = isIngress ? policy->default_shaper_id.ingress : policy->default_shaper_id.egress;
+      /* A protocol shaper has priority over the category shaper */
+      if(sd->protocol_shapers.enabled)
+	ret = isIngress ? sd->protocol_shapers.ingress : sd->protocol_shapers.egress;
+      else if(sd->category_shapers.enabled)
+	ret = isIngress ? sd->category_shapers.ingress : sd->category_shapers.egress;
     }
+
   }
 
 #ifdef SHAPER_DEBUG
@@ -1205,6 +1208,7 @@ u_int8_t Host::get_shaper_id(ndpi_protocol ndpiProtocol, bool isIngress) {
 
   return(ret);
 }
+
 #endif
 
 /* *************************************** */

