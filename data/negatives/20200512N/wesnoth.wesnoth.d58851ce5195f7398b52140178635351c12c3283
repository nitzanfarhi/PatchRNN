commit d58851ce5195f7398b52140178635351c12c3283
Author: Ali El Gariani <alinkmaze@gmail.com>
Date:   Thu May 10 17:21:03 2007 +0000

    Apply mordante patch, better fix of AI bug #9103
    
    Now the AI take correct account of average defense of static unit
    but it don't look on what terrain exactly the unit is fixed
    It's not a problem for towers, since they have the same def% for each terrains

diff --git a/src/ai.cpp b/src/ai.cpp
index d43b541583..8938d3981e 100644
--- a/src/ai.cpp
+++ b/src/ai.cpp
@@ -1551,8 +1551,22 @@ int ai::average_resistance_against(const unit_type& a, const unit_type& b) const
 		weighting_sum += j->second;
 	}
 
-	if (weighting_sum != 0)
+	if (weighting_sum != 0) {
 		defense /= weighting_sum;
+	} else {
+		// This unit can't move on this map so just get the avarage weighted of all
+		// available terrains. This still is a kind of silly since the opponent 
+		// probably can't recruit this unit and it's a static unit.
+		for (std::map<t_translation::t_letter, size_t>::const_iterator jj = terrain.begin(), 
+				jj_end = terrain.end(); jj != jj_end; ++jj) {
+
+			defense += a.movement_type().defense_modifier(map_, jj->first) * jj->second;
+			weighting_sum += jj->second;
+		}
+
+		wassert(weighting_sum != 0);
+		defense /= weighting_sum;
+	}
 
 	LOG_AI << "average defense of '" << a.id() << "': " << defense << "\n";
 

