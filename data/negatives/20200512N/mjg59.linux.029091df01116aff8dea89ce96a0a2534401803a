commit 029091df01116aff8dea89ce96a0a2534401803a
Author: Zhang, Yanmin <yanmin_zhang@linux.intel.com>
Date:   Thu Apr 30 14:48:29 2009 +0800

    PCI: Fix pci-e port driver slot_reset bad default return value
    
    When an upstream port reports an AER error to root port, kernel
    starts error recovery procedures. The default return value of
    function pcie_portdrv_slot_reset is PCI_ERS_RESULT_NONE. If all
    port service drivers of the downstream port under the upstream
    port have no slot_reset method in pci_error_handlers, AER recovery
    would stop without resume. Below patch against 2.6.30-rc3 fixes it.
    
    Signed-off-by: Zhang Yanmin <yanmin.zhang@linux.intel.com>
    Signed-off-by: Jesse Barnes <jbarnes@virtuousgeek.org>

diff --git a/drivers/pci/pcie/aer/aerdrv.h b/drivers/pci/pcie/aer/aerdrv.h
index c7ad68b6c6d6..aa14482a4779 100644
--- a/drivers/pci/pcie/aer/aerdrv.h
+++ b/drivers/pci/pcie/aer/aerdrv.h
@@ -95,6 +95,9 @@ struct aer_broadcast_data {
 static inline pci_ers_result_t merge_result(enum pci_ers_result orig,
 		enum pci_ers_result new)
 {
+	if (new == PCI_ERS_RESULT_NONE)
+		return orig;
+
 	switch (orig) {
 	case PCI_ERS_RESULT_CAN_RECOVER:
 	case PCI_ERS_RESULT_RECOVERED:
diff --git a/drivers/pci/pcie/portdrv_pci.c b/drivers/pci/pcie/portdrv_pci.c
index b924e2463f85..091ce70051e0 100644
--- a/drivers/pci/pcie/portdrv_pci.c
+++ b/drivers/pci/pcie/portdrv_pci.c
@@ -200,7 +200,7 @@ static int slot_reset_iter(struct device *device, void *data)
 
 static pci_ers_result_t pcie_portdrv_slot_reset(struct pci_dev *dev)
 {
-	pci_ers_result_t status = PCI_ERS_RESULT_NONE;
+	pci_ers_result_t status = PCI_ERS_RESULT_RECOVERED;
 	int retval;
 
 	/* If fatal, restore cfg space for possible link reset at upstream */

