commit e7afe6e3c56684dd203036353a937ebee0d064f6
Author: Timo Sirainen <tss@iki.fi>
Date:   Thu Mar 15 14:18:55 2012 +0200

    imap: Use mailbox_exists() to find out if namespace prefix is selectable or not.
    mailbox_list_mailbox() should be treated as an internal function, since
    ACLs don't apply to it.

diff --git a/src/imap/cmd-list.c b/src/imap/cmd-list.c
index 6058a5b6c..e44634419 100644
--- a/src/imap/cmd-list.c
+++ b/src/imap/cmd-list.c
@@ -273,6 +273,8 @@ list_namespace_send_prefix(struct cmd_list_context *ctx, bool have_children)
 {
 	struct mail_namespace *const *listed;
 	const struct mailbox_settings *mailbox_set;
+	struct mailbox *box;
+	enum mailbox_existence existence;
 	unsigned int len;
 	enum mailbox_info_flags flags;
 	const char *name;
@@ -307,11 +309,18 @@ list_namespace_send_prefix(struct cmd_list_context *ctx, bool have_children)
 
 		ctx->inbox_found = TRUE;
 		flags = list_get_inbox_flags(ctx);
-	} else if (same_ns &&
-		   mailbox_list_mailbox(ctx->ns->list, "", &flags) > 0) {
-		/* mailbox with namespace prefix exists */
-	} else {
+	} else if (!same_ns) {
+		/* parent */
 		flags = MAILBOX_NONEXISTENT;
+	} else {
+		/* see if namespace prefix is selectable */
+		box = mailbox_alloc(ctx->ns->list, name, 0);
+		if (mailbox_exists(box, TRUE, &existence) == 0 &&
+		    existence == MAILBOX_EXISTENCE_SELECT)
+			flags = MAILBOX_SELECT;
+		else
+			flags = MAILBOX_NONEXISTENT;
+		mailbox_free(&box);
 	}
 
 	if ((flags & MAILBOX_CHILDREN) == 0) {

