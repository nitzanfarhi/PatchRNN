commit 3e6d3f93f717028fd06f36acd9bfdf1c3241a6ad
Author: Jimmy Yang <jimmy.yang@oracle.com>
Date:   Fri Jul 8 04:16:42 2011 -0700

    A couple of bug fix from Michael's testing
    1) Check for infimum record when use btr_pcur_get_low_match() to find
    record.
    2) Make sure cache->added is updated when we re-parse the documents during
    server startup from last crash

diff --git a/storage/innobase/fut/fut0fut.c b/storage/innobase/fut/fut0fut.c
index 40b944423f6..53c648d4504 100644
--- a/storage/innobase/fut/fut0fut.c
+++ b/storage/innobase/fut/fut0fut.c
@@ -1093,7 +1093,8 @@ fts_cache_add_doc(
 		}
 
 		if (fts_node == NULL
-		    || fts_node->ilist_size > FTS_ILIST_MAX_SIZE) {
+		    || fts_node->ilist_size > FTS_ILIST_MAX_SIZE
+		    || doc_id < fts_node->last_doc_id) {
 
 			fts_node = ib_vector_push(word->nodes, NULL);
 
@@ -2966,7 +2967,8 @@ fts_add_doc_by_id(
 		rec = btr_pcur_get_rec(&pcur);
 
 		/* Doc could be deleted */
-		if (rec_get_deleted_flag(
+		if (page_rec_is_infimum(rec)
+		    || rec_get_deleted_flag(
 			rec, dict_table_is_comp(table))) {
 			doc->found = FALSE;
 			goto func_exit;
@@ -6189,6 +6191,8 @@ fts_init_recover_doc(
 
 	fts_doc_free(&doc);
 
+	cache->added++;
+
 	return(TRUE);
 }
 

