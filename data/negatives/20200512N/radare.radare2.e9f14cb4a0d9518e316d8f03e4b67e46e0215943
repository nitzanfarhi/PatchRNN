commit e9f14cb4a0d9518e316d8f03e4b67e46e0215943
Author: pancake <pancake@nopcode.org>
Date:   Tue Jun 14 03:14:48 2016 +0200

    Fix 4b85cff3312965cc7d7a38943cfa06373cef41f9 util.calc regression

diff --git a/libr/util/calc.c b/libr/util/calc.c
index 9cd95dacd..abefa9886 100644
--- a/libr/util/calc.c
+++ b/libr/util/calc.c
@@ -277,8 +277,9 @@ static RNumCalcToken get_token(RNum *num, RNumCalc *nc) {
 		{
 			int i = 0;
 #define stringValueAppend(x) { \
-	if (i + 1 < sizeof (x)) nc->string_value[i++] = x; \
-	else nc->string_value[sizeof(nc->string_value)-1] = 0; \
+	const size_t max = sizeof (nc->string_value) - 1; \
+	if (i < max) nc->string_value[i++] = x; \
+	else nc->string_value[max] = 0; \
 }
 			stringValueAppend(ch);
 			if (ch == '[') {
@@ -299,17 +300,12 @@ static RNumCalcToken get_token(RNum *num, RNumCalc *nc) {
 					stringValueAppend(ch);
 				}
 			}
-			stringValueAppend(ch);
+			stringValueAppend(0);
 			if (ch!='\'') {
 				cin_putback (num, nc, ch);
 			}
 			return nc->curr_tok = RNCNAME;
 		}
-/*
- * Unreacheable code:
-		error (num, nc, "bad token");
-		return nc->curr_tok = RNCPRINT;
-*/
 	}
 }
 

