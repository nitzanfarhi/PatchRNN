commit 7b69454a12510dc84b71c292214c364e499609e7
Author: Peter Maydell <peter.maydell@linaro.org>
Date:   Mon Aug 6 13:34:43 2018 +0100

    target/arm: Add dummy needed functions to M profile vmstate subsections
    
    Currently the migration code incorrectly treats a subsection with
    no .needed function pointer as if it was the subsection list
    terminator -- it is ignored and so is everything after it.
    Work around this by giving various M profile vmstate structs
    a 'needed' function that always returns true.
    We reuse m_needed() for this, since it's always true here.
    
    Signed-off-by: Peter Maydell <peter.maydell@linaro.org>
    Reviewed-by: Dr. David Alan Gilbert <dgilbert@redhat.com>
    Reviewed-by: Richard Henderson <richard.henderson@linaro.org>
    Message-id: 20180806123445.1459-4-peter.maydell@linaro.org

diff --git a/target/arm/machine.c b/target/arm/machine.c
index 2e28d086bd..ff4ec22bf7 100644
--- a/target/arm/machine.c
+++ b/target/arm/machine.c
@@ -184,6 +184,7 @@ static const VMStateDescription vmstate_m_faultmask_primask = {
     .name = "cpu/m/faultmask-primask",
     .version_id = 1,
     .minimum_version_id = 1,
+    .needed = m_needed,
     .fields = (VMStateField[]) {
         VMSTATE_UINT32(env.v7m.faultmask[M_REG_NS], ARMCPU),
         VMSTATE_UINT32(env.v7m.primask[M_REG_NS], ARMCPU),
@@ -230,6 +231,7 @@ static const VMStateDescription vmstate_m_scr = {
     .name = "cpu/m/scr",
     .version_id = 1,
     .minimum_version_id = 1,
+    .needed = m_needed,
     .fields = (VMStateField[]) {
         VMSTATE_UINT32(env.v7m.scr[M_REG_NS], ARMCPU),
         VMSTATE_END_OF_LIST()
@@ -240,6 +242,7 @@ static const VMStateDescription vmstate_m_other_sp = {
     .name = "cpu/m/other-sp",
     .version_id = 1,
     .minimum_version_id = 1,
+    .needed = m_needed,
     .fields = (VMStateField[]) {
         VMSTATE_UINT32(env.v7m.other_sp, ARMCPU),
         VMSTATE_END_OF_LIST()

