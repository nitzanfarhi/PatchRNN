commit b5ae5f911d221ad85090d6805ab9ab020f6e4703
Author: Benjamin Herrenschmidt <benh@kernel.crashing.org>
Date:   Mon Oct 27 19:48:44 2008 +0000

    powerpc/pci: Make pcibios_allocate_bus_resources more robust
    
    To properly fix PCI hotplug, it's useful to be able to make the fixup
    passes on all devices whether they were just hot plugged or already
    there.
    
    However, pcibios_allocate_bus_resources() wouldn't cope well with
    being called twice for a given bus.  This makes it ignore resources
    that have already been allocated, along with adding a bit of debug
    output.
    
    Signed-off-by: Benjamin Herrenschmidt <benh@kernel.crashing.org>
    Signed-off-by: Paul Mackerras <paulus@samba.org>

diff --git a/arch/powerpc/kernel/pci-common.c b/arch/powerpc/kernel/pci-common.c
index 0eaabd41474f..f965397a6105 100644
--- a/arch/powerpc/kernel/pci-common.c
+++ b/arch/powerpc/kernel/pci-common.c
@@ -1243,9 +1243,12 @@ void pcibios_allocate_bus_resources(struct pci_bus *bus)
 	int i;
 	struct resource *res, *pr;
 
+	pr_debug("PCI: Allocating bus resources for %04x:%02x...\n",
+		 pci_domain_nr(bus), bus->number);
+
 	for (i = 0; i < PCI_BUS_NUM_RESOURCES; ++i) {
 		if ((res = bus->resource[i]) == NULL || !res->flags
-		    || res->start > res->end)
+		    || res->start > res->end || res->parent)
 			continue;
 		if (bus->parent == NULL)
 			pr = (res->flags & IORESOURCE_IO) ?

