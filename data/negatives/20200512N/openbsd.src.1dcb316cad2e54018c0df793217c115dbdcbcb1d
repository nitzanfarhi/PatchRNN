commit 1dcb316cad2e54018c0df793217c115dbdcbcb1d
Author: henning <henning@openbsd.org>
Date:   Wed Mar 23 11:30:21 2005 +0000

    grow receive buffer on the routing socket, from bgpd

diff --git a/usr.sbin/ospfd/kroute.c b/usr.sbin/ospfd/kroute.c
index 7ed3c58d195..b5aa2939458 100644
--- a/usr.sbin/ospfd/kroute.c
+++ b/usr.sbin/ospfd/kroute.c
@@ -1,4 +1,4 @@
-/*	$OpenBSD: kroute.c,v 1.7 2005/03/23 11:07:42 henning Exp $ */
+/*	$OpenBSD: kroute.c,v 1.8 2005/03/23 11:30:21 henning Exp $ */
 
 /*
  * Copyright (c) 2004 Esben Norby <norby@openbsd.org>
@@ -121,7 +121,8 @@ kif_init(void)
 int
 kr_init(int fs)
 {
-	int opt = 0;
+	int		opt = 0, rcvbuf, default_rcvbuf;
+	socklen_t	optlen;
 
 	kr_state.fib_sync = fs;
 
@@ -135,6 +136,19 @@ kr_init(int fs)
 	    &opt, sizeof(opt)) == -1)
 		log_warn("kr_init: setsockopt");	/* not fatal */
 
+	/* grow receive buffer, don't wanna miss messages */
+	optlen = sizeof(default_rcvbuf);
+	if (getsockopt(kr_state.fd, SOL_SOCKET, SO_RCVBUF,
+	    &default_rcvbuf, &optlen) == -1)
+		log_warn("kr_init getsockopt SOL_SOCKET SO_RCVBUF");
+	else
+		for (rcvbuf = MAX_RTSOCK_BUF;
+		    rcvbuf > default_rcvbuf &&
+		    setsockopt(kr_state.fd, SOL_SOCKET, SO_RCVBUF,
+		    &rcvbuf, sizeof(rcvbuf)) == -1 && errno == ENOBUFS;
+		    rcvbuf /= 2)
+			;	/* nothing */
+
 	kr_state.pid = getpid();
 	kr_state.rtseq = 1;
 
diff --git a/usr.sbin/ospfd/ospfd.h b/usr.sbin/ospfd/ospfd.h
index c00d3f45b87..0b89b43e0d3 100644
--- a/usr.sbin/ospfd/ospfd.h
+++ b/usr.sbin/ospfd/ospfd.h
@@ -1,4 +1,4 @@
-/*	$OpenBSD: ospfd.h,v 1.18 2005/03/23 10:46:26 henning Exp $ */
+/*	$OpenBSD: ospfd.h,v 1.19 2005/03/23 11:30:21 henning Exp $ */
 
 /*
  * Copyright (c) 2004 Esben Norby <norby@openbsd.org>
@@ -37,6 +37,7 @@
 
 #define	READ_BUF_SIZE		65535
 #define	RT_BUF_SIZE		16384
+#define	MAX_RTSOCK_BUF		128 * 1024
 
 #define	OSPFD_FLAG_NO_FIB_UPDATE	0x0001
 

