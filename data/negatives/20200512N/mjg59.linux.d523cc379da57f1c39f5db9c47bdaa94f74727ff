commit d523cc379da57f1c39f5db9c47bdaa94f74727ff
Author: Michael Ellerman <michael@ellerman.id.au>
Date:   Tue Feb 17 00:18:49 2009 +0000

    powerpc/pseries: Return req#msi(-x) if request is larger
    
    If a driver asks for more MSIs than the devices "req#msi(-x)" property,
    we currently return -ENOSPC. This doesn't give the driver any chance to
    make a new request with a number that might work.
    
    So if "req#msi(-x)" is less than the request, return its value. To be
    100% safe, make sure we return an error if req_msi == 0.
    
    Signed-off-by: Michael Ellerman <michael@ellerman.id.au>
    Signed-off-by: Benjamin Herrenschmidt <benh@kernel.crashing.org>

diff --git a/arch/powerpc/platforms/pseries/msi.c b/arch/powerpc/platforms/pseries/msi.c
index 073b518338a3..081af6d7fa02 100644
--- a/arch/powerpc/platforms/pseries/msi.c
+++ b/arch/powerpc/platforms/pseries/msi.c
@@ -154,7 +154,11 @@ static int check_req(struct pci_dev *pdev, int nvec, char *prop_name)
 
 	if (*req_msi < nvec) {
 		pr_debug("rtas_msi: %s requests < %d MSIs\n", prop_name, nvec);
-		return -ENOSPC;
+
+		if (*req_msi == 0) /* Be paranoid */
+			return -ENOSPC;
+
+		return *req_msi;
 	}
 
 	return 0;

