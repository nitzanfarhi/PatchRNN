commit 46276a1a24bc40c39f8a7016df8bbad6673c2097
Author: Morris Jette <jette@schedmd.com>
Date:   Thu Feb 27 15:45:18 2014 -0800

    switch/cray: Sync global state with recovered steps
    
    If the switch/cray global state save/restore fails, avoid re-allocating
    ports based upon the job steps that we can recover

diff --git a/src/plugins/switch/cray/switch_cray.c b/src/plugins/switch/cray/switch_cray.c
index 6ab942e51b..12ea081406 100644
--- a/src/plugins/switch/cray/switch_cray.c
+++ b/src/plugins/switch/cray/switch_cray.c
@@ -712,6 +712,12 @@ int switch_p_unpack_jobinfo(switch_jobinfo_t *switch_job, Buf buffer,
 		goto unpack_error;
 	}
 	safe_unpack32(&job->port, buffer);
+#ifdef HAVE_NATIVE_CRAY
+	/* If the libstate save/restore failed, at least make sure that we
+	 * do not re-allocate ports assigned to job steps that we recover. */
+	if ((job->port >= MIN_PORT) && (job->port <= MAX_PORT))
+		port_resv[job->port - MIN_PORT] = 1;
+#endif
 
 	if (debug_flags & DEBUG_FLAG_SWITCH) {
 		info("(%s:%d: %s) switch_jobinfo_t contents:",

