commit 264c6bd26df5380dc52687f6ec0351354012a948
Author: Timo Sirainen <tss@iki.fi>
Date:   Sat Feb 16 16:45:47 2013 +0200

    dsync: If unexpected changes happen during sync, return a safe last-common-uid for state.

diff --git a/src/doveadm/dsync/dsync-mailbox-import.c b/src/doveadm/dsync/dsync-mailbox-import.c
index 125f8cc1e..16ebd1bdc 100644
--- a/src/doveadm/dsync/dsync-mailbox-import.c
+++ b/src/doveadm/dsync/dsync-mailbox-import.c
@@ -1819,6 +1819,11 @@ reassign_unwanted_uids(struct dsync_mailbox_importer *importer,
 			*changes_during_sync_r = TRUE;
 		}
 	}
+	if (*changes_during_sync_r) {
+		/* conflicting changes during sync, revert our last-common-uid
+		   back to a safe value. */
+		importer->last_common_uid = importer->local_uid_next - 1;
+	}
 	return ret;
 }
 

