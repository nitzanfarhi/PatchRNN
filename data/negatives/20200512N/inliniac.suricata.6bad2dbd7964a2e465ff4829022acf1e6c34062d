commit 6bad2dbd7964a2e465ff4829022acf1e6c34062d
Author: Victor Julien <victor@inliniac.net>
Date:   Mon Sep 26 18:53:26 2011 +0200

    Don't match on IP only rules that use ports if packet is not (proper) TCP, UDP or SCTP. Rules out frags matching as well.

diff --git a/src/detect-engine-iponly.c b/src/detect-engine-iponly.c
index 1ddb38c2..8196dc47 100644
--- a/src/detect-engine-iponly.c
+++ b/src/detect-engine-iponly.c
@@ -1047,6 +1047,13 @@ void IPOnlyMatchPacket(ThreadVars *tv,
                                 continue;
                             }
                         }
+                    } else {
+                        if (!(s->flags & SIG_FLAG_DP_ANY)) {
+                            continue;
+                        }
+                        if (!(s->flags & SIG_FLAG_SP_ANY)) {
+                            continue;
+                        }
                     }
 
                     if (!IPOnlyMatchCompatSMs(tv, det_ctx, s, p)) {

