commit 421cc3e7e89cb807d3c5f6de486abb2167c8e792
Author: Paolo Bonzini <pbonzini@redhat.com>
Date:   Thu Sep 8 17:42:53 2016 +0200

    Revert "megasas: remove useless check for cmd->frame"
    
    This reverts commit 8cc46787b5b58f01a11c919c7ff939ed009e27fc.
    It turns out that cmd->frame can be NULL and thus the commit
    can cause a SIGSEGV
    
    Reported-by: Holger Schranz <holger@fam-schranz.de>
    Cc: qemu-stable@nongnu.org
    Signed-off-by: Paolo Bonzini <pbonzini@redhat.com>

diff --git a/hw/scsi/megasas.c b/hw/scsi/megasas.c
index e968302fdc..52a41239cf 100644
--- a/hw/scsi/megasas.c
+++ b/hw/scsi/megasas.c
@@ -1981,7 +1981,11 @@ static void megasas_handle_frame(MegasasState *s, uint64_t frame_addr,
         break;
     }
     if (frame_status != MFI_STAT_INVALID_STATUS) {
-        cmd->frame->header.cmd_status = frame_status;
+        if (cmd->frame) {
+            cmd->frame->header.cmd_status = frame_status;
+        } else {
+            megasas_frame_set_cmd_status(s, frame_addr, frame_status);
+        }
         megasas_unmap_frame(s, cmd);
         megasas_complete_frame(s, cmd->context);
     }

