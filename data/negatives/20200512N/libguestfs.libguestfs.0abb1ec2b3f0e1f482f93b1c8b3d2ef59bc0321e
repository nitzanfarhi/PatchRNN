commit 0abb1ec2b3f0e1f482f93b1c8b3d2ef59bc0321e
Author: Richard Jones <rjones@trick.home.annexia.org>
Date:   Sat Aug 22 10:40:42 2009 +0100

    Add waitpid along guestfs_close path (RHBZ#518747).

diff --git a/src/guestfs.c b/src/guestfs.c
index 04bd4e88f..204125b9e 100644
--- a/src/guestfs.c
+++ b/src/guestfs.c
@@ -348,6 +348,10 @@ guestfs_close (guestfs_h *g)
   g->fd[1] = -1;
   g->sock = -1;
 
+  /* Wait for subprocess(es) to exit. */
+  waitpid (g->pid, NULL, 0);
+  if (g->recoverypid > 0) waitpid (g->recoverypid, NULL, 0);
+
   /* Remove tmpfiles. */
   if (g->tmpdir) {
     snprintf (filename, sizeof filename, "%s/sock", g->tmpdir);

