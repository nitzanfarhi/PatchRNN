commit a686425b31bb6441f6e20d698bf31dc65043f61f
Author: Gerald Schaefer <gerald.schaefer@de.ibm.com>
Date:   Wed May 9 16:27:37 2012 +0200

    s390/hugepages: clear page table for sw large page emulation
    
    The software large page emulation on s390 did not clear the the
    pre-allocated page table in arch_release_hugepage() before freeing
    it. This could trigger the WARN_ON(!pte_none(*pte) in mm/vmalloc.c:106
    and make vmap_pte_range() fail, because the page table could be reused
    in page_table_alloc(). This is fixed now by calling clear_table()
    before page_table_free().
    
    Signed-off-by: Gerald Schaefer <gerald.schaefer@de.ibm.com>
    Signed-off-by: Martin Schwidefsky <schwidefsky@de.ibm.com>

diff --git a/arch/s390/mm/hugetlbpage.c b/arch/s390/mm/hugetlbpage.c
index 597bb2d27c3c..900de2b3cf28 100644
--- a/arch/s390/mm/hugetlbpage.c
+++ b/arch/s390/mm/hugetlbpage.c
@@ -58,6 +58,8 @@ void arch_release_hugepage(struct page *page)
 	ptep = (pte_t *) page[1].index;
 	if (!ptep)
 		return;
+	clear_table((unsigned long *) ptep, _PAGE_TYPE_EMPTY,
+		    PTRS_PER_PTE * sizeof(pte_t));
 	page_table_free(&init_mm, (unsigned long *) ptep);
 	page[1].index = 0;
 }

