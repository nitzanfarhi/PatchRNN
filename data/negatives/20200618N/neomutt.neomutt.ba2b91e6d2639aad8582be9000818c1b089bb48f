commit ba2b91e6d2639aad8582be9000818c1b089bb48f
Author: Brendan Cully <brendan@kublai.com>
Date:   Thu Jan 1 00:00:00 1970 +0000

    Test that envelope from or from is set before attempting SMTP delivery.
    Closes #3079.

diff --git a/smtp.c b/smtp.c
index 654f4aa98..59c3f4fdb 100644
--- a/smtp.c
+++ b/smtp.c
@@ -210,8 +210,21 @@ mutt_smtp_send (const ADDRESS* from, const ADDRESS* to, const ADDRESS* cc,
 {
   CONNECTION *conn;
   ACCOUNT account;
-  int ret = -1;
+  const char* envfrom;
   char buf[1024];
+  int ret = -1;
+
+  /* it might be better to synthesize an envelope from from user and host
+   * but this condition is most likely arrived at accidentally */
+  if (EnvFrom)
+    envfrom = EnvFrom->mailbox;
+  else if (from)
+    envfrom = from->mailbox;
+  else
+  {
+    mutt_error (_("No from address given"));
+    return -1;
+  }
 
   if (smtp_fill_account (&account) < 0)
     return ret;

