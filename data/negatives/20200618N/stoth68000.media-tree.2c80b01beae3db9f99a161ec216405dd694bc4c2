commit 2c80b01beae3db9f99a161ec216405dd694bc4c2
Author: Jeremy Fitzhardinge <jeremy@goop.org>
Date:   Wed Nov 28 16:21:20 2007 -0800

    xen: mask _PAGE_PCD from ptes
    
    _PAGE_PCD maps a page with caching disabled, which is typically used for
    mapping harware registers.  Xen never allows it to be set on a mapping, and
    unprivileged guests never need it since they can't see the real underlying
    hardware.  However, some uncached mappings are made early when probing the
    (non-existent) APIC, and its OK to mask off the PCD flag in these cases.
    
    This became necessary because Xen started checking for this bit, rather
    than silently masking it off.
    
    Signed-off-by: Jeremy Fitzhardinge <jeremy@xensource.com>
    Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
    Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>

diff --git a/arch/x86/xen/mmu.c b/arch/x86/xen/mmu.c
index b2e32f9d0071..0ac6c5dc49ba 100644
--- a/arch/x86/xen/mmu.c
+++ b/arch/x86/xen/mmu.c
@@ -244,6 +244,8 @@ pte_t xen_make_pte(unsigned long long pte)
 	if (pte & 1)
 		pte = phys_to_machine(XPADDR(pte)).maddr;
 
+	pte &= ~_PAGE_PCD;
+
 	return (pte_t){ pte, pte >> 32 };
 }
 
@@ -291,6 +293,8 @@ pte_t xen_make_pte(unsigned long pte)
 	if (pte & _PAGE_PRESENT)
 		pte = phys_to_machine(XPADDR(pte)).maddr;
 
+	pte &= ~_PAGE_PCD;
+
 	return (pte_t){ pte };
 }
 

