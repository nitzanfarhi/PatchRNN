commit faa4cfa6b334fc07c3386e620a2fb55de508c077
Author: Björn Steinbrink <B.Steinbrink@gmx.de>
Date:   Sat Jun 16 10:15:55 2007 -0700

    i386: fix NMI watchdog not reserving its MSRs
    
    At system boot time, the NMI watchdog no longer reserved its MSRs, allowing
    other subsystems to mess with them.  Fix that.
    
    Signed-off-by: Björn Steinbrink <B.Steinbrink@gmx.de>
    Cc: Andi Kleen <ak@suse.de>
    Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
    Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>

diff --git a/arch/i386/kernel/cpu/perfctr-watchdog.c b/arch/i386/kernel/cpu/perfctr-watchdog.c
index 2b04c8f1db62..8343244b72c4 100644
--- a/arch/i386/kernel/cpu/perfctr-watchdog.c
+++ b/arch/i386/kernel/cpu/perfctr-watchdog.c
@@ -614,6 +614,12 @@ int lapic_watchdog_init(unsigned nmi_hz)
 		probe_nmi_watchdog();
 		if (!wd_ops)
 			return -1;
+
+		if (!wd_ops->reserve()) {
+			printk(KERN_ERR
+				"NMI watchdog: cannot reserve perfctrs\n");
+			return -1;
+		}
 	}
 
 	if (!(wd_ops->setup(nmi_hz))) {

