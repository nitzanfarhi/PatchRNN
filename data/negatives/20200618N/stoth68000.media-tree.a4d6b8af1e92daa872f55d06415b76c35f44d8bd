commit a4d6b8af1e92daa872f55d06415b76c35f44d8bd
Author: Kazunori MIYAZAWA <kazunori@miyazawa.org>
Date:   Thu Feb 14 14:51:38 2008 -0800

    [AF_KEY]: Fix bug in spdadd
    
    This patch fix a BUG when adding spds which have same selector.
    
    Signed-off-by: Kazunori MIYAZAWA <kazunori@miyazawa.org>
    Signed-off-by: David S. Miller <davem@davemloft.net>

diff --git a/net/key/af_key.c b/net/key/af_key.c
index b3ac85e808ac..1c853927810a 100644
--- a/net/key/af_key.c
+++ b/net/key/af_key.c
@@ -2291,6 +2291,7 @@ static int pfkey_spdadd(struct sock *sk, struct sk_buff *skb, struct sadb_msg *h
 	return 0;
 
 out:
+	xp->dead = 1;
 	xfrm_policy_destroy(xp);
 	return err;
 }

