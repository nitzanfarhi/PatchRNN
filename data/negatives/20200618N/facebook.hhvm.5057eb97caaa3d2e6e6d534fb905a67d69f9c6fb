commit 5057eb97caaa3d2e6e6d534fb905a67d69f9c6fb
Author: Edwin Smith <smith@fb.com>
Date:   Sat Sep 30 03:28:48 2017 -0700

    Do not sweep SmallMalloc blocks when m_bypassSlabAlloc is true
    
    Summary:
    When we aren't using the small block allocator, SmallMalloc
    blocks are wrapped with a BigObj header. So when sweeping, we
    need to skip them.
    
    Reviewed By: ricklavoie
    
    Differential Revision: D5945838
    
    fbshipit-source-id: 10d23642c99b5ca5bf1ad64ebfb7bc81f1e258ec

diff --git a/hphp/runtime/base/heap-collect.cpp b/hphp/runtime/base/heap-collect.cpp
index 52adda0710..736859ac8d 100644
--- a/hphp/runtime/base/heap-collect.cpp
+++ b/hphp/runtime/base/heap-collect.cpp
@@ -374,9 +374,9 @@ NEVER_INLINE void Marker::sweep() {
   heap_.iterate(
     [&](HeapObject* big, size_t big_size) { // onBig
       if (big->kind() == HeaderKind::BigObj) {
-        big = static_cast<MallocNode*>(big) + 1;
-        if (!marked(big)) {
-          mm.freeBigSize(big);
+        HeapObject* h2 = static_cast<MallocNode*>(big) + 1;
+        if (!marked(h2) && h2->kind() != HeaderKind::SmallMalloc) {
+          mm.freeBigSize(h2);
         }
       }
     },

