commit 24d7cd207f8e0d6864a314d5f03b5434403ff940
Author: David Rientjes <rientjes@google.com>
Date:   Tue Aug 12 13:46:07 2014 -0700

    mm, hugetlb_cgroup: align hugetlb cgroup limit to hugepage size
    
    Memcg aligns memory.limit_in_bytes to PAGE_SIZE as part of the resource
    counter since it makes no sense to allow a partial page to be charged.
    
    As a result of the hugetlb cgroup using the resource counter, it is also
    aligned to PAGE_SIZE but makes no sense unless aligned to the size of
    the hugepage being limited.
    
    Align hugetlb cgroup limit to hugepage size.
    
    Signed-off-by: David Rientjes <rientjes@google.com>
    Acked-by: Michal Hocko <mhocko@suse.cz>
    Cc: "Aneesh Kumar K.V" <aneesh.kumar@linux.vnet.ibm.com>
    Cc: Tejun Heo <tj@kernel.org>
    Cc: Li Zefan <lizefan@huawei.com>
    Cc: Michal Hocko <mhocko@suse.cz>
    Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
    Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>

diff --git a/mm/hugetlb_cgroup.c b/mm/hugetlb_cgroup.c
index 9aae6f47433f..9eebfadeeee1 100644
--- a/mm/hugetlb_cgroup.c
+++ b/mm/hugetlb_cgroup.c
@@ -275,6 +275,7 @@ static ssize_t hugetlb_cgroup_write(struct kernfs_open_file *of,
 		ret = res_counter_memparse_write_strategy(buf, &val);
 		if (ret)
 			break;
+		val = ALIGN(val, 1ULL << huge_page_shift(&hstates[idx]));
 		ret = res_counter_set_limit(&h_cg->hugepage[idx], val);
 		break;
 	default:

