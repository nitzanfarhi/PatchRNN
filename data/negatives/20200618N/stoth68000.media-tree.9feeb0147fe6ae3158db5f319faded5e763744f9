commit 9feeb0147fe6ae3158db5f319faded5e763744f9
Author: Marc Dietrich <marvin24@gmx.de>
Date:   Tue Sep 27 19:01:08 2011 +0200

    staging: nvec: send suspend messages synchronously
    
    The suspend commands need to be sent using the
    synchronous method, otherwise the power gets
    disabled before the messages are transferred.
    
    Signed-off-by: Marc Dietrich <marvin24@gmx.de>
    [jak@jak-linux.org: Rewrote commit message]
    Signed-off-by: Julian Andres Klode <jak@jak-linux.org>
    Signed-off-by: Greg Kroah-Hartman <gregkh@suse.de>

diff --git a/drivers/staging/nvec/nvec.c b/drivers/staging/nvec/nvec.c
index 07c8e0952a24..fb0f0959eafa 100644
--- a/drivers/staging/nvec/nvec.c
+++ b/drivers/staging/nvec/nvec.c
@@ -861,10 +861,16 @@ static int __devexit tegra_nvec_remove(struct platform_device *pdev)
 static int tegra_nvec_suspend(struct platform_device *pdev, pm_message_t state)
 {
 	struct nvec_chip *nvec = platform_get_drvdata(pdev);
+	struct nvec_msg *msg;
 
 	dev_dbg(nvec->dev, "suspending\n");
-	nvec_write_async(nvec, EC_DISABLE_EVENT_REPORTING, 3);
-	nvec_write_async(nvec, "\x04\x02", 2);
+
+	/* keep these sync or you'll break suspend */
+	msg = nvec_write_sync(nvec, EC_DISABLE_EVENT_REPORTING, 3);
+	nvec_msg_free(nvec, msg);
+	msg = nvec_write_sync(nvec, "\x04\x02", 2);
+	nvec_msg_free(nvec, msg);
+
 	nvec_disable_i2c_slave(nvec);
 
 	return 0;

