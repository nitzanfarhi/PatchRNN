commit 108026562b0b81d031d76bb3ea43de2f617a00ac
Author: Thorvald Natvig <slicer@users.sourceforge.net>
Date:   Thu Dec 8 20:38:16 2005 +0000

    Support graceful failure of loading the overlay (For Win2k support)
    
    
    git-svn-id: https://mumble.svn.sourceforge.net/svnroot/mumble/trunk@299 05730e5d-ab1b-0410-a4ac-84af385074fa

diff --git a/Overlay_win.cpp b/Overlay_win.cpp
index 9bb12df3..07b15331 100644
--- a/Overlay_win.cpp
+++ b/Overlay_win.cpp
@@ -315,13 +315,14 @@ Overlay::Overlay() : QObject() {
 
 	qlOverlay->setFileName(path);
 	if (! qlOverlay->load()) {
-		QMessageBox::critical(NULL, tr("Mumble"), tr("Failed to load overlay library."), QMessageBox::Ok, QMessageBox::NoButton);
-		qFatal("Overlay failure");
+		QMessageBox::critical(NULL, tr("Mumble"), tr("Failed to load overlay library. This means either that the library (mumble_ol.dll) wasn't found in the directory you ran mumble from, or that you're on an OS earlier than WinXP SP2."), QMessageBox::Ok, QMessageBox::NoButton);
+		qWarning("Overlay failure");
 	}
 
 	sm=reinterpret_cast<SharedMem *>(qlOverlay->resolve("sm"));
 #ifndef QT_NO_DEBUG
-	sm->bDebug = true;
+	if (sm)
+		sm->bDebug = true;
 #endif
 
 	hpInstall = (HooksProc)qlOverlay->resolve("InstallHooks");
@@ -346,10 +347,16 @@ Overlay::~Overlay() {
 }
 
 bool Overlay::isActive() const {
+	if (! sm)
+		return false;
+
 	return sm->bHooked;
 }
 
 void Overlay::setActive(bool act) {
+	if (! sm)
+		return;
+
 	if (act)
 		hpInstall();
 	else
@@ -357,10 +364,14 @@ void Overlay::setActive(bool act) {
 }
 
 void Overlay::on_Timer_timeout() {
-	sm->lastAppAlive = GetTickCount();
+	if (sm)
+		sm->lastAppAlive = GetTickCount();
 }
 
 void Overlay::toggleShow() {
+	if (! sm)
+		return;
+
 	DWORD dwWaitResult = WaitForSingleObject(hMutex, 500L);
 	if (dwWaitResult == WAIT_OBJECT_0) {
 		if (sm->bShow && bShowAll) {
@@ -379,6 +390,9 @@ void Overlay::forceSettings() {
 	QString str;
 	const wchar_t *wstr;
 
+	if (! sm)
+		return;
+
 	DWORD dwWaitResult = WaitForSingleObject(hMutex, 500L);
 	if (dwWaitResult == WAIT_OBJECT_0) {
 		str = g.s.qfOverlayFont.family();
@@ -412,6 +426,9 @@ void Overlay::setPlayers(QList<Player *> players) {
 	QList<qpChanCol> linkchans;
 	const wchar_t *wstr;
 
+	if (! sm)
+		return;
+
 	if (players.count() > 0) {
 		Channel *home = Player::get(g.sId)->cChannel;
 		foreach(Channel *c, home->allLinks()) {
diff --git a/main.cpp b/main.cpp
index b32694a2..77e47977 100644
--- a/main.cpp
+++ b/main.cpp
@@ -69,6 +69,7 @@ int main(int argc, char **argv)
 	a.setApplicationName("Mumble");
 	a.setOrganizationName("Mumble");
 	a.setOrganizationDomain("mumble.sourceforge.net");
+	a.setQuitOnLastWindowClosed(false);
 
 	g.qs = new QSettings();
 
@@ -119,6 +120,7 @@ int main(int argc, char **argv)
 		qWarning("Application: Failed to set priority!");
 #endif
 
+	a.setQuitOnLastWindowClosed(true);
 	res=a.exec();
 
 	g.s.save();

