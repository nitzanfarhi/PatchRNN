commit 4248bd7d3e2c7c87ff695d812018b8c22b5a5ab1
Author: Andrzej Pietrasiewicz <andrzej.p@samsung.com>
Date:   Fri Jul 24 09:48:41 2015 +0200

    usb: gadget: f_printer: actually limit the number of instances
    
    There is a predefined maximum number of printer instances, currently 4.
    A chrdev region is allocated accordingly, but with configfs the user
    can create as many printer function directories as they like. To make the
    number of printer  instances consistent with the number of allocated
    minors, the limit is enforced at directory creation time.
    
    Signed-off-by: Andrzej Pietrasiewicz <andrzej.p@samsung.com>
    Signed-off-by: Felipe Balbi <balbi@ti.com>

diff --git a/drivers/usb/gadget/function/f_printer.c b/drivers/usb/gadget/function/f_printer.c
index 44173df27273..357f63f47b42 100644
--- a/drivers/usb/gadget/function/f_printer.c
+++ b/drivers/usb/gadget/function/f_printer.c
@@ -1248,7 +1248,15 @@ static struct config_item_type printer_func_type = {
 
 static inline int gprinter_get_minor(void)
 {
-	return ida_simple_get(&printer_ida, 0, 0, GFP_KERNEL);
+	int ret;
+
+	ret = ida_simple_get(&printer_ida, 0, 0, GFP_KERNEL);
+	if (ret >= PRINTER_MINORS) {
+		ida_simple_remove(&printer_ida, ret);
+		ret = -ENODEV;
+	}
+
+	return ret;
 }
 
 static inline void gprinter_put_minor(int minor)

