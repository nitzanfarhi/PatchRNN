commit 05a7c225b21d1bc48098e332f0536ecb31098176
Author: miod <miod@openbsd.org>
Date:   Sat May 19 20:33:49 2007 +0000

    Force other processors to spin when one is in ddb.

diff --git a/sys/arch/m88k/m88k/db_interface.c b/sys/arch/m88k/m88k/db_interface.c
index ed3c1e3b7d3..005673618c6 100644
--- a/sys/arch/m88k/m88k/db_interface.c
+++ b/sys/arch/m88k/m88k/db_interface.c
@@ -1,4 +1,4 @@
-/*	$OpenBSD: db_interface.c,v 1.6 2007/03/21 19:32:17 miod Exp $	*/
+/*	$OpenBSD: db_interface.c,v 1.7 2007/05/19 20:33:49 miod Exp $	*/
 /*
  * Mach Operating System
  * Copyright (c) 1993-1991 Carnegie Mellon University
@@ -409,6 +409,7 @@ m88k_db_trap(type, frame)
 	curcpu()->ci_ddb_state = CI_DDB_ENTERDDB;
 	__mp_lock(&ddb_mp_lock);
 	curcpu()->ci_ddb_state = CI_DDB_INDDB;
+	m88k_broadcast_ipi(CI_IPI_DDB);		/* pause other processors */
 #endif
 
 	ddb_regs = frame->tf_regs;
diff --git a/sys/arch/mvme88k/mvme88k/m188_machdep.c b/sys/arch/mvme88k/mvme88k/m188_machdep.c
index 1c030dea0bf..b4150e6cc55 100644
--- a/sys/arch/mvme88k/mvme88k/m188_machdep.c
+++ b/sys/arch/mvme88k/mvme88k/m188_machdep.c
@@ -1,4 +1,4 @@
-/*	$OpenBSD: m188_machdep.c,v 1.30 2007/05/19 17:03:49 miod Exp $	*/
+/*	$OpenBSD: m188_machdep.c,v 1.31 2007/05/19 20:33:50 miod Exp $	*/
 /*
  * Copyright (c) 1998, 1999, 2000, 2001 Steve Murphree, Jr.
  * Copyright (c) 1996 Nivas Madhur
@@ -362,6 +362,17 @@ m188_ipi_handler(struct trapframe *eframe)
 	int ipi = ci->ci_ipi;
 	int spl = m188_curspl[ci->ci_cpuid];
 
+	if (ipi & CI_IPI_DDB) {
+#ifdef DDB
+		/*
+		 * Another processor has entered DDB. Spin on the ddb lock
+		 * until it is done.
+		 */
+		extern struct __mp_lock ddb_mp_lock;
+		__mp_lock(&ddb_mp_lock);
+		__mp_unlock(&ddb_mp_lock);
+#endif
+	}
 	if (ipi & CI_IPI_NOTIFY) {
 		/* nothing to do */
 	}

