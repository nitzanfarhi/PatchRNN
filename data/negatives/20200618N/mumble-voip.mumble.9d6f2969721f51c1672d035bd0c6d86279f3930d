commit 9d6f2969721f51c1672d035bd0c6d86279f3930d
Author: Mikkel Krautz <mkrautz@users.sourceforge.net>
Date:   Sat Oct 18 13:57:18 2008 +0000

    Sanity checking for CoD4 plugin [dd0t]
    
    
    git-svn-id: https://mumble.svn.sourceforge.net/svnroot/mumble/trunk@1331 05730e5d-ab1b-0410-a4ac-84af385074fa

diff --git a/plugins/cod4/cod4.cpp b/plugins/cod4/cod4.cpp
index 141d3921..d18c537c 100644
--- a/plugins/cod4/cod4.cpp
+++ b/plugins/cod4/cod4.cpp
@@ -44,6 +44,8 @@ static void about(HWND h) {
 
 static int fetch(float *pos, float *front, float *top) {
 	float viewHor, viewVer;
+	char state;
+
 	for (int i=0;i<3;i++)
 		pos[i]=front[i]=top[i]=0.0;
 
@@ -59,7 +61,24 @@ static int fetch(float *pos, float *front, float *top) {
 			0x0032AFF0		float	Y-Coordinate
 			0x0032AF3C		float	Horizontal view (degrees)
 			0x0032AF38		float	Vertical view (degrees)
+
+			0x0074E380		byte	Magical state value
+	*/
+	ok = peekProc((BYTE *) 0x0074E380, &state, 1); // Magical state value
+	if (! ok)
+		return false;
+	/*
+		state value is:
+		0		while not in game
+		4		while playing
+		8		while spectating
+
+		This value is used for disabling pa for spectators
+		or people not on a server.
 	*/
+	if (state != 4)
+		return true; // This results in all vectors beeing zero which tells mumble to ignore them.
+	
 	ok = peekProc((BYTE *) 0x0072AFD0, pos+2, 4) &&	//Z
 		 peekProc((BYTE *) 0x0072AFE0, pos, 4) &&	//X
 		 peekProc((BYTE *) 0x0072AFF0, pos+1, 4) && //Y

