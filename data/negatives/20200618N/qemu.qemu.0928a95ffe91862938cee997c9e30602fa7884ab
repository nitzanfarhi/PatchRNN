commit 0928a95ffe91862938cee997c9e30602fa7884ab
Author: Jan Kiszka <jan.kiszka@web.de>
Date:   Thu May 21 22:43:39 2009 +0200

    slirp: Reassign same address to same DHCP client
    
    In case a client restarts a DHCP recovery without releasing its old
    address, reassign the same address to prevent consuming free addresses
    and moving away from the standard client address.
    
    Signed-off-by: Jan Kiszka <jan.kiszka@siemens.com>

diff --git a/slirp/bootp.c b/slirp/bootp.c
index ae71e460b6..4e0082d2ca 100644
--- a/slirp/bootp.c
+++ b/slirp/bootp.c
@@ -49,13 +49,15 @@ if (slirp_debug & DBG_CALL) { fprintf(dfd, fmt, ##  __VA_ARGS__); fflush(dfd); }
 #define dprintf(fmt, ...)
 #endif
 
-static BOOTPClient *get_new_addr(struct in_addr *paddr)
+static BOOTPClient *get_new_addr(struct in_addr *paddr,
+                                 const uint8_t *macaddr)
 {
     BOOTPClient *bc;
     int i;
 
     for(i = 0; i < NB_ADDR; i++) {
-        if (!bootp_clients[i].allocated)
+        bc = &bootp_clients[i];
+        if (!bc->allocated || !memcmp(macaddr, bc->macaddr, 6))
             goto found;
     }
     return NULL;
@@ -192,7 +194,7 @@ static void bootp_reply(const struct bootp_t *bp)
         }
         if (!bc) {
          new_addr:
-            bc = get_new_addr(&daddr.sin_addr);
+            bc = get_new_addr(&daddr.sin_addr, client_ethaddr);
             if (!bc) {
                 dprintf("no address left\n");
                 return;

