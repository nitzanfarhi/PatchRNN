commit 903323754b8803a79884663a4fc387101783fbc2
Author: Gao,Yan <ygao@suse.com>
Date:   Sat Jan 26 00:03:59 2013 +0800

    High: fencing: Correctly register devices from CIB for Linux-HA fencing agents (bnc#800306)

diff --git a/lib/fencing/st_client.c b/lib/fencing/st_client.c
index d651bc55b..292ea2136 100644
--- a/lib/fencing/st_client.c
+++ b/lib/fencing/st_client.c
@@ -184,6 +184,14 @@ create_device_registration_xml(const char *id, const char *namespace, const char
     xmlNode *data = create_xml_node(NULL, F_STONITH_DEVICE);
     xmlNode *args = create_xml_node(data, XML_TAG_ATTRS);
 
+#if HAVE_STONITH_STONITH_H
+    namespace = get_stonith_provider(agent, namespace);
+    if (safe_str_eq(namespace, "heartbeat")) {
+        hash2field((gpointer) "plugin", (gpointer) agent, args);
+        agent = "fence_legacy";
+    }
+#endif
+
     crm_xml_add(data, XML_ATTR_ID, id);
     crm_xml_add(data, "origin", __FUNCTION__);
     crm_xml_add(data, "agent", agent);
@@ -204,14 +212,6 @@ stonith_api_register_device(stonith_t * st, int call_options,
     int rc = 0;
     xmlNode *data = NULL;
 
-#if HAVE_STONITH_STONITH_H
-    namespace = get_stonith_provider(agent, namespace);
-    if (safe_str_eq(namespace, "heartbeat")) {
-        stonith_key_value_add(params, "plugin", agent);
-        agent = "fence_legacy";
-    }
-#endif
-
     data = create_device_registration_xml(id, namespace, agent, params);
 
     rc = stonith_send_command(st, STONITH_OP_DEVICE_ADD, data, NULL, call_options, 0);

