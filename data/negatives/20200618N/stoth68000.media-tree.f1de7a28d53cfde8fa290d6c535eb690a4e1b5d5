commit f1de7a28d53cfde8fa290d6c535eb690a4e1b5d5
Author: Ido Schimmel <idosch@mellanox.com>
Date:   Thu Sep 1 10:37:44 2016 +0200

    mlxsw: spectrum: Don't take multiple references on a FID
    
    In commit 14d39461b3f4 ("mlxsw: spectrum: Use per-FID struct for the
    VLAN-aware bridge") I added a per-FID struct, which member ports can
    take a reference on upon VLAN membership configuration.
    
    However, sometimes only the VLAN flags (e.g. egress untagged) are
    toggled without changing the VLAN membership. In these cases we
    shouldn't take another reference on the FID.
    
    Fixes: 14d39461b3f4 ("mlxsw: spectrum: Use per-FID struct for the VLAN-aware bridge")
    Signed-off-by: Ido Schimmel <idosch@mellanox.com>
    Signed-off-by: Jiri Pirko <jiri@mellanox.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

diff --git a/drivers/net/ethernet/mellanox/mlxsw/spectrum_switchdev.c b/drivers/net/ethernet/mellanox/mlxsw/spectrum_switchdev.c
index d1b59cdfacc1..e0d95c419634 100644
--- a/drivers/net/ethernet/mellanox/mlxsw/spectrum_switchdev.c
+++ b/drivers/net/ethernet/mellanox/mlxsw/spectrum_switchdev.c
@@ -460,6 +460,9 @@ static int __mlxsw_sp_port_fid_join(struct mlxsw_sp_port *mlxsw_sp_port,
 {
 	struct mlxsw_sp_fid *f;
 
+	if (test_bit(fid, mlxsw_sp_port->active_vlans))
+		return 0;
+
 	f = mlxsw_sp_fid_find(mlxsw_sp_port->mlxsw_sp, fid);
 	if (!f) {
 		f = mlxsw_sp_fid_create(mlxsw_sp_port->mlxsw_sp, fid);

