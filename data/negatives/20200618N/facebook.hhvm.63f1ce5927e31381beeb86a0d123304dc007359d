commit 63f1ce5927e31381beeb86a0d123304dc007359d
Author: Jan Oravec <jan@fb.com>
Date:   Tue Sep 2 12:26:57 2014 -0700

    Set resumed flag before suspending VarEnv
    
    Summary: Recent cleanup changed the order of operations, causing assertion checks
    to fail. Make sure the resumed flag is set before attempting to suspend
    VarEnv.
    
    Reviewed By: @â€‹aravind
    
    Differential Revision: D1531325

diff --git a/hphp/runtime/vm/resumable.h b/hphp/runtime/vm/resumable.h
index 2b75250164..d41c8576c9 100644
--- a/hphp/runtime/vm/resumable.h
+++ b/hphp/runtime/vm/resumable.h
@@ -59,6 +59,7 @@ struct Resumable {
   static void* Create(const ActRec* fp, size_t numSlots, jit::TCA resumeAddr,
                       Offset resumeOffset, size_t objSize) {
     assert(fp);
+    assert(fp->resumed() == clone);
     DEBUG_ONLY auto const func = fp->func();
     assert(func);
     assert(func->isResumable());
@@ -76,6 +77,9 @@ struct Resumable {
       auto src = (void *)((uintptr_t)fp - frameSize);
       memcpy(mem, src, frameSize + sizeof(ActRec));
 
+      // Set resumed flag.
+      actRec->setResumed();
+
       // Suspend VarEnv if needed
       if (UNLIKELY(fp->hasVarEnv())) {
         fp->getVarEnv()->suspend(fp, actRec);
@@ -86,9 +90,6 @@ struct Resumable {
       memcpy(actRec, fp, sizeof(ActRec));
     }
 
-    // Set resumed flag.
-    actRec->setResumed();
-
     // Populate Resumable.
     resumable->m_resumeAddr = resumeAddr;
     resumable->m_resumeOffset = resumeOffset;

