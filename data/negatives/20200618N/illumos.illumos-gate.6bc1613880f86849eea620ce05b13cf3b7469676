commit 6bc1613880f86849eea620ce05b13cf3b7469676
Author: jj209869 <none@none>
Date:   Tue Feb 19 05:42:10 2008 -0800

    6532446 page_migrate() should not call PP_CLRMIGRATE(pp) without SE_EXCL lock on the page

diff --git a/usr/src/uts/common/vm/vm_page.c b/usr/src/uts/common/vm/vm_page.c
index e9ada7f823..e0e302dbab 100644
--- a/usr/src/uts/common/vm/vm_page.c
+++ b/usr/src/uts/common/vm/vm_page.c
@@ -19,7 +19,7 @@
  * CDDL HEADER END
  */
 /*
- * Copyright 2007 Sun Microsystems, Inc.  All rights reserved.
+ * Copyright 2008 Sun Microsystems, Inc.  All rights reserved.
  * Use is subject to license terms.
  */
 
@@ -5668,15 +5668,6 @@ page_migrate(
 		from = lgrp_pfn_to_lgrp(pfn);
 		to = lgrp_mem_choose(seg, addr, pgsz);
 
-		/*
-		 * Check to see whether we are trying to migrate page to lgroup
-		 * where it is allocated already
-		 */
-		if (to == from) {
-			PP_CLRMIGRATE(pp);
-			goto next;
-		}
-
 		/*
 		 * Need to get exclusive lock's to migrate
 		 */
@@ -5692,7 +5683,24 @@ page_migrate(
 				    page_cnt);
 				break;
 			}
+
+			/*
+			 * Check to see whether we are trying to migrate
+			 * page to lgroup where it is allocated already.
+			 * If so, clear the migrate bit and skip to next
+			 * page.
+			 */
+			if (i == 0 && to == from) {
+				PP_CLRMIGRATE(ppa[0]);
+				page_downgrade(ppa[0]);
+				goto next;
+			}
 		}
+
+		/*
+		 * If all constituent pages couldn't be locked,
+		 * unlock pages locked so far and skip to next page.
+		 */
 		if (i != page_cnt) {
 			while (--i != -1) {
 				page_downgrade(ppa[i]);

