commit eea481b7931f1a31080acfa92209662d2322a576
Author: Stephan Bosch <stephan.bosch@dovecot.fi>
Date:   Sat Sep 16 20:10:39 2017 +0200

    lib-smtp: smtp-submit: Use mail_debug setting to enable debug logging.
    
    When sendmail is used, this logs program_client debug messages.
    When SMTP is used (submission_host), this logs smtp_client debug messages.

diff --git a/src/lib-smtp/smtp-submit-settings.c b/src/lib-smtp/smtp-submit-settings.c
index e48653118..bda8c44cc 100644
--- a/src/lib-smtp/smtp-submit-settings.c
+++ b/src/lib-smtp/smtp-submit-settings.c
@@ -18,6 +18,7 @@ static bool smtp_submit_settings_check(void *_set, pool_t pool, const char **err
 
 static const struct setting_define smtp_submit_setting_defines[] = {
 	DEF(SET_STR, hostname),
+	DEF(SET_BOOL, mail_debug),
 
 	DEF(SET_STR_VARS, submission_host),
 	DEF(SET_STR_VARS, sendmail_path),
@@ -28,6 +29,7 @@ static const struct setting_define smtp_submit_setting_defines[] = {
 
 static const struct smtp_submit_settings smtp_submit_default_settings = {
 	.hostname = "",
+	.mail_debug = FALSE,
 
 	.submission_host = "",
 	.sendmail_path = "/usr/sbin/sendmail",
diff --git a/src/lib-smtp/smtp-submit-settings.h b/src/lib-smtp/smtp-submit-settings.h
index 3b7eb1e0f..1ede5c835 100644
--- a/src/lib-smtp/smtp-submit-settings.h
+++ b/src/lib-smtp/smtp-submit-settings.h
@@ -3,6 +3,7 @@
 
 struct smtp_submit_settings {
 	const char *hostname;
+	bool mail_debug;
 
 	const char *submission_host;
 	const char *sendmail_path;
diff --git a/src/lib-smtp/smtp-submit.c b/src/lib-smtp/smtp-submit.c
index e520ec318..799a652d2 100644
--- a/src/lib-smtp/smtp-submit.c
+++ b/src/lib-smtp/smtp-submit.c
@@ -285,6 +285,7 @@ smtp_submit_send_host(struct smtp_submit *subm)
 	smtp_set.my_hostname = set->hostname;
 	smtp_set.connect_timeout_msecs = set->submission_timeout*1000;
 	smtp_set.command_timeout_msecs = set->submission_timeout*1000;
+	smtp_set.debug = set->mail_debug;
 
 	smtp_client = smtp_client_init(&smtp_set);
 	smtp_conn = smtp_client_connection_create(smtp_client,
@@ -359,6 +360,7 @@ smtp_submit_send_sendmail(struct smtp_submit *subm)
 	i_zero(&pc_set);
 	pc_set.client_connect_timeout_msecs = set->submission_timeout * 1000;
 	pc_set.input_idle_timeout_msecs = set->submission_timeout * 1000;
+	pc_set.debug = set->mail_debug;
 	restrict_access_init(&pc_set.restrict_set);
 
 	pc = program_client_local_create
diff --git a/src/lib-smtp/test-smtp-submit.c b/src/lib-smtp/test-smtp-submit.c
index 715ddbaa0..bfe6ea3da 100644
--- a/src/lib-smtp/test-smtp-submit.c
+++ b/src/lib-smtp/test-smtp-submit.c
@@ -1787,6 +1787,7 @@ test_client_defaults(struct smtp_submit_settings *smtp_set)
 	smtp_set->hostname = "test";
 	smtp_set->submission_host = "";
 	smtp_set->sendmail_path = "/bin/false";
+	smtp_set->mail_debug = debug;
 }
 
 static void test_client_deinit(void)

