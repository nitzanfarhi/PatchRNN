commit e2136c35b317c408434eaec8c0f9ee288d9b9f38
Author: Peter van Dijk <peter.van.dijk@powerdns.com>
Date:   Thu Aug 16 21:15:59 2018 +0200

    after a db lookup, always finish the get cycle

diff --git a/pdns/rfc2136handler.cc b/pdns/rfc2136handler.cc
index bfa0cb31b..dafc8bdbc 100644
--- a/pdns/rfc2136handler.cc
+++ b/pdns/rfc2136handler.cc
@@ -961,6 +961,9 @@ int PacketHandler::processUpdate(DNSPacket *p) {
       di.backend->lookup(QType(QType::ANY), rr->d_name);
       while (di.backend->get(rec)) {
         if (rec.qtype != QType::CNAME && rec.qtype != QType::RRSIG) {
+          // leave database handle in a consistent state
+          while (di.backend->get(rec))
+            ;
           g_log<<Logger::Warning<<msgPrefix<<"Refusing update for " << rr->d_name << "/" << QType(rr->d_type).getName() << ": Data other than CNAME exists for the same name"<<endl;
           di.backend->abortTransaction();
           return RCode::Refused;
@@ -973,6 +976,9 @@ int PacketHandler::processUpdate(DNSPacket *p) {
       di.backend->lookup(QType(QType::CNAME), rr->d_name);
       while (di.backend->get(rec)) {
         if (rec.qtype == QType::CNAME && rr->d_type != QType::RRSIG) {
+          // leave database handle in a consistent state
+          while (di.backend->get(rec))
+            ;
           g_log<<Logger::Warning<<msgPrefix<<"Refusing update for " << rr->d_name << "/" << QType(rr->d_type).getName() << ": CNAME exists for the same name"<<endl;
           di.backend->abortTransaction();
           return RCode::Refused;

