commit 832c06358b01cf605698376bde26d1b300ec01b0
Author: lav <>
Date:   Mon Jul 20 17:02:54 1998 +0000

    *** empty log message ***

diff --git a/src/Filter.cc b/src/Filter.cc
index 50ad6068..588d3a1f 100644
--- a/src/Filter.cc
+++ b/src/Filter.cc
@@ -258,6 +258,17 @@ bool OutputFilter::Done()
       return true;
    return false;
 }
+bool OutputFilter::broken()
+{
+   if(w==0)
+      return false;
+   if(fd==-1)
+      return false;
+//    w->Do();
+   if(w->GetState()!=w->RUNNING)   
+      return true; // filter process terminated - pipe is broken
+   return false;
+}
 
 void FileStream::setmtime(time_t t)
 {
diff --git a/src/Filter.h b/src/Filter.h
index 230ab454..d6c8cc6c 100644
--- a/src/Filter.h
+++ b/src/Filter.h
@@ -50,6 +50,7 @@ public:
    virtual bool usesfd(int fd) { return this->fd==fd; }
    virtual void Kill(int=SIGTERM) {}
    virtual pid_t GetProcGroup() { return 0; }
+   virtual bool broken() { return false; }
 };
 
 class OutputFilter : public FDStream
@@ -83,6 +84,8 @@ public:
    bool usesfd(int fd) { return FDStream::usesfd(fd) || fd<=2; }
    void Kill(int sig=SIGTERM) { if(w) w->Kill(sig); }
    pid_t GetProcGroup() { return pg; }
+
+   bool broken();
 };
 
 class InputFilter : public OutputFilter
diff --git a/src/XferJob.cc b/src/XferJob.cc
index d46be968..034891ed 100644
--- a/src/XferJob.cc
+++ b/src/XferJob.cc
@@ -360,6 +360,12 @@ void  XferJob::RateDrain()
 
 int XferJob::TryWrite(FDStream *f)
 {
+   if(f->broken())
+   {
+      failed++;
+      return -1;
+   }
+
    if(in_buffer==0)
    {
       if(session)

