commit 96080a352e5643a13b41a7909285138ec36af383
Author: Sage Weil <sage@newdream.net>
Date:   Fri Jan 16 15:37:46 2009 -0800

    kclient: fix snap_rwsem link on non-existent cap release

diff --git a/src/kernel/caps.c b/src/kernel/caps.c
index e5482fbaab..b0bc9c7574 100644
--- a/src/kernel/caps.c
+++ b/src/kernel/caps.c
@@ -1632,7 +1632,6 @@ void ceph_handle_caps(struct ceph_mds_client *mdsc,
 		up_write(&mdsc->snap_rwsem);
 		check_caps = 1; /* we may have sent a RELEASE to the old auth */
 		goto done;
-
 	}
 
 	/* preallocate space for xattrs? */
@@ -1694,6 +1693,7 @@ bad:
 	return;
 
 release:
+	up_write(&mdsc->snap_rwsem);
 	send_cap_msg(mdsc, vino.ino, CEPH_CAP_OP_RELEASE,
 		     0, 0, 0,
 		     seq, 0,

