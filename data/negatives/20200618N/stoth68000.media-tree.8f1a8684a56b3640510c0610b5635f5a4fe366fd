commit 8f1a8684a56b3640510c0610b5635f5a4fe366fd
Author: Eyal Shapira <eyal@wizery.com>
Date:   Tue Jun 12 12:39:55 2012 +0300

    wlcore: send EAPOLs with basic rate policy
    
    EAPOLs are sent at high rates as they are considered
    data packets. Some APs like Motorola Symbol AP7131 and AP650
    don't respond well to these rates and don't respond with
    EAPOL 3/4 consistently. When sending EAPOL 2/4 at 54Mbps
    we've seen approx 30% success rate in getting EAPOL 3/4 response
    while using 11Mbps we got 100% success.
    To increase the chances of successful 4-Way handshake with
    such APs, send EAPOLs with basic rate policy in order to avoid
    high rates.
    
    Signed-off-by: Eyal Shapira <eyal@wizery.com>
    Signed-off-by: Luciano Coelho <coelho@ti.com>

diff --git a/drivers/net/wireless/ti/wlcore/tx.c b/drivers/net/wireless/ti/wlcore/tx.c
index 6983e7a829d0..8ee82b9f93f4 100644
--- a/drivers/net/wireless/ti/wlcore/tx.c
+++ b/drivers/net/wireless/ti/wlcore/tx.c
@@ -305,11 +305,15 @@ static void wl1271_tx_fill_hdr(struct wl1271 *wl, struct wl12xx_vif *wlvif,
 	if (is_dummy || !wlvif)
 		rate_idx = 0;
 	else if (wlvif->bss_type != BSS_TYPE_AP_BSS) {
-		/* if the packets are destined for AP (have a STA entry)
-		   send them with AP rate policies, otherwise use default
-		   basic rates */
+		/*
+		 * if the packets are destined for AP (have a STA entry)
+		 * send them with AP rate policies (EAPOLs are an exception),
+		 * otherwise use default basic rates
+		 */
 		if (control->flags & IEEE80211_TX_CTL_NO_CCK_RATE)
 			rate_idx = wlvif->sta.p2p_rate_idx;
+		else if (skb->protocol == cpu_to_be16(ETH_P_PAE))
+			rate_idx = wlvif->sta.basic_rate_idx;
 		else if (control->control.sta)
 			rate_idx = wlvif->sta.ap_rate_idx;
 		else

