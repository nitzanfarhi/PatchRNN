commit e763b793f7e5c09a859fc420eb0de385d80cf636
Author: Ben Lahaise <bcrl@linux.intel.com>
Date:   Mon Nov 7 00:58:52 2005 -0800

    [PATCH] uml: switch_mm fix
    
    Not quite, something along the lines of the patch below works correctly (and
    makes aio performance not suffer from multiple second delays), as skas0 mode
    correctly switches mm contexts, unlike TT (which should probably get nuked
    from the kernel now that skas0 seems to be working).
    
    Signed-off-by: Benjamin LaHaise <bcrl@linux.intel.com>
    Signed-off-by: Jeff Dike <jdike@addtoit.com>
    Cc: Paolo Giarrusso <blaisorblade@yahoo.it>
    Signed-off-by: Andrew Morton <akpm@osdl.org>
    Signed-off-by: Linus Torvalds <torvalds@osdl.org>

diff --git a/include/asm-um/mmu_context.h b/include/asm-um/mmu_context.h
index 2edb4f1f789c..9a0e48eb542e 100644
--- a/include/asm-um/mmu_context.h
+++ b/include/asm-um/mmu_context.h
@@ -29,7 +29,8 @@ static inline void activate_mm(struct mm_struct *old, struct mm_struct *new)
 	 * possible.
 	 */
 	if (old != new && (current->flags & PF_BORROWED_MM))
-		force_flush_all();
+		CHOOSE_MODE(force_flush_all(),
+			    switch_mm_skas(&new->context.skas.id));
 }
 
 static inline void switch_mm(struct mm_struct *prev, struct mm_struct *next, 

