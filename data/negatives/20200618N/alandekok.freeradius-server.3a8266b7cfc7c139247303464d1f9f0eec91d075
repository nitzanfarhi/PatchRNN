commit 3a8266b7cfc7c139247303464d1f9f0eec91d075
Author: Alan T. DeKok <aland@freeradius.org>
Date:   Thu Feb 10 13:35:52 2011 +0100

    Enable udpfromto() for IPv6
    
    On the theory that it will work, or that some magic will get it to work

diff --git a/src/lib/radius.c b/src/lib/radius.c
index 530a6d5f6..4a7f2097a 100644
--- a/src/lib/radius.c
+++ b/src/lib/radius.c
@@ -229,12 +229,10 @@ static int rad_sendto(int sockfd, void *data, size_t data_len, int flags,
 
 #ifdef WITH_UDPFROMTO
 	/*
-	 *	Only IPv4 is supported for udpfromto.
-	 *
 	 *	And if they don't specify a source IP address, don't
 	 *	use udpfromto.
 	 */
-	if ((dst_ipaddr->af == AF_INET) &&
+	if (((dst_ipaddr->af == AF_INET) || (dst_ipaddr->af == AF_INET6)) &&
 	    (src_ipaddr->af != AF_UNSPEC)) {
 		return sendfromto(sockfd, data, data_len, flags,
 				  (struct sockaddr *)&src, sizeof_src,
@@ -245,7 +243,7 @@ static int rad_sendto(int sockfd, void *data, size_t data_len, int flags,
 #endif
 
 	/*
-	 *	No udpfromto, OR an IPv6 socket, fail gracefully.
+	 *	No udpfromto, fail gracefully.
 	 */
 	return sendto(sockfd, data, data_len, flags,
 		      (struct sockaddr *) &dst, sizeof_dst);
@@ -416,14 +414,14 @@ static ssize_t rad_recvfrom(int sockfd, uint8_t **pbuf, int flags,
 	 *	packet after "len" bytes.
 	 */
 #ifdef WITH_UDPFROMTO
-	if (dst.ss_family == AF_INET) {
+	if ((dst.ss_family == AF_INET) || (dst.ss_family == AF_INET6)) {
 		data_len = recvfromto(sockfd, buf, len, flags,
 				      (struct sockaddr *)&src, &sizeof_src,
 				      (struct sockaddr *)&dst, &sizeof_dst);
 	} else
 #endif
 		/*
-		 *	No udpfromto, OR an IPv6 socket.  Fail gracefully.
+		 *	No udpfromto, fail gracefully.
 		 */
 		data_len = recvfrom(sockfd, buf, len, flags,
 				    (struct sockaddr *)&src, &sizeof_src);

