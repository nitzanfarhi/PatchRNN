commit 9b98b6f3e1534bba2efcd5b16318945cf2218d99
Author: Dave Chinner <dchinner@redhat.com>
Date:   Thu May 27 01:58:13 2010 +0000

    xfs: fix might_sleep() warning when initialising per-ag tree
    
    The use of radix_tree_preload() only works if the radix tree was
    initialised without the __GFP_WAIT flag. The per-ag tree uses
    GFP_NOFS, so does not trigger allocation of new tree nodes from the
    preloaded array. Hence it enters the allocator with a spinlock held
    and triggers the might_sleep() warnings.
    
    Reported-by; Chris Mason <chris.mason@oracle.com>
    Signed-off-by: Dave Chinner <dchinner@redhat.com>
    Reviewed-by: Christoph Hellwig <hch@lst.de>
    Signed-off-by: Alex Elder <aelder@sgi.com>

diff --git a/fs/xfs/xfs_mount.c b/fs/xfs/xfs_mount.c
index 2d811e57b332..ef1233b09683 100644
--- a/fs/xfs/xfs_mount.c
+++ b/fs/xfs/xfs_mount.c
@@ -1254,7 +1254,7 @@ xfs_mountfs(
 	 * Allocate and initialize the per-ag data.
 	 */
 	spin_lock_init(&mp->m_perag_lock);
-	INIT_RADIX_TREE(&mp->m_perag_tree, GFP_NOFS);
+	INIT_RADIX_TREE(&mp->m_perag_tree, GFP_ATOMIC);
 	error = xfs_initialize_perag(mp, sbp->sb_agcount, &mp->m_maxagi);
 	if (error) {
 		cmn_err(CE_WARN, "XFS: Failed per-ag init: %d", error);

