commit 28081d5d3384b9e0c887f20815349e81f7a3a93f
Author: Greg Banks <gnb@fastmail.fm>
Date:   Tue Nov 29 14:13:34 2011 +1100

    Less side effects in append_commit() if 0 messages
    
    are being committed - which happens in the XRUNANNOTATOR command.
    In particular, avoid setting the 'last append date' and avoid dirtying
    the cyrus.cache.

diff --git a/imap/append.c b/imap/append.c
index eaeb74083..4d4c27e4b 100644
--- a/imap/append.c
+++ b/imap/append.c
@@ -236,15 +236,17 @@ int append_commit(struct appendstate *as,
     if (num) *num = as->nummsg;
     if (uidvalidity) *uidvalidity = as->mailbox->i.uidvalidity;
 
-    /* Calculate new index header information */
-    as->mailbox->i.last_appenddate = time(0);
+    if (as->nummsg) {
+	/* Calculate new index header information */
+	as->mailbox->i.last_appenddate = time(0);
 
-    /* the cache will be dirty even if we hand added the records */
-    as->mailbox->cache_dirty = 1;
+	/* the cache will be dirty even if we hand added the records */
+	as->mailbox->cache_dirty = 1;
 
-    /* set seen state */
-    if (as->userid[0])
-	append_addseen(as->mailbox, as->userid, as->seen_seq);
+	/* set seen state */
+	if (as->userid[0])
+	    append_addseen(as->mailbox, as->userid, as->seen_seq);
+    }
     seqset_free(as->seen_seq);
     
     /* We want to commit here to guarantee mailbox on disk vs

