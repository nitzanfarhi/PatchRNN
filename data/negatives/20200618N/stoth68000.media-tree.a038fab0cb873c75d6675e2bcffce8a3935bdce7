commit a038fab0cb873c75d6675e2bcffce8a3935bdce7
Author: Yan, Zheng <yanzheng@21cn.com>
Date:   Mon Dec 28 05:01:58 2009 +0000

    Btrfs: align offsets for btrfs_ordered_update_i_size
    
    Some callers of btrfs_ordered_update_i_size can now pass in
    a NULL for the ordered extent to update against.  This makes
    sure we properly align the offset they pass in when deciding
    how much to bump the on disk i_size.
    
    Signed-off-by: Chris Mason <chris.mason@oracle.com>

diff --git a/fs/btrfs/ordered-data.c b/fs/btrfs/ordered-data.c
index b10a49d4bc6a..5c2a9e78a949 100644
--- a/fs/btrfs/ordered-data.c
+++ b/fs/btrfs/ordered-data.c
@@ -626,6 +626,8 @@ int btrfs_ordered_update_i_size(struct inode *inode, u64 offset,
 
 	if (ordered)
 		offset = entry_end(ordered);
+	else
+		offset = ALIGN(offset, BTRFS_I(inode)->root->sectorsize);
 
 	mutex_lock(&tree->mutex);
 	disk_i_size = BTRFS_I(inode)->disk_i_size;

