commit e53289c0c5e5a24e29e571eba7af05c845c10890
Author: Linus Torvalds <torvalds@linux-foundation.org>
Date:   Wed Jan 9 08:36:54 2013 -0800

    mm: reinstante dropped pmd_trans_splitting() check
    
    The check for a pmd being in the process of being split was dropped by
    mistake by commit d10e63f29488 ("mm: numa: Create basic numa page
    hinting infrastructure"). Put it back.
    
    Reported-by: Dave Jones <davej@redhat.com>
    Debugged-by: Hillf Danton <dhillf@gmail.com>
    Acked-by: Andrea Arcangeli <aarcange@redhat.com>
    Acked-by: Mel Gorman <mgorman@suse.de>
    Cc: Kirill Shutemov <kirill@shutemov.name>
    Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>

diff --git a/mm/memory.c b/mm/memory.c
index 49fb1cf08611..bb1369f7b9b4 100644
--- a/mm/memory.c
+++ b/mm/memory.c
@@ -3711,6 +3711,14 @@ int handle_mm_fault(struct mm_struct *mm, struct vm_area_struct *vma,
 		if (pmd_trans_huge(orig_pmd)) {
 			unsigned int dirty = flags & FAULT_FLAG_WRITE;
 
+			/*
+			 * If the pmd is splitting, return and retry the
+			 * the fault.  Alternative: wait until the split
+			 * is done, and goto retry.
+			 */
+			if (pmd_trans_splitting(orig_pmd))
+				return 0;
+
 			if (pmd_numa(orig_pmd))
 				return do_huge_pmd_numa_page(mm, vma, address,
 							     orig_pmd, pmd);

