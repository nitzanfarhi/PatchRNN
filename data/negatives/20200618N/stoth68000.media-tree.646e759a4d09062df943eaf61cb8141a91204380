commit 646e759a4d09062df943eaf61cb8141a91204380
Author: Jaegeuk Kim <jaegeuk@kernel.org>
Date:   Wed Sep 21 09:37:23 2016 -0700

    f2fs: avoid gc in cp_error case
    
    Otherwise, we can hit
            f2fs_bug_on(sbi, !PageUptodate(sum_page));
    
    Reviewed-by: Chao Yu <yuchao0@huawei.com>
    Signed-off-by: Jaegeuk Kim <jaegeuk@kernel.org>

diff --git a/fs/f2fs/gc.c b/fs/f2fs/gc.c
index a9a3c9f19032..b9d6c4250efa 100644
--- a/fs/f2fs/gc.c
+++ b/fs/f2fs/gc.c
@@ -847,7 +847,8 @@ static int do_garbage_collect(struct f2fs_sb_info *sbi,
 
 	for (segno = start_segno; segno < end_segno; segno++) {
 
-		if (get_valid_blocks(sbi, segno, 1) == 0)
+		if (get_valid_blocks(sbi, segno, 1) == 0 ||
+					unlikely(f2fs_cp_error(sbi)))
 			goto next;
 
 		/* find segment summary of victim */

