commit ebbed3ba04ce8e3cd9dff0e86717fb7e3d42db37
Author: Derrick Stolee <dstolee@microsoft.com>
Date:   Sat Feb 24 20:34:56 2018 -0500

    revision.c: reduce object database queries
    
    In mark_parents_uninteresting(), we check for the existence of an
    object file to see if we should treat a commit as parsed. The result
    is to set the "parsed" bit on the commit.
    
    Modify the condition to only check has_object_file() if the result
    would change the parsed bit.
    
    When a local branch is different from its upstream ref, "git status"
    will compute ahead/behind counts. This uses paint_down_to_common()
    and hits mark_parents_uninteresting(). On a copy of the Linux repo
    with a local instance of "master" behind the remote branch
    "origin/master" by ~60,000 commits, we find the performance of
    "git status" went from 1.42 seconds to 1.32 seconds, for a relative
    difference of -7.0%.
    
    Signed-off-by: Derrick Stolee <dstolee@microsoft.com>
    Reviewed-by: Jeff King <peff@peff.net>
    Signed-off-by: Junio C Hamano <gitster@pobox.com>

diff --git a/revision.c b/revision.c
index 771d079f6..29f82ccfe 100644
--- a/revision.c
+++ b/revision.c
@@ -110,7 +110,8 @@ void mark_parents_uninteresting(struct commit *commit)
 			 * it is popped next time around, we won't be trying
 			 * to parse it and get an error.
 			 */
-			if (!has_object_file(&commit->object.oid))
+			if (!commit->object.parsed &&
+			    !has_object_file(&commit->object.oid))
 				commit->object.parsed = 1;
 
 			if (commit->object.flags & UNINTERESTING)

