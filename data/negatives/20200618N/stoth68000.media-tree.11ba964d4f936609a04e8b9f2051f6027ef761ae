commit 11ba964d4f936609a04e8b9f2051f6027ef761ae
Author: Johannes Berg <johannes@sipsolutions.net>
Date:   Wed Aug 19 19:45:50 2009 +0200

    mac80211: fix register_hw error path
    
    "cfg80211: fix alignment problem in scan request"
    introduced a bug into the error path, because now
    we allocate the entire scan request and not just
    the channel list (the channel list is allocated
    together with the scan request) -- on errors we
    thus also need to free the entire scan request.
    
    Signed-off-by: Johannes Berg <johannes@sipsolutions.net>
    Signed-off-by: John W. Linville <linville@tuxdriver.com>

diff --git a/net/mac80211/main.c b/net/mac80211/main.c
index f80efd7ff5ec..dd3b0816614d 100644
--- a/net/mac80211/main.c
+++ b/net/mac80211/main.c
@@ -930,7 +930,7 @@ int ieee80211_register_hw(struct ieee80211_hw *hw)
  fail_workqueue:
 	wiphy_unregister(local->hw.wiphy);
  fail_wiphy_register:
-	kfree(local->int_scan_req->channels);
+	kfree(local->int_scan_req);
 	return result;
 }
 EXPORT_SYMBOL(ieee80211_register_hw);

