commit 2b1c6b464a50ed7987991ab55db8e50ffa87269d
Author: Mikkel Krautz <mikkel@krautz.dk>
Date:   Sat Nov 5 17:23:28 2016 +0100

    ServerHandler: implement ServerHandler logic for 'net/udpforcetcpaddr'.

diff --git a/src/mumble/ServerHandler.cpp b/src/mumble/ServerHandler.cpp
index 8a10de23..eab1f01b 100644
--- a/src/mumble/ServerHandler.cpp
+++ b/src/mumble/ServerHandler.cpp
@@ -600,12 +600,21 @@ void ServerHandler::serverConnectionConnected() {
 		QMutexLocker qml(&qmUdp);
 
 		qhaRemote = connection->peerAddress();
+		qhaLocal = connection->localAddress();
+		if (qhaLocal.isNull()) {
+			qFatal("ServerHandler: qhaLocal is unexpectedly a null addr");
+		}
 
 		qusUdp = new QUdpSocket(this);
-		if (qhaRemote.protocol() == QAbstractSocket::IPv6Protocol)
-			qusUdp->bind(QHostAddress(QHostAddress::AnyIPv6), 0);
-		else
-			qusUdp->bind(QHostAddress(QHostAddress::Any), 0);
+		if (g.s.bUdpForceTcpAddr) {
+			qusUdp->bind(qhaLocal);
+		} else {
+			if (qhaRemote.protocol() == QAbstractSocket::IPv6Protocol) {
+				qusUdp->bind(QHostAddress(QHostAddress::AnyIPv6), 0);
+			} else {
+				qusUdp->bind(QHostAddress(QHostAddress::Any), 0);
+			}
+		}
 
 		connect(qusUdp, SIGNAL(readyRead()), this, SLOT(udpReady()));
 
diff --git a/src/mumble/ServerHandler.h b/src/mumble/ServerHandler.h
index 5da8ca42..cd7e620f 100644
--- a/src/mumble/ServerHandler.h
+++ b/src/mumble/ServerHandler.h
@@ -67,6 +67,7 @@ class ServerHandler : public QThread {
 #endif
 
 		QHostAddress qhaRemote;
+		QHostAddress qhaLocal;
 		QUdpSocket *qusUdp;
 		QMutex qmUdp;
 

