commit cdf4b3fa03bab157d2d70d4de65bb7ae319b084f
Author: Xunlei Pang <xlpang@redhat.com>
Date:   Wed Jan 20 15:00:31 2016 -0800

    kexec: set KEXEC_TYPE_CRASH before sanity_check_segment_list()
    
    sanity_check_segment_list() checks KEXEC_TYPE_CRASH flag to ensure all the
    segments of the loaded crash kernel are within the kernel crash resource
    limits, so set the flag beforehand.
    
    Signed-off-by: Xunlei Pang <xlpang@redhat.com>
    Acked-by: Dave Young <dyoung@redhat.com>
    Cc: Eric Biederman <ebiederm@xmission.com>
    Cc: Vivek Goyal <vgoyal@redhat.com>
    Acked-by: Baoquan He <bhe@redhat.com>
    Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
    Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>

diff --git a/kernel/kexec.c b/kernel/kexec.c
index d873b64fbddc..ee70aef5cd81 100644
--- a/kernel/kexec.c
+++ b/kernel/kexec.c
@@ -63,16 +63,16 @@ static int kimage_alloc_init(struct kimage **rimage, unsigned long entry,
 	if (ret)
 		goto out_free_image;
 
-	ret = sanity_check_segment_list(image);
-	if (ret)
-		goto out_free_image;
-
-	 /* Enable the special crash kernel control page allocation policy. */
 	if (kexec_on_panic) {
+		/* Enable special crash kernel control page alloc policy. */
 		image->control_page = crashk_res.start;
 		image->type = KEXEC_TYPE_CRASH;
 	}
 
+	ret = sanity_check_segment_list(image);
+	if (ret)
+		goto out_free_image;
+
 	/*
 	 * Find a location for the control code buffer, and add it
 	 * the vector of segments so that it's pages will also be

