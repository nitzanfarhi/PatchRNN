commit e099ad4b7e9ca7debdd624a0d465a33198a6844f
Author: Gerd Hoffmann <kraxel@redhat.com>
Date:   Wed Oct 24 09:38:08 2012 +0200

    xhci: allow disabling interrupters
    
    For secondary interrupters this is explicitly allowed in the specs.
    For the primary interrupter behavior is undefined, lets be friendly
    and allow disabling too.
    
    Signed-off-by: Gerd Hoffmann <kraxel@redhat.com>

diff --git a/hw/usb/hcd-xhci.c b/hw/usb/hcd-xhci.c
index d8d1226a5b..bd8d4a5b39 100644
--- a/hw/usb/hcd-xhci.c
+++ b/hw/usb/hcd-xhci.c
@@ -964,6 +964,12 @@ static void xhci_er_reset(XHCIState *xhci, int v)
     XHCIInterrupter *intr = &xhci->intr[v];
     XHCIEvRingSeg seg;
 
+    if (intr->erstsz == 0) {
+        /* disabled */
+        intr->er_start = 0;
+        intr->er_size = 0;
+        return;
+    }
     /* cache the (sole) event ring segment location */
     if (intr->erstsz != 1) {
         fprintf(stderr, "xhci: invalid value for ERSTSZ: %d\n", intr->erstsz);

