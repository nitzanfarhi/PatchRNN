commit ec1fcd7b7e6f50dd6e259ca76c6e41e2346b3afe
Author: Enric Balletbo i Serra <enric.balletbo@collabora.com>
Date:   Thu Mar 1 16:25:10 2018 +0100

    phy: rockchip-typec: fall back to working in host-mode if extcon is missing.
    
    Right now the rockchip type-c phy does fail probing when no extcon is
    detected. Some boards get the cable-state via the extcon interface and
    have this supported, other boards seem to use the fusb302 chip or
    another but the driver currently does not seem to utilize the extcon
    interface to report the cable-state. And, other, just connect the type-c
    to a standard USB-A port so use no controller at all. A missing extcon
    shouldn't fail to probe, instead, should just fall back to working in
    host-mode if it cannot get the extcon.
    
    Fixes: c301b327aea898af ("arm64: dts: rockchip: add usb3-phy otg-port support for rk3399")
    Reported-by: Vicente Bergas <vicencb@gmail.com>
    Signed-off-by: Enric Balletbo i Serra <enric.balletbo@collabora.com>
    Reviewed-by: Heiko Stuebner <heiko@sntech.de>
    Signed-off-by: Kishon Vijay Abraham I <kishon@ti.com>

diff --git a/drivers/phy/rockchip/phy-rockchip-typec.c b/drivers/phy/rockchip/phy-rockchip-typec.c
index 1c79785a5439..76a4b58ec771 100644
--- a/drivers/phy/rockchip/phy-rockchip-typec.c
+++ b/drivers/phy/rockchip/phy-rockchip-typec.c
@@ -821,6 +821,9 @@ static int tcphy_get_mode(struct rockchip_typec_phy *tcphy)
 	u8 mode;
 	int ret;
 
+	if (!edev)
+		return MODE_DFP_USB;
+
 	ufp = extcon_get_state(edev, EXTCON_USB);
 	dp = extcon_get_state(edev, EXTCON_DISP_DP);
 
@@ -1159,9 +1162,13 @@ static int rockchip_typec_phy_probe(struct platform_device *pdev)
 
 	tcphy->extcon = extcon_get_edev_by_phandle(dev, 0);
 	if (IS_ERR(tcphy->extcon)) {
-		if (PTR_ERR(tcphy->extcon) != -EPROBE_DEFER)
-			dev_err(dev, "Invalid or missing extcon\n");
-		return PTR_ERR(tcphy->extcon);
+		if (PTR_ERR(tcphy->extcon) == -ENODEV) {
+			tcphy->extcon = NULL;
+		} else {
+			if (PTR_ERR(tcphy->extcon) != -EPROBE_DEFER)
+				dev_err(dev, "Invalid or missing extcon\n");
+			return PTR_ERR(tcphy->extcon);
+		}
 	}
 
 	pm_runtime_enable(dev);

