commit f081cca12ebdfb47425ab8d018da3903812b51a1
Author: Timo Sirainen <tss@iki.fi>
Date:   Sat Jul 28 20:31:13 2012 +0300

    lib-storage: When copying a mail, use a new timestamp for date.save instead of preserving it.

diff --git a/src/lib-storage/index/index-storage.c b/src/lib-storage/index/index-storage.c
index fabc97f73..a3e51b79f 100644
--- a/src/lib-storage/index/index-storage.c
+++ b/src/lib-storage/index/index-storage.c
@@ -625,6 +625,7 @@ mail_copy_cache_field(struct mail_save_context *ctx, struct mail *src_mail,
 	struct mailbox_transaction_context *dest_trans = ctx->transaction;
 	const struct mail_cache_field *dest_field;
 	unsigned int src_field_idx, dest_field_idx;
+	uint32_t t;
 
 	src_field_idx = mail_cache_register_lookup(src_mail->box->cache, name);
 	i_assert(src_field_idx != -1U);
@@ -643,8 +644,16 @@ mail_copy_cache_field(struct mail_save_context *ctx, struct mail *src_mail,
 	}
 
 	buffer_set_used_size(buf, 0);
-	if (mail_cache_lookup_field(src_mail->transaction->cache_view, buf,
-				    src_mail->seq, src_field_idx) > 0) {
+	if (strcmp(name, "date.save") == 0) {
+		/* save date must update when mail is copied */
+		t = ioloop_time;
+		buffer_append(buf, &t, sizeof(t));
+	} else {
+		if (mail_cache_lookup_field(src_mail->transaction->cache_view, buf,
+					    src_mail->seq, src_field_idx) <= 0)
+			buffer_set_used_size(buf, 0);
+	}
+	if (buf->used > 0) {
 		mail_cache_add(dest_trans->cache_trans, dest_seq,
 			       dest_field_idx, buf->data, buf->used);
 	}

