commit 7d8d00140715a115193bf502fa3b0cfe620f0dd9
Author: Omar Sandoval <osandov@fb.com>
Date:   Thu Mar 16 09:46:14 2017 -0600

    blk-stat: fix blk_stat_sum() if all samples are batched
    
    We need to flush the batch _before_ we check the number of samples,
    otherwise we'll miss all of the batched samples.
    
    Fixes: cf43e6b ("block: add scalable completion tracking of requests")
    Signed-off-by: Omar Sandoval <osandov@fb.com>
    Signed-off-by: Jens Axboe <axboe@fb.com>

diff --git a/block/blk-stat.c b/block/blk-stat.c
index 9b43efb8933f..186fcb981e9b 100644
--- a/block/blk-stat.c
+++ b/block/blk-stat.c
@@ -30,11 +30,11 @@ static void blk_stat_flush_batch(struct blk_rq_stat *stat)
 
 static void blk_stat_sum(struct blk_rq_stat *dst, struct blk_rq_stat *src)
 {
+	blk_stat_flush_batch(src);
+
 	if (!src->nr_samples)
 		return;
 
-	blk_stat_flush_batch(src);
-
 	dst->min = min(dst->min, src->min);
 	dst->max = max(dst->max, src->max);
 

