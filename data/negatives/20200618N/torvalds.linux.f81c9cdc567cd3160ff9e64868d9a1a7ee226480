commit f81c9cdc567cd3160ff9e64868d9a1a7ee226480
Author: Sage Weil <sage@newdream.net>
Date:   Wed Aug 10 18:04:04 2011 +0000

    Btrfs: truncate pages from clone ioctl target range
    
    We need to truncate page cache pages for the clone ioctl target range or
    else we'll confuse ourselves to no end.  If the old data was cached, we
    used to still see it (until remount).  If the page was partially updated
    we used to get a mix of old and new data.
    
    Signed-off-by: Sage Weil <sage@newdream.net>
    Signed-off-by: Chris Mason <chris.mason@oracle.com>

diff --git a/fs/btrfs/ioctl.c b/fs/btrfs/ioctl.c
index 2bb08862a4f6..b3d249d6eba7 100644
--- a/fs/btrfs/ioctl.c
+++ b/fs/btrfs/ioctl.c
@@ -2244,6 +2244,10 @@ static noinline long btrfs_ioctl_clone(struct file *file, unsigned long srcfd,
 		btrfs_wait_ordered_range(src, off, len);
 	}
 
+	/* truncate page cache pages from target inode range */
+	truncate_inode_pages_range(&inode->i_data, off,
+				   ALIGN(off + len, PAGE_CACHE_SIZE) - 1);
+
 	/* clone data */
 	key.objectid = btrfs_ino(src);
 	key.type = BTRFS_EXTENT_DATA_KEY;

