commit 7a12f459896ae1acf1d826d90b33ecff6f4508c2
Author: Frank Rowand <frank.rowand@sony.com>
Date:   Wed Jun 21 12:21:56 2017 -0700

    of: detect invalid phandle in overlay
    
    Overlays are not allowed to modify phandle values of previously existing
    nodes because there is no information available to allow fixup up
    properties that use the previously existing phandle.
    
    Signed-off-by: Frank Rowand <frank.rowand@sony.com>
    Signed-off-by: Rob Herring <robh@kernel.org>

diff --git a/drivers/of/overlay.c b/drivers/of/overlay.c
index 7827786718d8..c0e4ee1cd1ba 100644
--- a/drivers/of/overlay.c
+++ b/drivers/of/overlay.c
@@ -132,6 +132,10 @@ static int of_overlay_apply_single_device_node(struct of_overlay *ov,
 	/* NOTE: Multiple mods of created nodes not supported */
 	tchild = of_get_child_by_name(target, cname);
 	if (tchild != NULL) {
+		/* new overlay phandle value conflicts with existing value */
+		if (child->phandle)
+			return -EINVAL;
+
 		/* apply overlay recursively */
 		ret = of_overlay_apply_one(ov, tchild, child);
 		of_node_put(tchild);

