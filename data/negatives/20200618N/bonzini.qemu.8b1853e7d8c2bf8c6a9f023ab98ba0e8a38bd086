commit 8b1853e7d8c2bf8c6a9f023ab98ba0e8a38bd086
Author: David Gibson <david@gibson.dropbear.id.au>
Date:   Mon Dec 3 16:42:13 2012 +0000

    pseries: Don't allow TCE (iommu) tables to be registered with duplicate LIOBNs
    
    The PAPR specification requires that every bus or device mediated by the
    IOMMU have a unique Logical IO Bus Number (LIOBN).  This patch adds a check
    to enforce this, which will help catch errors in configuration earlier.
    
    Signed-off-by: David Gibson <david@gibson.dropbear.id.au>
    Signed-off-by: Alexander Graf <agraf@suse.de>

diff --git a/hw/spapr_iommu.c b/hw/spapr_iommu.c
index 02d78ccf28..3011b251d3 100644
--- a/hw/spapr_iommu.c
+++ b/hw/spapr_iommu.c
@@ -120,6 +120,12 @@ DMAContext *spapr_tce_new_dma_context(uint32_t liobn, size_t window_size)
 {
     sPAPRTCETable *tcet;
 
+    if (spapr_tce_find_by_liobn(liobn)) {
+        fprintf(stderr, "Attempted to create TCE table with duplicate"
+                " LIOBN 0x%x\n", liobn);
+        return NULL;
+    }
+
     if (!window_size) {
         return NULL;
     }

