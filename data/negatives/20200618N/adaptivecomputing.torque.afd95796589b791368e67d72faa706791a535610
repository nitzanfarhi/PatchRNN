commit afd95796589b791368e67d72faa706791a535610
Author: dbeer <dbeer@8f940c70-5916-0410-ac46-d1fa2fa6ea29>
Date:   Tue Nov 9 23:52:56 2010 +0000

    Small modification to the allocation of gpu subnodes. This time, only that code

diff --git a/src/server/node_func.c b/src/server/node_func.c
index 1a17b5260..602aeedd8 100644
--- a/src/server/node_func.c
+++ b/src/server/node_func.c
@@ -1558,10 +1558,7 @@ int create_a_gpusubnode(
   static char *id = "create_a_gpusubnode";
   struct gpusubn *tmp;
  
-  if (pnode->nd_ngpus > 0)
-    tmp = realloc(pnode->nd_gpusn,sizeof(struct gpusubn) * (1 + pnode->nd_ngpus));
-  else
-    tmp = malloc(sizeof(struct gpusubn));
+  tmp = malloc(sizeof(struct gpusubn) * (1 + pnode->nd_ngpus));
 
   if (tmp == NULL)
     {
@@ -1569,10 +1566,20 @@ int create_a_gpusubnode(
     return(ENOMEM);
     }
 
+  if (pnode->nd_ngpus > 0)
+    {
+    /* copy old memory to the new place */
+    memcpy(tmp,pnode->nd_gpusn,(sizeof(struct gpusubn) * pnode->nd_ngpus));
+    }
+
+  /* now use the new memory */
+  free(pnode->nd_gpusn);
   pnode->nd_gpusn = tmp;
 
   /* initialize the node */
-  memset(pnode->nd_gpusn + pnode->nd_ngpus,0,sizeof(struct gpusubn));
+  pnode->nd_gpusn[pnode->nd_ngpus].pjob = NULL;
+  pnode->nd_gpusn[pnode->nd_ngpus].inuse = FALSE;
+  pnode->nd_gpusn[pnode->nd_ngpus].flag = 0;
   pnode->nd_gpusn[pnode->nd_ngpus].index = pnode->nd_ngpus;
 
   /* increment the number of gpu subnodes and gpus free */

