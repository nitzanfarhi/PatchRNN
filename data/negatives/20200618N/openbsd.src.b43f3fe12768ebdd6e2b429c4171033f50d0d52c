commit b43f3fe12768ebdd6e2b429c4171033f50d0d52c
Author: nicm <nicm@openbsd.org>
Date:   Mon Mar 25 11:42:19 2013 +0000

    Handle empty pending output (not a failure) and add \n. From George
    Nachman.

diff --git a/usr.bin/tmux/cmd-capture-pane.c b/usr.bin/tmux/cmd-capture-pane.c
index 8234d8f332a..20d934367ac 100644
--- a/usr.bin/tmux/cmd-capture-pane.c
+++ b/usr.bin/tmux/cmd-capture-pane.c
@@ -1,4 +1,4 @@
-/* $OpenBSD: cmd-capture-pane.c,v 1.23 2013/03/25 11:38:15 nicm Exp $ */
+/* $OpenBSD: cmd-capture-pane.c,v 1.24 2013/03/25 11:42:19 nicm Exp $ */
 
 /*
  * Copyright (c) 2009 Jonathan Alvarado <radobobo@users.sourceforge.net>
@@ -69,7 +69,7 @@ cmd_capture_pane_pending(struct args *args, struct window_pane *wp,
 	line = EVBUFFER_DATA(wp->ictx.since_ground);
 	linelen = EVBUFFER_LENGTH(wp->ictx.since_ground);
 
-	buf = NULL;
+	buf = xstrdup("");
 	if (args_has(args, 'C')) {
 		for (i = 0; i < linelen; i++) {
 			if (line[i] >= ' ') {
@@ -189,6 +189,8 @@ cmd_capture_pane_exec(struct cmd *self, struct cmd_q *cmdq)
 			return (CMD_RETURN_ERROR);
 		}
 		evbuffer_add(c->stdout_data, buf, len);
+		if (args_has(args, 'P') && len > 0)
+		    evbuffer_add(c->stdout_data, "\n", 1);
 		server_push_stdout(c);
 	} else {
 		limit = options_get_number(&global_options, "buffer-limit");

