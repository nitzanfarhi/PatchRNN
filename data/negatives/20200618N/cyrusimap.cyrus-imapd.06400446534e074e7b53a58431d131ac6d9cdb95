commit 06400446534e074e7b53a58431d131ac6d9cdb95
Author: Bron Gondwana <brong@fastmail.fm>
Date:   Wed Jan 20 04:41:02 2016 +1100

    jmap: calculate thread exists and uncounts in getMailboxes

diff --git a/imap/http_jmap.c b/imap/http_jmap.c
index 671ab92b4..1d2be18c0 100644
--- a/imap/http_jmap.c
+++ b/imap/http_jmap.c
@@ -898,13 +898,19 @@ static json_t *jmap_mailbox_from_mbox(struct mailbox *mbox,
     if (_wantprop(props, "unreadMessages")) {
         json_object_set_new(obj, "unreadMessages", json_integer(sdata.unseen));
     }
-    if (_wantprop(props, "totalThreads")) {
-        /* XXX */
-        json_object_set_new(obj, "totalThreads", json_integer(0));
-    }
-    if (_wantprop(props, "unreadThreads")) {
-        /* XXX */
-        json_object_set_new(obj, "unreadThreads", json_integer(0));
+    if (_wantprop(props, "totalThreads") || _wantprop(props, "unreadThreads")) {
+        /* we're always subfolders of INBOX, and we locked above, so this works */
+        conv_status_t xconv = CONV_STATUS_INIT;
+        conversation_getstatus(inbox->local_cstate, mbox->name, &xconv);
+
+        if (_wantprop(props, "totalThreads")) {
+            /* XXX */
+            json_object_set_new(obj, "totalThreads", json_integer(xconv.exists));
+        }
+        if (_wantprop(props, "unreadThreads")) {
+            /* XXX */
+            json_object_set_new(obj, "unreadThreads", json_integer(xconv.unseen));
+        }
     }
     if (_wantprop(props, "mayRename")) {
         int mayRename = rights & ACL_DELETEMBOX && parent_rights & ACL_CREATE;

