commit 14d4f5ec7f3c83c9d13b225d2e42937dcf0c298f
Author: jmagne <jmagne@c9f7a03b-bd48-0410-a16d-cbbf54688b0b>
Date:   Sat Jan 24 01:01:13 2009 +0000

    Fix for bug#459538, tks support 330j cards.
    
    git-svn-id: svn+ssh://svn.fedorahosted.org/svn/pki/trunk@184 c9f7a03b-bd48-0410-a16d-cbbf54688b0b

diff --git a/pki/base/symkey/src/com/netscape/symkey/EncryptData.cpp b/pki/base/symkey/src/com/netscape/symkey/EncryptData.cpp
index fd037ce67..ff9e91df0 100644
--- a/pki/base/symkey/src/com/netscape/symkey/EncryptData.cpp
+++ b/pki/base/symkey/src/com/netscape/symkey/EncryptData.cpp
@@ -180,7 +180,9 @@ Java_com_netscape_symkey_SessionKey_EncryptData(JNIEnv * env, jclass this2, jstr
     }
 
     PK11SymKey *masterKey = NULL;
-    if (keyVersion[0] == 0x1 && keyVersion[1]== 0x1 &&strcmp( keyname, "#01#01") == 0)
+
+    if (keyVersion[0] == 0x1 && keyVersion[1]== 0x1 &&strcmp( keyname, "#01#01") == 0 ||
+        (keyVersion[0] == -1  && strstr(keyname, "#FF") ))
     {
         /* default development keyset */
         status = EncryptData(kek_buffer, cc, cc_len, out);
diff --git a/pki/base/symkey/src/com/netscape/symkey/SessionKey.cpp b/pki/base/symkey/src/com/netscape/symkey/SessionKey.cpp
index e4a02113d..19a3ba318 100644
--- a/pki/base/symkey/src/com/netscape/symkey/SessionKey.cpp
+++ b/pki/base/symkey/src/com/netscape/symkey/SessionKey.cpp
@@ -625,7 +625,11 @@ extern "C" JNIEXPORT jbyteArray JNICALL Java_com_netscape_symkey_SessionKey_Comp
     }else
     GetKeyName(keyVersion,keyname);
 
-    if (keyVersion[0] == 0x1 && keyVersion[1]== 0x1 &&strcmp( keyname, "#01#01") == 0)
+
+
+    if (keyVersion[0] == 0x1 && keyVersion[1]== 0x1 && strcmp( keyname, "#01#01") == 0 ||
+        (keyVersion[0] == -1 && strstr(keyname, "#FF")))
+     
     {
 
         /* default manufacturers key */
@@ -780,8 +784,8 @@ extern "C" JNIEXPORT jbyteArray JNICALL Java_com_netscape_symkey_SessionKey_Comp
         GetKeyName(keyVersion,keyname);
     }
 
-    if (keyVersion[0] == 0x1 && keyVersion[1]== 0x1 &&
-        strcmp( keyname, "#01#01") == 0)
+    if (keyVersion[0] == 0x1 && keyVersion[1]== 0x1 &&strcmp( keyname, "#01#01") == 0 ||
+        (keyVersion[0] == -1 && strstr(keyname, "#FF")))
     {
         /* default manufacturers key */
         symkey = DeriveKey(                       //Util::DeriveKey(
@@ -926,7 +930,8 @@ extern "C" JNIEXPORT jobject JNICALL Java_com_netscape_symkey_SessionKey_Compute
         GetKeyName(keyVersion,keyname);
     }
 
-    if (keyVersion[0] == 0x1 && keyVersion[1]== 0x1 &&strcmp( keyname, "#01#01") == 0)
+    if (keyVersion[0] == 0x1 && keyVersion[1]== 0x1 &&strcmp( keyname, "#01#01") == 0 ||
+        (keyVersion[0] == -1 && strstr(keyname, "#FF")))
     {
         /* default manufacturers key */
         symkey = DeriveKey(                       //Util::DeriveKey(
@@ -1059,8 +1064,8 @@ extern "C" JNIEXPORT jobject JNICALL Java_com_netscape_symkey_SessionKey_Compute
     }else
     GetKeyName(keyVersion,keyname);
 
-    if (keyVersion[0] == 0x1 && keyVersion[1]== 0x1 &&
-        strcmp( keyname, "#01#01") == 0)
+    if (keyVersion[0] == 0x1 && keyVersion[1]== 0x1 &&strcmp( keyname, "#01#01") == 0 ||
+        (keyVersion[0] == -1 && strcmp(keyname, "#FF")))
     {
         /* default manufacturers key */
         if (debug_fd)
@@ -1353,8 +1358,8 @@ extern "C" JNIEXPORT jbyteArray JNICALL Java_com_netscape_symkey_SessionKey_Comp
     }else
     GetKeyName(keyVersion,keyname);
 
-    if (keyVersion[0] == 0x1 && keyVersion[1]== 0x1 &&
-        strcmp( keyname, "#01#01") == 0)
+    if (keyVersion[0] == 0x1 && keyVersion[1]== 0x1 &&strcmp( keyname, "#01#01") == 0 ||
+        (keyVersion[0] == -1 && strstr(keyname, "#FF")))
     {
         /* default manufacturers key */
         symkey = DeriveKey(                       //Util::DeriveKey(

