commit 5988bed825745f200170b6306efcec78b0185905
Author: Isaac Connor <iconnor@tesla.com>
Date:   Wed May 2 12:21:01 2018 -0700

    make encodeloop return frame_size to indicate error so that we can bail

diff --git a/src/zm_video.cpp b/src/zm_video.cpp
index e44f4ce74..22379f2b3 100644
--- a/src/zm_video.cpp
+++ b/src/zm_video.cpp
@@ -217,7 +217,8 @@ int X264MP4Writer::Close() {
   /* Flush all pending frames */
   for ( int i = (x264_encoder_delayed_frames(x264enc) + 1); i > 0; i-- ) {
 Debug(1,"Encoding delayed frame");
-    x264encodeloop(true);
+    if ( x264encodeloop(true) < 0 )
+      break;
   }
 
   /* Close the encoder */
@@ -408,7 +409,7 @@ int X264MP4Writer::x264config() {
   return 0;
 }
 
-void X264MP4Writer::x264encodeloop(bool bFlush) {
+int X264MP4Writer::x264encodeloop(bool bFlush) {
   x264_nal_t* nals;
   int i_nals;
   int frame_size;
@@ -502,6 +503,7 @@ void X264MP4Writer::x264encodeloop(bool bFlush) {
   } else {
     Error("x264 encode failed: %d", frame_size);
   }
+  return frame_size;
 }
 #endif  // ZM_VIDEOWRITER_X264MP4
 
diff --git a/src/zm_video.h b/src/zm_video.h
index 2b71f12df..46d7c3635 100644
--- a/src/zm_video.h
+++ b/src/zm_video.h
@@ -146,7 +146,7 @@ protected:
 
 	/* Internal functions */
 	int x264config();
-	void x264encodeloop(bool bFlush = false);
+	int x264encodeloop(bool bFlush = false);
 
 	/* x264 objects */
 	x264_t* x264enc;

