commit 64b6c1528f2453ddda3a286e159c60e6805ac8dc
Author: fgsch <fgsch@openbsd.org>
Date:   Sat Oct 31 01:13:00 2009 +0000

    Make sure the descriptor is writable for some operations.
    Pointed out and ok by miod@.

diff --git a/sys/dev/isa/spkr.c b/sys/dev/isa/spkr.c
index 0fdd7ee0de7..51857ccc796 100644
--- a/sys/dev/isa/spkr.c
+++ b/sys/dev/isa/spkr.c
@@ -1,4 +1,4 @@
-/*	$OpenBSD: spkr.c,v 1.10 2006/03/09 22:35:23 miod Exp $	*/
+/*	$OpenBSD: spkr.c,v 1.11 2009/10/31 01:13:00 fgsch Exp $	*/
 /*	$NetBSD: spkr.c,v 1.1 1998/04/15 20:26:18 drochner Exp $	*/
 
 /*
@@ -53,6 +53,7 @@
 #include <sys/proc.h>
 #include <sys/ioctl.h>
 #include <sys/conf.h>
+#include <sys/file.h>
 
 #include <dev/isa/pcppivar.h>
 
@@ -499,6 +500,15 @@ spkrioctl(dev, cmd, data, flag, p)
 	if (minor(dev) != 0)
 		return (ENXIO);
 
+	switch (cmd) {
+	case SPKRTONE:
+	case SPKRTUNE:
+		if ((flag & FWRITE) == 0)
+			return (EACCES);
+	default:
+		break;
+	}
+
 	switch (cmd) {
 	case SPKRTONE:
 		tp = (tone_t *)data;

