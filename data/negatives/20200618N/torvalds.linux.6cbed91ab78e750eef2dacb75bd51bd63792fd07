commit 6cbed91ab78e750eef2dacb75bd51bd63792fd07
Author: Frank Pavlic <fpavlic@de.ibm.com>
Date:   Tue Jul 17 13:36:04 2007 +0200

    [S390] qdio: output queue stall on FCP and network devices
    
    When running QIOASSIST enabled qdio devices in a z/VM environment
    the output queue for such devices stall in heavy workload situations.
    When SQBS and EQBS instructions returns CCQ=96 qdio does not reissue
    the instruction again with the register settings done by millicode
    but processed the returned qdio buffer. This is wrong. qdio has to
    reissue the instruction once again on CCQ=96, as we already do it
    for CCQ=97.
    
    Signed-off-by: Frank Pavlic <fpavlic@de.ibm.com>
    Signed-off-by: Martin Schwidefsky <schwidefsky@de.ibm.com>

diff --git a/drivers/s390/cio/qdio.c b/drivers/s390/cio/qdio.c
index e70aeb7a3781..ae437322c9ca 100644
--- a/drivers/s390/cio/qdio.c
+++ b/drivers/s390/cio/qdio.c
@@ -166,9 +166,9 @@ qdio_check_ccq(struct qdio_q *q, unsigned int ccq)
 {
 	char dbf_text[15];
 
-	if (ccq == 0 || ccq == 32 || ccq == 96)
+	if (ccq == 0 || ccq == 32)
 		return 0;
-	if (ccq == 97)
+	if (ccq == 96 || ccq == 97)
 		return 1;
 	/*notify devices immediately*/
 	sprintf(dbf_text,"%d", ccq);

