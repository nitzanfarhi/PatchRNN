commit da653f208884f4f5da5b9daa9d5de0cdc009e843
Author: Timo Sirainen <timo.sirainen@dovecot.fi>
Date:   Fri May 13 09:48:13 2016 -0400

    lib-fs: If fs-metawrap sees truncated header, it should return error.

diff --git a/src/lib-fs/istream-metawrap.c b/src/lib-fs/istream-metawrap.c
index c389432d7..c86973627 100644
--- a/src/lib-fs/istream-metawrap.c
+++ b/src/lib-fs/istream-metawrap.c
@@ -33,8 +33,15 @@ static int metadata_header_read(struct metawrap_istream *mstream)
 		mstream->callback(line, p, mstream->context);
 	}
 	if (mstream->istream.parent->eof) {
-		mstream->istream.istream.stream_errno =
-			mstream->istream.parent->stream_errno;
+		if (mstream->istream.parent->stream_errno != 0) {
+			mstream->istream.istream.stream_errno =
+				mstream->istream.parent->stream_errno;
+		} else {
+			io_stream_set_error(&mstream->istream.iostream,
+				"Metadata header is missing ending line");
+			mstream->istream.istream.stream_errno = EINVAL;
+			return -1;
+		}
 		mstream->istream.istream.eof = TRUE;
 		return -1;
 	}

