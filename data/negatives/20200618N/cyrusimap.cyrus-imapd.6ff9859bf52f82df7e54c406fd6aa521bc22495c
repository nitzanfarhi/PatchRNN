commit 6ff9859bf52f82df7e54c406fd6aa521bc22495c
Author: Bron Gondwana <brong@fastmail.fm>
Date:   Mon Jan 27 21:48:58 2014 +1100

    annotate check for bogus entries

diff --git a/imap/annotate.c b/imap/annotate.c
index 6053898f1..8966a0dfe 100644
--- a/imap/annotate.c
+++ b/imap/annotate.c
@@ -944,6 +944,8 @@ static int find_cb(void *rock, const char *key, size_t keylen,
     struct find_rock *frock = (struct find_rock *) rock;
     const char *mboxname, *entry, *userid;
     unsigned int uid;
+    char newkey[MAX_MAILBOX_NAME+1];
+    size_t newkeylen;
     struct buf value = BUF_INITIALIZER;
     int r;
 
@@ -959,6 +961,11 @@ static int find_cb(void *rock, const char *key, size_t keylen,
     if (r)
 	return r;
 
+    newkeylen = make_key(mboxname, uid, entry, userid, newkey, sizeof(newkey));
+    if (keylen != newkeylen || strncmp(newkey, key, keylen)) {
+	syslog(LOG_ERR, "find_cb: bogus key %d %s %s", uid, entry, userid);
+    }
+
     r = split_attribs(data, datalen, &value);
 
     if (!r) r = frock->proc(mboxname, uid, entry, userid, &value, frock->rock);

