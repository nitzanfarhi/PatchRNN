commit e3f5a5f27153228569f3396049838e9727dae86e
Author: Kay Sievers <kay@vrfy.org>
Date:   Fri Jul 6 09:50:09 2012 -0700

    kmsg: escape the backslash character while exporting data
    
    Non-printable characters in the log data are hex-escaped to ensure safe
    post processing. We need to escape a backslash we find in the data, to be
    able to distinguish it from a backslash we add for the escaping.
    
    Also escape the non-printable character 127.
    
    Thanks to Miloslav Trmac for the heads up.
    
    Reported-by: Michael Neuling <mikey@neuling.org>
    Signed-off-by: Kay Sievers <kay@vrfy.org>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

diff --git a/kernel/printk.c b/kernel/printk.c
index 12886cd19cd9..505863aa3a7f 100644
--- a/kernel/printk.c
+++ b/kernel/printk.c
@@ -465,7 +465,7 @@ static ssize_t devkmsg_read(struct file *file, char __user *buf,
 	for (i = 0; i < msg->text_len; i++) {
 		unsigned char c = log_text(msg)[i];
 
-		if (c < ' ' || c >= 128)
+		if (c < ' ' || c >= 127 || c == '\\')
 			len += sprintf(user->buf + len, "\\x%02x", c);
 		else
 			user->buf[len++] = c;
@@ -489,7 +489,7 @@ static ssize_t devkmsg_read(struct file *file, char __user *buf,
 				continue;
 			}
 
-			if (c < ' ' || c >= 128) {
+			if (c < ' ' || c >= 127 || c == '\\') {
 				len += sprintf(user->buf + len, "\\x%02x", c);
 				continue;
 			}

