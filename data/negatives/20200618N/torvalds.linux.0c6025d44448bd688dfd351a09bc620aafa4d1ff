commit 0c6025d44448bd688dfd351a09bc620aafa4d1ff
Author: Peter Teoh <htmldeveloper@gmail.com>
Date:   Fri Mar 7 21:53:49 2008 +0100

    ide: fix buggy code in ide_register_hw()
    
    Relocating the index to come after finding the hwif pointer.
    
    Signed-off-by: Peter Teoh <htmldeveloper@gmail.com>
    Reported-by: Adrian Bunk <bunk@kernel.org>
    Signed-off-by: Bartlomiej Zolnierkiewicz <bzolnier@gmail.com>

diff --git a/drivers/ide/ide.c b/drivers/ide/ide.c
index fa16bc30bbc9..c2b791224097 100644
--- a/drivers/ide/ide.c
+++ b/drivers/ide/ide.c
@@ -667,7 +667,6 @@ int ide_register_hw(hw_regs_t *hw, void (*quirkproc)(ide_drive_t *),
 
 	do {
 		hwif = ide_deprecated_find_port(hw->io_ports[IDE_DATA_OFFSET]);
-		index = hwif->index;
 		if (hwif)
 			goto found;
 		for (index = 0; index < MAX_HWIFS; index++)
@@ -675,6 +674,7 @@ int ide_register_hw(hw_regs_t *hw, void (*quirkproc)(ide_drive_t *),
 	} while (retry--);
 	return -1;
 found:
+	index = hwif->index;
 	if (hwif->present)
 		ide_unregister(index, 0, 1);
 	else if (!hwif->hold)

