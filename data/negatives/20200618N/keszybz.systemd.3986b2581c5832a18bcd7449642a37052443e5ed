commit 3986b2581c5832a18bcd7449642a37052443e5ed
Author: Lennart Poettering <lennart@poettering.net>
Date:   Wed Apr 22 17:09:20 2015 +0200

    btrfs-util: support recursive removal of read-only subvolumes
    
    When deleting a read-only subsvolume with a sub-subvolume, we need to
    mark it writable first, otherwise the removal will not work.

diff --git a/src/shared/btrfs-util.c b/src/shared/btrfs-util.c
index 3ed14dc0f..49528dbf0 100644
--- a/src/shared/btrfs-util.c
+++ b/src/shared/btrfs-util.c
@@ -803,6 +803,7 @@ static int subvol_remove_children(int fd, const char *subvolume, uint64_t subvol
         struct btrfs_ioctl_vol_args vol_args = {};
         _cleanup_close_ int subvol_fd = -1;
         struct stat st;
+        bool made_writable = false;
         int r;
 
         assert(fd >= 0);
@@ -872,6 +873,14 @@ static int subvol_remove_children(int fd, const char *subvolume, uint64_t subvol
                         if (ioctl(fd, BTRFS_IOC_INO_LOOKUP, &ino_args) < 0)
                                 return -errno;
 
+                        if (!made_writable) {
+                                r = btrfs_subvol_set_read_only_fd(subvol_fd, false);
+                                if (r < 0)
+                                        return r;
+
+                                made_writable = true;
+                        }
+
                         if (isempty(ino_args.name))
                                 /* Subvolume is in the top-level
                                  * directory of the subvolume. */

