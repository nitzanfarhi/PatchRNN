commit d50bae33d1358b909ade05ae121d83d3a60ab63f
Author: Larry Finger <Larry.Finger@lwfinger.net>
Date:   Fri Oct 16 10:18:09 2009 -0500

    b43: Fix Bugzilla #14181 and the bug from the previous 'fix'
    
    "b43: Fix PPC crash in rfkill polling on unload" fixed the bug reported
    in Bugzilla No. 14181; however, it introduced a new bug. Whenever the
    radio switch was turned off, it was necessary to unload and reload
    the driver for it to recognize the switch again.
    
    This patch fixes both the original bug in #14181 and the bug introduced by
    the previous patch. It must be stated, however, that if there is a BCM4306/3
    with an rfkill switch (not yet proven), then the driver will need an
    unload/reload cycle to turn the device back on.
    
    Signed-off-by: Larry Finger <Larry.Finger@lwfinger.net>
    Signed-off-by: John W. Linville <linville@tuxdriver.com>

diff --git a/drivers/net/wireless/b43/main.c b/drivers/net/wireless/b43/main.c
index df6b26a0c05e..86f35827f008 100644
--- a/drivers/net/wireless/b43/main.c
+++ b/drivers/net/wireless/b43/main.c
@@ -4501,7 +4501,6 @@ static void b43_op_stop(struct ieee80211_hw *hw)
 
 	cancel_work_sync(&(wl->beacon_update_trigger));
 
-	wiphy_rfkill_stop_polling(hw->wiphy);
 	mutex_lock(&wl->mutex);
 	if (b43_status(dev) >= B43_STAT_STARTED) {
 		dev = b43_wireless_core_stop(dev);
diff --git a/drivers/net/wireless/b43/rfkill.c b/drivers/net/wireless/b43/rfkill.c
index 7a3218c5ba7d..ffdce6f3c909 100644
--- a/drivers/net/wireless/b43/rfkill.c
+++ b/drivers/net/wireless/b43/rfkill.c
@@ -33,7 +33,8 @@ bool b43_is_hw_radio_enabled(struct b43_wldev *dev)
 		      & B43_MMIO_RADIO_HWENABLED_HI_MASK))
 			return 1;
 	} else {
-		if (b43_read16(dev, B43_MMIO_RADIO_HWENABLED_LO)
+		if (b43_status(dev) >= B43_STAT_STARTED &&
+		    b43_read16(dev, B43_MMIO_RADIO_HWENABLED_LO)
 		    & B43_MMIO_RADIO_HWENABLED_LO_MASK)
 			return 1;
 	}

