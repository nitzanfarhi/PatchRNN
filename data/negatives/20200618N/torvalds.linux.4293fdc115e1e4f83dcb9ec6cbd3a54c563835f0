commit 4293fdc115e1e4f83dcb9ec6cbd3a54c563835f0
Author: Frank Zago <fzago@systemfabricworks.com>
Date:   Wed Dec 9 13:51:36 2009 -0800

    RDMA/nes: In nes_post_recv() always set bad_wr on error
    
    On error, set bad_wr in nes_post_recv().  Stop processing ib_wr queue
    when an error is detected.
    
    Signed-off-by: Frank Zago <fzago@systemfabricworks.com>
    Signed-off-by: Chien Tung <chien.tin.tung@intel.com>
    Signed-off-by: Roland Dreier <rolandd@cisco.com>

diff --git a/drivers/infiniband/hw/nes/nes_verbs.c b/drivers/infiniband/hw/nes/nes_verbs.c
index 25b52d2478a8..0b17c01bb9fa 100644
--- a/drivers/infiniband/hw/nes/nes_verbs.c
+++ b/drivers/infiniband/hw/nes/nes_verbs.c
@@ -3554,8 +3554,10 @@ static int nes_post_recv(struct ib_qp *ibqp, struct ib_recv_wr *ib_wr,
 	u32 counter;
 	u32 total_payload_length;
 
-	if (nesqp->ibqp_state > IB_QPS_RTS)
-		return -EINVAL;
+	if (nesqp->ibqp_state > IB_QPS_RTS) {
+		err = -EINVAL;
+		goto out;
+	}
 
 	spin_lock_irqsave(&nesqp->lock, flags);
 
@@ -3618,6 +3620,7 @@ static int nes_post_recv(struct ib_qp *ibqp, struct ib_recv_wr *ib_wr,
 
 	spin_unlock_irqrestore(&nesqp->lock, flags);
 
+out:
 	if (err)
 		*bad_wr = ib_wr;
 	return err;

