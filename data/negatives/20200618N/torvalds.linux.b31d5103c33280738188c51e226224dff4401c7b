commit b31d5103c33280738188c51e226224dff4401c7b
Author: Michael Thalmeier <michael.thalmeier@hale.at>
Date:   Thu Apr 21 16:43:53 2016 +0200

    NFC: pn533: handle interrupted commands in pn533_recv_frame
    
    When pn533_recv_frame is called from within abort_command
    context the current  dev->cmd is not guaranteed to be set.
    
    Additionally on receiving an error status we can omit frame
    checking and simply schedule the workqueue.
    
    Signed-off-by: Michael Thalmeier <michael.thalmeier@hale.at>
    Signed-off-by: Samuel Ortiz <sameo@linux.intel.com>

diff --git a/drivers/nfc/pn533/pn533.c b/drivers/nfc/pn533/pn533.c
index 745181ea693b..d9c55830b2b2 100644
--- a/drivers/nfc/pn533/pn533.c
+++ b/drivers/nfc/pn533/pn533.c
@@ -2016,8 +2016,16 @@ static int pn533_data_exchange_complete(struct pn533 *dev, void *_arg,
  */
 void pn533_recv_frame(struct pn533 *dev, struct sk_buff *skb, int status)
 {
+	if (!dev->cmd)
+		goto sched_wq;
+
 	dev->cmd->status = status;
 
+	if (status != 0) {
+		dev_dbg(dev->dev, "%s: Error received: %d\n", __func__, status);
+		goto sched_wq;
+	}
+
 	if (skb == NULL) {
 		pr_err("NULL Frame -> link is dead\n");
 		goto sched_wq;

