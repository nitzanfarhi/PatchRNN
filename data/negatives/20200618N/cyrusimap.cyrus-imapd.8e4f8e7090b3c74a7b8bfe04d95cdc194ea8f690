commit 8e4f8e7090b3c74a7b8bfe04d95cdc194ea8f690
Author: Bron Gondwana <brong@opera.com>
Date:   Tue Jan 3 10:26:04 2012 +0100

    mailbox: add mkdir back to copyfile, and return IOERROR
    
    Fixes bugs introduced in commit:
    "lib: create cyrus_copyfile API"

diff --git a/imap/mailbox.c b/imap/mailbox.c
index 1d21b64ae..f9d79314c 100644
--- a/imap/mailbox.c
+++ b/imap/mailbox.c
@@ -3312,9 +3312,13 @@ int mailbox_rename_cleanup(struct mailbox **mailboxptr, int isinbox)
  */
 int mailbox_copyfile(const char *from, const char *to, int nolink)
 {
-    int flags = 0;
+    int flags = COPYFILE_MKDIR;
     if (nolink) flags |= COPYFILE_NOLINK;
-    return cyrus_copyfile(from, to, flags);
+
+    if (cyrus_copyfile(from, to, flags))
+	return IMAP_IOERROR;
+
+    return 0;
 }
 
 /* ---------------------------------------------------------------------- */

