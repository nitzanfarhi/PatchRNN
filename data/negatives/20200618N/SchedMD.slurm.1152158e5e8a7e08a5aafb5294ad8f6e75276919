commit 1152158e5e8a7e08a5aafb5294ad8f6e75276919
Author: Danny Auble <da@schedmd.com>
Date:   Fri Feb 5 16:12:23 2016 -0800

    Move if into if when checking for parent structure.

diff --git a/src/slurmctld/proc_req.c b/src/slurmctld/proc_req.c
index ea984327c8..8c6948124a 100644
--- a/src/slurmctld/proc_req.c
+++ b/src/slurmctld/proc_req.c
@@ -1075,15 +1075,7 @@ static void _slurm_rpc_allocate_resources(slurm_msg_t * msg)
 			       (sizeof(uint16_t) * job_ptr->job_resrcs->
 				cpu_array_cnt));
 		}
-		if (job_ptr->details->env_cnt) {
-			alloc_msg.env_size = job_ptr->details->env_cnt;
-			alloc_msg.environment = xmalloc(sizeof(char *) *
-							alloc_msg.env_size);
-			for (i = 0; i < alloc_msg.env_size; i++) {
-				alloc_msg.environment[i] =
-					xstrdup(job_ptr->details->env_sup[i]);
-			}
-		}
+
 		alloc_msg.error_code     = error_code;
 		alloc_msg.job_id         = job_ptr->job_id;
 		alloc_msg.node_cnt       = job_ptr->node_cnt;
@@ -1107,6 +1099,18 @@ static void _slurm_rpc_allocate_resources(slurm_msg_t * msg)
 					job_ptr->details->mc_ptr->
 					ntasks_per_socket;
 			}
+
+			if (job_ptr->details->env_cnt) {
+				alloc_msg.env_size = job_ptr->details->env_cnt;
+				alloc_msg.environment =
+					xmalloc(sizeof(char *) *
+						alloc_msg.env_size);
+				for (i = 0; i < alloc_msg.env_size; i++) {
+					alloc_msg.environment[i] =
+						xstrdup(job_ptr->details->
+							env_sup[i]);
+				}
+			}
 		} else {
 			alloc_msg.pn_min_memory = 0;
 			alloc_msg.ntasks_per_board = (uint16_t)NO_VAL;

