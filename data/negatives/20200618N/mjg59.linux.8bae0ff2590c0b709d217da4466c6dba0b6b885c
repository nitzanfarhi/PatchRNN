commit 8bae0ff2590c0b709d217da4466c6dba0b6b885c
Author: Ralph Campbell <ralph.campbell@qlogic.com>
Date:   Wed Apr 16 21:01:13 2008 -0700

    IB/ipath: Fix error recovery for send buffer status after chip freeze mode
    
    The error recovery code for updating the driver's cached status information
    for which send buffers are busy or free wasn't updated for IBA7220.
    It should be similar to the initialization code in enable_chip().
    
    Signed-off-by: Ralph Campbell <ralph.campbell@qlogic.com>
    Signed-off-by: Roland Dreier <rolandd@cisco.com>

diff --git a/drivers/infiniband/hw/ipath/ipath_intr.c b/drivers/infiniband/hw/ipath/ipath_intr.c
index d12dfadaece7..ed2a227ceced 100644
--- a/drivers/infiniband/hw/ipath/ipath_intr.c
+++ b/drivers/infiniband/hw/ipath/ipath_intr.c
@@ -833,7 +833,8 @@ void ipath_clear_freeze(struct ipath_devdata *dd)
 	 */
 	for (i = 0; i < dd->ipath_pioavregs; i++) {
 		/* deal with 6110 chip bug */
-		im = i > 3 ? i ^ 1 : i;
+		im = (i > 3 && (dd->ipath_flags & IPATH_SWAP_PIOBUFS)) ?
+			i ^ 1 : i;
 		val = ipath_read_kreg64(dd, (0x1000 / sizeof(u64)) + im);
 		dd->ipath_pioavailregs_dma[i] = cpu_to_le64(val);
 		dd->ipath_pioavailshadow[i] = val;

