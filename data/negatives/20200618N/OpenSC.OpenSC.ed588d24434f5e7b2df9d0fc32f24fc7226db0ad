commit ed588d24434f5e7b2df9d0fc32f24fc7226db0ad
Author: Andreas Schwier <andreas.schwier@cardcontact.de>
Date:   Mon Apr 27 21:21:35 2015 +0200

    pkcs11: fixed broken C_Decrypt
    
    Fixed broken C_Decrypt from 643080baf9ffd404c88cb99493668eacfff3ab5e
    
    fix #449

diff --git a/src/pkcs11/mechanism.c b/src/pkcs11/mechanism.c
index fc6dcecf..a49acdb6 100644
--- a/src/pkcs11/mechanism.c
+++ b/src/pkcs11/mechanism.c
@@ -593,7 +593,7 @@ done:
 }
 
 /*
- * Initialize a signature operation
+ * Initialize a verify operation
  */
 static CK_RV
 sc_pkcs11_verify_init(sc_pkcs11_operation_t *operation,
@@ -611,10 +611,10 @@ sc_pkcs11_verify_init(sc_pkcs11_operation_t *operation,
 
 	if (key->ops->can_do)   {
 		rv = key->ops->can_do(operation->session, key, operation->type->mech, CKF_SIGN);
-		if (rv == CKR_OK)   {
-			/* Mechanism recognised and can be performed by pkcs#15 card */
+		if ((rv == CKR_OK) || (rv == CKR_FUNCTION_NOT_SUPPORTED))   {
+			/* Mechanism recognized and can be performed by pkcs#15 card or algorithm references not supported */
 		}
-		else  {
+		else {
 			/* Mechanism cannot be performed by pkcs#15 card, or some general error. */
 			free(data);
 			LOG_FUNC_RETURN(context, rv);
@@ -874,7 +874,7 @@ out:
 
 
 /*
- * Initialize a signature operation
+ * Initialize a decrypt operation
  */
 static CK_RV
 sc_pkcs11_decrypt_init(sc_pkcs11_operation_t *operation,
@@ -890,10 +890,10 @@ sc_pkcs11_decrypt_init(sc_pkcs11_operation_t *operation,
 
 	if (key->ops->can_do)   {
 		rv = key->ops->can_do(operation->session, key, operation->type->mech, CKF_DECRYPT);
-		if (rv == CKR_OK)   {
-			/* Mechanism recognised and can be performed by pkcs#15 card */
+		if ((rv == CKR_OK) || (rv == CKR_FUNCTION_NOT_SUPPORTED))   {
+			/* Mechanism recognized and can be performed by pkcs#15 card or algorithm references not supported */
 		}
-	   	else  {
+		else {
 			/* Mechanism cannot be performed by pkcs#15 card, or some general error. */
 			free(data);
 			LOG_FUNC_RETURN(context, rv);

