commit 1b6651f1bf2453d593478aa88af267f057fd73e2
Author: Patrick McHardy <kaber@trash.net>
Date:   Mon Dec 4 19:59:00 2006 -0800

    [XFRM]: Use output device disable_xfrm for forwarded packets
    
    Currently the behaviour of disable_xfrm is inconsistent between
    locally generated and forwarded packets. For locally generated
    packets disable_xfrm disables the policy lookup if it is set on
    the output device, for forwarded traffic however it looks at the
    input device. This makes it impossible to disable xfrm on all
    devices but a dummy device and use normal routing to direct
    traffic to that device.
    
    Always use the output device when checking disable_xfrm.
    
    Signed-off-by: Patrick McHardy <kaber@trash.net>
    Signed-off-by: David S. Miller <davem@davemloft.net>

diff --git a/net/ipv4/route.c b/net/ipv4/route.c
index 9f3924c4905e..11c167118e87 100644
--- a/net/ipv4/route.c
+++ b/net/ipv4/route.c
@@ -1780,7 +1780,7 @@ static inline int __mkroute_input(struct sk_buff *skb,
 #endif
 	if (in_dev->cnf.no_policy)
 		rth->u.dst.flags |= DST_NOPOLICY;
-	if (in_dev->cnf.no_xfrm)
+	if (out_dev->cnf.no_xfrm)
 		rth->u.dst.flags |= DST_NOXFRM;
 	rth->fl.fl4_dst	= daddr;
 	rth->rt_dst	= daddr;

