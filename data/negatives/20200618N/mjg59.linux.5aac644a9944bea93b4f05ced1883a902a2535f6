commit 5aac644a9944bea93b4f05ced1883a902a2535f6
Author: Adrian Hunter <adrian.hunter@intel.com>
Date:   Wed Jun 3 10:39:46 2015 +0300

    x86/tsc: Let high latency PIT fail fast in quick_pit_calibrate()
    
    If it takes longer than 12us to read the PIT counter lsb/msb,
    then the error margin will never fall below 500ppm within 50ms,
    and Fast TSC calibration will always fail.
    
    This patch detects when that will happen and fails fast. Note
    the failure message is not printed in that case because:
    1. it will always happen on that class of hardware
    2. the absence of the message is more informative than its
    presence
    
    Signed-off-by: Adrian Hunter <adrian.hunter@intel.com>
    Cc: Andy Lutomirski <luto@amacapital.net>
    Cc: Linus Torvalds <torvalds@linux-foundation.org>
    Cc: Len Brown <lenb@kernel.org>
    Cc: Andi Kleen <ak@linux.intel.com>
    Link: http://lkml.kernel.org/r/556EB717.9070607@intel.com
    Signed-off-by: Thomas Gleixner <tglx@linutronix.de>

diff --git a/arch/x86/kernel/tsc.c b/arch/x86/kernel/tsc.c
index 505449700e0c..7437b41f6a47 100644
--- a/arch/x86/kernel/tsc.c
+++ b/arch/x86/kernel/tsc.c
@@ -598,10 +598,19 @@ static unsigned long quick_pit_calibrate(void)
 			if (!pit_expect_msb(0xff-i, &delta, &d2))
 				break;
 
+			delta -= tsc;
+
+			/*
+			 * Extrapolate the error and fail fast if the error will
+			 * never be below 500 ppm.
+			 */
+			if (i == 1 &&
+			    d1 + d2 >= (delta * MAX_QUICK_PIT_ITERATIONS) >> 11)
+				return 0;
+
 			/*
 			 * Iterate until the error is less than 500 ppm
 			 */
-			delta -= tsc;
 			if (d1+d2 >= delta >> 11)
 				continue;
 

