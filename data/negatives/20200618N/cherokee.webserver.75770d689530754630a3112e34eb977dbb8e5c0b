commit 75770d689530754630a3112e34eb977dbb8e5c0b
Author: alobbs <alvaro@alobbs.com>
Date:   Sat Jun 27 21:27:43 2009 +0000

    When Cherokee was compiling without Pthread support (or threading was
    turn off in the configuration), it was not able to perform graceful
    restarts operations properly: http://bugs.cherokee-project.com/485
    
    
    git-svn-id: svn://cherokee-project.com/cherokee/trunk@3396 5dc97367-97f1-0310-9951-d761b3857238

diff --git a/cherokee/thread.c b/cherokee/thread.c
index 25210ac0..f174eb1b 100644
--- a/cherokee/thread.c
+++ b/cherokee/thread.c
@@ -1486,11 +1486,6 @@ cherokee_thread_step_SINGLE_THREAD (cherokee_thread_t *thd)
 	}
 #endif
 
-	/* Graceful restart
-	 */
-	if (srv->wanna_reinit)
-		goto out;
-
 	/* May have to reactive connections
 	 */
 	cherokee_limiter_reactive (&thd->limiter, thd);
@@ -1513,6 +1508,20 @@ cherokee_thread_step_SINGLE_THREAD (cherokee_thread_t *thd)
 	fdwatch_msecs = cherokee_limiter_get_time_limit (&thd->limiter,
 							 fdwatch_msecs);
 
+	/* Graceful restart
+	 */
+	if (srv->wanna_reinit) {
+		if ((thd->active_list_num == 0) && 
+		    (thd->polling_list_num == 0))
+		{
+			thd->exit = true;
+			return ret_eof;
+		}
+
+		cherokee_fdpoll_watch (thd->fdpoll, fdwatch_msecs);
+		goto out;
+	}
+
 	/* Inspect the file descriptors
 	 */
 	cherokee_fdpoll_watch (thd->fdpoll, fdwatch_msecs);

