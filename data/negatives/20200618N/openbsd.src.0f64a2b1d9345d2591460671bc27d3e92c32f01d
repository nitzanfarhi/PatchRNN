commit 0f64a2b1d9345d2591460671bc27d3e92c32f01d
Author: miod <miod@openbsd.org>
Date:   Wed Jan 16 20:28:06 2013 +0000

    On second thought, do not unconditionnaly register the cpu throttling code
    on all Loongson2F systems yet; Gdium does not have a separate scheduling
    clock yet and can't afford throttling until then.

diff --git a/sys/arch/loongson/loongson/loongson2_machdep.c b/sys/arch/loongson/loongson/loongson2_machdep.c
index 88383766b04..de80d22395e 100644
--- a/sys/arch/loongson/loongson/loongson2_machdep.c
+++ b/sys/arch/loongson/loongson/loongson2_machdep.c
@@ -1,4 +1,4 @@
-/*	$OpenBSD: loongson2_machdep.c,v 1.12 2013/01/16 07:17:59 pirofti Exp $	*/
+/*	$OpenBSD: loongson2_machdep.c,v 1.13 2013/01/16 20:28:06 miod Exp $	*/
 
 /*
  * Copyright (c) 2009, 2010 Miodrag Vallat.
@@ -38,8 +38,6 @@ boolean_t is_memory_range(paddr_t, psize_t, psize_t);
 void	loongson2e_setup(u_long, u_long);
 void	loongson2f_setup(u_long, u_long);
 void	loongson2f_setup_window(uint, uint, uint64_t, uint64_t, uint64_t, uint);
-int	loongson2f_cpuspeed(int *);
-void	loongson2f_setperf(int);
 
 /* PCI view of CPU memory */
 paddr_t loongson_dma_base = 0;
@@ -208,7 +206,6 @@ loongson2f_setup(u_long memlo, u_long memhi)
 	    ~(DDR_PHYSICAL_SIZE - 1), DDR_PHYSICAL_BASE, MASTER_CPU);
 
 	cpu_cpuspeed = loongson2f_cpuspeed;
-	cpu_setperf = loongson2f_setperf;
 }
 
 /*
diff --git a/sys/arch/loongson/loongson/yeeloong_machdep.c b/sys/arch/loongson/loongson/yeeloong_machdep.c
index c7f9a224a5c..5b31d53a381 100644
--- a/sys/arch/loongson/loongson/yeeloong_machdep.c
+++ b/sys/arch/loongson/loongson/yeeloong_machdep.c
@@ -1,4 +1,4 @@
-/*	$OpenBSD: yeeloong_machdep.c,v 1.22 2013/01/16 07:17:59 pirofti Exp $	*/
+/*	$OpenBSD: yeeloong_machdep.c,v 1.23 2013/01/16 20:28:06 miod Exp $	*/
 
 /*
  * Copyright (c) 2009, 2010 Miodrag Vallat.
@@ -28,6 +28,7 @@
 
 #include <machine/autoconf.h>
 #include <machine/cpu.h>
+#include <mips64/loongson2.h>
 #include <mips64/mips_cpu.h>
 #include <machine/pmon.h>
 
@@ -62,6 +63,7 @@ void	 fuloong_powerdown(void);
 void	 fuloong_setup(void);
 
 void	 yeeloong_powerdown(void);
+void	 yeeloong_setup(void);
 
 void	 lemote_pci_attach_hook(pci_chipset_tag_t);
 int	 lemote_intr_map(int, int, int);
@@ -195,7 +197,7 @@ const struct platform yeeloong_platform = {
 	.isa_chipset = &lemote_isa_chipset,
 	.legacy_io_ranges = yeeloong_legacy_ranges,
 
-	.setup = NULL,
+	.setup = yeeloong_setup,
 	.device_register = lemote_device_register,
 
 	.powerdown = yeeloong_powerdown,
@@ -502,8 +504,18 @@ fuloong_setup(void)
                 comconsiot = &bonito_pci_io_space_tag;
                 comconsaddr = 0x2f8;
                 comconsrate = 115200; /* default PMON console speed */
+		comconscflag = (TTYDEF_CFLAG & ~(CSIZE | CSTOPB | PARENB)) |
+		    CS8 | CLOCAL; /* 8N1 */
 	}
 #endif
+
+	cpu_setperf = loongson2f_setperf;
+}
+
+void
+yeeloong_setup(void)
+{
+	cpu_setperf = loongson2f_setperf;
 }
 
 void
diff --git a/sys/arch/mips64/include/loongson2.h b/sys/arch/mips64/include/loongson2.h
index 1561b19cbc2..6905a111dfa 100644
--- a/sys/arch/mips64/include/loongson2.h
+++ b/sys/arch/mips64/include/loongson2.h
@@ -1,4 +1,4 @@
-/*	$OpenBSD: loongson2.h,v 1.3 2011/03/23 16:54:36 pirofti Exp $	*/
+/*	$OpenBSD: loongson2.h,v 1.4 2013/01/16 20:28:06 miod Exp $	*/
 
 /*
  * Copyright (c) 2009 Miodrag Vallat.
@@ -57,4 +57,9 @@
 #define	COP_0_DIAG_BTB_CLEAR		0x02
 #define	COP_0_DIAG_RAS_DISABLE		0x01
 
+#if defined(_KERNEL) && !defined(_LOCORE)
+int	loongson2f_cpuspeed(int *);
+void	loongson2f_setperf(int);
+#endif
+
 #endif	/* _MIPS64_LOONGSON2_H_ */

