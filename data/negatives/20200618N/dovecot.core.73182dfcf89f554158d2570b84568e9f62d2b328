commit 73182dfcf89f554158d2570b84568e9f62d2b328
Author: Timo Sirainen <tss@iki.fi>
Date:   Mon Nov 29 02:27:47 2004 +0200

    Don't crash if cache is unusable.
    
    --HG--
    branch : HEAD

diff --git a/src/lib-index/mail-cache-sync-update.c b/src/lib-index/mail-cache-sync-update.c
index 8b0273e6b..ceca41be2 100644
--- a/src/lib-index/mail-cache-sync-update.c
+++ b/src/lib-index/mail-cache-sync-update.c
@@ -77,6 +77,9 @@ int mail_cache_expunge_handler(struct mail_index_sync_map_ctx *sync_ctx,
 	if (*cache_offset == 0)
 		return 1;
 
+	if (MAIL_CACHE_IS_UNUSABLE(cache))
+		return 1;
+
 	ret = mail_cache_handler_init(&ctx, cache);
 	*context = ctx;
 	if (ret <= 0)
@@ -110,6 +113,9 @@ int mail_cache_sync_handler(struct mail_index_sync_map_ctx *sync_ctx,
 		return 1;
 	}
 
+	if (MAIL_CACHE_IS_UNUSABLE(cache))
+		return 1;
+
 	if (cache->file_cache != NULL) {
 		file_cache_invalidate(cache->file_cache, *new_cache_offset,
 				      (size_t)-1);

