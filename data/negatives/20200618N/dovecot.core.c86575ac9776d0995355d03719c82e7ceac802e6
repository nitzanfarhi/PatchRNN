commit c86575ac9776d0995355d03719c82e7ceac802e6
Author: Aki Tuomi <aki.tuomi@dovecot.fi>
Date:   Tue Nov 28 16:50:13 2017 +0200

    auth: db-lua - Fix password scheme handling
    
    It was left as NULL and had misleading name in some
    of the handler functions causing assert-crash.

diff --git a/src/auth/db-lua.c b/src/auth/db-lua.c
index 1dcf854e9..a54143dc1 100644
--- a/src/auth/db-lua.c
+++ b/src/auth/db-lua.c
@@ -418,8 +418,7 @@ auth_lua_export_fields(struct auth_request *req,
 			key = t_strdup_until(*fields, value++);
 		}
 
-		if (password_r != NULL && strcmp(key, "password") == 0 &&
-		    req->userdb_lookup) {
+		if (password_r != NULL && strcmp(key, "password") == 0) {
 			*scheme_r = password_get_scheme(&value);
 			*password_r = value;
 		} else if (req->userdb_lookup) {
@@ -507,7 +506,7 @@ auth_lua_export_passdb_table(struct dlua_script *script, struct auth_request *re
 
 static enum passdb_result
 auth_lua_call_lookup_finish(struct dlua_script *script, struct auth_request *req,
-			    const char **username_r, const char **password_r,
+			    const char **scheme_r, const char **password_r,
 			    const char **error_r)
 {
 	if (lua_istable(script->L, -1)) {
@@ -522,9 +521,12 @@ auth_lua_call_lookup_finish(struct dlua_script *script, struct auth_request *req
 	if (ret != PASSDB_RESULT_OK && ret != PASSDB_RESULT_NEXT) {
 		*error_r = str;
 	} else {
-		auth_lua_export_fields(req, str, username_r, password_r);
+		auth_lua_export_fields(req, str, scheme_r, password_r);
 	}
 
+	if (scheme_r != NULL && *scheme_r == NULL)
+		*scheme_r = "PLAIN";
+
 	return ret;
 }
 

