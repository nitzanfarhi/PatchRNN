commit f287b4a8c8eb5890a38f18461b94fa11fc85e600
Author: unknown <jonas@perch.ndb.mysql.com>
Date:   Fri Aug 4 08:41:32 2006 +0200

    ndb - bug#20296 (recommit in 4.1)
       Make sure that tupkeyErrorLab is run if interpretedUpdate(fail), so that entry is not inserted into index.
         Yeilding crash on following dml on tupel
    
    
    
    ndb/src/kernel/blocks/dbtup/DbtupExecQuery.cpp:
      Make sure that tupkeyErrorLab is run if interpretedUpdate(fail), so that entry is not inserted into index.
            Yeilding crash on following dml on tupe

diff --git a/ndb/src/kernel/blocks/dbtup/DbtupExecQuery.cpp b/ndb/src/kernel/blocks/dbtup/DbtupExecQuery.cpp
index 8171fa65771..a1f8b827752 100644
--- a/ndb/src/kernel/blocks/dbtup/DbtupExecQuery.cpp
+++ b/ndb/src/kernel/blocks/dbtup/DbtupExecQuery.cpp
@@ -1111,14 +1111,16 @@ Dbtup::updateStartLab(Signal* signal,
                                 regOperPtr->pageOffset,
                                 &cinBuffer[0],
                                 regOperPtr->attrinbufLen);
-    if (retValue == -1) {
-      tupkeyErrorLab(signal);
-      return -1;
-    }//if
   } else {
     jam();
     retValue = interpreterStartLab(signal, pagePtr, regOperPtr->pageOffset);
   }//if
+
+  if (retValue == -1) {
+    tupkeyErrorLab(signal);
+    return -1;
+  }//if
+
   ndbrequire(regOperPtr->tupVersion != ZNIL);
   pagePtr->pageWord[regOperPtr->pageOffset + 1] = regOperPtr->tupVersion;
   if (regTabPtr->checksumIndicator) {

