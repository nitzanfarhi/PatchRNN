commit 04f1d2d66dc95a3f4c66c05471567a85c7d7cc37
Author: millert <millert@openbsd.org>
Date:   Mon Apr 28 20:59:13 2003 +0000

    fix skeygetnext()

diff --git a/lib/libskey/skeylogin.c b/lib/libskey/skeylogin.c
index 620378d53c5..2d85b18703d 100644
--- a/lib/libskey/skeylogin.c
+++ b/lib/libskey/skeylogin.c
@@ -10,7 +10,7 @@
  *
  * S/Key verification check, lookups, and authentication.
  *
- * $OpenBSD: skeylogin.c,v 1.49 2003/04/03 17:48:50 millert Exp $
+ * $OpenBSD: skeylogin.c,v 1.50 2003/04/28 20:59:13 millert Exp $
  */
 
 #include <sys/param.h>
@@ -37,6 +37,7 @@
 
 static void skey_fakeprompt(char *, char *);
 static char *tgetline(int, char *, size_t, int);
+static int skeygetent(struct skey *, const char *);
 
 /*
  * Return an skey challenge string for user 'name'. If successful,
@@ -74,15 +75,15 @@ skeychallenge(struct skey *mp, char *name, char *ss)
 }
 
 /*
- * Find an entry in the One-time Password database and lock it.
+ * Get an entry in the One-time Password database and lock it.
  *
  * Return codes:
  * -1: error in opening database or unable to lock entry
  *  0: entry found, file R/W pointer positioned at beginning of record
  *  1: entry not found
  */
-int
-skeylookup(struct skey *mp, char *name)
+static int
+skeygetent(struct skey *mp, const char *name)
 {
 	struct stat statbuf;
 	size_t nread;
@@ -90,8 +91,6 @@ skeylookup(struct skey *mp, char *name)
 	FILE *keyfile;
 	int fd;
 
-	memset(mp, 0, sizeof(*mp));
-
 	/* Check to see that /etc/skey has not been disabled. */
 	if (stat(_PATH_SKEYDIR, &statbuf) != 0)
 		return (-1);
@@ -170,6 +169,22 @@ skeylookup(struct skey *mp, char *name)
 	return (1);
 }
 
+/*
+ * Look up an entry in the One-time Password database and lock it.
+ * Zeroes out the passed in struct skey before using it.
+ *
+ * Return codes:
+ * -1: error in opening database or unable to lock entry
+ *  0: entry found, file R/W pointer positioned at beginning of record
+ *  1: entry not found
+ */
+int
+skeylookup(struct skey *mp, char *name)
+{
+	memset(mp, 0, sizeof(*mp));
+	return (skeygetent(mp, name));
+}
+
 /*
  * Get the next entry in the One-time Password database.
  *
@@ -197,9 +212,9 @@ skeygetnext(struct skey *mp)
 	while ((readdir_r(mp->keydir, &entry, &dp)) == 0 && dp == &entry) {
 		/* Skip dot files and zero-length files. */
 		if (entry.d_name[0] != '.' &&
-		    (rval = skeylookup(mp, entry.d_name) != 1))
+		    (rval = skeygetent(mp, entry.d_name)) != 1)
 			break;
-	};
+	}
 
 	if (dp == NULL) {
 		closedir(mp->keydir);

