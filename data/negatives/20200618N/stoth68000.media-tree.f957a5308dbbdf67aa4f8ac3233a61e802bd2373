commit f957a5308dbbdf67aa4f8ac3233a61e802bd2373
Author: Jiri Olsa <jolsa@kernel.org>
Date:   Mon Oct 10 09:56:32 2016 +0200

    perf header: Set nr_numa_nodes only when we parsed all the data
    
    Sukadev reported segfault on releasing perf env's numa data.  It's due
    to nr_numa_nodes being set no matter if the numa data gets parsed
    properly. The perf_env__exit crash the on releasing non existed data.
    
    Setting nr_numa_nodes only when data are parsed out properly.
    
    Signed-off-by: Jiri Olsa <jolsa@kernel.org>
    Reported-by: Sukadev Bhattiprolu <sukadev@linux.vnet.ibm.com>
    Cc: Adrian Hunter <adrian.hunter@intel.com>
    Cc: David Ahern <dsahern@gmail.com>
    Cc: Namhyung Kim <namhyung@kernel.org>
    Cc: Wang Nan <wangnan0@huawei.com>
    Link: http://lkml.kernel.org/n/tip-dt9c0zgkt4hybn2cr4xiawta@git.kernel.org
    Signed-off-by: Arnaldo Carvalho de Melo <acme@redhat.com>

diff --git a/tools/perf/util/header.c b/tools/perf/util/header.c
index 85dd0db0a127..2f3eded54b0c 100644
--- a/tools/perf/util/header.c
+++ b/tools/perf/util/header.c
@@ -1895,7 +1895,6 @@ static int process_numa_topology(struct perf_file_section *section __maybe_unuse
 	if (ph->needs_swap)
 		nr = bswap_32(nr);
 
-	ph->env.nr_numa_nodes = nr;
 	nodes = zalloc(sizeof(*nodes) * nr);
 	if (!nodes)
 		return -ENOMEM;
@@ -1932,6 +1931,7 @@ static int process_numa_topology(struct perf_file_section *section __maybe_unuse
 
 		free(str);
 	}
+	ph->env.nr_numa_nodes = nr;
 	ph->env.numa_nodes = nodes;
 	return 0;
 

