commit ee98f4738050bb93823ce9ba849f5d78f5b8c1a1
Author: Johan Hedberg <johan.hedberg@intel.com>
Date:   Wed Jan 9 15:29:36 2013 +0200

    Bluetooth: Fix accepting set_dev_class for non-BR/EDR controllers
    
    The concept of Class of Device only exists for BR/EDR controllers. The
    mgmt_set_dev_class command should therefore return a proper "not
    supported" error if it is attempted for a controller that doesn't
    support BR/EDR (e.g. a single mode LE-only one).
    
    Signed-off-by: Johan Hedberg <johan.hedberg@intel.com>
    Acked-by: Marcel Holtmann <marcel@holtmann.org>
    Signed-off-by: Gustavo Padovan <gustavo.padovan@collabora.co.uk>

diff --git a/net/bluetooth/mgmt.c b/net/bluetooth/mgmt.c
index f3fec4264dcf..d78ce81d2cf4 100644
--- a/net/bluetooth/mgmt.c
+++ b/net/bluetooth/mgmt.c
@@ -1424,6 +1424,12 @@ static int set_dev_class(struct sock *sk, struct hci_dev *hdev, void *data,
 
 	hci_dev_lock(hdev);
 
+	if (!lmp_bredr_capable(hdev)) {
+		err = cmd_status(sk, hdev->id, MGMT_OP_SET_DEV_CLASS,
+				 MGMT_STATUS_NOT_SUPPORTED);
+		goto unlock;
+	}
+
 	if (test_bit(HCI_PENDING_CLASS, &hdev->dev_flags)) {
 		err = cmd_status(sk, hdev->id, MGMT_OP_SET_DEV_CLASS,
 				 MGMT_STATUS_BUSY);

