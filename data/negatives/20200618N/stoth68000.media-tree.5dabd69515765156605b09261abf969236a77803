commit 5dabd69515765156605b09261abf969236a77803
Author: Jan Kara <jack@suse.cz>
Date:   Thu Feb 21 18:00:00 2008 +0100

    ocfs2: Improve rename locking
    
    ocfs2_rename() was being too aggressive with the rename lock - we only need
    it for certain forms of directory rename.
    
    Signed-off-by: Jan Kara <jack@suse.cz>
    Signed-off-by: Mark Fasheh <mfasheh@suse.com>

diff --git a/fs/ocfs2/namei.c b/fs/ocfs2/namei.c
index ab5a2272d0eb..d5d808fe0140 100644
--- a/fs/ocfs2/namei.c
+++ b/fs/ocfs2/namei.c
@@ -997,7 +997,7 @@ static int ocfs2_rename(struct inode *old_dir,
 	 *
 	 * And that's why, just like the VFS, we need a file system
 	 * rename lock. */
-	if (old_dentry != new_dentry) {
+	if (old_dir != new_dir && S_ISDIR(old_inode->i_mode)) {
 		status = ocfs2_rename_lock(osb);
 		if (status < 0) {
 			mlog_errno(status);

