commit 1648a22b16ab05bd99dd8e2f33ca80bbcea60031
Author: Vipul Pandya <vipul@chelsio.com>
Date:   Wed Sep 26 02:39:41 2012 +0000

    cxgb4: Inform caller if driver didn't upgrade firmware
    
    If a card had already been initialized, on reloading cxgb4 driver firmware
    required an upgrade but the upgrade did not happen. In that case a mailbox
    timeout would occur during T4 configuration file stuff. The fix is to let the
    caller know the firmware was not upgraded so a reset would be issued before
    starting the T4 config stuff.
    
    Signed-off-by: Jay Hernandez <jay@chelsio.com>
    Signed-off-by: Vipul Pandya <vipul@chelsio.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

diff --git a/drivers/net/ethernet/chelsio/cxgb4/cxgb4_main.c b/drivers/net/ethernet/chelsio/cxgb4/cxgb4_main.c
index b9cd08df39b3..a3f866d5b8f1 100644
--- a/drivers/net/ethernet/chelsio/cxgb4/cxgb4_main.c
+++ b/drivers/net/ethernet/chelsio/cxgb4/cxgb4_main.c
@@ -933,7 +933,13 @@ static int upgrade_fw(struct adapter *adap)
 		if (!ret)
 			dev_info(dev, "firmware upgraded to version %pI4 from "
 				 FW_FNAME "\n", &hdr->fw_ver);
+	} else {
+		/*
+		 * Tell our caller that we didn't upgrade the firmware.
+		 */
+		ret = -EINVAL;
 	}
+
 out:	release_firmware(fw);
 	return ret;
 }

