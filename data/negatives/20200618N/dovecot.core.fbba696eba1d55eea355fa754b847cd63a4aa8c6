commit fbba696eba1d55eea355fa754b847cd63a4aa8c6
Author: Timo Sirainen <tss@iki.fi>
Date:   Tue Apr 26 12:42:59 2005 +0300

    If X-UIDs hadn't yet been written, we resynced everything after the first
    message we had to sync.
    
    --HG--
    branch : HEAD

diff --git a/src/lib-storage/index/mbox/mbox-sync.c b/src/lib-storage/index/mbox/mbox-sync.c
index 249895255..cb0686ca9 100644
--- a/src/lib-storage/index/mbox/mbox-sync.c
+++ b/src/lib-storage/index/mbox/mbox-sync.c
@@ -989,11 +989,6 @@ static int mbox_sync_loop(struct mbox_sync_context *sync_ctx,
 				return -1;
 		}
 
-		if (rec == NULL) {
-			/* from now on, don't skip anything */
-			partial = FALSE;
-		}
-
 		if (ret == 0) {
 			/* UID found but it's broken */
 			uid = 0;
@@ -1015,6 +1010,11 @@ static int mbox_sync_loop(struct mbox_sync_context *sync_ctx,
 				uid = mail_ctx->mail.uid = rec->uid;
 		}
 
+		if (rec == NULL) {
+			/* from now on, don't skip anything */
+			partial = FALSE;
+		}
+
 		if (!mail_ctx->pseudo && !uidvalidity_changed) {
 			/* get all sync records related to this message */
 			if (mbox_sync_read_index_syncs(sync_ctx, uid,

