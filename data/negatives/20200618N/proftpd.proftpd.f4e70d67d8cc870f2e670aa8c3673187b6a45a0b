commit f4e70d67d8cc870f2e670aa8c3673187b6a45a0b
Author: castaglia <castaglia>
Date:   Thu Jul 1 01:52:36 2004 +0000

    When handling <Global> contexts in fixup_globals(), only handle contexts
    that have both the right config_type (CONF_GLOBAL) _and_ the right name
    ("<Global>").  Contrib modules (e.g. mod_ifsession) might create their own
    contexts that use the CONF_GLOBAL flag; in the case of mod_ifsession, the
    fact that fixup_globals() was handling the mod_ifsession-created context
    config_recs was causing a bug when <If*> sections were used within
    <Global> contexts.
    
    This change also includes some style cleanup.

diff --git a/src/dirtree.c b/src/dirtree.c
index f3f693a9b..8a320e264 100644
--- a/src/dirtree.c
+++ b/src/dirtree.c
@@ -25,7 +25,7 @@
  */
 
 /* Read configuration file(s), and manage server/configuration structures.
- * $Id: dirtree.c,v 1.153 2004-07-01 01:17:29 castaglia Exp $
+ * $Id: dirtree.c,v 1.154 2004-07-01 01:52:36 castaglia Exp $
  */
 
 #include "conf.h"
@@ -2812,23 +2812,27 @@ static void fixup_globals(void) {
   server_rec *s = NULL, *smain = NULL;
   config_rec *c = NULL, *cnext = NULL;
 
-  smain = (server_rec*) server_list->xas_list;
-  for (s = smain; s; s=s->next) {
-    /* loop through each top level directive looking for a CONF_GLOBAL
-     * context
+  smain = (server_rec *) server_list->xas_list;
+  for (s = smain; s; s = s->next) {
+    /* Loop through each top level directive looking for a CONF_GLOBAL
+     * context.
      */
     if (!s->conf || !s->conf->xas_list)
       continue;
 
-    for (c = (config_rec*)s->conf->xas_list; c; c=cnext) {
+    for (c = (config_rec * )s->conf->xas_list; c; c = cnext) {
       cnext = c->next;
-      if (c->config_type == CONF_GLOBAL) {
-        /* copy the contents of the block to all other servers
+
+      if (c->config_type == CONF_GLOBAL &&
+          strcmp(c->name, "<Global>") == 0) {
+        /* Copy the contents of the block to all other servers
          * (including this one), then pull the block "out of play".
          */
         if (c->subset && c->subset->xas_list)
           copy_global_to_all(c->subset);
-        xaset_remove(s->conf, (xasetmember_t*)c);
+
+        xaset_remove(s->conf, (xasetmember_t *) c);
+
         if (!s->conf->xas_list) {
           destroy_pool(s->conf->pool);
           s->conf = NULL;

