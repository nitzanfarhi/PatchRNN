commit 4be3bd8ccc195297870b9ffca4ef18bcbc2f1822
Author: Johannes Berg <johannes@sipsolutions.net>
Date:   Thu Sep 24 09:00:57 2009 +0200

    cfg80211: don't set privacy w/o key
    
    When wpa_supplicant is used to connect to open networks,
    it causes the wdev->wext.keys to point to key memory, but
    that key memory is all empty. Only use privacy when there
    is a default key to be used.
    
    Signed-off-by: Johannes Berg <johannes@sipsolutions.net>
    Tested-by: Luis R. Rodriguez <lrodriguez@atheros.com>
    Tested-by: Kalle Valo <kalle.valo@iki.fi>
    Signed-off-by: John W. Linville <linville@tuxdriver.com>

diff --git a/net/wireless/wext-sme.c b/net/wireless/wext-sme.c
index 53c6ba98dc25..5615a8802536 100644
--- a/net/wireless/wext-sme.c
+++ b/net/wireless/wext-sme.c
@@ -30,7 +30,8 @@ int cfg80211_mgd_wext_connect(struct cfg80211_registered_device *rdev,
 	if (wdev->wext.keys) {
 		wdev->wext.keys->def = wdev->wext.default_key;
 		wdev->wext.keys->defmgmt = wdev->wext.default_mgmt_key;
-		wdev->wext.connect.privacy = true;
+		if (wdev->wext.default_key != -1)
+			wdev->wext.connect.privacy = true;
 	}
 
 	if (!wdev->wext.connect.ssid_len)

