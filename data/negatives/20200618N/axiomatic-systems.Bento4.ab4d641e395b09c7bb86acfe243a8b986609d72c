commit ab4d641e395b09c7bb86acfe243a8b986609d72c
Author: Gilles Boccon-Gibod <bok@bok.net>
Date:   Sat Jul 21 11:50:34 2018 -0700

    fix #285

diff --git a/Source/C++/Core/Ap4StszAtom.cpp b/Source/C++/Core/Ap4StszAtom.cpp
index e43ba58..a5a1f05 100644
--- a/Source/C++/Core/Ap4StszAtom.cpp
+++ b/Source/C++/Core/Ap4StszAtom.cpp
@@ -87,6 +87,8 @@ AP4_StszAtom::AP4_StszAtom(AP4_UI32        size,
         AP4_Result result = stream.Read(buffer, sample_count*4);
         if (AP4_FAILED(result)) {
             delete[] buffer;
+            m_Entries.Clear();
+            m_SampleCount = 0;
             return;
         }
         for (unsigned int i=0; i<sample_count; i++) {
@@ -167,7 +169,7 @@ AP4_StszAtom::SetSampleSize(AP4_Ordinal sample, AP4_Size sample_size)
             // all samples must have the same size
             if (sample_size != m_SampleSize) {
                 // not the same
-                if (sample == 1) {
+                if (sample == 1 && sample_size != 0) {
                     // if this is the first sample, update the global size
                     m_SampleSize = sample_size;
                     return AP4_SUCCESS;
@@ -178,6 +180,9 @@ AP4_StszAtom::SetSampleSize(AP4_Ordinal sample, AP4_Size sample_size)
             }
         } else {
             // each sample has a different size
+            if (sample > m_Entries.ItemCount()) {
+                return AP4_ERROR_OUT_OF_RANGE;
+            }
             m_Entries[sample - 1] = sample_size;
         }
 

