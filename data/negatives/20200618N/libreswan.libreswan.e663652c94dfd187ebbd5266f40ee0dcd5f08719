commit e663652c94dfd187ebbd5266f40ee0dcd5f08719
Author: Avesh Agarwal <avagarwa@redhat.com>
Date:   Thu May 26 16:28:17 2011 -0400

    2. Protocol port issue when using hostnames instead of ipaddress in
    connection definitions (rhbz# 703473): leftprotoport/rightprotoport option
    does not work when using hostnames with ipv4. With ipv6, this issue can be
    reproduced even with ipv6 addresses, if you dont specify
    "connaddrfamily=ipv6" in the connection definition.  The reason is that the
    ipv6 address is considered as string and is tried for name resolution
    leading to wiping of ports from the connection. However, the ipv6 connection
    gets established. IOW that to make an ipv6 work, it is not really needed to
    specify "connaddrfamily=ipv6", however breaks protocol/port stuff.

diff --git a/programs/pluto/connections.c b/programs/pluto/connections.c
index 9393955c4..464649125 100644
--- a/programs/pluto/connections.c
+++ b/programs/pluto/connections.c
@@ -983,11 +983,16 @@ extract_end(struct end *dst, const struct whack_end *src, const char *which)
      */
     {
 	err_t er;
+	int port;
 	
 	switch(dst->host_type) {
 	case KH_IPHOSTNAME:
 	    er = ttoaddr(dst->host_addr_name, 0, 0, &dst->host_addr);
-	    
+
+	    /*The above call wipes out the port, put it again*/
+	    port = htons(dst->port);
+	    setportof(port, &dst->host_addr);
+		
 	    if(er) {
 		loglog(RC_COMMENT, "failed to convert '%s' at load time: %s"
 		       , dst->host_addr_name, er);

