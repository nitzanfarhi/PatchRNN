commit db80c7b974f4ccab56bd5e8ff2248c7339b00c73
Author: Marcel Apfelbaum <marcel.a@redhat.com>
Date:   Mon Oct 27 19:34:42 2014 +0200

    hw/pci: fixed hotplug crash when using rombar=0 with devices having romfile
    
    Hot-plugging a device that has a romfile (either supplied by user
    or built-in) using rombar=0 option is a user error,
    do not allow the device to be hot-plugged.
    
    Reviewed-by: Eric Blake <eblake@redhat.com>
    Signed-off-by: Marcel Apfelbaum <marcel.a@redhat.com>
    Reviewed-by: Michael S. Tsirkin <mst@redhat.com>
    Signed-off-by: Michael S. Tsirkin <mst@redhat.com>

diff --git a/hw/pci/pci.c b/hw/pci/pci.c
index 36226eb2c8..371699cf86 100644
--- a/hw/pci/pci.c
+++ b/hw/pci/pci.c
@@ -1942,6 +1942,15 @@ static int pci_add_option_rom(PCIDevice *pdev, bool is_default_rom)
          * for 0.11 compatibility.
          */
         int class = pci_get_word(pdev->config + PCI_CLASS_DEVICE);
+
+        /*
+         * Hot-plugged devices can't use the option ROM
+         * if the rom bar is disabled.
+         */
+        if (DEVICE(pdev)->hotplugged) {
+            return -1;
+        }
+
         if (class == 0x0300) {
             rom_add_vga(pdev->romfile);
         } else {

