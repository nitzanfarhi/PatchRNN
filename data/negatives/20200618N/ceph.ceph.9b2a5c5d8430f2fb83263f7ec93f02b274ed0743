commit 9b2a5c5d8430f2fb83263f7ec93f02b274ed0743
Author: Sage Weil <sage@newdream.net>
Date:   Fri Mar 9 16:34:55 2012 -0800

    filestore: sync object_map on _set_replay_guard()
    
    We need to sync the object_map too.  We can _almost_ check to see if there
    are keys for the object and only do it then, except that they may have
    existed previously and then been deleted.
    
    So, always sync.  leveldb is reasonably nice about this... it should just
    be another fsync.
    
    Signed-off-by: Sage Weil <sage@newdream.net>

diff --git a/src/os/FileStore.cc b/src/os/FileStore.cc
index 4ee8cfd6c0..4f8c3e55c8 100644
--- a/src/os/FileStore.cc
+++ b/src/os/FileStore.cc
@@ -2356,6 +2356,11 @@ void FileStore::_set_replay_guard(int fd, const SequencerPosition& spos)
   // first make sure the previous operation commits
   ::fsync(fd);
 
+  // sync object_map too.  even if this object has a header or keys,
+  // it have had them in the past and then removed them, so always
+  // sync.
+  object_map->sync();
+
   // then record that we did it
   bufferlist v(40);
   ::encode(spos, v);

