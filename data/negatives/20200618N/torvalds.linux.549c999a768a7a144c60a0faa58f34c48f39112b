commit 549c999a768a7a144c60a0faa58f34c48f39112b
Author: Artem Bityutskiy <Artem.Bityutskiy@nokia.com>
Date:   Thu May 26 16:57:14 2011 +0300

    UBIFS: return EROFS in case of broken commit
    
    If commit failed and it is in broken state, UBIFS switches to R/O mode. Most
    operations return -EROFS in this case, except of commit which returns -EINVAL.
    Make it return -EROFS too for consistency. This is also important for our power
    cut emulation testing.
    
    Signed-off-by: Artem Bityutskiy <Artem.Bityutskiy@nokia.com>

diff --git a/fs/ubifs/commit.c b/fs/ubifs/commit.c
index 87cd0ead8633..8ab03d12d5c0 100644
--- a/fs/ubifs/commit.c
+++ b/fs/ubifs/commit.c
@@ -418,7 +418,7 @@ int ubifs_run_commit(struct ubifs_info *c)
 
 	spin_lock(&c->cs_lock);
 	if (c->cmt_state == COMMIT_BROKEN) {
-		err = -EINVAL;
+		err = -EROFS;
 		goto out;
 	}
 
@@ -444,7 +444,7 @@ int ubifs_run_commit(struct ubifs_info *c)
 	 * re-check it.
 	 */
 	if (c->cmt_state == COMMIT_BROKEN) {
-		err = -EINVAL;
+		err = -EROFS;
 		goto out_cmt_unlock;
 	}
 

