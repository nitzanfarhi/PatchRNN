commit de87dcddc70ec6a90adfcc81f0ad7d84a892ffce
Author: Avi Kivity <avi@redhat.com>
Date:   Tue Jun 12 20:21:38 2012 +0300

    KVM: VMX: Stop invalid guest state emulation on pending event
    
    Process the event, possibly injecting an interrupt, before continuing.
    
    Signed-off-by: Avi Kivity <avi@redhat.com>

diff --git a/arch/x86/kvm/vmx.c b/arch/x86/kvm/vmx.c
index 2e51e7c6d2a8..a62f92ab1be2 100644
--- a/arch/x86/kvm/vmx.c
+++ b/arch/x86/kvm/vmx.c
@@ -4986,6 +4986,9 @@ static int handle_invalid_guest_state(struct kvm_vcpu *vcpu)
 		if (intr_window_requested && vmx_interrupt_allowed(vcpu))
 			return handle_interrupt_window(&vmx->vcpu);
 
+		if (test_bit(KVM_REQ_EVENT, &vcpu->requests))
+			return 1;
+
 		err = emulate_instruction(vcpu, 0);
 
 		if (err == EMULATE_DO_MMIO) {

