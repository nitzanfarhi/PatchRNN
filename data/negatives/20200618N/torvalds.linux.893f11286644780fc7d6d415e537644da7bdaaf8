commit 893f11286644780fc7d6d415e537644da7bdaaf8
Author: Ralph Wuerthner <rwuerthn@de.ibm.com>
Date:   Thu Apr 17 07:46:14 2008 +0200

    [S390] hw_random: allow rng_dev_read() to return hardware errors.
    
    The api for hardware random number generators is currently limited to
    devices that never fail. If the hardware is registered as a source for
    random numbers it has to work. This prevents the use of i/o based
    random number devices where the i/o might fail.
    
    Add a check for errors after the read from a hardware random number device.
    
    This patch is required to support large random numbers retrieved
    from the CEX2C cards on System z.
    
    Signed-off-by: Ralph Wuerthner <rwuerthn@de.ibm.com>
    Signed-off-by: Martin Schwidefsky <schwidefsky@de.ibm.com>
    Signed-off-by: Heiko Carstens <heiko.carstens@de.ibm.com>

diff --git a/drivers/char/hw_random/core.c b/drivers/char/hw_random/core.c
index 84cdf9025737..349b6edc5794 100644
--- a/drivers/char/hw_random/core.c
+++ b/drivers/char/hw_random/core.c
@@ -116,6 +116,10 @@ static ssize_t rng_dev_read(struct file *filp, char __user *buf,
 		err = -EAGAIN;
 		if (!bytes_read && (filp->f_flags & O_NONBLOCK))
 			goto out;
+		if (bytes_read < 0) {
+			err = bytes_read;
+			goto out;
+		}
 
 		err = -EFAULT;
 		while (bytes_read && size) {

