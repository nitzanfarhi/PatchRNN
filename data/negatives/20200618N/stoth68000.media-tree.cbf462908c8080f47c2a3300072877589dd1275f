commit cbf462908c8080f47c2a3300072877589dd1275f
Author: Chris Lalancette <clalance@redhat.com>
Date:   Wed Jul 21 12:41:45 2010 -0700

    xen/blkback: Flush blkback data when connecting.
    
    First cut at flushing blkback data when first connecting
    blkback.  This should avoid the pygrub issues we are experiencing
    in (RedHat bugzilla) 466681.
    
    [ 2.6.18-xen.hg commit 63b4d7f56688 ]
    
    Signed-off-by: Chris Lalancette <clalance@redhat.com>
    Signed-off-by: Jeremy Fitzhardinge <jeremy.fitzhardinge@citrix.com>

diff --git a/drivers/xen/blkback/xenbus.c b/drivers/xen/blkback/xenbus.c
index c31e5c40b45c..a0534fc6a428 100644
--- a/drivers/xen/blkback/xenbus.c
+++ b/drivers/xen/blkback/xenbus.c
@@ -91,6 +91,13 @@ static void update_blkif_status(blkif_t *blkif)
 		return;
 	}
 
+	err = filemap_write_and_wait(blkif->vbd.bdev->bd_inode->i_mapping);
+	if (err) {
+		xenbus_dev_error(blkif->be->dev, err, "block flush");
+		return;
+	}
+	invalidate_inode_pages2(blkif->vbd.bdev->bd_inode->i_mapping);
+
 	blkif->xenblkd = kthread_run(blkif_schedule, blkif, name);
 	if (IS_ERR(blkif->xenblkd)) {
 		err = PTR_ERR(blkif->xenblkd);

