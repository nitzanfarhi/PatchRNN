commit f80af9e2a62bb666c5d21b04eae17dddd2e7f7c3
Author: Eduardo Silva <edsiper@gmail.com>
Date:   Tue Jan 15 21:10:05 2013 -0600

    lib: do not left stage30 until all content is sent
    
    If for some reason the send() call returns -1 because the socket
    is not yet ready to receive more data (due to non-blocking mode),
    the routine should not stop working and should try to send the
    information over and over until is fully served.
    
    This is not an expected behavior in a non-blocking server, but is
    a temporal fix until the 'pending buffers' interface is implemented.
    
    This problem was found due to #170.
    
    Signed-off-by: Eduardo Silva <edsiper@gmail.com>

diff --git a/src/mk_plugin.c b/src/mk_plugin.c
index 47f1f772..04d005be 100644
--- a/src/mk_plugin.c
+++ b/src/mk_plugin.c
@@ -702,8 +702,18 @@ int mk_plugin_stage_run(unsigned int hook,
         /* Data */
         while (clen > 0) {
             int remaining = api->socket_send(socket, content, clen);
-            if (remaining < 0) return -1;
-
+            if (remaining < 0) {
+                /*
+                 * FIXME: This is a temporal fix to send out the data,
+                 * this is working in blocking mode. This will be fixed
+                 * shortly once the 'pending buffers' interface is
+                 * implemented.
+                 */
+                if (errno == EAGAIN) {
+                    continue;
+                }
+                return -1;
+            }
             clen -= remaining;
         }
         mk_socket_set_cork_flag(socket, TCP_CORK_OFF);

