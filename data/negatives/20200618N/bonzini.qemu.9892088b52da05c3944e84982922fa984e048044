commit 9892088b52da05c3944e84982922fa984e048044
Author: Gerd Hoffmann <kraxel@redhat.com>
Date:   Fri Jan 14 10:56:54 2011 +0100

    vnc: fix numlock+capslock tracking
    
    This patch makes the numlock+capslock tracking logic only look at
    keydown events.  Without this patch the vnc server will insert
    bogous capslock keypress in case it sees the following key sequence:
    
      shift down --- 'A' down --- shift up  --- 'A' up
                                             ^ here
    
    It doesn't hurt with a PS/2 keyboard, but it disturbs the USB Keyboard.
    And with the key event queue just added to the usb keyboard the guest
    will actually notice.
    
    Signed-off-by: Gerd Hoffmann <kraxel@redhat.com>

diff --git a/ui/vnc.c b/ui/vnc.c
index 495d6d6ef1..0820d99bde 100644
--- a/ui/vnc.c
+++ b/ui/vnc.c
@@ -1504,7 +1504,7 @@ static void do_key_event(VncState *vs, int down, int keycode, int sym)
         break;
     }
 
-    if (vs->vd->lock_key_sync &&
+    if (down && vs->vd->lock_key_sync &&
         keycode_is_keypad(vs->vd->kbd_layout, keycode)) {
         /* If the numlock state needs to change then simulate an additional
            keypress before sending this one.  This will happen if the user
@@ -1523,7 +1523,7 @@ static void do_key_event(VncState *vs, int down, int keycode, int sym)
         }
     }
 
-    if (vs->vd->lock_key_sync &&
+    if (down && vs->vd->lock_key_sync &&
         ((sym >= 'A' && sym <= 'Z') || (sym >= 'a' && sym <= 'z'))) {
         /* If the capslock state needs to change then simulate an additional
            keypress before sending this one.  This will happen if the user

