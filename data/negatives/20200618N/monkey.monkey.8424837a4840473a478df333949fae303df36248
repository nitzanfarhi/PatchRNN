commit 8424837a4840473a478df333949fae303df36248
Author: Eduardo Silva <eduardo@monkey.io>
Date:   Sat Aug 16 17:27:27 2014 -0600

    Mandril: fix network address reference
    
    Signed-off-by: Eduardo Silva <eduardo@monkey.io>

diff --git a/plugins/mandril/mandril.c b/plugins/mandril/mandril.c
index 1bc1e7b2..bf901952 100644
--- a/plugins/mandril/mandril.c
+++ b/plugins/mandril/mandril.c
@@ -161,13 +161,17 @@ static int mk_security_check_ip(int socket)
     int network;
     struct mk_secure_ip_t *entry;
     struct mk_list *head;
-    struct in_addr addr_t, *addr = &addr_t;
-    socklen_t len = sizeof(addr);
+    struct in_addr *addr;
+    struct sockaddr_in addr_t;
+    socklen_t len = sizeof(addr_t);
 
-    if (getpeername(socket, (struct sockaddr *)&addr_t, &len) < 0) {
+    if (getpeername(socket, (struct sockaddr *) &addr_t, &len) != 0) {
+        perror("getpeername");
         return -1;
     }
 
+    addr = &(addr_t).sin_addr;
+
     PLUGIN_TRACE("[FD %i] Mandril validating IP address", socket);
     mk_list_foreach(head, &mk_secure_ip) {
         entry = mk_list_entry(head, struct mk_secure_ip_t, _head);
@@ -178,7 +182,6 @@ static int mk_security_check_ip(int socket)
             if (network != entry->network) {
                 continue;
             }
-
             /* Validate host range */
             if (addr->s_addr <= entry->hostmax && addr->s_addr >= entry->hostmin) {
                 PLUGIN_TRACE("[FD %i] Mandril closing by rule in ranges", socket);
@@ -337,6 +340,7 @@ int _mkp_stage_10(unsigned int socket, struct sched_connection *conx)
         PLUGIN_TRACE("[FD %i] Mandril close connection", socket);
         return MK_PLUGIN_RET_CLOSE_CONX;
     }
+
     return MK_PLUGIN_RET_CONTINUE;
 }
 

