commit 78b3321610bf920d7fceb1a0236faa881be0bcf3
Author: Srinivas Pandruvada <srinivas.pandruvada@linux.intel.com>
Date:   Thu Aug 7 22:03:00 2014 +0100

    iio:core: Handle error when mask type is not separate
    
    When event spec is shared by multiple channels, which has definition
    for mask_shared_by_type, iio_device_register_eventset fails.
    
    For example:
    static const struct iio_event_spec iio_dummy_events[] = {
            {
                    .type = IIO_EV_TYPE_THRESH,
                    .dir = IIO_EV_DIR_RISING,
                    .mask_separate = BIT(IIO_EV_INFO_ENABLE),
                    .mask_shared_by_type = BIT(IIO_EV_INFO_VALUE),
            }, {
                    .type = IIO_EV_TYPE_THRESH,
                    .dir = IIO_EV_DIR_FALLING,
                    .mask_separate = BIT(IIO_EV_INFO_ENABLE),a
                    .mask_shared_by_type = BIT(IIO_EV_INFO_VALUE),
            }
    };
    
    If two channels use this event spec, this will result in error.
    
    This change handles EBUSY error similar to iio_device_add_info_mask_type().
    
    Signed-off-by: Srinivas Pandruvada <srinivas.pandruvada@linux.intel.com>
    Signed-off-by: Jonathan Cameron <jic23@kernel.org>
    Cc: Stable@vger.kernel.org

diff --git a/drivers/iio/industrialio-event.c b/drivers/iio/industrialio-event.c
index 258a973a1fb8..bfbf4d419f41 100644
--- a/drivers/iio/industrialio-event.c
+++ b/drivers/iio/industrialio-event.c
@@ -345,6 +345,9 @@ static int iio_device_add_event(struct iio_dev *indio_dev,
 			&indio_dev->event_interface->dev_attr_list);
 		kfree(postfix);
 
+		if ((ret == -EBUSY) && (shared_by != IIO_SEPARATE))
+			continue;
+
 		if (ret)
 			return ret;
 

