commit 593224ea77b1ca842f45cf76f4deeef44dfbacd1
Author: Hans de Goede <hdegoede@redhat.com>
Date:   Tue May 31 09:18:03 2016 +0200

    USB: uas: Fix slave queue_depth not being set
    
    Commit 198de51dbc34 ("USB: uas: Limit qdepth at the scsi-host level")
    removed the scsi_change_queue_depth() call from uas_slave_configure()
    assuming that the slave would inherit the host's queue_depth, which
    that commit sets to the same value.
    
    This is incorrect, without the scsi_change_queue_depth() call the slave's
    queue_depth defaults to 1, introducing a performance regression.
    
    This commit restores the call, fixing the performance regression.
    
    Cc: stable@vger.kernel.org
    Fixes: 198de51dbc34 ("USB: uas: Limit qdepth at the scsi-host level")
    Reported-by: Tom Yan <tom.ty89@gmail.com>
    Signed-off-by: Hans de Goede <hdegoede@redhat.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

diff --git a/drivers/usb/storage/uas.c b/drivers/usb/storage/uas.c
index e03c490616ef..5ef014ba6ae8 100644
--- a/drivers/usb/storage/uas.c
+++ b/drivers/usb/storage/uas.c
@@ -836,6 +836,7 @@ static int uas_slave_configure(struct scsi_device *sdev)
 	if (devinfo->flags & US_FL_BROKEN_FUA)
 		sdev->broken_fua = 1;
 
+	scsi_change_queue_depth(sdev, devinfo->qdepth - 2);
 	return 0;
 }
 

