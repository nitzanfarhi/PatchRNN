commit ca99993adc9205c905dba5dc1bb819959ada7200
Author: Dr. David Alan Gilbert <dgilbert@redhat.com>
Date:   Mon Apr 14 17:03:59 2014 +0100

    Disallow outward migration while awaiting incoming migration
    
    QEMU will assert if you attempt to start an outgoing migration on
    a QEMU that's sitting waiting for an incoming migration (started
    with -incoming), so disallow it with a proper error.
    
    (This is a fix for https://bugzilla.redhat.com/show_bug.cgi?id=1086987 )
    
    Signed-off-by: Dr. David Alan Gilbert <dgilbert@redhat.com>
    Reviewed-by: Andreas FÃ¤rber <afaerber@suse.de>
    Reviewed-by: Eric Blake <eblake@redhat.com>
    Signed-off-by: Juan Quintela <quintela@redhat.com>

diff --git a/migration.c b/migration.c
index bd1fb912ae..ac232758b9 100644
--- a/migration.c
+++ b/migration.c
@@ -419,6 +419,11 @@ void qmp_migrate(const char *uri, bool has_blk, bool blk,
         return;
     }
 
+    if (runstate_check(RUN_STATE_INMIGRATE)) {
+        error_setg(errp, "Guest is waiting for an incoming migration");
+        return;
+    }
+
     if (qemu_savevm_state_blocked(errp)) {
         return;
     }

