commit 4b60223adb09e3f5ca6ea62fd7604f4957584dc1
Author: Greg Farnum <gregory.farnum@dreamhost.com>
Date:   Fri Jan 21 11:07:52 2011 -0800

    mds: Keep journaler in readonly mode until replay completes.
    
    Previously we were switching it off for the final non-standby replay
    when a standby-replay got activated. This caused issues
    since the states weren't quite correct!
    
    Signed-off-by: Greg Farnum <gregory.farnum@dreamhost.com>

diff --git a/src/mds/MDS.cc b/src/mds/MDS.cc
index 79372a6a2b..21d7ff74d2 100644
--- a/src/mds/MDS.cc
+++ b/src/mds/MDS.cc
@@ -1272,12 +1272,13 @@ void MDS::replay_done()
   }
 
   if (continue_replay) {
-    mdlog->get_journaler()->set_writeable();
     continue_replay = false;
     standby_replay_restart();
     return;
   }
 
+  mdlog->get_journaler()->set_writeable();
+
   if (g_conf.mds_wipe_sessions) {
     dout(1) << "wiping out client sessions" << dendl;
     sessionmap.wipe();

