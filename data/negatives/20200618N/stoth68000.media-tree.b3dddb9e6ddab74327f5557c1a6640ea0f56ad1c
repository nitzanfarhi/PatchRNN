commit b3dddb9e6ddab74327f5557c1a6640ea0f56ad1c
Author: Amit Shah <amit.shah@redhat.com>
Date:   Thu Sep 2 18:11:45 2010 +0530

    virtio: console: Make read() return -ENODEV on hot-unplug
    
    When a port is hot-unplugged while an app was blocked on a read() call,
    the call was unblocked but would not get an error returned.
    
    Return -ENODEV to ensure the app knows the port has gone away.
    
    Signed-off-by: Amit Shah <amit.shah@redhat.com>
    Signed-off-by: Rusty Russell <rusty@rustcorp.com.au>

diff --git a/drivers/char/virtio_console.c b/drivers/char/virtio_console.c
index 47b710ca4ab3..e17ecf5d42b5 100644
--- a/drivers/char/virtio_console.c
+++ b/drivers/char/virtio_console.c
@@ -582,6 +582,9 @@ static ssize_t port_fops_read(struct file *filp, char __user *ubuf,
 		if (ret < 0)
 			return ret;
 	}
+	/* Port got hot-unplugged. */
+	if (!port->guest_connected)
+		return -ENODEV;
 	/*
 	 * We could've received a disconnection message while we were
 	 * waiting for more data.

