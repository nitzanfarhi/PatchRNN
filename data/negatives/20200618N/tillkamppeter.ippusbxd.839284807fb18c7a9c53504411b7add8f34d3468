commit 839284807fb18c7a9c53504411b7add8f34d3468
Author: Daniel Dressler <danieru.dressler@gmail.com>
Date:   Thu Jul 24 13:10:34 2014 -0600

    Check send() return values

diff --git a/src/tcp.c b/src/tcp.c
index 5abe60b..532c32a 100644
--- a/src/tcp.c
+++ b/src/tcp.c
@@ -135,10 +135,23 @@ error:
 	return NULL;
 }
 
+// TODO: handle EPIPE and SIGPIPE with MSG_NOSIGNAL and check for pipe closures
 void tcp_packet_send(struct tcp_conn_t *conn, struct http_packet_t *pkt)
 {
-	send(conn->sd, pkt->buffer, pkt->filled_size, 0);
-	NOTE("TCP: sent %lu bytes", pkt->filled_size);
+	ssize_t remaining = pkt->filled_size;
+	ssize_t total = 0;
+	while (remaining > 0) {
+		ssize_t sent = send(conn->sd, pkt->buffer + total,
+		                    remaining, 0);
+		if (sent < 0) {
+			ERR("Failed to sent data over TCP");
+			exit(-1); // TODO: unify exits
+		}
+
+		total += sent;
+		remaining -= sent;
+	}
+	NOTE("TCP: sent %lu bytes", total);
 }
 
 

