commit abf45dbb5b256dab439ca3b6b71191ecfddf9cb6
Author: Michael S. Tsirkin <mst@mellanox.co.il>
Date:   Wed Apr 5 15:47:16 2006 +0300

    IB/mthca: Disable tuning PCI read burst size
    
    The PCI spec recommends against drivers playing with a device's PCI
    read burst size, and says that systems software should configure it.
    And we actually have users that report that changing it from the
    default set by BIOS hurts performance and/or stability for them.  On
    the other hand, the Mellanox Programmer's Reference Manual recommends
    turning it up all the way to the maximum value.  Some tests conducted
    here in the lab do not show performance improvement from this tuning,
    but this might be just me.
    
    As a work-around, make this tuning an option, off by default (safe
    value), with an eye towards removing it completely one day if no one
    complains.
    
    Signed-off-by: Michael S. Tsirkin <mst@mellanox.co.il>
    Signed-off-by: Roland Dreier <rolandd@cisco.com>

diff --git a/drivers/infiniband/hw/mthca/mthca_main.c b/drivers/infiniband/hw/mthca/mthca_main.c
index 0dc5b8da0007..7e9c97b09404 100644
--- a/drivers/infiniband/hw/mthca/mthca_main.c
+++ b/drivers/infiniband/hw/mthca/mthca_main.c
@@ -77,6 +77,10 @@ MODULE_PARM_DESC(msi, "attempt to use MSI if nonzero");
 
 #endif /* CONFIG_PCI_MSI */
 
+static int tune_pci = 0;
+module_param(tune_pci, int, 0444);
+MODULE_PARM_DESC(tune_pci, "increase PCI burst from the default set by BIOS if nonzero");
+
 static const char mthca_version[] __devinitdata =
 	DRV_NAME ": Mellanox InfiniBand HCA driver v"
 	DRV_VERSION " (" DRV_RELDATE ")\n";
@@ -98,6 +102,9 @@ static int __devinit mthca_tune_pci(struct mthca_dev *mdev)
 	int cap;
 	u16 val;
 
+	if (!tune_pci)
+		return 0;
+
 	/* First try to max out Read Byte Count */
 	cap = pci_find_capability(mdev->pdev, PCI_CAP_ID_PCIX);
 	if (cap) {

