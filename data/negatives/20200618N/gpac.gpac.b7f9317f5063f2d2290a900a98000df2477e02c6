commit b7f9317f5063f2d2290a900a98000df2477e02c6
Author: nguyen-viet-thanh-trung <viet-thanh-trung.nguyen@telecom-paristech.fr>
Date:   Mon Nov 16 14:31:17 2015 +0100

    fixed bug while handling PCR discontinuity

diff --git a/include/gpac/internal/terminal_dev.h b/include/gpac/internal/terminal_dev.h
index 7c65ef38e..a32d2d042 100644
--- a/include/gpac/internal/terminal_dev.h
+++ b/include/gpac/internal/terminal_dev.h
@@ -561,6 +561,8 @@ struct _object_clock
 	//media time in ms corresponding to the init tmiestamp of the clock
 	u32 media_time_at_init;
 	Bool has_media_time_shift;
+
+	u16 ocr_on_esid;
 };
 
 /*destroys clock*/
diff --git a/src/terminal/channel.c b/src/terminal/channel.c
index d1d418c4b..0869e6122 100644
--- a/src/terminal/channel.c
+++ b/src/terminal/channel.c
@@ -199,6 +199,8 @@ Bool gf_es_owns_clock(GF_Channel *ch)
 {
 	/*if the clock is not in the same namespace (used with dynamic scenes), it's not ours*/
 	if (gf_list_find(ch->odm->net_service->Clocks, ch->clock)<0) return 0;
+	/*It occurs in TS stream when PCR is provided in a dedicated stream. Suppose that the channel owns a clock*/
+	if (ch->clock->ocr_on_esid) return 1;
 	return (ch->esd->ESID==ch->clock->clockID) ? 1 : 0;
 }
 
@@ -930,6 +932,15 @@ void gf_es_receive_sl_packet(GF_ClientService *serv, GF_Channel *ch, char *paylo
 	if (ch->odm->parentscene && ch->odm->parentscene->root_od->addon)
 		hdr.OCRflag = 0;
 
+	if (hdr.OCRflag) {
+		if (!ch->clock->ocr_on_esid) {
+			ch->clock->ocr_on_esid = ch->esd->ESID;
+		} else if (ch->esd->ESID != ch->clock->ocr_on_esid) {
+			GF_LOG(GF_LOG_WARNING, GF_LOG_SYNC, ("[SyncLayer] Receiving OCR from a different channel (ES%d vs previous ES%d)\n", ch->esd->ESID, ch->clock->ocr_on_esid ));
+		}
+
+	}
+
 	/*we ignore OCRs for the moment*/
 	if (hdr.OCRflag==1) {
 		if (!ch->IsClockInit) {

