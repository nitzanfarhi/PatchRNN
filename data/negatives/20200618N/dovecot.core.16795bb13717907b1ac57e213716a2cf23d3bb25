commit 16795bb13717907b1ac57e213716a2cf23d3bb25
Author: Timo Sirainen <tss@iki.fi>
Date:   Sun Jul 3 18:14:40 2005 +0300

    Don't crash if hdr.message-id isn't set in cache file.
    
    --HG--
    branch : HEAD

diff --git a/src/lib-storage/index/index-mail.c b/src/lib-storage/index/index-mail.c
index ac3897e3d..37281e1f1 100644
--- a/src/lib-storage/index/index-mail.c
+++ b/src/lib-storage/index/index-mail.c
@@ -802,8 +802,9 @@ int index_mail_set_seq(struct mail *_mail, uint32_t seq)
 		unsigned int cache_field2 =
 			cache_fields[MAIL_CACHE_IMAP_ENVELOPE].idx;
 
-		if (mail_cache_field_exists(cache_view, seq,
-					    cache_field1) == 0 &&
+		if ((cache_field1 == (unsigned int)-1 ||
+		     mail_cache_field_exists(cache_view, seq,
+					     cache_field1) == 0) &&
 		    mail_cache_field_exists(cache_view, seq,
 					    cache_field2) == 0)
 			data->access_part |= PARSE_HDR;

