commit e350aa54617be30978af193b3c9ecc8dcae2b7f9
Author: mwilliams <mwilliams@fb.com>
Date:   Mon Apr 8 16:02:46 2013 -0700

    Prevent elimination of stores to generator params
    
    After some recent cleanup to generators, local analysis was
    able to remove some stores that it shouldnt have done, because
    it didnt take account of the fact that the locals were
    generator parameters.

diff --git a/hphp/compiler/analysis/variable_table.cpp b/hphp/compiler/analysis/variable_table.cpp
index fc9df2aa2a..208fd9c134 100644
--- a/hphp/compiler/analysis/variable_table.cpp
+++ b/hphp/compiler/analysis/variable_table.cpp
@@ -178,6 +178,8 @@ bool VariableTable::isLocal(const Symbol *sym) const {
     */
     return (!sym->isStatic() &&
             !sym->isGlobal() &&
+            !sym->isGeneratorParameter() &&
+            !sym->isRefGeneratorParameter() &&
             !sym->isParameter());
   }
   return false;
diff --git a/hphp/test/test_code_run.cpp b/hphp/test/test_code_run.cpp
index 84aa0c26c9..bf9962a965 100644
--- a/hphp/test/test_code_run.cpp
+++ b/hphp/test/test_code_run.cpp
@@ -26390,6 +26390,26 @@ bool TestCodeRun::TestYield() {
         "bool(false)\n"
         "NULL\n");
 
+  MVCRO("<?php "
+        "function gen(&$x) {"
+        "  $x = 1;"
+        "  yield 1;"
+        "  $x = 2;"
+        "  yield 3;"
+        "  $x = 4;"
+        "}"
+        "function test() {"
+        "  $x = 0;"
+        "  foreach (gen($x) as $y) {"
+        "    var_dump($y);"
+        "  }"
+        "  var_dump($x);"
+        "}"
+        "test();",
+        "int(1)\n"
+        "int(3)\n"
+        "int(4)\n");
+
   return true;
 }
 

