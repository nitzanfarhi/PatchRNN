commit 86ca9eac31d0d8c4fe61b5726e6d63197bc435a6
Author: Johan Hedberg <johan.hedberg@intel.com>
Date:   Tue Nov 5 11:30:39 2013 +0200

    Bluetooth: Fix rejecting SMP security request in slave role
    
    The SMP security request is for a slave role device to request the
    master role device to initiate a pairing request. If we receive this
    command while we're in the slave role we should reject it appropriately.
    
    Signed-off-by: Johan Hedberg <johan.hedberg@intel.com>
    Signed-off-by: Marcel Holtmann <marcel@holtmann.org>

diff --git a/net/bluetooth/smp.c b/net/bluetooth/smp.c
index b5562abdd6e0..ccad6c1e3ec3 100644
--- a/net/bluetooth/smp.c
+++ b/net/bluetooth/smp.c
@@ -739,6 +739,9 @@ static u8 smp_cmd_security_req(struct l2cap_conn *conn, struct sk_buff *skb)
 
 	BT_DBG("conn %p", conn);
 
+	if (!(conn->hcon->link_mode & HCI_LM_MASTER))
+		return SMP_CMD_NOTSUPP;
+
 	hcon->pending_sec_level = authreq_to_seclevel(rp->auth_req);
 
 	if (smp_ltk_encrypt(conn, hcon->pending_sec_level))

