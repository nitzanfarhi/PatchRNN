commit 80ceb057135ad77f513277f3bcd04b885501877a
Author: Namhyung Kim <namhyung@gmail.com>
Date:   Mon Jun 20 13:27:44 2011 +0200

    bsg: fix bsg_poll() to return POLLOUT properly
    
    POLLOUT should be returned only if bd->queued_cmds < bd->max_queue
    so that bsg_alloc_command() can proceed.
    
    Signed-off-by: Namhyung Kim <namhyung@gmail.com>
    Acked-by: FUJITA Tomonori <fujita.tomonori@lab.ntt.co.jp>
    Signed-off-by: Jens Axboe <jaxboe@fusionio.com>

diff --git a/block/bsg.c b/block/bsg.c
index 0c8b64a16484..c4f49e255751 100644
--- a/block/bsg.c
+++ b/block/bsg.c
@@ -878,7 +878,7 @@ static unsigned int bsg_poll(struct file *file, poll_table *wait)
 	spin_lock_irq(&bd->lock);
 	if (!list_empty(&bd->done_list))
 		mask |= POLLIN | POLLRDNORM;
-	if (bd->queued_cmds >= bd->max_queue)
+	if (bd->queued_cmds < bd->max_queue)
 		mask |= POLLOUT;
 	spin_unlock_irq(&bd->lock);
 

