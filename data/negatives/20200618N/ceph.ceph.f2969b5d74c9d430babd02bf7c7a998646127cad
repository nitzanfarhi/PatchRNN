commit f2969b5d74c9d430babd02bf7c7a998646127cad
Author: Jin Cai <caijin.caij@alibaba-inc.com>
Date:   Wed Sep 13 10:32:08 2017 +0800

    msg/asyc/rmda: fix the bug of assert when Infiniband::recv_msg receives
    disconnect message
    
    Signed-off-by: Jin Cai <caijin.caij@alibaba-inc.com>

diff --git a/src/msg/async/rdma/RDMAConnectedSocketImpl.cc b/src/msg/async/rdma/RDMAConnectedSocketImpl.cc
index 90fc8e5707..8f2ac4a59c 100644
--- a/src/msg/async/rdma/RDMAConnectedSocketImpl.cc
+++ b/src/msg/async/rdma/RDMAConnectedSocketImpl.cc
@@ -200,7 +200,7 @@ int RDMAConnectedSocketImpl::try_connect(const entity_addr_t& peer_addr, const S
 void RDMAConnectedSocketImpl::handle_connection() {
   ldout(cct, 20) << __func__ << " QP: " << my_msg.qpn << " tcp_fd: " << tcp_fd << " notify_fd: " << notify_fd << dendl;
   int r = infiniband->recv_msg(cct, tcp_fd, peer_msg);
-  if (r < 0) {
+  if (r <= 0) {
     if (r != -EAGAIN) {
       dispatcher->perf_logger->inc(l_msgr_rdma_handshake_errors);
       ldout(cct, 1) << __func__ << " recv handshake msg failed." << dendl;

