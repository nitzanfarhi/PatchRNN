commit 4d1a63b21b4f77a82efe7d78fc1ae1cc7532691c
Author: David Sterba <dsterba@suse.cz>
Date:   Mon Feb 3 19:24:19 2014 +0100

    btrfs: send: remove BUG from process_all_refs
    
    There are only 2 static callers, the BUG would normally be never
    reached, but let's be nice.
    
    Signed-off-by: David Sterba <dsterba@suse.cz>
    Signed-off-by: Josef Bacik <jbacik@fb.com>

diff --git a/fs/btrfs/send.c b/fs/btrfs/send.c
index 4405aae05281..d3ed9df77422 100644
--- a/fs/btrfs/send.c
+++ b/fs/btrfs/send.c
@@ -3606,7 +3606,10 @@ static int process_all_refs(struct send_ctx *sctx,
 		root = sctx->parent_root;
 		cb = __record_deleted_ref;
 	} else {
-		BUG();
+		btrfs_err(sctx->send_root->fs_info,
+				"Wrong command %d in process_all_refs", cmd);
+		ret = -EINVAL;
+		goto out;
 	}
 
 	key.objectid = sctx->cmp_key->objectid;

