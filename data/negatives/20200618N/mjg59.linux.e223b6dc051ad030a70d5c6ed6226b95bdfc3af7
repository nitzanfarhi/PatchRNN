commit e223b6dc051ad030a70d5c6ed6226b95bdfc3af7
Author: Rami Rosen <ramirose@gmail.com>
Date:   Wed Jan 14 00:00:13 2009 +0200

    rt2x00: fix a wrong parameter for __test_and_clear_bit() in rt2x00rfkill_free().
    
    When running modprobe rt73usb, and then rmmod rt73usb, and then
    iwconfig, the wlan0 device does not disappear. When repeating this
    process again, we get a kernel Oops errors and "BUG: unable to handle
    kernel paging request..." message in the kernel log.
    
    The reason for this is that there is an error in rt2x00rfkill_free(),
    which is called in the process of removing the device
    (rt2x00lib_remove_dev() in rt2x00dev.c).
    rt2x00rfkill_free() clears the RFKILL_STATE_ALLOCATED bit , which is
    bit number 1 () in rt2x00dev->flags instead of in
    rt2x00dev->rfkill_state. As a result, when checking the
    DEVICE_STATE_REGISTERED_HW bit (bit number 1 in rt2x00dev->flags) in
    rt2x00lib_remove_hw() it is **unset**, and we wrongly **don't** call
    ieee80211_unregister_hw().
    
    This patch corrects this: the parameter for __test_and_clear_bit() in
    rt2x00rfkill_free() should be &rt2x00dev->rfkill_state and not
    &rt2x00dev->flags.
    
    Signed-off-by: Rami Rosen <ramirose@gmail.com>
    Acked-by: Ivo van Doorn <IvDoorn@gmail.com>
    Signed-off-by: John W. Linville <linville@tuxdriver.com>

diff --git a/drivers/net/wireless/rt2x00/rt2x00rfkill.c b/drivers/net/wireless/rt2x00/rt2x00rfkill.c
index c3f53a92180a..3298cae1e12d 100644
--- a/drivers/net/wireless/rt2x00/rt2x00rfkill.c
+++ b/drivers/net/wireless/rt2x00/rt2x00rfkill.c
@@ -162,7 +162,7 @@ void rt2x00rfkill_allocate(struct rt2x00_dev *rt2x00dev)
 
 void rt2x00rfkill_free(struct rt2x00_dev *rt2x00dev)
 {
-	if (!test_bit(RFKILL_STATE_ALLOCATED, &rt2x00dev->flags))
+	if (!test_bit(RFKILL_STATE_ALLOCATED, &rt2x00dev->rfkill_state))
 		return;
 
 	cancel_delayed_work_sync(&rt2x00dev->rfkill_work);

