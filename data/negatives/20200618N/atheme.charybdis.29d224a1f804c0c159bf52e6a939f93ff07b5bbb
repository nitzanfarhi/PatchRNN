commit 29d224a1f804c0c159bf52e6a939f93ff07b5bbb
Author: Keith Buck <mr_flea@esper.net>
Date:   Sat Feb 18 05:16:03 2012 +0000

    ip_cloaking*: Do qjm locally too.

diff --git a/extensions/ip_cloaking.c b/extensions/ip_cloaking.c
index 2aeefe73..e19de0ef 100644
--- a/extensions/ip_cloaking.c
+++ b/extensions/ip_cloaking.c
@@ -47,25 +47,28 @@ DECLARE_MODULE_AV1(ip_cloaking, _modinit, _moddeinit, NULL, NULL,
 			ip_cloaking_hfnlist, "$Revision: 3526 $");
 
 static void
-distribute_hostchange(struct Client *client)
+distribute_hostchange(struct Client *client_p, char *newhost)
 {
-	if (irccmp(client->host, client->orighost))
-		sendto_one_numeric(client, RPL_HOSTHIDDEN, "%s :is now your hidden host",
-			client->host);
+	if (newhost != client_p->orighost)
+		sendto_one_numeric(client_p, RPL_HOSTHIDDEN, "%s :is now your hidden host",
+			client_p->host);
 	else
-		sendto_one_numeric(client, RPL_HOSTHIDDEN, "%s :hostname reset",
-			client->host);
+		sendto_one_numeric(client_p, RPL_HOSTHIDDEN, "%s :hostname reset",
+			client_p->host);
 
 	sendto_server(NULL, NULL,
 		CAP_EUID | CAP_TS6, NOCAPS, ":%s CHGHOST %s :%s",
-		use_id(&me), use_id(client), client->host);
+		use_id(&me), use_id(client_p), client_p->host);
 	sendto_server(NULL, NULL,
 		CAP_TS6, CAP_EUID, ":%s ENCAP * CHGHOST %s :%s",
-		use_id(&me), use_id(client), client->host);
-	if (irccmp(client->host, client->orighost))
-		SetDynSpoof(client);
+		use_id(&me), use_id(client_p), client_p->host);
+
+	change_nick_user_host(client_p, client_p->name, client_p->username, newhost, 0, "Changing host");
+
+	if (newhost != client_p->orighost)
+		SetDynSpoof(client_p);
 	else
-		ClearDynSpoof(client);
+		ClearDynSpoof(client_p);
 }
 
 static void
@@ -179,8 +182,7 @@ check_umode_change(void *vdata)
 		}
 		if (strcmp(source_p->host, source_p->localClient->mangledhost))
 		{
-			rb_strlcpy(source_p->host, source_p->localClient->mangledhost, HOSTLEN + 1);
-			distribute_hostchange(source_p);
+			distribute_hostchange(source_p, source_p->localClient->mangledhost);
 		}
 		else /* not really nice, but we need to send this numeric here */
 			sendto_one_numeric(source_p, RPL_HOSTHIDDEN, "%s :is now your hidden host",
@@ -191,8 +193,7 @@ check_umode_change(void *vdata)
 		if (source_p->localClient->mangledhost != NULL &&
 				!strcmp(source_p->host, source_p->localClient->mangledhost))
 		{
-			rb_strlcpy(source_p->host, source_p->orighost, HOSTLEN + 1);
-			distribute_hostchange(source_p);
+			distribute_hostchange(source_p, source_p->orighost);
 		}
 	}
 }
diff --git a/extensions/ip_cloaking_3.0.c b/extensions/ip_cloaking_3.0.c
index 19393956..136c3016 100644
--- a/extensions/ip_cloaking_3.0.c
+++ b/extensions/ip_cloaking_3.0.c
@@ -44,25 +44,28 @@ DECLARE_MODULE_AV1(ip_cloaking, _modinit, _moddeinit, NULL, NULL,
 			ip_cloaking_hfnlist, "$Revision: 3526 $");
 
 static void
-distribute_hostchange(struct Client *client)
+distribute_hostchange(struct Client *client_p, char *newhost)
 {
-	if (irccmp(client->host, client->orighost))
-		sendto_one_numeric(client, RPL_HOSTHIDDEN, "%s :is now your hidden host",
-			client->host);
+	if (newhost != client_p->orighost)
+		sendto_one_numeric(client_p, RPL_HOSTHIDDEN, "%s :is now your hidden host",
+			client_p->host);
 	else
-		sendto_one_numeric(client, RPL_HOSTHIDDEN, "%s :hostname reset",
-			client->host);
+		sendto_one_numeric(client_p, RPL_HOSTHIDDEN, "%s :hostname reset",
+			client_p->host);
 
 	sendto_server(NULL, NULL,
 		CAP_EUID | CAP_TS6, NOCAPS, ":%s CHGHOST %s :%s",
-		use_id(&me), use_id(client), client->host);
+		use_id(&me), use_id(client_p), client_p->host);
 	sendto_server(NULL, NULL,
 		CAP_TS6, CAP_EUID, ":%s ENCAP * CHGHOST %s :%s",
-		use_id(&me), use_id(client), client->host);
-	if (irccmp(client->host, client->orighost))
-		SetDynSpoof(client);
+		use_id(&me), use_id(client_p), client_p->host);
+
+	change_nick_user_host(client_p, client_p->name, client_p->username, newhost, 0, "Changing host");
+
+	if (newhost != client_p->orighost)
+		SetDynSpoof(client_p);
 	else
-		ClearDynSpoof(client);
+		ClearDynSpoof(client_p);
 }
 
 #define Nval 0x8c3a48ac
@@ -186,8 +189,7 @@ check_umode_change(void *vdata)
 		}
 		if (strcmp(source_p->host, source_p->localClient->mangledhost))
 		{
-			rb_strlcpy(source_p->host, source_p->localClient->mangledhost, HOSTLEN);
-			distribute_hostchange(source_p);
+			distribute_hostchange(source_p, source_p->localClient->mangledhost);
 		}
 		else /* not really nice, but we need to send this numeric here */
 			sendto_one_numeric(source_p, RPL_HOSTHIDDEN, "%s :is now your hidden host",
@@ -198,8 +200,7 @@ check_umode_change(void *vdata)
 		if (source_p->localClient->mangledhost != NULL &&
 				!strcmp(source_p->host, source_p->localClient->mangledhost))
 		{
-			rb_strlcpy(source_p->host, source_p->orighost, HOSTLEN);
-			distribute_hostchange(source_p);
+			distribute_hostchange(source_p, source_p->orighost);
 		}
 	}
 }
diff --git a/extensions/ip_cloaking_4.0.c b/extensions/ip_cloaking_4.0.c
index cc92360f..e0ce6d55 100644
--- a/extensions/ip_cloaking_4.0.c
+++ b/extensions/ip_cloaking_4.0.c
@@ -47,25 +47,28 @@ DECLARE_MODULE_AV1(ip_cloaking, _modinit, _moddeinit, NULL, NULL,
 			ip_cloaking_hfnlist, "$Revision: 3526 $");
 
 static void
-distribute_hostchange(struct Client *client)
+distribute_hostchange(struct Client *client_p, char *newhost)
 {
-	if (irccmp(client->host, client->orighost))
-		sendto_one_numeric(client, RPL_HOSTHIDDEN, "%s :is now your hidden host",
-			client->host);
+	if (newhost != client_p->orighost)
+		sendto_one_numeric(client_p, RPL_HOSTHIDDEN, "%s :is now your hidden host",
+			client_p->host);
 	else
-		sendto_one_numeric(client, RPL_HOSTHIDDEN, "%s :hostname reset",
-			client->host);
+		sendto_one_numeric(client_p, RPL_HOSTHIDDEN, "%s :hostname reset",
+			client_p->host);
 
 	sendto_server(NULL, NULL,
 		CAP_EUID | CAP_TS6, NOCAPS, ":%s CHGHOST %s :%s",
-		use_id(&me), use_id(client), client->host);
+		use_id(&me), use_id(client_p), client_p->host);
 	sendto_server(NULL, NULL,
 		CAP_TS6, CAP_EUID, ":%s ENCAP * CHGHOST %s :%s",
-		use_id(&me), use_id(client), client->host);
-	if (irccmp(client->host, client->orighost))
-		SetDynSpoof(client);
+		use_id(&me), use_id(client_p), client_p->host);
+
+	change_nick_user_host(client_p, client_p->name, client_p->username, newhost, 0, "Changing host");
+
+	if (newhost != client_p->orighost)
+		SetDynSpoof(client_p);
 	else
-		ClearDynSpoof(client);
+		ClearDynSpoof(client_p);
 }
 
 static void
@@ -179,8 +182,7 @@ check_umode_change(void *vdata)
 		}
 		if (strcmp(source_p->host, source_p->localClient->mangledhost))
 		{
-			rb_strlcpy(source_p->host, source_p->localClient->mangledhost, HOSTLEN + 1);
-			distribute_hostchange(source_p);
+			distribute_hostchange(source_p, source_p->localClient->mangledhost);
 		}
 		else /* not really nice, but we need to send this numeric here */
 			sendto_one_numeric(source_p, RPL_HOSTHIDDEN, "%s :is now your hidden host",
@@ -191,8 +193,7 @@ check_umode_change(void *vdata)
 		if (source_p->localClient->mangledhost != NULL &&
 				!strcmp(source_p->host, source_p->localClient->mangledhost))
 		{
-			rb_strlcpy(source_p->host, source_p->orighost, HOSTLEN + 1);
-			distribute_hostchange(source_p);
+			distribute_hostchange(source_p, source_p->orighost);
 		}
 	}
 }
diff --git a/extensions/ip_cloaking_old.c b/extensions/ip_cloaking_old.c
index 16406536..9f309649 100644
--- a/extensions/ip_cloaking_old.c
+++ b/extensions/ip_cloaking_old.c
@@ -44,25 +44,28 @@ DECLARE_MODULE_AV1(ip_cloaking, _modinit, _moddeinit, NULL, NULL,
 			ip_cloaking_hfnlist, "$Revision: 3522 $");
 
 static void
-distribute_hostchange(struct Client *client)
+distribute_hostchange(struct Client *client_p, char *newhost)
 {
-	if (irccmp(client->host, client->orighost))
-		sendto_one_numeric(client, RPL_HOSTHIDDEN, "%s :is now your hidden host",
-			client->host);
+	if (newhost != client_p->orighost)
+		sendto_one_numeric(client_p, RPL_HOSTHIDDEN, "%s :is now your hidden host",
+			client_p->host);
 	else
-		sendto_one_numeric(client, RPL_HOSTHIDDEN, "%s :hostname reset",
-			client->host);
+		sendto_one_numeric(client_p, RPL_HOSTHIDDEN, "%s :hostname reset",
+			client_p->host);
 
 	sendto_server(NULL, NULL,
 		CAP_EUID | CAP_TS6, NOCAPS, ":%s CHGHOST %s :%s",
-		use_id(&me), use_id(client), client->host);
+		use_id(&me), use_id(client_p), client_p->host);
 	sendto_server(NULL, NULL,
 		CAP_TS6, CAP_EUID, ":%s ENCAP * CHGHOST %s :%s",
-		use_id(&me), use_id(client), client->host);
-	if (irccmp(client->host, client->orighost))
-		SetDynSpoof(client);
+		use_id(&me), use_id(client_p), client_p->host);
+
+	change_nick_user_host(client_p, client_p->name, client_p->username, newhost, 0, "Changing host");
+
+	if (newhost != client_p->orighost)
+		SetDynSpoof(client_p);
 	else
-		ClearDynSpoof(client);
+		ClearDynSpoof(client_p);
 }
 
 static void
@@ -128,8 +131,7 @@ check_umode_change(void *vdata)
 		}
 		if (strcmp(source_p->host, source_p->localClient->mangledhost))
 		{
-			rb_strlcpy(source_p->host, source_p->localClient->mangledhost, HOSTLEN);
-			distribute_hostchange(source_p);
+			distribute_hostchange(source_p, source_p->localClient->mangledhost);
 		}
 		else /* not really nice, but we need to send this numeric here */
 			sendto_one_numeric(source_p, RPL_HOSTHIDDEN, "%s :is now your hidden host",
@@ -140,8 +142,7 @@ check_umode_change(void *vdata)
 		if (source_p->localClient->mangledhost != NULL &&
 				!strcmp(source_p->host, source_p->localClient->mangledhost))
 		{
-			rb_strlcpy(source_p->host, source_p->orighost, HOSTLEN);
-			distribute_hostchange(source_p);
+			distribute_hostchange(source_p, source_p->orighost);
 		}
 	}
 }

