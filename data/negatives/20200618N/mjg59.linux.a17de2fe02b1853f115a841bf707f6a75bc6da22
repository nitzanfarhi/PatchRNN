commit a17de2fe02b1853f115a841bf707f6a75bc6da22
Author: Johan Hedberg <johan.hedberg@intel.com>
Date:   Tue May 14 13:25:37 2013 +0300

    Bluetooth: Allow l2cap_chan_check_security() to be used for LE links.
    
    With connection oriented L2CAP channels some code paths will be shared
    with BR/EDR links. It is therefore necessary to allow the
    l2cap_chan_check_security function to be usable also for LE links in
    addition to BR/EDR ones. This means that smp_conn_security() needs to be
    called instead of hci_conn_security() in the case of an LE link.
    
    Signed-off-by: Johan Hedberg <johan.hedberg@intel.com>
    Signed-off-by: Marcel Holtmann <marcel@holtmann.org>

diff --git a/net/bluetooth/l2cap_core.c b/net/bluetooth/l2cap_core.c
index 03b641c2f39d..510a17cefd26 100644
--- a/net/bluetooth/l2cap_core.c
+++ b/net/bluetooth/l2cap_core.c
@@ -726,6 +726,9 @@ int l2cap_chan_check_security(struct l2cap_chan *chan)
 	struct l2cap_conn *conn = chan->conn;
 	__u8 auth_type;
 
+	if (conn->hcon->type == LE_LINK)
+		return smp_conn_security(conn->hcon, chan->sec_level);
+
 	auth_type = l2cap_get_auth_type(chan);
 
 	return hci_conn_security(conn->hcon, chan->sec_level, auth_type);

