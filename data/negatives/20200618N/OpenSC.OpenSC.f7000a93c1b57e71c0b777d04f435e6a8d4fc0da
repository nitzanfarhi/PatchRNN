commit f7000a93c1b57e71c0b777d04f435e6a8d4fc0da
Author: martin <martin@c6295689-39f2-0310-b995-f0e70906c6a9>
Date:   Wed Oct 20 08:48:56 2010 +0000

    EstEID: add workarond for a buggy card.
    
    git-svn-id: https://www.opensc-project.org/svnp/opensc/trunk@4819 c6295689-39f2-0310-b995-f0e70906c6a9

diff --git a/src/libopensc/card-mcrd.c b/src/libopensc/card-mcrd.c
index 5eca0cf2..728918ec 100644
--- a/src/libopensc/card-mcrd.c
+++ b/src/libopensc/card-mcrd.c
@@ -40,6 +40,7 @@ static struct sc_atr_table mcrd_atrs[] = {
 	  "D-Trust", SC_CARD_TYPE_MCRD_DTRUST, 0, NULL},
 	{"3b:ff:11:00:ff:80:b1:fe:45:1f:03:00:68:d2:76:00:00:28:ff:05:1e:31:80:00:90:00:a6", NULL,
 	  "D-Trust", SC_CARD_TYPE_MCRD_DTRUST, 0, NULL},
+	{"3b:fe:94:00:ff:80:b1:fa:45:1f:03:45:73:74:45:49:44:20:76:65:72:20:31:2e:30:43", NULL, "Digi-ID", SC_CARD_TYPE_MCRD_ESTEID_DIGI, 0, NULL},
 	{NULL, NULL, NULL, 0, 0, NULL}
 };
 
@@ -260,7 +261,8 @@ static int is_esteid_atr(u8 *atr, size_t atr_len) {
 
 static int mcrd_match_card(sc_card_t * card)
 {
-	int i;
+	if (_sc_match_atr(card, mcrd_atrs, &card->type) >= 0)
+		return 1;
 
 	if (is_esteid_atr(card->atr, card->atr_len)) {
 		sc_debug(card->ctx, SC_LOG_DEBUG_NORMAL, "Found EstEID ver 1.0 card!");
@@ -268,10 +270,7 @@ static int mcrd_match_card(sc_card_t * card)
 		return 1;
 	}
 
-	i = _sc_match_atr(card, mcrd_atrs, &card->type);
-	if (i < 0)
-		return 0;
-	return 1;
+	return 0;
 }
 
 static int mcrd_init(sc_card_t * card)
@@ -306,6 +305,11 @@ static int mcrd_init(sc_card_t * card)
 	/* The special file loading thing doesn't work for EstEID */
 	if (card->type != SC_CARD_TYPE_MCRD_ESTEID)
 		load_special_files(card);
+
+	/* The MULTOS Digi-ID card is dumb and buggy and requires a reset before use. */	
+	if (card->type != SC_CARD_TYPE_MCRD_ESTEID_DIGI)
+		sc_reset(card);		
+
 	return SC_SUCCESS;
 }
 
diff --git a/src/libopensc/cards.h b/src/libopensc/cards.h
index 01d3d322..f3a5373e 100644
--- a/src/libopensc/cards.h
+++ b/src/libopensc/cards.h
@@ -74,6 +74,7 @@ enum {
 	SC_CARD_TYPE_MCRD_BASE = 5000,
 	SC_CARD_TYPE_MCRD_GENERIC,
 	SC_CARD_TYPE_MCRD_ESTEID,
+	SC_CARD_TYPE_MCRD_ESTEID_DIGI,
 	SC_CARD_TYPE_MCRD_DTRUST,
 
 	/* setcos driver */

