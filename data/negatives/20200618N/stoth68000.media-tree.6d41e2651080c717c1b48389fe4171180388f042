commit 6d41e2651080c717c1b48389fe4171180388f042
Author: Larry Finger <Larry.Finger@lwfinger.net>
Date:   Tue Jun 20 09:19:18 2006 -0500

    [PATCH] 2.6.17 missing a call to ieee80211softmac_capabilities from ieee80211softmac_assoc_req
    
    In commit ba9b28d19a3251bb1dfe6a6f8cc89b96fb85f683, routine
    ieee80211softmac_capabilities was added to ieee80211softmac_io.c. As
    denoted by its name, it completes the capabilities IE that is
    needed in the associate and reassociate requests sent to the
    AP. For at least one AP, the Linksys WRT54G V5, the capabilities
    field must set the 'short preamble' bit or the AP refuses to
    associate. In the commit noted above, there is a call to the
    new routine from ieee80211softmac_reassoc_req, but not from
    ieee80211softmac_assoc_req. This patch fixes that oversight.
    
    As noted in the subject, v2.6.17 is affected. My bcm43xx card had been
    unable to associate since I was forced to buy a new AP. I finally was
    able to get a packet dump and traced the problem to the capabilities
    info. Although I had heard that a patch was "floating around", I had
    not seen it before 2.6.17 was released. As this bug does not affect
    security and I seem to have the only AP affected by it, there should
    be no problem in leaving it for 2.6.18.
    
    Signed-Off-By: Larry Finger <Larry.Finger@lwfinger.net>
    Signed-off-by: John W. Linville <linville@tuxdriver.com>

diff --git a/net/ieee80211/softmac/ieee80211softmac_io.c b/net/ieee80211/softmac/ieee80211softmac_io.c
index 09541611e48c..8cc8b20f5cda 100644
--- a/net/ieee80211/softmac/ieee80211softmac_io.c
+++ b/net/ieee80211/softmac/ieee80211softmac_io.c
@@ -229,6 +229,9 @@ ieee80211softmac_assoc_req(struct ieee80211_assoc_request **pkt,
 		return 0;
 	ieee80211softmac_hdr_3addr(mac, &((*pkt)->header), IEEE80211_STYPE_ASSOC_REQ, net->bssid, net->bssid);
 
+	/* Fill in the capabilities */
+	(*pkt)->capability = ieee80211softmac_capabilities(mac, net);
+
 	/* Fill in Listen Interval (?) */
 	(*pkt)->listen_interval = cpu_to_le16(10);
 	

