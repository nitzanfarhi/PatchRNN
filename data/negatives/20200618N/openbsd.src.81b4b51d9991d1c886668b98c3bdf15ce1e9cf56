commit 81b4b51d9991d1c886668b98c3bdf15ce1e9cf56
Author: henning <henning@openbsd.org>
Date:   Wed Jun 11 17:52:37 2008 +0000

    when we establish the mapping from a state key, do it both ways, aka
    key1->reverse = key2; and key2->reverse = key1;
    ok ryan

diff --git a/sys/net/pf.c b/sys/net/pf.c
index a47c9e3ffd2..6a1426a7b7f 100644
--- a/sys/net/pf.c
+++ b/sys/net/pf.c
@@ -1,4 +1,4 @@
-/*	$OpenBSD: pf.c,v 1.595 2008/06/11 04:04:19 henning Exp $ */
+/*	$OpenBSD: pf.c,v 1.596 2008/06/11 17:52:37 henning Exp $ */
 
 /*
  * Copyright (c) 2001 Daniel Hartmeier
@@ -885,9 +885,11 @@ pf_find_state(struct pfi_kif *kif, struct pf_state_key_cmp *key, u_int dir,
 		if ((sk = RB_FIND(pf_state_tree, &pf_statetbl,
 		    (struct pf_state_key *)key)) == NULL)
 			return (NULL);
-		if (m->m_pkthdr.pf.statekey)
+		if (m->m_pkthdr.pf.statekey) {
 			((struct pf_state_key *)
 			    m->m_pkthdr.pf.statekey)->reverse = sk;
+			sk->reverse = m->m_pkthdr.pf.statekey;
+		}
 	}
 
 	if (dir == PF_OUT)

