commit 3e58f892ab90e49bcbbfd1f0ef8fed0ca9f7fe97
Author: Timo Sirainen <tss@iki.fi>
Date:   Fri Jan 25 13:45:36 2008 +0200

    Don't fsync() saved mail if saving failed and we're going to unlink() it.
    
    --HG--
    branch : HEAD

diff --git a/src/lib-storage/index/maildir/maildir-save.c b/src/lib-storage/index/maildir/maildir-save.c
index 848806bab..c79c9b3d7 100644
--- a/src/lib-storage/index/maildir/maildir-save.c
+++ b/src/lib-storage/index/maildir/maildir-save.c
@@ -490,7 +490,7 @@ static int maildir_save_finish_real(struct mail_save_context *_ctx)
 	output_errno = ctx->output->stream_errno;
 	o_stream_destroy(&ctx->output);
 
-	if (!ctx->mbox->ibox.fsync_disable) {
+	if (!ctx->mbox->ibox.fsync_disable && !ctx->failed) {
 		if (fsync(ctx->fd) < 0) {
 			mail_storage_set_critical(storage,
 						  "fsync(%s) failed: %m", path);

