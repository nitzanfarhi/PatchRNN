commit 25d809ff43dc6d51dd4293f0daa507bef5d8f8cc
Author: Poul-Henning Kamp <phk@phk.freebsd.dk>
Date:   Mon Oct 18 15:23:38 2010 +0000

    There is a potential lock-order inversion between a worker thread
    and the ban-lurker and there is nothing we can do about it:  They
    come from opposite ends of the world.
    
    Resolve this by using a TryLock in the ban-lurker and abandon the
    attempt if we fail to get the lock.
    
    Fixes:  #796
    
    
    git-svn-id: http://www.varnish-cache.org/svn/trunk/varnish-cache@5432 d4fa192b-c00b-0410-8231-f00ffab90ce4

diff --git a/bin/varnishd/cache_hash.c b/bin/varnishd/cache_hash.c
index 24de906c0..f876fbbd0 100644
--- a/bin/varnishd/cache_hash.c
+++ b/bin/varnishd/cache_hash.c
@@ -661,7 +661,10 @@ HSH_FindBan(struct sess *sp, struct objcore **oc)
 	CHECK_OBJ_NOTNULL(oc1, OBJCORE_MAGIC);
 	oh = oc1->objhead;
 	CHECK_OBJ_NOTNULL(oh, OBJHEAD_MAGIC);
-	Lck_Lock(&oh->mtx);
+	if (Lck_Trylock(&oh->mtx)) {
+		*oc = NULL;
+		return;
+	}
 	VTAILQ_FOREACH(oc2, &oh->objcs, list)
 		if (oc1 == oc2)
 			break;

