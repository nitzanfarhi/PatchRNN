commit c028dd6bb648251b773f900f59e53544278b3b3c
Author: Radim Krčmář <rkrcmar@redhat.com>
Date:   Fri May 22 19:22:10 2015 +0200

    KVM: x86: preserve x2APIC LDR on INIT
    
    Logical x2APIC stops working if we rewrite it with zeros.
    The best references are SDM April 2015: 10.12.10.1 Logical Destination
    Mode in x2APIC Mode
    
      [...], the LDR are initialized by hardware based on the value of
      x2APIC ID upon x2APIC state transitions.
    
    and SDM April 2015: 10.12.10.2 Deriving Logical x2APIC ID from the Local
    x2APIC ID
    
      The LDR initialization occurs whenever the x2APIC mode is enabled
    
    Signed-off-by: Radim KrÄmÃ¡Å™ <rkrcmar@redhat.com>
    Signed-off-by: Paolo Bonzini <pbonzini@redhat.com>

diff --git a/arch/x86/kvm/lapic.c b/arch/x86/kvm/lapic.c
index c2a7d8a7a414..c789e00dfa8b 100644
--- a/arch/x86/kvm/lapic.c
+++ b/arch/x86/kvm/lapic.c
@@ -1594,7 +1594,8 @@ void kvm_lapic_reset(struct kvm_vcpu *vcpu, bool init_event)
 	apic_set_reg(apic, APIC_DFR, 0xffffffffU);
 	apic_set_spiv(apic, 0xff);
 	apic_set_reg(apic, APIC_TASKPRI, 0);
-	kvm_apic_set_ldr(apic, 0);
+	if (!apic_x2apic_mode(apic))
+		kvm_apic_set_ldr(apic, 0);
 	apic_set_reg(apic, APIC_ESR, 0);
 	apic_set_reg(apic, APIC_ICR, 0);
 	apic_set_reg(apic, APIC_ICR2, 0);

