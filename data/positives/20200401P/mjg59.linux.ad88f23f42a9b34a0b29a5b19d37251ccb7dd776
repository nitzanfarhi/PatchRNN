commit ad88f23f42a9b34a0b29a5b19d37251ccb7dd776
Author: Yan, Zheng <zheng.z.yan@intel.com>
Date:   Sun Jul 21 20:25:25 2013 +0800

    ceph: drop CAP_LINK_SHARED when sending "link" request to MDS
    
    To handle "link" request, the MDS need to xlock inode's linklock,
    which requires revoking any CAP_LINK_SHARED.
    
    Signed-off-by: Yan, Zheng <zheng.z.yan@intel.com>
    Reviewed-by: Sage Weil <sage@inktank.com>

diff --git a/fs/ceph/dir.c b/fs/ceph/dir.c
index f02d82b7933e..0e4da4a9c213 100644
--- a/fs/ceph/dir.c
+++ b/fs/ceph/dir.c
@@ -796,6 +796,8 @@ static int ceph_link(struct dentry *old_dentry, struct inode *dir,
 	req->r_locked_dir = dir;
 	req->r_dentry_drop = CEPH_CAP_FILE_SHARED;
 	req->r_dentry_unless = CEPH_CAP_FILE_EXCL;
+	/* release LINK_SHARED on source inode (mds will lock it) */
+	req->r_old_inode_drop = CEPH_CAP_LINK_SHARED;
 	err = ceph_mdsc_do_request(mdsc, dir, req);
 	if (err) {
 		d_drop(dentry);

