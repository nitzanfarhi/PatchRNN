commit 908bcd540f489f7adf2d804347905b0025d808d3
Author: Max Reitz <mreitz@redhat.com>
Date:   Thu Aug 7 22:47:55 2014 +0200

    block: Catch !bs->drv in bdrv_check()
    
    qemu-img check calls bdrv_check() twice if the first run repaired some
    inconsistencies. If the first run however again triggered corruption
    prevention (on qcow2) due to very bad inconsistencies, bs->drv may be
    NULL afterwards. Thus, bdrv_check() should check whether bs->drv is set.
    
    Signed-off-by: Max Reitz <mreitz@redhat.com>
    Reviewed-by: Eric Blake <eblake@redhat.com>
    Signed-off-by: Kevin Wolf <kwolf@redhat.com>

diff --git a/block.c b/block.c
index 6ef3465b4a..6fa0201074 100644
--- a/block.c
+++ b/block.c
@@ -2209,6 +2209,9 @@ bool bdrv_dev_is_medium_locked(BlockDriverState *bs)
  */
 int bdrv_check(BlockDriverState *bs, BdrvCheckResult *res, BdrvCheckMode fix)
 {
+    if (bs->drv == NULL) {
+        return -ENOMEDIUM;
+    }
     if (bs->drv->bdrv_check == NULL) {
         return -ENOTSUP;
     }

