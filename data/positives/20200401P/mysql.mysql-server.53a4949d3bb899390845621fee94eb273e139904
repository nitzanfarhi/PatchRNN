commit 53a4949d3bb899390845621fee94eb273e139904
Author: evgen@moonbone.local <>
Date:   Mon Jan 15 22:40:39 2007 +0300

    sql_select.cc:
      Fix for crashes on 64bit platforms after fixing bug#23417.

diff --git a/sql/sql_select.cc b/sql/sql_select.cc
index fb4e2c3ab30..93b29c05fd5 100644
--- a/sql/sql_select.cc
+++ b/sql/sql_select.cc
@@ -13416,10 +13416,12 @@ count_field_types(TMP_TABLE_PARAM *param, List<Item> &fields,
   param->quick_group=1;
   while ((field=li++))
   {
-    Item::Type type=field->real_item()->type();
-    if (type == Item::FIELD_ITEM)
+    Item::Type type=field->type();
+    Item::Type real_type= field->real_item()->type();
+    if (type == Item::FIELD_ITEM || (real_type == Item::FIELD_ITEM &&
+        (type != Item::REF_ITEM || !((Item_ref *) field)->depended_from)))
       param->field_count++;
-    else if (type == Item::SUM_FUNC_ITEM)
+    else if (real_type == Item::SUM_FUNC_ITEM)
     {
       if (! field->const_item())
       {

