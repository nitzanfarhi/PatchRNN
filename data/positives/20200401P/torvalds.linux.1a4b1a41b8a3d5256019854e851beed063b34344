commit 1a4b1a41b8a3d5256019854e851beed063b34344
Author: Benjamin Herrenschmidt <benh@kernel.crashing.org>
Date:   Tue Sep 13 15:16:33 2011 -0300

    pci: Don't crash when reading mpss from root complex
    
    In pcie_find_smpss(), we have the following statement:
    
            if (dev->is_hotplug_bridge && (!list_is_singular(&dev->bus->devices) ||
                dev->bus->self->pcie_type != PCI_EXP_TYPE_ROOT_PORT))
    
    The problem is that at least on my machine, this gets called for the
    root complex (virtual P2P bridge), and dev->bus->self is NULL since
    the parent bus for this is not itself anchor to a PCI device.
    
    This adds the necessary NULL check.
    
    Signed-off-by: Benjamin Herrenschmidt <benh@kernel.crashing.org>
    Acked-by: Jon Mason <mason@myri.com>
    Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>

diff --git a/drivers/pci/probe.c b/drivers/pci/probe.c
index b1187ff31d89..f3f94a5c068f 100644
--- a/drivers/pci/probe.c
+++ b/drivers/pci/probe.c
@@ -1351,7 +1351,8 @@ static int pcie_find_smpss(struct pci_dev *dev, void *data)
 	 * will occur as normal.
 	 */
 	if (dev->is_hotplug_bridge && (!list_is_singular(&dev->bus->devices) ||
-	    dev->bus->self->pcie_type != PCI_EXP_TYPE_ROOT_PORT))
+	     (dev->bus->self &&
+	      dev->bus->self->pcie_type != PCI_EXP_TYPE_ROOT_PORT)))
 		*smpss = 0;
 
 	if (*smpss > dev->pcie_mpss)

