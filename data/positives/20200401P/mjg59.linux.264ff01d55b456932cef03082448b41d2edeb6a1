commit 264ff01d55b456932cef03082448b41d2edeb6a1
Author: Jan Kiszka <jan.kiszka@siemens.com>
Date:   Mon Nov 24 12:26:19 2008 +0100

    KVM: VMX: Fix pending NMI-vs.-IRQ race for user space irqchip
    
    As with the kernel irqchip, don't allow an NMI to stomp over an already
    injected IRQ; instead wait for the IRQ injection to be completed.
    
    Signed-off-by: Jan Kiszka <jan.kiszka@siemens.com>
    Signed-off-by: Avi Kivity <avi@redhat.com>

diff --git a/arch/x86/kvm/vmx.c b/arch/x86/kvm/vmx.c
index e446f232588e..487e1dcdce33 100644
--- a/arch/x86/kvm/vmx.c
+++ b/arch/x86/kvm/vmx.c
@@ -2486,7 +2486,9 @@ static void do_interrupt_requests(struct kvm_vcpu *vcpu,
 	vmx_update_window_states(vcpu);
 
 	if (vcpu->arch.nmi_pending && !vcpu->arch.nmi_injected) {
-		if (vcpu->arch.nmi_window_open) {
+		if (vcpu->arch.interrupt.pending) {
+			enable_nmi_window(vcpu);
+		} else if (vcpu->arch.nmi_window_open) {
 			vcpu->arch.nmi_pending = false;
 			vcpu->arch.nmi_injected = true;
 		} else {

