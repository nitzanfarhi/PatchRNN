commit e5a7a30b42c34918b40930de0e02883a37ef0c3d
Author: pengcheng chen - Sun Microsystems - Beijing China <Pengcheng.Chen@Sun.COM>
Date:   Tue Oct 21 10:24:39 2008 +0800

    6735662 ipw driver double free RX/TX buffers on allocation failure

diff --git a/usr/src/uts/common/io/ipw/ipw2100.c b/usr/src/uts/common/io/ipw/ipw2100.c
index a177ae382b..3ad59d1051 100644
--- a/usr/src/uts/common/io/ipw/ipw2100.c
+++ b/usr/src/uts/common/io/ipw/ipw2100.c
@@ -1327,9 +1327,9 @@ ipw2100_ring_alloc(struct ipw2100_softc *sc)
 		err = ipw2100_dma_region_alloc(sc, &sc->sc_dma_txbufs[i],
 		    IPW2100_TXBUF_SIZE, DDI_DMA_WRITE, DDI_DMA_STREAMING);
 		if (err != DDI_SUCCESS) {
-			while (i >= 0) {
-				ipw2100_dma_region_free(&sc->sc_dma_txbufs[i]);
+			while (i > 0) {
 				i--;
+				ipw2100_dma_region_free(&sc->sc_dma_txbufs[i]);
 			}
 			goto fail1;
 		}
@@ -1350,9 +1350,9 @@ ipw2100_ring_alloc(struct ipw2100_softc *sc)
 		err = ipw2100_dma_region_alloc(sc, &sc->sc_dma_rxbufs[i],
 		    IPW2100_RXBUF_SIZE, DDI_DMA_READ, DDI_DMA_STREAMING);
 		if (err != DDI_SUCCESS) {
-			while (i >= 0) {
-				ipw2100_dma_region_free(&sc->sc_dma_rxbufs[i]);
+			while (i > 0) {
 				i--;
+				ipw2100_dma_region_free(&sc->sc_dma_rxbufs[i]);
 			}
 			goto fail3;
 		}

