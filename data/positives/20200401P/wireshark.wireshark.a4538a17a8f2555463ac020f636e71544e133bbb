commit a4538a17a8f2555463ac020f636e71544e133bbb
Author: Gerald Combs <gerald@wireshark.org>
Date:   Wed Dec 2 22:29:06 2009 +0000

    Back out r30376, which introduced a buffer overrun. Fixes bug 4285.
    
    svn path=/trunk/; revision=31157

diff --git a/epan/dissectors/packet-icq.c b/epan/dissectors/packet-icq.c
index de3b5f4b4b..8061de437d 100644
--- a/epan/dissectors/packet-icq.c
+++ b/epan/dissectors/packet-icq.c
@@ -1503,7 +1503,9 @@ dissect_icqv5Client(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree)
      * bytes in the buffer.
      */
     rounded_size = ((((capturedsize - ICQ5_CL_SESSIONID) + 3)/4)*4) + ICQ5_CL_SESSIONID;
-    decr_pd = tvb_memdup(tvb, 0, capturedsize);
+    /* rounded_size might exceed the tvb bounds so we can't just use tvb_memdup here. */
+    decr_pd = g_malloc(rounded_size);
+    tvb_memcpy(tvb, decr_pd, 0, capturedsize);
     decrypt_v5(decr_pd, rounded_size, key);
 
     /* Allocate a new tvbuff, referring to the decrypted data. */

