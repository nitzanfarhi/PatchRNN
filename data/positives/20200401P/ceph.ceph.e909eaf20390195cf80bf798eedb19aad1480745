commit e909eaf20390195cf80bf798eedb19aad1480745
Author: Yan, Zheng <zheng.z.yan@intel.com>
Date:   Mon Mar 3 10:03:35 2014 +0800

    mds: drop auth pins before waiting for dir unfreeze
    
    Otherwise deadlock can happen
    
    Signed-off-by: Yan, Zheng <zheng.z.yan@intel.com>

diff --git a/src/mds/Server.cc b/src/mds/Server.cc
index 702ab1f445..dfb44cb45b 100644
--- a/src/mds/Server.cc
+++ b/src/mds/Server.cc
@@ -2838,6 +2838,8 @@ void Server::handle_client_readdir(MDRequest *mdr)
   if (!dir->is_complete()) {
     if (dir->is_frozen()) {
       dout(7) << "dir is frozen " << *dir << dendl;
+      mds->locker->drop_locks(mdr);
+      mdr->drop_local_auth_pins();
       dir->add_waiter(CDir::WAIT_UNFREEZE, new C_MDS_RetryRequest(mdcache, mdr));
       return;
     }

