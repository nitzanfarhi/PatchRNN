commit 0ee418f19d37dd01c220e743d4e6adf7b4662f52
Author: castaglia <castaglia>
Date:   Mon Jun 22 17:54:23 2009 +0000

    If no DeleteAbortedStores appears in the proftpd.conf, then the callback
    which closes any open filehandles could segfault, trying to deference
    a null pointer.  Check for this, and handle it appropriately.

diff --git a/contrib/mod_sftp/fxp.c b/contrib/mod_sftp/fxp.c
index f2a76957a..93fb855b1 100644
--- a/contrib/mod_sftp/fxp.c
+++ b/contrib/mod_sftp/fxp.c
@@ -21,7 +21,7 @@
  * resulting executable, without including the source code for OpenSSL in the
  * source distribution.
  *
- * $Id: fxp.c,v 1.32 2009-06-20 00:29:56 castaglia Exp $
+ * $Id: fxp.c,v 1.33 2009-06-22 17:54:23 castaglia Exp $
  */
 
 #include "mod_sftp.h"
@@ -1958,7 +1958,7 @@ static int fxp_handle_abort(const void *key_data, size_t key_datasz,
   struct fxp_handle *fxh;
   char *abs_path, *curr_path = NULL, *real_path = NULL;
   char direction;
-  unsigned char *delete_aborted_stores;
+  unsigned char *delete_aborted_stores = NULL;
 
   fxh = value_data;
   delete_aborted_stores = user_data;
@@ -1990,7 +1990,8 @@ static int fxp_handle_abort(const void *key_data, size_t key_datasz,
   fxh->fh = NULL;
 
   if (fxh->fh_flags != O_RDONLY) {
-    if (*delete_aborted_stores == TRUE) {
+    if (delete_aborted_stores != NULL &&
+        *delete_aborted_stores == TRUE) {
       (void) pr_log_writefile(sftp_logfd, MOD_SFTP_VERSION,
         "removing aborted uploaded file '%s'", curr_path);
 

