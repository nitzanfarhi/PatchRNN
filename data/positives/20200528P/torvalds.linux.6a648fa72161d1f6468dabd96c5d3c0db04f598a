commit 6a648fa72161d1f6468dabd96c5d3c0db04f598a
Author: Badari Pulavarty <pbadari@us.ibm.com>
Date:   Fri Aug 10 13:00:44 2007 -0700

    direct-io: fix error-path crashes
    
    Need to initialize map_bh.b_state to zero.  Otherwise, in case of a faulty
    user-buffer its possible to go into dio_zero_block() and submit a page by
    mistake - since it checks for buffer_new().
    
    http://marc.info/?l=linux-kernel&m=118551339032528&w=2
    
    akpm: Linus had a (better) patch to just do a kzalloc() in there, but it got
    lost.  Probably this version is better for -stable anwyay.
    
    Signed-off-by: Badari Pulavarty <pbadari@us.ibm.com>
    Acked-by: Joe Jin <joe.jin@oracle.com>
    Acked-by: Zach Brown <zach.brown@oracle.com>
    Cc: gurudas pai <gurudas.pai@oracle.com>
    Cc: <stable@kernel.org>
    Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
    Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>

diff --git a/fs/direct-io.c b/fs/direct-io.c
index 52bb2638f7ab..6874785bb65a 100644
--- a/fs/direct-io.c
+++ b/fs/direct-io.c
@@ -974,6 +974,7 @@ direct_io_worker(int rw, struct kiocb *iocb, struct inode *inode,
 	dio->get_block = get_block;
 	dio->end_io = end_io;
 	dio->map_bh.b_private = NULL;
+	dio->map_bh.b_state = 0;
 	dio->final_block_in_bio = -1;
 	dio->next_block_for_io = -1;
 

