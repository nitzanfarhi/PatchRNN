commit 425c9e20a24374b4fb6f143068d13344cf7d154e
Author: Alex Bligh <alex@alex.org.uk>
Date:   Sat May 28 19:29:20 2011 +0100

    Fix handling of oversize writes
    
    Oversize writes were attempting to write the whole length of the
    write each time, rather than BUFSIZ chunks. This could cause
    disk corruption.

diff --git a/nbd-server.c b/nbd-server.c
index 695deef..d57120b 100644
--- a/nbd-server.c
+++ b/nbd-server.c
@@ -1568,7 +1568,7 @@ int mainloop(CLIENT *client) {
 					consume(client->net, buf, len-currlen, BUFSIZE);
 					continue;
 				}
-				if (expwrite(request.from, buf, len, client,
+				if (expwrite(request.from, buf, currlen, client,
 					     request.type & NBD_CMD_FLAG_FUA)) {
 					DEBUG("Write failed: %m" );
 					ERROR(client, reply, errno);

