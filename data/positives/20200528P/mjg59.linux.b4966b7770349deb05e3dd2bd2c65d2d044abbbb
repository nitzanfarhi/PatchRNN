commit b4966b7770349deb05e3dd2bd2c65d2d044abbbb
Author: Daniel J Blueman <daniel.blueman@gmail.com>
Date:   Wed Mar 9 16:46:42 2011 +0000

    btrfs: fix dip leak
    
    The btrfs DIO code leaks dip structs when dip->csums allocation
    fails; bio->bi_end_io isn't set at the point where the free_ordered
    branch is consequently taken, thus bio_endio doesn't call the function
    which would free it in the normal case. Fix.
    
    Signed-off-by: Daniel J Blueman <daniel.blueman@gmail.com>
    Acked-by: Miao Xie <miaox@cn.fujitsu.com>
    Signed-off-by: Chris Mason <chris.mason@oracle.com>

diff --git a/fs/btrfs/inode.c b/fs/btrfs/inode.c
index 44b926646e33..e7a8303328b2 100644
--- a/fs/btrfs/inode.c
+++ b/fs/btrfs/inode.c
@@ -6058,6 +6058,7 @@ static void btrfs_submit_direct(int rw, struct bio *bio, struct inode *inode,
 	if (!skip_sum) {
 		dip->csums = kmalloc(sizeof(u32) * bio->bi_vcnt, GFP_NOFS);
 		if (!dip->csums) {
+			kfree(dip);
 			ret = -ENOMEM;
 			goto free_ordered;
 		}

