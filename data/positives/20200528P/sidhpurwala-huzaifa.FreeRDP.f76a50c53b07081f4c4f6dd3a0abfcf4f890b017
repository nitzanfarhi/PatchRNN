commit f76a50c53b07081f4c4f6dd3a0abfcf4f890b017
Author: Vic Lee <llyzs@163.com>
Date:   Thu Jun 28 14:53:43 2012 +0800

    libfreerdp-core/server: fix a corrupted memory access issue.
    
    The peer context memory block should not be freed by the server
    implementation because it still needs to be accessed after the
    context free callback has been called. It should be the core's
    responsibility to free it.

diff --git a/libfreerdp-core/peer.c b/libfreerdp-core/peer.c
index ae77408d..c33ff2bc 100644
--- a/libfreerdp-core/peer.c
+++ b/libfreerdp-core/peer.c
@@ -394,6 +394,7 @@ void freerdp_peer_free(freerdp_peer* client)
 	if (client)
 	{
 		rdp_free(client->context->rdp);
+		xfree(client->context);
 		xfree(client);
 	}
 }
diff --git a/server/Windows/wfreerdp.c b/server/Windows/wfreerdp.c
index bd7c7b63..9d62f495 100644
--- a/server/Windows/wfreerdp.c
+++ b/server/Windows/wfreerdp.c
@@ -50,7 +50,6 @@ void wf_peer_context_free(freerdp_peer* client, wfPeerContext* context)
 {
 	if (context)
 	{
-		xfree(context);
 	}
 }
 
diff --git a/server/X11/xf_peer.c b/server/X11/xf_peer.c
index 1689ac8e..40bd9887 100644
--- a/server/X11/xf_peer.c
+++ b/server/X11/xf_peer.c
@@ -273,7 +273,6 @@ void xf_peer_context_free(freerdp_peer* client, xfPeerContext* context)
 	{
 		stream_free(context->s);
 		rfx_context_free(context->rfx_context);
-		xfree(context);
 	}
 }
 
diff --git a/server/test/tfreerdp.c b/server/test/tfreerdp.c
index 3ec31f36..3f677149 100644
--- a/server/test/tfreerdp.c
+++ b/server/test/tfreerdp.c
@@ -123,7 +123,6 @@ void test_peer_context_free(freerdp_peer* client, testPeerContext* context)
 			audin_server_context_free(context->audin);
 		}
 		WTSDestroyVirtualChannelManager(context->vcm);
-		xfree(context);
 	}
 }
 

