commit aa04335e9bb7fc899275c7468c83bcdfad2778d1
Author: Timo Sirainen <tss@iki.fi>
Date:   Sat Jun 17 23:15:10 2006 +0300

    Crashfix if mail's data is fetched in specific order (I'm not sure how to
    reproduce this though, but the crash has happened to others)
    
    --HG--
    branch : HEAD

diff --git a/src/lib-storage/index/index-mail-headers.c b/src/lib-storage/index/index-mail-headers.c
index a905fe5ad..0f9573076 100644
--- a/src/lib-storage/index/index-mail-headers.c
+++ b/src/lib-storage/index/index-mail-headers.c
@@ -352,9 +352,12 @@ int index_mail_parse_headers(struct index_mail *mail,
 
 	index_mail_parse_header_init(mail, headers);
 
-	if (data->parts == NULL && data->parser_ctx == NULL) {
+	if (data->parser_ctx == NULL && (data->parts == NULL ||
+					 data->save_bodystructure_header)) {
 		/* initialize bodystructure parsing in case we read the whole
 		   message. */
+		if (data->parser_ctx != NULL)
+			(void)message_parser_deinit(&mail->data.parser_ctx);
 		data->parser_ctx =
 			message_parser_init(mail->data_pool, data->stream);
 		message_parser_parse_header(data->parser_ctx, &data->hdr_size,

