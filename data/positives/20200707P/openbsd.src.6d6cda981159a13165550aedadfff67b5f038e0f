commit 6d6cda981159a13165550aedadfff67b5f038e0f
Author: gilles <gilles@openbsd.org>
Date:   Sat Mar 26 17:43:01 2011 +0000

    check that we actually have a stdio stream opened for the message before
    trying to close it in a mta session. in case of DNS errors; this pointer
    will remain NULL and cause a segv in MTA_DONE state.

diff --git a/usr.sbin/smtpd/mta.c b/usr.sbin/smtpd/mta.c
index 48e8f9c02de..114200d1080 100644
--- a/usr.sbin/smtpd/mta.c
+++ b/usr.sbin/smtpd/mta.c
@@ -1,4 +1,4 @@
-/*	$OpenBSD: mta.c,v 1.99 2011/03/26 10:59:59 gilles Exp $	*/
+/*	$OpenBSD: mta.c,v 1.100 2011/03/26 17:43:01 gilles Exp $	*/
 
 /*
  * Copyright (c) 2008 Pierre-Yves Ritschard <pyr@openbsd.org>
@@ -512,7 +512,10 @@ mta_enter_state(struct mta_session *s, int newstate, void *p)
 			TAILQ_REMOVE(&s->relays, relay, entry);
 			free(relay);
 		}
-		fclose(s->datafp);
+
+		if (s->datafp)
+			fclose(s->datafp);
+
 		free(s->secret);
 		free(s->host);
 		free(s->cert);

