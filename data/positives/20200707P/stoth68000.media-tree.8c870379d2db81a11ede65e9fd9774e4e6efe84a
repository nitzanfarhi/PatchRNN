commit 8c870379d2db81a11ede65e9fd9774e4e6efe84a
Author: Ben Hutchings <bhutchings@solarflare.com>
Date:   Wed Mar 4 09:53:02 2009 +0000

    sfc: Clear I2C adapter structure in falcon_remove_nic()
    
    i2c_del_adapter() leaves dangling pointers in the structure.  If we
    retry the NIC probe and pass the structure to i2c_add_adapter() again
    it will lead to an oops unless we clear it first.
    
    Signed-off-by: Ben Hutchings <bhutchings@solarflare.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

diff --git a/drivers/net/sfc/falcon.c b/drivers/net/sfc/falcon.c
index 9e2f0f0d47a8..efd121c42a21 100644
--- a/drivers/net/sfc/falcon.c
+++ b/drivers/net/sfc/falcon.c
@@ -3114,8 +3114,10 @@ void falcon_remove_nic(struct efx_nic *efx)
 	struct falcon_nic_data *nic_data = efx->nic_data;
 	int rc;
 
+	/* Remove I2C adapter and clear it in preparation for a retry */
 	rc = i2c_del_adapter(&efx->i2c_adap);
 	BUG_ON(rc);
+	memset(&efx->i2c_adap, 0, sizeof(efx->i2c_adap));
 
 	falcon_remove_spi_devices(efx);
 	falcon_free_buffer(efx, &efx->irq_status);

