commit 7d67077f78d4a43f214c240359ad5f7284d086fa
Author: David Herrmann <dh.herrmann@gmail.com>
Date:   Wed Jul 15 14:35:15 2015 +0200

    sd-bus: fix object tree to be deeper than 2 levels
    
    So right now our object-tree is limited to 2 levels at most
    ('/' and '/foo/...../bar'). We never link any intermediate levels, even
    though that was clearly the plan. Fix the bus_node_allocate() helper to
    actually link all intermediate nodes, too, not just the root node.
    
    This fixes a simple inverse ptr-diff bug.
    
    The downside of this fix is that we clearly never tested (nor used) the
    object tree in any way. The only reason that the introspection works is
    that our enumerators shortcut the object tree.
    
    Lets see whether that code actually works..
    
    Thanks to: Nathaniel McCallum <nathaniel@themccallums.org>
    ..for reporting this. See #524 for an actual example code.

diff --git a/src/libsystemd/sd-bus/bus-objects.c b/src/libsystemd/sd-bus/bus-objects.c
index b3cc28ee9..cbdf6552f 100644
--- a/src/libsystemd/sd-bus/bus-objects.c
+++ b/src/libsystemd/sd-bus/bus-objects.c
@@ -1416,7 +1416,7 @@ static struct node *bus_node_allocate(sd_bus *bus, const char *path) {
                 e = strrchr(path, '/');
                 assert(e);
 
-                p = strndupa(path, MAX(1, path - e));
+                p = strndupa(path, MAX(1, e - path));
 
                 parent = bus_node_allocate(bus, p);
                 if (!parent)

