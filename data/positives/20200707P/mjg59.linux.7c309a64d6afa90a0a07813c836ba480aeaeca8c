commit 7c309a64d6afa90a0a07813c836ba480aeaeca8c
Author: Christian Krafft <krafft@de.ibm.com>
Date:   Wed Dec 6 20:32:41 2006 -0800

    [PATCH] enable booting a NUMA system where some nodes have no memory
    
    When booting a NUMA system with nodes that have no memory (eg by limiting
    memory), bootmem_alloc_core tried to find pages in an uninitialized
    bootmem_map.  This caused a null pointer access.  This fix adds a check, so
    that NULL is returned.  That will enable the caller (bootmem_alloc_nopanic)
    to alloc memory on other without a panic.
    
    Signed-off-by: Christian Krafft <krafft@de.ibm.com>
    Cc: Christoph Lameter <clameter@engr.sgi.com>
    Cc: Andy Whitcroft <apw@shadowen.org>
    Cc: Martin Bligh <mbligh@google.com>
    Signed-off-by: Andrew Morton <akpm@osdl.org>
    Signed-off-by: Linus Torvalds <torvalds@osdl.org>

diff --git a/mm/bootmem.c b/mm/bootmem.c
index d53112fcb404..94253428f091 100644
--- a/mm/bootmem.c
+++ b/mm/bootmem.c
@@ -196,6 +196,10 @@ __alloc_bootmem_core(struct bootmem_data *bdata, unsigned long size,
 	if (limit && bdata->node_boot_start >= limit)
 		return NULL;
 
+	/* on nodes without memory - bootmem_map is NULL */
+	if (!bdata->node_bootmem_map)
+		return NULL;
+
 	end_pfn = bdata->node_low_pfn;
 	limit = PFN_DOWN(limit);
 	if (limit && end_pfn > limit)

