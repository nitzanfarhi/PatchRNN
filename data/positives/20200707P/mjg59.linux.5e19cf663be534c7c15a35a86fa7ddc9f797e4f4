commit 5e19cf663be534c7c15a35a86fa7ddc9f797e4f4
Author: Steve Wise <swise@opengridcomputing.com>
Date:   Tue Jul 8 14:40:05 2008 -0700

    RDMA/cxgb3: Fix regression caused by class_device -> device conversion
    
    The change to iwch_provider.c in commit f4e91eb4 ("IB: convert struct
    class_device to struct device") undid the fix done in commit 7f049f2f
    ("RDMA/cxgb3: Hold rtnl_lock() around ethtool get_drvinfo call").  It
    removed the calls to rtnl_lock() that serialized the iw_cxgb3 ethtool
    ops calls into the cxgb3 driver.  This locking is needed to avoid
    messing up the internal state of the cxgb3 driver.
    
    Signed-off-by: Steve Wise <swise@opengridcomputing.com>
    Signed-off-by: Roland Dreier <rolandd@cisco.com>

diff --git a/drivers/infiniband/hw/cxgb3/iwch_provider.c b/drivers/infiniband/hw/cxgb3/iwch_provider.c
index 8934178a23ee..95f82cfb6c54 100644
--- a/drivers/infiniband/hw/cxgb3/iwch_provider.c
+++ b/drivers/infiniband/hw/cxgb3/iwch_provider.c
@@ -1096,7 +1096,9 @@ static ssize_t show_fw_ver(struct device *dev, struct device_attribute *attr, ch
 	struct net_device *lldev = iwch_dev->rdev.t3cdev_p->lldev;
 
 	PDBG("%s dev 0x%p\n", __func__, dev);
+	rtnl_lock();
 	lldev->ethtool_ops->get_drvinfo(lldev, &info);
+	rtnl_unlock();
 	return sprintf(buf, "%s\n", info.fw_version);
 }
 
@@ -1109,7 +1111,9 @@ static ssize_t show_hca(struct device *dev, struct device_attribute *attr,
 	struct net_device *lldev = iwch_dev->rdev.t3cdev_p->lldev;
 
 	PDBG("%s dev 0x%p\n", __func__, dev);
+	rtnl_lock();
 	lldev->ethtool_ops->get_drvinfo(lldev, &info);
+	rtnl_unlock();
 	return sprintf(buf, "%s\n", info.driver);
 }
 

