commit e086ed76671252d5b539854a83f8506be7bea05c
Author: Lars-Peter Clausen <lars@metafoo.de>
Date:   Tue Oct 15 09:38:00 2013 +0100

    iio:buffer: Free active scan mask in iio_disable_all_buffers()
    
    Usually the active scan mask is freed in __iio_update_buffers() when the buffer
    is disabled. But when the device is still sampling when it is removed we'll end
    up disabling the buffers in iio_disable_all_buffers(). So we also need to free
    the active scan mask here, otherwise it will be leaked.
    
    Signed-off-by: Lars-Peter Clausen <lars@metafoo.de>
    Signed-off-by: Jonathan Cameron <jic23@kernel.org>

diff --git a/drivers/iio/industrialio-buffer.c b/drivers/iio/industrialio-buffer.c
index 2710f7245c3b..2db7dcd826b9 100644
--- a/drivers/iio/industrialio-buffer.c
+++ b/drivers/iio/industrialio-buffer.c
@@ -477,6 +477,9 @@ void iio_disable_all_buffers(struct iio_dev *indio_dev)
 	indio_dev->currentmode = INDIO_DIRECT_MODE;
 	if (indio_dev->setup_ops->postdisable)
 		indio_dev->setup_ops->postdisable(indio_dev);
+
+	if (indio_dev->available_scan_masks == NULL)
+		kfree(indio_dev->active_scan_mask);
 }
 
 int iio_update_buffers(struct iio_dev *indio_dev,

