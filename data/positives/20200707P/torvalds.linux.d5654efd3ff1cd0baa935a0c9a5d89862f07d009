commit d5654efd3ff1cd0baa935a0c9a5d89862f07d009
Author: Wei Yongjun <yjwei@cn.fujitsu.com>
Date:   Wed Dec 3 00:27:18 2008 -0800

    xfrm: Fix kernel panic when flush and dump SPD entries
    
    After flush the SPD entries, dump the SPD entries will cause kernel painc.
    
    Used the following commands to reproduct:
    
    - echo 'spdflush;' | setkey -c
    - echo 'spdadd 3ffe:501:ffff:ff01::/64 3ffe:501:ffff:ff04::/64  any -P out ipsec \
      ah/tunnel/3ffe:501:ffff:ff00:200:ff:fe00:b0b0-3ffe:501:ffff:ff02:200:ff:fe00:a1a1/require;\
      spddump;' | setkey -c
    - echo 'spdflush; spddump;' | setkey -c
    - echo 'spdadd 3ffe:501:ffff:ff01::/64 3ffe:501:ffff:ff04::/64  any -P out ipsec \
      ah/tunnel/3ffe:501:ffff:ff00:200:ff:fe00:b0b0-3ffe:501:ffff:ff02:200:ff:fe00:a1a1/require;\
      spddump;' | setkey -c
    
    This is because when flush the SPD entries, the SPD entry is not remove
    from the list.
    
    This patch fix the problem by remove the SPD entry from the list.
    
    Signed-off-by: Wei Yongjun <yjwei@cn.fujitsu.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

diff --git a/net/xfrm/xfrm_policy.c b/net/xfrm/xfrm_policy.c
index 058f04f54b90..fb216c9adf86 100644
--- a/net/xfrm/xfrm_policy.c
+++ b/net/xfrm/xfrm_policy.c
@@ -817,6 +817,7 @@ int xfrm_policy_flush(u8 type, struct xfrm_audit *audit_info)
 				continue;
 			hlist_del(&pol->bydst);
 			hlist_del(&pol->byidx);
+			list_del(&pol->walk.all);
 			write_unlock_bh(&xfrm_policy_lock);
 
 			xfrm_audit_policy_delete(pol, 1, audit_info->loginuid,

