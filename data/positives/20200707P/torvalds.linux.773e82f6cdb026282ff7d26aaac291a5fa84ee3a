commit 773e82f6cdb026282ff7d26aaac291a5fa84ee3a
Author: Julia Lawall <julia@diku.dk>
Date:   Mon Jul 21 09:58:30 2008 +0200

    [SCSI] scsi_scan.c: Release mutex in error handling code
    
    The mutex is released on a successful return, so it would seem that it
    should be released on an error return as well.
    
    The semantic patch that makes this change is as follows:
    (http://www.emn.fr/x-info/coccinelle/)
    
    // <smpl>
    @@
    expression l;
    @@
    
    mutex_lock(l);
    ... when != mutex_unlock(l)
        when any
        when strict
    (
    if (...) { ... when != mutex_unlock(l)
    +   mutex_unlock(l);
        return ...;
    }
    |
    mutex_unlock(l);
    )
    // </smpl>
    
    Signed-off-by: Julia Lawall <julia@diku.dk>
    Signed-off-by: James Bottomley <James.Bottomley@HansenPartnership.com>

diff --git a/drivers/scsi/scsi_scan.c b/drivers/scsi/scsi_scan.c
index 196fe3af0d5e..b7b74489fce7 100644
--- a/drivers/scsi/scsi_scan.c
+++ b/drivers/scsi/scsi_scan.c
@@ -1760,6 +1760,7 @@ static void scsi_finish_async_scan(struct async_scan_data *data)
 		printk("%s called twice for host %d", __FUNCTION__,
 				shost->host_no);
 		dump_stack();
+		mutex_unlock(&shost->scan_mutex);
 		return;
 	}
 

