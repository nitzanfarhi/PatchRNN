commit 187226f57f1381cfc63216979b4375f30e593795
Author: john stultz <johnstul@us.ibm.com>
Date:   Wed Aug 22 14:01:10 2007 -0700

    futex_unlock_pi() hurts my brain and may cause application deadlock
    
    Avoid futex_unlock_pi returning -EFAULT (which results in deadlock), by
    clearing uval before jumping to retry_locked.
    
    Signed-off-by: John Stultz <johnstul@us.ibm.com>
    Acked-by: Steven Rostedt <rostedt@goodmis.org>
    Cc: Ingo Molnar <mingo@elte.hu>
    Cc: Thomas Gleixner <tglx@linutronix.de>
    Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
    Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>

diff --git a/kernel/futex.c b/kernel/futex.c
index 3415e9ad1391..e8935b195e88 100644
--- a/kernel/futex.c
+++ b/kernel/futex.c
@@ -1670,6 +1670,7 @@ static int futex_unlock_pi(u32 __user *uaddr, struct rw_semaphore *fshared)
 					 attempt);
 		if (ret)
 			goto out;
+		uval = 0;
 		goto retry_unlocked;
 	}
 

