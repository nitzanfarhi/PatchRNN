commit 26e9d599561e9a964bd4d7c2be0029db8aaff852
Author: Hans Verkuil <hverkuil@xs4all.nl>
Date:   Sat Aug 25 05:41:52 2007 -0300

    V4L/DVB (6115): ivtv/ivtv-fb: improve locking to avoid initialization problems
    ivtv/ivtv-fb: improve locking to prevent ivtv/ivtv-fb initialization problems
    
    Signed-off-by: Hans Verkuil <hverkuil@xs4all.nl>
    Signed-off-by: Mauro Carvalho Chehab <mchehab@infradead.org>

diff --git a/drivers/media/video/ivtv/ivtv-driver.c b/drivers/media/video/ivtv/ivtv-driver.c
index 855697c1c968..2a5e0facca7d 100644
--- a/drivers/media/video/ivtv/ivtv-driver.c
+++ b/drivers/media/video/ivtv/ivtv-driver.c
@@ -1003,6 +1003,8 @@ static int __devinit ivtv_probe(struct pci_dev *dev,
 
 	IVTV_DEBUG_INFO("base addr: 0x%08x\n", itv->base_addr);
 
+	mutex_lock(&itv->serialize_lock);
+
 	/* PCI Device Setup */
 	if ((retval = ivtv_setup_pci(itv, dev, pci_id)) != 0) {
 		if (retval == -EIO)
@@ -1174,6 +1176,7 @@ static int __devinit ivtv_probe(struct pci_dev *dev,
 		IVTV_ERR("Failed to register irq %d\n", retval);
 		goto free_streams;
 	}
+	mutex_unlock(&itv->serialize_lock);
 	IVTV_INFO("Initialized card #%d: %s\n", itv->num, itv->card_name);
 	return 0;
 
@@ -1192,6 +1195,7 @@ static int __devinit ivtv_probe(struct pci_dev *dev,
 		release_mem_region(itv->base_addr + IVTV_DECODER_OFFSET, IVTV_DECODER_SIZE);
       free_workqueue:
 	destroy_workqueue(itv->irq_work_queues);
+	mutex_unlock(&itv->serialize_lock);
       err:
 	if (retval == 0)
 		retval = -ENODEV;
diff --git a/drivers/media/video/ivtv/ivtv-fb.c b/drivers/media/video/ivtv/ivtv-fb.c
index e80564aed632..ffe6478682ae 100644
--- a/drivers/media/video/ivtv/ivtv-fb.c
+++ b/drivers/media/video/ivtv/ivtv-fb.c
@@ -1011,10 +1011,13 @@ static int ivtvfb_init_io(struct ivtv *itv)
 {
 	struct osd_info *oi = itv->osd_info;
 
+	mutex_lock(&itv->serialize_lock);
 	if (ivtv_init_on_first_open(itv)) {
+		mutex_unlock(&itv->serialize_lock);
 		IVTV_FB_ERR("Failed to initialize ivtv\n");
 		return -ENXIO;
 	}
+	mutex_unlock(&itv->serialize_lock);
 
 	ivtv_fb_get_framebuffer(itv, &oi->video_rbase, &oi->video_buffer_size);
 

