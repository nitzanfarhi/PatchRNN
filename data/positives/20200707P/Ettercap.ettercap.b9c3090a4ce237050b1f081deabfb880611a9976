commit b9c3090a4ce237050b1f081deabfb880611a9976
Author: Emilio Escobar <eescobar@gmail.com>
Date:   Wed Mar 20 21:13:14 2013 -0400

    Overflow fixes to TN3270 dissector

diff --git a/src/dissectors/ec_TN3270.c b/src/dissectors/ec_TN3270.c
index b1707247..66ac797c 100644
--- a/src/dissectors/ec_TN3270.c
+++ b/src/dissectors/ec_TN3270.c
@@ -96,16 +96,23 @@ FUNC_DECODER(dissector_TN3270)
       ebcdic2ascii(ptr, PACKET->DATA.len, (unsigned char*)output);
 
       /* scan packets to find username and password */
-      for (i = 0; i < PACKET->DATA.len; i++) {
+      for (i = 0; i < PACKET->DATA.len - 5; i++) {
          /* find username, logons start with 125 193 (215 or 213) 17 64 90 ordinals
           * We relax the check for third byte because it is less error-prone that way */
          if (ptr[i] == 125 && ptr[i+1] == 193 && /* (ptr[i+2] == 215 || ptr[i+2] == 213) && */
                  ptr[i+3] == 17 && ptr[i+4] == 64 && ptr[i+5] == 90) {
                  /* scan for spaces */
                  int j = i + 6;
-                 while (output[j] == 32)
+                 while (j < 512 && output[j] == 32)
                     j++;
+
+		 if (j==511) /* Don't even bother */
+			continue;
+
                  strncpy(username, &output[j], 512);
+
+		 username[511] = 0; /* Boundary */
+
                  int l = strlen(username);
                  username[l-2] = 0;
                  DISSECT_MSG("%s:%d <= z/OS TSO Username : %s\n", ip_addr_ntoa(&PACKET->L3.dst, tmp), ntohs(PACKET->L4.dst), username);
@@ -113,6 +120,7 @@ FUNC_DECODER(dissector_TN3270)
          /* find password */
          if (ptr[i] == 125 && ptr[i+1] == 201 && ptr[i+3] == 17 && ptr[i+4] == 201 && ptr[i+5] == 195) {
                  strncpy(password, &output[i + 6], 512);
+		 password[511] = 0; /* Boundary */
                  int l = strlen(password);
                  password[l-2] = 0;
                  DISSECT_MSG("%s:%d <= z/OS TSO Password : %s\n", ip_addr_ntoa(&PACKET->L3.dst, tmp), ntohs(PACKET->L4.dst), password);

