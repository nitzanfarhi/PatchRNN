commit 5988a363edb9eb9f31486ceb2cd10e8b45f05dda
Author: Julien Grall <julien.grall@arm.com>
Date:   Tue May 31 12:41:23 2016 +0100

    drivers/perf: arm_pmu: Avoid leaking pmu->irq_affinity on error
    
    pmu->irq_affinity will not be freed if an error occurred within
    arm_pmu_device_probe after of_pmu_irq_cfg has been called.
    
    Note that in the case of_pmu_irq_cfg is returning an error,
    pmu->irq_affinity will not be set, but it should be NULL as pmu was
    kzalloc'd. Therefore the result kfree(NULL) is benign.
    
    Signed-off-by: Julien Grall <julien.grall@arm.com>
    Acked-by: Mark Rutland <mark.rutland@arm.com>
    Signed-off-by: Will Deacon <will.deacon@arm.com>

diff --git a/drivers/perf/arm_pmu.c b/drivers/perf/arm_pmu.c
index 95614d24675f..1b8304e1efaa 100644
--- a/drivers/perf/arm_pmu.c
+++ b/drivers/perf/arm_pmu.c
@@ -1040,6 +1040,7 @@ int arm_pmu_device_probe(struct platform_device *pdev,
 out_free:
 	pr_info("%s: failed to register PMU devices!\n",
 		of_node_full_name(node));
+	kfree(pmu->irq_affinity);
 	kfree(pmu);
 	return ret;
 }

