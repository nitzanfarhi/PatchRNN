commit 4246032216181c778f7ddf7f2e062cada2ef346d
Author: Paul B Mahol <onemda@gmail.com>
Date:   Thu Mar 22 03:36:25 2012 +0000

    segment: fix null pointer dereference
    
    Signed-off-by: Paul B Mahol <onemda@gmail.com>
    Signed-off-by: Michael Niedermayer <michaelni@gmx.at>

diff --git a/libavformat/segment.c b/libavformat/segment.c
index 1af412ad53..05f76a72c5 100644
--- a/libavformat/segment.c
+++ b/libavformat/segment.c
@@ -174,11 +174,13 @@ static int seg_write_header(AVFormatContext *s)
 
 fail:
     if (ret) {
-        oc->streams = NULL;
-        oc->nb_streams = 0;
+        if (oc) {
+            oc->streams = NULL;
+            oc->nb_streams = 0;
+            avformat_free_context(oc);
+        }
         if (seg->list)
             avio_close(seg->pb);
-        avformat_free_context(oc);
     }
     return ret;
 }

