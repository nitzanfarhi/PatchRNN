commit 027b6ca02192f381a5a91237ba8a8cf625dc6f6a
Author: Trond Myklebust <Trond.Myklebust@netapp.com>
Date:   Tue Dec 23 16:04:13 2008 -0500

    NFSv4: Fix an infinite loop in the NFS state recovery code
    
    Marten Gajda <marten.gajda@fernuni-hagen.de> states:
    
    I tracked the problem down to the function nfs4_do_open_expired.
    Within this function _nfs4_open_expired is called and may return
    -NFS4ERR_DELAY. When a further call to _nfs4_open_expired is
    executed and does not return -NFS4ERR_DELAY the "exception.retry"
    variable is not reset to 0, causing the loop to iterate again
    (and as long as err != -NFS4ERR_DELAY, probably forever)
    
    Signed-off-by: Trond Myklebust <Trond.Myklebust@netapp.com>

diff --git a/fs/nfs/nfs4proc.c b/fs/nfs/nfs4proc.c
index e8df52dc2bc5..49eebe25bbad 100644
--- a/fs/nfs/nfs4proc.c
+++ b/fs/nfs/nfs4proc.c
@@ -1104,8 +1104,9 @@ static inline int nfs4_do_open_expired(struct nfs_open_context *ctx, struct nfs4
 
 	do {
 		err = _nfs4_open_expired(ctx, state);
-		if (err == -NFS4ERR_DELAY)
-			nfs4_handle_exception(server, err, &exception);
+		if (err != -NFS4ERR_DELAY)
+			break;
+		nfs4_handle_exception(server, err, &exception);
 	} while (exception.retry);
 	return err;
 }

