commit 1a867c33bb65f2921351a9bdd98548bb96f0ff8c
Author: Julia Lawall <julia@diku.dk>
Date:   Tue Jul 22 14:18:10 2008 -0700

    IB/ehca: Release mutex in error path of alloc_small_queue_page()
    
    The pd->lock mutex is released on a successful return, so it should be
    released on an error return as well.
    
    The semantic patch that makes this change is as follows:
    (http://www.emn.fr/x-info/coccinelle/)
    
    // <smpl>
    @@
    expression l;
    @@
    
    mutex_lock(l);
    ... when != mutex_unlock(l)
        when any
        when strict
    (
    if (...) { ... when != mutex_unlock(l)
    +   mutex_unlock(l);
        return ...;
    }
    |
    mutex_unlock(l);
    )
    // </smpl>
    
    Signed-off-by: Julia Lawall <julia@diku.dk>
    Signed-off-by: Roland Dreier <rolandd@cisco.com>

diff --git a/drivers/infiniband/hw/ehca/ipz_pt_fn.c b/drivers/infiniband/hw/ehca/ipz_pt_fn.c
index 661f8db62706..c3a328465431 100644
--- a/drivers/infiniband/hw/ehca/ipz_pt_fn.c
+++ b/drivers/infiniband/hw/ehca/ipz_pt_fn.c
@@ -163,6 +163,7 @@ static int alloc_small_queue_page(struct ipz_queue *queue, struct ehca_pd *pd)
 
 out:
 	ehca_err(pd->ib_pd.device, "failed to allocate small queue page");
+	mutex_unlock(&pd->lock);
 	return 0;
 }
 

