commit e8830e606ffee383f073e32313f11fc5692813fe
Author: Miao Xie <miaox@cn.fujitsu.com>
Date:   Wed Sep 19 22:14:29 2012 -0600

    Btrfs: fix memory leak in start_transaction()
    
    This patch fixes memory leak of the transaction handle which happened
    when starting transaction failed on a freezed fs.
    
    Signed-off-by: Miao Xie <miaox@cn.fujitsu.com>

diff --git a/fs/btrfs/transaction.c b/fs/btrfs/transaction.c
index 910ff8051ba9..35489644c247 100644
--- a/fs/btrfs/transaction.c
+++ b/fs/btrfs/transaction.c
@@ -351,8 +351,10 @@ again:
 	 */
 	if (type != TRANS_JOIN_NOLOCK &&
 	    !__sb_start_write(root->fs_info->sb, SB_FREEZE_FS, false)) {
-		if (type == TRANS_JOIN_FREEZE)
+		if (type == TRANS_JOIN_FREEZE) {
+			kmem_cache_free(btrfs_trans_handle_cachep, h);
 			return ERR_PTR(-EPERM);
+		}
 		sb_start_intwrite(root->fs_info->sb);
 	}
 

