commit bd969fac52ad04e97189b194cecb355fb253c2ea
Author: Love Hörnquist Åstrand <lha@kth.se>
Date:   Mon Aug 21 09:19:22 2006 +0000

    (krb5_rd_rep): free krb5_ap_rep_enc_part on error and set return pointer to NULL
    (krb5_free_ap_rep_enc_part): permit freeing of NULL
    
    
    git-svn-id: svn://svn.h5l.se/heimdal/trunk/heimdal@17890 ec53bebd-3082-4978-b11e-865c3cabbd6b

diff --git a/lib/krb5/rd_rep.c b/lib/krb5/rd_rep.c
index 83b786a2a..c710be174 100644
--- a/lib/krb5/rd_rep.c
+++ b/lib/krb5/rd_rep.c
@@ -92,7 +92,10 @@ krb5_rd_rep(krb5_context context,
   
     if (auth_context->flags & KRB5_AUTH_CONTEXT_DO_TIME) { 
 	if ((*repl)->ctime != auth_context->authenticator->ctime ||
-	    (*repl)->cusec != auth_context->authenticator->cusec) {
+	    (*repl)->cusec != auth_context->authenticator->cusec) 
+	{
+	    krb5_free_ap_rep_enc_part(context, *repl);
+	    *repl = NULL;
 	    ret = KRB5KRB_AP_ERR_MUT_FAIL;
 	    krb5_clear_error_string (context);
 	    goto out;
@@ -114,6 +117,8 @@ void KRB5_LIB_FUNCTION
 krb5_free_ap_rep_enc_part (krb5_context context,
 			   krb5_ap_rep_enc_part *val)
 {
-    free_EncAPRepPart (val);
-    free (val);
+    if (val) {
+	free_EncAPRepPart (val);
+	free (val);
+    }
 }

