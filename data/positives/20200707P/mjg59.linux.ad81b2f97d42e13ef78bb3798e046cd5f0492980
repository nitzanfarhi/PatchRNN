commit ad81b2f97d42e13ef78bb3798e046cd5f0492980
Author: Assaf Krauss <assaf.krauss@intel.com>
Date:   Wed Jun 4 20:27:59 2008 +0300

    mac80211: Fixing slow IBSS rejoin
    
    This patch fixes the issue of slow reconnection to an IBSS cell after
    disconnection from it. Now the interface's bssid is reset upon ifdown.
    
    ieee80211_sta_find_ibss:
    if (found && memcmp(ifsta->bssid, bssid, ETH_ALEN) != 0 &&
                (bss = ieee80211_rx_bss_get(dev, bssid,
                                            local->hw.conf.channel->center_freq,
                                            ifsta->ssid, ifsta->ssid_len)))
    
    Note:
    In general disconnection is still not handled properly in mac80211
    
    Signed-off-by: Assaf Krauss <assaf.krauss@intel.com>
    Signed-off-by: Tomas Winkler <tomas.winkler@intel.com>
    Signed-off-by: John W. Linville <linville@tuxdriver.com>

diff --git a/net/mac80211/main.c b/net/mac80211/main.c
index 5c876450b14c..98c0b5e56ecc 100644
--- a/net/mac80211/main.c
+++ b/net/mac80211/main.c
@@ -511,6 +511,7 @@ static int ieee80211_stop(struct net_device *dev)
 	case IEEE80211_IF_TYPE_STA:
 	case IEEE80211_IF_TYPE_IBSS:
 		sdata->u.sta.state = IEEE80211_DISABLED;
+		memset(sdata->u.sta.bssid, 0, ETH_ALEN);
 		del_timer_sync(&sdata->u.sta.timer);
 		/*
 		 * When we get here, the interface is marked down.

