commit ac48e389d073bf2c8703745eef4824fabe0427ba
Author: Kevin Wolf <mail@kevin-wolf.de>
Date:   Fri Sep 10 12:27:02 2010 +0200

    vvfat: Fix segfault on write to read-only disk
    
    vvfat tries to set the readonly flag in its open function, but nowadays
    this is overwritted with the readonly=... command line option. Check in
    bdrv_write if the vvfat was opened read-only and return an error in this
    case.
    
    Without this check, vvfat tries to access the qcow bs, which is NULL
    without enabled write support.
    
    Signed-off-by: Kevin Wolf <mail@kevin-wolf.de>

diff --git a/block/vvfat.c b/block/vvfat.c
index 365332aa21..5898d664b0 100644
--- a/block/vvfat.c
+++ b/block/vvfat.c
@@ -2665,6 +2665,11 @@ static int vvfat_write(BlockDriverState *bs, int64_t sector_num,
 
 DLOG(checkpoint());
 
+    /* Check if we're operating in read-only mode */
+    if (s->qcow == NULL) {
+        return -EACCES;
+    }
+
     vvfat_close_current_file(s);
 
     /*

