commit 8c71897be2ddfd84969412635ca42fa9e137f7b6
Author: Henry C Chang <henry.cy.chang@gmail.com>
Date:   Tue May 3 09:45:16 2011 +0000

    ceph: handle ceph_osdc_new_request failure in ceph_writepages_start
    
    We should unlock the page and return -ENOMEM if ceph_osdc_new_request
    failed.
    
    Signed-off-by: Henry C Chang <henry_c_chang@tcloudcomputing.com>
    Signed-off-by: Sage Weil <sage@newdream.net>

diff --git a/fs/ceph/addr.c b/fs/ceph/addr.c
index e159c529fd2b..38b8ab554924 100644
--- a/fs/ceph/addr.c
+++ b/fs/ceph/addr.c
@@ -775,6 +775,13 @@ static int ceph_writepages_start(struct address_space *mapping,
 					    ci->i_truncate_seq,
 					    ci->i_truncate_size,
 					    &inode->i_mtime, true, 1, 0);
+
+				if (!req) {
+					rc = -ENOMEM;
+					unlock_page(page);
+					break;
+				}
+
 				max_pages = req->r_num_pages;
 
 				alloc_page_vec(fsc, req);

