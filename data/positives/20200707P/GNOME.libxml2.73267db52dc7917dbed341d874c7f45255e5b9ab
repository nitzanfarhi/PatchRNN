commit 73267db52dc7917dbed341d874c7f45255e5b9ab
Author: Igor Zlatkovic <igor@src.gnome.org>
Date:   Sat Mar 8 13:29:24 2003 +0000

    applied Gennady's patch against buffer overrun

diff --git a/encoding.c b/encoding.c
index 3ac35fd3..de55e2e0 100644
--- a/encoding.c
+++ b/encoding.c
@@ -2194,6 +2194,9 @@ retry:
     
     written = out->size - out->use;
 
+    if (written > 0)
+	written--; /* Gennady: count '/0' */
+
     /*
      * First specific handling of in = NULL, i.e. the initialization call
      */
@@ -2202,8 +2205,10 @@ retry:
 	if (handler->output != NULL) {
 	    ret = handler->output(&out->content[out->use], &written,
 				  NULL, &toconv);
-	    out->use += written;
-	    out->content[out->use] = 0;
+	    if (ret == 0) { /* Gennady: check return value */
+		out->use += written;
+		out->content[out->use] = 0;
+	    }
 	}
 #ifdef LIBXML_ICONV_ENABLED
 	else if (handler->iconv_out != NULL) {

