commit 3a5b4efe1d3b6af7fff60ec5c4f4c1160f2fe16d
Author: Josh Durgin <josh.durgin@dreamhost.com>
Date:   Fri Mar 11 18:11:00 2011 -0800

    librbd: don't leak rados_completion
    
    The implementation is already referenced by librados callbacks, so it
    will stick around.

diff --git a/src/librbd.cc b/src/librbd.cc
index 317759c986..050019cffb 100644
--- a/src/librbd.cc
+++ b/src/librbd.cc
@@ -1233,6 +1233,8 @@ int aio_write(ImageCtx *ictx, off_t off, uint64_t len, const char *buf,
     librados::AioCompletion *rados_completion =
       Rados::aio_create_completion(block_completion, NULL, rados_cb);
     r = ictx->data_ctx.aio_write(oid, rados_completion, bl, write_len, block_ofs);
+    rados_completion->release();
+    delete rados_completion;
     if (r < 0)
       goto done;
     total_write += write_len;
@@ -1283,6 +1285,8 @@ int aio_read(ImageCtx *ictx, off_t off, uint64_t len,
     r = ictx->data_ctx.aio_sparse_read(oid, rados_completion,
 				       &block_completion->m, &block_completion->data_bl,
 				       read_len, block_ofs);
+    rados_completion->release();
+    delete rados_completion;
     if (r < 0 && r == -ENOENT)
       r = 0;
     if (r < 0) {

