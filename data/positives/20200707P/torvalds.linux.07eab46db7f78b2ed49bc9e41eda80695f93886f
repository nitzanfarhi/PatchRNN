commit 07eab46db7f78b2ed49bc9e41eda80695f93886f
Author: Jean Delvare <khali@linux-fr.org>
Date:   Wed Nov 23 15:44:31 2005 -0800

    [PATCH] hwmon: Fix missing it87 fan div init
    
    Fix a bug where setting the low fan speed limits will not work if no
    data was ever read through the sysfs interface and the fan clock
    dividers have not been explicitely set yet either. The reason is that
    data->fan_div[nr] may currently be used before it is initialized from
    the chip register values. The fix is to explicitely initialize
    data->fan_div[nr] before using it.
    
    Bug reported, and fix tested, by Nicolas Mailhot.
    
    Signed-off-by: Jean Delvare <khali@linux-fr.org>
    Signed-off-by: Greg Kroah-Hartman <gregkh@suse.de>
    Signed-off-by: Linus Torvalds <torvalds@osdl.org>

diff --git a/drivers/hwmon/it87.c b/drivers/hwmon/it87.c
index 6c41e25e670b..a61f5d00f10a 100644
--- a/drivers/hwmon/it87.c
+++ b/drivers/hwmon/it87.c
@@ -522,8 +522,15 @@ static ssize_t set_fan_min(struct device *dev, struct device_attribute *attr,
 	struct i2c_client *client = to_i2c_client(dev);
 	struct it87_data *data = i2c_get_clientdata(client);
 	int val = simple_strtol(buf, NULL, 10);
+	u8 reg = it87_read_value(client, IT87_REG_FAN_DIV);
 
 	down(&data->update_lock);
+	switch (nr) {
+	case 0: data->fan_div[nr] = reg & 0x07; break;
+	case 1: data->fan_div[nr] = (reg >> 3) & 0x07; break;
+	case 2: data->fan_div[nr] = (reg & 0x40) ? 3 : 1; break;
+	}
+
 	data->fan_min[nr] = FAN_TO_REG(val, DIV_FROM_REG(data->fan_div[nr]));
 	it87_write_value(client, IT87_REG_FAN_MIN(nr), data->fan_min[nr]);
 	up(&data->update_lock);

