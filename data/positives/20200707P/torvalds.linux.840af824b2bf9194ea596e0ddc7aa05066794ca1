commit 840af824b2bf9194ea596e0ddc7aa05066794ca1
Author: Vladislav P <vladisslav@inbox.ru>
Date:   Mon Feb 14 15:21:50 2011 -0200

    Bluetooth: Release BTM while sleeping to avoid deadlock
    
    Signed-off-by: Vladislav P <vladisslav@inbox.ru>
    Signed-off-by: Gustavo F. Padovan <padovan@profusion.mobi>

diff --git a/net/bluetooth/rfcomm/tty.c b/net/bluetooth/rfcomm/tty.c
index 2575c2db6404..d7b9af4703d0 100644
--- a/net/bluetooth/rfcomm/tty.c
+++ b/net/bluetooth/rfcomm/tty.c
@@ -727,7 +727,9 @@ static int rfcomm_tty_open(struct tty_struct *tty, struct file *filp)
 			break;
 		}
 
+		tty_unlock();
 		schedule();
+		tty_lock();
 	}
 	set_current_state(TASK_RUNNING);
 	remove_wait_queue(&dev->wait, &wait);

