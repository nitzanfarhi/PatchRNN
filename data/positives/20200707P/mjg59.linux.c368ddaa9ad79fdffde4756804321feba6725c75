commit c368ddaa9ad79fdffde4756804321feba6725c75
Author: Eytan Lifshitz <eytan.lifshitz@intel.com>
Date:   Thu Feb 6 21:01:32 2014 +0200

    mac80211: fix memory leak
    
    In case ieee80211_prep_connection() fails to dereference
    sdata->vif.chanctx_conf, the function returns and doesn't
    free new_sta. fixed.
    
    Signed-off-by: Eytan Lifshitz <eytan.lifshitz@intel.com>
    Signed-off-by: Johannes Berg <johannes.berg@intel.com>

diff --git a/net/mac80211/mlme.c b/net/mac80211/mlme.c
index fc1d82465b3c..57d5482b10fa 100644
--- a/net/mac80211/mlme.c
+++ b/net/mac80211/mlme.c
@@ -3753,6 +3753,7 @@ static int ieee80211_prep_connection(struct ieee80211_sub_if_data *sdata,
 		chanctx_conf = rcu_dereference(sdata->vif.chanctx_conf);
 		if (WARN_ON(!chanctx_conf)) {
 			rcu_read_unlock();
+			sta_info_free(local, new_sta);
 			return -EINVAL;
 		}
 		rate_flags = ieee80211_chandef_rate_flags(&chanctx_conf->def);

