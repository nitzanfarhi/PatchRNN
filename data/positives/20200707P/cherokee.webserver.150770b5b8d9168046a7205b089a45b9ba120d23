commit 150770b5b8d9168046a7205b089a45b9ba120d23
Author: alobbs <alvaro@alobbs.com>
Date:   Tue Dec 21 13:08:55 2010 +0000

    Fixes a file descriptor leak in the CGI handler. Three file fds could
    be leaked in the forked process where the CGI was executed. Since the
    leak was no incremental over the time, it isn't such a big deal.
    
    git-svn-id: svn://cherokee-project.com/cherokee/trunk@5983 5dc97367-97f1-0310-9951-d761b3857238

diff --git a/cherokee/handler_cgi.c b/cherokee/handler_cgi.c
index ba21938f..a9f64a53 100644
--- a/cherokee/handler_cgi.c
+++ b/cherokee/handler_cgi.c
@@ -533,7 +533,8 @@ manage_child_cgi_process (cherokee_handler_cgi_t *cgi, int pipe_cgi[2], int pipe
 
 	/* Change stdin and out
 	 */
-	re  = dup2 (pipe_server[0], STDIN_FILENO);
+	cherokee_fd_close (STDIN_FILENO);
+	re = dup2 (pipe_server[0], STDIN_FILENO);
 	cherokee_fd_close (pipe_server[0]);
 
 	if (unlikely (re != 0)) {
@@ -542,6 +543,7 @@ manage_child_cgi_process (cherokee_handler_cgi_t *cgi, int pipe_cgi[2], int pipe
 		exit(1);
 	}
 
+	cherokee_fd_close (STDOUT_FILENO);
 	re |= dup2 (pipe_cgi[1], STDOUT_FILENO);
 	cherokee_fd_close (pipe_cgi[1]);
 
@@ -550,6 +552,7 @@ manage_child_cgi_process (cherokee_handler_cgi_t *cgi, int pipe_cgi[2], int pipe
 	if ((CONN_VSRV(conn)->error_writer != NULL) &&
 	    (CONN_VSRV(conn)->error_writer->fd != -1))
 	{
+		cherokee_fd_close (STDERR_FILENO);
 		dup2 (CONN_VSRV(conn)->error_writer->fd, STDERR_FILENO);
 	}
 

