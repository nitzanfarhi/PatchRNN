commit a5b99dd302cd8c84a28f2b45ba02002540129fd7
Author: homm <homm86@gmail.com>
Date:   Sun May 1 17:31:54 2016 +0300

    move checks before mallocs to prevent memory leaks

diff --git a/libImaging/Resample.c b/libImaging/Resample.c
index 64e90eed..144ed6cb 100644
--- a/libImaging/Resample.c
+++ b/libImaging/Resample.c
@@ -139,11 +139,11 @@ ImagingResampleHorizontal(Imaging imIn, int xsize, int filter)
     kmax = (int) ceil(support) * 2 + 1;
 
     // check for overflow
-    if (kmax > 0 && xsize > SIZE_MAX / kmax)
+    if (xsize > SIZE_MAX / (kmax * sizeof(float)))
         return (Imaging) ImagingError_MemoryError();
 
-    // sizeof(float) should be greater than 0
-    if (xsize * kmax > SIZE_MAX / sizeof(float))
+    // sizeof(int) should be greater than 0 as well
+    if (xsize > SIZE_MAX / (2 * sizeof(int)))
         return (Imaging) ImagingError_MemoryError();
 
     /* coefficient buffer */
@@ -151,10 +151,6 @@ ImagingResampleHorizontal(Imaging imIn, int xsize, int filter)
     if ( ! kk)
         return (Imaging) ImagingError_MemoryError();
 
-    // sizeof(int) should be greater than 0 as well
-    if (xsize > SIZE_MAX / (2 * sizeof(int)))
-        return (Imaging) ImagingError_MemoryError();
-
     xbounds = malloc(xsize * 2 * sizeof(int));
     if ( ! xbounds) {
         free(kk);

