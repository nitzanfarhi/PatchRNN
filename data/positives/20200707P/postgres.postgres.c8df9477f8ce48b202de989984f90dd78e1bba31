commit c8df9477f8ce48b202de989984f90dd78e1bba31
Author: Robert Haas <rhaas@postgresql.org>
Date:   Mon Nov 10 15:19:56 2014 -0500

    Fix potential NULL-pointer dereference.
    
    Commit 2781b4bea7db357be59f9a5fd73ca1eb12ff5a79 arranged to defer
    the setup of after-trigger-related data structures, but
    AfterTriggerPendingOnRel didn't get the memo.

diff --git a/src/backend/commands/trigger.c b/src/backend/commands/trigger.c
index 31a5411140..ebccfea3d7 100644
--- a/src/backend/commands/trigger.c
+++ b/src/backend/commands/trigger.c
@@ -4776,7 +4776,7 @@ AfterTriggerPendingOnRel(Oid relid)
 	 * if TRUNCATE/etc is executed by a function or trigger within an updating
 	 * query on the same relation, which is pretty perverse, but let's check.
 	 */
-	for (depth = 0; depth <= afterTriggers.query_depth; depth++)
+	for (depth = 0; depth <= afterTriggers.query_depth && depth < afterTriggers.maxquerydepth; depth++)
 	{
 		for_each_event_chunk(event, chunk, afterTriggers.query_stack[depth])
 		{

