commit 31fb176f8ad3f41b98a761c931a648147a7d3e3b
Author: macvicar <macvicar@facebook.com>
Date:   Tue Nov 9 05:20:07 2010 -0800

    Fix crash when PDO encouters error during connection
    
    Summary:
    If PDO MySQL can't connect it will segfault as it dereferences
    a NULL pointer, the reason is the error handler expects a stmt.
    
    Test Plan:
    No crash with the following:
    <?php
    $dsn = 'mysql:dbname=testdb;host=127.0.0.1';
    $user = 'dbuser';
    $password = 'dbpass';
    
    try {
        $dbh = new PDO($dsn, $user, $password);
    } catch (PDOException $e) {
        echo 'Connection failed: ' . $e->getMessage() . PHP_EOL;
    }
    
    DiffCamp Revision: 180138
    Reviewed By: hzhao
    CC: hzhao, hphp-diffs@lists
    Revert Plan:
    Ok

diff --git a/src/runtime/ext/pdo_mysql.cpp b/src/runtime/ext/pdo_mysql.cpp
index 101ef77497..cacff8f703 100644
--- a/src/runtime/ext/pdo_mysql.cpp
+++ b/src/runtime/ext/pdo_mysql.cpp
@@ -453,8 +453,12 @@ int PDOMySqlConnection::handleError(const char *file, int line,
     strcpy(*pdo_err, mysql_sqlstate(m_server));
   }
 
-  pdo_raise_impl_error(stmt->dbh, NULL, pdo_err[0], einfo->errmsg);
-
+  if (stmt && stmt->stmt()) {
+    pdo_raise_impl_error(stmt->dbh, NULL, pdo_err[0], einfo->errmsg);
+  } else {
+    throw_pdo_exception(null, null, "SQLSTATE[%s] [%d] %s",
+                        pdo_err[0], einfo->errcode, einfo->errmsg);
+  }
   return einfo->errcode;
 }
 

