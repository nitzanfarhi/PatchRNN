commit c420ca076642f0dee6145f1cb9317d6c04955d88
Author: maheshvs <none@none>
Date:   Sat Sep 2 11:40:03 2006 -0700

    6462751 system panics due to race with reaper thread

diff --git a/usr/src/uts/common/fs/nfs/nfs4_state.c b/usr/src/uts/common/fs/nfs/nfs4_state.c
index d7ee054f9f..e87428ca83 100644
--- a/usr/src/uts/common/fs/nfs/nfs4_state.c
+++ b/usr/src/uts/common/fs/nfs/nfs4_state.c
@@ -2998,11 +2998,20 @@ rfs4_state_close(rfs4_state_t *sp, bool_t lock_held,
 	/* Remove the associated lo_state owners */
 	if (!lock_held)
 		rfs4_dbe_lock(sp->dbe);
-	if (sp->closed == FALSE) {
-		sp->closed = TRUE;
 
-		rfs4_release_share_lock_state(sp, cr, close_of_client);
+	/*
+	 * If refcnt == 0, the dbe is about to be destroyed.
+	 * lock state will be released by the reaper thread.
+	 */
+
+	if (rfs4_dbe_refcnt(sp->dbe) > 0) {
+		if (sp->closed == FALSE) {
+			sp->closed = TRUE;
+
+			rfs4_release_share_lock_state(sp, cr, close_of_client);
+		}
 	}
+
 	if (!lock_held)
 		rfs4_dbe_unlock(sp->dbe);
 }

