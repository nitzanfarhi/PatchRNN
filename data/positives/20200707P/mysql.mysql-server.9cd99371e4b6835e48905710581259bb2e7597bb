commit 9cd99371e4b6835e48905710581259bb2e7597bb
Author: Vasil Dimov <vasil.dimov@oracle.com>
Date:   Fri Nov 16 08:49:24 2012 +0200

    Followup to Bug#14805484 LOCKS ON SYS_* TABLES/RECORDS EXIST WHEN
    UNLOCKING DATA DICTIONARY
    
    Add asserts that we do not hold any locks on SYS_* objects when
    unlocking the data dictionary. Doing so is forbidden as it may cause
    deadlock or a lock wait of a trx that operates on SYS_*.
    
    Discussed with: Marko, Sunny

diff --git a/storage/innobase/row/row0mysql.cc b/storage/innobase/row/row0mysql.cc
index 8853fb6a757..f34207eb524 100644
--- a/storage/innobase/row/row0mysql.cc
+++ b/storage/innobase/row/row0mysql.cc
@@ -2056,6 +2056,8 @@ row_mysql_unfreeze_data_dictionary(
 /*===============================*/
 	trx_t*	trx)	/*!< in/out: transaction */
 {
+	ut_ad(lock_trx_has_sys_table_locks(trx) == NULL);
+
 	ut_a(trx->dict_operation_lock_mode == RW_S_LATCH);
 
 	rw_lock_s_unlock(&dict_operation_lock);
@@ -2094,6 +2096,8 @@ row_mysql_unlock_data_dictionary(
 /*=============================*/
 	trx_t*	trx)	/*!< in/out: transaction */
 {
+	ut_ad(lock_trx_has_sys_table_locks(trx) == NULL);
+
 	ut_a(trx->dict_operation_lock_mode == RW_X_LATCH);
 
 	/* Serialize data dictionary operations with dictionary mutex:

