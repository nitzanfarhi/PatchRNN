commit 7ce86aa1aafaa65e7d3e572873bdf37bdb896f49
Author: Hans de Goede <hdegoede@redhat.com>
Date:   Tue Aug 28 11:50:26 2012 +0200

    ehci: Fix NULL ptr deref when unplugging an USB dev with an iso stream active
    
    Signed-off-by: Hans de Goede <hdegoede@redhat.com>

diff --git a/hw/usb/hcd-ehci.c b/hw/usb/hcd-ehci.c
index f43d690eb5..a3aea6debe 100644
--- a/hw/usb/hcd-ehci.c
+++ b/hw/usb/hcd-ehci.c
@@ -1598,7 +1598,7 @@ static int ehci_process_itd(EHCIState *ehci,
 
             dev = ehci_find_device(ehci, devaddr);
             ep = usb_ep_get(dev, pid, endp);
-            if (ep->type == USB_ENDPOINT_XFER_ISOC) {
+            if (ep && ep->type == USB_ENDPOINT_XFER_ISOC) {
                 usb_packet_setup(&ehci->ipacket, pid, ep, addr);
                 usb_packet_map(&ehci->ipacket, &ehci->isgl);
                 ret = usb_handle_packet(dev, &ehci->ipacket);

