commit b7d2b9a0003ac7df60d94b82ca3ce1e63b16cf40
Author: Rodrigo Kumpera <kumpera@gmail.com>
Date:   Fri Jan 17 18:13:57 2014 -0500

    The shutdown check is racy, we should check if the queue has been cleaned up instead.

diff --git a/mono/metadata/threadpool.c b/mono/metadata/threadpool.c
index 8710dafd661..6d0996e444a 100644
--- a/mono/metadata/threadpool.c
+++ b/mono/metadata/threadpool.c
@@ -1300,9 +1300,10 @@ try_steal (MonoWSQ *local_wsq, gpointer *data, gboolean retry)
 static gboolean
 dequeue_or_steal (ThreadPool *tp, gpointer *data, MonoWSQ *local_wsq)
 {
-	if (mono_runtime_is_shutting_down ())
+	MonoCQ *queue = tp->queue;
+	if (mono_runtime_is_shutting_down () || !queue)
 		return FALSE;
-	mono_cq_dequeue (tp->queue, (MonoObject **) data);
+	mono_cq_dequeue (queue, (MonoObject **) data);
 	if (!tp->is_io && !*data)
 		try_steal (local_wsq, data, FALSE);
 	return (*data != NULL);

