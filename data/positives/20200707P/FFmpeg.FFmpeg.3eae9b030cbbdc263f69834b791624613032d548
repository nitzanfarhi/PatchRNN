commit 3eae9b030cbbdc263f69834b791624613032d548
Author: Janne Grunau <janne-libav@jannau.net>
Date:   Tue May 21 17:39:27 2013 +0200

    mpegvideo: unref buffers in ff_mpeg_unref_picture on frame size changes
    
    ff_mpeg_unref_picture clears the flag indicating that the frame needs to
    be reallocated after a frame size change. Since we have now reference
    counted buffers we can unref the buffers immediately.

diff --git a/libavcodec/mpegvideo.c b/libavcodec/mpegvideo.c
index b175d32ff1..c9a425abfa 100644
--- a/libavcodec/mpegvideo.c
+++ b/libavcodec/mpegvideo.c
@@ -435,6 +435,9 @@ void ff_mpeg_unref_picture(MpegEncContext *s, Picture *pic)
 
     av_buffer_unref(&pic->hwaccel_priv_buf);
 
+    if (pic->needs_realloc)
+        free_picture_tables(pic);
+
     memset((uint8_t*)pic + off, 0, sizeof(*pic) - off);
 }
 

