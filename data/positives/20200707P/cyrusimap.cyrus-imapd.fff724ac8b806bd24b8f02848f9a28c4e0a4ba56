commit fff724ac8b806bd24b8f02848f9a28c4e0a4ba56
Author: Rob Siemborski <rjs3@andrew.cmu.edu>
Date:   Tue Jul 16 19:58:56 2002 +0000

    fix a fd leak if db_open or db_create fails

diff --git a/lib/auth_krb_pts.c b/lib/auth_krb_pts.c
index 41ae7345a..6b56b2a38 100644
--- a/lib/auth_krb_pts.c
+++ b/lib/auth_krb_pts.c
@@ -1,5 +1,5 @@
 /* auth_krb_pts.c -- Kerberos authorization with AFS PTServer groups
- * $Id: auth_krb_pts.c,v 1.44 2002/02/25 16:52:42 rjs3 Exp $
+ * $Id: auth_krb_pts.c,v 1.45 2002/07/16 19:58:56 rjs3 Exp $
  * Copyright (c) 1998-2000 Carnegie Mellon University.  All rights reserved.
  *
  * Redistribution and use in source and binary forms, with or without
@@ -392,6 +392,7 @@ struct auth_state *auth_newstate(const char *identifier,
     }
     if (lock_shared(fd) < 0) {
         syslog(LOG_ERR, "IOERROR: locking lock file %s: %m", fnamebuf);
+	close(fd);
         return newstate;
     }
     strcpy(fnamebuf, STATEDIR);
@@ -402,6 +403,7 @@ struct auth_state *auth_newstate(const char *identifier,
 
     if (r != 0) {
 	syslog(LOG_ERR, "auth_newstate: db_create: %s", db_strerror(r));
+	close(fd);
 	return newstate;
     }
     
@@ -414,6 +416,7 @@ struct auth_state *auth_newstate(const char *identifier,
     if (r != 0) {
 	syslog(LOG_ERR, "auth_newstate: opening %s: %s", fnamebuf, 
 	       db_strerror(r));
+	close(fd);
 	return newstate;
     }
 

