commit 4c2ecfafd746411b07b8de10b91f5fd26fdd9cb3
Author: Lennart Poettering <lennart@poettering.net>
Date:   Tue Jul 3 12:23:33 2012 +0200

    journald: handle /proc/kmsg reads returning 0 more nicely

diff --git a/src/journal/journald.c b/src/journal/journald.c
index 08597ae3e..d2e2fcaca 100644
--- a/src/journal/journald.c
+++ b/src/journal/journald.c
@@ -2148,6 +2148,10 @@ static int server_read_proc_kmsg(Server *s) {
         assert(s->proc_kmsg_fd >= 0);
 
         l = read(s->proc_kmsg_fd, s->proc_kmsg_buffer + s->proc_kmsg_length, sizeof(s->proc_kmsg_buffer) - 1 - s->proc_kmsg_length);
+        if (l == 0) /* the kernel is stupid and in some race
+                     * conditions returns 0 in the middle of the
+                     * stream. */
+                return 0;
         if (l < 0) {
 
                 if (errno == EAGAIN || errno == EINTR)

