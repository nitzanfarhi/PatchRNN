commit 7b89d4da51e5f07764dfb1f3ca682037d79cf0a9
Author: Hoa V. DINH <dinh.viet.hoa@gmail.com>
Date:   Mon Jul 21 23:53:13 2014 -0700

    More memory leaks

diff --git a/src/data-types/mailstream_cfstream.c b/src/data-types/mailstream_cfstream.c
index a82f183..336fc95 100644
--- a/src/data-types/mailstream_cfstream.c
+++ b/src/data-types/mailstream_cfstream.c
@@ -179,11 +179,13 @@ static void cfstream_data_free(struct mailstream_cfstream_data * cfstream_data)
 static void cfstream_data_close(struct mailstream_cfstream_data * cfstream_data)
 {
   if (cfstream_data->writeStream != NULL) {
+    CFWriteStreamSetClient(cfstream_data->writeStream, kCFStreamEventNone, NULL, NULL);
     CFWriteStreamClose(cfstream_data->writeStream);
     CFRelease(cfstream_data->writeStream);
     cfstream_data->writeStream = NULL;
   }
   if (cfstream_data->readStream != NULL) {
+    CFReadStreamSetClient(cfstream_data->readStream, kCFStreamEventNone, NULL, NULL);
     CFReadStreamClose(cfstream_data->readStream);
     CFRelease(cfstream_data->readStream);
     cfstream_data->readStream = NULL;
diff --git a/src/data-types/mailstream_compress.c b/src/data-types/mailstream_compress.c
index 054badc..99f60fc 100644
--- a/src/data-types/mailstream_compress.c
+++ b/src/data-types/mailstream_compress.c
@@ -244,7 +244,7 @@ static int mailstream_low_compress_close(mailstream_low * s)
 {
 #if HAVE_ZLIB
   compress_data * data = s->data;
-  return data->ms->driver->mailstream_close(data->ms);
+  mailstream_low_close(data->ms);
 #else
   return 0;
 #endif
@@ -274,7 +274,7 @@ static void mailstream_low_compress_free(mailstream_low * s)
 {
 #if HAVE_ZLIB
   compress_data * data = s->data;
-  data->ms->driver->mailstream_free(data->ms);
+  mailstream_low_free(data->ms);
   if (data->compress_stream) {
     deflateEnd(data->compress_stream);
     free(data->compress_stream);

