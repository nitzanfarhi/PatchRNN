commit 64b840dd88eb2054f86c72ed6d989cb8681f0058
Author: Brian King <brking@linux.vnet.ibm.com>
Date:   Thu Jan 22 15:45:38 2009 -0600

    [SCSI] ibmvfc: Fix DMA mapping leak on memory allocation failure
    
    There is currently a DMA mapping leak that can occur in the ibmvfc
    driver if we fail to allocate a scatterlist. Fix this by unmapping
    the scatterlist in the failure path. Additionally, only log an error
    for a scatterlist allocation failure if the log level is greater
    than the default, since this can occur when running Active Memory
    Sharing and this is not considered an error.
    
    Signed-off-by: Brian King <brking@linux.vnet.ibm.com>
    Signed-off-by: James Bottomley <James.Bottomley@HansenPartnership.com>

diff --git a/drivers/scsi/ibmvscsi/ibmvfc.c b/drivers/scsi/ibmvscsi/ibmvfc.c
index 91ef669d98f6..a1a511bdec8c 100644
--- a/drivers/scsi/ibmvscsi/ibmvfc.c
+++ b/drivers/scsi/ibmvscsi/ibmvfc.c
@@ -1322,7 +1322,9 @@ static int ibmvfc_map_sg_data(struct scsi_cmnd *scmd,
 					       &evt->ext_list_token);
 
 		if (!evt->ext_list) {
-			scmd_printk(KERN_ERR, scmd, "Can't allocate memory for scatterlist\n");
+			scsi_dma_unmap(scmd);
+			if (vhost->log_level > IBMVFC_DEFAULT_LOG_LEVEL)
+				scmd_printk(KERN_ERR, scmd, "Can't allocate memory for scatterlist\n");
 			return -ENOMEM;
 		}
 	}

