commit 4a6e1c793027e30750d1adbcec6f955ace2e26a7
Author: dlg <dlg@openbsd.org>
Date:   Tue Jul 1 02:31:16 2014 +0000

    take the biglock before calling the xs completion handler.
    
    should be safe to call the midlayer io path without the biglock now.

diff --git a/sys/scsi/scsi_base.c b/sys/scsi/scsi_base.c
index 9a5b6dce0d2..9cf6b450dd3 100644
--- a/sys/scsi/scsi_base.c
+++ b/sys/scsi/scsi_base.c
@@ -1,4 +1,4 @@
-/*	$OpenBSD: scsi_base.c,v 1.213 2014/07/01 02:11:46 dlg Exp $	*/
+/*	$OpenBSD: scsi_base.c,v 1.214 2014/07/01 02:31:16 dlg Exp $	*/
 /*	$NetBSD: scsi_base.c,v 1.43 1997/04/02 02:29:36 mycroft Exp $	*/
 
 /*
@@ -1303,7 +1303,9 @@ scsi_done(struct scsi_xfer *xs)
 #endif /* SCSIDEBUG */
 
 	SET(xs->flags, ITSDONE);
+	KERNEL_LOCK();
 	xs->done(xs);
+	KERNEL_UNLOCK();
 }
 
 int

