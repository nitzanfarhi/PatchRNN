commit 994fed2dd2166f86b62ec53c7424660145f138ee
Author: Stefan Weil <weil@mail.berlios.de>
Date:   Sun Jan 30 21:41:44 2011 +0100

    MIPS: Loongson: Fix potentially wrong string handling
    
    This error was reported by cppcheck:
    arch/mips/loongson/common/machtype.c:56: error: Dangerous usage of 'str' (strncpy doesn't always 0-terminate it)
    
    If strncpy copied MACHTYPE_LEN bytes, the destination string str
    was not terminated.
    
    The patch adds one more byte to str and makes sure that this byte is
    always 0.
    
    Signed-off-by: Stefan Weil <weil@mail.berlios.de>
    Cc: Wu Zhangjin <wuzhangjin@gmail.com>
    Cc: Arnaud Patard <apatard@mandriva.com>
    Cc: linux-mips@linux-mips.org
    Cc: linux-kernel@vger.kernel.org
    Patchwork: https://patchwork.linux-mips.org/patch/2053/
    Signed-off-by: Ralf Baechle <ralf@linux-mips.org>

diff --git a/arch/mips/loongson/common/machtype.c b/arch/mips/loongson/common/machtype.c
index 81fbe6b73f91..2efd5d9dee27 100644
--- a/arch/mips/loongson/common/machtype.c
+++ b/arch/mips/loongson/common/machtype.c
@@ -41,7 +41,7 @@ void __weak __init mach_prom_init_machtype(void)
 
 void __init prom_init_machtype(void)
 {
-	char *p, str[MACHTYPE_LEN];
+	char *p, str[MACHTYPE_LEN + 1];
 	int machtype = MACH_LEMOTE_FL2E;
 
 	mips_machtype = LOONGSON_MACHTYPE;
@@ -53,6 +53,7 @@ void __init prom_init_machtype(void)
 	}
 	p += strlen("machtype=");
 	strncpy(str, p, MACHTYPE_LEN);
+	str[MACHTYPE_LEN] = '\0';
 	p = strstr(str, " ");
 	if (p)
 		*p = '\0';

