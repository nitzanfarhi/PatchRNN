commit 932f0549f872cde022eed200910ee3291b1d3c69
Author: Stefan Haberland <stefan.haberland@de.ibm.com>
Date:   Mon Nov 24 10:59:44 2014 +0100

    s390/dasd: fix list corruption for sleep_on requests
    
    Fix race for sleep_on requests leading to list corruption.
    The SLEEP_ON_END_TAG is set during CQR clean up. Remove it from
    interrupt handler to avoid the CQR from being cleared when it is
    still in the device_queue.
    
    Signed-off-by: Stefan Haberland <stefan.haberland@de.ibm.com>
    Signed-off-by: Martin Schwidefsky <schwidefsky@de.ibm.com>

diff --git a/drivers/s390/block/dasd.c b/drivers/s390/block/dasd.c
index 8cb120e9c868..4abf11965484 100644
--- a/drivers/s390/block/dasd.c
+++ b/drivers/s390/block/dasd.c
@@ -1697,11 +1697,8 @@ void dasd_int_handler(struct ccw_device *cdev, unsigned long intparm,
 	if (cqr->status == DASD_CQR_CLEAR_PENDING &&
 	    scsw_fctl(&irb->scsw) & SCSW_FCTL_CLEAR_FUNC) {
 		cqr->status = DASD_CQR_CLEARED;
-		if (cqr->callback_data == DASD_SLEEPON_START_TAG)
-			cqr->callback_data = DASD_SLEEPON_END_TAG;
 		dasd_device_clear_timer(device);
 		wake_up(&dasd_flush_wq);
-		wake_up(&generic_waitq);
 		dasd_schedule_device_bh(device);
 		return;
 	}

