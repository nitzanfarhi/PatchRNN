commit f3cb4cc120177090b0ccc9fb20a12010de39ac8a
Author: Pavel Roskin <proski@gnu.org>
Date:   Fri Sep 23 04:18:06 2005 -0400

    [PATCH] orinoco: Fix memory leak and unneeded unlock in orinoco_join_ap()
    
    Signed-off-by: Pavel Roskin <proski@gnu.org>
    
    Fix memory leak and unneeded unlock in orinoco_join_ap()
    
    If orinoco_lock() fails, the code would still run orinoco_unlock(),
    instead of freeing the allocated memory.  Found by sparse.
    Signed-off-by: Jeff Garzik <jgarzik@pobox.com>

diff --git a/drivers/net/wireless/orinoco.c b/drivers/net/wireless/orinoco.c
index f76fe3d10248..8b93b44291d4 100644
--- a/drivers/net/wireless/orinoco.c
+++ b/drivers/net/wireless/orinoco.c
@@ -1046,7 +1046,7 @@ static void orinoco_join_ap(struct net_device *dev)
 		return;
 
 	if (orinoco_lock(priv, &flags) != 0)
-		goto out;
+		goto fail_lock;
 
 	/* Sanity checks in case user changed something in the meantime */
 	if (! priv->bssid_fixed)
@@ -1091,8 +1091,10 @@ static void orinoco_join_ap(struct net_device *dev)
 		printk(KERN_ERR "%s: Error issuing join request\n", dev->name);
 
  out:
-	kfree(buf);
 	orinoco_unlock(priv, &flags);
+
+ fail_lock:
+	kfree(buf);
 }
 
 /* Send new BSSID to userspace */

