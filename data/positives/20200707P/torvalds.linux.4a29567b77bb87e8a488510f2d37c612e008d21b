commit 4a29567b77bb87e8a488510f2d37c612e008d21b
Author: Peter Chen <peter.chen@freescale.com>
Date:   Tue Sep 10 15:34:39 2013 +0800

    chipidea: udc: free pending TD at removal procedure
    
    There is a pending TD which is not freed after request finishes,
    we do this due to a controller bug. This TD needs to be freed when
    the driver is removed. It prints below error message when unload
    chipidea driver at current code:
    "ci_hdrc ci_hdrc.0: dma_pool_destroy ci_hw_td, b0001000 busy"
    It indicates the buffer at dma pool are still in use.
    
    This commit will free the pending TD at driver's removal procedure,
    it can fix the problem described above.
    
    Signed-off-by: Peter Chen <peter.chen@freescale.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

diff --git a/drivers/usb/chipidea/udc.c b/drivers/usb/chipidea/udc.c
index 6b4c2f2eb946..4ef4edf2990f 100644
--- a/drivers/usb/chipidea/udc.c
+++ b/drivers/usb/chipidea/udc.c
@@ -1600,6 +1600,8 @@ static void destroy_eps(struct ci_hdrc *ci)
 	for (i = 0; i < ci->hw_ep_max; i++) {
 		struct ci_hw_ep *hwep = &ci->ci_hw_ep[i];
 
+		if (hwep->pending_td)
+			free_pending_td(hwep);
 		dma_pool_free(ci->qh_pool, hwep->qh.ptr, hwep->qh.dma);
 	}
 }

