commit bf494e94556f9a4a27e17347f428abe8acda6e05
Author: Sage Weil <sage@redhat.com>
Date:   Mon Aug 7 09:36:54 2017 -0400

    crush/CrushWrapper: fix out of bounds access
    
    Fixes: http://tracker.ceph.com/issues/20926
    Signed-off-by: Sage Weil <sage@redhat.com>

diff --git a/src/crush/CrushWrapper.cc b/src/crush/CrushWrapper.cc
index 9c03358aad..05e031c86f 100644
--- a/src/crush/CrushWrapper.cc
+++ b/src/crush/CrushWrapper.cc
@@ -1916,7 +1916,7 @@ int CrushWrapper::device_class_clone(
     // pick a new shadow bucket id that is not used by the current map
     // *or* any previous shadow buckets.
     bno = -1;
-    while (crush->buckets[-1-bno] ||
+    while (((-1-bno) < crush->max_buckets && crush->buckets[-1-bno]) ||
 	   used_ids.count(bno)) {
       --bno;
     }

