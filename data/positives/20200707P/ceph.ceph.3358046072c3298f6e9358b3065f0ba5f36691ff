commit 3358046072c3298f6e9358b3065f0ba5f36691ff
Author: Sage Weil <sage@newdream.net>
Date:   Tue Nov 16 09:47:34 2010 -0800

    mds: set dir hash on root inode
    
    Signed-off-by: Sage Weil <sage@newdream.net>

diff --git a/src/mds/MDCache.cc b/src/mds/MDCache.cc
index db106a700e..c106a07d6c 100644
--- a/src/mds/MDCache.cc
+++ b/src/mds/MDCache.cc
@@ -256,10 +256,14 @@ CInode *MDCache::create_system_inode(inodeno_t ino, int mode)
     in->inode.mtime = g_clock.now();
   in->inode.nlink = 1;
   in->inode.truncate_size = -1ull;
-  if (in->inode.is_dir())
+
+  memset(&in->inode.dir_layout, 0, sizeof(in->inode.dir_layout));
+  if (in->inode.is_dir()) {
     memset(&in->inode.layout, 0, sizeof(in->inode.layout));
-  else
+    in->inode.dir_layout.dl_dir_hash = g_conf.mds_default_dir_hash;
+  } else {
     in->inode.layout = default_file_layout;
+  }
 
   if (in->is_base()) {
     if (in->is_root())

