commit f50c995f9ebf064cea1368bf361c4e29679415b4
Author: Marek Roszko <mark.roszko@gmail.com>
Date:   Tue Jan 7 11:45:07 2014 +0100

    tty/serial: at91: fix race condition in atmel_serial_remove
    
    The _remove callback could be called when a tasklet is scheduled. tasklet_kill
    was called inside the function in order to free up any scheduled tasklets.
    However it was called after uart_remove_one_port which destroys tty references
    needed in the port for atmel_tasklet_func.
    Simply putting the tasklet_kill at the start of the function will prevent this
    conflict.
    
    Signed-off-by: Marek Roszko <mark.roszko@gmail.com>
    Acked-by: Leilei Zhao <leilei.zhao@atmel.com>
    Cc: <stable@vger.kernel.org> # v3.12
    Signed-off-by: Nicolas Ferre <nicolas.ferre@atmel.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

diff --git a/drivers/tty/serial/atmel_serial.c b/drivers/tty/serial/atmel_serial.c
index 48ea47a32d5f..c421d11b3d4c 100644
--- a/drivers/tty/serial/atmel_serial.c
+++ b/drivers/tty/serial/atmel_serial.c
@@ -2447,11 +2447,12 @@ static int atmel_serial_remove(struct platform_device *pdev)
 	struct atmel_uart_port *atmel_port = to_atmel_uart_port(port);
 	int ret = 0;
 
+	tasklet_kill(&atmel_port->tasklet);
+
 	device_init_wakeup(&pdev->dev, 0);
 
 	ret = uart_remove_one_port(&atmel_uart, port);
 
-	tasklet_kill(&atmel_port->tasklet);
 	kfree(atmel_port->rx_ring.buf);
 
 	/* "port" is allocated statically, so we shouldn't free it */

