commit ffc548bb3601f0250474afcfa10ceb0b8b8b9764
Author: Bart Van Assche <bart.vanassche@sandisk.com>
Date:   Fri Apr 22 14:14:15 2016 -0700

    IB/srp: Avoid that mapping failure triggers an infinite loop
    
    The srp_queuecommand() function translates ENOMEM into QUEUE_FULL
    which causes the SCSI mid-layer to retry the command. All other
    error codes are translated into DID_ERROR which causes the SCSI
    command to fail. Return E2BIG if mapping will always fail to
    prevent that the SCSI mid-layer keeps resubmitting a command
    forever.
    
    Signed-off-by: Bart Van Assche <bart.vanassche@sandisk.com>
    Cc: Christoph Hellwig <hch@lst.de>
    Cc: Sagi Grimberg <sagi@grimberg.me>
    Cc: Laurence Oberman <loberman@redhat.com>
    Reviewed-by: Christoph Hellwig <hch@lst.de>
    Signed-off-by: Doug Ledford <dledford@redhat.com>

diff --git a/drivers/infiniband/ulp/srp/ib_srp.c b/drivers/infiniband/ulp/srp/ib_srp.c
index 92d2d98c9831..fbd2edbedf05 100644
--- a/drivers/infiniband/ulp/srp/ib_srp.c
+++ b/drivers/infiniband/ulp/srp/ib_srp.c
@@ -1681,6 +1681,8 @@ static int srp_map_data(struct scsi_cmnd *scmnd, struct srp_rdma_ch *ch,
 
 unmap:
 	srp_unmap_data(scmnd, ch, req);
+	if (ret == -ENOMEM && req->nmdesc >= target->mr_pool_size)
+		ret = -E2BIG;
 	return ret;
 }
 

