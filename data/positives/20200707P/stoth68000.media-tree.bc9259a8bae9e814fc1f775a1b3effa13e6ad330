commit bc9259a8bae9e814fc1f775a1b3effa13e6ad330
Author: Nicolas Dichtel <nicolas.dichtel@6wind.com>
Date:   Thu Sep 27 04:11:00 2012 +0000

    inetpeer: fix token initialization
    
    When jiffies wraps around (for example, 5 minutes after the boot, see
    INITIAL_JIFFIES) and peer has just been created, now - peer->rate_last can be
    < XRLIM_BURST_FACTOR * timeout, so token is not set to the maximum value, thus
    some icmp packets can be unexpectedly dropped.
    
    Fix this case by initializing last_rate to 60 seconds in the past.
    
    Signed-off-by: Nicolas Dichtel <nicolas.dichtel@6wind.com>
    Signed-off-by: Eric Dumazet <edumazet@google.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

diff --git a/net/ipv4/inetpeer.c b/net/ipv4/inetpeer.c
index e1e0a4e8fd34..c7527f6b9ad9 100644
--- a/net/ipv4/inetpeer.c
+++ b/net/ipv4/inetpeer.c
@@ -510,7 +510,10 @@ struct inet_peer *inet_getpeer(struct inet_peer_base *base,
 					secure_ipv6_id(daddr->addr.a6));
 		p->metrics[RTAX_LOCK-1] = INETPEER_METRICS_NEW;
 		p->rate_tokens = 0;
-		p->rate_last = 0;
+		/* 60*HZ is arbitrary, but chosen enough high so that the first
+		 * calculation of tokens is at its maximum.
+		 */
+		p->rate_last = jiffies - 60*HZ;
 		INIT_LIST_HEAD(&p->gc_list);
 
 		/* Link the node. */

