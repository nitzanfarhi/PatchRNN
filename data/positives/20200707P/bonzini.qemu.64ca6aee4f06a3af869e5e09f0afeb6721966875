commit 64ca6aee4f06a3af869e5e09f0afeb6721966875
Author: Kevin Wolf <kwolf@redhat.com>
Date:   Wed Feb 22 12:37:13 2012 +0100

    qcow2: Reject too large header extensions
    
    Image files that make qemu-img info read several gigabytes into the
    unknown header extensions list are bad. Just fail opening the image
    if an extension claims to be larger than the header extension area.
    
    Signed-off-by: Kevin Wolf <kwolf@redhat.com>
    Reviewed-by: Stefan Hajnoczi <stefanha@linux.vnet.ibm.com>

diff --git a/block/qcow2.c b/block/qcow2.c
index f68f0e1074..eb5ea485d9 100644
--- a/block/qcow2.c
+++ b/block/qcow2.c
@@ -108,6 +108,11 @@ static int qcow2_read_extensions(BlockDriverState *bs, uint64_t start_offset,
 #ifdef DEBUG_EXT
         printf("ext.magic = 0x%x\n", ext.magic);
 #endif
+        if (ext.len > end_offset - offset) {
+            error_report("Header extension too large");
+            return -EINVAL;
+        }
+
         switch (ext.magic) {
         case QCOW2_EXT_MAGIC_END:
             return 0;

