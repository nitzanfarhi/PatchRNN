commit 0abafd0e9aaac2d71191197b57e2d200ac2f30d4
Author: sth <sth@c6295689-39f2-0310-b995-f0e70906c6a9>
Date:   Thu Mar 27 16:08:10 2003 +0000

    Fix: root certs could be shown more then once
    
    
    git-svn-id: https://www.opensc-project.org/svnp/opensc/trunk@965 c6295689-39f2-0310-b995-f0e70906c6a9

diff --git a/src/pkcs11/framework-pkcs15.c b/src/pkcs11/framework-pkcs15.c
index 6bd50e90..df74e003 100644
--- a/src/pkcs11/framework-pkcs15.c
+++ b/src/pkcs11/framework-pkcs15.c
@@ -382,6 +382,19 @@ pkcs15_bind_related_objects(struct pkcs15_fw_data *fw_data)
 	}
 }
 
+static int
+pool_is_present(struct sc_pkcs11_pool *pool, struct pkcs15_any_object *obj)
+{
+	struct sc_pkcs11_pool_item *item;
+
+	for (item = pool->head; item != NULL; item = item->next) {
+		if (obj == (struct pkcs15_any_object *) item->item)
+			return 1;
+	}
+
+	return 0;
+}
+
 static void
 pkcs15_add_object(struct sc_pkcs11_slot *slot,
 		  struct pkcs15_any_object *obj,
@@ -390,6 +403,9 @@ pkcs15_add_object(struct sc_pkcs11_slot *slot,
 	if (obj == NULL)
 		return;
 
+	if (pool_is_present(&slot->object_pool, obj))
+		return;
+
 	pool_insert(&slot->object_pool, obj, pHandle);
 	obj->base.flags |= SC_PKCS11_OBJECT_SEEN;
 	obj->refcount++;

