commit 40d3dfe15f0068009eaddacc3ded2afa9c994fa0
Author: marks <none@none>
Date:   Wed May 7 14:09:56 2008 -0700

    6698415 on zfs root, ace_walk oversteps its bounds, causing panic when kmem_flags is set to 0x4f
    6698707 zfs_mountroot() shouldn't release rootvp

diff --git a/usr/src/common/acl/acl_common.c b/usr/src/common/acl/acl_common.c
index b47a40b1e3..94a9fc9c11 100644
--- a/usr/src/common/acl/acl_common.c
+++ b/usr/src/common/acl/acl_common.c
@@ -293,14 +293,14 @@ ace_walk(void *datap, uint64_t cookie, int aclcnt, uint16_t *flags,
 {
 	ace_t *acep = datap;
 
+	if (cookie >= aclcnt)
+		return (0);
+
 	*flags = acep[cookie].a_flags;
 	*type = acep[cookie].a_type;
 	*mask = acep[cookie++].a_access_mask;
 
-	if (cookie > aclcnt)
-		return (0);
-	else
-		return (cookie);
+	return (cookie);
 }
 
 int
diff --git a/usr/src/uts/common/fs/zfs/zfs_vfsops.c b/usr/src/uts/common/fs/zfs/zfs_vfsops.c
index c524cb5eaa..6c173c22ad 100644
--- a/usr/src/uts/common/fs/zfs/zfs_vfsops.c
+++ b/usr/src/uts/common/fs/zfs/zfs_vfsops.c
@@ -930,10 +930,8 @@ zfs_mountroot(vfs_t *vfsp, enum whymountroot why)
 		rootvp = vp;
 
 		/*
-		 * The zfs_zget call above returns with a hold on vp, we release
-		 * it here.
+		 * Leave rootvp held.  The root file system is never unmounted.
 		 */
-		VN_RELE(vp);
 
 		vfs_add((struct vnode *)0, vfsp,
 		    (vfsp->vfs_flag & VFS_RDONLY) ? MS_RDONLY : 0);

