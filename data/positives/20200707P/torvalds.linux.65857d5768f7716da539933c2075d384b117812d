commit 65857d5768f7716da539933c2075d384b117812d
Author: Trond Myklebust <Trond.Myklebust@netapp.com>
Date:   Mon Sep 24 13:49:27 2012 -0400

    NFSv4.1: _pnfs_return_layout() shouldn't invalidate the layout on failure
    
    Failure of the layoutreturn allocation fails is not a good reason to
    mark the pnfs_layout_hdr as having failed a layoutget or i/o. Just
    exit cleanly.
    
    Signed-off-by: Trond Myklebust <Trond.Myklebust@netapp.com>

diff --git a/fs/nfs/pnfs.c b/fs/nfs/pnfs.c
index 20a1b6222ff6..d737557747b9 100644
--- a/fs/nfs/pnfs.c
+++ b/fs/nfs/pnfs.c
@@ -718,8 +718,9 @@ _pnfs_return_layout(struct inode *ino)
 	lrp = kzalloc(sizeof(*lrp), GFP_KERNEL);
 	if (unlikely(lrp == NULL)) {
 		status = -ENOMEM;
-		pnfs_layout_io_set_failed(lo, IOMODE_RW);
-		pnfs_layout_io_set_failed(lo, IOMODE_READ);
+		spin_lock(&ino->i_lock);
+		lo->plh_block_lgets--;
+		spin_unlock(&ino->i_lock);
 		pnfs_put_layout_hdr(lo);
 		goto out;
 	}

