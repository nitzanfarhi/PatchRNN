commit 7e0c19c9608483808e6b5c294e357fa456f058e1
Author: Colin Ian King <colin.king@canonical.com>
Date:   Fri Jul 17 11:37:52 2015 +0100

    mtd: physmap_of: fix null pointer deference when kzalloc returns null
    
    static analysis by smatch caught the following error:
    
    drivers/mtd/maps/physmap_of.c:135 of_get_probes()
       error: potential null dereference 'res'.  (kzalloc returns null)
    
    Check for failed kzalloc and return -ENOMEM in of_flash_probe if
    this occurs.
    
    Signed-off-by: Colin Ian King <colin.king@canonical.com>
    Signed-off-by: Brian Norris <computersforpeace@gmail.com>

diff --git a/drivers/mtd/maps/physmap_of.c b/drivers/mtd/maps/physmap_of.c
index 774b32fd29e6..3e614e9119d5 100644
--- a/drivers/mtd/maps/physmap_of.c
+++ b/drivers/mtd/maps/physmap_of.c
@@ -130,6 +130,8 @@ static const char * const *of_get_probes(struct device_node *dp)
 			count++;
 
 	res = kzalloc((count + 1)*sizeof(*res), GFP_KERNEL);
+	if (!res)
+		return NULL;
 	count = 0;
 	while (cplen > 0) {
 		res[count] = cp;
@@ -311,6 +313,10 @@ static int of_flash_probe(struct platform_device *dev)
 
 	ppdata.of_node = dp;
 	part_probe_types = of_get_probes(dp);
+	if (!part_probe_types) {
+		err = -ENOMEM;
+		goto err_out;
+	}
 	mtd_device_parse_register(info->cmtd, part_probe_types, &ppdata,
 			NULL, 0);
 	of_free_probes(part_probe_types);

