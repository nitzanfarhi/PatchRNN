commit 42577ca8c3616baaafdd8f167b2e1fb959026081
Author: David Howells <dhowells@redhat.com>
Date:   Tue Jul 23 16:49:24 2013 +0100

    Fix __wait_on_atomic_t() to call the action func if the counter != 0
    
    Fix __wait_on_atomic_t() so that it calls the action func if the counter != 0
    rather than if the counter is 0 so as to be analogous to __wait_on_bit().
    
    Thanks to Yacine who found this by visual inspection.
    
    This will affect FS-Cache in that it will could fail to sleep correctly when
    trying to clean up after a netfs cookie is withdrawn.
    
    Reported-by: Yacine Belkadi <yacine.belkadi.1@gmail.com>
    Signed-off-by: David Howells <dhowells@redhat.com>
    Reviewed-by: Jeff Layton <jlayton@redhat.com>
    cc: Milosz Tanski <milosz@adfin.com>
    Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>

diff --git a/kernel/wait.c b/kernel/wait.c
index ce0daa320a26..dec68bd4e9d8 100644
--- a/kernel/wait.c
+++ b/kernel/wait.c
@@ -333,7 +333,8 @@ int __wait_on_atomic_t(wait_queue_head_t *wq, struct wait_bit_queue *q,
 		prepare_to_wait(wq, &q->wait, mode);
 		val = q->key.flags;
 		if (atomic_read(val) == 0)
-			ret = (*action)(val);
+			break;
+		ret = (*action)(val);
 	} while (!ret && atomic_read(val) != 0);
 	finish_wait(wq, &q->wait);
 	return ret;

