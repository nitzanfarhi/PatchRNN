commit 68b83d67dadb3f7579d8126725eae8bba92a8ee9
Author: Sage Weil <sage@newdream.net>
Date:   Thu Apr 9 14:42:15 2009 -0700

    mds: choose reasonable state after xlock finishes

diff --git a/src/mds/Locker.cc b/src/mds/Locker.cc
index af4fbe12a9..7c7b89a795 100644
--- a/src/mds/Locker.cc
+++ b/src/mds/Locker.cc
@@ -862,7 +862,10 @@ void Locker::xlock_finish(SimpleLock *lock, Mutation *mut)
 	lock->get_num_client_lease() == 0) {
       assert(!lock->is_stable());
       lock->get_parent()->auth_unpin(lock);
-      lock->set_state(LOCK_LOCK);
+      if (lock->get_type() != CEPH_LOCK_DN && ((CInode*)lock->get_parent())->get_loner() >= 0)
+	lock->set_state(LOCK_EXCL);
+      else
+	lock->set_state(LOCK_LOCK);
     }
 
     // others waiting?

