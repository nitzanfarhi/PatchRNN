commit 69b9f11b6f8e63493b0685d641bc1aac922951aa
Author: Vlad Brezae <brezaevlad@gmail.com>
Date:   Thu Oct 12 01:05:27 2017 +0300

    [coop handles] Fix monotonic handle check race with stw in mono_handle_new

diff --git a/mono/metadata/handle.c b/mono/metadata/handle.c
index 96ec928eb5d..4f674800495 100644
--- a/mono/metadata/handle.c
+++ b/mono/metadata/handle.c
@@ -248,12 +248,12 @@ retry:
 		 * between 1 and 2, the object is still live)
 		 */
 		*objslot = NULL;
+		SET_OWNER (top,idx);
+		SET_SP (handles, top, idx);
 		mono_memory_write_barrier ();
 		top->size++;
 		mono_memory_write_barrier ();
 		*objslot = obj;
-		SET_OWNER (top,idx);
-		SET_SP (handles, top, idx);
 		return objslot;
 	}
 	if (G_LIKELY (top->next)) {

