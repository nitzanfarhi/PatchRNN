commit 45f2e081f573526977abfa781a12728f83e9641f
Author: Sage Weil <sage@inktank.com>
Date:   Tue Aug 21 12:11:51 2012 -0700

    ceph: avoid divide by zero in __validate_layout()
    
    If "l->stripe_unit" is zero the the mod on the next line will cause a
    divide by zero bug.  This comes from the copy_from_user() in
    ceph_ioctl_set_layout_policy().  Passing 0 is valid, though (it means
    "do not change") so avoid the % check in that case.
    
    Reported-by: Dan Carpenter <dan.carpenter@oracle.com>
    Signed-off-by: Sage Weil <sage@inktank.com>
    Reviewed-by: Alex Elder <elder@inktank.com>

diff --git a/fs/ceph/ioctl.c b/fs/ceph/ioctl.c
index 8e3fb69fbe62..1396ceb46797 100644
--- a/fs/ceph/ioctl.c
+++ b/fs/ceph/ioctl.c
@@ -42,7 +42,8 @@ static long __validate_layout(struct ceph_mds_client *mdsc,
 	/* validate striping parameters */
 	if ((l->object_size & ~PAGE_MASK) ||
 	    (l->stripe_unit & ~PAGE_MASK) ||
-	    ((unsigned)l->object_size % (unsigned)l->stripe_unit))
+	    (l->stripe_unit != 0 &&
+	     ((unsigned)l->object_size % (unsigned)l->stripe_unit)))
 		return -EINVAL;
 
 	/* make sure it's a valid data pool */

