commit 5d7289de649905721729c763145376311797200e
Author: Igor Solodovnikov <igor.solodovnikov@oracle.com>
Date:   Thu Dec 18 20:24:39 2014 +0200

    Bug #20065517   MEMORY LEAK OF 8160 BYTES IN MYSQL_STMT_PREPARE() API
    
    Memory leak is fixed by adding memory cleanup code after first cli_read_metadata() call in cli_read_prepare_result(). It is safe to free mysql->field_alloc object here because few lines upper there is free_old_query() call which also reinitializes mysql->field_alloc object. Thus there is no allocations before cli_read_metadata() call.
    
    Reviewed-by: Rafal Somla <rafal.somla@oracle.com>
    Reviewed-by: Georgi KOdinov <georgi.kodinov@oracle.com>
    RB: 7473

diff --git a/libmysql/libmysql.c b/libmysql/libmysql.c
index 60f8d885944..43bcde8d68d 100644
--- a/libmysql/libmysql.c
+++ b/libmysql/libmysql.c
@@ -1409,6 +1409,8 @@ my_bool cli_read_prepare_result(MYSQL *mysql, MYSQL_STMT *stmt)
     /* skip parameters data: we don't support it yet */
     if (!(cli_read_metadata(mysql, param_count, 7)))
       DBUG_RETURN(1);
+    /* free memory allocated by cli_read_metadata() for parameters data */
+    free_root(&mysql->field_alloc, MYF(0));
   }
 
   if (field_count != 0)

