commit 2a98dbbcd72cfae508c4d90bcbdc829363554ea7
Author: Wei Yongjun <yongjun_wei@trendmicro.com.cn>
Date:   Tue Jun 18 12:21:21 2013 +0800

    usb: gadget: f_ecm: fix missing unlock on error in ecm_alloc()
    
    Add the missing unlock before return from function ecm_alloc()
    in the error handling case.
    
    Introduced by commit da92801c647cdebfd45001fd6aaecb8f0be7f56b.
    (usb: gadget: f_ecm: add configfs support)
    
    Signed-off-by: Wei Yongjun <yongjun_wei@trendmicro.com.cn>
    Acked-by: Andrzej Pietrasiewicz <andrzej.p@samsung.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

diff --git a/drivers/usb/gadget/f_ecm.c b/drivers/usb/gadget/f_ecm.c
index fcafe1af4585..5d3561ea1c15 100644
--- a/drivers/usb/gadget/f_ecm.c
+++ b/drivers/usb/gadget/f_ecm.c
@@ -1012,6 +1012,7 @@ struct usb_function *ecm_alloc(struct usb_function_instance *fi)
 					  sizeof(ecm->ethaddr));
 	if (status < 12) {
 		kfree(ecm);
+		mutex_unlock(&opts->lock);
 		return ERR_PTR(-EINVAL);
 	}
 	ecm_string_defs[1].s = ecm->ethaddr;

