commit cea26e5a0aed95edb53e877aa1c4b12c6544442c
Author: Gordon Williams <gw@pur3.co.uk>
Date:   Tue Jan 12 14:34:16 2016 +0000

    minor tweak to stop crash on BT disconnect

diff --git a/libs/bluetooth/jswrap_bluetooth.c b/libs/bluetooth/jswrap_bluetooth.c
index 201b251e..6ecd36c0 100644
--- a/libs/bluetooth/jswrap_bluetooth.c
+++ b/libs/bluetooth/jswrap_bluetooth.c
@@ -133,6 +133,10 @@ static void nus_data_handler(ble_nus_t * p_nus, uint8_t * p_data, uint16_t lengt
 }
 
 bool jswrap_nrf_transmit_string() {
+  if (m_conn_handle == BLE_CONN_HANDLE_INVALID) {
+    // If no connection, drain the output buffer
+    while (jshGetCharToTransmit(EV_BLUETOOTH)>=0);
+  }
   if (ble_is_sending) return false;
   static uint8_t buf[BLE_NUS_MAX_DATA_LEN];
   int idx = 0;

