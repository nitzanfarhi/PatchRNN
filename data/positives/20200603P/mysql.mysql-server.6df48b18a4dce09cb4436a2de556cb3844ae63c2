commit 6df48b18a4dce09cb4436a2de556cb3844ae63c2
Author: Neeraj Bisht <neeraj.x.bisht@oracle.com>
Date:   Fri Dec 20 15:15:00 2013 +0530

    Bug#16539903 - SERVER CRASHES IN IN HA_MYISAM::FT_INIT_EXT WITH
                   A FROM SUBQUERY
    
    Problem:-
    Full-text search combined with derived tables causes a segment fault.
    
    Analysis:-
    In query like
    EXPLAIN SELECT  MATCH(ft) AGAINST( "test" IN BOOLEAN MODE) FROM
    ( SELECT  ft FROM t1 ) AS t;
    
    We are creating a temporary table for the subquery result table.
    But after wl-5274(where we are postponed materialization), we will create
    tmp table, but skip instantiation of temporary table.
    
    When we have full-text function in our main select query, we are
    going to call Item_func_match::init_search() for all the full-text item.
    There we are going to take care about
    condition like
    --> match ... against (null)
    and we are going to call handler::ft_init_ext(), which is used to
    Initialize full-text index scan(which need table to be initialized).
    but as we havnt initialized the table. This cause a segmentation fault.
    
    Solution:-
    When we have derived tables, instead of intializing full-text function at
    optimization, we will initiate it at the time of execution .

diff --git a/sql/sql_executor.cc b/sql/sql_executor.cc
index 289cc8e46a8..e1e9cbed21c 100644
--- a/sql/sql_executor.cc
+++ b/sql/sql_executor.cc
@@ -116,6 +116,9 @@ JOIN::exec()
   if (prepare_result(&columns_list))
     DBUG_VOID_RETURN;
 
+  if (select_lex->materialized_table_count)
+    init_ftfuncs(thd, select_lex, order);
+
   if (!tables_list && (tables || !select_lex->with_sum_func))
   {                                           // Only test of functions
     /*
diff --git a/sql/sql_optimizer.cc b/sql/sql_optimizer.cc
index e3b4b05ef01..5b8c8876ed0 100644
--- a/sql/sql_optimizer.cc
+++ b/sql/sql_optimizer.cc
@@ -741,9 +741,10 @@ JOIN::optimize()
              (rollup.state != ROLLUP::STATE_NONE && select_distinct));
 
   /* Perform FULLTEXT search before all regular searches */
-  if (!(select_options & SELECT_DESCRIBE))
+  if (!(select_options & SELECT_DESCRIBE) &&
+      !select_lex->materialized_table_count)
   {
-    init_ftfuncs(thd, select_lex, MY_TEST(order));
+    init_ftfuncs(thd, select_lex, order);
     optimize_fts_query();
   }
 

