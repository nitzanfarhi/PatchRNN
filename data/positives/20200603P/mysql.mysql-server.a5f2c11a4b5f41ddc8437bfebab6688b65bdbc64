commit a5f2c11a4b5f41ddc8437bfebab6688b65bdbc64
Author: Jonas Oreland <jonas@mysql.com>
Date:   Wed Sep 9 10:57:13 2009 +0200

    ndb - bug#47170
      Calculation of StringMemory could overflow for big values
        of MaxNoOfTables/Attributes

diff --git a/storage/ndb/src/kernel/blocks/dbdict/Dbdict.cpp b/storage/ndb/src/kernel/blocks/dbdict/Dbdict.cpp
index efb023eb197..d64e1e6b101 100644
--- a/storage/ndb/src/kernel/blocks/dbdict/Dbdict.cpp
+++ b/storage/ndb/src/kernel/blocks/dbdict/Dbdict.cpp
@@ -2212,17 +2212,20 @@ void Dbdict::execREAD_CONFIG_REQ(Signal* signal)
   if (sm == 0)
     sm = 25;
   
-  Uint32 sb = 0;
+  Uint64 sb = 0;
   if (sm <= 100)
   {
-    sb = (rps * sm) / 100;
+    sb = (Uint64(rps) * Uint64(sm)) / 100;
   }
   else
   {
     sb = sm;
   }
   
-  c_rope_pool.setSize(sb/28 + 100);
+  sb /= (Rope::getSegmentSize() * sizeof(Uint32));
+  sb += 100; // more safty
+  ndbrequire(sb < (Uint64(1) << 32));
+  c_rope_pool.setSize(Uint32(sb));
   
   // Initialize BAT for interface to file system
   NewVARIABLE* bat = allocateBat(2);
diff --git a/storage/ndb/src/kernel/vm/Rope.hpp b/storage/ndb/src/kernel/vm/Rope.hpp
index bf2039522b4..b784f9f5158 100644
--- a/storage/ndb/src/kernel/vm/Rope.hpp
+++ b/storage/ndb/src/kernel/vm/Rope.hpp
@@ -86,6 +86,7 @@ public:
   
   static Uint32 hash(const char * str, Uint32 len);
 
+  static Uint32 getSegmentSize() { return RopeBase::getSegmentSize();}
 private:
   Uint32 m_hash;
   RopeHandle & src;

