commit 0a9e8dfd815605856cecfcf76632f846146c3a58
Author: Thomas d'Otreppe <tdotreppe@aircrack-ng.org>
Date:   Tue Oct 21 02:13:52 2014 +0000

    Aireplay-ng test: Better handling of invalid length (or empty stuff).
    
    git-svn-id: http://svn.aircrack-ng.org/trunk@2421 28c6078b-6c39-48e3-add9-af49d547ecab

diff --git a/src/aireplay-ng.c b/src/aireplay-ng.c
index 0d8f7c31..69d27980 100644
--- a/src/aireplay-ng.c
+++ b/src/aireplay-ng.c
@@ -5396,29 +5396,30 @@ int tcp_test(const char* ip_str, const short port)
             }
         }
 
-        if( (unsigned)caplen == sizeof(nh))
+        if(caplen > 0 && (unsigned)caplen == sizeof(nh))
         {
             len = ntohl(nh.nh_len);
-            if (len > packetsize || len < 0)
-                continue;
-            if( nh.nh_type == 1 && i==0 )
+            if (len <= packetsize && len > 0)
             {
-                i=1;
-                caplen = read(sock, packet, len);
-                if(caplen == len)
+                if( nh.nh_type == 1 && i==0 )
                 {
-                    i=2;
-                    break;
+                    i=1;
+                    caplen = read(sock, packet, len);
+                    if(caplen == len)
+                    {
+                        i=2;
+                        break;
+                    }
+                    else
+                    {
+                        i=0;
+                    }
                 }
                 else
                 {
-                    i=0;
+                    caplen = read(sock, packet, len);
                 }
             }
-            else
-            {
-                caplen = read(sock, packet, len);
-            }
         }
 
         gettimeofday( &tv2, NULL );

