commit 6583bb64fc370842b32a87c67750c26f6d559af0
Author: David Rientjes <rientjes@google.com>
Date:   Wed Jul 29 15:02:06 2009 -0700

    mm: avoid endless looping for oom killed tasks
    
    If a task is oom killed and still cannot find memory when trying with
    no watermarks, it's better to fail the allocation attempt than to loop
    endlessly.  Direct reclaim has already failed and the oom killer will
    be a no-op since current has yet to die, so there is no other
    alternative for allocations that are not __GFP_NOFAIL.
    
    Acked-by: Mel Gorman <mel@csn.ul.ie>
    Signed-off-by: David Rientjes <rientjes@google.com>
    Acked-by: Hugh Dickins <hugh.dickins@tiscali.co.uk>
    Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
    Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>

diff --git a/mm/page_alloc.c b/mm/page_alloc.c
index ae28c22a7fdb..2dbb2fc68837 100644
--- a/mm/page_alloc.c
+++ b/mm/page_alloc.c
@@ -1794,6 +1794,10 @@ __alloc_pages_slowpath(gfp_t gfp_mask, unsigned int order,
 	if (p->flags & PF_MEMALLOC)
 		goto nopage;
 
+	/* Avoid allocations with no watermarks from looping endlessly */
+	if (test_thread_flag(TIF_MEMDIE) && !(gfp_mask & __GFP_NOFAIL))
+		goto nopage;
+
 	/* Try direct reclaim and then allocating */
 	page = __alloc_pages_direct_reclaim(gfp_mask, order,
 					zonelist, high_zoneidx,

