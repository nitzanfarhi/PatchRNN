commit 8a00056a2279284f6834ce78d837e4728558e7d9
Author: Charles Dang <exodia339@gmail.com>
Date:   Sat Apr 21 14:12:25 2018 +1100

    Attempt to fix infinite loading screen if server restarts during MP login
    
    See #2927.

diff --git a/src/game_initialization/multiplayer.cpp b/src/game_initialization/multiplayer.cpp
index 01e7809503..bc89495017 100644
--- a/src/game_initialization/multiplayer.cpp
+++ b/src/game_initialization/multiplayer.cpp
@@ -104,6 +104,10 @@ std::pair<wesnothd_connection_ptr, config> open_connection(std::string host)
 			return std::make_pair(std::move(sock), config());
 		}
 
+		if(!sock->socket_open()) {
+			throw wesnothd_error("The server has shut down or restarted.");
+		}
+
 		data.clear();
 		sock->wait_and_receive_data(data);
 
diff --git a/src/wesnothd_connection.cpp b/src/wesnothd_connection.cpp
index 63f696371c..e99c87f96e 100644
--- a/src/wesnothd_connection.cpp
+++ b/src/wesnothd_connection.cpp
@@ -186,7 +186,7 @@ void wesnothd_connection::send_data(const configr_of& request)
 void wesnothd_connection::cancel()
 {
 	MPTEST_LOG;
-	if(socket_.is_open()) {
+	if(socket_open()) {
 		boost::system::error_code ec;
 
 #ifdef _MSC_VER
diff --git a/src/wesnothd_connection.hpp b/src/wesnothd_connection.hpp
index a23841d305..2e79449e96 100644
--- a/src/wesnothd_connection.hpp
+++ b/src/wesnothd_connection.hpp
@@ -92,6 +92,11 @@ public:
 	// Destroys this object.
 	void stop();
 
+	bool socket_open() const
+	{
+		return socket_.is_open();
+	}
+
 	/** True if connected and no high-level operation is in progress */
 	bool handshake_finished() const
 	{

