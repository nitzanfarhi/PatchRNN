commit 934ef1c314cd1fcf92ab6583f7b0e76ce7915fc6
Author: Tomasz Sterna <tomek@xiaoka.com>
Date:   Tue Dec 15 20:49:19 2009 +0000

    [cwave:r60] fix memory leak when sm reconnects

diff --git a/sm/main.c b/sm/main.c
index 9b92a13..021d7ea 100644
--- a/sm/main.c
+++ b/sm/main.c
@@ -377,6 +377,7 @@ JABBER_MAIN("jabberd2sm", "Jabber 2 Session Manager", "Jabber Open Source Server
                 log_write(sm->log, LOG_NOTICE, "attempting reconnect");
                 sleep(sm->retry_sleep);
                 sm_lost_router = 0;
+                if (sm->router) sx_free(sm->router);
                 _sm_router_connect(sm);
             }
 
@@ -389,6 +390,7 @@ JABBER_MAIN("jabberd2sm", "Jabber 2 Session Manager", "Jabber Open Source Server
                 sm->retry_left--;
                 sleep(sm->retry_sleep);
                 sm_lost_router = 0;
+                if (sm->router) sx_free(sm->router);
                 _sm_router_connect(sm);
             }
         }
@@ -413,6 +415,7 @@ JABBER_MAIN("jabberd2sm", "Jabber 2 Session Manager", "Jabber Open Source Server
 
     xhash_free(sm->sessions);
 
+    if (sm->fd) mio_close(sm->mio, sm->fd);
     mio_free(sm->mio);
 
     mm_free(sm->mm);

