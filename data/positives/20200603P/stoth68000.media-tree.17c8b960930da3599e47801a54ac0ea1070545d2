commit 17c8b960930da3599e47801a54ac0ea1070545d2
Author: Marcin Slusarz <marcin.slusarz@gmail.com>
Date:   Mon Aug 22 23:14:05 2011 +0200

    drm/nouveau: properly handle allocation failure in nouveau_sgdma_populate
    
    Not cleaning after alloc failure would result in crash on destroy,
    because nouveau_sgdma_clear assumes "ttm_alloced" to be not null when
    "pages" is not null.
    
    Signed-off-by: Marcin Slusarz <marcin.slusarz@gmail.com>
    Cc: stable@kernel.org
    Signed-off-by: Ben Skeggs <bskeggs@redhat.com>

diff --git a/drivers/gpu/drm/nouveau/nouveau_sgdma.c b/drivers/gpu/drm/nouveau/nouveau_sgdma.c
index c444cadbf849..88062de26b00 100644
--- a/drivers/gpu/drm/nouveau/nouveau_sgdma.c
+++ b/drivers/gpu/drm/nouveau/nouveau_sgdma.c
@@ -37,8 +37,11 @@ nouveau_sgdma_populate(struct ttm_backend *be, unsigned long num_pages,
 		return -ENOMEM;
 
 	nvbe->ttm_alloced = kmalloc(sizeof(bool) * num_pages, GFP_KERNEL);
-	if (!nvbe->ttm_alloced)
+	if (!nvbe->ttm_alloced) {
+		kfree(nvbe->pages);
+		nvbe->pages = NULL;
 		return -ENOMEM;
+	}
 
 	nvbe->nr_pages = 0;
 	while (num_pages--) {

