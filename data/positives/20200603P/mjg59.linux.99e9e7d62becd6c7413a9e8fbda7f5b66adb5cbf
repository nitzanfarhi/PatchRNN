commit 99e9e7d62becd6c7413a9e8fbda7f5b66adb5cbf
Author: Florian Tobias Schandinat <FlorianSchandinat@gmx.de>
Date:   Tue Sep 22 16:47:41 2009 -0700

    fb: fix fb_pan_display range check
    
    Fix the range check for panning.  The current code fails to detect some
    invalid values (very high ones that can occur if an app tries to move
    further up/left than 0,0) as the check uses the unknown values for
    calculation so that an overflow can occur.
    
    To fix this it is sufficient to move the calculation to the right side to
    use only trusted values.
    
    Kai Jiang detected this problem and proposed an initial patch.
    
    Signed-off-by: Florian Tobias Schandinat <FlorianSchandinat@gmx.de>
    Cc: Kai Jiang <b18973@freescale.com>
    Cc: Krzysztof Helt <krzysztof.h1@poczta.fm>
    Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
    Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>

diff --git a/drivers/video/fbmem.c b/drivers/video/fbmem.c
index a85c818be945..346f257215a7 100644
--- a/drivers/video/fbmem.c
+++ b/drivers/video/fbmem.c
@@ -871,8 +871,8 @@ fb_pan_display(struct fb_info *info, struct fb_var_screeninfo *var)
 		err = -EINVAL;
 
 	if (err || !info->fbops->fb_pan_display ||
-	    var->yoffset + yres > info->var.yres_virtual ||
-	    var->xoffset + info->var.xres > info->var.xres_virtual)
+	    var->yoffset > info->var.yres_virtual - yres ||
+	    var->xoffset > info->var.xres_virtual - info->var.xres)
 		return -EINVAL;
 
 	if ((err = info->fbops->fb_pan_display(var, info)))

