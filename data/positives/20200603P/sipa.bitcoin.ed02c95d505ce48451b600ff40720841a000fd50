commit ed02c95d505ce48451b600ff40720841a000fd50
Author: Gavin Andresen <gavinandresen@gmail.com>
Date:   Thu Sep 1 10:58:08 2011 -0400

    obtain cs_wallet mutex to protect vchDefaultKey

diff --git a/src/wallet.cpp b/src/wallet.cpp
index e861416e5..8bbb80cf2 100644
--- a/src/wallet.cpp
+++ b/src/wallet.cpp
@@ -1280,20 +1280,23 @@ bool CWallet::GetKeyFromPool(vector<unsigned char>& result, bool fAllowReuse)
 {
     int64 nIndex = 0;
     CKeyPool keypool;
-    ReserveKeyFromKeyPool(nIndex, keypool);
-    if (nIndex == -1)
+    CRITICAL_BLOCK(cs_wallet)
     {
-        if (fAllowReuse && !vchDefaultKey.empty())
+        ReserveKeyFromKeyPool(nIndex, keypool);
+        if (nIndex == -1)
         {
-            result = vchDefaultKey;
+            if (fAllowReuse && !vchDefaultKey.empty())
+            {
+                result = vchDefaultKey;
+                return true;
+            }
+            if (IsLocked()) return false;
+            result = GenerateNewKey();
             return true;
         }
-        if (IsLocked()) return false;
-        result = GenerateNewKey();
-        return true;
+        KeepKey(nIndex);
+        result = keypool.vchPubKey;
     }
-    KeepKey(nIndex);
-    result = keypool.vchPubKey;
     return true;
 }
 

