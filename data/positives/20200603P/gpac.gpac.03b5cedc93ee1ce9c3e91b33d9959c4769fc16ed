commit 03b5cedc93ee1ce9c3e91b33d9959c4769fc16ed
Author: Jean Le Feuvre <jeanlf@users.sourceforge.net>
Date:   Tue Mar 1 10:33:18 2011 +0000

    Fixed deadlock in cache
    
    
    git-svn-id: http://svn.code.sf.net/p/gpac/code/trunk/gpac@2717 63c20433-aa62-49bd-875c-5a186b69a8fb

diff --git a/src/utils/cache.c b/src/utils/cache.c
index 5c0efe741..80139d8d2 100644
--- a/src/utils/cache.c
+++ b/src/utils/cache.c
@@ -738,24 +738,23 @@ s32 gf_cache_remove_session_from_cache_entry(DownloadedCacheEntry entry, GF_Down
         GF_DownloadSession * s = gf_list_get(entry->sessions, i);
         if (s == sess) {
             gf_list_rem(entry->sessions, i);
-            return count - 1;
+            count --;
+			break;
         }
     }
-    gf_mx_p(entry->write_mutex);
-    if (entry->write_session == sess){
-	/* OK, this is not optimal to close it since we are in a mutex,
-	 * but we don't want to risk to have another session opening
-	 * a not fully closed cache entry */
-	if (entry->writeFilePtr){
-	  if (fclose(entry->writeFilePtr)){
-	      GF_LOG(GF_LOG_ERROR, GF_LOG_NETWORK,
-		     ("[CACHE] gf_cache_remove_session_from_cache_entry:%d, Failed to properly fclose cache file '%s' of url '%s', cache may be corrupted !\n", __LINE__, entry->cache_filename, entry->url));
-	  }
+    if (entry->write_session == sess) {
+		/* OK, this is not optimal to close it since we are in a mutex,
+		 * but we don't want to risk to have another session opening
+		 * a not fully closed cache entry */
+		if (entry->writeFilePtr){
+			if (fclose(entry->writeFilePtr)) {
+				GF_LOG(GF_LOG_ERROR, GF_LOG_NETWORK, ("[CACHE] gf_cache_remove_session_from_cache_entry:%d, Failed to properly fclose cache file '%s' of url '%s', cache may be corrupted !\n", __LINE__, entry->cache_filename, entry->url));
+			}
+		}
+		entry->writeFilePtr = NULL;
+		entry->write_session = NULL;
+	    gf_mx_v(entry->write_mutex);
 	}
-	entry->writeFilePtr = NULL;
-	entry->write_session = NULL;
-    }
-    gf_mx_v(entry->write_mutex);
     return count;
 }
 

