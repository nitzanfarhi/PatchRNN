commit 156c55325d30261d250e88ed3a39f22008f4ca16
Author: Po Liu <po.liu@nxp.com>
Date:   Mon Aug 29 15:28:01 2016 +0800

    PCI: Check for pci_setup_device() failure in pci_iov_add_virtfn()
    
    If pci_setup_device() returns failure, we must return failure from
    pci_iov_add_virtfn().  If we ignore the failure and continue with an
    uninitialized pci_dev for virtfn, we crash later when we try to use those
    uninitialized parts.
    
    Signed-off-by: Po Liu <po.liu@nxp.com>
    Signed-off-by: Bjorn Helgaas <bhelgaas@google.com>

diff --git a/drivers/pci/iov.c b/drivers/pci/iov.c
index 2194b447201d..e30f05c8517f 100644
--- a/drivers/pci/iov.c
+++ b/drivers/pci/iov.c
@@ -136,7 +136,10 @@ int pci_iov_add_virtfn(struct pci_dev *dev, int id, int reset)
 	virtfn->devfn = pci_iov_virtfn_devfn(dev, id);
 	virtfn->vendor = dev->vendor;
 	pci_read_config_word(dev, iov->pos + PCI_SRIOV_VF_DID, &virtfn->device);
-	pci_setup_device(virtfn);
+	rc = pci_setup_device(virtfn);
+	if (rc)
+		goto failed0;
+
 	virtfn->dev.parent = dev->dev.parent;
 	virtfn->physfn = pci_dev_get(dev);
 	virtfn->is_virtfn = 1;

