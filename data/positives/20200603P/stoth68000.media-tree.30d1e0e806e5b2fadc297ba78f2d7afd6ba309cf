commit 30d1e0e806e5b2fadc297ba78f2d7afd6ba309cf
Author: Chen Gang <gang.chen.5i5j@gmail.com>
Date:   Fri Aug 8 23:37:59 2014 +0800

    virt/kvm/assigned-dev.c: Set 'dev->irq_source_id' to '-1' after free it
    
    As a generic function, deassign_guest_irq() assumes it can be called
    even if assign_guest_irq() is not be called successfully (which can be
    triggered by ioctl from user mode, indirectly).
    
    So for assign_guest_irq() failure process, need set 'dev->irq_source_id'
    to -1 after free 'dev->irq_source_id', or deassign_guest_irq() may free
    it again.
    
    Signed-off-by: Chen Gang <gang.chen.5i5j@gmail.com>
    Signed-off-by: Paolo Bonzini <pbonzini@redhat.com>

diff --git a/virt/kvm/assigned-dev.c b/virt/kvm/assigned-dev.c
index bf06577fea51..5819a2708d7e 100644
--- a/virt/kvm/assigned-dev.c
+++ b/virt/kvm/assigned-dev.c
@@ -526,8 +526,10 @@ static int assign_guest_irq(struct kvm *kvm,
 		dev->irq_requested_type |= guest_irq_type;
 		if (dev->ack_notifier.gsi != -1)
 			kvm_register_irq_ack_notifier(kvm, &dev->ack_notifier);
-	} else
+	} else {
 		kvm_free_irq_source_id(kvm, dev->irq_source_id);
+		dev->irq_source_id = -1;
+	}
 
 	return r;
 }

