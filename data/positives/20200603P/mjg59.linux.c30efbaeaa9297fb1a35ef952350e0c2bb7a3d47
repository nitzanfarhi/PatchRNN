commit c30efbaeaa9297fb1a35ef952350e0c2bb7a3d47
Author: Dave Jones <davej@redhat.com>
Date:   Sun Jan 28 17:39:19 2007 -0500

    [AGPGART] Prevent (unlikely) memory leak in amd_create_gatt_pages()
    
    If we fail an alloc, unwind the previous allocs that succeeded.
    
    Spotted-by: Alan Grimes <agrimes@speakeasy.net>
    Signed-off-by: Dave Jones <davej@redhat.com>

diff --git a/drivers/char/agp/amd-k7-agp.c b/drivers/char/agp/amd-k7-agp.c
index 51d0d562d01e..c85c8cadb6df 100644
--- a/drivers/char/agp/amd-k7-agp.c
+++ b/drivers/char/agp/amd-k7-agp.c
@@ -101,6 +101,11 @@ static int amd_create_gatt_pages(int nr_tables)
 	for (i = 0; i < nr_tables; i++) {
 		entry = kzalloc(sizeof(struct amd_page_map), GFP_KERNEL);
 		if (entry == NULL) {
+			while (i > 0) {
+				kfree(tables[i-1]);
+				i--;
+			}
+			kfree(tables);
 			retval = -ENOMEM;
 			break;
 		}

