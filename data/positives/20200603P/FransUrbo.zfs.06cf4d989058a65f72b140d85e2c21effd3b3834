commit 06cf4d989058a65f72b140d85e2c21effd3b3834
Author: cao <cao.xuewen@zte.com.cn>
Date:   Thu Oct 13 02:16:47 2016 +0800

    Fix coverity defects: CID 147606, 147609
    
    coverity scan CID:147606, Type:resource leak
    coverity scan CID:147609, Type:resource leak
    
    Reviewed-by: Brian Behlendorf <behlendorf1@llnl.gov>
    Signed-off-by: cao.xuewen <cao.xuewen@zte.com.cn>
    Closes #5245

diff --git a/cmd/ztest/ztest.c b/cmd/ztest/ztest.c
index 1491e8734..2e4dae3a9 100644
--- a/cmd/ztest/ztest.c
+++ b/cmd/ztest/ztest.c
@@ -6281,8 +6281,11 @@ ztest_run(ztest_shared_t *zs)
 		kthread_t *thread;
 
 		if (t < ztest_opts.zo_datasets &&
-		    ztest_dataset_open(t) != 0)
+		    ztest_dataset_open(t) != 0) {
+			umem_free(tid,
+			    ztest_opts.zo_threads * sizeof (kt_did_t));
 			return;
+		}
 
 		VERIFY3P(thread = zk_thread_create(NULL, 0,
 		    (thread_func_t)ztest_thread,
diff --git a/lib/libzfs/libzfs_pool.c b/lib/libzfs/libzfs_pool.c
index 112221674..68cc5f3ee 100644
--- a/lib/libzfs/libzfs_pool.c
+++ b/lib/libzfs/libzfs_pool.c
@@ -4159,7 +4159,7 @@ zpool_label_name(char *label_name, int label_size)
 	int fd;
 
 	fd = open("/dev/urandom", O_RDONLY);
-	if (fd > 0) {
+	if (fd >= 0) {
 		if (read(fd, &id, sizeof (id)) != sizeof (id))
 			id = 0;
 
diff --git a/tests/zfs-tests/cmd/dir_rd_update/dir_rd_update.c b/tests/zfs-tests/cmd/dir_rd_update/dir_rd_update.c
index 3e075e3d7..64348549d 100644
--- a/tests/zfs-tests/cmd/dir_rd_update/dir_rd_update.c
+++ b/tests/zfs-tests/cmd/dir_rd_update/dir_rd_update.c
@@ -108,6 +108,7 @@ main(int argc, char **argv)
 			}
 			j++;
 		}
+		(void) close(fd);
 	} else if (pid == 0) {
 		int fd = open(dirpath, O_RDONLY);
 		int chownret;
@@ -128,6 +129,7 @@ main(int argc, char **argv)
 
 			k++;
 		}
+		(void) close(fd);
 	}
 
 	return (0);

