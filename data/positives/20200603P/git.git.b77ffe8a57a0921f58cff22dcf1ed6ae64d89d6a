commit b77ffe8a57a0921f58cff22dcf1ed6ae64d89d6a
Author: Shawn O. Pearce <spearce@spearce.org>
Date:   Wed May 30 02:13:14 2007 -0400

    Ensure the pack index is opened before access
    
    In this particular location of fsck the index should have already
    been opened by verify_pack, which is called just before we get
    here and loop through the object names.  However, just in case a
    future version of that function does not use the index file we'll
    double-check its open before we access the num_objects field.
    
    Better safe now than sorry later.
    
    Signed-off-by: Shawn O. Pearce <spearce@spearce.org>
    Signed-off-by: Junio C Hamano <junkio@cox.net>

diff --git a/builtin-fsck.c b/builtin-fsck.c
index cbbcaf011..9959818ce 100644
--- a/builtin-fsck.c
+++ b/builtin-fsck.c
@@ -668,7 +668,10 @@ int cmd_fsck(int argc, char **argv, const char *prefix)
 			verify_pack(p, 0);
 
 		for (p = packed_git; p; p = p->next) {
-			uint32_t i, num = p->num_objects;
+			uint32_t i, num;
+			if (open_pack_index(p))
+				continue;
+			num = p->num_objects;
 			for (i = 0; i < num; i++)
 				fsck_sha1(nth_packed_object_sha1(p, i));
 		}

