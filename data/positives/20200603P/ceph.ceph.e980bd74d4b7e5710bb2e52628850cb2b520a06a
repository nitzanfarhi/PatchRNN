commit e980bd74d4b7e5710bb2e52628850cb2b520a06a
Author: Jason Dillaman <dillaman@redhat.com>
Date:   Thu Mar 1 17:57:17 2018 -0500

    librbd: reduce lock scope on copy-on-read IO path
    
    Signed-off-by: Jason Dillaman <dillaman@redhat.com>

diff --git a/src/librbd/io/ObjectRequest.cc b/src/librbd/io/ObjectRequest.cc
index bc1d9e93fc..320daedb25 100644
--- a/src/librbd/io/ObjectRequest.cc
+++ b/src/librbd/io/ObjectRequest.cc
@@ -337,7 +337,7 @@ void ObjectReadRequest<I>::copyup() {
 
   ldout(image_ctx->cct, 20) << dendl;
 
-  Mutex::Locker copyup_locker(image_ctx->copyup_list_lock);
+  image_ctx->copyup_list_lock.Lock();
   auto it = image_ctx->copyup_list.find(this->m_object_no);
   if (it == image_ctx->copyup_list.end()) {
     // create and kick off a CopyupRequest
@@ -346,7 +346,10 @@ void ObjectReadRequest<I>::copyup() {
       this->m_trace);
 
     image_ctx->copyup_list[this->m_object_no] = new_req;
+    image_ctx->copyup_list_lock.Unlock();
     new_req->send();
+  } else {
+    image_ctx->copyup_list_lock.Unlock();
   }
 
   image_ctx->parent_lock.put_read();

