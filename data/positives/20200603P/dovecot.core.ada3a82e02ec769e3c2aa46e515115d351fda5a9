commit ada3a82e02ec769e3c2aa46e515115d351fda5a9
Author: Timo Sirainen <tss@iki.fi>
Date:   Mon Jul 24 01:40:54 2006 +0300

    When saving a mail with initial keywords, lock the uidlist before doing
    anything with the file's header.
    
    --HG--
    branch : HEAD

diff --git a/src/lib-storage/index/dbox/dbox-save.c b/src/lib-storage/index/dbox/dbox-save.c
index c19727ead..26439c605 100644
--- a/src/lib-storage/index/dbox/dbox-save.c
+++ b/src/lib-storage/index/dbox/dbox-save.c
@@ -154,6 +154,18 @@ int dbox_save_init(struct mailbox_transaction_context *_t,
 
 	t_push();
 	if (keywords != NULL && keywords->count > 0) {
+		uint32_t uid;
+		time_t mtime;
+
+		/* uidlist must be locked while we're reading or modifying
+		   file's header */
+		if (dbox_uidlist_append_get_first_uid(ctx->append_ctx,
+						      &uid, &mtime) < 0) {
+			ctx->failed = TRUE;
+			t_pop();
+			return -1;
+		}
+
 		/* write keywords to the file */
 		file_keywords = buffer_create_dynamic(pool_datastack_create(),
 						      DBOX_KEYWORD_COUNT);

