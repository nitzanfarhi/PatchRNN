commit d3674c5754775eb65ec2f2fd5f8cfe9b032ca0b1
Author: Jason Wang <jasowang@redhat.com>
Date:   Wed May 18 13:57:37 2011 +0800

    virtio: correctly initialize vm_running
    
    Current vm_running was not explicitly initialized and its value was changed by
    vm state notifier, this may confuse the virtio device being hotplugged such as
    virtio-net with vhost backend as it may think the vm was not running. Solve this
    by initialize this value explicitly in virtio_common_init().
    
    Signed-off-by: Jason Wang <jasowang@redhat.com>
    Signed-off-by: Michael S. Tsirkin <mst@redhat.com>

diff --git a/hw/virtio.c b/hw/virtio.c
index a6518606c3..36b8f3599b 100644
--- a/hw/virtio.c
+++ b/hw/virtio.c
@@ -787,6 +787,7 @@ VirtIODevice *virtio_common_init(const char *name, uint16_t device_id,
     vdev->queue_sel = 0;
     vdev->config_vector = VIRTIO_NO_VECTOR;
     vdev->vq = qemu_mallocz(sizeof(VirtQueue) * VIRTIO_PCI_QUEUE_MAX);
+    vdev->vm_running = vm_running;
     for(i = 0; i < VIRTIO_PCI_QUEUE_MAX; i++) {
         vdev->vq[i].vector = VIRTIO_NO_VECTOR;
         vdev->vq[i].vdev = vdev;

