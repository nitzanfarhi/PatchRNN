commit c40701eacbaebcfe3fb6fac8ef3da653021c212c
Author: Jesper Juhl <jj@chaosbits.net>
Date:   Sun Jan 8 23:41:21 2012 +0100

    brcm80211: Don't leak 'vbuffer' in brcmf_sdbrcm_write_vars()
    
    If the memory allocation 'nvram_ularray = kmalloc(varsize,
    GFP_ATOMIC);' fails we'll leak the memory allocated to 'vbuffer' when
    we return -ENOMEM from the function.
    
    This patch resolves the leak by kfree()'ing the allocated memory
    before the return.
    
    Signed-off-by: Jesper Juhl <jj@chaosbits.net>
    Acked-by: Arend van Spriel <arend@broadcom.com>
    Signed-off-by: John W. Linville <linville@tuxdriver.com>

diff --git a/drivers/net/wireless/brcm80211/brcmfmac/dhd_sdio.c b/drivers/net/wireless/brcm80211/brcmfmac/dhd_sdio.c
index 5a002a21f108..f7eeee1dcdb6 100644
--- a/drivers/net/wireless/brcm80211/brcmfmac/dhd_sdio.c
+++ b/drivers/net/wireless/brcm80211/brcmfmac/dhd_sdio.c
@@ -3119,8 +3119,10 @@ static int brcmf_sdbrcm_write_vars(struct brcmf_sdio *bus)
 		/* Verify NVRAM bytes */
 		brcmf_dbg(INFO, "Compare NVRAM dl & ul; varsize=%d\n", varsize);
 		nvram_ularray = kmalloc(varsize, GFP_ATOMIC);
-		if (!nvram_ularray)
+		if (!nvram_ularray) {
+			kfree(vbuffer);
 			return -ENOMEM;
+		}
 
 		/* Upload image to verify downloaded contents. */
 		memset(nvram_ularray, 0xaa, varsize);

