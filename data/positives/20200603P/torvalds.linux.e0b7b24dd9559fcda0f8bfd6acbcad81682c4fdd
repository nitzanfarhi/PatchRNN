commit e0b7b24dd9559fcda0f8bfd6acbcad81682c4fdd
Author: Wen Congyang <wency@cn.fujitsu.com>
Date:   Fri Nov 16 02:08:16 2012 +0100

    ACPI / memhotplug: free memory device if acpi_memory_enable_device() failed
    
    If acpi_memory_enable_device() fails, acpi_memory_enable_device() will
    return a non-zero value, which means we fail to bind the memory device to
    this driver.  So we should free memory device before
    acpi_memory_device_add() returns.
    
    Signed-off-by: Wen Congyang <wency@cn.fujitsu.com>
    Reviewed-by: Yasuaki Ishimatsu <isimatu.yasuaki@jp.fujitsu.com>
    Acked-by: David Rientjes <rientjes@google.com>
    Signed-off-by: Rafael J. Wysocki <rafael.j.wysocki@intel.com>

diff --git a/drivers/acpi/acpi_memhotplug.c b/drivers/acpi/acpi_memhotplug.c
index c5e7b6d08ef3..e52ad5d3792d 100644
--- a/drivers/acpi/acpi_memhotplug.c
+++ b/drivers/acpi/acpi_memhotplug.c
@@ -421,9 +421,11 @@ static int acpi_memory_device_add(struct acpi_device *device)
 	if (!acpi_memory_check_device(mem_device)) {
 		/* call add_memory func */
 		result = acpi_memory_enable_device(mem_device);
-		if (result)
+		if (result) {
 			printk(KERN_ERR PREFIX
 				"Error in acpi_memory_enable_device\n");
+			acpi_memory_device_free(mem_device);
+		}
 	}
 	return result;
 }

