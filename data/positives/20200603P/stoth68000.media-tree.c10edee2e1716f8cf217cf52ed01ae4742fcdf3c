commit c10edee2e1716f8cf217cf52ed01ae4742fcdf3c
Author: Pekka Enberg <penberg@cs.helsinki.fi>
Date:   Sun Nov 8 18:01:06 2009 +0200

    perf tools: Fix permission checks
    
    The perf_event_open() system call returns EACCES if the user is
    not root which results in a very confusing error message:
    
      $ perf record -A -a -f
    
        Error: perfcounter syscall returned with -1 (Permission denied)
    
        Fatal: No CONFIG_PERF_EVENTS=y kernel support configured?
    
    It turns out that's because perf tools are checking only for
    EPERM. Fix that up to get a much better error message:
    
      $ perf record -A -a -f
        Fatal: Permission error - are you root?
    
    Signed-off-by: Pekka Enberg <penberg@cs.helsinki.fi>
    Cc: Peter Zijlstra <a.p.zijlstra@chello.nl>
    Cc: Paul Mackerras <paulus@samba.org>
    Cc: Frederic Weisbecker <fweisbec@gmail.com>
    LKML-Reference: <1257696066-4046-1-git-send-email-penberg@cs.helsinki.fi>
    Signed-off-by: Ingo Molnar <mingo@elte.hu>

diff --git a/tools/perf/builtin-record.c b/tools/perf/builtin-record.c
index 3eeef339c787..a4be453fc8a9 100644
--- a/tools/perf/builtin-record.c
+++ b/tools/perf/builtin-record.c
@@ -426,7 +426,7 @@ static void create_counter(int counter, int cpu, pid_t pid)
 	if (fd[nr_cpu][counter] < 0) {
 		int err = errno;
 
-		if (err == EPERM)
+		if (err == EPERM || err == EACCES)
 			die("Permission error - are you root?\n");
 		else if (err ==  ENODEV && profile_cpu != -1)
 			die("No such device - did you specify an out-of-range profile CPU?\n");
diff --git a/tools/perf/builtin-top.c b/tools/perf/builtin-top.c
index a1b1d10912dc..e23bc74e734f 100644
--- a/tools/perf/builtin-top.c
+++ b/tools/perf/builtin-top.c
@@ -1027,7 +1027,7 @@ static void start_counter(int i, int counter)
 	if (fd[i][counter] < 0) {
 		int err = errno;
 
-		if (err == EPERM)
+		if (err == EPERM || err == EACCES)
 			die("No permission - are you root?\n");
 		/*
 		 * If it's cycles then fall back to hrtimer

