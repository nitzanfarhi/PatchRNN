commit 65f3e55d3592da8fb482b5344a28013029199115
Author: Panu Matilainen <pmatilai@redhat.com>
Date:   Tue Mar 10 10:17:13 2009 +0200

    Don't return data from headerGet() on regionSwab() failure
    - callers dont expect to free data if headerGet() returns failure,
      leaking memory

diff --git a/lib/header.c b/lib/header.c
index 96a6f1c5f..8cac9758e 100644
--- a/lib/header.c
+++ b/lib/header.c
@@ -1183,6 +1183,10 @@ static int copyTdEntry(const indexEntry entry, rpmtd td, headerGetFlags flags)
 	    dataStart = (unsigned char *) memcpy(pe + ril, dataStart, rdl);
 
 	    rc = regionSwab(NULL, ril, 0, pe, dataStart, dataStart + rdl, 0);
+	    /* don't return data on failure */
+	    if (rc < 0) {
+		td->data = _free(td->data);
+	    }
 	    /* XXX 1 on success. */
 	    rc = (rc < 0) ? 0 : 1;
 	} else {

