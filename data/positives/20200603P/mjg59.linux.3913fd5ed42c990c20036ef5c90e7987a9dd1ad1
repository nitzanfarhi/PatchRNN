commit 3913fd5ed42c990c20036ef5c90e7987a9dd1ad1
Author: Dan Carpenter <error27@gmail.com>
Date:   Tue Apr 27 14:12:03 2010 -0700

    gpio: potential null dereference
    
    Smatch found a potential null dereference in gpio_setup_irq().  The
    "pdesc" variable is allocated with idr_find() that can return NULL.  If
    gpio_setup_irq() is called with 0 as gpio_flags and "pdesc" is null, it
    would OOPs here.
    
    Signed-off-by: Dan Carpenter <error27@gmail.com>
    Cc: David Brownell <david-b@pacbell.net>
    Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
    Signed-off-by: Grant Likely <grant.likely@secretlab.ca>

diff --git a/drivers/gpio/gpiolib.c b/drivers/gpio/gpiolib.c
index 76be229c814d..eb0c3fe44b29 100644
--- a/drivers/gpio/gpiolib.c
+++ b/drivers/gpio/gpiolib.c
@@ -416,7 +416,8 @@ static int gpio_setup_irq(struct gpio_desc *desc, struct device *dev,
 	return 0;
 
 free_sd:
-	sysfs_put(pdesc->value_sd);
+	if (pdesc)
+		sysfs_put(pdesc->value_sd);
 free_id:
 	idr_remove(&pdesc_idr, id);
 	desc->flags &= GPIO_FLAGS_MASK;

