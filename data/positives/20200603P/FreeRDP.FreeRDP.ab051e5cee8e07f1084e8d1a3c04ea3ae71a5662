commit ab051e5cee8e07f1084e8d1a3c04ea3ae71a5662
Author: Mads Kiilerich <mads@kiilerich.com>
Date:   Sat Mar 24 01:57:09 2012 +0100

    core: reset crypto key counters when the keys are initialized
    
    This fixes --sec rdp --salted-checksum in combination with farm redirect.
    
    The counters are implicitly set to 0 in rdp_new, but they also has to be reset
    after redirects. Resetting the counters when the keys are reset seems like the
    cleanest solution.

diff --git a/libfreerdp-core/security.c b/libfreerdp-core/security.c
index 5757cea3b..9571f0011 100644
--- a/libfreerdp-core/security.c
+++ b/libfreerdp-core/security.c
@@ -420,6 +420,10 @@ boolean security_establish_keys(uint8* client_random, rdpRdp* rdp)
 
 	memcpy(rdp->decrypt_update_key, rdp->decrypt_key, 16);
 	memcpy(rdp->encrypt_update_key, rdp->encrypt_key, 16);
+	rdp->decrypt_use_count = 0;
+	rdp->decrypt_checksum_use_count = 0;
+	rdp->encrypt_use_count =0;
+	rdp->encrypt_checksum_use_count =0;
 
 	return true;
 }

