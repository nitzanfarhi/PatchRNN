commit 9801d8a39cfe6c34f39f9552a246a6bd002e735e
Author: J. Bruce Fields <bfields@fieldses.org>
Date:   Tue Oct 17 00:10:14 2006 -0700

    [PATCH] knfsd: nfsd4: fix open permission checking
    
    We weren't actually checking for SHARE_ACCESS_WRITE, with the result that the
    owner could open a non-writeable file for write!
    
    Continue to allow DENY_WRITE only with write access.
    
    Thanks to Jim Rees for reporting the bug.
    
    Signed-off-by: J. Bruce Fields <bfields@citi.umich.edu>
    Signed-off-by: Neil Brown <neilb@suse.de>
    Signed-off-by: Andrew Morton <akpm@osdl.org>
    Signed-off-by: Linus Torvalds <torvalds@osdl.org>

diff --git a/fs/nfsd/nfs4proc.c b/fs/nfsd/nfs4proc.c
index a05d3376cc46..d1fac6872c44 100644
--- a/fs/nfsd/nfs4proc.c
+++ b/fs/nfsd/nfs4proc.c
@@ -78,8 +78,10 @@ do_open_permission(struct svc_rqst *rqstp, struct svc_fh *current_fh, struct nfs
 
 	if (open->op_share_access & NFS4_SHARE_ACCESS_READ)
 		accmode |= MAY_READ;
-	if (open->op_share_deny & NFS4_SHARE_ACCESS_WRITE)
+	if (open->op_share_access & NFS4_SHARE_ACCESS_WRITE)
 		accmode |= (MAY_WRITE | MAY_TRUNC);
+	if (open->op_share_deny & NFS4_SHARE_DENY_WRITE)
+		accmode |= MAY_WRITE;
 
 	status = fh_verify(rqstp, current_fh, S_IFREG, accmode);
 

