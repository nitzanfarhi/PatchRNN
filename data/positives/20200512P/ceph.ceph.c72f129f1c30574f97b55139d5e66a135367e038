commit c72f129f1c30574f97b55139d5e66a135367e038
Author: Sage Weil <sage@newdream.net>
Date:   Thu Nov 6 19:15:10 2008 -0800

    ebofs: fix lock recursion

diff --git a/src/ebofs/Ebofs.cc b/src/ebofs/Ebofs.cc
index c39a129dd9..0993299962 100644
--- a/src/ebofs/Ebofs.cc
+++ b/src/ebofs/Ebofs.cc
@@ -3658,9 +3658,17 @@ int Ebofs::collection_remove(coll_t cid, pobject_t oid, Context *onsafe)
   return 0;
 }
 
+
 int Ebofs::collection_list(coll_t cid, vector<pobject_t>& ls)
 {
   ebofs_lock.Lock();
+  int num = _collection_list(cid, ls);
+  ebofs_lock.Unlock();
+  return num;
+}
+
+int Ebofs::_collection_list(coll_t cid, vector<pobject_t>& ls)
+{
   dout(9) << "collection_list " << hex << cid << dec << dendl;
 
   if (!_collection_exists(cid)) {
@@ -3683,7 +3691,6 @@ int Ebofs::collection_list(coll_t cid, vector<pobject_t>& ls)
     }
   }
 
-  ebofs_lock.Unlock();
   return num;
 }
 
diff --git a/src/ebofs/Ebofs.h b/src/ebofs/Ebofs.h
index ee14f13868..789d264fcb 100644
--- a/src/ebofs/Ebofs.h
+++ b/src/ebofs/Ebofs.h
@@ -344,6 +344,7 @@ private:
   int _setattrs(pobject_t oid, map<string,bufferptr>& attrset);
   int _rmattr(pobject_t oid, const char *name);
   bool _collection_exists(coll_t c);
+  int _collection_list(coll_t c, vector<pobject_t>& o);
   int _create_collection(coll_t c);
   int _destroy_collection(coll_t c);
   int _collection_add(coll_t c, pobject_t o);

