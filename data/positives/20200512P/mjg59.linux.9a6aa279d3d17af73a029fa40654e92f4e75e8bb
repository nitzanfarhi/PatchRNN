commit 9a6aa279d3d17af73a029fa40654e92f4e75e8bb
Author: Alexey Kardashevskiy <aik@ozlabs.ru>
Date:   Wed Jun 5 08:54:16 2013 -0600

    vfio: fix crash on rmmod
    
    devtmpfs_delete_node() calls devnode() callback with mode==NULL but
    vfio still tries to write there.
    
    The patch fixes this.
    
    Signed-off-by: Alexey Kardashevskiy <aik@ozlabs.ru>
    Signed-off-by: Alex Williamson <alex.williamson@redhat.com>

diff --git a/drivers/vfio/vfio.c b/drivers/vfio/vfio.c
index acb7121a9316..6d78736563de 100644
--- a/drivers/vfio/vfio.c
+++ b/drivers/vfio/vfio.c
@@ -1360,7 +1360,7 @@ static const struct file_operations vfio_device_fops = {
  */
 static char *vfio_devnode(struct device *dev, umode_t *mode)
 {
-	if (MINOR(dev->devt) == 0)
+	if (mode && (MINOR(dev->devt) == 0))
 		*mode = S_IRUGO | S_IWUGO;
 
 	return kasprintf(GFP_KERNEL, "vfio/%s", dev_name(dev));

