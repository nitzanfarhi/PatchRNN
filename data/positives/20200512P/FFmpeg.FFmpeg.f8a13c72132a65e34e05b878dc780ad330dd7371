commit f8a13c72132a65e34e05b878dc780ad330dd7371
Author: Martin Storsj√∂ <martin@martin.st>
Date:   Thu Sep 15 13:50:57 2016 +0200

    lavf/rtsp: Fix a crash with the RTSP muxer.
    
    Introduced in 00e122bc / bc2a3296
    The whole block that the statement was added to is only
    relevant when used as a demuxer, but the other statements
    there have had other if statements guarding them. Make
    sure to only run this whole block if being used as a
    demuxer.
    
    Fixes ticket #5844.

diff --git a/libavformat/rtsp.c b/libavformat/rtsp.c
index 15e1ab8395..c6292c5543 100644
--- a/libavformat/rtsp.c
+++ b/libavformat/rtsp.c
@@ -834,7 +834,8 @@ int ff_rtsp_open_transport_ctx(AVFormatContext *s, RTSPStream *rtsp_st)
 
     if (!rtsp_st->transport_priv) {
          return AVERROR(ENOMEM);
-    } else if (CONFIG_RTPDEC && rt->transport == RTSP_TRANSPORT_RTP) {
+    } else if (CONFIG_RTPDEC && rt->transport == RTSP_TRANSPORT_RTP &&
+               s->iformat) {
         RTPDemuxContext *rtpctx = rtsp_st->transport_priv;
         rtpctx->ssrc = rtsp_st->ssrc;
         if (rtsp_st->dynamic_handler) {

