commit b2439d26f078c826e5e06b34d978a6f6d5c7c56f
Author: Max Reitz <mreitz@redhat.com>
Date:   Tue Dec 2 18:32:47 2014 +0100

    qemu-img: Check create_opts before image amendment
    
    The image options which can be amended are described by the .create_opts
    field for every driver. This field must therefore be non-NULL so that
    anything can be amended in the first place. Check that this holds true
    before going into qemu_opts_create() (because if .create_opts is NULL,
    the create_opts pointer in img_amend() will be NULL after
    qemu_opts_append()).
    
    Cc: qemu-stable@nongnu.org
    Signed-off-by: Max Reitz <mreitz@redhat.com>
    Reviewed-by: Kevin Wolf <kwolf@redhat.com>
    Signed-off-by: Kevin Wolf <kwolf@redhat.com>

diff --git a/qemu-img.c b/qemu-img.c
index 8c4edf37a9..7876258fa9 100644
--- a/qemu-img.c
+++ b/qemu-img.c
@@ -2986,6 +2986,13 @@ static int img_amend(int argc, char **argv)
         goto out;
     }
 
+    if (!bs->drv->create_opts) {
+        error_report("Format driver '%s' does not support any options to amend",
+                     fmt);
+        ret = -1;
+        goto out;
+    }
+
     create_opts = qemu_opts_append(create_opts, bs->drv->create_opts);
     opts = qemu_opts_create(create_opts, NULL, 0, &error_abort);
     if (options && qemu_opts_do_parse(opts, options, NULL)) {

