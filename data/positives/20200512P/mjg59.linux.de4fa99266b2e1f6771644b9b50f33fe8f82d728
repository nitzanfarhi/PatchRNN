commit de4fa99266b2e1f6771644b9b50f33fe8f82d728
Author: David Brownell <david-b@pacbell.net>
Date:   Fri Dec 29 16:48:47 2006 -0800

    [PATCH] SPI/MTD: mtd_dataflash oops prevention
    
    Return a fault code if the Dataflash driver runs into a "no device present"
    error when the MISO line has a pulldown (it currently expects a pullup), so
    that rmmod won't oops.
    
    Signed-off-by: David Brownell <dbrownell@users.sourceforge.net>
    Cc: David Woodhouse <dwmw2@infradead.org>
    Signed-off-by: Andrew Morton <akpm@osdl.org>
    Signed-off-by: Linus Torvalds <torvalds@osdl.org>

diff --git a/drivers/mtd/devices/mtd_dataflash.c b/drivers/mtd/devices/mtd_dataflash.c
index 0a7e86859bf1..910e4061dfd2 100644
--- a/drivers/mtd/devices/mtd_dataflash.c
+++ b/drivers/mtd/devices/mtd_dataflash.c
@@ -536,7 +536,7 @@ static int __devinit dataflash_probe(struct spi_device *spi)
 	if (status <= 0 || status == 0xff) {
 		DEBUG(MTD_DEBUG_LEVEL1, "%s: status error %d\n",
 				spi->dev.bus_id, status);
-		if (status == 0xff)
+		if (status == 0 || status == 0xff)
 			status = -ENODEV;
 		return status;
 	}

