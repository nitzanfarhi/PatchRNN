commit 5db0b5e1adff92dac54f2dfb1846a42501c8f7d9
Author: Mauro Carvalho Chehab <mchehab@redhat.com>
Date:   Mon Dec 22 06:14:31 2008 -0300

    V4L/DVB (9930): em28xx: Fix bad locks on error condition
    
    Signed-off-by: Mauro Carvalho Chehab <mchehab@redhat.com>

diff --git a/drivers/media/video/em28xx/em28xx-video.c b/drivers/media/video/em28xx/em28xx-video.c
index dbae8bcb18d7..fc41eead640b 100644
--- a/drivers/media/video/em28xx/em28xx-video.c
+++ b/drivers/media/video/em28xx/em28xx-video.c
@@ -819,8 +819,10 @@ static int vidioc_s_fmt_vid_cap(struct file *file, void *priv,
 	vidioc_try_fmt_vid_cap(file, priv, f);
 
 	fmt = format_by_fourcc(f->fmt.pix.pixelformat);
-	if (!fmt)
-		return -EINVAL;
+	if (!fmt) {
+		rc = -EINVAL;
+		goto out;
+	}
 
 	if (videobuf_queue_is_busy(&fh->vb_vidq)) {
 		em28xx_errdev("%s queue busy\n", __func__);
@@ -1305,10 +1307,8 @@ static int vidioc_streamon(struct file *file, void *priv,
 	mutex_lock(&dev->lock);
 	rc = res_get(fh);
 
-	if (unlikely(rc < 0))
-		return rc;
-
-	rc = videobuf_streamon(&fh->vb_vidq);
+	if (likely(rc >= 0))
+		rc = videobuf_streamon(&fh->vb_vidq);
 
 	mutex_unlock(&dev->lock);
 

