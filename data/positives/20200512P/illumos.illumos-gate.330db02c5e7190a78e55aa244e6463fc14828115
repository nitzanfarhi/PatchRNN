commit 330db02c5e7190a78e55aa244e6463fc14828115
Author: Gordon Ross <Gordon.Ross@nexenta.com>
Date:   Wed Dec 8 20:51:19 2010 -0500

    432 Memory leak in smbd/libsmb smb_idmap_getsid
    Reviewed by: garrett@nexenta.com
    Reviewed by: josh@sysmgr.org
    Reviewed by: trisk@nexenta.com
    Approved by: garrett@nexenta.com

diff --git a/usr/src/lib/smbsrv/libsmb/common/smb_idmap.c b/usr/src/lib/smbsrv/libsmb/common/smb_idmap.c
index 8201db46aa..07d0edacd9 100644
--- a/usr/src/lib/smbsrv/libsmb/common/smb_idmap.c
+++ b/usr/src/lib/smbsrv/libsmb/common/smb_idmap.c
@@ -20,6 +20,7 @@
  */
 /*
  * Copyright (c) 2007, 2010, Oracle and/or its affiliates. All rights reserved.
+ * Copyright 2010 Nexenta Systems, Inc.  All rights reserved.
  */
 
 #include <syslog.h>
@@ -174,8 +175,10 @@ smb_idmap_batch_destroy(smb_idmap_batch_t *sib)
 		 * SIDs are allocated only when mapping
 		 * UID/GID to SIDs
 		 */
-		for (i = 0; i < sib->sib_nmap; i++)
+		for (i = 0; i < sib->sib_nmap; i++) {
 			smb_sid_free(sib->sib_maps[i].sim_sid);
+			free(sib->sib_maps[i].sim_domsid);
+		}
 	}
 
 	if (sib->sib_size && sib->sib_maps) {
@@ -367,7 +370,6 @@ smb_idmap_batch_binsid(smb_idmap_batch_t *sib)
 			return (-1);
 
 		sid = smb_sid_fromstr(sim->sim_domsid);
-		free(sim->sim_domsid);
 		if (sid == NULL)
 			return (-1);
 

