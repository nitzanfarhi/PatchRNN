commit 405469cefd240d997ea764fe63480d5ce8f4c3d9
Author: Michael Niedermayer <michaelni@gmx.at>
Date:   Mon Aug 26 08:14:36 2002 +0000

    forgot the const bits in 2pass curve matching (patch (with rounding removed) by RÃ©mi Guyomarch <rguyom at pobox dot com>)
    
    Originally committed as revision 866 to svn://svn.ffmpeg.org/ffmpeg/trunk

diff --git a/libavcodec/ratecontrol.c b/libavcodec/ratecontrol.c
index 1671c9f798..fc05cb535e 100644
--- a/libavcodec/ratecontrol.c
+++ b/libavcodec/ratecontrol.c
@@ -658,7 +658,7 @@ static int init_pass2(MpegEncContext *s)
         if(expected_bits < all_available_bits) avg_quantizer[P_TYPE]-= step;
 //printf("%f %lld %f\n", expected_bits, all_available_bits, avg_quantizer[P_TYPE]);
     }
-printf("qp_i:%f, qp_p:%f, qp_b:%f\n", avg_quantizer[I_TYPE],avg_quantizer[P_TYPE],avg_quantizer[B_TYPE]);
+//printf("qp_i:%f, qp_p:%f, qp_b:%f\n", avg_quantizer[I_TYPE],avg_quantizer[P_TYPE],avg_quantizer[B_TYPE]);
 
     for(i=0; i<5; i++){
         available_bits[i]= const_bits[i] + complexity[i]/avg_quantizer[i];
@@ -723,7 +723,7 @@ printf("qp_i:%f, qp_p:%f, qp_b:%f\n", avg_quantizer[I_TYPE],avg_quantizer[P_TYPE
             RateControlEntry *rce= &rcc->entry[i];
             double bits;
             rce->new_qscale= modify_qscale(s, rce, blured_qscale[i], i);
-            bits= qp2bits(rce, rce->new_qscale);
+            bits= qp2bits(rce, rce->new_qscale) + rce->mv_bits + rce->misc_bits;
 //printf("%d %f\n", rce->new_bits, blured_qscale[i]);
             update_rc_buffer(s, bits);
 

