commit 3ac85fb66626ea91641f5fb9ad9069aab94754f5
Author: Thomas Huth <thuth@linux.vnet.ibm.com>
Date:   Mon Jul 29 15:49:16 2013 +0200

    s390/kvm: Add check for priviledged SCLP handler
    
    The SCLP instruction is priviledged, so we should make sure that
    we generate an exception when it is called from the problem state.
    
    Signed-off-by: Thomas Huth <thuth@linux.vnet.ibm.com>
    Signed-off-by: Christian Borntraeger <borntraeger@de.ibm.com>

diff --git a/target-s390x/kvm.c b/target-s390x/kvm.c
index 4923e0a717..0bc317e928 100644
--- a/target-s390x/kvm.c
+++ b/target-s390x/kvm.c
@@ -439,6 +439,10 @@ static int kvm_sclp_service_call(S390CPU *cpu, struct kvm_run *run,
     int r = 0;
 
     cpu_synchronize_state(CPU(cpu));
+    if (env->psw.mask & PSW_MASK_PSTATE) {
+        enter_pgmcheck(cpu, PGM_PRIVILEGED);
+        return 0;
+    }
     sccb = env->regs[ipbh0 & 0xf];
     code = env->regs[(ipbh0 & 0xf0) >> 4];
 

