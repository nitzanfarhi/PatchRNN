commit 8b2b2d3cbefb605501342adaf64d601b545ed154
Author: Tsutomu Itoh <t-itoh@jp.fujitsu.com>
Date:   Mon Apr 4 01:52:13 2011 +0000

    Btrfs: fix memory leak in btrfs_ioctl_start_sync()
    
    Call btrfs_end_transaction() if btrfs_commit_transaction_async() fails.
    
    Signed-off-by: Tsutomu Itoh <t-itoh@jp.fujitsu.com>
    Signed-off-by: Chris Mason <chris.mason@oracle.com>

diff --git a/fs/btrfs/ioctl.c b/fs/btrfs/ioctl.c
index 6b70e0e2bd1e..255c7c5279c4 100644
--- a/fs/btrfs/ioctl.c
+++ b/fs/btrfs/ioctl.c
@@ -2436,8 +2436,10 @@ static noinline long btrfs_ioctl_start_sync(struct file *file, void __user *argp
 		return PTR_ERR(trans);
 	transid = trans->transid;
 	ret = btrfs_commit_transaction_async(trans, root, 0);
-	if (ret)
+	if (ret) {
+		btrfs_end_transaction(trans, root);
 		return ret;
+	}
 
 	if (argp)
 		if (copy_to_user(argp, &transid, sizeof(transid)))

