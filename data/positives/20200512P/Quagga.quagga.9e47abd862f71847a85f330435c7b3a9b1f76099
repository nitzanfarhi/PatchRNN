commit 9e47abd862f71847a85f330435c7b3a9b1f76099
Author: Rakesh Garimella <rakesh.garimella@sophos.com>
Date:   Mon Mar 11 12:38:31 2013 +0000

    bgpd: prevent double address delete on shutdown
    
    bgp_interface_down() and bgp_exit() both proceed to delete the address
    from bgpd's interface representation, so the second call gets a NULL
    result from the hash lookup and subsequently crashes.
    
    Signed-off-by: Rakesh Garimella <rakesh.garimella@sophos.com>
    [reformatted]
    Signed-off-by: David Lamparter <equinox@opensourcerouting.org>

diff --git a/bgpd/bgp_nexthop.c b/bgpd/bgp_nexthop.c
index d4692366..4076fe41 100644
--- a/bgpd/bgp_nexthop.c
+++ b/bgpd/bgp_nexthop.c
@@ -604,6 +604,10 @@ bgp_address_del (struct prefix *p)
   tmp.addr = p->u.prefix4;
 
   addr = hash_lookup (bgp_address_hash, &tmp);
+  /* may have been deleted earlier by bgp_interface_down() */
+  if (addr == NULL)
+    return;
+
   addr->refcnt--;
 
   if (addr->refcnt == 0)

