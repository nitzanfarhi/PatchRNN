commit c4154145df03aafca2cd64d2fa34fbdfcd0ff00e
Author: Hannes Magnusson <bjori@php.net>
Date:   Tue Jun 20 18:09:50 2006 +0000

    MFH: plug memleak

diff --git a/main/streams/streams.c b/main/streams/streams.c
index 4a9c119801..1f087f8879 100755
--- a/main/streams/streams.c
+++ b/main/streams/streams.c
@@ -1216,7 +1216,7 @@ PHPAPI size_t _php_stream_copy_to_mem(php_stream *src, char **buf, size_t maxlen
 
 		p = php_stream_mmap_range(src, php_stream_tell(src), maxlen, PHP_STREAM_MAP_MODE_SHARED_READONLY, &mapped);
 
-		if (p) {
+		if (p && mapped) {
 			*buf = pemalloc_rel_orig(mapped + 1, persistent);
 
 			if (*buf) {

