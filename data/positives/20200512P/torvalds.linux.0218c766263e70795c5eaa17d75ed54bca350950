commit 0218c766263e70795c5eaa17d75ed54bca350950
Author: Zhenzhong Duan <zhenzhong.duan@oracle.com>
Date:   Fri Jun 22 13:51:26 2018 +0200

    x86/microcode/intel: Fix memleak in save_microcode_patch()
    
    Free useless ucode_patch entry when it's replaced.
    
    [ bp: Drop the memfree_patch() two-liner. ]
    
    Signed-off-by: Zhenzhong Duan <zhenzhong.duan@oracle.com>
    Signed-off-by: Borislav Petkov <bp@suse.de>
    Signed-off-by: Thomas Gleixner <tglx@linutronix.de>
    Cc: Srinivas REDDY Eeda <srinivas.eeda@oracle.com>
    Link: http://lkml.kernel.org/r/888102f0-fd22-459d-b090-a1bd8a00cb2b@default

diff --git a/arch/x86/kernel/cpu/microcode/intel.c b/arch/x86/kernel/cpu/microcode/intel.c
index 1c2cfa0644aa..97ccf4c3b45b 100644
--- a/arch/x86/kernel/cpu/microcode/intel.c
+++ b/arch/x86/kernel/cpu/microcode/intel.c
@@ -190,8 +190,11 @@ static void save_microcode_patch(void *data, unsigned int size)
 			p = memdup_patch(data, size);
 			if (!p)
 				pr_err("Error allocating buffer %p\n", data);
-			else
+			else {
 				list_replace(&iter->plist, &p->plist);
+				kfree(iter->data);
+				kfree(iter);
+			}
 		}
 	}
 

