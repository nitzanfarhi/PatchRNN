commit dd829c45640ff14d7a039af40b3b3975f1b2e484
Author: J. Bruce Fields <bfields@citi.umich.edu>
Date:   Wed Oct 21 17:54:13 2009 -0400

    nfsd4.1: fix session memory use calculation
    
    Unbalanced calculations on creation and destruction of sessions could
    cause our estimate of cache memory used to become negative, sometimes
    resulting in spurious SERVERFAULT returns to client CREATE_SESSION
    requests.
    
    Signed-off-by: J. Bruce Fields <bfields@citi.umich.edu>

diff --git a/fs/nfsd/nfs4state.c b/fs/nfsd/nfs4state.c
index fcb9817881a1..c17137110412 100644
--- a/fs/nfsd/nfs4state.c
+++ b/fs/nfsd/nfs4state.c
@@ -629,10 +629,13 @@ void
 free_session(struct kref *kref)
 {
 	struct nfsd4_session *ses;
+	int mem;
 
 	ses = container_of(kref, struct nfsd4_session, se_ref);
 	spin_lock(&nfsd_drc_lock);
-	nfsd_drc_mem_used -= ses->se_fchannel.maxreqs * NFSD_SLOT_CACHE_SIZE;
+	mem = ses->se_fchannel.maxreqs
+		* (ses->se_fchannel.maxresp_cached - NFSD_MIN_HDR_SEQ_SZ);
+	nfsd_drc_mem_used -= mem;
 	spin_unlock(&nfsd_drc_lock);
 	free_session_slots(ses);
 	kfree(ses);

