commit 8e1a0476f8563cadfa32e9b4fff39c4224553b1e
Author: Christoffer Dall <christoffer.dall@linaro.org>
Date:   Mon Dec 5 10:32:11 2016 +0100

    KVM: arm/arm64: timer: Check for properly initialized timer on init
    
    When the arch timer code fails to initialize (for example because the
    memory mapped timer doesn't work, which is currently seen with the AEM
    model), then KVM just continues happily with a final result that KVM
    eventually does a NULL pointer dereference of the uninitialized cycle
    counter.
    
    Check directly for this in the init path and give the user a reasonable
    error in this case.
    
    Cc: Shih-Wei Li <shihwei@cs.columbia.edu>
    Signed-off-by: Christoffer Dall <christoffer.dall@linaro.org>
    Signed-off-by: Marc Zyngier <marc.zyngier@arm.com>

diff --git a/virt/kvm/arm/arch_timer.c b/virt/kvm/arm/arch_timer.c
index 17b8fa52bf3b..ae95fc0e3214 100644
--- a/virt/kvm/arm/arch_timer.c
+++ b/virt/kvm/arm/arch_timer.c
@@ -425,6 +425,11 @@ int kvm_timer_hyp_init(void)
 	info = arch_timer_get_kvm_info();
 	timecounter = &info->timecounter;
 
+	if (!timecounter->cc) {
+		kvm_err("kvm_arch_timer: uninitialized timecounter\n");
+		return -ENODEV;
+	}
+
 	if (info->virtual_irq <= 0) {
 		kvm_err("kvm_arch_timer: invalid virtual timer IRQ: %d\n",
 			info->virtual_irq);

