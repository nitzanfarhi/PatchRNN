commit df403bc58859c893ebd0accda07678e84d15dc5d
Author: John Snow <jsnow@redhat.com>
Date:   Mon Sep 26 14:33:37 2016 -0400

    ahci: clear aiocb in ncq_cb
    
    Similar to existing fixes for IDE (87ac25fd) and ATAPI (7f951b2d), the
    AIOCB must be cleared in the callback. Otherwise, we may accidentally
    try to reset a dangling pointer in bdrv_aio_cancel() from a port reset.
    
    Signed-off-by: John Snow <jsnow@redhat.com>
    Reviewed-by: Stefan Hajnoczi <stefanha@redhat.com>
    Message-id: 1474575040-32079-2-git-send-email-jsnow@redhat.com
    Signed-off-by: John Snow <jsnow@redhat.com>

diff --git a/hw/ide/ahci.c b/hw/ide/ahci.c
index f3438ad78a..63ead21047 100644
--- a/hw/ide/ahci.c
+++ b/hw/ide/ahci.c
@@ -948,6 +948,7 @@ static void ncq_cb(void *opaque, int ret)
     NCQTransferState *ncq_tfs = (NCQTransferState *)opaque;
     IDEState *ide_state = &ncq_tfs->drive->port.ifs[0];
 
+    ncq_tfs->aiocb = NULL;
     if (ret == -ECANCELED) {
         return;
     }

