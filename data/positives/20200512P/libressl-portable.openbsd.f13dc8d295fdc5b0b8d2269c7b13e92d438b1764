commit f13dc8d295fdc5b0b8d2269c7b13e92d438b1764
Author: jsing <>
Date:   Thu Jun 5 15:51:06 2014 +0000

    Ensure that we do not process a ChangeCipherSpec with an empty master
    secret. This is an additional safeguard against early ChangeCipherSpec
    handling.
    
    From OpenSSL.
    
    ok deraadt@

diff --git a/src/lib/libssl/s3_pkt.c b/src/lib/libssl/s3_pkt.c
index 58d8221fe..942ab37b9 100644
--- a/src/lib/libssl/s3_pkt.c
+++ b/src/lib/libssl/s3_pkt.c
@@ -1337,7 +1337,7 @@ ssl3_do_change_cipher_spec(SSL *s)
 		i = SSL3_CHANGE_CIPHER_CLIENT_READ;
 
 	if (s->s3->tmp.key_block == NULL) {
-		if (s->session == NULL) {
+		if (s->session == NULL || s->session->master_key_length == 0) {
 			/* might happen if dtls1_read_bytes() calls this */
 			SSLerr(SSL_F_SSL3_DO_CHANGE_CIPHER_SPEC,
 			    SSL_R_CCS_RECEIVED_EARLY);
diff --git a/src/lib/libssl/src/ssl/s3_pkt.c b/src/lib/libssl/src/ssl/s3_pkt.c
index 58d8221fe..942ab37b9 100644
--- a/src/lib/libssl/src/ssl/s3_pkt.c
+++ b/src/lib/libssl/src/ssl/s3_pkt.c
@@ -1337,7 +1337,7 @@ ssl3_do_change_cipher_spec(SSL *s)
 		i = SSL3_CHANGE_CIPHER_CLIENT_READ;
 
 	if (s->s3->tmp.key_block == NULL) {
-		if (s->session == NULL) {
+		if (s->session == NULL || s->session->master_key_length == 0) {
 			/* might happen if dtls1_read_bytes() calls this */
 			SSLerr(SSL_F_SSL3_DO_CHANGE_CIPHER_SPEC,
 			    SSL_R_CCS_RECEIVED_EARLY);

