commit 95edcff497b126a3f3e079e94b20fe2ca7e5a63d
Author: Jeff Layton <jlayton@redhat.com>
Date:   Thu Dec 1 20:22:41 2011 -0500

    cifs: attempt to freeze while looping on a receive attempt
    
    In the recent overhaul of the demultiplex thread receive path, I
    neglected to ensure that we attempt to freeze on each pass through the
    receive loop.
    
    Reported-and-Tested-by: Woody Suwalski <terraluna977@gmail.com>
    Reported-and-Tested-by: Adam Williamson <awilliam@redhat.com>
    Signed-off-by: Jeff Layton <jlayton@redhat.com>
    Signed-off-by: Steve French <smfrench@gmail.com>

diff --git a/fs/cifs/connect.c b/fs/cifs/connect.c
index d6a972df0338..8cd4b52d4217 100644
--- a/fs/cifs/connect.c
+++ b/fs/cifs/connect.c
@@ -441,6 +441,8 @@ cifs_readv_from_socket(struct TCP_Server_Info *server, struct kvec *iov_orig,
 	smb_msg.msg_controllen = 0;
 
 	for (total_read = 0; to_read; total_read += length, to_read -= length) {
+		try_to_freeze();
+
 		if (server_unresponsive(server)) {
 			total_read = -EAGAIN;
 			break;

