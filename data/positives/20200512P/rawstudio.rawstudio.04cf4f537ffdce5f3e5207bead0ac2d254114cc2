commit 04cf4f537ffdce5f3e5207bead0ac2d254114cc2
Author: post <klauspost@gmail.com>
Date:   Sat Jul 10 19:55:53 2010 +0000

    Make a whole bunch of GStaticMutex actually static, and not just show good intentions, but actually act as a mutex ;)

diff --git a/librawstudio/rs-dcp-file.c b/librawstudio/rs-dcp-file.c
index eb4a6409..eaf2c900 100644
--- a/librawstudio/rs-dcp-file.c
+++ b/librawstudio/rs-dcp-file.c
@@ -198,7 +198,7 @@ read_illuminant(RSDcpFile *dcp_file, guint ifd, gushort tag)
 const gchar *
 read_ascii(RSDcpFile *dcp_file, guint ifd, gushort tag, gchar **cache)
 {
-	GStaticMutex lock = G_STATIC_MUTEX_INIT;
+	static GStaticMutex lock = G_STATIC_MUTEX_INIT;
 	g_static_mutex_lock(&lock);
 	if (!*cache)
 		*cache = rs_tiff_get_ascii(RS_TIFF(dcp_file), ifd, tag);
diff --git a/librawstudio/rs-filter-request.c b/librawstudio/rs-filter-request.c
index fac9c6f3..d9ffc8cd 100644
--- a/librawstudio/rs-filter-request.c
+++ b/librawstudio/rs-filter-request.c
@@ -67,7 +67,7 @@ rs_filter_request_new(void)
 const RSFilterRequest *rs_filter_request_get_quick_singleton(void)
 {
 	RSFilterRequest *request = NULL;
-	GStaticMutex lock = G_STATIC_MUTEX_INIT;
+	static GStaticMutex lock = G_STATIC_MUTEX_INIT;
 
 	g_static_mutex_lock(&lock);
 	if (!request)
diff --git a/librawstudio/rs-job-queue.c b/librawstudio/rs-job-queue.c
index fa8c9dcd..892d87cb 100644
--- a/librawstudio/rs-job-queue.c
+++ b/librawstudio/rs-job-queue.c
@@ -130,7 +130,7 @@ static RSJobQueue *
 rs_job_queue_get_singleton()
 {
 	static RSJobQueue *singleton = NULL;
-	GStaticMutex lock = G_STATIC_MUTEX_INIT;
+	static GStaticMutex lock = G_STATIC_MUTEX_INIT;
 
 	g_static_mutex_lock(&lock);
 	if (!singleton)
diff --git a/librawstudio/rs-lens-db.c b/librawstudio/rs-lens-db.c
index c5f26030..18114f7c 100644
--- a/librawstudio/rs-lens-db.c
+++ b/librawstudio/rs-lens-db.c
@@ -113,7 +113,7 @@ save_db(RSLensDb *lens_db)
 {
 	xmlTextWriterPtr writer;
 	GList *list;
-	GStaticMutex lock = G_STATIC_MUTEX_INIT;
+	static GStaticMutex lock = G_STATIC_MUTEX_INIT;
 
 	g_static_mutex_lock(&lock);
 	writer = xmlNewTextWriterFilename(lens_db->path, 0);
diff --git a/librawstudio/rs-metadata.c b/librawstudio/rs-metadata.c
index c7d17cc2..6fe214f2 100644
--- a/librawstudio/rs-metadata.c
+++ b/librawstudio/rs-metadata.c
@@ -121,7 +121,7 @@ rs_metadata_cache_save(RSMetadata *metadata, const gchar *filename)
 	gchar *cache_filename;
 	gchar *thumb_filename;
 	xmlTextWriterPtr writer;
-	GStaticMutex lock = G_STATIC_MUTEX_INIT;
+	static GStaticMutex lock = G_STATIC_MUTEX_INIT;
 
 	if (!dotdir)
 		return;
diff --git a/librawstudio/rs-profile-factory.c b/librawstudio/rs-profile-factory.c
index 675d4328..13afeba0 100644
--- a/librawstudio/rs-profile-factory.c
+++ b/librawstudio/rs-profile-factory.c
@@ -153,7 +153,7 @@ RSProfileFactory *
 rs_profile_factory_new_default(void)
 {
 	static RSProfileFactory *factory = NULL;
-	GStaticMutex lock = G_STATIC_MUTEX_INIT;
+	static GStaticMutex lock = G_STATIC_MUTEX_INIT;
 
 	g_static_mutex_lock(&lock);
 	if (!factory)
@@ -171,7 +171,7 @@ rs_profile_factory_new_default(void)
 const gchar *
 rs_profile_factory_get_user_profile_directory(void)
 {
-	GStaticMutex lock = G_STATIC_MUTEX_INIT;
+	static GStaticMutex lock = G_STATIC_MUTEX_INIT;
 	gchar *directory = NULL;
 
 	g_static_mutex_lock(&lock);
diff --git a/src/gtk-helper.c b/src/gtk-helper.c
index e3ea76e5..a770950c 100644
--- a/src/gtk-helper.c
+++ b/src/gtk-helper.c
@@ -437,7 +437,7 @@ gui_select_theme(RS_THEME theme)
 {
 	static RS_THEME current_theme = STANDARD_GTK_THEME;
 	static gchar **default_rc_files = NULL;
-	GStaticMutex lock = G_STATIC_MUTEX_INIT;
+	static GStaticMutex lock = G_STATIC_MUTEX_INIT;
 	GtkSettings *settings;
 
 	g_static_mutex_lock(&lock);
diff --git a/src/gtk-interface.c b/src/gtk-interface.c
index bf672bed..27e51622 100644
--- a/src/gtk-interface.c
+++ b/src/gtk-interface.c
@@ -149,7 +149,10 @@ open_photo(RS_BLOB *rs, const gchar *filename)
 	photo = rs_photo_load_from_file(filename);
 
 	if (photo)
-		rs_photo_close(rs->photo);
+	{
+		if (rs->photo)
+			rs_photo_close(rs->photo);
+	}
 	else
 	{
 		gui_set_busy(FALSE);
@@ -743,7 +746,7 @@ gui_dialog_simple(gchar *title, gchar *message)
 GtkUIManager *
 gui_get_uimanager()
 {
-	GStaticMutex lock = G_STATIC_MUTEX_INIT;
+	static GStaticMutex lock = G_STATIC_MUTEX_INIT;
 	static GtkUIManager *ui_manager = NULL;
 
 	g_static_mutex_lock(&lock);
diff --git a/src/rs-actions.c b/src/rs-actions.c
index 8f982194..8404b8ee 100644
--- a/src/rs-actions.c
+++ b/src/rs-actions.c
@@ -42,7 +42,7 @@
 #include "rs-toolbox.h"
 
 static GtkActionGroup *core_action_group = NULL;
-GStaticMutex rs_actions_spinlock = G_STATIC_MUTEX_INIT;
+static GStaticMutex rs_actions_spinlock = G_STATIC_MUTEX_INIT;
 
 #define ACTION(Action) void rs_action_##Action(GtkAction *action, RS_BLOB *rs); \
 	void rs_action_##Action(GtkAction *action, RS_BLOB *rs)
diff --git a/src/rs-store.c b/src/rs-store.c
index ed38f048..bc0e014f 100644
--- a/src/rs-store.c
+++ b/src/rs-store.c
@@ -1195,7 +1195,7 @@ rs_store_load_directory(RSStore *store, const gchar *path)
 {
 	RSLibrary *library = rs_library_get_singleton();
 	static gboolean running = FALSE;
-	GStaticMutex lock = G_STATIC_MUTEX_INIT;
+	static GStaticMutex lock = G_STATIC_MUTEX_INIT;
 
 	GtkTreeSortable *sortable;
 	gboolean load_8bit = FALSE;

