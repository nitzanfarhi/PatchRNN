commit 69b95a3a80b44ebb71bf153e79bcb8580e1d3de5
Author: Sylwester Nawrocki <sylvester.nawrocki@gmail.com>
Date:   Thu Feb 7 18:36:12 2013 -0300

    [media] s3c-camif: Fail on insufficient number of allocated buffers
    
    Ensure the driver gets always at least its minimum required
    number of buffers allocated by checking actual number of
    allocated buffers in vb2_reqbufs(). And free any partially
    allocated buffer queue with signaling an error to user space.
    Without this patch applications may wait forever to dequeue
    a filled buffer, because the hardware didn't even start after
    VIDIOC_STREAMON, VIDIOC_QBUF calls, due to insufficient number
    of empty buffers.
    
    Reported-by: Alexander Nestorov <alexandernst@gmail.com>
    Signed-off-by: Sylwester Nawrocki <sylvester.nawrocki@gmail.com>
    Signed-off-by: Mauro Carvalho Chehab <mchehab@redhat.com>

diff --git a/drivers/media/platform/s3c-camif/camif-capture.c b/drivers/media/platform/s3c-camif/camif-capture.c
index e91f350929eb..70438a0f62ae 100644
--- a/drivers/media/platform/s3c-camif/camif-capture.c
+++ b/drivers/media/platform/s3c-camif/camif-capture.c
@@ -934,12 +934,19 @@ static int s3c_camif_reqbufs(struct file *file, void *priv,
 		vp->owner = NULL;
 
 	ret = vb2_reqbufs(&vp->vb_queue, rb);
-	if (!ret) {
-		vp->reqbufs_count = rb->count;
-		if (vp->owner == NULL && rb->count > 0)
-			vp->owner = priv;
+	if (ret < 0)
+		return ret;
+
+	if (rb->count && rb->count < CAMIF_REQ_BUFS_MIN) {
+		rb->count = 0;
+		vb2_reqbufs(&vp->vb_queue, rb);
+		ret = -ENOMEM;
 	}
 
+	vp->reqbufs_count = rb->count;
+	if (vp->owner == NULL && rb->count > 0)
+		vp->owner = priv;
+
 	return ret;
 }
 

