commit aae6ec353d0b28d3feef485b0915d1e5120cdfe0
Author: deraadt <deraadt@openbsd.org>
Date:   Fri Sep 16 23:47:00 2005 +0000

    if tokendb_open() failed, do not crash if tokendb_close() is called

diff --git a/libexec/login_token/tokendb.c b/libexec/login_token/tokendb.c
index d0260e8d39d..def4135df74 100644
--- a/libexec/login_token/tokendb.c
+++ b/libexec/login_token/tokendb.c
@@ -1,4 +1,4 @@
-/*	$OpenBSD: tokendb.c,v 1.7 2003/07/29 18:39:23 deraadt Exp $	*/
+/*	$OpenBSD: tokendb.c,v 1.8 2005/09/16 23:47:00 deraadt Exp $	*/
 
 /*-
  * Copyright (c) 1995 Migration Associates Corp. All Rights Reserved
@@ -236,8 +236,11 @@ tokendb_open(void)
 static	void
 tokendb_close(void)
 {
-	(void)flock((tokendb->fd)(tokendb), LOCK_UN);
-	(tokendb->close)(tokendb);
+	if (tokendb) {
+		(void)flock((tokendb->fd)(tokendb), LOCK_UN);
+		(tokendb->close)(tokendb);
+		tokendb = NULL;
+	}
 }
 
 /*

