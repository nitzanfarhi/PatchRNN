commit e637d553199e264327714da437e6c808f2f4b096
Author: Robert Jennings <rcj@linux.vnet.ibm.com>
Date:   Thu Jan 22 13:40:09 2009 -0600

    [SCSI] ibmvscsi: Correct DMA mapping leak
    
    The ibmvscsi client driver is not unmapping the SCSI command after
    encountering a DMA mapping error while trying to map an indirect
    scattergather list for the event pool.  This leads to a leak of DMA
    entitlement that could result in the device failing future DMA operations
    in a CMO environment.
    
    Signed-off-by: Robert Jennings <rcj@linux.vnet.ibm.com>
    Acked-by: Brian King <brking@linux.vnet.ibm.com>
    Signed-off-by: James Bottomley <James.Bottomley@HansenPartnership.com>

diff --git a/drivers/scsi/ibmvscsi/ibmvscsi.c b/drivers/scsi/ibmvscsi/ibmvscsi.c
index 74d07d137dae..c9aa7611e408 100644
--- a/drivers/scsi/ibmvscsi/ibmvscsi.c
+++ b/drivers/scsi/ibmvscsi/ibmvscsi.c
@@ -432,6 +432,7 @@ static int map_sg_data(struct scsi_cmnd *cmd,
 				sdev_printk(KERN_ERR, cmd->device,
 				            "Can't allocate memory "
 				            "for indirect table\n");
+			scsi_dma_unmap(cmd);
 			return 0;
 		}
 	}

