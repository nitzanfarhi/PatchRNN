commit 6d26397a616586999f93fc4de30203db267a28f4
Author: Panu Matilainen <pmatilai@redhat.com>
Date:   Thu Jan 15 09:22:58 2009 +0200

    Make sure global state gets NULLed on free
    - otherwise repeated read config -> free config like rpmbuild does
      will crash and burn
    - somewhat kludgy, figure a better way to do this

diff --git a/rpmio/rpmlua.c b/rpmio/rpmlua.c
index 4afa8d510..133fa1629 100644
--- a/rpmio/rpmlua.c
+++ b/rpmio/rpmlua.c
@@ -84,6 +84,7 @@ void *rpmluaFree(rpmlua lua)
 	if (lua->L) lua_close(lua->L);
 	free(lua->printbuf);
 	free(lua);
+	if (lua == globalLuaState) globalLuaState = NULL;
     }
     return NULL;
 }

