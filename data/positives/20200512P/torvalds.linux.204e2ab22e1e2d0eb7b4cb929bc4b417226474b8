commit 204e2ab22e1e2d0eb7b4cb929bc4b417226474b8
Author: Larry Finger <Larry.Finger@lwfinger.net>
Date:   Sat Jun 25 13:37:43 2016 -0500

    rtlwifi: rtl8188ee: Fix potential race condition
    
    Flag rfchange_inprogress in struct rtl_ps_ctl is protected by a spinlock
    in most routines but not in rtl88e_dm_watchdog(), which could
    lead to a race condition. The necessary locking to prevent this condition
    is added.
    
    Reported-by: Pavel Andrianov <andrianov@ispras.ru>
    Signed-off-by: Larry Finger <Larry.Finger@lwfinger.net>
    Cc: Pavel Andrianov <andrianov@ispras.ru>
    Signed-off-by: Kalle Valo <kvalo@codeaurora.org>

diff --git a/drivers/net/wireless/realtek/rtlwifi/rtl8188ee/dm.c b/drivers/net/wireless/realtek/rtlwifi/rtl8188ee/dm.c
index 6e7b673ae898..f936a491371b 100644
--- a/drivers/net/wireless/realtek/rtlwifi/rtl8188ee/dm.c
+++ b/drivers/net/wireless/realtek/rtlwifi/rtl8188ee/dm.c
@@ -1790,6 +1790,7 @@ void rtl88e_dm_watchdog(struct ieee80211_hw *hw)
 	if (ppsc->p2p_ps_info.p2p_ps_mode)
 		fw_ps_awake = false;
 
+	spin_lock(&rtlpriv->locks.rf_ps_lock);
 	if ((ppsc->rfpwr_state == ERFON) &&
 	    ((!fw_current_inpsmode) && fw_ps_awake) &&
 	    (!ppsc->rfchange_inprogress)) {
@@ -1802,4 +1803,5 @@ void rtl88e_dm_watchdog(struct ieee80211_hw *hw)
 		rtl88e_dm_check_edca_turbo(hw);
 		rtl88e_dm_antenna_diversity(hw);
 	}
+	spin_unlock(&rtlpriv->locks.rf_ps_lock);
 }

