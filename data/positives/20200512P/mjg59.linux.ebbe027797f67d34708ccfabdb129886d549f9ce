commit ebbe027797f67d34708ccfabdb129886d549f9ce
Author: Robin Dong <sanbai@taobao.com>
Date:   Wed Oct 26 05:14:27 2011 -0400

    ext4: use stream-alloc when mb_group_prealloc set to zero
    
    The kernel will crash on
    
    ext4_mb_mark_diskspace_used:
            BUG_ON(ac->ac_b_ex.fe_len <= 0);
    
    after we set /sys/fs/ext4/sda/mb_group_prealloc to zero and create new files in an ext4 filesystem.
    
    The reason is: ac_b_ex.fe_len also set to zero(mb_group_prealloc) in ext4_mb_normalize_group_request
    because the ac_flags contains EXT4_MB_HINT_GROUP_ALLOC.
    
    I think when someone set mb_group_prealloc to zero, it means DO NOT USE GROUP PREALLOCATION,
    so we should set alloc-strategy to STREAM in this case.
    
    Signed-off-by: Robin Dong <sanbai@taobao.com>
    Signed-off-by: "Theodore Ts'o" <tytso@mit.edu>

diff --git a/fs/ext4/mballoc.c b/fs/ext4/mballoc.c
index cd70b3041185..89762652aae2 100644
--- a/fs/ext4/mballoc.c
+++ b/fs/ext4/mballoc.c
@@ -4006,6 +4006,11 @@ static void ext4_mb_group_or_file(struct ext4_allocation_context *ac)
 		return;
 	}
 
+	if (sbi->s_mb_group_prealloc <= 0) {
+		ac->ac_flags |= EXT4_MB_STREAM_ALLOC;
+		return;
+	}
+
 	/* don't use group allocation for large files */
 	size = max(size, isize);
 	if (size > sbi->s_mb_stream_request) {

