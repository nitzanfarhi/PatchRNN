commit ca22f4cdcb097d0b3f30e50a38dd724672170908
Author: alobbs <alvaro@alobbs.com>
Date:   Wed Jun 9 15:20:45 2010 +0000

    Slightly safer TLS/SSL connection close.
    
    git-svn-id: svn://cherokee-project.com/cherokee/trunk@5187 5dc97367-97f1-0310-9951-d761b3857238

diff --git a/cherokee/cryptor_libssl.c b/cherokee/cryptor_libssl.c
index 5af3e49e..b27621ff 100644
--- a/cherokee/cryptor_libssl.c
+++ b/cherokee/cryptor_libssl.c
@@ -640,10 +640,24 @@ static ret_t
 _socket_close (cherokee_cryptor_socket_libssl_t *cryp)
 {
 	int re;
+	int fd;
 
 	if (cryp->session != NULL) {
+		/* Send a 'close_notify' SSL message
+		 */
 		re = SSL_shutdown (cryp->session);
 		if (re == 0) {
+			/* Send a TCP FIN segment to trigger the
+			 * client's 'close_notify' - leaving the
+			 * connection open for reading.
+			 */
+			fd = SSL_get_fd (cryp->session);
+			if (fd >= 0) {
+				do {
+					re = shutdown (fd, SHUT_WR);
+				} while ((re == -1) && (errno == EINTR));
+			}
+
 			/* Call it again to finish the shutdown */
 			re = SSL_shutdown (cryp->session);
 		}

