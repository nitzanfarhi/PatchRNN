commit 33d06aacd99a0e7504e05adf241728e59649b7d8
Author: ellie timoney <ellie@fastmail.com>
Date:   Fri May 12 11:11:39 2017 +1000

    http_dav: don't leak attrib
    
    Thanks Дилян Палаузов for finding this

diff --git a/imap/http_dav.c b/imap/http_dav.c
index c2d52b1a7..ed8ff7f9f 100644
--- a/imap/http_dav.c
+++ b/imap/http_dav.c
@@ -2777,15 +2777,20 @@ static int propfind_fromresource(const xmlChar *name, xmlNsPtr ns,
                                 buf_cstring(&fctx->buf), NULL, &attrib);
 
 done:
-    if (r) return HTTP_SERVER_ERROR;
-    if (!buf_len(&attrib)) return HTTP_NOT_FOUND;
+    if (r) r = HTTP_SERVER_ERROR;
+    else if (!buf_len(&attrib)) r = HTTP_NOT_FOUND;
 
-    node = xml_add_prop(HTTP_OK, fctx->ns[NS_DAV], &propstat[PROPSTAT_OK],
-                        name, ns, NULL, 0);
-    xmlAddChild(node, xmlNewCDataBlock(fctx->root->doc,
-                                       BAD_CAST buf_cstring(&attrib), buf_len(&attrib)));
+    if (!r) {
+        node = xml_add_prop(HTTP_OK, fctx->ns[NS_DAV], &propstat[PROPSTAT_OK],
+                            name, ns, NULL, 0);
+        xmlAddChild(node, xmlNewCDataBlock(fctx->root->doc,
+                                           BAD_CAST buf_cstring(&attrib),
+                                           buf_len(&attrib)));
+    }
 
-    return 0;
+    buf_free(&attrib);
+
+    return r;
 }
 
 

