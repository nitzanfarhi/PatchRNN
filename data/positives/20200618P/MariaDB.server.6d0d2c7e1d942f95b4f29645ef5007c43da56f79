commit 6d0d2c7e1d942f95b4f29645ef5007c43da56f79
Author: unknown <heikki@hundin.mysql.fi>
Date:   Mon Mar 21 22:21:55 2005 +0200

    trx0trx.c:
      If MySQL wrote to its binlog, but for some reason trx->update_undo and trx->insert_undo were NULL in InnoDB, then trx->commit_lsn was garbage, and InnoDB could assert in the log flush of trx_commit_complete_for_mysql() (Bug #9277)
    
    
    innobase/trx/trx0trx.c:
      If MySQL wrote to its binlog, but for some reason trx->update_undo and trx->insert_undo were NULL in InnoDB, then trx->commit_lsn was garbage, and InnoDB could assert in the log flush of trx_commit_complete_for_mysql() (Bug #9277)

diff --git a/innobase/trx/trx0trx.c b/innobase/trx/trx0trx.c
index 8f409034df0..13575a3cedd 100644
--- a/innobase/trx/trx0trx.c
+++ b/innobase/trx/trx0trx.c
@@ -96,6 +96,7 @@ trx_create(
 	trx->check_unique_secondary = TRUE;
 
 	trx->flush_log_later = FALSE;
+	trx->must_flush_log_later = FALSE;
 
 	trx->dict_operation = FALSE;
 
@@ -654,6 +655,8 @@ trx_commit_off_kernel(
 	ut_ad(mutex_own(&kernel_mutex));
 #endif /* UNIV_SYNC_DEBUG */
 
+	trx->must_flush_log_later = FALSE;
+
 	rseg = trx->rseg;
 	
 	if (trx->insert_undo != NULL || trx->update_undo != NULL) {
@@ -821,6 +824,7 @@ trx_commit_off_kernel(
 
                 if (trx->flush_log_later) {
                         /* Do nothing yet */
+			trx->must_flush_log_later = TRUE;
                 } else if (srv_flush_log_at_trx_commit == 0) {
                         /* Do nothing */
                 } else if (srv_flush_log_at_trx_commit == 1) {
@@ -1539,7 +1543,9 @@ trx_commit_complete_for_mysql(
 	
 	trx->op_info = "flushing log";
 
-        if (srv_flush_log_at_trx_commit == 0) {
+	if (!trx->must_flush_log_later) {
+                /* Do nothing */
+        } else if (srv_flush_log_at_trx_commit == 0) {
                 /* Do nothing */
         } else if (srv_flush_log_at_trx_commit == 1) {
                 if (srv_unix_file_flush_method == SRV_UNIX_NOSYNC) {
@@ -1560,6 +1566,8 @@ trx_commit_complete_for_mysql(
         } else {
                 ut_error;
         }
+	
+	trx->must_flush_log_later = FALSE;
 
 	trx->op_info = "";
 

