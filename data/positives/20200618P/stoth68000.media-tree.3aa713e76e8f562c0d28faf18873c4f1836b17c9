commit 3aa713e76e8f562c0d28faf18873c4f1836b17c9
Author: Mattias Wallin <mattias.wallin@stericsson.com>
Date:   Thu Nov 4 11:01:31 2010 +0100

    regulator: lock supply in regulator enable
    
    This patch add locks around regulator supply enable.
    
    Signed-off-by: Mattias Wallin <mattias.wallin@stericsson.com>
    Acked-by: Mark Brown <broonie@opensource.wolfsonmicro.com>
    Signed-off-by: Liam Girdwood <lrg@slimlogic.co.uk>

diff --git a/drivers/regulator/core.c b/drivers/regulator/core.c
index 711fa1722bce..27d062e1395c 100644
--- a/drivers/regulator/core.c
+++ b/drivers/regulator/core.c
@@ -1269,7 +1269,9 @@ static int _regulator_enable(struct regulator_dev *rdev)
 
 	/* do we need to enable the supply regulator first */
 	if (rdev->supply) {
+		mutex_lock(&rdev->supply->mutex);
 		ret = _regulator_enable(rdev->supply);
+		mutex_unlock(&rdev->supply->mutex);
 		if (ret < 0) {
 			printk(KERN_ERR "%s: failed to enable %s: %d\n",
 			       __func__, rdev_get_name(rdev), ret);

