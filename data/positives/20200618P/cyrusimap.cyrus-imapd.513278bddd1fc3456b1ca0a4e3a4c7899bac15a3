commit 513278bddd1fc3456b1ca0a4e3a4c7899bac15a3
Author: Ken Murchison <murch@andrew.cmu.edu>
Date:   Wed Aug 3 15:25:03 2016 -0400

    httpd.c: move initialization of deflate context from cmdloop() to service_main()

diff --git a/imap/httpd.c b/imap/httpd.c
index 96ed1db11..42f6ed439 100644
--- a/imap/httpd.c
+++ b/imap/httpd.c
@@ -1061,6 +1061,15 @@ int service_main(int argc __attribute__((unused)),
         }
     }
 
+#ifdef HAVE_ZLIB
+    /* Always use gzip format because IE incorrectly uses raw deflate */
+    if (config_getswitch(IMAPOPT_HTTPALLOWCOMPRESS) &&
+        deflateInit2(&http_conn.zstrm, Z_DEFAULT_COMPRESSION, Z_DEFLATED,
+                     16+MAX_WBITS, MAX_MEM_LEVEL, Z_DEFAULT_STRATEGY) == Z_OK) {
+        http_conn.gzip_enabled = 1;
+    }
+#endif
+
     cmdloop(&http_conn);
 
     /* Closing connection */
@@ -1852,15 +1861,6 @@ static void cmdloop(struct http_connection *conn)
     /* Pre-allocate our working buffer */
     buf_ensure(&txn.buf, 1024);
 
-#ifdef HAVE_ZLIB
-    /* Always use gzip format because IE incorrectly uses raw deflate */
-    if (config_getswitch(IMAPOPT_HTTPALLOWCOMPRESS) &&
-        deflateInit2(&conn->zstrm, Z_DEFAULT_COMPRESSION, Z_DEFLATED,
-                     16+MAX_WBITS, MAX_MEM_LEVEL, Z_DEFAULT_STRATEGY) == Z_OK) {
-        conn->gzip_enabled = 1;
-    }
-#endif
-
     for (;;) {
         int ret = 0;
 

