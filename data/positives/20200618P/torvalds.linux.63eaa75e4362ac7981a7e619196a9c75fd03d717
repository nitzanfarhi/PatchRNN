commit 63eaa75e4362ac7981a7e619196a9c75fd03d717
Author: Maurizio Lombardi <mlombard@redhat.com>
Date:   Thu Sep 11 12:28:03 2014 +0200

    amd_iommu: do not dereference a NULL pointer address.
    
    under low memory conditions, alloc_pte() may return a NULL pointer.
    iommu_map_page() does not check it and will panic the system.
    
    Signed-off-by: Maurizio Lombardi <mlombard@redhat.com>
    Signed-off-by: Joerg Roedel <jroedel@suse.de>

diff --git a/drivers/iommu/amd_iommu.c b/drivers/iommu/amd_iommu.c
index 989c1ae03979..23c5be6a3a1e 100644
--- a/drivers/iommu/amd_iommu.c
+++ b/drivers/iommu/amd_iommu.c
@@ -1393,6 +1393,9 @@ static int iommu_map_page(struct protection_domain *dom,
 	count     = PAGE_SIZE_PTE_COUNT(page_size);
 	pte       = alloc_pte(dom, bus_addr, page_size, NULL, GFP_KERNEL);
 
+	if (!pte)
+		return -ENOMEM;
+
 	for (i = 0; i < count; ++i)
 		if (IOMMU_PTE_PRESENT(pte[i]))
 			return -EBUSY;

