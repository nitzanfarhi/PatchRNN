commit 5941d079f2c3bdf0dffed1afb8941678fcd0bcb7
Author: Roland Dreier <rolandd@cisco.com>
Date:   Tue May 9 22:54:59 2006 -0700

    IPoIB: Free child interfaces properly
    
    When deleting a child interface with a non-default P_Key via
    /sys/class/net/ibX/delete_child, the interface must be freed with
    free_netdev() (rather than kfree() on the private data).
    
    Signed-off-by: Roland Dreier <rolandd@cisco.com>

diff --git a/drivers/infiniband/ulp/ipoib/ipoib_vlan.c b/drivers/infiniband/ulp/ipoib/ipoib_vlan.c
index 4ca175553f9f..f887780e8093 100644
--- a/drivers/infiniband/ulp/ipoib/ipoib_vlan.c
+++ b/drivers/infiniband/ulp/ipoib/ipoib_vlan.c
@@ -158,10 +158,8 @@ int ipoib_vlan_delete(struct net_device *pdev, unsigned short pkey)
 		if (priv->pkey == pkey) {
 			unregister_netdev(priv->dev);
 			ipoib_dev_cleanup(priv->dev);
-
 			list_del(&priv->list);
-
-			kfree(priv);
+			free_netdev(priv->dev);
 
 			ret = 0;
 			break;

