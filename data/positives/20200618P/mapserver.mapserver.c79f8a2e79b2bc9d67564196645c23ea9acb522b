commit c79f8a2e79b2bc9d67564196645c23ea9acb522b
Author: Thomas Bonfort <thomas.bonfort@gmail.com>
Date:   Tue Jul 3 18:39:19 2012 +0200

    avoid segfaults on empty shapes (#4092)

diff --git a/maputil.c b/maputil.c
index 23834967..38bfd346 100644
--- a/maputil.c
+++ b/maputil.c
@@ -449,7 +449,7 @@ int msEvalExpression(layerObj *layer, shapeObj *shape, expressionObj *expression
         msSetError(MS_MISCERR, "Cannot evaluate expression, no item index defined.", "msEvalExpression()");
         return MS_FALSE;
       }
-      if(itemindex >= layer->numitems) {
+      if(itemindex >= layer->numitems || itemindex >= shape->numvalues) {
         msSetError(MS_MISCERR, "Invalid item index.", "msEvalExpression()");
         return MS_FALSE;
       }
@@ -483,7 +483,7 @@ int msEvalExpression(layerObj *layer, shapeObj *shape, expressionObj *expression
         msSetError(MS_MISCERR, "Cannot evaluate expression, no item index defined.", "msEvalExpression()");
         return MS_FALSE;
       }
-      if(itemindex >= layer->numitems) {
+      if(itemindex >= layer->numitems || itemindex >= shape->numvalues) {
         msSetError(MS_MISCERR, "Invalid item index.", "msEvalExpression()");
         return MS_FALSE;
       }

