commit 074c3c2693e34037af9c551f40613019f5d42996
Author: Zoltan Varga <vargaz@gmail.com>
Date:   Tue Aug 8 16:35:54 2017 -0400

    [runtime] Fix a case where klass->blittable was written without holding the loader locked. (#5331)

diff --git a/mono/metadata/marshal.c b/mono/metadata/marshal.c
index 9403e54a149..1cca5a3c743 100644
--- a/mono/metadata/marshal.c
+++ b/mono/metadata/marshal.c
@@ -11590,7 +11590,6 @@ mono_marshal_load_type_info (MonoClass* klass)
 
 	layout = mono_class_get_flags (klass) & TYPE_ATTRIBUTE_LAYOUT_MASK;
 
-	/* The mempool is protected by the loader lock */
 	info = (MonoMarshalType *)mono_image_alloc0 (klass->image, MONO_SIZEOF_MARSHAL_TYPE + sizeof (MonoMarshalField) * count);
 	info->num_fields = count;
 	
@@ -11677,8 +11676,11 @@ mono_marshal_load_type_info (MonoClass* klass)
 	info->min_align = min_align;
 
 	/* Update the class's blittable info, if the layouts don't match */
-	if (info->native_size != mono_class_value_size (klass, NULL))
+	if (info->native_size != mono_class_value_size (klass, NULL)) {
+		mono_loader_lock ();
 		klass->blittable = FALSE;
+		mono_loader_unlock ();
+	}
 
 	/* If this is an array type, ensure that we have element info */
 	if (klass->rank && !mono_marshal_is_loading_type_info (klass->element_class)) {

