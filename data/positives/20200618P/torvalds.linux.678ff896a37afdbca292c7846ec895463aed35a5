commit 678ff896a37afdbca292c7846ec895463aed35a5
Author: KAMEZAWA Hiroyuki <kamezawa.hiroyu@jp.fujitsu.com>
Date:   Thu Feb 10 15:01:36 2011 -0800

    memcg: fix leak of accounting at failure path of hugepage collapsing
    
    mem_cgroup_uncharge_page() should be called in all failure cases after
    mem_cgroup_charge_newpage() is called in huge_memory.c::collapse_huge_page()
    
     [ 4209.076861] BUG: Bad page state in process khugepaged  pfn:1e9800
     [ 4209.077601] page:ffffea0006b14000 count:0 mapcount:0 mapping:          (null) index:0x2800
     [ 4209.078674] page flags: 0x40000000004000(head)
     [ 4209.079294] pc:ffff880214a30000 pc->flags:2146246697418756 pc->mem_cgroup:ffffc9000177a000
     [ 4209.082177] (/A)
     [ 4209.082500] Pid: 31, comm: khugepaged Not tainted 2.6.38-rc3-mm1 #1
     [ 4209.083412] Call Trace:
     [ 4209.083678]  [<ffffffff810f4454>] ? bad_page+0xe4/0x140
     [ 4209.084240]  [<ffffffff810f53e6>] ? free_pages_prepare+0xd6/0x120
     [ 4209.084837]  [<ffffffff8155621d>] ? rwsem_down_failed_common+0xbd/0x150
     [ 4209.085509]  [<ffffffff810f5462>] ? __free_pages_ok+0x32/0xe0
     [ 4209.086110]  [<ffffffff810f552b>] ? free_compound_page+0x1b/0x20
     [ 4209.086699]  [<ffffffff810fad6c>] ? __put_compound_page+0x1c/0x30
     [ 4209.087333]  [<ffffffff810fae1d>] ? put_compound_page+0x4d/0x200
     [ 4209.087935]  [<ffffffff810fb015>] ? put_page+0x45/0x50
     [ 4209.097361]  [<ffffffff8113f779>] ? khugepaged+0x9e9/0x1430
     [ 4209.098364]  [<ffffffff8107c870>] ? autoremove_wake_function+0x0/0x40
     [ 4209.099121]  [<ffffffff8113ed90>] ? khugepaged+0x0/0x1430
     [ 4209.099780]  [<ffffffff8107c236>] ? kthread+0x96/0xa0
     [ 4209.100452]  [<ffffffff8100dda4>] ? kernel_thread_helper+0x4/0x10
     [ 4209.101214]  [<ffffffff8107c1a0>] ? kthread+0x0/0xa0
     [ 4209.101842]  [<ffffffff8100dda0>] ? kernel_thread_helper+0x0/0x10
    
    Signed-off-by: KAMEZAWA Hiroyuki <kamezawa.hiroyu@jp.fujitsu.com>
    Acked-by: Daisuke Nishimura <nishimura@mxp.nes.nec.co.jp>
    Reviewed-by: Johannes Weiner <hannes@cmpxchg.org>
    Cc: Andrea Arcangeli <aarcange@redhat.com>
    Reviewed-by: Minchan Kim <minchan.kim@gmail.com>
    Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
    Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>

diff --git a/mm/huge_memory.c b/mm/huge_memory.c
index b6c1ce3c53b5..e62ddb8f24b6 100644
--- a/mm/huge_memory.c
+++ b/mm/huge_memory.c
@@ -1852,7 +1852,6 @@ static void collapse_huge_page(struct mm_struct *mm,
 		set_pmd_at(mm, address, pmd, _pmd);
 		spin_unlock(&mm->page_table_lock);
 		anon_vma_unlock(vma->anon_vma);
-		mem_cgroup_uncharge_page(new_page);
 		goto out;
 	}
 
@@ -1898,6 +1897,7 @@ static void collapse_huge_page(struct mm_struct *mm,
 	return;
 
 out:
+	mem_cgroup_uncharge_page(new_page);
 #ifdef CONFIG_NUMA
 	put_page(new_page);
 #endif

