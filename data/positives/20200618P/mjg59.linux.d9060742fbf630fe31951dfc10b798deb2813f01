commit d9060742fbf630fe31951dfc10b798deb2813f01
Author: Sasha Levin <sasha.levin@oracle.com>
Date:   Fri Mar 28 13:33:38 2014 -0700

    ocfs2: check if cluster name exists before deref
    
    Commit c74a3bdd9b52 ("ocfs2: add clustername to cluster connection") is
    trying to strlcpy a string which was explicitly passed as NULL in the
    very same patch, triggering a NULL ptr deref.
    
      BUG: unable to handle kernel NULL pointer dereference at           (null)
      IP: strlcpy (lib/string.c:388 lib/string.c:151)
      CPU: 19 PID: 19426 Comm: trinity-c19 Tainted: G        W     3.14.0-rc7-next-20140325-sasha-00014-g9476368-dirty #274
      RIP:  strlcpy (lib/string.c:388 lib/string.c:151)
      Call Trace:
       ocfs2_cluster_connect (fs/ocfs2/stackglue.c:350)
       ocfs2_cluster_connect_agnostic (fs/ocfs2/stackglue.c:396)
       user_dlm_register (fs/ocfs2/dlmfs/userdlm.c:679)
       dlmfs_mkdir (fs/ocfs2/dlmfs/dlmfs.c:503)
       vfs_mkdir (fs/namei.c:3467)
       SyS_mkdirat (fs/namei.c:3488 fs/namei.c:3472)
       tracesys (arch/x86/kernel/entry_64.S:749)
    
    akpm: this patch probably disables the feature.  A temporary thing to
    avoid triviel oopses.
    
    Signed-off-by: Sasha Levin <sasha.levin@oracle.com>
    Cc: Goldwyn Rodrigues <rgoldwyn@suse.com>
    Cc: Mark Fasheh <mfasheh@suse.de>
    Cc: Joel Becker <jlbec@evilplan.org>
    Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
    Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>

diff --git a/fs/ocfs2/stackglue.c b/fs/ocfs2/stackglue.c
index 1324e6600e57..ca5ce14cbddc 100644
--- a/fs/ocfs2/stackglue.c
+++ b/fs/ocfs2/stackglue.c
@@ -346,7 +346,9 @@ int ocfs2_cluster_connect(const char *stack_name,
 
 	strlcpy(new_conn->cc_name, group, GROUP_NAME_MAX + 1);
 	new_conn->cc_namelen = grouplen;
-	strlcpy(new_conn->cc_cluster_name, cluster_name, CLUSTER_NAME_MAX + 1);
+	if (cluster_name_len)
+		strlcpy(new_conn->cc_cluster_name, cluster_name,
+			CLUSTER_NAME_MAX + 1);
 	new_conn->cc_cluster_name_len = cluster_name_len;
 	new_conn->cc_recovery_handler = recovery_handler;
 	new_conn->cc_recovery_data = recovery_data;

