commit 41880dcdb64db5ed1c2c5cd229234f237369410a
Author: James Antill <james@and.org>
Date:   Wed May 21 14:09:07 2008 -0400

     Fix escaping strings that end in \
     Fix escaping of unprintable bytes

diff --git a/src/internal.c b/src/internal.c
index 588d3b40..761d2c5e 100644
--- a/src/internal.c
+++ b/src/internal.c
@@ -152,7 +152,7 @@ char *unescape(const char *s, int len) {
     char *result, *t;
     int i;
 
-    if (len > strlen(s))
+    if (len < 0 || len > strlen(s))
         len = strlen(s);
 
     size = 0;
@@ -182,7 +182,7 @@ char *escape(const char *text, int cnt) {
         cnt = strlen(text);
 
     for (int i=0; i < cnt; i++) {
-        if (strchr(escape_chars, text[i]) != NULL)
+        if (text[i] && (strchr(escape_chars, text[i]) != NULL))
             len += 2;  /* Escaped as '\x' */
         else if (! isprint(text[i]))
             len += 4;  /* Escaped as '\ooo' */
@@ -193,11 +193,12 @@ char *escape(const char *text, int cnt) {
     e = esc;
     for (int i=0; i < cnt; i++) {
         char *p;
-        if ((p = strchr(escape_chars, text[i])) != NULL) {
+        if (text[i] && ((p = strchr(escape_chars, text[i])) != NULL)) {
             *e++ = '\\';
             *e++ = escape_names[p - escape_chars];
         } else if (! isprint(text[i])) {
             sprintf(e, "\\%03o", text[i]);
+            e += 4;
         } else {
             *e++ = text[i];
         }

