commit 43560d525bbe874882f9091581ab8c661eba086d
Author: Tor Didriksen <tor.didriksen@oracle.com>
Date:   Tue Jan 28 14:33:07 2014 +0100

    Bug#18003651 VALGRIND: MEMORY LEAK AT THE TIME OF SERVER START UP
    
    Post-push fix of failing unit tests.

diff --git a/storage/perfschema/pfs_instr_class.cc b/storage/perfschema/pfs_instr_class.cc
index 735b2502f86..fe0510fec1d 100644
--- a/storage/perfschema/pfs_instr_class.cc
+++ b/storage/perfschema/pfs_instr_class.cc
@@ -701,6 +701,9 @@ static void configure_instr_class(PFS_instr_class *entry)
 {
   uint match_length= 0; /* length of matching pattern */
 
+  // May be NULL in unit tests
+  if (pfs_instr_config_array == NULL)
+    return;
   Pfs_instr_config_array::iterator it= pfs_instr_config_array->begin();
   for ( ; it != pfs_instr_config_array->end(); it++)
   {
diff --git a/storage/perfschema/pfs_server.cc b/storage/perfschema/pfs_server.cc
index 77616fa7951..fcf99cb5add 100644
--- a/storage/perfschema/pfs_server.cc
+++ b/storage/perfschema/pfs_server.cc
@@ -295,8 +295,10 @@ void init_pfs_instrument_array()
 */
 void cleanup_instrument_config()
 {
-  my_free_container_pointers(*pfs_instr_config_array);
+  if (pfs_instr_config_array != NULL)
+    my_free_container_pointers(*pfs_instr_config_array);
   delete pfs_instr_config_array;
+  pfs_instr_config_array= NULL;
 }
 
 /**

