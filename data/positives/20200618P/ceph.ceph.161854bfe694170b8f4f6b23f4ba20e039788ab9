commit 161854bfe694170b8f4f6b23f4ba20e039788ab9
Author: weiqiaomiao <wei.qiaomiao@zte.com.cn>
Date:   Sat Apr 23 02:19:59 2016 +0800

    rgw: fix memory leak in func 'RGWCreateBucket_ObjStore_S3::get_params' (#8670)
    
    Signed-off-by: weiqiaomiao <wei.qiaomiao@zte.com.cn>
    Reviewed-by: Casey Bodley <cbodley@redhat.com>

diff --git a/src/rgw/rgw_rest_s3.cc b/src/rgw/rgw_rest_s3.cc
index 2ef10a5ed7..04ee28f017 100644
--- a/src/rgw/rgw_rest_s3.cc
+++ b/src/rgw/rgw_rest_s3.cc
@@ -923,6 +923,8 @@ int RGWCreateBucket_ObjStore_S3::get_params()
   op_ret = rgw_rest_read_all_input(s, &data, &len, CREATE_BUCKET_MAX_REQ_LEN);
   if ((op_ret < 0) && (op_ret != -ERR_LENGTH_REQUIRED))
     return op_ret;
+  
+  auto data_deleter = std::unique_ptr<char, decltype(free)*>{data, free};
 
   if (s->aws4_auth_needs_complete) {
     int ret_auth = do_aws4_auth_completion();
@@ -947,10 +949,8 @@ int RGWCreateBucket_ObjStore_S3::get_params()
 
     if (!success) {
       ldout(s->cct, 0) << "failed to parse input: " << data << dendl;
-      free(data);
       return -EINVAL;
     }
-    free(data);
 
     if (!parser.get_location_constraint(location_constraint)) {
       ldout(s->cct, 0) << "provided input did not specify location constraint correctly" << dendl;

