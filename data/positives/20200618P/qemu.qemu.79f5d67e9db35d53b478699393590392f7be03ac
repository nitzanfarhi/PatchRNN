commit 79f5d67e9db35d53b478699393590392f7be03ac
Author: walimis <walimisdev@gmail.com>
Date:   Tue Dec 11 11:30:37 2012 +0000

    xilinx_zynq: Add one variable to avoid overwriting QSPI bus
    
    commit 7b482bcf xilinx_zynq: added QSPI controller
    
    Adds one QSPI controller, which has two spi buses, one is for
    spi0, and another is for spi1. But when initializing the spi1
    bus, "dev" has been overwrited by the ssi_create_slave_no_init() function,
    so that qdev_get_child_bus() returns NULL and the last two m25p80 flashes
    won't be attached to the spi1 bus, but to main-system-bus.
    
    Here we add one variable to avoid overwriting.
    
    Signed-off-by: Liming Wang <walimisdev@gmail.com>
    Reviewed-by: Peter Crosthwaite <peter.crosthwaite@xilinx.com>
    Signed-off-by: Peter Maydell <peter.maydell@linaro.org>

diff --git a/hw/xilinx_zynq.c b/hw/xilinx_zynq.c
index 1f12a3d1ad..49233d8e2e 100644
--- a/hw/xilinx_zynq.c
+++ b/hw/xilinx_zynq.c
@@ -57,6 +57,7 @@ static inline void zynq_init_spi_flashes(uint32_t base_addr, qemu_irq irq,
     DeviceState *dev;
     SysBusDevice *busdev;
     SSIBus *spi;
+    DeviceState *flash_dev;
     int i, j;
     int num_busses =  is_qspi ? NUM_QSPI_BUSSES : 1;
     int num_ss = is_qspi ? NUM_QSPI_FLASHES : NUM_SPI_FLASHES;
@@ -81,11 +82,11 @@ static inline void zynq_init_spi_flashes(uint32_t base_addr, qemu_irq irq,
         spi = (SSIBus *)qdev_get_child_bus(dev, bus_name);
 
         for (j = 0; j < num_ss; ++j) {
-            dev = ssi_create_slave_no_init(spi, "m25p80");
-            qdev_prop_set_string(dev, "partname", "n25q128");
-            qdev_init_nofail(dev);
+            flash_dev = ssi_create_slave_no_init(spi, "m25p80");
+            qdev_prop_set_string(flash_dev, "partname", "n25q128");
+            qdev_init_nofail(flash_dev);
 
-            cs_line = qdev_get_gpio_in(dev, 0);
+            cs_line = qdev_get_gpio_in(flash_dev, 0);
             sysbus_connect_irq(busdev, i * num_ss + j + 1, cs_line);
         }
     }

