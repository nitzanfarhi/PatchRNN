commit 719fc28c80a22ab9f1533d775bae09c14442bbbe
Author: Jeff Cody <jcody@redhat.com>
Date:   Wed Jun 7 09:55:22 2017 -0400

    block: fix external snapshot abort permission error
    
    In external_snapshot_abort(), we try to undo what was done in
    external_snapshot_prepare() calling bdrv_replace_node() to swap the
    nodes back.  However, we receive a permissions error as writers are
    blocked on the old node, which is now the new node backing file.
    
    An easy fix (initially suggested by Kevin Wolf) is to call
    bdrv_set_backing_hd() on the new node, to set the backing node to NULL.
    
    Signed-off-by: Jeff Cody <jcody@redhat.com>
    Reviewed-by: Eric Blake <eblake@redhat.com>
    Signed-off-by: Kevin Wolf <kwolf@redhat.com>

diff --git a/blockdev.c b/blockdev.c
index 892d768574..6472548186 100644
--- a/blockdev.c
+++ b/blockdev.c
@@ -1803,7 +1803,11 @@ static void external_snapshot_abort(BlkActionState *common)
                              DO_UPCAST(ExternalSnapshotState, common, common);
     if (state->new_bs) {
         if (state->overlay_appended) {
+            bdrv_ref(state->old_bs);   /* we can't let bdrv_set_backind_hd()
+                                          close state->old_bs; we need it */
+            bdrv_set_backing_hd(state->new_bs, NULL, &error_abort);
             bdrv_replace_node(state->new_bs, state->old_bs, &error_abort);
+            bdrv_unref(state->old_bs); /* bdrv_replace_node() ref'ed old_bs */
         }
     }
 }

