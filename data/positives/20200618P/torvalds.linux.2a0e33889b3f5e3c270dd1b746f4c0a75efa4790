commit 2a0e33889b3f5e3c270dd1b746f4c0a75efa4790
Author: Namhyung Kim <namhyung@gmail.com>
Date:   Wed Oct 13 17:17:18 2010 +0900

    jbd: Check return value of __getblk()
    
    Fail journal creation if __getblk() returns NULL.  unlikely() is
    added because it is called in a loop and we've been OK without
    the check until now.
    
    Signed-off-by: Namhyung Kim <namhyung@gmail.com>
    Signed-off-by: Jan Kara <jack@suse.cz>

diff --git a/fs/jbd/journal.c b/fs/jbd/journal.c
index e56117651826..ac1840415a65 100644
--- a/fs/jbd/journal.c
+++ b/fs/jbd/journal.c
@@ -952,6 +952,8 @@ int journal_create(journal_t *journal)
 		if (err)
 			return err;
 		bh = __getblk(journal->j_dev, blocknr, journal->j_blocksize);
+		if (unlikely(!bh))
+			return -ENOMEM;
 		lock_buffer(bh);
 		memset (bh->b_data, 0, journal->j_blocksize);
 		BUFFER_TRACE(bh, "marking dirty");

