commit a7e118d73aeaa5eae12c92f2541127276efb7e01
Author: Marc Alff <marc.alff@oracle.com>
Date:   Mon Jun 22 10:45:26 2015 +0200

    Bug#21145277 VALGRIND ERRORS IN RQG_MDL_STRESS_VALGRIND AND
    RQG_MDL_DEADLOCK_VALGRIND
    
    Valgrind reports errors while executing PFS_status_stats::aggregate_from(),
    when under load, for an event scheduler thread.
    
    The code should not even take this path,
    as the event scheduler does not have THD associated with PFS_thread.
    
    The root cause is in creat_thread(),
    which does not properly initialize the PFS_instr::m_thd attribute.
    
    As a result, a previous THD object from a previous thread,
    which has been now freed, is used in the code,
    leading to reads of free, invalid memory, and potentially to a crash.
    
    The fix is to initialize PFS_instr::m_thd properly.

diff --git a/storage/perfschema/pfs_instr.cc b/storage/perfschema/pfs_instr.cc
index 9b781b315d5..13429d53bc2 100644
--- a/storage/perfschema/pfs_instr.cc
+++ b/storage/perfschema/pfs_instr.cc
@@ -560,6 +560,7 @@ PFS_thread* create_thread(PFS_thread_class *klass, const void *identity,
     pfs->m_processlist_info_length= 0;
     pfs->m_connection_type= NO_VIO_TYPE;
 
+    pfs->m_thd= NULL;
     pfs->m_host= NULL;
     pfs->m_user= NULL;
     pfs->m_account= NULL;

