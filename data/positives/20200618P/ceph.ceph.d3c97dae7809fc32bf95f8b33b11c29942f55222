commit d3c97dae7809fc32bf95f8b33b11c29942f55222
Author: Sage Weil <sage@inktank.com>
Date:   Thu Jul 5 18:08:58 2012 -0700

    librados: take lock when signaling notify cond
    
    When we are signaling the cond to indicate that a notify is complete,
    take the appropriate lock.  This removes the possibility of a race
    that loses our signal.  (That would be very difficult given that there
    are network round trips involved, but this makes the lock/cond usage
    "correct.")
    
    Signed-off-by: Sage Weil <sage@inktank.com>

diff --git a/src/librados/IoCtxImpl.cc b/src/librados/IoCtxImpl.cc
index 0fd7575ca3..cb30aa8bf0 100644
--- a/src/librados/IoCtxImpl.cc
+++ b/src/librados/IoCtxImpl.cc
@@ -1600,8 +1600,10 @@ void librados::IoCtxImpl::C_NotifyComplete::notify(uint8_t opcode,
 						   uint64_t ver,
 						   bufferlist& bl)
 {
+  lock->Lock();
   *done = true;
   cond->Signal();
+  lock->Unlock();
 }
 
 /////////////////////////// WatchContext ///////////////////////////////

