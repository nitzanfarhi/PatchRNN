commit f106e82caaa0d943e47cacc184f5b40d538e0044
Author: Li Zefan <lizf@cn.fujitsu.com>
Date:   Tue Dec 7 01:51:26 2010 +0000

    Btrfs: Fix a crash when mounting a subvolume
    
    We should drop dentry before deactivating the superblock, otherwise
    we can hit this bug:
    
    BUG: Dentry f349a690{i=100,n=/} still in use (1) [unmount of btrfs loop1]
    ...
    
    Steps to reproduce the bug:
    
      # mount /dev/loop1 /mnt
      # mkdir save
      # btrfs subvolume snapshot /mnt save/snap1
      # umount /mnt
      # mount -o subvol=save/snap1 /dev/loop1 /mnt
      (crash)
    
    Reported-by: Michael Niederle <mniederle@gmx.at>
    Signed-off-by: Li Zefan <lizf@cn.fujitsu.com>
    Signed-off-by: Chris Mason <chris.mason@oracle.com>

diff --git a/fs/btrfs/super.c b/fs/btrfs/super.c
index 47bf67cbe6bf..61bd79abb805 100644
--- a/fs/btrfs/super.c
+++ b/fs/btrfs/super.c
@@ -685,9 +685,9 @@ static int btrfs_get_sb(struct file_system_type *fs_type, int flags,
 		mutex_unlock(&root->d_inode->i_mutex);
 
 		if (IS_ERR(new_root)) {
+			dput(root);
 			deactivate_locked_super(s);
 			error = PTR_ERR(new_root);
-			dput(root);
 			goto error_free_subvol_name;
 		}
 		if (!new_root->d_inode) {

