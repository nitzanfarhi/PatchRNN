commit 97846eaedc4c2a12f329dba30dacdfb0b4fa7ec5
Author: Aki Tuomi <aki.tuomi@dovecot.fi>
Date:   Mon Jun 27 13:19:35 2016 +0300

    istream-decrypt: Correctly check the header length for v1

diff --git a/src/lib-dcrypt/istream-decrypt.c b/src/lib-dcrypt/istream-decrypt.c
index 87b954dd7..4ca35880b 100644
--- a/src/lib-dcrypt/istream-decrypt.c
+++ b/src/lib-dcrypt/istream-decrypt.c
@@ -70,7 +70,8 @@ ssize_t i_stream_decrypt_read_header_v1(struct decrypt_istream *stream,
 	buffer_t *key = buffer_create_dynamic(pool_datastack_create(), 256);
 
 	hdr_len = ((data[0] << 8) | data[1]) + 12;
-	if (mlen < hdr_len) {
+
+	if (mlen < hdr_len - pos) {
 		/* try to read more */
 		return 0;
 	}

