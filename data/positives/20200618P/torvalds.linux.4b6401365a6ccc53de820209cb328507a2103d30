commit 4b6401365a6ccc53de820209cb328507a2103d30
Author: Matt Redfearn <matt.redfearn@imgtec.com>
Date:   Wed Sep 7 10:45:19 2016 +0100

    MIPS: SMP: Wrap call to mips_cpc_lock_other in mips_cm_lock_other
    
    All calls to mips_cpc_lock_other should be wrapped in
    mips_cm_lock_other. This only matters if the system has CM3 and is using
    cpu idle, since otherwise a) the CPC lock is sufficent for CM < 3 and b)
    any systems with CM > 3 have not been able to use cpu idle until now.
    
    Signed-off-by: Matt Redfearn <matt.redfearn@imgtec.com>
    Reviewed-by: Paul Burton <paul.burton@imgtec.com>
    Cc: linux-mips@linux-mips.org
    Cc: linux-kernel@vger.kernel.org
    Cc: Thomas Gleixner <tglx@linutronix.de>
    Cc: James Hogan <james.hogan@imgtec.com>
    Cc: Qais Yousef <qsyousef@gmail.com>
    Patchwork: https://patchwork.linux-mips.org/patch/14227/
    Signed-off-by: Ralf Baechle <ralf@linux-mips.org>

diff --git a/arch/mips/kernel/smp.c b/arch/mips/kernel/smp.c
index b0baf48951fa..cb02df215365 100644
--- a/arch/mips/kernel/smp.c
+++ b/arch/mips/kernel/smp.c
@@ -192,9 +192,11 @@ void mips_smp_send_ipi_mask(const struct cpumask *mask, unsigned int action)
 				continue;
 
 			while (!cpumask_test_cpu(cpu, &cpu_coherent_mask)) {
+				mips_cm_lock_other(core, 0);
 				mips_cpc_lock_other(core);
 				write_cpc_co_cmd(CPC_Cx_CMD_PWRUP);
 				mips_cpc_unlock_other();
+				mips_cm_unlock_other();
 			}
 		}
 	}

