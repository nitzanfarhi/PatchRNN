commit 96b09e024fedf0a6604c8c688a3994d5ed991434
Author: Andy Adamson <andros@netapp.com>
Date:   Wed Apr 1 09:22:33 2009 -0400

    nfs41: use session attributes for rsize and wsize
    
    Set the mount points rsize and wsize to the negotiated session fore channel
    maximum response and requeset size. These values will be bound checked in
    nfs_server_set_fsinfo.
    
    Signed-off-by: Andy Adamson <andros@netapp.com>
    Signed-off-by: Benny Halevy <bhalevy@panasas.com>
    [move nfs4_session_set_rwsize into CONFIG_NFS_V4]
    Signed-off-by: Trond Myklebust <Trond.Myklebust@netapp.com>

diff --git a/fs/nfs/client.c b/fs/nfs/client.c
index a9828baaa445..bb7432d83b5a 100644
--- a/fs/nfs/client.c
+++ b/fs/nfs/client.c
@@ -1206,6 +1206,21 @@ static void nfs4_init_session(struct nfs_client *clp,
 #endif /* CONFIG_NFS_V4_1 */
 }
 
+/*
+ * Session has been established, and the client marked ready.
+ * Set the mount rsize and wsize with negotiated fore channel
+ * attributes which will be bound checked in nfs_server_set_fsinfo.
+ */
+static void nfs4_session_set_rwsize(struct nfs_server *server)
+{
+#ifdef CONFIG_NFS_V4_1
+	if (!nfs4_has_session(server->nfs_client))
+		return;
+	server->rsize = server->nfs_client->cl_session->fc_attrs.max_resp_sz;
+	server->wsize = server->nfs_client->cl_session->fc_attrs.max_rqst_sz;
+#endif /* CONFIG_NFS_V4_1 */
+}
+
 /*
  * Create a version 4 volume record
  */
@@ -1296,6 +1311,8 @@ struct nfs_server *nfs4_create_server(const struct nfs_parsed_mount_data *data,
 		(unsigned long long) server->fsid.minor);
 	dprintk("Mount FH: %d\n", mntfh->size);
 
+	nfs4_session_set_rwsize(server);
+
 	error = nfs_probe_fsinfo(server, mntfh, &fattr);
 	if (error < 0)
 		goto error;

