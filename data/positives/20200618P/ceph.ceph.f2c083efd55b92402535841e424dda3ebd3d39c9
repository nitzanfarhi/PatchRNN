commit f2c083efd55b92402535841e424dda3ebd3d39c9
Author: Samuel Just <sam.just@inktank.com>
Date:   Thu Dec 13 10:50:52 2012 -0800

    OSD: disconnect_session_watches obc might not be valid after we relock
    
    If disconnect_session_watches races with watch removal, the session
    might no longer have a valid obc ref.  In that case, move on to
    the next obc.
    
    Note, there is no danger of any obcs being *added* to the session
    since the session/connection at this point is dead.
    
    Signed-off-by: Samuel Just <sam.just@inktank.com>

diff --git a/src/osd/OSD.cc b/src/osd/OSD.cc
index ea96c327ba..2dedaf4049 100644
--- a/src/osd/OSD.cc
+++ b/src/osd/OSD.cc
@@ -2438,6 +2438,14 @@ void OSD::disconnect_session_watches(Session *session)
       continue; 
     }
     service.watch_lock.Lock();
+
+    if (!session->watches.count((void*)obc)) {
+      // Raced with watch removal, obc is invalid
+      service.watch_lock.Unlock();
+      pg->unlock();
+      continue;
+    }
+
     /* NOTE! fix this one, should be able to just lookup entity name,
        however, we currently only keep EntityName on the session and not
        entity_name_t. */

