commit d56134d6cf293c0963d9ebc652efcd56d2877769
Author: mikeb <mikeb@openbsd.org>
Date:   Tue Sep 26 22:12:04 2017 +0000

    Prevent null pointer dereference when probing channels
    
    Account for the case when wdc is attached to the ISA bus and performs
    channel probing using a dummy structure that lacks the back pointer to
    the controller's softc.
    
    Bug reported and fix tested by Andrew Daugherity, thanks!
    OK phessler, jsg, krw, deraadt

diff --git a/sys/dev/ic/wdc.c b/sys/dev/ic/wdc.c
index 55871544eba..3584b559e8f 100644
--- a/sys/dev/ic/wdc.c
+++ b/sys/dev/ic/wdc.c
@@ -1,4 +1,4 @@
-/*	$OpenBSD: wdc.c,v 1.132 2017/07/12 13:40:59 mikeb Exp $	*/
+/*	$OpenBSD: wdc.c,v 1.133 2017/09/26 22:12:04 mikeb Exp $	*/
 /*	$NetBSD: wdc.c,v 1.68 1999/06/23 19:00:17 bouyer Exp $	*/
 /*
  * Copyright (c) 1998, 2001 Manuel Bouyer.  All rights reserved.
@@ -646,7 +646,7 @@ wdcprobe(struct channel_softc *chp)
 	if (ret_value == 0)
 		return 0;
 
-	if (chp->wdc->quirks & WDC_QUIRK_NOATAPI)
+	if (chp->wdc && (chp->wdc->quirks & WDC_QUIRK_NOATAPI))
 		goto noatapi;
 
 	/*
@@ -680,7 +680,7 @@ wdcprobe(struct channel_softc *chp)
 	}
 
 noatapi:
-	if (chp->wdc->quirks & WDC_QUIRK_NOATA)
+	if (chp->wdc && (chp->wdc->quirks & WDC_QUIRK_NOATA))
 		goto noata;
 
 	/*

