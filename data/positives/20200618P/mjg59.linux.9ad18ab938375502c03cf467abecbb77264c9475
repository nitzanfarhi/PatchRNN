commit 9ad18ab938375502c03cf467abecbb77264c9475
Author: Tejun Heo <tj@kernel.org>
Date:   Tue Sep 29 12:47:50 2015 -0400

    writeback: laptop_mode_timer_fn() needs rcu_read_lock() around bdi_writeback iteration
    
    laptop_mode_timer_fn() was using bdi_for_each_wb() without the
    required RCU locking leading to the following warning.
    
     WARNING: CPU: 0 PID: 0 at include/linux/backing-dev.h:415 laptop_mode_timer_fn+0x106/0x170()
     ...
     Call Trace:
      <IRQ>  [<ffffffff81480cdc>] dump_stack+0x4e/0x82
      [<ffffffff81051912>] warn_slowpath_common+0x82/0xc0
      [<ffffffff81051a0a>] warn_slowpath_null+0x1a/0x20
      [<ffffffff8115f0e6>] laptop_mode_timer_fn+0x106/0x170
      [<ffffffff810ca8e3>] call_timer_fn+0xb3/0x2f0
      [<ffffffff810cad25>] run_timer_softirq+0x205/0x370
      [<ffffffff81056854>] __do_softirq+0xd4/0x460
      [<ffffffff81056d69>] irq_exit+0x89/0xa0
      [<ffffffff8185a892>] smp_apic_timer_interrupt+0x42/0x50
      [<ffffffff81858a44>] apic_timer_interrupt+0x84/0x90
     ...
    
    Fix it by adding rcu_read_lock() around the iteration.
    
    Signed-off-by: Tejun Heo <tj@kernel.org>
    Fixes: a06fd6b10228 ("writeback: make laptop_mode_timer_fn() handle multiple bdi_writeback's")
    Reviewed-by: Jan Kara <jack@suse.com>
    Signed-off-by: Jens Axboe <axboe@fb.com>

diff --git a/mm/page-writeback.c b/mm/page-writeback.c
index 0a931cdd4f6b..902e5f215e57 100644
--- a/mm/page-writeback.c
+++ b/mm/page-writeback.c
@@ -1965,10 +1965,12 @@ void laptop_mode_timer_fn(unsigned long data)
 	if (!bdi_has_dirty_io(&q->backing_dev_info))
 		return;
 
+	rcu_read_lock();
 	bdi_for_each_wb(wb, &q->backing_dev_info, &iter, 0)
 		if (wb_has_dirty_io(wb))
 			wb_start_writeback(wb, nr_pages, true,
 					   WB_REASON_LAPTOP_TIMER);
+	rcu_read_unlock();
 }
 
 /*

