commit efaf782ccc388d6c23abf47a57300cd68b8483e9
Author: javer <javer@argentum.ua>
Date:   Thu Jan 2 18:40:07 2014 -0800

    Fix memory leak in pdo_parse_params
    
    Fixed memory leak after executing PDOStatement::execute() with bound parameters. Also removed unnecessary copying of result query string.
    
    Test case (I don't know whether it can be tested with Travis because it requires MySQL connection):
    
    <?php
    $pdo = new PDO('mysql:dbname=test;host=localhost', 'root', '');
    $data = str_repeat('a', 1000000);
    
    for ($n = 0; $n < 50; $n++) {
        $stmt = $pdo->prepare('SELECT :data = 1');
        $stmt->bindValue(':data', $data);
        $stmt->execute();
        $stmt = null;
        echo sprintf("%dM\n", memory_get_usage(true) / 1048576);
    }
    
    Closes #1459
    
    Reviewed By: @ptarjan
    
    Differential Revision: D1113187
    
    Pulled By: @scannell

diff --git a/hphp/runtime/ext/ext_pdo.cpp b/hphp/runtime/ext/ext_pdo.cpp
index e4b818d7e2..7bbb5a437e 100644
--- a/hphp/runtime/ext/ext_pdo.cpp
+++ b/hphp/runtime/ext/ext_pdo.cpp
@@ -2548,7 +2548,7 @@ rewrite:
       newbuffer += t;
     }
     *newbuffer = '\0';
-    out = out.substr(0, newbuffer - out.data());
+    out.setSize(newbuffer - out.data());
 
     ret = 1;
     goto clean_up;
@@ -2609,6 +2609,7 @@ clean_up:
   while (placeholders) {
     plc = placeholders;
     placeholders = plc->next;
+    plc->quoted.reset();
     free(plc);
   }
 

