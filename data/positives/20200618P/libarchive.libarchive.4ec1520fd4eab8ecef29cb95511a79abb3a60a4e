commit 4ec1520fd4eab8ecef29cb95511a79abb3a60a4e
Author: Michihiro NAKAJIMA <ggcueroad@gmail.com>
Date:   Mon Mar 21 16:21:39 2011 -0400

    Properly return an error code; do not overwirte an error code with a return code
    of __archive_write_close_filter();
    
    Found with Clang Static Analyzer.
    
    SVN-Revision: 3045

diff --git a/libarchive/archive_write_add_filter_compress.c b/libarchive/archive_write_add_filter_compress.c
index f8e6258e..d42ec6ca 100644
--- a/libarchive/archive_write_add_filter_compress.c
+++ b/libarchive/archive_write_add_filter_compress.c
@@ -416,7 +416,7 @@ static int
 archive_compressor_compress_close(struct archive_write_filter *f)
 {
 	struct private_data *state = (struct private_data *)f->data;
-	int ret;
+	int ret, ret2;
 
 	ret = output_code(f, state->cur_code);
 	if (ret != ARCHIVE_OK)
@@ -429,7 +429,9 @@ archive_compressor_compress_close(struct archive_write_filter *f)
 	ret = __archive_write_filter(f->next_filter,
 	    state->compressed, state->compressed_offset);
 cleanup:
-	ret = __archive_write_close_filter(f->next_filter);
+	ret2 = __archive_write_close_filter(f->next_filter);
+	if (ret > ret2)
+		ret = ret2;
 	free(state->compressed);
 	free(state);
 	return (ret);

