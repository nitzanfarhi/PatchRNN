commit a63102226e28122373c35bb8921a6656260b7e1e
Author: Marko Mäkelä <marko.makela@mariadb.com>
Date:   Tue Oct 17 10:58:46 2017 +0300

    MDEV-14082 Enforcing innodb_open_files leads to fil_system->mutex problem
    
    fil_mutex_enter_and_prepare_for_io(): Reacquire fil_system->mutex after
    failing to close a file and before retrying.

diff --git a/storage/innobase/fil/fil0fil.cc b/storage/innobase/fil/fil0fil.cc
index f90238ffafb..73132754fdf 100644
--- a/storage/innobase/fil/fil0fil.cc
+++ b/storage/innobase/fil/fil0fil.cc
@@ -1218,6 +1218,7 @@ fil_mutex_enter_and_prepare_for_io(
 					fil_flush_file_spaces(FIL_TYPE_TABLESPACE);
 
 					count++;
+					mutex_enter(&fil_system->mutex);
 					continue;
 				}
 			}

