commit 2b59b7edd3b9f937ecd00704f45c7bc7c99fc676
Author: Baodong Chen <chenbdchenbd@gmail.com>
Date:   Fri Jan 5 16:07:15 2018 +0800

    avoid infinite loop when user want send more bufers count than ours in on_msg_callback()

diff --git a/lib/websocket.c b/lib/websocket.c
index 76b47150..93c62d2c 100644
--- a/lib/websocket.c
+++ b/lib/websocket.c
@@ -224,7 +224,10 @@ void h2o_websocket_proceed(h2o_websocket_conn_t *conn)
             if (wslay_event_send(conn->ws_ctx) != 0) {
                 goto Close;
             }
-            handled = 1;
+            /* avoid infinite loop when user want send more bufers count than ours in on_msg_callback() */
+            if (conn->_write_buf.cnt < sizeof(conn->_write_buf.bufs) / sizeof(conn->_write_buf.bufs[0])) {
+                handled = 1;
+            }
         }
         if (conn->sock->input->size != 0 && wslay_event_want_read(conn->ws_ctx)) {
             if (wslay_event_recv(conn->ws_ctx) != 0) {

