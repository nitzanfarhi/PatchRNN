commit 42a77e858b950878cf67fa74ab95620f1de596b4
Author: marko <Unknown>
Date:   Tue Aug 22 07:20:52 2006 +0000

    Merge a patch from MySQL AB (Mats Kindal):
    
    Lock and unlock prepare_commit_mutex under the same conditions.

diff --git a/handler/ha_innodb.cc b/handler/ha_innodb.cc
index 6b19ea228e5..ec79ddfef99 100644
--- a/handler/ha_innodb.cc
+++ b/handler/ha_innodb.cc
@@ -7396,7 +7396,9 @@ innobase_xa_prepare(
 	int error = 0;
 	trx_t* trx = check_trx_exists(thd);
 
-	if (thd->lex->sql_command != SQLCOM_XA_PREPARE) {
+	if (thd->lex->sql_command != SQLCOM_XA_PREPARE &&
+	    (all || !(thd->options & (OPTION_NOT_AUTOCOMMIT | OPTION_BEGIN))))
+	{
 
 		/* For ibbackup to work the order of transactions in binlog
 		and InnoDB must be the same. Consider the situation

