commit b1e3899d5003b35c3e89f793261dd89141808bb5
Author: miod <miod@openbsd.org>
Date:   Mon Jan 16 20:34:09 2012 +0000

    Fix a memory leak in pkcs11_rsa_private_encrypt(), reported by Jan Klemkow.
    While there, be sure to buffer_clear() between send_msg() and recv_msg().
    ok markus@

diff --git a/usr.bin/ssh/ssh-pkcs11-client.c b/usr.bin/ssh/ssh-pkcs11-client.c
index 72ebbf31e66..d37ea48a887 100644
--- a/usr.bin/ssh/ssh-pkcs11-client.c
+++ b/usr.bin/ssh/ssh-pkcs11-client.c
@@ -1,4 +1,4 @@
-/* $OpenBSD: ssh-pkcs11-client.c,v 1.2 2010/02/24 06:12:53 djm Exp $ */
+/* $OpenBSD: ssh-pkcs11-client.c,v 1.3 2012/01/16 20:34:09 miod Exp $ */
 /*
  * Copyright (c) 2010 Markus Friedl.  All rights reserved.
  *
@@ -117,6 +117,7 @@ pkcs11_rsa_private_encrypt(int flen, const u_char *from, u_char *to, RSA *rsa,
 	buffer_put_int(&msg, 0);
 	xfree(blob);
 	send_msg(&msg);
+	buffer_clear(&msg);
 
 	if (recv_msg(&msg) == SSH2_AGENT_SIGN_RESPONSE) {
 		signature = buffer_get_string(&msg, &slen);
@@ -126,6 +127,7 @@ pkcs11_rsa_private_encrypt(int flen, const u_char *from, u_char *to, RSA *rsa,
 		}
 		xfree(signature);
 	}
+	buffer_free(&msg);
 	return (ret);
 }
 

