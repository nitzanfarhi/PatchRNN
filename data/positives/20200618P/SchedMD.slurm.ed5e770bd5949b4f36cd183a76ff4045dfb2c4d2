commit ed5e770bd5949b4f36cd183a76ff4045dfb2c4d2
Author: Moe Jette <jette1@llnl.gov>
Date:   Wed Mar 26 19:49:34 2008 +0000

    change the pthread locking to eliminate a race condition
    that appears in AIX

diff --git a/src/api/step_launch.c b/src/api/step_launch.c
index 81204a7fcc..86e9995743 100644
--- a/src/api/step_launch.c
+++ b/src/api/step_launch.c
@@ -425,7 +425,9 @@ void slurm_step_launch_wait_finish(slurm_step_ctx_t *ctx)
 
 	/* Then shutdown the message handler thread */
 	eio_signal_shutdown(sls->msg_handle);
+	pthread_mutex_unlock(&sls->lock);
 	pthread_join(sls->msg_thread, NULL);
+	pthread_mutex_lock(&sls->lock);
 	eio_handle_destroy(sls->msg_handle);
 
 	/* Then wait for the IO thread to finish */
@@ -435,7 +437,6 @@ void slurm_step_launch_wait_finish(slurm_step_ctx_t *ctx)
 	}
 
 	mpi_hook_client_fini(sls->mpi_state);
-
 	pthread_mutex_unlock(&sls->lock);
 }
 

