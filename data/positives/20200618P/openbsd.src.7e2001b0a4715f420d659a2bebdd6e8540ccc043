commit 7e2001b0a4715f420d659a2bebdd6e8540ccc043
Author: krw <krw@openbsd.org>
Date:   Thu Jun 3 11:37:45 2010 +0000

    Always initialize the ccb provided by the scsi layer into the proper
    state when starting an i/o. Necessary as the scsi layer may now
    re-submit a completed xs/ccb to the adapter in some error situations.
    
    Fixes panics seen by various people, reproduced and fix tested by
    sobrado@.
    
    ok dlg@

diff --git a/sys/dev/ic/siop.c b/sys/dev/ic/siop.c
index 003ba4ad743..89185a69dbf 100644
--- a/sys/dev/ic/siop.c
+++ b/sys/dev/ic/siop.c
@@ -1,4 +1,4 @@
-/*	$OpenBSD: siop.c,v 1.58 2010/04/06 01:12:17 dlg Exp $ */
+/*	$OpenBSD: siop.c,v 1.59 2010/06/03 11:37:45 krw Exp $ */
 /*	$NetBSD: siop.c,v 1.79 2005/11/18 23:10:32 bouyer Exp $	*/
 
 /*
@@ -1467,6 +1467,12 @@ siop_scsicmd(xs)
 
 	siop_cmd = xs->io;
 
+	/*
+	 * The xs may have been restarted by the scsi layer, so ensure the ccb
+	 * starts in the proper state.
+	 */
+	siop_cmd->cmd_c.status = CMDST_READY;
+
 	/* Always reset xs->stimeout, lest we timeout_del() with trash */
 	timeout_set(&xs->stimeout, siop_timeout, siop_cmd);
 

