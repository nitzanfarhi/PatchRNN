commit 62313f4841da9303582969adf89160e233b01ab4
Author: Alan T. DeKok <aland@freeradius.org>
Date:   Wed Oct 19 17:26:36 2011 +0200

    Catch case where User-Name may be > 250 octets

diff --git a/src/modules/rlm_eap/types/rlm_eap_peap/peap.c b/src/modules/rlm_eap/types/rlm_eap_peap/peap.c
index 0d9a03105..21b7e7bcd 100644
--- a/src/modules/rlm_eap/types/rlm_eap_peap/peap.c
+++ b/src/modules/rlm_eap/types/rlm_eap_peap/peap.c
@@ -938,7 +938,9 @@ int eappeap_process(EAP_HANDLER *handler, tls_session_t *tls_session)
 		vp->vp_octets[3] = len & 0xff;
 		vp->vp_octets[4] = PW_EAP_IDENTITY;
 
-		memcpy(vp->vp_octets + EAP_HEADER_LEN + 1, t->username->vp_strvalue, t->username->length);
+		if (len > sizeof(vp->vp_octets)) len = sizeof(vp->vp_octets);
+		memcpy(vp->vp_octets + EAP_HEADER_LEN + 1,
+		       t->username->vp_strvalue, len - EAP_HEADER_LEN - 1);
 		vp->length = len;
 
 		pairadd(&fake->packet->vps, vp);

