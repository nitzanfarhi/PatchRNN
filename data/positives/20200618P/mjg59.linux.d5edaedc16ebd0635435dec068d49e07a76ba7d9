commit d5edaedc16ebd0635435dec068d49e07a76ba7d9
Author: Johannes Berg <johannes@sipsolutions.net>
Date:   Wed Apr 22 23:02:51 2009 +0200

    mac80211: fix PS vs. scan race
    
    When somebody changes the PS parameters while scanning
    is in progress, we enable PS -- during the scan. This
    is clearly not desirable, and we can just abort enabling
    PS when scanning since when the scan finishes it will
    be taken care of.
    
    Signed-off-by: Johannes Berg <johannes@sipsolutions.net>
    Reviewed-by: Kalle Valo <kalle.valo@iki.fi>
    Signed-off-by: John W. Linville <linville@tuxdriver.com>

diff --git a/net/mac80211/mlme.c b/net/mac80211/mlme.c
index 3610c11286bc..2029b71eb879 100644
--- a/net/mac80211/mlme.c
+++ b/net/mac80211/mlme.c
@@ -487,6 +487,13 @@ static void ieee80211_enable_ps(struct ieee80211_local *local,
 {
 	struct ieee80211_conf *conf = &local->hw.conf;
 
+	/*
+	 * If we are scanning right now then the parameters will
+	 * take effect when scan finishes.
+	 */
+	if (local->hw_scanning || local->sw_scanning)
+		return;
+
 	if (conf->dynamic_ps_timeout > 0 &&
 	    !(local->hw.flags & IEEE80211_HW_SUPPORTS_DYNAMIC_PS)) {
 		mod_timer(&local->dynamic_ps_timer, jiffies +

