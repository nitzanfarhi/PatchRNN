commit b46d1765efe69f1fe03d0a802fdac19668600c3f
Author: Tomas Heinrich <theinric@redhat.com>
Date:   Mon Jul 21 12:25:25 2014 +0200

    bugfix: don't leak memory returned by newActive()
    
    Error: RESOURCE_LEAK (CWE-772):
    rsyslog-7.4.10/runtime/ruleset.c:506: alloc_fn: Storage is returned from allocation function "newActive(batch_t *)".
    rsyslog-7.4.10/runtime/ruleset.c:220:2: alloc_fn: Storage is returned from allocation function "malloc(size_t)".
    rsyslog-7.4.10/runtime/ruleset.c:220:2: return_alloc_fn: Directly returning storage allocated by "malloc(size_t)".
    rsyslog-7.4.10/runtime/ruleset.c:506: var_assign: Assigning: "thenAct" = storage returned from "newActive(pBatch)".
    rsyslog-7.4.10/runtime/ruleset.c:509: leaked_storage: Variable "thenAct" going out of scope leaks the storage it points to.

diff --git a/runtime/ruleset.c b/runtime/ruleset.c
index df716b8b3..5bec4f68c 100644
--- a/runtime/ruleset.c
+++ b/runtime/ruleset.c
@@ -512,16 +512,17 @@ done:
 }
 
 /* for details, see scriptExec() header comment! */
-static void
+static rsRetVal
 execPROPFILT(struct cnfstmt *stmt, batch_t *pBatch, sbool *active)
 {
 	sbool *thenAct;
 	sbool bRet;
 	int i;
-	thenAct = newActive(pBatch);
+	DEFiRet;
+	CHKmalloc(thenAct = newActive(pBatch));
 	for(i = 0 ; i < batchNumMsgs(pBatch) ; ++i) {
 		if(*(pBatch->pbShutdownImmediate))
-			return;
+			FINALIZE;
 		if(pBatch->eltState[i] == BATCH_STATE_DISC)
 			continue; /* will be ignored in any case */
 		if(active == NULL || active[i]) {
@@ -533,7 +534,10 @@ execPROPFILT(struct cnfstmt *stmt, batch_t *pBatch, sbool *active)
 	}
 
 	scriptExec(stmt->d.s_propfilt.t_then, pBatch, thenAct);
-	freeActive(thenAct);
+finalize_it:
+	if(thenAct == NULL)
+		freeActive(thenAct);
+	RETiRet;
 }
 
 /* The rainerscript execution engine. It is debatable if that would be better

