commit de60980ada21e0e6bf7166c8c791f8d83e666a1f
Author: Werner Dittmann <Werner.Dittmann@t-online.de>
Date:   Mon Jul 16 18:50:49 2012 +0200

    Fix initialization of PRNG

diff --git a/cryptcommon/ZrtpRandom.cpp b/cryptcommon/ZrtpRandom.cpp
index ae07129..af6a505 100644
--- a/cryptcommon/ZrtpRandom.cpp
+++ b/cryptcommon/ZrtpRandom.cpp
@@ -47,6 +47,8 @@ int ZrtpRandom::getRandomData(uint8_t* buffer, uint32_t length) {
     uint8_t    rdata[AES_BLOCK_SIZE];
     uint32_t   generated = length;
 
+    initialize();
+
     lockRandom.Lock();
 
     /*
@@ -106,6 +108,8 @@ int ZrtpRandom::getRandomData(uint8_t* buffer, uint32_t length) {
 
 int ZrtpRandom::addEntropy(const uint8_t *buffer, uint32_t length)
 {
+    initialize();
+
     if (buffer && length) {
         sha512_hash(buffer, length, &mainCtx);
     }
@@ -129,6 +133,7 @@ void ZrtpRandom::initialize() {
         return;
     }
     sha512_begin(&mainCtx);
+    initialized = true;
     lockRandom.Unlock();
 }
 

