From 24c929a27415c7cfc7126c47e4cad39acf3efa6b Mon Sep 17 00:00:00 2001
From: Nigel Metheringham <nigel@exim.org>
Date: Fri, 12 Dec 2008 14:36:37 +0000
Subject: [PATCH] Buffer overrun fix. fixes: bug #787

---
 doc/doc-txt/ChangeLog | 5 ++++-
 src/src/string.c      | 9 ++++++++-
 2 files changed, 12 insertions(+), 2 deletions(-)

diff --git a/doc/doc-txt/ChangeLog b/doc/doc-txt/ChangeLog
index 52279d3..09b9031 100644
--- a/doc/doc-txt/ChangeLog
+++ b/doc/doc-txt/ChangeLog
@@ -1,4 +1,4 @@
-$Cambridge: exim/doc/doc-txt/ChangeLog,v 1.556 2008/10/16 07:57:01 nm4 Exp $
+$Cambridge: exim/doc/doc-txt/ChangeLog,v 1.557 2008/12/12 14:36:37 nm4 Exp $
 
 Change log file for Exim from version 4.21
 -------------------------------------------
@@ -77,6 +77,9 @@ NM/07 Bugzilla 769: Extraneous comma in usage fprintf
 NM/08 Fixed erroneous documentation references to smtp_notquit_acl to be
       acl_smtp_notquit
 
+NM/09 Bugzilla 787: Potential buffer overflow in string_format
+      Patch provided by Eugene Bujak
+
 
 Exim version 4.69
 -----------------
diff --git a/src/src/string.c b/src/src/string.c
index 20bd1d1..8345529 100644
--- a/src/src/string.c
+++ b/src/src/string.c
@@ -1,4 +1,4 @@
-/* $Cambridge: exim/src/src/string.c,v 1.13 2007/02/26 14:07:04 ph10 Exp $ */
+/* $Cambridge: exim/src/src/string.c,v 1.14 2008/12/12 14:36:37 nm4 Exp $ */
 
 /*************************************************
 *     Exim - an Internet mail transport agent    *
@@ -1267,10 +1267,17 @@ while (*fp != 0)
     not OK, add part of the string (debugging uses this to show as
     much as possible). */
 
+    if (p == last)
+      {
+      yield = FALSE;
+      goto END_FORMAT;
+      }
     if (p >= last - width)
       {
       yield = FALSE;
       width = precision = last - p - 1;
+      if (width < 0) width = 0;
+      if (precision < 0) precision = 0;
       }
     sprintf(CS p, "%*.*s", width, precision, s);
     if (fp[-1] == 'S')
-- 
1.9.1

