From 3320955045e5a2a22c13a04fa9422bb809e75eda Mon Sep 17 00:00:00 2001
From: Cristy <urban-warrior@imagemagick.org>
Date: Sat, 8 Jul 2017 18:32:55 -0400
Subject: [PATCH] https://github.com/ImageMagick/ImageMagick/issues/550

---
 ChangeLog    | 4 ++++
 coders/png.c | 8 +++++++-
 2 files changed, 11 insertions(+), 1 deletion(-)

diff --git a/ChangeLog b/ChangeLog
index 57c04d14e9..e864319c57 100644
--- a/ChangeLog
+++ b/ChangeLog
@@ -1,3 +1,7 @@
+2017-07-08  6.9.9-0 Cristy  <quetzlzacatenango@image...>
+  * Fixed numerous memory leaks (reference
+    https://github.com/ImageMagick/ImageMagick/issues).
+
 2017-06-10  6.9.8-10 Cristy  <quetzlzacatenango@image...>
   * Release ImageMagick version 6.9.8-10, GIT revision 11637:eb6f363:20170610.
 
diff --git a/coders/png.c b/coders/png.c
index 3445ce7882..acd8cc3187 100644
--- a/coders/png.c
+++ b/coders/png.c
@@ -4293,7 +4293,13 @@ static Image *ReadOneJNGImage(MngInfo *mng_info,
         type[0],type[1],type[2],type[3],(double) length);
 
     if (length > PNG_UINT_31_MAX || count == 0)
-      ThrowReaderException(CorruptImageError,"CorruptImage");
+      {
+        if (color_image != (Image *) NULL)
+          color_image=DestroyImage(color_image);
+        if (color_image_info != (Image *) NULL)
+          color_image_info=DestroyImageInfo(color_image_info);
+        ThrowReaderException(CorruptImageError,"CorruptImage");
+      }
 
     p=NULL;
     chunk=(unsigned char *) NULL;
