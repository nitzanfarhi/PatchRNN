From 470990fee0182566d439ef7e82d1abf18b7085d7 Mon Sep 17 00:00:00 2001
From: zhu qun-ying <qunying@yahoo.com>
Date: Mon, 2 Jun 2014 14:38:52 +0100
Subject: [PATCH] Free up s->d1->buffered_app_data.q properly.

PR#3286
---
 ssl/d1_lib.c | 9 ++++++---
 1 file changed, 6 insertions(+), 3 deletions(-)

diff --git a/ssl/d1_lib.c b/ssl/d1_lib.c
index 2287ba6fa42..7d9d91ff2c3 100644
--- a/ssl/d1_lib.c
+++ b/ssl/d1_lib.c
@@ -202,9 +202,12 @@ static void dtls1_clear_queues(SSL *s)
 
 	while ( (item = pqueue_pop(s->d1->buffered_app_data.q)) != NULL)
 		{
-		frag = (hm_fragment *)item->data;
-		OPENSSL_free(frag->fragment);
-		OPENSSL_free(frag);
+		rdata = (DTLS1_RECORD_DATA *) item->data;
+		if (rdata->rbuf.buf)
+			{
+			OPENSSL_free(rdata->rbuf.buf);
+			}
+		OPENSSL_free(item->data);
 		pitem_free(item);
 		}
 	}
