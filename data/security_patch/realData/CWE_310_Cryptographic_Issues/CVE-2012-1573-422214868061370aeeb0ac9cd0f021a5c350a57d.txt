From 422214868061370aeeb0ac9cd0f021a5c350a57d Mon Sep 17 00:00:00 2001
From: Nikos Mavrogiannopoulos <nmav@gnutls.org>
Date: Thu, 1 Mar 2012 09:50:40 +0100
Subject: [PATCH] better check decrypted data.

---
 NEWS                |  9 +++++++++
 lib/gnutls_cipher.c | 11 +++++------
 2 files changed, 14 insertions(+), 6 deletions(-)

diff --git a/NEWS b/NEWS
index 398c5e9..41c0c50 100644
--- a/NEWS
+++ b/NEWS
@@ -3,6 +3,15 @@ Copyright (C) 2000, 2001, 2002, 2003, 2004, 2005,
               2006, 2007, 2008, 2009, 2010, 2011 Free Software Foundation, Inc.
 See the end for copying conditions.
 
+Version 2.12.17 (unreleased)
+
+** libgnutls: Corrections in record packet parsing.
+Reported by Matthew Hall.
+
+** API and ABI modifications:
+No changes since last version.
+
+
 Version 2.12.16 (released 2011-01-06)
 
 ** libgnutls: Corrected functionality of
diff --git a/lib/gnutls_cipher.c b/lib/gnutls_cipher.c
index 22d02f6..6b83208 100644
--- a/lib/gnutls_cipher.c
+++ b/lib/gnutls_cipher.c
@@ -511,14 +511,13 @@ _gnutls_ciphertext2compressed (gnutls_session_t session,
         {
           ciphertext.size -= blocksize;
           ciphertext.data += blocksize;
-
-          if (ciphertext.size == 0)
-            {
-              gnutls_assert ();
-              return GNUTLS_E_DECRYPTION_FAILED;
-            }
         }
 
+      if (ciphertext.size < hash_size)
+        {
+          gnutls_assert ();
+          return GNUTLS_E_DECRYPTION_FAILED;
+        }
       pad = ciphertext.data[ciphertext.size - 1] + 1;   /* pad */
 
       if ((int) pad > (int) ciphertext.size - hash_size)
-- 
1.9.1

