From 4dcc6affe04368461310a21238f7e1871a752a05 Mon Sep 17 00:00:00 2001
From: Sebastian Rasmussen <sebras@gmail.com>
Date: Fri, 2 Feb 2018 00:37:51 +0100
Subject: [PATCH 1/1] Bug 698891: Keep colorspace for luminosity transparency
 group.

This was forgotten when a gray colorspace was used as a fallback
in case a colorspace was never set. Thanks to oss-fuzz for reporting.
---
 source/pdf/pdf-op-run.c | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/source/pdf/pdf-op-run.c b/source/pdf/pdf-op-run.c
index 16c5c2f..c51bb53 100644
--- a/source/pdf/pdf-op-run.c
+++ b/source/pdf/pdf-op-run.c
@@ -135,7 +135,7 @@ begin_softmask(fz_context *ctx, pdf_run_processor *pr, softmask_save *save)
 	mask_colorspace = pdf_xobject_colorspace(ctx, softmask);
 
 	if (gstate->luminosity && !mask_colorspace)
-		mask_colorspace = fz_device_gray(ctx);
+		mask_colorspace = fz_keep_colorspace(ctx, fz_device_gray(ctx));
 
 	fz_try(ctx)
 	{
-- 
2.9.1

