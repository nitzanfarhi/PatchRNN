From 83d4dae44c71816c084a635550acc1a51529b881 Mon Sep 17 00:00:00 2001
From: Sebastian Rasmussen <sebras@gmail.com>
Date: Tue, 23 Jan 2018 16:43:59 +0100
Subject: [PATCH 1/1] Bug 698904: Upon error both free color converter and
 clear its pointer.

Without this change future calls to fz_fin_cached_color_converter()
will try to dereference the already freed pointer.
---
 source/fitz/colorspace.c | 1 +
 1 file changed, 1 insertion(+)

diff --git a/source/fitz/colorspace.c b/source/fitz/colorspace.c
index c099297..336513f 100644
--- a/source/fitz/colorspace.c
+++ b/source/fitz/colorspace.c
@@ -3663,6 +3663,7 @@ void fz_init_cached_color_converter(fz_context *ctx, fz_color_converter *cc, fz_
 		fz_drop_color_converter(ctx, &cached->base);
 		fz_drop_hash_table(ctx, cached->hash);
 		fz_free(ctx, cached);
+		cc->opaque = NULL;
 		fz_rethrow(ctx);
 	}
 }
-- 
2.9.1

