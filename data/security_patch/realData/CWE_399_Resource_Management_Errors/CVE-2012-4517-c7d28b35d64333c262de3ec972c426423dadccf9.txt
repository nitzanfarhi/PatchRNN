From c7d28b35d64333c262de3ec972c426423dadccf9 Mon Sep 17 00:00:00 2001
From: "sean.hefty@intel.com" <sean.hefty@intel.com>
Date: Tue, 3 Apr 2012 17:20:35 -0700
Subject: [PATCH] Fix refcnt for multicast destination

mc_dest has a default refcnt of 0.  When a multicast destination is
released, an attempt is made to free it, which can result in the
ibacm service crashing.

Signed-off-by: Sean Hefty <sean.hefty@intel.com>
---
 src/acm.c | 1 +
 1 file changed, 1 insertion(+)

diff --git a/src/acm.c b/src/acm.c
index d47f9d6..818dbcc 100644
--- a/src/acm.c
+++ b/src/acm.c
@@ -762,6 +762,7 @@ static void acm_process_join_resp(struct acm_ep *ep, struct ib_user_mad *umad)
 		}
 	}
 
+	atomic_set(&dest->refcnt, 1);
 	dest->state = ACM_READY;
 	acm_log(1, "join successful\n");
 out:
-- 
2.17.1

