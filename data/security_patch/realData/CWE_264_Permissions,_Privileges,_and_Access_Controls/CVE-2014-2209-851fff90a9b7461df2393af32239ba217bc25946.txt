From 851fff90a9b7461df2393af32239ba217bc25946 Mon Sep 17 00:00:00 2001
From: Otto Ebeling <otto@fb.com>
Date: Mon, 28 Apr 2014 11:19:44 -0700
Subject: [PATCH] Drop supplementary groups when changing to non-root

Summary: When running HHVM as a non-root user, UID and GID are updated correctly but supplementary groups are not dropped properly. This runs initgroups inside main thread and lightprocess threads to reset groups to those of the specified non-root user.

Reviewed By: @markw65

Differential Revision: D1193229
---
 hphp/util/capability.cpp    | 7 +++++++
 hphp/util/light-process.cpp | 2 ++
 2 files changed, 9 insertions(+)

diff --git a/hphp/util/capability.cpp b/hphp/util/capability.cpp
index 56133790c46..e4c9df2070d 100644
--- a/hphp/util/capability.cpp
+++ b/hphp/util/capability.cpp
@@ -24,6 +24,7 @@
 #include <sys/prctl.h>
 #include <sys/types.h>
 #include <pwd.h>
+#include <grp.h>
 
 namespace HPHP {
 ///////////////////////////////////////////////////////////////////////////////
@@ -102,6 +103,12 @@ bool Capability::ChangeUnixUser(uid_t uid) {
       return false;
     }
 
+    if (initgroups(pw->pw_name, pw->pw_gid) < 0) {
+      Logger::Error("unable to drop supplementary group privs: %s",
+                    folly::errnoStr(errno).c_str());
+      return false;
+    }
+
     if (pw->pw_gid == 0 || setgid(pw->pw_gid) < 0) {
       Logger::Error("unable to drop gid privs: %s",
                     folly::errnoStr(errno).c_str());
diff --git a/hphp/util/light-process.cpp b/hphp/util/light-process.cpp
index 02d2c84260f..3c67c32e66b 100644
--- a/hphp/util/light-process.cpp
+++ b/hphp/util/light-process.cpp
@@ -25,6 +25,7 @@
 #include <sys/socket.h>
 
 #include <afdt.h>
+#include <grp.h>
 #include <stdlib.h>
 #include <unistd.h>
 #include <poll.h>
@@ -299,6 +300,7 @@ static void do_change_user(FILE *fin, FILE *fout) {
     struct passwd *pw = getpwnam(uname.c_str());
     if (pw) {
       if (pw->pw_gid) {
+        initgroups(pw->pw_name, pw->pw_gid);
         setgid(pw->pw_gid);
       }
       if (pw->pw_uid) {
