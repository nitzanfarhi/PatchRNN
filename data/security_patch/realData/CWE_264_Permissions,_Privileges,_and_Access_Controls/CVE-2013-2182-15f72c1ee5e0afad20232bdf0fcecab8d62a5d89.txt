From 15f72c1ee5e0afad20232bdf0fcecab8d62a5d89 Mon Sep 17 00:00:00 2001
From: Eduardo Silva <eduardo@monkey.io>
Date: Tue, 20 May 2014 11:22:19 -0600
Subject: [PATCH] Mandril: check decoded URI (fix #92)

Signed-off-by: Eduardo Silva <eduardo@monkey.io>
---
 plugins/mandril/mandril.c | 3 ++-
 1 file changed, 2 insertions(+), 1 deletion(-)

diff --git a/plugins/mandril/mandril.c b/plugins/mandril/mandril.c
index 8df087b3..820f4416 100644
--- a/plugins/mandril/mandril.c
+++ b/plugins/mandril/mandril.c
@@ -349,7 +349,8 @@ int _mkp_stage_30(struct plugin *p,
     (void) cs;
 
     PLUGIN_TRACE("[FD %i] Mandril validating URL", cs->socket);
-    if (mk_security_check_url(sr->uri) < 0) {
+
+    if (mk_security_check_url(sr->uri_processed) < 0) {
         PLUGIN_TRACE("[FD %i] Close connection, blocked URL", cs->socket);
         mk_api->header_set_http_status(sr, MK_CLIENT_FORBIDDEN);
         return MK_PLUGIN_RET_CLOSE_CONX;
