From 25821e6d74fab5fcc200fe5e818362e03e114428 Mon Sep 17 00:00:00 2001
From: Tor Andersson <tor.andersson@artifex.com>
Date: Wed, 24 Jan 2018 16:55:18 +0100
Subject: [PATCH] Fix 698920: Guard jsdtoa from integer overflow wreaking
 havoc.

---
 jsdtoa.c | 14 +++++++++-----
 1 file changed, 9 insertions(+), 5 deletions(-)

diff --git a/jsdtoa.c b/jsdtoa.c
index 04f22a1..af8f358 100644
--- a/jsdtoa.c
+++ b/jsdtoa.c
@@ -709,16 +709,20 @@ js_strtod(const char *string, char **endPtr)
 	 * fraction.
 	 */
 
-	if (exp < 0) {
+	if (exp < -maxExponent) {
+		exp = maxExponent;
+		expSign = TRUE;
+		errno = ERANGE;
+	} else if (exp > maxExponent) {
+		exp = maxExponent;
+		expSign = FALSE;
+		errno = ERANGE;
+	} else if (exp < 0) {
 		expSign = TRUE;
 		exp = -exp;
 	} else {
 		expSign = FALSE;
 	}
-	if (exp > maxExponent) {
-		exp = maxExponent;
-		errno = ERANGE;
-	}
 	dblExp = 1.0;
 	for (d = powersOf10; exp != 0; exp >>= 1, d += 1) {
 		if (exp & 01) {
-- 
2.9.1

