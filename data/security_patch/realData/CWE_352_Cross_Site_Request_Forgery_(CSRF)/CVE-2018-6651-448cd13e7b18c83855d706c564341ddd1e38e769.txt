From 448cd13e7b18c83855d706c564341ddd1e38e769 Mon Sep 17 00:00:00 2001
From: Christopher Dickson <chrisd1100@gmail.com>
Date: Tue, 16 Jan 2018 15:41:33 -0500
Subject: [PATCH] origin matching must come at str end

---
 src/uncurl.c | 7 +++++--
 1 file changed, 5 insertions(+), 2 deletions(-)

diff --git a/src/uncurl.c b/src/uncurl.c
index ca82af9..9ea8642 100644
--- a/src/uncurl.c
+++ b/src/uncurl.c
@@ -536,9 +536,12 @@ UNCURL_EXPORT int32_t uncurl_ws_accept(struct uncurl_conn *ucc, char **origins,
 	e = uncurl_get_header_str(ucc, "Origin", &origin);
 	if (e != UNCURL_OK) return e;
 
+	//the substring MUST came at the end of the origin header, thus a strstr AND a strcmp
 	bool origin_ok = false;
-	for (int32_t x = 0; x < n_origins; x++)
-		if (strstr(origin, origins[x])) {origin_ok = true; break;}
+	for (int32_t x = 0; x < n_origins; x++) {
+		char *match = strstr(origin, origins[x]);
+		if (match && !strcmp(match, origins[x])) {origin_ok = true; break;}
+	}
 
 	if (!origin_ok) return UNCURL_WS_ERR_ORIGIN;
 
