From 1f91e076a585118495b976a413c1df40f6fd3d41 Mon Sep 17 00:00:00 2001
From: Neal Poole <neal@fb.com>
Date: Mon, 25 Aug 2014 22:29:37 -0700
Subject: [PATCH] Fix integer overflow in chunk_split

Reviewed By: @ptarjan

Differential Revision: D1515947
---
 hphp/runtime/base/zend-string.cpp                      | 10 ++++++++--
 hphp/test/slow/ext_string/chunk_split_overflow.php     |  3 +++
 .../slow/ext_string/chunk_split_overflow.php.expectf   |  2 ++
 3 files changed, 13 insertions(+), 2 deletions(-)
 create mode 100644 hphp/test/slow/ext_string/chunk_split_overflow.php
 create mode 100644 hphp/test/slow/ext_string/chunk_split_overflow.php.expectf

diff --git a/hphp/runtime/base/zend-string.cpp b/hphp/runtime/base/zend-string.cpp
index c40a9469f14..7b64a9a924f 100644
--- a/hphp/runtime/base/zend-string.cpp
+++ b/hphp/runtime/base/zend-string.cpp
@@ -626,8 +626,14 @@ String string_chunk_split(const char *src, int srclen, const char *end,
   int chunks = srclen / chunklen; // complete chunks!
   int restlen = srclen - chunks * chunklen; /* srclen % chunklen */
 
-  int out_len = (chunks + 1) * endlen + srclen;
-  String ret(out_len, ReserveString);
+  String ret(
+    safe_address(
+      chunks + 1,
+      endlen,
+      srclen
+    ),
+    ReserveString
+  );
   char *dest = ret.bufferSlice().ptr;
 
   const char *p; char *q;
diff --git a/hphp/test/slow/ext_string/chunk_split_overflow.php b/hphp/test/slow/ext_string/chunk_split_overflow.php
new file mode 100644
index 00000000000..c895bee3639
--- /dev/null
+++ b/hphp/test/slow/ext_string/chunk_split_overflow.php
@@ -0,0 +1,3 @@
+<?php
+
+chunk_split(str_repeat('*', 2000000), 1.0, str_repeat('*', 2000000));
diff --git a/hphp/test/slow/ext_string/chunk_split_overflow.php.expectf b/hphp/test/slow/ext_string/chunk_split_overflow.php.expectf
new file mode 100644
index 00000000000..17c953f9163
--- /dev/null
+++ b/hphp/test/slow/ext_string/chunk_split_overflow.php.expectf
@@ -0,0 +1,2 @@
+
+Fatal error: String length exceeded 2^31-2: 4000004000000 in %s on line 3
