From 9c2cd3c93c05d009a91d84eedbb85873b0cb505d Mon Sep 17 00:00:00 2001
From: Anders Brander <anders@brander.dk>
Date: Wed, 3 Dec 2014 08:01:28 +0100
Subject: [PATCH] Fixes insecure use of temporary file (CVE-2014-4978).

---
 librawstudio/rs-filter.c | 21 ++++++++++++++++++---
 1 file changed, 18 insertions(+), 3 deletions(-)

diff --git a/librawstudio/rs-filter.c b/librawstudio/rs-filter.c
index 4913c13d..352b23c5 100644
--- a/librawstudio/rs-filter.c
+++ b/librawstudio/rs-filter.c
@@ -772,17 +772,32 @@ void
 rs_filter_graph(RSFilter *filter)
 {
 	g_return_if_fail(RS_IS_FILTER(filter));
+	gchar *dot_filename;
+	gchar *png_filename;
+	gchar *command_line;
 	GString *str = g_string_new("digraph G {\n");
 
 	rs_filter_graph_helper(str, filter);
 
 	g_string_append_printf(str, "}\n");
-	g_file_set_contents("/tmp/rs-filter-graph", str->str, str->len, NULL);
 
-	if (0 != system("dot -Tpng >/tmp/rs-filter-graph.png </tmp/rs-filter-graph"))
+	/* Here we would like to use g_mkdtemp(), but due to a bug in upstream, that's impossible */
+	dot_filename = g_strdup_printf("/tmp/rs-filter-graph.%u", g_random_int());
+	png_filename = g_strdup_printf("%s.%u.png", dot_filename, g_random_int());
+
+	g_file_set_contents(dot_filename, str->str, str->len, NULL);
+
+	command_line = g_strdup_printf("dot -Tpng >%s <%s", png_filename, dot_filename);
+	if (0 != system(command_line))
 		g_warning("Calling dot failed");
-	if (0 != system("gnome-open /tmp/rs-filter-graph.png"))
+	g_free(command_line);
+
+	command_line = g_strdup_printf("gnome-open %s", png_filename);
+	if (0 != system(command_line))
 		g_warning("Calling gnome-open failed.");
+	g_free(command_line);
 
+	g_free(dot_filename);
+	g_free(png_filename);
 	g_string_free(str, TRUE);
 }
