From 2fc178cf448d8e1b95d1314e47eeef610729e0df Mon Sep 17 00:00:00 2001
From: Stanislav Malyshev <stas@php.net>
Date: Sun, 11 Jan 2015 00:51:05 -0800
Subject: [PATCH] Fix bug #68799: Free called on unitialized pointer

---
 ext/exif/exif.c              |   2 +-
 ext/exif/tests/bug68799.jpg  | Bin 0 -> 735 bytes
 ext/exif/tests/bug68799.phpt |  63 +++++++++++++++++++++++++++++++++++++++++++
 3 files changed, 64 insertions(+), 1 deletion(-)
 create mode 100644 ext/exif/tests/bug68799.jpg
 create mode 100644 ext/exif/tests/bug68799.phpt

diff --git a/ext/exif/exif.c b/ext/exif/exif.c
index 637ebf9..7f95ff4 100644
--- a/ext/exif/exif.c
+++ b/ext/exif/exif.c
@@ -2702,7 +2702,7 @@ static int exif_process_user_comment(image_info_type *ImageInfo, char **pszInfoP
 static int exif_process_unicode(image_info_type *ImageInfo, xp_field_type *xp_field, int tag, char *szValuePtr, int ByteCount TSRMLS_DC)
 {
 	xp_field->tag = tag;	
-	
+	xp_field->value = NULL;
 	/* XXX this will fail again if encoding_converter returns on error something different than SIZE_MAX   */
 	if (zend_multibyte_encoding_converter(
 			(unsigned char**)&xp_field->value, 
diff --git a/ext/exif/tests/bug68799.jpg b/ext/exif/tests/bug68799.jpg
new file mode 100644
index 0000000000000000000000000000000000000000..acc326dbbf3be6e0721ea1b6b6da6b78225883ba
GIT binary patch
literal 735
zcmex=<NpH&0WUXCHwH!rM<-_&S2y?n4;j*2D>Bm<7<_#hv=|r|I2c$Mr5IR&EJh%<
zW0Z!o-550(n8D&q3=DJTG5|?1@PpC`KpLb6Ocx|(=9TE>rIsj|=o#o4GyK2J;LO0p
z$OuAEz|6`F0&FZS%&hEe?Cc=S!O6|Z!NJAB&d$Zl#l_771niuA{JcDTAU4PlkamzR
zAmZU*=K!f74g5dAAjko9C?hkY5(ASUBeNjm|04|YK)16pf&tJAV8F=4%)-hBbP^Xg
zP{CFKp!1oTnShREWnlrTt_8|7un4jWDH=Mm2?r*!D;0_uHBMZ}q3pErplHy=4=Tn<
zMNOPsV&W2#QmSg|8k$-rre@|AmR8_^_we)z4hanlkBE#)PDxEm&&bRwE-5W5uc)kQ
zZfR|6@96BBG<nL@Y13!SoV952lBLU*uUNTi)8;K(w{73CbJwB6M~)sle&Xb*OP8-)
zy>|V^&07y2J$~}^+4C1KUw!=a`ODXD-+%o41@ado12e>1KoYCJ1cCly0>%LgJIG&*
zOyxk#EXcyDXviky7|5PjD6C}E$RXl1apA^;oXW;QA4HRiE^>*fm^@Vd2=W@(XT*7|
hi7cPNJ%;etEe0NDMquPI3o_U<{Qa}2ON06UO#tsw&oBT0

literal 0
HcmV?d00001

diff --git a/ext/exif/tests/bug68799.phpt b/ext/exif/tests/bug68799.phpt
new file mode 100644
index 0000000..b09f21c
--- /dev/null
+++ b/ext/exif/tests/bug68799.phpt
@@ -0,0 +1,63 @@
+--TEST--
+Bug #68799 (Free called on unitialized pointer)
+--SKIPIF--
+<?php if (!extension_loaded('exif')) print 'skip exif extension not available';?>
+--FILE--
+<?php
+/*
+* Pollute the heap. Helps trigger bug. Sometimes not needed.
+*/
+class A {
+    function __construct() {
+        $a = 'AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAa';
+        $this->a = $a . $a . $a . $a . $a . $a;
+    }
+};
+
+function doStuff ($limit) {
+
+    $a = new A;
+
+    $b = array();
+    for ($i = 0; $i < $limit; $i++) {
+        $b[$i] = clone $a;
+    }
+
+    unset($a);
+
+    gc_collect_cycles();
+}
+
+$iterations = 3;
+
+doStuff($iterations);
+doStuff($iterations);
+
+gc_collect_cycles();
+
+print_r(exif_read_data(__DIR__.'/bug68799.jpg'));
+
+?>
+--EXPECTF--
+Array
+(
+    [FileName] => bug68799.jpg
+    [FileDateTime] => %d
+    [FileSize] => 735
+    [FileType] => 2
+    [MimeType] => image/jpeg
+    [SectionsFound] => ANY_TAG, IFD0, WINXP
+    [COMPUTED] => Array
+        (
+            [html] => width="1" height="1"
+            [Height] => 1
+            [Width] => 1
+            [IsColor] => 1
+            [ByteOrderMotorola] => 1
+        )
+
+    [XResolution] => 96/1
+    [YResolution] => 96/1
+    [ResolutionUnit] => 2
+    [Author] => 
+)
-- 
2.1.4

